webpackJsonp([32],{2849:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n(360),n(362),n(2850)},2850:function(e,t,n){"use strict";var o=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var c,r=n(360),s=n(362);!function(e){e.Skip="skip",e.Delta="delta"}(c||(c={}));var a;!function(e){e.Full="full",e.Delta="delta"}(a||(a={}));var u=function(e){function t(t,n,o,i,c,r,s,a,u,l,h,d,g,f,p,S,v,y,m){var C=e.call(this,s.valueFor(a.settings.names.middleTierConstants).newEndpointAddress,s,a,t,o,n,r,l)||this;return C.$http=t,C.$qNoApply=n,C.$q=o,C.$interval=i,C.$rootScope=c,C.authenticationService=r,C.settingsService=s,C.constants=a,C.loggingService=u,C.appStateService=l,C.contactsDatabase=h,C.identityService=g,C.utilityService=f,C.storageService=p,C.eventingService=S,C.pstnNumberService=v,C.peopleService=y,C.myUserPreferencesStore=m,C.logger=u.newLogger("ContactSyncService"),d.registerForMtma(C),C.initializeOnAppLaunchAndReinit("First Initialize"),C}return o(t,e),t.$inject=["$http","$qNoApply","$q","$interval","$rootScope","authenticationService","settingsService","constants","loggingService","appStateService","contactsDatabase","orchestrationService","identityService","utilityService","storageService","eventingService","pstnNumberService","peopleService","myUserPreferencesStore"],t.prototype.initializeOnAppLaunchAndReinit=function(e){this.logger.log("contactSyncService Initialize reason {0}",e),this.contactSyncServiceEnabled=this.settingsService.valueAsBoolean(this.constants.settings.names.enableContactSyncService),this.contactSyncRefreshIntervalInMinutes=this.settingsService.valueFor(this.constants.settings.names.contactSyncRefreshTimeoutInMinutes),this.contactSyncResetIntervalInDays=this.settingsService.valueFor(this.constants.settings.names.contactSyncResetIntervalInDays),this.contactSyncContactProcessingDelayInMs=this.settingsService.valueFor(this.constants.settings.names.contactSyncContactProcessingDelayInMs),this.configuredPageSize=this.settingsService.valueFor(this.constants.settings.names.contactSyncPageSize),this.contactSyncOrderOfPrecedence=this.settingsService.valueFor(this.constants.settings.names.contactSyncOrderOfPrecedence),this.contactSyncMinSearchStringSize=this.settingsService.valueFor(this.constants.settings.names.contactSyncMinSearchStringSize),this.enableTflSmsCreate=this.settingsService.valueAsBoolean(this.constants.settings.names.enableTflSmsCreate),this.enableChatWithNonTflUsers=this.settingsService.valueAsBoolean(this.constants.settings.names.enableChatWithNonTflUsers),this.tflSmsAllowedPhoneNumberRegionCodes=this.settingsService.valueFor(this.constants.settings.names.tflSmsAllowedPhoneNumberRegionCodes),this.isGuestUser=this.identityService.isGuestUserType(),this.initService()},t.prototype.cleanupOnAppTeardown=function(e){this.logger.log("contactSyncService onAppTeardown: reason = {0}",e),this.recurringContactSyncUpdateInterval&&(this.$interval.cancel(this.recurringContactSyncUpdateInterval),this.recurringContactSyncUpdateInterval=null),this.dbOpenPromise=void 0,this.syncProviders=void 0,this.contactSyncServiceEnabled=!1,this.contactSyncRefreshIntervalInMinutes=0,this.contactSyncResetIntervalInDays=0,this.contactSyncContactProcessingDelayInMs=0,this.contactSyncOrderOfPrecedence=void 0,this.contactSyncMinSearchStringSize=0,this.configuredPageSize=0,this.enableChatWithNonTflUsers=!1,this.enableTflSmsCreate=!1,this.tflSmsAllowedPhoneNumberRegionCodes=[],this.isGuestUser=!1},t.prototype.mtmaTelemetryIdentifier=function(){return"ContactSyncService"},t.prototype.openContactsDatabase=function(){var e=this,t=this.loggingService.newScenario(this.constants.scenarios.contactSyncService.openDatabase);return this.contactsDatabase.isOpen?(t.stop({message:"contactSync database already open"}),this.dbOpenPromise.resolve()):this.contactsDatabase.open().then(function(){t.stop(),e.dbOpenPromise.resolve()},function(){t.fail({error:"contactSync database failed to open"}),e.dbOpenPromise.reject()}),this.dbOpenPromise.promise},t.prototype.search=function(e,t,n){var o=this;if(!e)return this.$q.resolve([]);var i=(e=e.toLocaleLowerCase()).split(/(\s+)/).filter(function(e){return e.trim().length>0}),c=i.length>0?i[0]:"",r=i.length>1?i[i.length-1]:null,s=r&&r.length>c.length?r:c;if(s.length<this.contactSyncMinSearchStringSize)return this.logger.info("Search string too small, skipping the seach"),this.$q.resolve([]);var a=this.loggingService.newScenario(this.constants.scenarios.contactSyncService.search),u={source:n,stringLength:e.length,wordCount:i.length,mainWordStringLength:s.length,matches:0},l=function(e,t,n,i){return o.onDbOpenCompletion().then(function(){var i=e,c=i+"ï¿¿";return o.contactsDatabase.provider.getRangeWithCriteria(o.contactsDatabase.schema.stores.rawcontacts.name,n,function(e){var n=!1;if(t){var o=e.displayName.toLocaleLowerCase();t.forEach(function(e){n=n||!o.contains(e)})}return!(n||!e.phone&&!e.email)},i,c,!1,!1,!1,o.constants.contactSync.maxContactResultsFromCache,0).toNgPromise(o.$q)}).then(function(e){return e.results.map(function(e){return{cachedContact:e,priority:i}})}).catch(function(e){return o.logger.error("Search failed with "+e),u.error||(u.error=o.utilityService.getErrorLoggingString(e)),[]})},h=i.length>1?i:null,d=[];return d.push(l(s,h,this.contactsDatabase.schema.stores.rawcontacts.indexes.namePart1.name,1)),d.push(l(s,h,this.contactsDatabase.schema.stores.rawcontacts.indexes.namePart2.name,2)),h||d.push(l(s,null,this.contactsDatabase.schema.stores.rawcontacts.indexes.email.name,3)),this.$q.all(d).then(function(e){var t=[];return e.forEach(function(e){e.forEach(function(e){e.contactKey=e.cachedContact.displayName+":"+(e.cachedContact.email||e.cachedContact.phone),t.push(e)})}),t=_.sortBy(t,["priority"]),t=_.uniqBy(t,"contactKey"),u.matches=t.length,o.mapToUsersForInvite(t.map(function(e){return e.cachedContact}))}).then(function(e){return t?e.slice(0,t):e}).finally(function(){u.error?a.fail(u):a.stop(u)})},t.prototype.initService=function(){this.contactSyncServiceEnabled&&!this.isGuestUser?(this.dbOpenPromise=this.$q.defer(),this.initProviders(),this.syncContacts("contactSyncService_initService"),this.resetContactSyncUpdateInterval()):this.logger.info("Contact Syncing is not enabled")},t.prototype._getAuthHeaders=function(e,t,n){return this.authenticationService.getAuthHeaders({},void 0,t?[t]:void 0)},t.prototype.getAuthConfig=function(){return{}},t.prototype.syncContacts=function(e,t){var n=this;void 0===t&&(t=!1),this.logger.info("Starting sync cycle ("+(t?"forced full":"normal")+", from "+e+")");var o=this.$q.defer(),i=[];this.logger.info("Discovering sync sources");var c=this.syncProviders.map(function(e){return e.discoverSources().then(function(e){i.push.apply(i,e)}).catch(function(e){n.logger.error("Source discovery failed with "+e)})});return this.$q.all(c).then(function(){return n.logger.info("Reading local sync state"),n.getSyncStateFromDB()}).then(function(e){return n.logger.info("Calling sync worker"),n.syncWorker(e,i,t)}).then(function(){n.logger.info("Completed sync cycle"),n.syncProviders.forEach(function(e){e.syncCompleted()}),o.resolve()}).catch(function(e){n.logger.info("DB or Sync worker failed with "+e),o.reject(e)}),o.promise},t.prototype.initProviders=function(){this.syncProviders=[],this.syncProviders.push(new r.RoamingDeviceContactsSyncProvider(this.$http,this.$qNoApply,this.$q,this.$rootScope,this.authenticationService,this.settingsService,this.constants,this.loggingService,this.appStateService,this.utilityService,this.storageService,this.eventingService,this.myUserPreferencesStore)),this.syncProviders.push(new s.OutlookContactsSyncProvider(this.$q,this.authenticationService,this.settingsService,this.constants,this.loggingService))},t.prototype.resetContactSyncUpdateInterval=function(){var e=this;this.recurringContactSyncUpdateInterval&&(this.$interval.cancel(this.recurringContactSyncUpdateInterval),this.recurringContactSyncUpdateInterval=null),this.recurringContactSyncUpdateInterval=this.$interval(function(){e.syncContacts("contactSyncService_scheduledUpdate")},this.constants.timeInMiliseconds.minute*this.contactSyncRefreshIntervalInMinutes,0,!1)},t.prototype.onDbOpenCompletion=function(){return this.dbOpenPromise.promise},t.prototype.getAllSyncState=function(){var e=this,t=this.contactsDatabase.schema.stores.contactsyncinternaldata.name;return this.contactsDatabase.provider.getAll(t).toNgPromise(this.$q).then(function(n){return e.logger.info(t+" data: "+n.length+" items fetched from indexed db"),n}).catch(function(t){return e.logger.error("failed to get sync status from indexed db"),e.$q.reject(t)})},t.prototype.getSyncStateFromDB=function(){var e=this;return this.onDbOpenCompletion().then(function(){return e.getAllSyncState()})},t.prototype.syncWorker=function(e,t,n){var o=this,r=this.loggingService.newScenario(this.constants.scenarios.contactSyncService.syncWorker);this.logger.info("Starting sync worker ("+e.length+" local sources, "+t.length+" discovered sources)");var s=this.computePrecedenceOrder(t),a=function(e,t){return o.addOrUpdateSyncStateToDB(e).then(function(){return o.syncSource(e,s,t)})},u=function(e){return o.unsyncSource(e).then(function(){return o.deleteSyncStateFromDB(e)})},l=function(e,t,n){return u(e).then(function(){return a(t,n)})},h=function(r){if(r>=t.length)return o.$q.resolve();var u=null,d=t[r],g=e.findIndex(function(e){return d.sourceType==e.source&&d.accountId==e.accountId});if(void 0===g||g<0){var f="New sync source of type <"+d.sourceType+">";o.logger.info(f);var p={source:d.sourceType,accountId:d.accountId,isSyncAllowed:!0,connectedAccountId:d.connectedAccountId,currentSyncStatus:c.Skip,deltaToken:void 0,lastResetTimestamp:Date.now()};u=a(p,d.shouldSendToScd).then(function(){o.logger.info(f+": syncing completed.")}).catch(function(e){o.logger.info(f+": syncing failed with "+e+".")})}else{var S=e[g],v=!1;if((Date.now()-S.lastResetTimestamp)/o.constants.timeInMiliseconds.day>o.contactSyncResetIntervalInDays&&(v=!0),n||v||d.connectedAccountId!==S.connectedAccountId){var y="Existing sync source of type <"+d.sourceType+"> "+(n?"with forced full sync":v?"with scheduled full sync":"with mismatching connectedAccountId");o.logger.info(""+y);var m=i(i({},S),{connectedAccountId:d.connectedAccountId,lastResetTimestamp:Date.now()});u=l(S,m,d.shouldSendToScd).then(function(){o.logger.info(y+": syncing completed.")}).catch(function(e){o.logger.info(y+": syncing failed with "+e+".")})}else{var C="Existing sync source of type <"+d.sourceType+">";o.logger.info(""+C),u=o.syncSource(S,s,d.shouldSendToScd).then(function(){o.logger.info(C+": syncing completed.")}).catch(function(e){o.logger.info(C+": syncing failed with "+e+".")})}e.splice(g,1)}return u.then(function(){return h(r+1)})},d=function(t){if(t>=e.length)return o.$q.resolve();var n=e[t],i="Unsyncing Source of type <"+n.source+">";return o.logger.info(""+i),u(n).then(function(){o.logger.info(i+": completed.")}).catch(function(e){o.logger.info(i+": failed with "+e+".")}).then(function(){return d(t+1)})};return h(0).then(function(){return d(0)}).finally(function(){r.stop()})},t.prototype.syncSource=function(e,t,n){var o=this,r=this.$q.defer(),s=e.currentSyncStatus===c.Skip?"full":"delta";this.logger.info("Source of type <"+e.source+"> is in "+s+" mode");var u=this.loggingService.newScenario(this.constants.scenarios.contactSyncService.syncSource),l={sourceType:e.source,initialMode:s,pages:0},h=function(){var r=e.currentSyncStatus===c.Skip?e.deltaToken:void 0,s=e.currentSyncStatus===c.Delta?e.deltaToken:void 0;return o.performSyncPageRetrieval(e.source,e.accountId,e.connectedAccountId,o.configuredPageSize,n,r,s).then(function(t){return e.deltaToken&&t.scope===a.Full?(o.logger.warn("Source of type <"+e.source+"> switched to full syncing due to reset"),l.modeReset=!0,o.unsyncSource(e).then(function(){return e=i(i({},e),{currentSyncStatus:c.Skip,deltaToken:void 0,lastResetTimestamp:Date.now()}),o.addOrUpdateSyncStateToDB(e)}).then(function(){return t})):t}).then(function(n){return o.syncOnePage(e,n.contacts,t).then(function(){return n})}).then(function(t){var n=t.skipToken||t.deltaToken,r=e.currentSyncStatus;return r===c.Skip&&t.deltaToken?(o.logger.info("Source of type <"+e.source+"> switched to delta syncing"),r=c.Delta):r===c.Delta&&t.skipToken&&(o.logger.info("Source of type <"+e.source+"> switched to skip syncing"),r=c.Skip),(e=i(i({},e),{deltaToken:n,currentSyncStatus:r})).currentSyncStatus===c.Delta&&(e.lastSuccessTimestamp=Date.now()),o.addOrUpdateSyncStateToDB(e).then(function(){return e.currentSyncStatus===c.Delta})}).then(function(e){return o.$q.resolve(e)})},d=function(){h().then(function(e){e?(u.stop(l),r.resolve()):(l.pages++,setTimeout(function(){return d()}))}).catch(function(e){l.error=o.utilityService.getErrorLoggingString(e),u.fail(l),r.reject(e)})};return d(),r.promise},t.prototype.syncOnePage=function(e,t,n){var o=this,i=this.$q.defer(),c=new Set;t.forEach(function(e){c.add(e.id)});var r=function(e){var t;if(c.has(e.id)){var i=e.id,r=i+"~";t=o.deleteRawContactsRangeFromDB(o.contactsDatabase.schema.stores.rawcontacts.indexes.id.name,i,r),c.delete(e.id)}else t=o.$q.resolve();return t.then(function(){return e.isDeleted?o.$q.resolve():o.getRawContactFromDB(e.displayName,e.phone,e.email).then(function(t){if(!t||o.hasPrecedence(e.source,t.source,n)){var i=e.displayName.split(/(\s+)/).filter(function(e){return e.trim().length>0}),c=i.length>0?i[0].toLocaleLowerCase():null,r=i.length>1?i[i.length-1].toLocaleLowerCase():null;return o.addOrUpdateContactToDB({displayName:e.displayName,namePart1:c,namePart2:r,email:e.email,phone:e.phone,id:e.id,source:e.source})}return o.$q.resolve()})})},s=function(e){e>=t.length?i.resolve():r(t[e]).then(function(){setTimeout(function(){return s(e+1)},o.contactSyncContactProcessingDelayInMs)}).catch(function(e){i.reject(e)})};return s(0),i.promise},t.prototype.hasPrecedence=function(e,t,n){var o=n.indexOf(t);return o<0||o>n.indexOf(e)},t.prototype.computePrecedenceOrder=function(e){var t=this,n=this.contactSyncOrderOfPrecedence.map(function(e){return[]});e.forEach(function(e){var o=t.contactSyncOrderOfPrecedence.indexOf(e.sourceType);o>=0?n[o].push(e.accountId):t.logger.error("Unknown source type <"+e.sourceType+">")});var o=[];return n.forEach(function(e,n){e.sort(),e.forEach(function(e){o.push(t.compoundSourceAndAccountId(t.contactSyncOrderOfPrecedence[n],e))})}),o},t.prototype.unsyncSource=function(e){var t=this.compoundSourceAndAccountId(e.source,e.accountId),n=t+"~";return this.deleteRawContactsRangeFromDB(this.contactsDatabase.schema.stores.rawcontacts.indexes.source.name,t,n)},t.prototype.addOrUpdateSyncState=function(e){var t=this;return this.contactsDatabase.provider.put(this.contactsDatabase.schema.stores.contactsyncinternaldata.name,e).toNgPromise(this.$q).then(function(){t.logger.info("DB updated with the new sync state.")}).catch(function(e){return t.logger.error("DB error: {0}",e),t.$q.reject(e)})},t.prototype.addOrUpdateSyncStateToDB=function(e){var t=this;return this.onDbOpenCompletion().then(function(){return t.addOrUpdateSyncState(e)})},t.prototype.deleteSyncState=function(e){var t=this;return this.contactsDatabase.provider.remove(this.contactsDatabase.schema.stores.contactsyncinternaldata.name,[e.source,e.accountId]).toNgPromise(this.$q).then(function(){t.logger.info("DB updated with the deleted sync state.")}).catch(function(e){return t.logger.error("DB error: {0}",e),t.$q.reject(e)})},t.prototype.deleteSyncStateFromDB=function(e){var t=this;return this.onDbOpenCompletion().then(function(){return t.deleteSyncState(e)})},t.prototype.deleteRawContactsRange=function(e,t,n){var o=this;return this.contactsDatabase.provider.removeRange(this.contactsDatabase.schema.stores.rawcontacts.name,e,t,n,!1,!0).toNgPromise(this.$q).catch(function(e){return o.logger.error("DB error: {0}",e),o.$q.reject(e)})},t.prototype.deleteRawContactsRangeFromDB=function(e,t,n){var o=this;return this.onDbOpenCompletion().then(function(){return o.deleteRawContactsRange(e,t,n)})},t.prototype.getRawContact=function(e,t,n){var o=this;return this.contactsDatabase.provider.get(this.contactsDatabase.schema.stores.rawcontacts.name,[e,t,n]).toNgPromise(this.$q).catch(function(e){return o.logger.error("DB error: {0}",e),o.$q.reject(e)})},t.prototype.getRawContactFromDB=function(e,t,n){var o=this;return this.onDbOpenCompletion().then(function(){return o.getRawContact(e,t,n)})},t.prototype.addOrUpdateContact=function(e){var t=this;return this.contactsDatabase.provider.put(this.contactsDatabase.schema.stores.rawcontacts.name,e).toNgPromise(this.$q).catch(function(e){return t.logger.error("DB error: {0}",e),t.$q.reject(e)})},t.prototype.addOrUpdateContactToDB=function(e){var t=this;return this.onDbOpenCompletion().then(function(){return t.addOrUpdateContact(e)})},t.prototype.compoundSourceAndAccountId=function(e,t){return e+"|"+t},t.prototype.mapToUsersForInvite=function(e){var n,o=this;return this.peopleService.getMeMSAProfile("contactSyncService").then(function(e){n=e}).catch(function(){o.logger.warn("Failed to retrieve current user profile"),n=void 0}).then(function(){var i=[];return e.forEach(function(e){if(e.email){if(o.enableChatWithNonTflUsers&&!t.matchEmailAliasInMeProfile(e.email,n)){u=""+o.constants.tflConstants.people.offNetwork.mriPrefixForEmail+e.email;i.push({id:u+"|"+e.displayName,mri:u,displayName:e.displayName,description:e.email,email:e.email,source:e.source})}}else if(o.enableChatWithNonTflUsers||o.enableTflSmsCreate){var c=e.phone,r=o.pstnNumberService.formatPhoneNumber(c),s=(null===r||void 0===r?void 0:r.isValid)&&(null===r||void 0===r?void 0:r.normalized);if(s&&!t.matchPhoneAliasInMeProfile(s,n)){var a=(null===r||void 0===r?void 0:r.display)||c,u=o.enableTflSmsCreate&&o.tflSmsAllowedPhoneNumberRegionCodes&&!_.isEmpty(o.tflSmsAllowedPhoneNumberRegionCodes)&&o.pstnNumberService.isValidNumberForAnyRegion(s,o.tflSmsAllowedPhoneNumberRegionCodes)?""+o.constants.tflConstants.people.smsUnverified.mriPrefix+s:""+o.constants.tflConstants.people.offNetwork.mriPrefixForPhone+s;i.push({mri:u,id:u+"|"+e.displayName,displayName:e.displayName,description:a,phone:s,source:e.source})}}}),i})},t.matchEmailAliasInMeProfile=function(e,t){var n=_.compact(t.emailsInfo);return!!(n&&n.length>0&&-1!==n.findIndex(function(t){return e===t.address||e.toLowerCase()===t.address.toLowerCase()}))},t.matchPhoneAliasInMeProfile=function(e,t){var n=_.compact(t.phonesInfo),o=e.startsWith("+")?e.substr(1):e;return!!(n&&n.length>0&&-1!==n.findIndex(function(e){return o===e.number}))},t.prototype.performSyncPageRetrieval=function(e,t,n,o,c,r,s){var a,u=this,l=this.$q.defer(),h=this.utilityService.generateUUID(),d=this.loggingService.newScenario(this.constants.scenarios.contactSyncService.getSyncPage),g=this.constants.urls.contacts.syncSource.get.replace("{source}",e).replace("{accountId}",t).replace("{connectedAccountId}",n).replace("{pageSize}",o.toString()).replace("toScd",c?"true":"false"),f=(a={},a[this.constants.headers.clientRequestId]=h,a[this.constants.headers.accept]=this.constants.headers.jsonContent,a);r&&(f.SkipToken=r),s&&(f.DeltaToken=s);var p={callType:this.constants.urls.contacts.syncSource.type,headers:f};return this.performApiGetDetailed(g,p).toNgPromise(this.$q).then(function(t){var n,o;if(t&&t.object){var c=t.object,r=(null===(n=c.contacts)||void 0===n?void 0:n.length)||0;u.logger.info("Retrieved "+r+" contact items."),d.stop({source:e,statusCode:t.statusCode,contactCount:r,clientRequestId:h}),c.contacts=null===(o=c.contacts)||void 0===o?void 0:o.map(function(e){var t;return i(i({},e),{displayName:e.displayName||"",phone:e.phone||"",email:(null===(t=e.email)||void 0===t?void 0:t.toLowerCase())||""})}),l.resolve(c)}else d.fail({source:e,statusCode:550,clientRequestId:h}),l.reject("Bad Response, response was empty")}).catch(function(t){d.fail({source:e,statusCode:t.statusCode,error:u.utilityService.getErrorLoggingString(t),clientRequestId:h}),l.reject(t)}),l.promise},t}(SkypeX.Services.GenericRestClient);t.ContactSyncService=u,angular.module("teamspace.contactSyncService",["teamspace.settingsService","teamspace.config","teamspace.loggingService","teamspace.constants","teamspace.pstnNumberService","teamspace.peopleService","skypeX.myUserPreferencesStore"]).service("contactSyncService",u)},360:function(e,t,n){"use strict";var o=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();Object.defineProperty(t,"__esModule",{value:!0});var i,c=n(361);!function(e){e[e.None=0]="None",e[e.NotificationNotNeeded=1]="NotificationNotNeeded",e[e.NotificationNeeded=2]="NotificationNeeded",e[e.NotificationAcknowledged=3]="NotificationAcknowledged"}(i||(i={}));var r=function(e){function t(t,n,o,c,r,s,a,u,l,h,d,g,f){var p=e.call(this,s.valueFor(a.settings.names.middleTierConstants).newEndpointAddress,s,a,t,o,n,r,l)||this;return p.$http=t,p.$qNoApply=n,p.$q=o,p.authenticationService=r,p.settingsService=s,p.constants=a,p.loggingService=u,p.appStateService=l,p.utilityService=h,p.storageService=d,p.eventingService=g,p.myUserPreferencesStore=f,p.stampValue="true",p.logger=u.newLogger("RoamingDeviceContactsSyncProvider"),p.enableDeviceContactsSyncedNotification=s.valueAsBoolean(a.settings.names.enableDeviceContactsSyncedNotification),p.enableDeviceContactsSyncedUserSetting=s.valueAsBoolean(a.settings.names.enableDeviceContactsSyncedUserSetting),g.$on(c,a.events.contactSync.notificationAck,function(){p.logger.info("Notification acknowledged"),p.setConsentState(i.NotificationAcknowledged)}),g.unsafeOnWithTenantScope(a.events.settings.updated,function(e,t){(s.checkIfSettingHasChanged(t,a.settings.names.enableDeviceContactsSyncedNotification)||s.checkIfSettingHasChanged(t,a.settings.names.enableDeviceContactsSyncedUserSetting))&&(p.enableDeviceContactsSyncedNotification=s.valueAsBoolean(a.settings.names.enableDeviceContactsSyncedNotification),p.enableDeviceContactsSyncedUserSetting=s.valueAsBoolean(a.settings.names.enableDeviceContactsSyncedUserSetting))}),p.logger.info("created"),p}return o(t,e),t.prototype.discoverSources=function(){var e,t=this,n=this.$q.defer();if(!this.settingsService.valueFor(this.constants.settings.names.enableRoamingDeviceContactsSyncing))return this.logger.info("Syncing is not enabled"),n.resolve([]),n.promise;var o=this.utilityService.generateUUID(),r=this.loggingService.newScenario(this.constants.scenarios.contactSyncService.roamingDeviceContacts.getFolders),s=this.constants.urls.contacts.roaming.folders.get,a={callType:this.constants.urls.contacts.roaming.folders.type,headers:(e={},e[this.constants.headers.clientRequestId]=o,e[this.constants.headers.accept]=this.constants.headers.jsonContent,e)};return this.performApiGetDetailed(s,a).toNgPromise(this.$q).then(function(e){if(e&&e.object&&e.object.value){var s=e.object,a=t.settingsService.valueFor(t.constants.settings.names.maxRoamingDeviceContactsFolders),u=s.value.sort(function(e,t){var n=e.deviceTimestamp||0,o=t.deviceTimestamp||0;return n>o?-1:n<o?1:e.deviceId<t.deviceId?-1:e.deviceId>t.deviceId?1:0}).slice(0,a).map(function(e){return{sourceType:c.SourceType.Device,accountId:e.deviceId,connectedAccountId:e.id,shouldSendToScd:!1}});if(t.logger.info("Retrieved "+s.value.length+" roaming contact folders, using "+u.length+"."),r.stop({statusCode:e.statusCode,folderCount:s.value.length,folderCountAllowed:u.length,clientRequestId:o}),t.enableDeviceContactsSyncedNotification){var l=t.getConsentState();l==i.None&&(u.length>0?(t.logger.info("First run with some sources found, we'll notify user"),l=i.NotificationNeeded):(t.logger.info("First run with no sources found"),l=i.NotificationNotNeeded),t.setConsentState(l))}n.resolve(u)}else r.fail({statusCode:550,clientRequestId:o}),n.reject("Bad Response, response was empty")}).catch(function(e){r.fail({statusCode:e.statusCode,error:t.utilityService.getErrorLoggingString(e),clientRequestId:o}),n.reject(e)}),n.promise},t.prototype.syncCompleted=function(){this.enableDeviceContactsSyncedNotification&&this.getConsentState()===i.NotificationNeeded&&(this.logger.info("Sync succeeded, notifying user"),this.eventingService.$emit(this.constants.events.contactSync.notification))},t.prototype._getAuthHeaders=function(e,t,n){return this.authenticationService.getAuthHeaders({},void 0,t?[t]:void 0)},t.prototype.getAuthConfig=function(){return{}},t.prototype.getConsentState=function(){var e;return this.enableDeviceContactsSyncedUserSetting&&(null===(e=this.myUserPreferencesStore.getUserPreferences())||void 0===e?void 0:e.deviceContactsSyncedShown)===this.stampValue?i.NotificationAcknowledged:this.storageService.get(this.constants.storageNames.contactSyncDeviceConsentState)||i.None},t.prototype.setConsentState=function(e){this.storageService.set(this.constants.storageNames.contactSyncDeviceConsentState,e),this.enableDeviceContactsSyncedUserSetting&&e===i.NotificationAcknowledged&&this.myUserPreferencesStore.setUserPreference(SkypeX.Services.MyUserPreferenceStorageKey.DeviceContactsSyncedShown,this.stampValue)},t}(SkypeX.Services.GenericRestClient);t.RoamingDeviceContactsSyncProvider=r},361:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});!function(e){e.Device="device",e.Outlook="outlook",e.Skype="skype",e.Google="google"}(t.SourceType||(t.SourceType={}))},362:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(361),i=function(){function e(e,t,n,o,i){this.$q=e,this.authenticationService=t,this.settingsService=n,this.constants=o,this.loggingService=i,this.logger=i.newLogger("OutlookContactsSyncProvider"),this.logger.info("created")}return e.prototype.discoverSources=function(){var e=this;return this.settingsService.valueFor(this.constants.settings.names.enableOutlookContactsSyncing)?this.authenticationService.getUserInformation().then(function(t){return e.logger.info("Using Outlook contacts syncing."),[{sourceType:o.SourceType.Outlook,accountId:t.userName,connectedAccountId:void 0,shouldSendToScd:!0}]}).catch(function(t){return e.$q.reject(t)}):(this.logger.info("Syncing is not enabled"),this.$q.resolve([]))},e.prototype.syncCompleted=function(){},e}();t.OutlookContactsSyncProvider=i}},[2849]);