var msRDCRTC;!function(e){window.vdiPeerConnection=e()}(function(e,t){"use strict";function i(e,t){t.forEach(function(t){Object.defineProperty(e,t,{enumerable:!0,get:function(){return this.readOnlyAttributes[t]},set:function(){throw new TypeError}})})}function n(e,t){t.forEach(function(t){var i=t[0],n=t[1],r=t[2];e.observableAttributes[i]=n,Object.defineProperty(e,i,{enumerable:!0,get:function(){return this.observableAttributes[i]},set:function(e){this.observableAttributes[i]=e,r()}})})}function r(e,t){t.forEach(function(t){var i=t[0],n=t[1],r=t[2];Object.defineProperty(e,i,{enumerable:!0,get:function(){return n(i)},set:function(e){return r(i,e)}})})}function c(e,t){t.forEach(function(t){var c=t[0],o=t[1];if(Object.defineProperty(e,c,{enumerable:!1,writable:!0,value:o}),"readOnlyAttributes"===c){var a=[];for(var c in o)a.push(c);i(e,a)}else"observableAttributes"===c?n(e,o):"customAttributes"===c&&r(e,o)})}function o(e,t){var i="on"+t,n=e.observableAttributes[i],r=e.eventListeners[i];e.eventListeners[i]=n,null!=r&&e.removeEventListener(t,r,!1),null!=n&&e.addEventListener(t,n,!1)}function a(e){return e?e.match(/[0-9a-f]{2}/gi).reverse().join(""):""}function s(){var e=this;c(this,[["customAttributes",[["size",function(){return e.getSize()},J]]]])}function d(e){return e<0&&(e+=4294967296),"0x"+e.toString(16)}function u(e){var t=[];e.forEach(function(e){t[e.name]={listeners:[],level:e.level}}),this.eventTarget=void 0,this.eventList=t}function h(e,t){return new Promise(function(i,n){if(t)(o={}).width=e.width,o.height=e.height,o.data=e.base64PNGData.replace(/^data:image\/(png|jpg);base64,/,""),i(o);else{var r=document.createElement("canvas");r.width=e.width,r.height=e.height;var c=r.getContext("2d"),o=new Image(e.width,e.height);o.addEventListener("load",function(){c.drawImage(o,0,0,r.width,r.height),i(c.getImageData(0,0,r.width,r.height))},!1),o.src=e.base64PNGData}})}function l(e,t,i){c(this,[["readOnlyAttributes",{rpcObjectType:"ScreenCaptureSource"}]]),this.sourceId=e,this.sharingSourceType=t,this.description=i}function p(e){c(this,[["id",e],["events",new Map],["maxListeners",10]])}function v(){c(this,[["readOnlyAttributes",{rpcObjectType:"HidManager"}],["hidDevices",new Array],["eventEmitter",new p("HidManager")]])}function f(e){c(this,[["readOnlyAttributes",{rpcObjectType:"HidDevice"}],["id",e],["eventEmitter",new p("HidDevice("+e+")")]])}function g(){var e=navigator.mediaDevices,t=new u([{name:"devicechange",level:"info"}]);t.setEventTarget(e);var i=this;c(this,[["readOnlyAttributes",{rpcObjectType:"MediaDevices",actualMediaDevicesAddEventListener:e.addEventListener,actualMediaDevicesRemoveEventListener:e.removeEventListener,actualMediaDevicesGetUserMedia:e.getUserMedia,actualMediaDevicesEnumerateDevices:e.enumerateDevices,actualMediaDevicesGetDisplayMedia:e.getDisplayMedia,actualMediaDevicesGetScreensAsync:e.getScreensAsync,actualMediaDevicesSetScreenSharePanelId:e.setScreenSharePanelId}],["observableAttributes",[["ondevicechange",void 0,function(){o(i,"devicechange")}]]],["redirecting",!1],["mediaDevices",null],["audioOutputDevice",null],["eventManager",t],["eventListeners",new s],["deviceList",""],["pending",new Array]]);e.addEventListener=function(){return i.addEventListener.apply(i,arguments)},e.removeEventListener=function(){return i.removeEventListener.apply(i,arguments)},e.getUserMedia=function(){return i.getUserMedia.apply(i,arguments)},e.enumerateDevices=function(){return i.enumerateDevices.apply(i,arguments)},e.getDisplayMedia=function(){return i.getDisplayMedia.apply(i,arguments)},e.getScreensAsync=function(){return i.getScreensAsync.apply(i,arguments)},e.setScreenSharePanelId=function(){return i.setScreenSharePanelId.apply(i,arguments)}}function m(e){var t=this;_.debug("RTCDTMFSenderRedirector("+e+")"),c(this,[["readOnlyAttributes",{rpcObjectType:"RTCDTMFSender",rpcObjectId:e,canInsertDTMF:!0,toneBuffer:""}],["eventManager",new u([{name:"tonechange",level:"info"}])],["eventListeners",new s],["observableAttributes",[["ontonechange",null,function(){o(t,"tonechange")}]]]])}function b(e){c(this,[["readOnlyAttributes",{id:e.id,type:e.type,timestamp:new Date(e.timestamp),rawTimestamp:e.timestamp}]]);var t=new s;for(var i in e.stats)e.stats.hasOwnProperty(i)&&(t[i]=e.stats[i]);this.stats=t}function R(e){var t=new Array;void 0!=e&&e.reports.forEach(function(e){var i=new b(e);t.push(i)}),this.statsReports=t}function C(e){c(this,[["readOnlyAttributes",{peerConnectionRpcObjectId:e}],["operations",[]],["opExecutionScheduled",!1],["pendingOp",null],["closed",!1]])}function O(e,t){var i=this,n=msRDCRTC.getNextRpcObjectId();_.debug("RTCPeerConnectionRedirector("+n+") - config: "+JSON.stringify(e)+", constraints: "+JSON.stringify(t));var r=new u([{name:"negotiationneeded",level:"info"},{name:"icecandidate",level:"info"},{name:"icecandidateerror",level:"error"},{name:"signalingstatechange",level:"info"},{name:"iceconnectionstatechange",level:"info"},{name:"icegatheringstatechange",level:"info"},{name:"connectionstatechange",level:"info"},{name:"track",level:"info"},{name:"addstream",level:"info"},{name:"removestream",level:"info"},{name:"statsended",level:"info"},{name:"datachannel",level:"info"}]);c(this,[["readOnlyAttributes",{rpcObjectType:"RTCPeerConnection",rpcObjectId:n,currentLocalDescription:null,pendingLocalDescription:null,currentRemoteDescription:null,pendingRemoteDescription:null,signalingState:"stable",iceGatheringState:"new",iceConnectionState:"new",connectionState:"new",canTrickleIceCandidates:null}],["observableAttributes",[["onnegotiationneeded",void 0,function(){o(i,"negotiationneeded")}],["onicecandidate",void 0,function(){o(i,"icecandidate")}],["onicecandidateerror",void 0,function(){o(i,"icecandidateerror")}],["onsignalingstatechange",void 0,function(){o(i,"signalingstatechange")}],["oniceconnectionstatechange",void 0,function(){o(i,"iceconnectionstatechange")}],["onicegatheringstatechange",void 0,function(){o(i,"icegatheringstatechange")}],["onconnectionstatechange",void 0,function(){o(i,"connectionstatechange")}],["ontrack",void 0,function(){o(i,"track")}],["onaddstream",void 0,function(){o(i,"addstream")}],["onremovestream",void 0,function(){o(i,"removestream")}],["onstatsended",void 0,function(){o(i,"statsended")}],["ondatachannel",void 0,function(){o(i,"datachannel")}]]],["customAttributes",[["localDescription",function(){return i.getLocalDescription()},J],["remoteDescription",function(){return i.getRemoteDescription()},J]]],["eventManager",r],["eventListeners",new s],["configuration",e],["closed",!1],["senders",[]],["receivers",[]],["transceivers",[]],["unifiedPlan",!1],["defaultIceServers",[]],["sendCapabilities",{}],["recvCapabilities",{}],["stats",void 0],["operationQueue",new C(n)],["ready",!1],["eventMap",{signalingstatechange:"signalingState",iceconnectionstatechange:"iceConnectionState",icegatheringstatechange:"iceGatheringState",connectionstatechange:"connectionState"}]]),0!==msRDCRTC.debugLevel&&(this.debugPeriodicCallback=function(){var e=performance.now(),t=i.pendingOp;if(null!=t&&void 0==t.completed){var n=e-t.started;n>=5e3?void 0==t.hung&&(_.error('RTCPeerConnectionRedirector "rpcObjectId":'+i.rpcObjectId+', "opName":'+t.name+', "opId":'+t.id+" has not completed after "+n.toFixed(4)+" ms"),t.hung=!0):n>=1e3&&void 0==t.warned&&(_.warn('RTCPeerConnectionRedirector "rpcObjectId":'+i.rpcObjectId+', "opName":'+t.name+', "opId":'+t.id+" has not completed after "+n.toFixed(4)+" ms"),t.warned=!0)}i.operationQueue.operations.forEach(function(t){var n=e-t.queued;n>=5e3?void 0==t.hung&&(_.error('RTCPeerConnectionRedirector "rpcObjectId":'+i.rpcObjectId+', "opName":'+t.name+', "opId":'+t.id+" has been waiting in the queue for "+n.toFixed(4)+" ms"),t.hung=!0):n>=1e3&&void 0==t.warned&&(_.warn('RTCPeerConnectionRedirector "rpcObjectId":'+i.rpcObjectId+', "opName":'+t.name+', "opId":'+t.id+" has been waiting in the queue for "+n.toFixed(4)+" ms"),t.warned=!0)})});var a=msRDCRTC.clientVersionGreaterThanOrEqual("1.1.2106.04001");if(a||(this.addTransceiver=void 0),null!=this.configuration&&void 0!=this.configuration&&"unified-plan"===this.configuration.sdpSemantics){if(!a)throw new Error({name:"WebRTC 1.0 Unsupported",message:"The WebRTC Redirector Plugin must be version 1.1.2105.21001 or later  - current version="+msRDCRTC.WEBRTC_REDIRECTOR_VERSION});this.unifiedPlan=!0,_.info('WebRTC 1.0 will be used for RTCPeerConnectionRedirector "rpcObjectId":'+this.rpcObjectId)}this.operationQueue.queueOperation(this.rpcObjectType,"createPeerConnection",function(){return i.makeRpcCall("createPeerConnection",[e,t]).then(function(e){_.debug("RTCPeerConnectionRedirector("+i.rpcObjectId+")::createPeerConnection - sendCapabilities: "+JSON.stringify(e.sendCapabilities)),_.debug("RTCPeerConnectionRedirector("+i.rpcObjectId+")::createPeerConnection - recvCapabilities: "+JSON.stringify(e.recvCapabilities)),i.sendCapabilities=e.sendCapabilities,i.recvCapabilities=e.recvCapabilities,i.senders.forEach(function(e){e.readOnlyAttributes.capabilities=i.sendCapabilities}),i.unifiedPlan&&i.transceivers.forEach(function(e){e.sender.readOnlyAttributes.capabilities=i.sendCapabilities}),i.ready=!0})})}function T(e,t,i,n,r){var a=this,d=void 0==i?msRDCRTC.getNextRpcObjectId():i;void 0==n&&(n=msRDCRTC.generateUuid()),_.debug("MediaStreamRedirector("+d+") - id: "+n+", devices: "+JSON.stringify(t));if(c(this,[["readOnlyAttributes",{rpcObjectType:"MediaStream",rpcObjectId:d,id:n,constraints:e}],["observableAttributes",[["onaddtrack",void 0,function(){o(a,"addtrack")}],["onremovetrack",void 0,function(){o(a,"removetrack")}]]],["customAttributes",[["active",function(){return a.getIsActive()},void 0]]],["eventManager",new u([{name:"addtrack",level:"info"},{name:"removetrack",level:"info"}])],["eventListeners",new s],["audioTracks",[]],["videoTracks",[]],["devices",t]]),void 0==i&&(this.makeRpcCall("createMediaStream",[{id:this.id,constraints:this.constraints}]),void 0==r))for(var h in t){var l=new E(this,t[h]);this.addTrack(l)}}function E(e,t,i,n,r){var a=this,d=void 0==i?msRDCRTC.getNextRpcObjectId():i;void 0==n&&(n=msRDCRTC.generateUuid());var h=null;if(void 0!=r)h=r;else if("audioinput"===t.kind||"audiooutput"===t.kind)h="audio";else if("videoinput"===t.kind)h="video";else{if("displayoutput"!==t.kind)throw new Error({name:"MSRDCRTC: E_NOTIMPL",message:"device not supported - kind="+t.kind});h="screenshare"}_.debug("MediaStreamTrackRedirector("+d+") - id: "+n+", kind: "+h+", stream rpcObjectId: "+e.rpcObjectId);var l=new u([{name:"mute",level:"info"},{name:"unmute",level:"info"},{name:"ended",level:"info"},{name:"overconstrained",level:"warn"}]),p=void 0;"audio"===h&&n.match(/.*-(\d+)$/)&&(p=n.replace(/.*-(\d+)$/,"$1")),c(this,[["readOnlyAttributes",{rpcObjectType:"MediaStreamTrack",rpcObjectId:d,mediaStreamRpcObjectId:e.rpcObjectId,deviceRpcObjectId:t.rpcObjectId,kind:h,id:n,label:t.label,muted:!1,readyState:"live"}],["observableAttributes",[["enabled",!0,function(){a.onEnabledAttributeChanged()}],["onmute",void 0,function(){o(a,"mute")}],["onunmute",void 0,function(){o(a,"unmute")}],["onended",void 0,function(){o(a,"ended")}],["onoverconstrained",void 0,function(){o(a,"overconstrained")}]]],["mediaStream",e],["device",t],["eventManager",l],["eventListeners",new s],["ssrc",p],["constraints",void 0]]),void 0==i&&this.makeRpcCall("createMediaStreamTrack",[{mediaStreamRpcObjectId:e.rpcObjectId,id:this.id,kind:this.kind,label:this.label}])}function S(e,t,i){var n=this,r=void 0==i?msRDCRTC.getNextRpcObjectId():i;_.debug("RTCRtpTransceiverRedirector("+r+") - pc rpcObjectId: "+e.rpcObjectId+" kind: "+t);c(this,[["readOnlyAttributes",{rpcObjectType:"RTCRtpTransceiver",rpcObjectId:r,peerConnectionRpcObjectId:e.rpcObjectId,peerConnectionOperationQueue:e.operationQueue,currentDirection:null,kind:t}],["customAttributes",[["direction",function(){return n.getDirection()},function(e,t){return n.setDirection(t)}]]],["sender",null],["receiver",null],["mid",null],["stopped",!1],["stopping",!1],["usedToSend",!1],["preferredCodecs",void 0]])}function y(e,t,i,n,r){var o=void 0==r?msRDCRTC.getNextRpcObjectId():r,a=void 0!==t.kind,s=a?t.kind:t;_.debug("RTCRtpSenderRedirector("+o+") - kind: "+s+", pc rpcObjectId: "+e.rpcObjectId);var d=null;"audio"===s&&(d=new m(o)),c(this,[["readOnlyAttributes",{rpcObjectType:"RTCRtpSender",rpcObjectId:o,peerConnectionOperationQueue:e.operationQueue,kind:s,transport:null,rtcpTransport:null,dtmf:d}],["track",a?t:void 0],["ready",!1],["streams",i],["sendEncodings",n],["capabilities",e.sendCapabilities],["transceiver",void 0]])}function I(e,t,i,n){var r=void 0==i?msRDCRTC.getNextRpcObjectId():i;_.debug("RTCRtpReceiverRedirector("+r+") - kind: "+t+", pc rpcObjectId: "+e.rpcObjectId),c(this,[["readOnlyAttributes",{rpcObjectType:"RTCRtpReceiver",rpcObjectId:r,peerConnectionOperationQueue:e.operationQueue,track:void 0==n?null:n,kind:t,transport:null,rtcpTransport:null}],["parameters",null],["contributingSources",[]],["synchronizationSources",[]],["capabilities",e.recvCapabilities],["lastAudioReceived",void 0],["transceiver",void 0]])}function N(e,t,i,n){var r=this,a=void 0==n?msRDCRTC.getNextRpcObjectId():n,d=void 0!=i&&void 0!=i.id;if(_.debug("RTCDataChannelRedirector("+a+") - pc rpcObjectId: "+e.rpcObjectId+" label: "+t+" fHasInitParams:"+d),new Blob([t]).size>65535)throw new InvalidStateError;if(d&&1==i.negotiated&&void 0!=i.id&&new Blob([i.id]).size>65535)throw new InvalidStateError;var h=new u([{name:"open",level:"info"},{name:"bufferedamountlow",level:"info"},{name:"error",level:"error"},{name:"closing",level:"info"},{name:"close",level:"info"},{name:"message",level:"info"}]);h.channel=this,c(this,[["readOnlyAttributes",{rpcObjectType:"RTCDataChannel",rpcObjectId:a,label:t,ordered:!!d&&i.ordered,maxPacketLifeTime:d?i.maxPacketLifeTime:null,maxRetransmits:d?i.maxRetransmits:null,protocol:d?i.protocol:"",negotiated:!!d&&i.negotiated,peerConnectionRpcObjectId:e.rpcObjectId,peerConnectionOperationQueue:e.operationQueue}],["observableAttributes",[["onopen",void 0,function(){o(r,"open")}],["onbufferedamountlow",void 0,function(){o(r,"bufferedamountlow")}],["onerror",void 0,function(){o(r,"error")}],["onclosing",void 0,function(){o(r,"closing")}],["onclose",void 0,function(){o(r,"close")}],["onmessage",void 0,function(){o(r,"message")}]]],["id",d&&1==negotiated?i.id:null],["binaryType","blob"],["readyState","connecting"],["bufferedAmount",0],["eventManager",h],["eventListeners",new s]])}function D(e,t,i){var n=this,r=msRDCRTC.getNextRpcObjectId(),o=a(i);_.debug("MediaElementRedirector("+r+") - kind: "+e+", windowHandle: "+o);var d=new u([{name:"loadstart",level:"info"},{name:"abort",level:"info"},{name:"emptied",level:"info"},{name:"stalled",level:"info"},{name:"play",level:"info"},{name:"pause",level:"info"},{name:"loadedmetadata",level:"info"},{name:"loadeddata",level:"info"},{name:"waiting",level:"info"},{name:"playing",level:"info"},{name:"canplay",level:"info"},{name:"canplaythrough",level:"info"},{name:"ended",level:"info"},{name:"durationchange",level:"info"},{name:"volumechange",level:"info"},{name:"timeupdate",level:"ignore"},{name:"progress",level:"ignore"},{name:"contextmenu",level:"info"},{name:"error",level:"error"}]);d.setEventTarget(t);var h=function(e){return n.getAttribute(e)},l=function(e,t){return n.setAttribute(e,t)};c(this,[["readOnlyAttributes",{rpcObjectType:"MediaElement",rpcObjectId:r,kind:e,duration:Number.NaN,readyState:this.HAVE_NOTHING,networkState:this.NETWORK_EMPTY,paused:t.paused,currentTime:0,ended:!1}],["redirecting",!1],["mediaElement",t],["eventManager",d],["eventListeners",new s],["actualGetAttribute",t.getAttribute],["actualSetAttribute",t.setAttribute],["actualRemoveAttribute",t.removeAttribute],["actualAddEventListener",t.addEventListener],["actualRemoveEventListener",t.removeEventListener],["actualPlay",t.play],["actualPause",t.pause],["actualLoad",t.load],["actualSetSinkId",t.setSinkId],["getAttributeFunctor",h],["setAttributeFunctor",l],["removeAttributeFunctor",function(e){return n.removeAttribute(e)}],["addEventListenerFunctor",function(e,t,i){return n.addEventListener(e,t,i)}],["removeEventListenerFunctor",function(e,t,i){return n.removeEventListener(e,t,i)}],["onResizeFunctor",function(){return n.onPositionChanged("onresize")}],["playFunctor",function(){return n.play()}],["pauseFunctor",function(){return n.pause()}],["loadFunctor",function(){return n.load()}],["setSinkIdFunctor",function(e){return n.setSinkId(e)}],["srcObject",null],["autoplay",t.autoplay],["muted",t.muted],["volume",t.volume],["videoWidth",0],["videoHeight",0],["lastPlayAt",0],["progressIntervalId",void 0],["boundingRect",void 0],["scaleFactor",void 0],["objectFit",t.style.objectFit],["windowHandle",o]]),c(t,[["customAttributes",[["srcObject",h,l],["loop",h,l],["autoplay",h,l],["muted",h,l],["volume",h,l]]]]);var p=[e,o];if("video"===e){c(t,[["observableAttributes",[["data-vdi_videoid",t["data-vdi_videoid"],function(){n.onVdiVideoIdChanged()}],["data-toggle",t["data-toggle"],function(){n.onVdiDataToggleChanged()}]]]]);var v=t.getBoundingClientRect();_.debug("MediaElementRedirector("+r+") - bounding client rect: "+JSON.stringify(v)),this.boundingRect=v,p.push({top:v.top,right:v.right,bottom:v.bottom,left:v.left}),Object.defineProperty(t,"videoWidthFromRedirector",{value:1280,writable:!0}),Object.defineProperty(t,"videoHeightFromRedirector",{value:768,writable:!0}),delete t.videoWidth,Object.defineProperty(t,"videoWidth",{get:function(){return t.videoWidthFromRedirector}}),delete t.videoHeight,Object.defineProperty(t,"videoHeight",{get:function(){return t.videoHeightFromRedirector}})}this.makeRpcCall("createMediaElement",p)}function A(e,t){var i=(e+t).replace(/-/g,"").match(/[0-9a-f]{2}/gi),n=new ArrayBuffer(i.length),r=new Uint8Array(n);for(var c in i)r[c]=parseInt(i[c],16);this.rawKey=n,this.key=void 0}function k(){this.vmEventCallback=void 0,this.connectionState=this.STATE_NOT_CONNECTED,this.endpointUnsupported=!1,this.webSocketUnavailable=!1,this.clientFeatures=void 0,this.debugLevel=0,this.socket=null,this.socketConnected=!1,this.socketClosed=!0,this.rtcSessionStarted=!1,this.enumerateDevicesOnConnect=!1,this.attachHidDevicesOnConnect=!1,this.pendingMessages=[],this.outstandingRpcCalls=new s,this.actualRTCPeerConnection=RTCPeerConnection,this.actualMediaStream=MediaStream,this.hidManagerRedirector=new v,this.mediaDevicesRedirector=new g,this.rtcObjects=[this.mediaDevicesRedirector,this.hidManagerRedirector],this.recvCapabilities=void 0,this.nextPeerConnectionId=1,this.nextMediaStreamId=1,this.nextVideoElementId=1,this.nextRpcObjectId=1,this.nextRpcCallId=1,this.nextOperationId=1,this.uniqueIds=new s,this.defaultSinkId=void 0,this.notifications=new s;var e=this;this.onWebSocketOpenFunctor=function(t){e.onWebSocketOpen(t)},this.onWebSocketClosedFunctor=function(t){e.onWebSocketClosed(t)},this.onWebSocketErrorFunctor=function(t){e.onWebSocketError(t)},this.onWebSocketMessageFunctor=function(t){e.onWebSocketMessage(t)}}var j,w={debug:function(){},info:function(e){j.info("MSRDCRTC: [I] "+e)},warn:function(e){j.warn("MSRDCRTC: [W] "+e)},error:function(e){j.error("MSRDCRTC: [E] "+e)}},M={debug:function(e){j.debug("MSRDCRTC: [D] "+e)},info:function(e){j.info("MSRDCRTC: [I] "+e)},warn:function(e){j.warn("MSRDCRTC: [W] "+e)},error:function(e){j.error("MSRDCRTC: [E] "+e)}},P={debug:function(e){console.debug("MSRDCRTC: [D] "+e)},info:function(e){console.info("MSRDCRTC: [I] "+e)},warn:function(e){console.warn("MSRDCRTC: [W] "+e)},error:function(e){console.error("MSRDCRTC: [E] "+e)}},_=w,L=function(){},J=function(){throw new TypeError},V=function(){throw new InvalidStateError};return s.prototype={forEach:function(e){for(var t in this)"size"!==t&&this.hasOwnProperty(t)&&e(t)},get:function(e){return this[e]},has:function(e){return void 0!=this[e]},keys:function(){var e=[];return this.forEach(function(t){e.push(t)}),e},values:function(){var e=[],t=this;return this.forEach(function(i){e.push(t.get(i))}),e},getSize:function(){return this.keys().length}},u.prototype={addEventListener:function(e,t,i){var n=this.eventList[e];void 0!=n?n.listeners.push(t):_.warn("EventManager::addEventListener() called for unexpected event: "+e)},removeEventListener:function(e,t,i){var n=this.eventList[e];if(void 0!=n){var r=n.listeners;for(var c in r)if(r[c]===t){r.splice(c,1);break}}else _.warn("EventManager::removeEventListener() called for unexpected event: "+e)},setEventTarget:function(e){this.eventTarget=e},fireEvent:function(e,t){var i=this.eventList[e];if(void 0==i)return _.warn("event not expected: "+e),!1;var n=i.level;"ignore"!==n&&("debug"===n?_.debug:"info"===n?_.info:"warn"===n?_.warn:_.error)("EventManager::fireEvent('"+e+"')");var r=document.createEvent("HTMLEvents");if(r.initEvent(e,!1,!0),void 0!=t)for(var c in t)r[c]=t[c];if(void 0!=this.eventTarget)this.eventTarget.dispatchEvent(r);else{if(void 0!=this.channel){var o=new EventTarget;o.label=this.channel.label,o.id=this.channel.id,o.dispatchEvent(r)}i.listeners.forEach(function(e){e(r)})}return!0}},l.prototype={getId:function(){return _.debug("ScreenCaptureSource::getId() returning "+this.sourceId),this.sourceId},getDeviceId:function(){return _.debug("ScreenCaptureSource::getDeviceId() returning "+this.description),this.description},getType:function(){return _.debug("ScreenCaptureSource::getType() returning "+this.sharingSourceType),this.sharingSourceType},getPreview:function(e,t,i){return _.debug("ScreenCaptureSource::getPreview(width: "+e+" height: "+t+" asImage: "+i+")"),new Promise(function(e,t){t(null)})},getPreviewAsync:function(e,t,i){var n=this;return _.debug("ScreenCaptureSource::getPreviewAsync(width: "+e+" height: "+t+" asImage: "+i+")"),new Promise(function(r,c){n.makeRpcCall("getPreviewAsync",[{width:e,height:t,sourceId:n.sourceId}],!0).then(function(e){_.debug("ScreenCaptureSource::getPreviewAsync returning"+JSON.stringify(e)+")"),h(e,i).then(function(e){_.debug("ScreenCaptureSource::getPreviewAsync imageData: "+JSON.stringify(e)+")"),r(e)})}).catch(function(e){c(e)})})},getBounds:function(){var e=this;return new Promise(function(t,i){e.makeRpcCall("getBounds",[],!0).then(function(e){_.debug("ScreenCaptureSource::getBounds returning (x:"+e.x+" y:"+e.y+" width:"+e.width+" height:"+e.height+NaN),t(e)}).catch(function(e){i(e)})})},getDescription:function(){return _.debug("ScreenCaptureSource::getDescription() returning "+this.description),this.description},getIcon:function(e,t){return _.debug("ScreenCaptureSource::getIcon(width: "+e+" height: "+t+")"),new Promise(function(e,t){t(null)})},makeRpcCall:function(e,t,i){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcName:e,rpcArgs:t},i)}},p.prototype={addListener:function(e,t){return _.debug("EventEmitter::addListener() ["+this.id+"] caching listener ["+t+"] for event ["+e+"]"),this.cacheListener(e,t,!1),this},on:function(e,t){return _.debug("EventEmitter::on() ["+this.id+"] caching listener ["+t+"] for event ["+e+"]"),this.cacheListener(e,t,!1),this},once:function(e,t){return _.debug("EventEmitter::once() ["+this.id+"] caching listener ["+t+"] for event ["+e+"]"),this.cacheListener(e,t,!0),this},removeListener:function(e,t){if("function"!=typeof t)_.error("EventEmitter::removeListener() ["+this.id+"] listener ["+t+"] is not a function");else{var i=this.events.get(e);if(void 0==i)_.debug("EventEmitter::removeListener() ["+this.id+"] no listeners found for event ["+e+"]");else{var n=i.indexOf(t);n>=0?(i.splice(n,1),this.events.set(e,i),_.debug("EventEmitter::removeListener() ["+this.id+"] removed listener ["+t+"] for event ["+e+"]")):_.debug("EventEmitter::removeListener() ["+this.id+"] for event ["+e+"] does not contain listener ["+t+"]")}}return this},removeAllListeners:function(e){_.debug("EventEmitter::removeAllListeners() ["+this.id+"] for event ["+e+"]");var t=this.events.get(e);return void 0==t?_.debug("EventEmitter::removeAllListeners() ["+this.id+"] no listeners found for event ["+e+"]"):(t.clear(),this.events.set(e,t),_.debug("EventEmitter::removeAllListeners() ["+this.id+"] removed all listeners")),this},getMaxListeners:function(){return _.debug("EventEmitter::getMaxListeners() returning value ["+this.maxListeners+"]"),this.maxListeners},setMaxListeners:function(e){_.debug("EventEmitter::setMaxListeners() to ["+e+"]"),this.maxListeners=e},listeners:function(e){return _.debug("EventEmitter::listeners() for event ["+e+"]"),this.events.get(e)},emit:function(e,t){_.debug("EventEmitter::emit() ["+this.id+"] for event ["+e+"] and args ["+JSON.stringify(t)+"]");var i=this.events.get(e);return void 0!=i&&0!=i.length&&(i.forEach(function(e,i,n){var r=e[0];e[1]&&n.splice(i,1),r(t)}),this.events.set(e,i),!0)},cacheListener:function(e,t,i){if("function"!=typeof t)_.error("EventEmitter::cacheListener() ["+this.id+"] listener ["+t+"] is not a function");else{var n=this.events.get(e);void 0==n&&(n=new Array),n.length>=this.maxListeners&&_.warn("EventEmitter::cacheListener() ["+this.id+"] for event ["+e+"] is has ["+n.length+"] listeners, but max is set to ["+this.maxListeners+"] listeners"),n.push([t,i]),this.events.set(e,n),_.debug("EventEmitter::cacheListener() ["+this.id+"] listener ["+t+"]  added for event ["+e+"] with once flag ["+i+"]")}}},v.prototype={DeviceFilter_Telephony:1,startWithDeviceFilter:function(e,t){_.debug("HidManagerRedirector::startWithDeviceFilter("+JSON.stringify(arguments)+")");var i=this;return new Promise(function(t,n){i.makeRpcCall("startWithDeviceFilter",[{deviceFilter:e}]).then(function(e){_.debug("HidManagerRedirector::startWithDeviceFilter() RPC call succeeded with result ("+JSON.stringify(e)+")"),t()}).catch(function(e){n(e)})})},stop:function(){_.debug("HidManagerRedirector::stop()");var e=this;return new Promise(function(t,i){e.makeRpcCall("stop",[]).then(function(e){_.debug("HidManagerRedirector::stop() RPC call succeeded with result ("+JSON.stringify(e)+")"),t()}).catch(function(e){i(e)})})},forEachDevice:function(e){_.debug("HidManagerRedirector::forEachDevice("+e+")");var t=this;return new Promise(function(i,n){t.makeRpcCall("enumerateDevices",arguments).then(function(n){_.debug("HidManagerRedirector::enumerateDevices() RPC call succeeded with "+n.length+" device(s).");for(var r in n){var c=n[r].identifier,o=t.addDevice(c);e(o),_.debug("HidManagerRedirector::forEachDevice() callback triggered for hidDevice with id ["+c+"].")}i()}).catch(function(e){n(e)})})},onRpcEventNotification:function(e){var t=!1;if(e.rpcEventTarget.rpcObjectType===this.rpcObjectType)"device-attached"===e.rpcEventName?(this.addDeviceAndEmitDeviceAttached(e.rpcEventArgs.deviceId),t=!0):"device-detached"===e.rpcEventName&&(this.removeDeviceAndEmitDeviceDetached(e.rpcEventArgs.deviceId),t=!0);else if("HidDevice"===e.rpcEventTarget.rpcObjectType){var i=this.findDevice(e.rpcEventArgs.deviceId);i&&(t=i.onRpcEventNotification(e))}return t},makeRpcCall:function(e,t,i){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcName:e,rpcArgs:t},i)},addDevice:function(e){for(var t,i=0;i<this.hidDevices.length;i++){var n=this.hidDevices[i];if(n.id===e){t=n;break}}return void 0!=t?_.debug("HidManagerRedirector::addDevice() Device already exists in HidDeviceManager with id ["+e+"]."):(t=new f(e),this.hidDevices.push(t),_.debug("HidManagerRedirector::addDevice() Created new hidDevice with id ["+e+"].")),t},removeDevice:function(e){for(var t,i=0;i<this.hidDevices.length;i++){var n=this.hidDevices[i];if(n.id===e){t=n,this.hidDevices.splice(i,1);break}}return t?_.debug("HidManagerRedirector::removeDevice() Successfully removed device from HidDeviceManager with id ["+e+"]."):_.warn("HidManagerRedirector::removeDevice() Device does not exist in HidDeviceManager with id ["+e+"]."),t},findDevice:function(e){for(var t=0;t<this.hidDevices.length;t++){var i=this.hidDevices[t];if(i.id===e)return i}},attachHidDevices:function(){_.debug("HidManagerRedirector::attachHidDevices()");var e=this;return new Promise(function(t,i){e.makeRpcCall("enumerateDevices",arguments).then(function(i){_.debug("HidManagerRedirector::enumerateDevices() RPC call succeeded with "+i.length+" device(s).");for(var n in i){var r=i[n];e.addDeviceAndEmitDeviceAttached(r.identifier)}t()}).catch(function(e){i(e)})})},detachHidDevices:function(){for(_.debug("HidManagerRedirector::detachHidDevices()");this.hidDevices.length>0;){var e=this.hidDevices[0];this.removeDeviceAndEmitDeviceDetached(e.id)}},addDeviceAndEmitDeviceAttached:function(e){var t={};t.device=this.addDevice(e),this.emit("device-attached",t)},removeDeviceAndEmitDeviceDetached:function(e){var t={};t.device=this.removeDevice(e),this.emit("device-detached",t)},addListener:function(e,t){return this.eventEmitter.addListener(e,t),this},on:function(e,t){return this.eventEmitter.on(e,t),this},once:function(e,t){return this.eventEmitter.once(e,t),this},removeListener:function(e,t){return this.eventEmitter.removeListener(e,t),this},removeAllListeners:function(e){return this.eventEmitter.removeAllListeners(e),this},getMaxListeners:function(){return this.eventEmitter.getMaxListeners()},setMaxListeners:function(e){this.eventEmitter.setMaxListeners(e)},listeners:function(e){return this.eventEmitter.listeners(e)},emit:function(e,t){var i={};return i.type=e,_.debug("HidManager::emit() ["+t.deviceId+"] for event ["+e+"]"),"device-attached"!==e&&"device-detached"!==e||(i.device=t.device),this.eventEmitter.emit(e,i)}},f.prototype={identifier:function(){_.debug("HidDeviceRedirector::identifier()");var e=this;return new Promise(function(t,i){t(e.id)})},property:function(e){_.debug("HidDeviceRedirector::property("+JSON.stringify(arguments)+")");var t=this;return new Promise(function(i,n){t.makeRpcCall("property",[{id:t.id,key:e}]).then(function(n){var r=n.property;_.debug("HidDeviceRedirector::property() RPC call for device ["+t.id+"] with key ("+e+") succeeded with property value ("+JSON.stringify(r)+")"),i(r)}).catch(function(e){n(e)})})},open:function(e){_.debug("HidDeviceRedirector::open()");var t=this;return new Promise(function(e,i){t.makeRpcCall("open",[{id:t.id}]).then(function(t){_.debug("HidDeviceRedirector::open() RPC status: "+t),e()}).catch(function(e){i(e)})})},close:function(){_.debug("HidDeviceRedirector::close()");var e=this;return new Promise(function(t,i){e.makeRpcCall("close",[{id:e.id}]).then(function(e){_.debug("HidDeviceRedirector::close() RPC status: "+e),t()}).catch(function(e){i(e)})})},setValue:function(e,t,i){var n=this;return _.debug("HidDeviceRedirector::setValue() for DeviceId: ["+n.id+"] with params: ("+e+", "+t+", "+i+")"),new Promise(function(r,c){n.makeRpcCall("setValue",[{id:n.id,usagePage:e,usage:t,value:i}]).then(function(c){_.debug("HidDeviceRedirector::setValue() RPC status: "+c+" DeviceId: ["+n.id+"] with params: ("+e+", "+t+", "+i+")"),r()}).catch(function(e){c(e)})})},setFeatureReport:function(e,t){var i=this;return _.debug("HidDeviceRedirector::setFeatureReport() for DeviceId: ["+i.id+"] and ReportId: ["+e+"] with data: "+t),new Promise(function(n,r){i.makeRpcCall("setFeatureReport",[{id:i.id,reportId:e,data:t}]).then(function(e){_.debug("HidDeviceRedirector::setFeatureReport() RPC status: "+e+"."),n()}).catch(function(e){r(e)})})},readFeatureReport:function(e){var t=this;return _.debug("HidDeviceRedirector::readFeatureReport() for DeviceId: ["+t.id+"] and ReportId: ["+e+"]"),new Promise(function(i,n){t.makeRpcCall("readFeatureReport",[{id:t.id,reportId:e}]).then(function(e){_.debug("HidDeviceRedirector::readFeatureReport() RPC status: "+e+"."),i(e)}).catch(function(e){n(e)})})},setOutputReport:function(e,t,i){return _.debug("HidDeviceRedirector::setOutputReport(NotYetImplemented)"),new Promise(function(e,t){e()})},allElements:function(){var e=this;return _.debug("HidDeviceRedirector::allElements() for DeviceId: ["+e.id+"]."),new Promise(function(t,i){e.makeRpcCall("allElements",[{id:e.id}]).then(function(e){_.debug("HidManagerRedirector::allElements() RPC call succeeded with "+e.length+" element(s)."),t(e)}).catch(function(e){i(e)})})},onRpcEventNotification:function(e){var t=!1;return e.rpcEventTarget.rpcObjectType===this.rpcObjectType&&"input-report"===e.rpcEventName&&e.rpcEventArgs.deviceId===this.id&&(this.emit("input-report",e.rpcEventArgs),t=!0),t},makeRpcCall:function(e,t,i){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcName:e,rpcArgs:t},i)},addListener:function(e,t){return this.eventEmitter.addListener(e,t),this},on:function(e,t){return this.eventEmitter.on(e,t),this},once:function(e,t){return this.eventEmitter.once(e,t),this},removeListener:function(e,t){return this.eventEmitter.removeListener(e,t),this},removeAllListeners:function(e){return this.eventEmitter.removeAllListeners(e),this},getMaxListeners:function(){return this.eventEmitter.getMaxListeners()},setMaxListeners:function(e){this.eventEmitter.setMaxListeners(e)},listeners:function(e){return this.eventEmitter.listeners(e)},emit:function(e,t){return _.debug("HidDevice::emit() ["+this.id+"] for event ["+e+"]"),this.eventEmitter.emit(e,t)}},g.prototype={enableRedirection:function(){this.redirecting=!0},disableRedirection:function(){this.redirecting=!1,this.mediaDevices=null,this.deviceList="",this.pending=new Array},addEventListener:function(e,t,i){_.debug("MediaDevicesRedirector adding event listener for: "+e),this.eventManager.addEventListener(e,t,i),this.actualMediaDevicesAddEventListener.apply(navigator.mediaDevices,arguments)},removeEventListener:function(e,t,i){_.debug("MediaDevicesRedirector removing event listener for: "+e),this.eventManager.removeEventListener(e,t,i),this.actualMediaDevicesRemoveEventListener.apply(navigator.mediaDevices,arguments)},enumerateDevices:function(){if(_.debug("MediaDevicesRedirector::enumerateDevices("+JSON.stringify(arguments)+")"),!this.redirecting)return _.info("returning empty array"),msRDCRTC.enumerateDevicesOnConnect=!0,msRDCRTC.attachHidDevicesOnConnect=!0,new Promise(function(e,t){e([])});var e=this;if(null!=this.mediaDevices)return new Promise(function(t,i){_.debug("MediaDevicesRedirector::enumerateDevices() returning: "+JSON.stringify(e.mediaDevices)),t(e.mediaDevices)});var t={},i=new Promise(function(e,i){t.resolve=function(t){_.debug("MediaDevicesRedirector::enumerateDevices() returning: "+JSON.stringify(t)),e(t)},t.reject=function(e){i(e)}});return this.pending.push(t),1==this.pending.length&&e.makeRpcCall("enumerateDevices",arguments).then(function(t){e.onEnumerateDevices(t),e.pending.forEach(function(e){e.resolve(t)}),e.pending=new Array}).catch(function(t){e.pending.forEach(function(e){e.reject(t)}),e.pending=new Array}),i},onEnumerateDevices:function(e){var t=JSON.stringify(e);if(t!==this.deviceList){this.deviceList=t,this.mediaDevices=e,this.audioOutputDevice=null;for(var i in e){var n=e[i];if("audiooutput"===n.kind&&null==this.audioOutputDevice){this.audioOutputDevice=n;break}}this.eventManager.fireEvent("devicechange")}},getUserMedia:function(){if(_.debug("MediaDevicesRedirector::getUserMedia("+JSON.stringify(arguments)+")"),!msRDCRTC.redirectionSupported())return _.info("passing through call to actual MediaDevices.getUserMedia"),this.actualMediaDevicesGetUserMedia.apply(navigator.mediaDevices,arguments);var e,t,i;if(arguments.length<=1?e=arguments[0]:(e=arguments[0],t=arguments[1],i=arguments[2]),void 0==e||0===Object.keys(e).length)throw new TypeError("getUserMedia() constraints must not be the empty set.");var n=!1,r=!1;if(!0===e||e.audio&&e.video?(n=!0,r=!0):e.audio?n=!0:e.video&&(r=!0),!n&&!r)throw new TypeError("getUserMedia() constraints not supported.");var c=this;return null==this.mediaDevices?new Promise(function(o,a){c.enumerateDevices().then(function(s){c.completeGetUserMedia(e,n,r,t,i,o,a)}).catch(function(e){a(e)})}):new Promise(function(o,a){c.completeGetUserMedia(e,n,r,t,i,o,a)})},completeGetUserMedia:function(e,t,i,n,r,c,o){var a,s,d=new Array;t&&e.audio&&(a=e.audio.deviceId),i&&e.video&&(s=e.video.deviceId);for(var u=void 0===a,h=void 0===s,l=!1,p=!1,v=null==this.mediaDevices?0:this.mediaDevices.length,f=0;f<v;++f){var g=this.mediaDevices[f];if(t&&"audioinput"===g.kind&&!l?(u||g.deviceId===a)&&(d.push(g),l=!0):i&&"videoinput"===g.kind&&!p&&(h||g.deviceId===s)&&(d.push(g),p=!0),l&&p)break}if(d.length>0){var m=new T(e,d);_.debug("MediaDevicesRedirector::getUserMedia returning: "+JSON.stringify(m)),void 0!=n?(n(m),c()):c(m)}else{var b=t?i?"audio or video":"audio":"video",R=new Error({name:"MSRDCRTC Error",message:"No "+b+" input device found."});void 0!=r&&r(R),o(R)}},getDisplayMedia:function(){_.debug("MediaDevicesRedirector::getDisplayMedia("+JSON.stringify(arguments)+")");var e,t,i;if(arguments.length<=1?e=arguments[0]:(e=arguments[0],t=arguments[1],i=arguments[2]),void 0==e||0===Object.keys(e).length)throw new TypeError("getDisplayMedia() constraints must not be the empty set.");var n=!0===e||e.video,r=this;return new Promise(function(c,o){r.completeGetDisplayMedia(e,n,t,i,c,o)})},completeGetDisplayMedia:function(e,t,i,n,r,c){var o=new Array;if(o.push(JSON.parse('{"deviceId":"display","kind":"displayoutput","label":"Session Desktop"}')),t&&e.video){var a=new T(e,o);_.debug("MediaDevicesRedirector::getDisplayMedia returning: "+JSON.stringify(a)),void 0!=i?(i(a),r()):r(a)}},onDeviceChange:function(e){this.onEnumerateDevices(e.mediaDevices)},onRpcEventNotification:function(e){var t=!1;return e.rpcEventTarget.rpcObjectType===this.rpcObjectType&&"devicechange"===e.rpcEventName&&(this.onDeviceChange(e.rpcEventArgs),t=!0),t},getScreensAsync:function(){_.debug("MediaDevicesRedirector::getScreensAsync()");var e=this;return new Promise(function(t,i){e.makeRpcCall("getScreensAsync",[],!0).then(function(e){var i=new Array;for(var n in e){var r=new l(e[n].sourceId,e[n].sharingSourceType,e[n].description);i.push(r)}_.debug("MediaDevicesRedirector::getScreensAsync returning: "+JSON.stringify(i)),t(i)}).catch(function(e){i(e)})})},setScreenSharePanelId:function(){_.debug("MediaDevicesRedirector::setScreenSharePanelId("+JSON.stringify(arguments)+")");var e=arguments[0];this.makeRpcCall("setScreenSharePanelId",[{id:e}])},makeRpcCall:function(e,t,i){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcName:e,rpcArgs:t},i)}},m.prototype={addEventListener:function(e,t,i){_.debug("RTCDTMFSenderRedirector("+this.rpcObjectId+") - adding event listener for: "+e),this.eventManager.addEventListener(e,t,i)},removeEventListener:function(e,t,i){_.debug("RTCDTMFSenderRedirector("+this.rpcObjectId+") - removing event listener for: "+e),this.eventManager.removeEventListener(e,t,i)},insertDTMF:function(e,t,i){_.debug("RTCDTMFSenderRedirector("+this.rpcObjectId+") - Inserting tones ["+e+"] with Duration:"+t+" and Gap:"+i),this.makeRpcCall("insertDTMF",[{tones:e,duration:t,gap:i}])},onToneChange:function(e,t){_.debug("RTCDTMFSenderRedirector("+this.rpcObjectId+")::onToneChange("+JSON.stringify(e)+", "+JSON.stringify(t)+")"),this.readOnlyAttributes.toneBuffer=t,this.eventManager.fireEvent("tonechange",{tone:e})},makeRpcCall:function(e,t){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcObjectId:this.rpcObjectId,rpcName:e,rpcArgs:t})}},b.prototype={names:function(){return this.stats.keys()},stat:function(e){return this.stats.get(e)}},R.prototype={namedItem:function(){return null},result:function(){return this.statsReports}},C.prototype={queueOperation:function(e,t,i){var n=this.operations.length,r={id:msRDCRTC.getNextOperationId(),name:t,op:i,queued:performance.now(),started:void 0,completed:void 0};_.debug("RTCPeerConnectionOperationQueue("+this.peerConnectionRpcObjectId+')::queueOperation - "rpcObjectType":'+e+', "opName":'+r.name+', "opId":'+r.id+", "+n+" operation"+(1!==n?"s":"")+" ahead in queue"),this.operations.push(r),this.scheduleNextOperation()},scheduleNextOperation:function(){if(!this.opExecutionScheduled&&null==this.pendingOp&&this.operations.length>0){this.opExecutionScheduled=!0;var e=this;window.setTimeout(function(){e.executeNextOperation()},0)}},executeNextOperation:function(){this.opExecutionScheduled=!1;var e=this.operations.shift();if(void 0==e||this.closed)_.debug('RTCPeerConnectionOperationQueue "peerConnectionRpcObjectId":'+this.peerConnectionRpcObjectId+" is closed - dropping operation");else if(null==this.pendingOp){this.pendingOp=e;var t=this;e.started=performance.now();var i=e.started-e.queued;(i>=5e3?_.error:i>=1e3?_.warn:_.debug)("RTCPeerConnectionOperationQueue("+this.peerConnectionRpcObjectId+')::executeNextOperation - "opName":'+e.name+', "opId":'+e.id+" is starting after waiting in queue for "+i.toFixed(4)+" ms"),e.op().then(function(){e.completed=performance.now();var i=e.started-e.queued,n=e.completed-e.started;(i>=5e3||n>=5e3?_.error:i>=1e3||n>=1e3?_.warn:_.debug)('RTCPeerConnectionOperationQueue "peerConnectionRpcObjectId":'+t.peerConnectionRpcObjectId+', "opName":'+e.name+', "opId":'+e.id+" took "+n.toFixed(4)+" ms, after sitting in the queue for "+i.toFixed(4)+" ms")}).finally(function(){t.pendingOp=null,t.scheduleNextOperation()})}else _.error("RTCPeerConnectionOperationQueue("+this.peerConnectionRpcObjectId+")::executeNextOperation was called while an operation was pending.")}},O.prototype={addEventListener:function(e,t,i){_.debug("adding event listener for: "+e),this.eventManager.addEventListener(e,t,i)},removeEventListener:function(e,t,i){_.debug("removing event listener for: "+e),this.eventManager.removeEventListener(e,t,i)},createOffer:function(){_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::createOffer("+JSON.stringify(arguments)+")");var e,t,i;arguments.length<=1?e=arguments[0]:(t=arguments[0],i=arguments[1],e=arguments[2]);var n=this;return new Promise(function(r,c){n.operationQueue.queueOperation(n.rpcObjectType,"createOffer",function(){return n.makeRpcCall("createOffer",[e]).then(function(e){void 0!=t?(_.debug("RTCPeerConnectionRedirector("+n.rpcObjectId+")::createOffer - returning: "+JSON.stringify(e.desc)),t(e.desc),r()):r(e.desc)}).catch(function(e){void 0!=i&&i(e),c(e)})})})},createAnswer:function(){if(_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::createAnswer("+JSON.stringify(arguments)+")"),this.closed)return new Promise(function(e,t){t(new InvalidStateError)});var e,t,i;arguments.length<=1?e=arguments[0]:(t=arguments[0],i=arguments[1]);var n=this;return new Promise(function(r,c){n.operationQueue.queueOperation(n.rpcObjectType,"createAnswer",function(){return n.makeRpcCall("createAnswer",[e]).then(function(e){void 0!=t?(_.debug("RTCPeerConnectionRedirector("+n.rpcObjectId+")::createAnswer - returning: "+JSON.stringify(e.desc)),t(e.desc),r()):r(e.desc)}).catch(function(e){void 0!=i&&i(e),c(e)})})})},setLocalDescription:function(){if(_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::setLocalDescription("+JSON.stringify(arguments)+")"),this.closed)return new Promise(function(e,t){t(new InvalidStateError)});var e,t,i=arguments[0];arguments.length>1&&(e=arguments[1],t=arguments[2]),this.readOnlyAttributes.pendingLocalDescription=i;var n=this;return new Promise(function(r,c){n.operationQueue.queueOperation(n.rpcObjectType,"setLocalDescription",function(){return n.makeRpcCall("setLocalDescription",[i]).then(function(t){n.readOnlyAttributes.currentLocalDescription=i,n.readOnlyAttributes.pendingLocalDescription=null,void 0!=e&&(_.debug("RTCPeerConnectionRedirector("+n.rpcObjectId+")::setLocalDescription - calling successCallback"),e()),r()}).catch(function(e){n.readOnlyAttributes.pendingLocalDescription=null,void 0!=t&&t(e),c(e)})})})},setRemoteDescription:function(){if(_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::setRemoteDescription("+JSON.stringify(arguments)+")"),this.closed)return new Promise(function(e,t){t(new InvalidStateError)});var e,t,i=arguments[0];arguments.length>1&&(e=arguments[1],t=arguments[2]),this.readOnlyAttributes.pendingRemoteDescription=i;var n=this;return new Promise(function(r,c){n.operationQueue.queueOperation(n.rpcObjectType,"setRemoteDescription",function(){return n.makeRpcCall("setRemoteDescription",[i]).then(function(t){n.readOnlyAttributes.currentRemoteDescription=i,n.readOnlyAttributes.pendingRemoteDescription=null,void 0!=e&&(_.debug("RTCPeerConnectionRedirector("+n.rpcObjectId+")::setRemoteDescription - calling successCallback"),e()),r()}).catch(function(e){n.readOnlyAttributes.pendingRemoteDescription=null,void 0!=t&&t(e),c(e)})})})},addIceCandidate:function(){if(_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::addIceCandidate("+JSON.stringify(arguments)+")"),this.closed)return new Promise(function(e,t){t(new InvalidStateError)});var e,t,i=arguments[0];arguments.length>1&&(e=arguments[1],t=arguments[2]);var n=this;return new Promise(function(r,c){n.operationQueue.queueOperation(n.rpcObjectType,"addIceCandidate",function(){return n.makeRpcCall("addIceCandidate",[i]).then(function(t){_.debug("RTCPeerConnectionRedirector("+n.rpcObjectId+")::addIceCandidate - updating remoteDescription: "+JSON.stringify(t.result)),n.remoteDescription=t.result,void 0!=e&&(_.debug("RTCPeerConnectionRedirector("+n.rpcObjectId+")::addIceCandidate - calling successCallback"),e()),r()}).catch(function(e){void 0!=t&&t(e),c(e)})})})},getDefaultIceServers:function(){return _.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getDefaultIceServers("+JSON.stringify(arguments)+")"),_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getDefaultIceServers returning: "+JSON.stringify(this.defaultIceServers)),this.defaultIceServers},getConfiguration:function(){return _.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getConfiguration("+JSON.stringify(arguments)+")"),_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getConfiguration returning: "+JSON.stringify(this.configuration)),this.configuration},setConfiguration:function(e){_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::setConfiguration("+JSON.stringify(arguments)+")"),this.configuration=e;var t=this;this.operationQueue.queueOperation(this.rpcObjectType,"setConfiguration",function(){return t.makeRpcCall("setConfiguration",[e]).then(function(){t.configuration=e})})},close:function(){if(_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::close("+JSON.stringify(arguments)+")"),!this.closed){var e=this;this.operationQueue.queueOperation(this.rpcObjectType,"close",function(){return e.makeRpcCall("close").finally(function(){e.closed=!0,e.operationQueue.closed=!0})})}},getTransceivers:function(){return _.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getTransceivers("+JSON.stringify(arguments)+")"),_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getTransceivers returning: "+JSON.stringify(this.transceivers)),this.transceivers},getSenders:function(){_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getSenders("+JSON.stringify(arguments)+")");var e=null;return this.unifiedPlan?(e=new Array,this.transceivers.forEach(function(t){transceiver.stopped||e.push(transceiver.sender)})):e=this.senders,_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getSenders returning: "+JSON.stringify(e)),e},getReceivers:function(){_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getReceivers("+JSON.stringify(arguments)+")");var e=null;return this.unifiedPlan?(e=new Array,this.transceivers.forEach(function(t){t.stopped||null==t.receiver.track||e.push(t.receiver)})):e=this.receivers,_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getReceivers returning: "+JSON.stringify(e)),e},addStream:function(e){_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::addStream("+JSON.stringify(arguments)+")");var t=this;e.getTracks().forEach(function(i){t.internalAddTrack(i,e)})},removeStream:function(){_.error("RTCPeerConnectionRedirector("+this.rpcObjectId+")::removeStream("+JSON.stringify(arguments)+") - E_NOTIMPL")},addTrack:function(){return _.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::addTrack("+JSON.stringify(arguments)+")"),this.internalAddTrack.apply(this,arguments)},removeTrack:function(e){_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::removeTrack("+JSON.stringify(arguments)+")");var t=this;if(this.unifiedPlan)for(var i in this.transceivers){var n=this.transceivers[i];void 0!=n.sender&&n.sender.rpcObjectId===e.rpcObjectId&&("sendrecv"===n.direction?n.direction:"sendonly"===n.direction&&n.direction,n.sender.track=null)}this.operationQueue.queueOperation(this.rpcObjectType,"removeTrack",function(){return t.makeRpcCall("removeTrack",[{senderRpcObjectId:e.rpcObjectId}])})},addTransceiver:function(e,t){_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::addTransceiver("+JSON.stringify(arguments)+")");var i=this.internalAddTransceiver(e);i.readOnlyAttributes.currentDirection=t.direction,_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::addTransceiver returning: "+JSON.stringify(i));var n=this,r=void 0!=e.kind;return this.operationQueue.queueOperation(this.rpcObjectType,"addTransceiver",function(){return n.makeRpcCall("addTransceiver",[{trackRpcObjectId:r?e.rpcObjectid:0,kind:r?e.kind:e,direction:t.direction,transceiverRpcObjectId:i.rpcObjectId,senderRpcObjectId:i.sender.rpcObjectId,receiverRpcObjectId:i.receiver.rpcObjectId}])}),this.transceivers.push(i),i},getLocalStreams:function(){_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getLocalStreams("+JSON.stringify(arguments)+")");var e=new Array;return this.senders.forEach(function(t){e=e.concat(t.streams)}),_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getLocalStreams - returning: "+JSON.stringify(e)),e},getRemoteStreams:function(){_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getRemoteStreams("+JSON.stringify(arguments)+")");var e=new Array;return this.receivers.forEach(function(t){null!=t.track&&(e=e.concat(t.track.mediaStream))}),_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getRemoteStreams - returning: "+JSON.stringify(e)),e},getStats:function(){_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getStats("+JSON.stringify(arguments)+")");var e,t,i={};arguments.length>0?void 0!=arguments[0]&&"function"==typeof arguments[0]?e=arguments[0]:t=arguments[0]:i={selectorRpcObjectType:this.rpcObjectType},void 0!=t&&(i={selectorRpcObjectType:t.rpcObjectType,selectorRpcObjectId:t.rpcObjectid});var n=this;return this.closed?void 0!=e?void e(new R):new Promise(function(e,t){t(new InvalidStateError)}):this.ready?new Promise(function(t,r){n.makeRpcCall("getStats",[i]).then(function(i){if(n.updateContributingSources(i.receivers),void 0!=e){var r=new R(i);return n.stats=r,void e(r)}var c=new s,o=i.stats;for(var a in o){var d=o[a];c[d.id]=d}t(c)}).catch(function(e){r(e)})}):void 0!=e?void e(new R):new Promise(function(e,t){e(new s)})},createDataChannel:function(e,t){var i=this,n=new N(this,e,t);return msRDCRTC.rtcObjects.push(n),this.operationQueue.queueOperation(this.rpcObjectType,"createDataChannel",function(){return i.makeRpcCall("createDataChannel",[{label:e,rpcObjectId:n.rpcObjectId}])}),n},setState:function(e,t,i){var n=this.readOnlyAttributes[e];n!==t&&(this.readOnlyAttributes[e]=t,_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::setState - "+e+" changed from: "+n+" to: "+t),"iceGatheringState"===e&&"complete"===t&&this.eventManager.fireEvent("icecandidate"),this.eventManager.fireEvent(i))},setSignalingState:function(e){this.setState("signalingState",e,"signalingstatechange")},setIceConnectionState:function(e){this.setState("iceConnectionState",e,"iceconnectionstatechange")},setIceGatheringState:function(e){"complete"===e&&this.eventManager.fireEvent("icecandidate"),this.setState("iceGatheringState",e,"icegatheringstatechange")},setConnectionState:function(e){this.setState("connectionState",e,"connectionstatechange")},getLocalDescription:function(){var e=void 0!=this.readOnlyAttributes.pendingLocalDescription,t=this.readOnlyAttributes.pendingLocalDescription||this.readOnlyAttributes.currentLocalDescription;return _.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getLocalDescription - pending="+e+": "+JSON.stringify(t)),t},getRemoteDescription:function(){var e=void 0!=this.readOnlyAttributes.pendingRemoteDescription,t=this.readOnlyAttributes.pendingRemoteDescription||this.readOnlyAttributes.currentRemoteDescription;return _.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getRemoteDescription - pending="+e+": "+JSON.stringify(t)),t},getReceiverByRpcObjectId:function(e){var t=null;return this.receivers.some(function(i){return i.rpcObjectId==e&&(t=i),null!=t}),t},internalAddTrack:function(e,t){_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::internalAddTrack("+JSON.stringify(arguments)+")"),void 0!=t&&(t=(new Array).concat(t));var i=this,n=new Array;void 0!=t&&t.forEach(function(e){n.push(e.rpcObjectId)});var r=null,c=!1,o=null,a=null;if(this.unifiedPlan){for(var s in this.transceivers)if(null===(o=this.transceivers[s]).sender.track&&o.sender.kind===r.kind&&!1===o.stopping&&!1===o.usedToSend){_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::internalAddTrack("+JSON.stringify(arguments)+"). Reusing existing sender on transceiver with rpcObjectId: "+o.rpcObjectid),c=!0,"recvonly"===o.direction?o.direction="sendrecv":"inactive"===o.direction&&(o.direction="sendonly");break}c?o.sender.track=e:(o=this.internalAddTransceiver(e,t),r=o.sender,a=o.receiver,transceivers.push(o))}else r=new y(this,e,t,void 0),this.senders.push(r);return this.operationQueue.queueOperation(this.rpcObjectType,"addTrack",function(){return i.makeRpcCall("addTrack",[{trackRpcObjectId:e.rpcObjectId,streamRpcObjectIds:n,senderRpcObjectId:r.rpcObjectId,receiverRpcObjectId:null!=a?a.rpcObjectId:0,transceiverRpcObjectId:null!=o?o.rpcObjectId:0,reuseSender:c}]).then(function(e){r.ready=!0})}),r},internalAddTransceiver:function(e,t,i,n,r,c){var o=void 0!=e.kind?e.kind:e,a=null;a=new S(this,o,i);var s=new y(this,e,t,void 0,r),d=null;return d=void 0===n?new I(this,o):new I(this,o,n,c),a.sender=s,a.receiver=d,s.transceiver=a,d.transceiver=a,this.senders.push(s),this.receivers.push(d),a},onAddTrack:function(e){_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+')::onAddTrack - "rpcObjectId":'+this.rpcObjectId+" - "+JSON.stringify(e));var t=e.receiver,i=e.stream,n=e.track,r=new Array,c=msRDCRTC.mediaDevicesRedirector.audioOutputDevice,o=new T(void 0,[c],i.rpcObjectId,i.id),a=new E(o,c,n.rpcObjectId,n.id,t.kind);o.addTrack(a),r.push(o);var s=new I(this,t.kind,t.rpcObjectId,a);this.receivers.push(s);var d={track:a,streams:o};return this.eventManager.fireEvent("addstream",{stream:o}),d},onTrack:function(e){_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+')::onTrack - "rpcObjectId":'+this.rpcObjectId+" - "+JSON.stringify(e));var t=e.receiver,i=e.sender,n=e.transceiver,r=e.stream,c=e.track,o=e.reuseReceiver,a=new Array,s=msRDCRTC.mediaDevicesRedirector.audioOutputDevice,d=new T(void 0,[s],r.rpcObjectId,r.id),u=new E(d,s,c.rpcObjectId,c.id,t.kind);if(d.addTrack(u),a.push(d),o)this.receivers.find(function(e){return e.rpcObjectId===t.rpcObjectId}).readOnlyAttributes.track=u;else{var h=this.internalAddTransceiver(t.kind,a,n.rpcObjectId,t.rpcObjectId,i.rpcObjectId,u);h.direction=n.direction,h.mid=n.mid,this.transceivers.push(h)}return{track:u,streams:a}},onDataChannel:function(e){_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+')::onDataChannel - "rpcObjectId":'+this.rpcObjectId+" - "+JSON.stringify(e));var t=e.datachannel,i=new N(this,t.label,void 0,t.rpcObjectId);return msRDCRTC.rtcObjects.push(i),{channel:i}},onSetLocalDescriptionComplete:function(e){_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::setLocalDescriptionComplete  - "+JSON.stringify(e)),this.associateTransceivers(e.transceivers)},associateTransceivers:function(e){_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::associateTransceivers - "+JSON.stringify(e));var t=this;e.forEach(function(e){var i=t.transceivers.find(function(t){return e.rpcObjectId==t.rpcObjectId});void 0!=i&&(i.mid=e.mid)})},onRemoveTrack:function(e){_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+')::onRemoveTrack - "rpcObjectId":'+this.rpcObjectId+" - "+JSON.stringify(e));var t=e.receiverRpcObjectId;if(this.unifiedPlan)for(var i in this.transceivers){var n=this.transceivers[i];if((c=n.receiver).rpcObjectId===t){"sendrecv"===n.direction?n.direction="sendonly":"recvonly"===n.direction&&(n.direction="inactive");break}}else{var r=void 0;for(var i in this.receivers){var c=this.receivers[i];if(c.rpcObjectId===t){r=c.track.mediaStream,this.unifiedPlan||this.receivers.splice(i,1);break}}this.eventManager.fireEvent("removestream",{stream:r})}},onRemoveStream:function(e){_.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+')::onRemoveStream (Unified Plan Only)- "rpcObjectId":'+this.rpcObjectId+" - "+JSON.stringify(e));var t=e.mediaStreamObjectId,i=void 0,n=this.getRemoteStreams();for(var r in n){var c=n[r];if(c.rpcObjectId===t){i=c;break}}this.eventManager.fireEvent("removestream",{stream:i})},onIceCandidate:function(e){return _.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+')::onIceCandidate - "rpcObjectId":'+this.rpcObjectId+" - updating localDescription: "+JSON.stringify(e.desc)),this.readOnlyAttributes.currentLocalDescription=e.desc,e},updateContributingSources:function(e){if(e)for(var t in this.receivers){var i=this.receivers[t],n=e.find(function(e){return e.rpcObjectId===i.rpcObjectId});n?i.updateContributingSources(n.contributingSources):i.updateContributingSources([])}},disableRedirection:function(){this.closed||(this.pendingOp=null,this.operations=new Array,"new"!==this.iceConnectionState&&(_.info("RTCPeerConnectionRedirector("+this.rpcObjectId+")::disableRedirection - iceConnectionState changing from: "+this.iceConnectionState+" to: failed"),this.setIceConnectionState("failed")),this.closed=!0)},onRpcEventNotification:function(e){var t=!1,i=e.rpcEventTarget,n=e.rpcEventArgs;if(i.rpcObjectType===this.rpcObjectType&&i.rpcObjectId===this.rpcObjectId){var r=e.rpcEventName,c=n&&n.state;if(void 0!=c){var o=this.eventMap[r];void 0!=o&&(this.setState(o,c,r),t=!0)}"setLocalDescriptionComplete"===r&&(this.onSetLocalDescriptionComplete(n),t=!0),t||("removetrack"===r?(this.onRemoveTrack(n),t=!0):"removestream"===r?(this.onRemoveStream(n),t=!0):("track"===r?n=this.unifiedPlan?this.onTrack(n):this.onAddTrack(n):"icecandidate"===r?n=this.onIceCandidate(n):"datachannel"===r&&(n=this.onDataChannel(n)),t=this.eventManager.fireEvent(r,n)))}else"RTCRtpReceiver"===i.rpcObjectType?this.receivers.forEach(function(i){void 0!=i.onRpcEventNotification&&i.onRpcEventNotification(e)&&(t=!0)}):"RTCRtpSender"===i.rpcObjectType&&this.senders.forEach(function(i){void 0!=i.onRpcEventNotification&&i.onRpcEventNotification(e)&&(t=!0)});return t},makeRpcCall:function(e,t,i){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcObjectId:this.rpcObjectId,rpcName:e,rpcArgs:t},i)}},T.prototype={addEventListener:function(e,t,i){_.debug("MediaStreamRedirector("+this.rpcObjectId+") - adding event listener for: "+e),this.eventManager.addEventListener(e,t,i)},removeEventListener:function(e,t,i){_.debug("MediaStreamRedirector("+this.rpcObjectId+") - removing event listener for: "+e),this.eventManager.removeEventListener(e,t,i)},getAudioTracks:function(){return _.debug("MediaStreamRedirector("+this.rpcObjectId+")::getAudioTracks("+JSON.stringify(arguments)+")"),_.debug("MediaStreamRedirector("+this.rpcObjectId+")::getAudioTracks returning: "+JSON.stringify(this.audioTracks)),this.audioTracks},getVideoTracks:function(){return _.debug("MediaStreamRedirector("+this.rpcObjectId+")::getVideoTracks("+JSON.stringify(arguments)+")"),_.debug("MediaStreamRedirector("+this.rpcObjectId+")::getVideoTracks returning: "+JSON.stringify(this.videoTracks)),this.videoTracks},getTracks:function(){_.debug("MediaStreamRedirector("+this.rpcObjectId+")::getTracks("+JSON.stringify(arguments)+")");var e=this.audioTracks.concat(this.videoTracks);return _.debug("MediaStreamRedirector("+this.rpcObjectId+")::getTracks returning: "+JSON.stringify(e)),e},getTrackById:function(e){_.debug("MediaStreamRedirector("+this.rpcObjectId+")::getTrackById("+JSON.stringify(arguments)+")");var t=null;for(var i in this.audioTracks)if(i.id===e){t=i;break}if(null==t)for(var i in this.videoTracks)if(i.id===e){t=i;break}return _.debug("MediaStreamRedirector("+this.rpcObjectId+")::getTrackById returning: "+JSON.stringify(t)),t},addTrack:function(e){if(_.debug("MediaStreamRedirector("+this.rpcObjectId+")::addTrack("+JSON.stringify(arguments)+")"),null==this.getTrackById(e.id)){if("audio"===e.kind)this.audioTracks.push(e);else{if("video"!==e.kind&&"screenshare"!==e.kind)throw new TypeError("addTrack - unsupported track kind: "+e.kind);this.videoTracks.push(e)}this.eventManager.fireEvent("addtrack")}},removeTrack:function(e){if(_.debug("MediaStreamRedirector("+this.rpcObjectId+")::removeTrack("+JSON.stringify(arguments)+")"),null!=this.getTrackById(e.id)){var t=null;if("audio"===e.kind)t=this.audioTracks;else{if("video"!==e.kind&&"screenshare"!==e.kind)throw new TypeError("removeTrack - unsupported track kind: "+e.kind);t=this.videoTracks}var i=e.id;for(var n in t)if(t[n].id===i){t.splice(n,1);break}this.eventManager.fireEvent("removetrack")}},clone:function(){_.debug("MediaStreamRedirector("+this.rpcObjectId+")::clone");var e=new T(this.constraints,this.devices,void 0,void 0,"cloning");return this.getTracks().forEach(function(t){var i=t.internalClone(e);e.addTrack(i)}),_.debug("MediaStreamRedirector("+this.rpcObjectId+")::clone - returning: "+JSON.stringify(e)),e},getIsActive:function(){var e=this.getTracks(),t=!1;for(var i in e)if("ended"!=i.readyState){t=!0;break}return _.debug("MediaStreamRedirector("+this.rpcObjectId+")::getIsActive() returning "+t),t},onRpcEventNotification:function(e){var t=!1,i=e.rpcEventTarget;return i.rpcObjectType===this.rpcObjectType&&i.rpcObjectId===this.rpcObjectId&&(t=this.eventManager.fireEvent(e.rpcEventName,e.rpcEventArgs)),t},makeRpcCall:function(e,t,i){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcObjectId:this.rpcObjectId,rpcName:e,rpcArgs:t},i)}},E.prototype={addEventListener:function(e,t,i){_.debug("MediaStreamTrackRedirector("+this.rpcObjectId+") - adding event listener for: "+e),this.eventManager.addEventListener(e,t,i)},removeEventListener:function(e,t,i){_.debug("MediaStreamTrackRedirector("+this.rpcObjectId+") - removing event listener for: "+e),this.eventManager.removeEventListener(e,t,i)},clone:function(){_.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::clone");var e=this.internalClone(this.mediaStream);return _.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::clone - returning: "+JSON.stringify(e)),e},internalClone:function(e){_.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::clone");var t=new E(e,this.device);return t.readOnlyAttributes.readyState=this.readyState,t.observableAttributes.enabled=this.observableAttributes.enabled,_.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::clone - returning: "+JSON.stringify(t)),t},stop:function(){_.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::stop("+JSON.stringify(arguments)+")"),this.setReadyState("ended"),this.makeRpcCall("stop")},getCapabilities:function(){_.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::getCapabilities("+JSON.stringify(arguments)+") - E_NOTIMPL")},getConstraints:function(){return _.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::getConstraints("+JSON.stringify(arguments)+")"),this.constraints},applyConstraints:function(e){_.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::applyConstraints("+JSON.stringify(arguments)+")");var t=this;return this.constraints=e,new Promise(function(i,n){t.makeRpcCall("applyConstraints",e).then(function(e){i()}).catch(function(e){n(e)})})},setReadyState:function(e){var t=this.readyState;t!==e&&(this.readOnlyAttributes.readyState=e,_.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::setReadyState - old="+t+", new="+e),"ended"===e&&this.eventManager.fireEvent("ended"))},onEnabledAttributeChanged:function(){_.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::onEnabledAttributeChanged("+JSON.stringify(arguments)+")"),"ended"!==this.readyState&&this.makeRpcCall("onEnabledAttributeChanged",[this.enabled])},onRpcEventNotification:function(e){var t=!1,i=e.rpcEventTarget;return i.rpcObjectType===this.rpcObjectType&&i.rpcObjectId===this.rpcObjectId&&(t=this.eventManager.fireEvent(e.rpcEventName,e.rpcEventArgs)),t},makeRpcCall:function(e,t,i){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcObjectId:this.rpcObjectId,rpcName:e,rpcArgs:t},i)}},S.prototype={stop:function(){return _.debug("RTCRtpTransceiverRedirector("+this.rpcObjectId+")::stop("+JSON.stringify(arguments)+")"),this.makeRpcCall("stop")},setCodecPreferences:function(e){_.debug("RTCRtpTransceiverRedirector("+this.rpcObjectId+")::setCodecPreferences("+JSON.stringify(arguments)+")");var t=this;this.preferredCodecs=e,this.peerConnectionOperationQueue.queueOperation(this.rpcObjectType,"setCodecPreferences",function(){return t.makeRpcCall("setCodecPreferences",[{codecs:e}])})},getCapabilities:function(){return _.debug("RTCRtpTransceiverRedirector("+this.rpcObjectId+")::getCapabilities("+JSON.stringify(arguments)+")"),this.makeRpcCall("getCapabilities")},getDirection:function(){return this.stopping?"stopped":this.readOnlyAttributes.currentDirection},setDirection:function(e){_.debug("RTCRtpTransceiverRedirector("+this.rpcObjectId+")::setDirection("+JSON.stringify(arguments)+")");var t=this;if(this.stopping)throw new InvalidStateError;if(e!==this.readOnlyAttributes.currentDirection){if("stopped"===e)return this.stopped=!0,void(this.stopping=!0);"sendrecv"!==e&&"sendonly"!==e||(this.usedToSend=!0),this.readOnlyAttributes.currentDirection=e,this.peerConnectionOperationQueue.queueOperation(this.rpcObjectType,"setDirection",function(){return t.makeRpcCall("setDirection",[{direction:e}])})}},makeRpcCall:function(e,t,i){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcObjectId:this.rpcObjectId,rpcName:e,rpcArgs:t},i)}},y.prototype={getCapabilities:function(e){_.debug("RTCRtpSenderRedirector("+this.rpcObjectId+")::getCapabilities("+JSON.stringify(arguments)+")");var t="audio"===e?this.capabilities.audio:"video"===e?this.capabilities.video:{};_.debug("RTCRtpSenderRedirector("+this.rpcObjectId+")::getCapabilities returning: "+JSON.stringify(t))},setParameters:function(e){_.debug("RTCRtpSenderRedirector("+this.rpcObjectId+")::setParameters("+JSON.stringify(arguments)+")");var t=this;return new Promise(function(i,n){t.peerConnectionOperationQueue.queueOperation(t.rpcObjectType,"setParameters",function(){return t.makeRpcCall("setParameters",[{parameters:e}]).then(function(e){_.debug("RTCRtpSenderRedirector("+t.rpcObjectId+")::setParameters() RPC status: "+JSON.stringify(e)),i()}).catch(function(e){n(e)})})})},getParameters:function(){return _.debug("RTCRtpSenderRedirector("+this.rpcObjectId+")::getParameters("+JSON.stringify(arguments)+")"),{encodings:[{active:!0}]}},replaceTrack:function(e){_.debug("RTCRtpSenderRedirector("+this.rpcObjectId+")::replaceTrack("+JSON.stringify(arguments)+")");var t=this;return this.transceiver.stopped?new Promise(function(e,t){t(new InvalidStateError)}):new Promise(function(i,n){t.peerConnectionOperationQueue.queueOperation(t.rpcObjectType,"replaceTrack",function(){return t.makeRpcCall("replaceTrack",[{trackRpcObjectId:null==e?0:e.rpcObjectId}]).then(function(n){("sendrecv"==t.transceiver.direction||"sendonly"==t.transceiver.direction)&&null==e&&("sendrecv"==t.transceiver.direction?t.transceiver.direction="recvonly":"sendonly"==t.transceiver.direction&&t.transceiver.direction),t.track=e,i(void 0)}).catch(function(e){n(e)})})})},setStreams:function(e){_.debug("RTCRtpSenderRedirector("+this.rpcObjectId+")::setStreams("+JSON.stringify(arguments)+")"),this.streams=e,that.peerConnectionOperationQueue.queueOperation(that.rpcObjectType,"setStreams",function(){that.makeRpcCall("setStreams",[{streams:e}])})},getStats:function(){if(_.debug("RTCRtpSenderRedirector("+this.rpcObjectId+")::getStats("+JSON.stringify(arguments)+")"),!this.ready)return new Promise(function(e,t){e(new s)});var e=this;return new Promise(function(t,i){e.makeRpcCall("getStats",arguments).then(function(e){var i=new s;for(var n in e){var r=e[n];i[r.id]=r}t(i)}).catch(function(e){i(e)})})},onRpcEventNotification:function(e){var t=!1;if(e.rpcEventTarget.rpcObjectType===this.rpcObjectType&&e.rpcEventTarget.rpcObjectId===this.rpcObjectId&&"tonechange"===e.rpcEventName){var i=e.rpcEventArgs,n=i.tone,r=i.toneBuffer;this.dtmf.onToneChange(n,r),t=!0}return t},makeRpcCall:function(e,t,i){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcObjectId:this.rpcObjectId,rpcName:e,rpcArgs:t},i)}},I.prototype={getCapabilities:function(e){_.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getCapabilities("+JSON.stringify(arguments)+")");var t="audio"===e?this.capabilities.audio:"video"===e?this.capabilities.video:{};_.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getCapabilities returning: "+JSON.stringify(t))},getParameters:function(){return _.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getParameters("+JSON.stringify(arguments)+")"),_.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getParameters returning: "+JSON.stringify(this.parameters)),this.parameters},getContributingSources:function(){return _.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getContributingSources("+JSON.stringify(arguments)+")"),_.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getContributingSources returning: "+JSON.stringify(this.contributingSources)),this.contributingSources},getSynchronizationSources:function(){return _.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getSynchronizationSources("+JSON.stringify(arguments)+")"),_.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getSynchronizationSources returning: "+JSON.stringify(this.synchronizationSources)),this.synchronizationSources},getStats:function(){_.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getStats("+JSON.stringify(arguments)+")");var e=this;return new Promise(function(t,i){e.makeRpcCall("getStats",arguments).then(function(e){var i=new s;for(var n in e){var r=e[n];i[r.id]=r}t(i)}).catch(function(e){i(e)})})},onContributingSourcesChanged:function(e){_.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::onContributingSourcesChanged("+JSON.stringify(e)+")"),this.contributingSources=e},updateContributingSources:function(e){void 0!=this.track&&(this.contributingSources=e,this.contributingSources||(this.contributingSources=[]))},onRpcEventNotification:function(e){var t=!1;return e.rpcEventTarget.rpcObjectType===this.rpcObjectType&&e.rpcEventTarget.rpcObjectId===this.rpcObjectId&&"contributingsourceschanged"===e.rpcEventName&&(this.onContributingSourcesChanged(e.rpcEventArgs.sources),t=!0),t},makeRpcCall:function(e,t,i){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcObjectId:this.rpcObjectId,rpcName:e,rpcArgs:t},i)}},N.prototype={addEventListener:function(e,t,i){_.debug("adding event listener for: "+e),this.eventManager.addEventListener(e,t,i)},removeEventListener:function(e,t,i){_.debug("removing event listener for: "+e),this.eventManager.removeEventListener(e,t,i)},close:function(){if(_.debug("RTCDataChannelRedirector("+this.rpcObjectId+")::close("+JSON.stringify(arguments)+")"),"closed"!=this.readyState&&"closing"!=this.readyState){var e=this;this.readyState="closing",this.eventManager.fireEvent("closing"),this.peerConnectionOperationQueue.queueOperation(this.rpcObjectType,"close",function(){return e.makeRpcCall("close").finally(function(){e.readyState="closed",e.eventManager.fireEvent("close");for(var t in msRDCRTC.rtcObjects)if(msRDCRTC.rtcObjects[t].rpcObjectId==e.rpcObjectId){msRDCRTC.rtcObjects.splice(t,1);break}})})}},send:function(e){_.debug("RTCDataChannelRedirector("+this.rpcObjectId+")::send("+JSON.stringify(arguments)+")");var t=this;if("open"!=this.readyState)throw new InvalidStateError;var i=window.btoa(e);_.debug("RTCDataChannelRedirector("+this.rpcObjectId+")::send("+i+")"),this.peerConnectionOperationQueue.queueOperation(this.rpcObjectType,"send",function(){return t.makeRpcCall("send",[{dataBase64:i}])})},onRpcEventNotification:function(e){var t=!1,i=e.rpcEventTarget,n={};if(i.rpcObjectType===this.rpcObjectType&&i.rpcObjectId===this.rpcObjectId){var r=e.rpcEventName;if("open"===r)this.readyState="open",this.id=e.rpcEventArgs.id;else if("closing"===r)this.readyState="closing";else if("close"===r)this.readyState="closed";else if("message"===r){for(var c=window.atob(e.rpcEventArgs.base64MessageData),o=c.length,a=new Uint8Array(o),s=0;s<o;s++)a[s]=c.charCodeAt(s);n.data=a}_.debug("RTCDataChannelRedirector("+this.rpcObjectId+")::onRpcEventNotification("+JSON.stringify(arguments)+") - rpcEventArgs: "+JSON.stringify(n)),t=this.eventManager.fireEvent(r,n)}return t},makeRpcCall:function(e,t,i){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcObjectId:this.rpcObjectId,rpcName:e,rpcArgs:t},i)}},D.prototype={MEDIA_ERR_ABORTED:1,MEDIA_ERR_NETWORK:2,MEDIA_ERR_DECODE:3,MEDIA_ERR_SRC_NOT_SUPPORTED:4,NETWORK_EMPTY:0,NETWORK_IDLE:1,NETWORK_LOADING:2,NETWORK_NO_SOURCE:3,HAVE_NOTHING:0,HAVE_METADATA:1,HAVE_CURRENT_DATA:2,HAVE_FUTURE_DATA:3,HAVE_ENOUGH_DATA:4,enableRedirection:function(){if(!this.redirecting){var e=this.mediaElement;"video"===this.kind&&e.addEventListener("onresize",this.onResizeFunctor,!1),e.getAttribute=this.getAttributeFunctor,e.setAttribute=this.setAttributeFunctor,e.removeAttribute=this.removeAttributeFunctor,e.addEventListener=this.addEventListenerFunctor,e.removeEventListener=this.removeEventListenerFunctor,e.play=this.playFunctor,e.pause=this.pauseFunctor,e.load=this.loadFunctor,e.setSinkId=this.setSinkIdFunctor,this.redirecting=!0}},disableRedirection:function(){if(this.redirecting){var e=this.mediaElement;e.getAttribute=this.actualGetAttribute,e.setAttribute=this.actualSetAttribute,e.removeAttribute=this.actualRemoveAttribute,e.addEventListener=this.actualAddEventListener,e.removeEventListener=this.actualRemoveEventListener,e.play=this.actualPlay,e.pause=this.actualPause,e.load=this.actualLoad,e.setSinkId=this.actualSetSinkId,"video"===this.kind&&e.removeEventListener("onresize",this.onResizeFunctor,!1),this.stopProgressTimer(),this.redirecting=!1}},getAttribute:function(e){return this.redirecting?"preload"===e?"none":"currentTime"===e?this.getCurrentTime():"duration"===e?this.duration:"defaultPlaybackRate"===e?1:"playbackRate"===e?1:"played"===e?this.getPlayedRanges():"loop"!==e&&("srcObject"===e?this.srcObject:"sinkId"===e?this.sinkId:"autoplay"===e?this.autoplay:"muted"===e?this.muted:"volume"===e?this.volume:"videoHeight"===e?this.videoHeight:"videoWidth"===e?this.videoWidth:"data-vdi_videoid"===e?this["data-vdi_videoid"]:"data-toggle"===e?this["data-toggle"]:void _.warn("MediaElementRedirector("+this.rpcObjectId+")::getAttribute called for unsupported attribute: name="+e)):(_.info("MediaElementRedirector("+this.rpcObjectId+")::getAttribute called while not redirecting for attribute: name="+e),this.actualGetAttribute.apply(this.mediaElement,arguments))},getReadOnlyAttribute:function(e){return this.redirecting?this.readOnlyAttributes[e]:(_.info("MediaElementRedirector("+this.rpcObjectId+")::getReadOnlyAttribute called while not redirecting for attribute: name="+e),this.actualGetAttribute.apply(this.mediaElement,arguments))},setAttribute:function(e,t){var i=null,n=!0,r=!0,c=null,o=this;if(!this.redirecting)return _.info("MediaElementRedirector("+this.rpcObjectId+")::setAttribute called while not redirecting for attribute: name="+e+", value="+t),this.actualSetAttribute.apply(this.mediaElement,arguments);if("id"===e&&t.startsWith(msRDCRTC.MEDIAELEMENT_PLAYBACK_ID))return _.info("MediaElementRedirector("+this.rpcObjectId+")::setAttribute id="+t+" playback attempt detected; disabling redirection"),this.disableRedirection(),this.actualSetAttribute.apply(this.mediaElement,arguments);if("srcObject"===e){if(r=!1,null!=t&&"MediaStream"!==t.rpcObjectType)return _.warn("MediaElementRedirector("+this.rpcObjectId+")::setAttribute srcObject is not a MediaStream redirector object; disabling redirection"),this.disableRedirection(),this.actualSetAttribute.apply(this.mediaElement,arguments);this.readOnlyAttributes.networkState=this.NETWORK_LOADING,c=function(e){o.setReadyState(o.HAVE_ENOUGH_DATA)},this.srcObject=t,null!=t&&(t={rpcObjectType:t.rpcObjectType,rpcObjectId:t.rpcObjectId})}else"autoplay"===e?(r=!0,i=this.autoplay,this.autoplay=t):"muted"===e?(r=!0,i=this.muted,this.muted=t,c=function(e){o.eventManager.fireEvent("volumechange")}):"volume"===e?(msRDCRTC.clientVersionGreaterThanOrEqual("0.11.10")||(n=!1),r=!0,i=this.volume,this.volume=t,c=function(e){o.eventManager.fireEvent("volumechange")}):"data-toggle"===e?(_.info("MediaElementRedirector("+this.rpcObjectId+")::setAttribute called for data-toggle value="+t),this["data-toggle"]=t,n=!1):"data-vdi_videoid"===e?(_.info("MediaElementRedirector("+this.rpcObjectId+")::setAttribute called for data-vdi_video value="+t),this["data-vdi_videoid"]=t,n=!1):(n=!1,_.warn("MediaElementRedirector("+this.rpcObjectId+")::setAttribute called for unsupported attribute: name="+e+", value="+t));r&&(_.info("MediaElementRedirector("+this.rpcObjectId+")::setAttribute setting on mediaElement name="+e+", value="+t),this.actualSetAttribute.apply(this.mediaElement,arguments)),i!==t&&n&&this.makeRpcCall("setAttribute",[e,t]).then(function(e){null!=c&&c(e)})},removeAttribute:function(e){if(!this.redirecting)return _.info("MediaElementRedirector("+this.rpcObjectId+")::removeAttribute called while not redirecting for attribute: name="+e),this.actualRemoveAttribute.apply(this.mediaElement,arguments);_.warn("MediaElementRedirector("+this.rpcObjectId+")::removeAttribute called for unsupported attribute: name="+e+", value="+value)},addEventListener:function(e,t,i){return this.redirecting?"webkitneedkey"===e||"msneedkey"===e||"encrypted"===e?(_.info("MediaElementRedirector("+this.rpcObjectId+")::addEventListener called for: "+e+"; disabling redirection"),this.disableRedirection(),this.actualAddEventListener.apply(this.mediaElement,arguments)):("loadedmetadata"!==e||void 0!=this.mediaElement.id&&this.mediaElement.id.startsWith(msRDCRTC.MEDIAELEMENT_PLAYBACK_ID)||this.enablePropertyRedirection(),_.debug("MediaElementRedirector("+this.rpcObjectId+") - adding event listener for: "+e),this.eventManager.addEventListener(e,t,i),void this.actualAddEventListener.apply(this.mediaElement,arguments)):(_.info("MediaElementRedirector("+this.rpcObjectId+")::addEventListener called while not redirecting for event: "+e),this.actualAddEventListener.apply(this.mediaElement,arguments))},removeEventListener:function(e,t,i){if(!this.redirecting)return _.info("MediaElementRedirector("+this.rpcObjectId+")::removeEventListener called while not redirecting for event: "+e),this.actualRemoveEventListener.apply(this.mediaElement,arguments);_.debug("MediaElementRedirector("+this.rpcObjectId+") - removing event listener for: "+e),this.eventManager.removeEventListener(e,t,i),this.actualRemoveEventListener.apply(this.mediaElement,arguments),"loadedmetadata"===e&&this.makeRpcCall("shutdown",void 0,!1)},setSinkId:function(e){return _.debug("MediaElementRedirector("+this.rpcObjectId+")::setSinkId: "+e),this.makeRpcCall("setSinkId",[e])},play:function(){if(!this.redirecting)return _.info("MediaElementRedirector("+this.rpcObjectId+")::play called while not redirecting"),this.actualPlay.apply(this.mediaElement,arguments);if(_.debug("MediaElementRedirector("+this.rpcObjectId+")::play"),this.paused){this.eventManager.fireEvent("play"),this.lastPlayAt=performance.now();var e=this;this.makeRpcCall("play").then(function(){e.readOnlyAttributes.paused=!1,e.eventManager.fireEvent("playing"),e.startProgressTimer()})}},pause:function(){if(!this.redirecting)return _.info("MediaElementRedirector("+this.rpcObjectId+")::pause called while not redirecting"),this.actualPause.apply(this.mediaElement,arguments);if(_.debug("MediaElementRedirector("+this.rpcObjectId+")::pause"),!this.paused){var e=this;this.makeRpcCall("pause").then(function(){e.stopProgressTimer(),e.readOnlyAttributes.paused=!0,e.updateCurrentTime(),e.eventManager.fireEvent("pause")})}},load:function(){if(!this.redirecting)return _.info("MediaElementRedirector("+this.rpcObjectId+")::load called while not redirecting"),this.actualLoad.apply(this.mediaElement,arguments);_.debug("MediaElementRedirector("+this.rpcObjectId+")::load")},getCurrentTime:function(){return this.currentTime},updateCurrentTime:function(){var e=performance.now(),t=this.currentTime,i=e-this.lastPlayAt;i!==t&&(this.readOnlyAttributes.currentTime=i,this.eventManager.fireEvent("timeupdate"))},getPlayedTimeRanges:function(){var e=this.getCurrentTime(),t=new TimeRanges;return 0!==e&&t.setTimeRange(0,e),t},setReadyState:function(e){var t=this.readyState;if(t!==e){var i=!1;t===this.HAVE_NOTHING&&e>=this.HAVE_METADATA&&(this.readOnlyAttributes.readyState=this.HAVE_METADATA,isNaN(this.duration)&&(this.readOnlyAttributes.duration=Number.POSITIVE_INFINITY,this.eventManager.fireEvent("durationchange")),"video"===this.kind&&(this.videoWidth=1280,this.videoHeight=768),this.eventManager.fireEvent("loadedmetadata")),t<=this.HAVE_METADATA&&e>=this.HAVE_CURRENT_DATA&&(this.readOnlyAttributes.readyState=this.HAVE_CURRENT_DATA,this.eventManager.fireEvent("loadeddata")),t<=this.HAVE_CURRENT_DATA&&e>=this.HAVE_FUTURE_DATA&&(this.readOnlyAttributes.readyState=this.HAVE_FUTURE_DATA,this.eventManager.fireEvent("canplay"),i=!0),t<=this.HAVE_FUTURE_DATA&&e>=this.HAVE_ENOUGH_DATA&&(this.readOnlyAttributes.readyState=this.HAVE_ENOUGH_DATA,this.eventManager.fireEvent("canplaythrough"),i=!0),i&&this.paused&&this.autoplay&&this.play()}},startProgressTimer:function(){if(void 0==this.progressIntervalId){_.debug("MediaElementRedirector("+this.rpcObjectId+")::startProgressTimer");var e=this;this.progressIntervalId=window.setInterval(function(){e.onProgressTimer()},250)}},stopProgressTimer:function(){void 0!=this.progressIntervalId&&(_.debug("MediaElementRedirector("+this.rpcObjectId+")::startProgressTimer"),window.clearInterval(this.progressIntervalId),this.progressIntervalId=void 0)},onProgressTimer:function(){this.paused||this.ended||(this.onStyleChanged("poll"),this.onPositionChanged("poll"),this.updateCurrentTime(),this.eventManager.fireEvent("progress"))},onVdiVideoIdChanged:function(){_.debug("MediaElementRedirector("+this.rpcObjectId+")::onVdiVideoIdChanged: "+this.mediaElement["data-vdi_video"])},onVdiDataToggleChanged:function(){_.debug("MediaElementRedirector("+this.rpcObjectId+")::onVdiDataToggleChanged: "+this.mediaElement["data-toggle"])},onStyleChanged:function(e){var t=void 0;void 0!=this.mediaElement&&void 0!=this.mediaElement.style&&(t=this.mediaElement.style.objectFit),void 0!=t&&this.objectFit!==t&&(_.info("MediaElementRedirector("+this.rpcObjectId+")::onStyleChanged - objectFit changed from: "+this.objectFit+" to: "+t),this.objectFit=t,msRDCRTC.clientVersionGreaterThanOrEqual("0.11.10")&&this.makeRpcCall("notifyObjectFitChanged",[t],!1,!0,!0)),"poll"!==e&&this.onPositionChanged("style")},onPositionChanged:function(e){"poll"!==e&&_.debug("MediaElementRedirector("+this.rpcObjectId+")::onPositionChanged due to "+e+": ["+this.mediaElement[e]+"]");var t={left:0,top:0,right:0,bottom:0},i=this.boundingRect,n=this.scaleFactor;this.mediaElement&&(t=this.mediaElement.getBoundingClientRect()),null!=i&&t.left===i.left&&t.top===i.top&&t.right===i.right&&t.bottom===i.bottom&&window.devicePixelRatio===n||(_.debug("MediaElementRedirector("+this.rpcObjectId+")::onPositionChanged - bounding client rect changed from: "+JSON.stringify(i)+" to: "+JSON.stringify(t)+", scale factor changed from: "+n+", to: "+window.devicePixelRatio),this.mediaElement.videoWidthFromRedirector=t.right-t.left,this.mediaElement.videoHeightFromRedirector=t.bottom-t.top,_.debug("MediaElementRedirector("+this.rpcObjectId+")::onPositionChanged - update HTML videoElement size"),this.boundingRect=t,this.scaleFactor=window.devicePixelRatio,this.makeRpcCall("notifyPositionChanged",[{left:t.left,top:t.top,right:t.right,bottom:t.bottom},this.scaleFactor],!1,!0,!0))},enablePropertyRedirection:function(){var e=this;_.info("MediaElementRedirector("+this.rpcObjectId+")::enablePropertyRedirection");var t=function(t){return e.getAttribute(t)},i=function(t){return e.getReadOnlyAttribute(t)};c(this.mediaElement,[["customAttributes",[["currentSrc",i,J],["networkState",i,J],["buffered",i,J],["readyState",i,J],["seeking",i,J],["duration",i,J],["paused",i,J],["seekable",i,J],["ended",i,J],["error",i,J],["sinkId",i,J],["src",t,V],["preload",t,L],["currentTime",t,V],["defaultPlaybackRate",t,L],["playbackRate",t,L],["played",t,J]]],["observableAttributes",[["onloadstart",void 0,function(){o(e,"loadstart")}],["onsuspend",void 0,function(){o(e,"suspend")}],["onabort",void 0,function(){o(e,"abort")}],["onemptied",void 0,function(){o(e,"emptied")}],["onstalled",void 0,function(){o(e,"stalled")}],["onplay",void 0,function(){o(e,"play")}],["onpause",void 0,function(){o(e,"pause")}],["onloadedmetadata",void 0,function(){o(e,"loadedmetadata")}],["onwaiting",void 0,function(){o(e,"waiting")}],["onplaying",void 0,function(){o(e,"playing")}],["oncanplay",void 0,function(){o(e,"canplay")}],["oncanplaythrough",void 0,function(){o(e,"canplaythrough")}],["onended",void 0,function(){o(e,"ended")}],["ondurationchange",void 0,function(){o(e,"durationchange")}],["onvolumechange",void 0,function(){o(e,"volumechange")}],["ontimeupdate",void 0,function(){o(e,"timeupdate")}],["onprogress",void 0,function(){o(e,"progress")}],["oncontextmenu",void 0,function(){o(e,"contextmenu")}],["onerror",void 0,function(){o(e,"error")}]]]]),"video"===this.kind&&c(this.mediaElement,[["customAttributes",[["videoHeight",t,V],["videoWidth",t,V]]],["observableAttributes",[["clientHeight",this.mediaElement.clientHeight,function(){e.onPositionChanged("clientHeight")}],["clientLeft",this.mediaElement.clientLeft,function(){e.onPositionChanged("clientLeft")}],["clientTop",this.mediaElement.clientTop,function(){e.onPositionChanged("clientTop")}],["clientWidth",this.mediaElement.clientWidth,function(){e.onPositionChanged("clientWidth")}],["offsetHeight",this.mediaElement.offsetHeight,function(){e.onPositionChanged("offsetHeight")}],["offsetLeft",this.mediaElement.offsetLeft,function(){e.onPositionChanged("offsetLeft")}],["offsetParent",this.mediaElement.offsetParent,function(){e.onPositionChanged("offsetParent")}],["offsetTop",this.mediaElement.offsetTop,function(){e.onPositionChanged("offsetTop")}],["offsetWidth",this.mediaElement.offsetWidth,function(){e.onPositionChanged("offsetWidth")}],["parentElement",this.mediaElement.parentElement,function(){e.onPositionChanged("parentElement")}],["parentNode",this.mediaElement.parentNode,function(){e.onPositionChanged("parentNode")}],["style",this.mediaElement.style,function(){e.onStyleChanged("style")}]]]])},makeRpcCall:function(e,t,i,n,r){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcObjectId:this.rpcObjectId,rpcName:e,rpcArgs:t},i,n,r)}},A.prototype={sign:function(e){var t=this;return void 0==this.key?new Promise(function(i,n){t.importKey().then(function(){t.generateHash(e).then(function(e){i(e)}).catch(function(e){n(e)})}).catch(function(e){n(e)})}):this.generateHash(e)},importKey:function(){var e=this;return new Promise(function(t,i){window.crypto.subtle.importKey("raw",e.rawKey,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]).then(function(i){e.key=i,t()}).catch(function(e){i(e)})})},pad:function(e){for(;e.length<2;)e="0"+e;return e},generateHash:function(e){for(var t=this,i=e.length,n=new ArrayBuffer(i),r=new Uint8Array(n),c=0;c<i;++c)r[c]=e.charCodeAt(c);return new Promise(function(e,i){window.crypto.subtle.sign({name:"HMAC"},t.key,n).then(function(i){for(var n=new Uint8Array(i),r="",c=n.byteLength,o=0;o<c;++o)r+=t.pad(n[o].toString(16));e(r)}).catch(function(e){i(e)})})}},k.prototype={VERSION:"1.1.2108.11001",WEBSOCKET_DEFAULT_PORT:9500,WEBSOCKET_PORT:k.WEBSOCKET_DEFAULT_PORT,WEBSOCKET_URI_BASE:"ws://localhost",WEBSOCKET_URI:k.WEBSOCKET_URI_BASE+":"+k.WEBSOCKET_DEFAULT_PORT,WEBSOCKET_SERVICE_ID:"388FE4DA-5AAD-C078-FCD5-2DB6ADE9C174",WEBSOCKET_KEY:void 0,CLIENT_OS_NAME:void 0,CLIENT_OS_VERSION:void 0,CLIENT_APP_NAME:void 0,CLIENT_APP_VERSION:void 0,CLIENT_PLATFORM:void 0,OOB_CLIENT_VERSION:void 0,HOST_OS_VERSION:void 0,WEBRTC_VERSION:void 0,WEBRTC_REDIRECTOR_VERSION:void 0,WEBSOCKET_SERVICE_VERSION:void 0,VDI_MODE:void 0,SESSION_ID:void 0,ENDPOINT_ID:void 0,APP_WINDOW_NAME:"Chrome Legacy Window",NOTIFICATION_ASSETS_BASEURI:"https://teams.microsoft.com/assets/audio",MEDIAELEMENT_PLAYBACK_ID:"teamsDefaultPlayer",STATE_NOT_CONNECTED:0,STATE_CONNECTING:1,STATE_CONNECTED:2,STATE_WS_CONNECTION_FAILED:3,STATE_ENDPOINT_UNSUPPORTED:4,STATE_CONNECTION_FAILED:5,init:function(e){var t=this;j=e,_.info("WVD VDI shim loaded - v"+this.VERSION),this.getConfiguration().then(function(){t.startRtcSession()})},setConnectionState:function(e,t){_.info("connectionState changed from: "+this.connectionState+" to: "+e);var i=this.connectionState;if(this.connectionState=e,e===this.STATE_NOT_CONNECTED)this.verifyConnectionState([this.STATE_CONNECTING,this.STATE_CONNECTED],i),this.hidManagerRedirector.detachHidDevices(),this.notifyVmEventCallback({event:"vdiClientDisconnected",reason:"endpointDisconnected"}),this.resetVersionInfo();else if(e===this.STATE_CONNECTING){if(this.verifyConnectionState([this.STATE_NOT_CONNECTED],i),null==this.socket){_.debug("connecting to: "+this.WEBSOCKET_URI),this.webSocketUnavailable=!1,this.endpointUnsupported=!1;var n=new WebSocket(this.WEBSOCKET_URI);n.addEventListener("open",this.onWebSocketOpenFunctor,!1),n.addEventListener("closed",this.onWebSocketClosedFunctor,!1),n.addEventListener("error",this.onWebSocketErrorFunctor,!1),n.addEventListener("message",this.onWebSocketMessageFunctor,!1),this.socket=n}}else if(e===this.STATE_CONNECTED){this.verifyConnectionState([this.STATE_CONNECTING],i),this.rtcObjects.forEach(function(e){void 0!=e.enableRedirection&&e.enableRedirection()});var r={clientOS:this.CLIENT_OS_VERSION,hostOS:this.HOST_OS_VERSION,webRTC:this.WEBRTC_VERSION,webRTCRedirector:this.WEBRTC_REDIRECTOR_VERSION,websocketService:this.WEBSOCKET_SERVICE_VERSION,shim:this.VERSION,vdiMode:this.VDI_MODE};void 0!=this.CLIENT_OS_NAME&&(r.clientOSName=this.CLIENT_OS_NAME),void 0!=this.CLIENT_PLATFORM&&(r.clientPlatform=this.CLIENT_PLATFORM),void 0!=this.CLIENT_APP_NAME&&(r.clientAppName=this.CLIENT_APP_NAME),void 0!=this.CLIENT_APP_VERSION&&(r.clientAppVersion=this.CLIENT_APP_VERSION),void 0!=this.OOB_CLIENT_VERSION&&(r.oobClient=this.OOB_CLIENT_VERSION),this.notifyVmEventCallback({event:"vdiClientConnected",version:r,endpointId:this.ENDPOINT_ID});var c=this.getE911Info();if(null!=c){var o=this;c.then(function(e){o.notifyVmEventCallback({event:"vdiE911InfoChanged",bssid:e.bssid,E911:e.E911,ipv4:e.ipv4,ipv6:e.ipv6,mac:e.mac,subnetLengthIpv4:e.subnetLengthIpv4,subnetLengthIpv6:e.subnetLengthIpv6,latitude:e.latitude,longitude:e.longitude})}).catch(function(){_.debug("Could not obtain E911 information")})}else _.debug("Client does not support E911 information");this.enumerateDevicesOnConnect?this.enumerateDevices():this.enumerateDevicesOnConnect=!0,this.attachHidDevicesOnConnect?(this.hidManagerRedirector.startWithDeviceFilter(this.hidManagerRedirector.DeviceFilter_Telephony),this.hidManagerRedirector.attachHidDevices()):this.attachHidDevicesOnConnect=!0}else if(e===this.STATE_WS_CONNECTION_FAILED)this.verifyConnectionState([this.STATE_CONNECTING],i),_.info("connectionState changed from: "+this.connectionState+" to: "+this.STATE_NOT_CONNECTED),this.connectionState=this.STATE_NOT_CONNECTED,this.webSocketUnavailable=!0,this.closeWebSocketConnection(),this.notifyVmEventCallback({event:"vdiClientDisconnected",reason:"failure",msg:t});else if(e===this.STATE_ENDPOINT_UNSUPPORTED)this.verifyConnectionState([this.STATE_CONNECTING],i),_.info("connectionState changed from: "+this.connectionState+" to: "+this.STATE_NOT_CONNECTED),this.connectionState=this.STATE_NOT_CONNECTED,this.endpointUnsupported=!0,this.notifyVmEventCallback({event:"vdiClientDisconnected",reason:"endpointUnsupported",msg:t});else{if(e!==this.STATE_CONNECTION_FAILED)throw _.error("invalid connectionState: "+e),new Error({name:"MSRDCRTC: Error",message:"Connection state not expected: "+e});this.verifyConnectionState([this.STATE_CONNECTING,this.STATE_CONNECTED],i),_.info("connectionState changed from: "+this.connectionState+" to: "+this.STATE_NOT_CONNECTED),this.connectionState=this.STATE_NOT_CONNECTED,this.notifyVmEventCallback({event:"vdiClientDisconnected",reason:"failure",msg:t})}},verifyConnectionState:function(e,t){var i=!1;void 0==t&&(t=this.connectionState);for(var n in e)if(e[n]===t){i=!0;break}if(!i)throw _.error("invalid connectionState: "+this.connectionState+", expecting: "+e.toString()),new Error({name:"MSRDCRTC: Error",message:"Connection state not expected: "+this.connectionState+", expecting: "+e.toString()})},resetVersionInfo:function(){this.CLIENT_PLATFORM=void 0,this.CLIENT_OS_NAME=void 0,this.CLIENT_OS_VERSION=void 0,this.CLIENT_APP_NAME=void 0,this.CLIENT_APP_VERSION=void 0,this.OOB_CLIENT_VERSION=void 0,this.WEBRTC_VERSION=void 0,this.WEBRTC_REDIRECTOR_VERSION=void 0,this.VDI_MODE=void 0},closeWebSocketConnection:function(){if(null!=this.socket){var e=this.socket;_.debug("disconnected from: "+this.WEBSOCKET_URI),e.removeEventListener("open",this.onWebSocketOpenFunctor,!1),e.removeEventListener("closed",this.onWebSocketClosedFunctor,!1),e.removeEventListener("error",this.onWebSocketErrorFunctor,!1),e.removeEventListener("message",this.onWebSocketMessageFunctor,!1),this.socket=null,this.socketConnected=!1,this.socketClosed=!0}this.stopRtcSession(),this.SESSION_ID=void 0},setDebugLevel:function(e){if(e!==this.debugLevel){var t=this.debugLevel;if(this.debugLevel=e,_=0===e?w:1===e?M:P,0===e)window.clearInterval(this.periodicCallbackId),this.periodicCallbackId=null;else if(0===t){var i=this;this.periodicCallbackId=window.setInterval(function(){i.debugPeriodicCallback()},1e3)}}},redirectionSupported:function(){return!this.endpointUnsupported&&!this.webSocketUnavailable},startRtcSession:function(){var e=this;if(!this.endpointUnsupported&&(this.setConnectionState(this.STATE_CONNECTING),void 0==this.SESSION_ID)){var t=msRDCRTC.generateUuid(),i=Date.now().toString(),n=t+"|"+i;new A(this.WEBSOCKET_SERVICE_ID,this.WEBSOCKET_KEY).sign(n).then(function(n){e.makeRpcCall({rpcObjectType:"RDWebRTCRedirector",rpcName:"rtcSession",rpcArgs:[t,i,n,e.VERSION]},!0,!0).then(function(n){var r=n[0],c=n[1],o=n[2];void 0!=o&&(e.HOST_OS_VERSION=o.hostOS,e.WEBSOCKET_SERVICE_VERSION=o.websocketService),e.verifyRtcSession(t,i,r,c)}),e.trySendPendingMessages()}),this.registerAppWindowHandle()}},stopRtcSession:function(){this.pendingMessages=[],this.outstandingRpcCalls=new s,this.rtcObjects.forEach(function(e){void 0!=e.disableRedirection&&e.disableRedirection()}),this.connectionState!==this.STATE_NOT_CONNECTED&&this.setConnectionState(this.STATE_NOT_CONNECTED)},verifyRtcSession:function(e,t,i,n){var r=this;this.verifyConnectionState([this.STATE_CONNECTING]);var c=e+"|"+t+"|"+i;new A(this.WEBSOCKET_SERVICE_ID,this.WEBSOCKET_KEY).sign(c).then(function(e){e===n?(r.rtcSessionStarted=!0,r.trySendPendingMessages()):r.setConnectionState(r.STATE_WS_CONNECTION_FAILED,"WebSocket connection failed due to hash mismatch")})},getConfiguration:function(){var e=this;return new Promise(function(t,i){window.getWVDConfig().then(function(n){_.debug("config="+n);var r=JSON.parse(n);void 0!=r.port&&void 0!=r.key||i(new Error("invalid WVD config")),e.WEBSOCKET_PORT=r.port,e.WEBSOCKET_URI=e.WEBSOCKET_URI_BASE+":"+e.WEBSOCKET_PORT,e.WEBSOCKET_KEY=r.key,t()}).catch(function(e){i(e)})})},registerAppWindowHandle:function(){var e=this;window.getWindowHandleAsHex().then(function(t){t=a(t),_.info("app hwnd="+t),e.makeRpcCall({rpcObjectType:"RDWebRTCRedirector",rpcName:"setAppWindow",rpcArgs:[t,e.APP_WINDOW_NAME]})}).catch(function(e){_.error("failed to get the app window - "+e.toString())})},compareVersions:function(e,t){for(var i=e.match(/^(\d+)(?:\.(\d+))?(?:\.(\d+))?(?:\.(\d+))?$/),n=t.match(/^(\d+)(?:\.(\d+))?(?:\.(\d+))?(?:\.(\d+))?$/),r=1;r<=4;++r)void 0==i[r]&&(i[r]="0"),void 0==n[r]&&(n[r]="0");var c=1e13*Number.parseInt(i[1])+1e11*Number.parseInt(i[2])+1e5*Number.parseInt(i[3])+Number.parseInt(i[4]),o=1e13*Number.parseInt(n[1])+1e11*Number.parseInt(n[2])+1e5*Number.parseInt(n[3])+Number.parseInt(n[4]);return c==o?0:c<o?1:-1},compareVersionsLowerThan:function(e,t){var i=!0;return void 0!=t&&(i=this.compareVersions(e,t)<0),i},clientVersionLowerThan:function(e){return this.compareVersionsLowerThan(e,this.WEBRTC_REDIRECTOR_VERSION)},wssVersionLowerThan:function(e){return this.compareVersionsLowerThan(e,this.WEBSOCKET_SERVICE_VERSION)},compareVersionsGreaterThanOrEqual:function(e,t){var i=!1;return void 0!=t&&(i=this.compareVersions(e,t)>=0),i},clientVersionGreaterThanOrEqual:function(e){return this.compareVersionsGreaterThanOrEqual(e,this.WEBRTC_REDIRECTOR_VERSION)},wssVersionGreaterThanOrEqual:function(e){return this.compareVersionsGreaterThanOrEqual(e,this.WEBSOCKET_SERVICE_VERSION)},setVMEventCallback:function(e){this.vmEventCallback=e},newAudioElement:function(e,t){var i=new D("audio",e,t);this.rtcObjects.push(i);var n=!1;this.connectionState===this.STATE_CONNECTED&&(i.enableRedirection(),n=!0),_.info("newAudioElement returning "+(n?"":"un")+"shimmed object")},newVideoElement:function(e,t){var i=this.nextVideoElementId++;e.setAttribute("data-vdi_videoid",i);var n=new D("video",e,t);this.rtcObjects.push(n);var r=!1;this.connectionState===this.STATE_CONNECTED&&(n.enableRedirection(),r=!0),_.info("newVideoElement returning "+(r?"":"un")+"shimmed object, id="+i)},getNotifyAudio:function(e){var t=this.notifications[e];return void 0==t&&(t={id:e,sinkId:this.defaultSinkId,loop:!1,played:!1},this.notifications[e]=t),t},getNotificationAssetUri:function(e){var t=void 0;return e.match(/^http/i)?t=e:e.match(/[^\/]+$/)&&(t=e.replace(/.*?([^\/]+)$/,this.NOTIFICATION_ASSETS_BASEURI+"/$1")),t},playNotifyAudio:function(e,t){_.debug("playNotifyAudio("+JSON.stringify(arguments)+")");var i=this.getNotifyAudio(e);i.played=!0;var n=this.getNotificationAssetUri(t);this.makeRpcCall({rpcObjectType:"RDWebRTCRedirector",rpcName:"playNotifyAudio",rpcArgs:[{audioId:e,uri:n,sinkId:i.sinkId,loop:i.loop}]})},pauseNotifyAudio:function(e){_.debug("pauseNotifyAudio("+JSON.stringify(arguments)+")"),this.getNotifyAudio(e).played&&this.makeRpcCall({rpcObjectType:"RDWebRTCRedirector",rpcName:"pauseNotifyAudio",rpcArgs:[{audioId:e}]})},setLoop:function(e,t){_.debug("pauseNotifyAudio("+JSON.stringify(arguments)+")"),this.getNotifyAudio(e).loop=t},setSinkId:function(e,t){_.debug("setSinkId("+JSON.stringify(arguments)+")"),this.getNotifyAudio(e).sinkId=t},setDefaultSinkId:function(e){_.debug("setDefaultSinkId("+JSON.stringify(arguments)+")"),this.defaultSinkId=e},getE911Info:function(){if(_.debug("getE911Info()"),msRDCRTC.clientVersionGreaterThanOrEqual("1.1.2105.21001")){var e=this;return new Promise(function(t,i){e.makeRpcCall({rpcObjectType:"RDWebRTCRedirector",rpcName:"getE911Info"},!0,!0).then(function(e){t(e)}).catch(function(e){i(e)})})}return null},addClipRect:function(e,t){var i=new Date;_.info("TimeStamp: "+i.toTimeString()+" addClipRect("+JSON.stringify(arguments)+")");var n=a(t);this.makeRpcCall({rpcObjectType:"RDWebRTCRedirector",rpcName:"addClipRect",rpcArgs:[{left:e.left,top:e.top,right:e.right,bottom:e.bottom,shape:"rectangle"},n]})},removeClipRect:function(e,t){var i=new Date;_.info("TimeStamp: "+i.toTimeString()+" removeClipRect("+JSON.stringify(arguments)+")");var n=a(t);this.makeRpcCall({rpcObjectType:"RDWebRTCRedirector",rpcName:"removeClipRect",rpcArgs:[{left:e.left,top:e.top,right:e.right,bottom:e.bottom,shape:"rectangle"},n]})},addClipCircle:function(e,t){_.info("addClipCircle("+JSON.stringify(arguments)+")");var i=a(t);this.makeRpcCall({rpcObjectType:"RDWebRTCRedirector",rpcName:"addClipRect",rpcArgs:[{left:e.left,top:e.top,right:e.right,bottom:e.bottom,shape:"ellipse"},i]})},removeClipCircle:function(e,t){_.info("removeClipCircle("+JSON.stringify(arguments)+")");var i=a(t);this.makeRpcCall({rpcObjectType:"RDWebRTCRedirector",rpcName:"removeClipRect",rpcArgs:[{left:e.left,top:e.top,right:e.right,bottom:e.bottom,shape:"ellipse"},i]})},createPeerConnection:function(e,t){var i;if(null!=e&&(e=JSON.parse(JSON.stringify(e))),null!=t&&(t=JSON.parse(JSON.stringify(t))),this.redirectionSupported())(i=new O(e,t)).teamsId=this.nextPeerConnectionId++,_.info("createPeerConnection returning shimmed object, id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),this.rtcObjects.push(i);else{(i=new this.actualRTCPeerConnection(e,t)).teamsId=this.nextPeerConnectionId++,_.info("createPeerConnection returning hooked object, id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments));var n=i.addIceCandidate;i.addIceCandidate=function(){return _.info("addIceCandidate id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),n.apply(i,arguments)};var r=i.createOffer;i.createOffer=function(){return _.info("createOffer id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),r.apply(i,arguments)};var c=i.createAnswer;i.createAnswer=function(){return _.info("createAnswer id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),c.apply(i,arguments)};var o=i.setRemoteDescription;i.setRemoteDescription=function(){return _.info("setRemoteDescription id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),o.apply(i,arguments)};var a=i.setLocalDescription;i.setLocalDescription=function(){return _.info("setLocalDescription id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),a.apply(i,arguments)};var s=i.createDTMFSender;i.createDTMFSender=function(){return _.info("createDTMFSender id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),s.apply(i,arguments)};var d=i.getLocalStreams;i.getLocalStreams=function(){_.info("getLocalStreams id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments));var e=d.apply(i,arguments);return _.info("VDI Local Streams",e),e};var u=i.getRemoteStreams;i.getRemoteStreams=function(){return _.info("getRemoteStreams id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),u.apply(i,arguments)};var h=i.getStats;i.getStats=function(){return _.info("getStats id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),h.apply(i,arguments)};var l=i.addStream;i.addStream=function(){return _.info("addStream id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),l.apply(i,arguments)};var p=i.addTrackStream;i.addTrack=function(){return _.info("addTrack id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),p.apply(i,arguments)};var v=i.removeStream;i.removeStream=function(){return _.info("removeStream id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),v.apply(i,arguments)};var f=i.getReceivers;i.getReceivers=function(){return _.info("getReceivers id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),f.apply(i,arguments)};var g=i.close;i.close=function(){return _.info("close id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),g.apply(i,arguments)},["onnegotiationneeded","onsignalingstatechange","onaddstream","onremovestream","onicecandidate","oniceconnectionstatechange","onicegatheringstatechange","onicecandidateerror","ontrack","onconnectionstatechange"].forEach(function(e){var t=i[e];i[e]=function(){if(_.info(e+" id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),t)return t.apply(i,arguments)}})}return i},createMediaStream:function(e){var t,i=this;if(this.redirectionSupported()){(t=new T).teamsId=this.nextMediaStreamId++;var n;_.info("createMediaStream creating shimmed object, id="+t.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),void 0!=e&&(n=new Array,e.forEach(function(e){for(var r="screenshare"==e.kind,c="video"==e.kind,o=i.mediaDevicesRedirector.mediaDevices,a=null==o?0:o.length,s=0;s<a;++s){var d=o[s];(c&&"videoinput"==d.kind||r&&"displayOutput"==d.kind&&d.label===e.label)&&n.push(d)}var u=new E(t,d);t.addTrack(u)}),t.devices=n),_.info("createMediaStream returning shimmed object"+JSON.stringify(t))}else{(t=new this.actualMediaStream(id,constraints)).teamsId=this.nextMediaStreamId++,_.info("createMediaStream returning hooked object, id="+t.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments));var r=t.getAudioTracks;t.getAudioTracks=function(){return _.info("getAudioTracks id="+t.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),r.apply(t,arguments)};var c=t.getVideoTracks;t.getVideoTracks=function(){return _.info("getVideoTracks id="+t.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),c.apply(t,arguments)};t.getTracks;t.getTracks=function(){return _.info("getTracks id="+t.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),originaGetTracks.apply(t,arguments)};t.getTrackById;t.getTrackById=function(){return _.info("getTrackById id="+t.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),originaGetTrackById.apply(t,arguments)};var o=t.addTrack;t.addTrack=function(){return _.info("addTrack id="+t.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),o.apply(t,arguments)};var a=t.removeTrack;t.removeTrack=function(){return _.info("removeTrack id="+t.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),a.apply(t,arguments)};var s=t.clone;t.clone=function(){return _.info("clone id="+t.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),s.apply(t,arguments)},["onaddtrack","onremovetrack"].forEach(function(e){var i=t[e];t[e]=function(){if(_.info(e+" id="+t.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),i)return i.apply(t,arguments)}})}return t},getCapabilities:function(e){var t=this;void 0==this.recvCapabilities&&this.rtcObjects.forEach(function(e){"RTCPeerConnection"==e.rpcObjectType&&void 0!=e.recvCapabilities.video&&void 0!=e.recvCapabilities.audio&&(t.recvCapabilities=e.recvCapabilities)});{if(void 0!=this.recvCapabilities)return"video"==e?(_.info("getCapabilities shimmed function call args="+e+" returning="+JSON.stringify(this.recvCapabilities.video)),this.recvCapabilities.video):"audio"==e?(_.info("getCapabilities shimmed function call args="+e+" returning="+JSON.stringify(this.recvCapabilities.audio)),this.recvCapabilities.audio):void 0;_.info("getCapabilities shimmed function call args="+e+" returning=undefined")}},createHidManager:function(){return this.hidManagerRedirector},getUserMedia:function(){return this.mediaDevicesRedirector.getUserMedia.apply(this.mediaDevicesRedirector,arguments)},enumerateDevices:function(){return this.mediaDevicesRedirector.enumerateDevices.apply(this.mediaDevicesRedirector,arguments)},getDisplayMedia:function(){return this.mediaDevicesRedirector.getDisplayMedia.apply(this.mediaDevicesRedirector,arguments)},getScreensAsync:function(){return this.mediaDevicesRedirector.getScreensAsync.apply(this.mediaDevicesRedirector,arguments)},setScreenSharePanelId:function(){return this.mediaDevicesRedirector.setScreenSharePanelId.apply(this.mediaDevicesRedirector,arguments)},isFeatureSupported:function(e){var t=!1;return"video"===e?void 0!=this.clientFeatures&&"disabled"===this.clientFeatures.camera||(t=!0):"screenshare"===e?void 0!=this.clientFeatures&&"enabled"===this.clientFeatures.screenshare&&(t=!0):"multimonitorscreenshare"===e?void 0!=this.clientFeatures&&"enabled"===this.clientFeatures.multimonitorscreenshare&&this.wssVersionGreaterThanOrEqual("1.0.2006.4001")&&(t=!0):"hid"===e?(t=!0,void 0!=this.clientFeatures&&"enabled"===this.clientFeatures.hid&&(t=!0)):"multiwindow"===e?this.wssVersionGreaterThanOrEqual("1.0.2102.19001")&&(t=!0):"datachannel"===e&&void 0!=this.clientFeatures&&"enabled"===this.clientFeatures.datachannel&&(t=!0),_.debug("isFeatureSupported("+JSON.stringify(arguments)+") returning: "+t),t},onWebSocketOpen:function(e){_.debug("WebSocket opened"),this.socketConnected=!0,this.trySendPendingMessages()},onWebSocketClosed:function(e){_.debug("WebSocket closed"),this.setConnectionState(this.STATE_NOT_CONNECTED)},onWebSocketError:function(e){_.error("WebSocket error");var t=this.connectionState===this.STATE_CONNECTING?this.STATE_WS_CONNECTION_FAILED:this.STATE_CONNECTION_FAILED,i=this.connectionState===this.STATE_CONNECTING?"WebSocket connection failed":"WebSocket error";this.setConnectionState(t,i)},onWebSocketMessage:function(e){_.debug("onWebSocketMessage");var t=null;try{var i=new String(e.data),n=i.lastIndexOf("}");i=i.substring(0,n+1),t=JSON.parse(i)}catch(t){_.error("failed to parse the JSON string: ["+e.data+"] - "+t.toString())}if(null!=t)try{void 0!=t.rpcCallId?this.onRpcResponse(t):void 0!=t.rpcEventTarget?this.onRpcEventNotification(t):_.error("error: received RPC response with no rpcCallId or rpcEventTarget defined")}catch(t){_.error("failed to handle the WebSocket message: ["+e.data+"] - "+t.toString())}},onSessionInfo:function(e){_.debug("onSessionInfo: "+JSON.stringify(e));var t=e.version;void 0!=t&&(this.CLIENT_OS_NAME=t.clientOSName,this.CLIENT_OS_VERSION=t.clientOS,this.CLIENT_APP_NAME=t.clientAppName,this.CLIENT_APP_VERSION=t.clientAppVersion,this.CLIENT_PLATFORM=t.clientPlatform,this.OOB_CLIENT_VERSION=t.oobClient,this.WEBRTC_VERSION=t.webRTC,this.WEBRTC_REDIRECTOR_VERSION=t.webRTCRedirector);var i=e.session;void 0!=i?(this.ENDPOINT_ID=i.endpointId,this.VDI_MODE=i.vdiMode):this.ENDPOINT_ID=e.endpointId,this.SESSION_ID=e.sessionId,this.clientFeatures=e.features,void 0!=this.clientFeatures&&"disabled"===this.clientFeatures.microphone?(_.warn("endpoint microphone access is disabled"),this.setConnectionState(this.STATE_ENDPOINT_UNSUPPORTED,"endpoint microphone access is disabled")):this.setConnectionState(this.STATE_CONNECTED)},onSessionChange:function(e){var t=e.status;void 0!=t&&(_.debug("onSessionChange: received sessionChange event: "+e.status),"connected"===t?(this.endpointUnsupported=!1,this.connectionState===this.STATE_NOT_CONNECTED&&this.startRtcSession()):"disconnected"===t&&this.stopRtcSession())},onRpcResponse:function(e){0===e.hr?_.debug("onRpcResponse: "+JSON.stringify(e)):_.error("onRpcResponse - ERROR: "+JSON.stringify(e));var t=e.rpcCallId,i=this.outstandingRpcCalls[t];if(void 0!=i){i.stats.completed=performance.now();var n=i.stats.completed-i.stats.started;(n>=1e3?_.warn:_.debug)('"rpcCallId":'+t+" took "+n.toFixed(4)+" ms"),delete this.outstandingRpcCalls[t],i.onRpcResponse(e)}else _.error("error: received RPC response with unexpected rpcCallId: "+t)},onRpcEventNotification:function(e){if(0===e.hr?_.debug("onRpcEventNotification: "+JSON.stringify(e)):_.error("onRpcEventNotification - ERROR: "+JSON.stringify(e)),void 0!=e.rpcEventTarget)if(void 0!=e.rpcEventTarget.rpcObjectType)if(void 0!=e.rpcEventName){var t=!1;"RDWebRTCRedirector"===e.rpcEventTarget.rpcObjectType?t=this.handleRpcEventNotification(e):this.rtcObjects.forEach(function(i){void 0!=i.onRpcEventNotification&&i.onRpcEventNotification(e)&&(t=!0)}),t||_.warn("warning - received RPC event notification but no objects handled the event")}else _.error("error: received RPC event notification with no rpcEventName defined");else _.error("error: received RPC event notification with no rpcEventTarget.rpcObjectType defined");else _.error("error: received RPC event notification with no rpcEventTarget defined")},handleRpcEventNotification:function(e){var t=!0,i=e.rpcEventName;if("sessioninfo"===i)this.onSessionInfo(e.rpcEventArgs);else if("sessionchange"===i)this.onSessionChange(e.rpcEventArgs);else if("vdiScreenTopologyChanged"===i)this.notifyVmEventCallback({event:"vdiScreenTopologyChanged"});else if("vdiE911InfoChanged"===i){var n=e.rpcEventArgs.e911Info;this.notifyVmEventCallback({event:"vdiE911InfoChanged",bssid:n.bssid,E911:n.E911,ipv4:n.ipv4,ipv6:n.ipv6,mac:n.mac,subnetLengthIpv4:n.subnetLengthIpv4,subnetLengthIpv6:n.subnetLengthIpv6,latitude:n.latitude,longitude:n.longitude})}else"virtualchannelerror"===i?this.setConnectionState(this.STATE_ENDPOINT_UNSUPPORTED,"virtual channel connection failed: hr="+d(e.hr)):"error"===i?this.setConnectionState(this.STATE_CONNECTION_FAILED,"hr="+d(e.hr)):t=!1;return t},sendWebSocketMessage:function(e,t){if(this.socketConnected&&(this.rtcSessionStarted||this.isSessionHandshakeMessage(e))){var i="close"===e;if(!i||!this.socketClosed){var n=new Date;_.debug("TimeStamp: "+n.toTimeString()+" Sending... "+e);try{this.socket.send(e),this.socketClosed=i}catch(e){_.error("failed to send WebSocket message - "+e.toString()),this.setConnectionState(this.STATE_NOT_CONNECTED)}}}else t?this.pendingMessages.unshift(e):this.pendingMessages.push(e)},isSessionHandshakeMessage:function(e){var t=JSON.parse(e);return"RDWebRTCRedirector"===t.rpcObjectType&&"rtcSession"===t.rpcName},trySendPendingMessages:function(){if(this.socketConnected)for(;;){var e=this.pendingMessages.shift();if(void 0==e)break;if(!this.rtcSessionStarted&&!this.isSessionHandshakeMessage(e)){this.pendingMessages.unshift(e);break}this.sendWebSocketMessage(e)}},getNextRpcObjectId:function(){return this.nextRpcObjectId++},getNextOperationId:function(){return this.nextOperationId++},generateUuid:function(){for(var e=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},t=null;;)if(t=e()+e()+e()+"4"+e().substring(1)+"b"+e().substring(1)+e()+e()+e(),void 0==this.uniqueIds[t]){this.uniqueIds[t]=!0;break}return t},makeRpcCall:function(e,t,i,n){var r=this.nextRpcCallId++;e.rpcCallId=r;var c=e.rpcArgs,o=!0;for(var a in c)if(void 0!=c[a]){o=!1;break}if(o&&(e.rpcArgs=[]),n){for(var s=[];;){var u=this.pendingMessages.shift();if(void 0==u)break;var h=JSON.parse(u);h.rpcObjectId===e.rpcObjectId&&h.rpcName===e.rpcName?_.debug("Dropping superceded RPC call: "+u):s.push(u)}this.pendingMessages=s}var l=JSON.stringify(e);this.sendWebSocketMessage(l,i);var p;return void 0==t||t?(e.stats={started:performance.now()},p=new Promise(function(t,i){e.onRpcResponse=function(e){0===e.hr?t(e.result):i(new Error("RPC call failed with hr="+d(e.hr)))}}),this.outstandingRpcCalls[r]=e):p=new Promise(function(e,t){e()}),p},disconnectAllCalls:function(){this.notifyVmEventCallback({event:"vdiClientDisconnected",request:"endCalls"})},notifyVmEventCallback:function(e){"vdiE911InfoChanged"!=e.event&&_.info("notifyVmEventCallback event="+JSON.stringify(e)),void 0!=this.vmEventCallback&&this.vmEventCallback(e)},debugPeriodicCallback:function(){this.rtcObjects.forEach(function(e){void 0!=e.debugPeriodicCallback&&e.debugPeriodicCallback()})}},msRDCRTC=new k,{init:function(){return msRDCRTC.init.apply(msRDCRTC,arguments)},setVMEventCallback:function(){return msRDCRTC.setVMEventCallback.apply(msRDCRTC,arguments)},newAudioElement:function(){return msRDCRTC.newAudioElement.apply(msRDCRTC,arguments)},newVideoElement:function(){return msRDCRTC.newVideoElement.apply(msRDCRTC,arguments)},playNotifyAudio:function(){return msRDCRTC.playNotifyAudio.apply(msRDCRTC,arguments)},pauseNotifyAudio:function(){return msRDCRTC.pauseNotifyAudio.apply(msRDCRTC,arguments)},setLoop:function(){return msRDCRTC.setLoop.apply(msRDCRTC,arguments)},setSinkId:function(){return msRDCRTC.setSinkId.apply(msRDCRTC,arguments)},setDefaultSinkId:function(){return msRDCRTC.setDefaultSinkId.apply(msRDCRTC,arguments)},getE911Info:function(){return msRDCRTC.getE911Info.apply(msRDCRTC,arguments)},addClipRect:function(){return msRDCRTC.addClipRect.apply(msRDCRTC,arguments)},removeClipRect:function(){return msRDCRTC.removeClipRect.apply(msRDCRTC,arguments)},addClipCircle:function(){return msRDCRTC.addClipCircle.apply(msRDCRTC,arguments)},removeClipCircle:function(){return msRDCRTC.removeClipCircle.apply(msRDCRTC,arguments)},createPeerConnection:function(){return msRDCRTC.createPeerConnection.apply(msRDCRTC,arguments)},createMediaStream:function(){return msRDCRTC.createMediaStream.apply(msRDCRTC,arguments)},getCapabilitiesShim:function(){return msRDCRTC.getCapabilities.apply(msRDCRTC,arguments)},getUserMediaShim:function(){return msRDCRTC.getUserMedia.apply(msRDCRTC,arguments)},mediaDevicesGetUserMediaShim:function(){return msRDCRTC.getUserMedia.apply(msRDCRTC,arguments)},enumerateDevicesShim:function(){return msRDCRTC.enumerateDevices.apply(msRDCRTC,arguments)},getDisplayMediaShim:function(){return msRDCRTC.getDisplayMedia.apply(msRDCRTC,arguments)},getScreensAsync:function(){return msRDCRTC.getScreensAsync.apply(msRDCRTC,arguments)},setScreenSharePanelId:function(){return msRDCRTC.setScreenSharePanelId.apply(msRDCRTC,arguments)},isFeatureSupported:function(){return msRDCRTC.isFeatureSupported.apply(msRDCRTC,arguments)},createHidManager:function(){return msRDCRTC.createHidManager.apply(msRDCRTC,arguments)}}});