webpackJsonp([7],{2731:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n(2732)},2732:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(2733),r=n(2766),s=n(2767),a=n(2769),c=n(2770),d=n(2771),l=function(e){function t(t,n,i,o,r,s,a,c,d,l,m,p,g,h,u,v,C,f,S,y,I,D,P,R,T,b,E,O,k,w,A,M,_){var L=e.call(this,i)||this;return L.transportDependencyProviderService=t,L.constants=o,L.loggingService=r,L.appStateService=s,L.$q=a,L.settingsService=c,L.utilityService=d,L.callingAgentsService=l,L.$translate=m,L.resources=p,L.callingService=g,L.$injector=h,L.dialingService=u,L.$timeout=v,L.dialogService=C,L.deepLinkService=f,L.eventingService=S,L.$rootScope=y,L.channelService=I,L.multiWindowService=D,L.callingNavigationService=P,L.callTogglingService=R,L.devicesBLEService=T,L.storageService=b,L.bluetoothLEService=E,L.myUserPreferencesStore=O,L.platformDetectService=k,L.authenticationService=w,L.rigelSpeakerService=A,L.rigelServiceHandler=M,L.meetingRoomUbarService=_,L.logger=r.newLogger("transportLazyLoadService"),L.initializeOnAppLaunchAndReinit(),L}return i(t,e),t.$inject=["transportDependencyProviderService","transportAgentService","orchestrationService","constants","loggingService","appStateService","$q","settingsService","utilityService","callingAgentsService","$translate","resources","callingService","$injector","dialingService","$timeout","dialogService","deepLinkService","eventingService","$rootScope","channelService","multiWindowService","callingNavigationService","callTogglingService","devicesBLEService","storageService","bluetoothLEService","myUserPreferencesStore","platformDetectService","authenticationService","rigelSpeakerService","rigelServiceHandler","meetingRoomUbarService"],t.prototype.getTransportCommandRouter=function(){return this.transportCommandRouter},t.prototype.getTransportConnectionHandler=function(){return this.transportConnectionHandler},t.prototype.getRemoteControllerConnectionHandler=function(){return this.remoteControllerConnectionHandler},t.prototype.getRemoteControllerSessionManager=function(){return this.remoteControllerSessionManager},t.prototype.getTransportAgentHandler=function(){return this.transportAgentHandler},t.prototype.getTransportCallKeeper=function(){return this.transportCallKeeper},t.prototype.initializeTranportConnectionHandling=function(e,t){this.transportCommandRouter=new o.TransportCommandRouter(this.transportDependencyProviderService,t,e,this.constants,this.loggingService,this.appStateService,this.$q,this.settingsService,this.utilityService,this.callingAgentsService,this.$translate,this.resources,this.callingService,this.$injector,this.dialingService,this.$timeout,this.dialogService,this.deepLinkService,this.eventingService,this.$rootScope,this.channelService,this.multiWindowService,this.callingNavigationService,this.callTogglingService,this.platformDetectService,this.rigelSpeakerService,this.authenticationService,this.rigelServiceHandler,this.meetingRoomUbarService),this.transportConnectionHandler=new r.TransportConnectionHandler(this.transportDependencyProviderService,this.transportCommandRouter,this.constants,this.storageService,this.bluetoothLEService,this.loggingService,this.settingsService,this.myUserPreferencesStore,this.$q,this.authenticationService,this.utilityService,this.appStateService),this.remoteControllerConnectionHandler=new s.RemoteControllerConnectionHandler(this.transportDependencyProviderService,this.devicesBLEService,this.loggingService,this.callTogglingService,this.$rootScope,this.constants,this.callingService,this.meetingRoomUbarService),this.transportAgentHandler=new c.TransportAgentHandler(this.transportCommandRouter,this.transportConnectionHandler),this.remoteControllerSessionManager=new a.RemoteControllerSessionManager(this.transportDependencyProviderService,t,e,this.utilityService,this.settingsService,this.constants,this.loggingService,this.$q),this.transportCallKeeper=new d.TransportCallKeeper(this.$q,this.loggingService,this.$injector)},t.prototype.cleanupOnAppTeardown=function(e){this.logger.info("clean up has been called. marking commandRouter and connectionHandler as undefined."),this.transportConnectionHandler.cleanUpConnectionHandler(),this.transportCallKeeper.cleanupCallKeeper(),this.remoteControllerConnectionHandler.cleanup(),this.remoteControllerSessionManager.cleanup(),this.transportCommandRouter=void 0,this.transportConnectionHandler=void 0,this.remoteControllerConnectionHandler=void 0,this.remoteControllerSessionManager=void 0,this.transportAgentHandler=void 0,this.transportCallKeeper=void 0},t.prototype.initializeOnAppLaunchAndReinit=function(e){},t.prototype.mtmaTelemetryIdentifier=function(){return"TransportLazyLoadService"},t}(teamspace.services.MTMABase);t.TransportLazyLoadService=l,angular.module("teamspace.transportLazyLoadService",["teamspace.transportDependencyProviderService","teamspace.transportAgentService","teamspace.constants","teamspace.loggingService","teamspace.settingsService","teamspace.utilityService","teamspace.bluetoothLEService","teamspace.orchestrationService","teamspace.authenticationService","teamspace.dialogService","teamspace.storageService","teamspace.trouterService","teamspace.callingAgentsService","teamspace.callingService","teamspace.callingNavigationService","teamspace.multiWindowService","teamspace.channelService","teamspace.loggingService","teamspace.desktopUtilityService","teamspace.tenantService","teamspace.platformDetectService","teamspace.localizationService","teamspace.appState","teamspace.eventingService","teamspace.deviceManagerService","oc.lazyLoad","teamspace.locales","teamspace.brbV2FeedbackService","skypeX.myUserPreferencesStore","teamspace.dialingService","skypeX.sxConfig","teamspace.callingAlertsService","teamspace.callingConversationService","teamspace.rigelSpeakerService","teamspace.rigelServiceHandler","teamspace.meetingRoomUbarService","pascalprecht.translate"]).service("transportLazyLoadService",l)},2733:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i,o=n(2734),r=n(2747),s=n(2755),a=n(2764);!function(e){e.InitState="InitState",e.ActiveIncomingCommandsCount="ActiveIncomingCommandsCount",e.ActiveOutgoingCommandsCount="ActiveOutgoingCommandsCount",e.AckFailedCountInSession="AckFailedCountInSession",e.AckSuccessCountInSession="AckSuccessCountInSession"}(i=t.TransportCommandRouterStates||(t.TransportCommandRouterStates={}));var c=function(){function e(e,t,n,c,d,l,m,p,g,h,u,v,C,f,S,y,I,D,P,R,T,b,E,O,k,w,A,M,_){this.transportDependencyProviderService=e,this.transportStack=t,this.transportUser=n,this.constants=c,this.loggingService=d,this.$q=m,this.utilityService=g,this.callingAgentsService=h,this.ComponentName="TransportCommandRouter",this.ackSuccessCount=0,this.ackFailureCount=0,this.outgoingCommandResponseTimeout=6e4,this.incomingCommandFactory=new o.IncomingCommandFactory(e,c,d,l,m,p,u,g,v,C,f,S,y,I,D,P,R,T,b,E),this.outgoingCommandFactory=new r.OutgoingCommandFactory(e,c,d,m,p,g,l,S,C),this.remoteControllerIncomingCommandFactory=new s.RemoteControllerIncomingCommandFactory(e,O,d,C,m,c,u,k,h,p,v,R,w,A,M,P,_),this.remoteControllerOutgoingCommandFactory=new a.RemoteControllerOutgoingCommandFactory(d,c,m,g),this.activeIncomingCommands=new Map,this.activeOutgoingCommands=new Map,this.setupInitialStates(),this.constants=c,this.logger=d.newLogger(this.ComponentName),this.states.set(i.InitState,teamspace.services.ITransportComponentState.Initialized)}return e.prototype.onIncomingCommandReceived=function(e,t){var n=this,i=this.loggingService.newScenario(this.constants.scenarios.betterTogether.incomingCommand.incomingCommand,null,null,null,!0);if(e&&e.command){var o=this.getNameForIncomingCommand(e.command);i.appendEventData({source:o})}else i.appendEventData({source:this.constants.scenarios.betterTogether.incomingCommand.invalidCommand});if(this.validateIncomingCommand(e,t,i)){var r=e.command;if(this.logger.info("Incoming command received. "+this.getLogPrefixIncomingRequest(e)),r===teamspace.services.IncomingCommand.Response)return this.ackIncomingCommandSuccess(t,e),void this.onResponseReceivedForOutgoingCommand(e,i);var s;if(!1!==(s=this.transportDependencyProviderService.runsInRoomRemoteControlMode?this.remoteControllerIncomingCommandFactory.createCommand(e,i):this.incomingCommandFactory.createCommand(e,i)).result)s=s,this.activeIncomingCommands.set(e.causeId,s),this.ackIncomingCommandSuccess(t,e),s.action().promise.then(function(t){n.sendResponse(e,t),n.logger.info("Sending response for "+e.command+". "+n.getLogPrefixIncomingRequest(e))}).catch(function(t){n.sendResponse(e,t,!0),n.logger.error("Error in executing command "+e.command+" - Error - "+t.errorDetails+". "+n.getLogPrefixIncomingRequest(e))});else{var a={errorCode:s.errorCode,errorDetails:s.message};this.ackIncomingCommandFailure(t,e,a)}}},e.prototype.getLogPrefixIncomingRequest=function(e){return"requestCauseId - "+(null===e||void 0===e?void 0:e.causeId)+", endPointId - "+(null===e||void 0===e?void 0:e.endpointId)+", commandName - "+(null===e||void 0===e?void 0:e.command)},e.prototype.getLogPrefixOutgoingCommand=function(e){var t;return"outgoingCommandCauseId - "+(null===e||void 0===e?void 0:e.causeId)+", endPointId - "+(null===(t=null===e||void 0===e?void 0:e.endpoint)||void 0===t?void 0:t.getEndpointId())+", commandName - "+(null===e||void 0===e?void 0:e.name)},e.prototype.ackIncomingCommandSuccess=function(e,t){var n=t.causeId,i=t.endpointId,o=e({status:200,body:JSON.stringify({})}),r=this.loggingService.newScenario(this.constants.scenarios.betterTogether.commandRouter.ackIncomingCommand.success,null,null,null,!0);o!==teamspace.services.ResponseSendStatusCode.Success?(r.fail({endPointId:i,requestId:n,errorMessage:"responseSendStatusCode - "+teamspace.services.ResponseSendStatusCode[o]+" ("+o+")}",message:t.command}),this.logger.error("Failed to send ack for the incoming command - result: "+o+". "+this.getLogPrefixIncomingRequest(t))):(r.stop({endPointId:i,requestId:n,message:t.command}),this.logger.info("Ack sent for incoming command. "+this.getLogPrefixIncomingRequest(t)))},e.prototype.ackIncomingCommandFailure=function(e,t,n){var i=t.causeId,o=t.endpointId,r=e({status:300,body:n?JSON.stringify(n):JSON.stringify({})}),s=this.loggingService.newScenario(this.constants.scenarios.betterTogether.commandRouter.ackIncomingCommand.failure,null,null,null,!0);r!==teamspace.services.ResponseSendStatusCode.Success?(s.fail({endPointId:o,requestId:i,errorMessage:"responseSendStatusCode - "+teamspace.services.ResponseSendStatusCode[r]+" ("+r+")}",message:t.command}),this.logger.error("Failed to send failure for the incoming command - result: "+r+". "+this.getLogPrefixIncomingRequest(t))):(s.stop({endPointId:o,requestId:i,message:t.command}),this.logger.info("Failed-Ack-response sent for incoming command. "+this.getLogPrefixIncomingRequest(t)))},e.prototype.validateIncomingCommand=function(e,t,n){var i=e.causeId,o=e.endpointId;if(!this.transportDependencyProviderService.canInitializeTransport())return this.logger.error("ECS not enabled. Received incoming command "+e.command+". "+this.getLogPrefixIncomingRequest(e)),n.fail({endPointId:o,requestId:i,errorMessage:this.constants.transportTelemetryErrorCode.incomingCommand.featureDisabled}),!1;if(!e)return this.logger.error("Invalid transport command request. "+this.getLogPrefixIncomingRequest(e)),n.fail({endPointId:o,requestId:i,errorMessage:this.constants.transportTelemetryErrorCode.incomingCommand.invalidCommandRequest}),!1;var r=JSON.parse(e.commandDetails);if(r.targetEndpointId&&this.callingAgentsService.getRegistrationId()!==r.targetEndpointId){this.logger.error("Incoming commmand is not meant for this endpoint id. own endpointId - "+this.callingAgentsService.getRegistrationId()+", target endpointId - "+(r.targetEndpointId||"")+". "+this.getLogPrefixIncomingRequest(e));var s={errorCode:this.constants.transportTelemetryErrorCode.incomingCommand.incorrectEndpointId};return n.fail({endPointId:o,requestId:i,errorMessage:s.errorCode,message:"callingEndpointId - "+this.callingAgentsService.getRegistrationId()+"; targetEndpointId - "+(r.targetEndpointId||"")}),this.ackIncomingCommandFailure(t,e,s),!1}return!0},e.prototype.cleanupIncomingCommand=function(e){var t=this.activeIncomingCommands.get(e);t&&(this.activeIncomingCommands.delete(e),t=void 0)},e.prototype.sendResponse=function(e,t,n){var i=this;void 0===n&&(n=!1);var o=n?400:200,r=e.causeId;if(this.activeIncomingCommands.get(r)){if(t){t.statusCode=o,t.requestCauseId=r;var s=this.sendOutgoingCommand(teamspace.services.OutgoingCommand.Response,t,e.endpointId);s?s.promise.then(function(t){i.logger.info("Response completed. "+i.getLogPrefixIncomingRequest(e))}):this.logger.error("Response command not created. "+this.getLogPrefixIncomingRequest(e))}this.cleanupIncomingCommand(r)}},e.prototype.sendOutgoingCommand=function(e,t,n){var i,o,r=this,s=this.getNameForOutgoingCommand(e),a=this.loggingService.newScenario(this.constants.scenarios.betterTogether.outgoingCommand.outgoingCommand,null,null,null,!0);a.appendEventData({source:s});var c=this.transportDependencyProviderService.isCallingRelatedCommand(e);if(!this.transportDependencyProviderService.canInitializeTransport()){m={errorDetails:"FF not enabled for outgoing command "+e,errorCode:this.constants.transportTelemetryErrorCode.outgoingCommand.featureDisabled,statusCode:400,salt:[-1],requestCauseId:"-1"};return a.fail({errorMessage:m.errorCode,endPointId:n||(null===(i=this.transportDependencyProviderService.getPairedAndActiveEndpoint(c))||void 0===i?void 0:i.endPointId),message:m.errorDetails}),this.logger.error(m.errorDetails),(p=this.$q.defer()).reject(m),p}var d;if(this.transportDependencyProviderService.runsInRoomRemoteControlMode?d=this.getIBTTransportEndpointForRemote(n):(d=this.getIBTTransportEndpoint(n,c,!1))&&this.isSessionEstablishedWithEndpoint(d)||(d=this.getIBTTransportEndpoint(n,c,!0)),!d){m={errorDetails:"Outgoing Command not created for "+e+". No available endpoint to send the command to for endpointId - "+n,errorCode:this.constants.transportTelemetryErrorCode.outgoingCommand.endpointNotAvailable,statusCode:400,salt:[-1],requestCauseId:"-1"};return a.fail({errorMessage:m.errorCode,endPointId:n||(null===(o=this.transportDependencyProviderService.getPairedAndActiveEndpoint(c))||void 0===o?void 0:o.endPointId),message:m.errorDetails}),this.logger.error(m.errorDetails),(p=this.$q.defer()).reject(m),p}t.targetEndpointId=d.getEndpointId();var l;if(!(l=this.isEndpointBetterTogether(d)?this.outgoingCommandFactory.createCommand(e,t,d,a):this.remoteControllerOutgoingCommandFactory.createCommand(e,t,d,a))){var m={errorDetails:"Command not created for "+e+". Not compatible or implemented",errorCode:this.constants.transportTelemetryErrorCode.outgoingCommand.invalidCommand,statusCode:400,salt:[-1],requestCauseId:"-1"};a.fail({errorMessage:m.errorCode,endPointId:t.targetEndpointId,message:m.errorDetails}),this.logger.error(m.errorDetails);var p=this.$q.defer();return p.reject(m),p}return this.activeOutgoingCommands.set(l.causeId,l),this.logger.info("Command added to the active outgoing commands. "+l.causeId+". Name - "+l.name+" Size is - "+this.activeOutgoingCommands.size+". "+this.getLogPrefixOutgoingCommand(l)),l.onCommandReadyToSend.promise.then(function(n){var i=r.createBTTOutgoingCommandListener(a);l.commandResponseListener=i;var o=t?JSON.stringify(t):"";if(!r.isSessionEstablishedWithEndpoint(l.endpoint)&&r.isEndpointBetterTogether(d)){s="[sendOutgoingCommand] session setup, command name - "+e+" with details "+o+". "+r.getLogPrefixOutgoingCommand(l);r.logger.info(s),l.endpoint.setupSession(l.causeId,e,o,i)}else{var s="[sendOutgoingCommand] command name - "+e+" with details "+o+". "+r.getLogPrefixOutgoingCommand(l);r.logger.info(s),l.endpoint.sendCommand(l.causeId,e,o,i)}setTimeout(function(){if(l.name!==teamspace.services.OutgoingCommand.CreateAndStartCall&&l.name!==teamspace.services.OutgoingCommand.DialNumber||!l.acknowledgementReceived){if(-1!==r.cleanupOutgoingCommand(l.causeId)){var t={errorDetails:"no response received for outgoing command with name - "+e+" within threshold time. acknowledgement received - "+l.acknowledgementReceived,errorCode:l.acknowledgementReceived?r.constants.transportTelemetryErrorCode.outgoingCommand.timeoutWithAck:r.constants.transportTelemetryErrorCode.outgoingCommand.timeoutWithoutAck,statusCode:400,salt:[-1],requestCauseId:l.causeId};l.onResponseReceived.reject(t),r.logger.error(t.errorDetails+". "+r.getLogPrefixOutgoingCommand(l))}}else setTimeout(function(){if(-1!==r.cleanupOutgoingCommand(l.causeId)){var t={errorDetails:"no response received for outgoing command with name - "+e+" within threshold time. acknowledgement received - "+l.acknowledgementReceived,errorCode:r.constants.transportTelemetryErrorCode.outgoingCommand.timeoutWithAck,statusCode:400,salt:[-1],requestCauseId:l.causeId};l.onResponseReceived.reject(t),r.logger.error(t.errorDetails+". "+r.getLogPrefixOutgoingCommand(l))}},2*r.outgoingCommandResponseTimeout)},r.outgoingCommandResponseTimeout)}).catch(function(e){var t={errorDetails:e,errorCode:r.constants.transportTelemetryErrorCode.outgoingCommand.operationFailed,statusCode:400,salt:[-1],requestCauseId:l.causeId};l.onResponseReceived.reject(t),r.cleanupOutgoingCommand(l.causeId)}),l.onResponseReceived},e.prototype.isSessionEstablishedWithEndpoint=function(e){return!!this.transportDependencyProviderService.getPairedAndActiveEndpoint(!1)&&!!e&&e.getEndpointState()==teamspace.services.EndpointState.Connected},e.prototype.startSession=function(e){this.logger.info("starting session with endpoint with a force discover."),this.getIBTTransportEndpoint(e,!1,!0,!0)},e.prototype.endSession=function(e){this.logger.info("ending session with endpoint without a force discover.");var t=this.getIBTTransportEndpoint(e,!1,!1);t&&(t.setSessionEstablished(!1),this.ackFailureCount=0,this.ackSuccessCount=0)},e.prototype.getStates=function(){return this.states.set(i.ActiveOutgoingCommandsCount,this.activeOutgoingCommands.size),this.states.set(i.ActiveIncomingCommandsCount,this.activeIncomingCommands.size),this.states.set(i.AckFailedCountInSession,this.ackFailureCount),this.states.set(i.AckSuccessCountInSession,this.ackSuccessCount),this.states},e.prototype.setupInitialStates=function(){this.states=new Map,this.states.set(i.InitState,teamspace.services.ITransportComponentState.Uninitialized)},e.prototype.onResponseReceivedForOutgoingCommand=function(e,t){var n=JSON.parse(e.commandDetails);if(!n.requestCauseId)return this.logger.error("Request cause id not found with the response. "+this.getLogPrefixIncomingRequest(e)),void t.fail({endPointId:e.endpointId,requestId:e.causeId,errorMessage:this.constants.transportTelemetryErrorCode.outgoingCommand.response.nullRequestId,message:"causeIdForOutgoingCommand - "+n.requestCauseId});var i=this.activeOutgoingCommands.get(n.requestCauseId);if(!i)return this.logger.error("No outgoing command found with the requestCauseId "+n.requestCauseId+" or response not required. "+this.getLogPrefixIncomingRequest(e)),void t.fail({endPointId:e.endpointId,requestId:e.causeId,errorMessage:this.constants.transportTelemetryErrorCode.outgoingCommand.response.noOutgoingCommand,message:"causeIdForOutgoingCommand - "+n.requestCauseId});200!==n.statusCode?(this.logger.error("response is not OK for command name - "+i.name+", status code- "+n.statusCode+" and error details - "+n.errorDetails+". "+this.getLogPrefixIncomingRequest(e)),i.onResponseReceived.reject(n)):(this.logger.info("response resolved for outgoing command name - "+i.name+". "+this.getLogPrefixIncomingRequest(e)),i.onResponseReceived.resolve(n));var o=this.cleanupOutgoingCommand(n.requestCauseId);t.stop({endPointId:e.endpointId,requestId:e.causeId,delta:o,message:"Round_Trip_Time"})},e.prototype.cleanupOutgoingCommand=function(e){var t=this.activeOutgoingCommands.get(e);if(t){t.commandResponseListener&&t.commandResponseListener.dispose(),this.logger.info("Command with causeid - "+e+" cleaned up. Name - "+t.name+" Size is - "+this.activeOutgoingCommands.size+". "+this.getLogPrefixOutgoingCommand(t));var n=t.startTime;if(this.activeOutgoingCommands.delete(e),t=void 0,n)return(new Date).getTime()-n.getTime()}return-1},e.prototype.createBTTOutgoingCommandListener=function(e){var t=this,n=this.transportStack.createOutgoingCommandResponse();return n.on("request-succeeded",function(n){var i=n.causeId,o=n.responseBody;t.ackSuccessCount++,t.logger.info("Received transport response for "+i+".");var r=t.activeOutgoingCommands.get(i);if(r){r.acknowledgementReceived=!0;var s=o?JSON.parse(o):void 0;if(r.commandDetails.companionResponseRequired)t.logger.info("Command acknowledged by companion device,command name - "+r.name+", requires response from device. "+t.getLogPrefixOutgoingCommand(r));else{r.onResponseReceived.resolve(s);var a=t.cleanupOutgoingCommand(i);t.logger.info("Outgoing command does not need response,command name - "+r.name+" time taken is "+a+". "+t.getLogPrefixOutgoingCommand(r))}}else t.logger.error("No valid outgoing command in request-succeeded. causeId - "+(n.causeId?n.causeId:"causeID not present"));e.stop({causeId:i||"CauseId not present",reason:"TROUTER_AVAILABILITY"})}),n.on("request-failed",function(n){var i=n.causeId,o=n.errorCode,r=n.errorDetails;t.ackFailureCount++,t.logger.info("Received transport response for "+i+". errorCode - "+o);var s=t.activeOutgoingCommands.get(i);if(s){if(!s.isRetry){var a=s.startTime,c=0;a&&(c=(new Date).getTime()-a.getTime());var d="received error response for outgoing command name - "+s.name+", causeId "+i+", errorCode - "+o+", time taken is "+c;t.logger.error(d+". "+t.getLogPrefixOutgoingCommand(s));var l=JSON.stringify(s.commandDetails);s.isRetry=!0;var m=s.endpoint.getEndpointId(),p=void 0;p=t.transportDependencyProviderService.runsInRoomRemoteControlMode?t.getIBTTransportEndpointForRemote(m):t.getIBTTransportEndpoint(m,t.transportDependencyProviderService.isCallingRelatedCommand(s.name),!0),s.endpoint=p;var g=t.utilityService.generateUUID();return s.causeId=g,t.activeOutgoingCommands.delete(i),t.activeOutgoingCommands.set(g,s),s.commandResponseListener&&s.commandResponseListener.dispose(),s.commandResponseListener=t.createBTTOutgoingCommandListener(e),t.logger.error("First attempt for command failed. Retry-ing command "+s.name+", causeId "+i+" with new causeid "+g+". "+t.getLogPrefixOutgoingCommand(s)),p.setupSession(s.causeId,s.name,l,s.commandResponseListener),void e.fail({errorCode:o,errorMessage:d,causeId:i||"CauseId not present",reason:"TROUTER_AVAILABILITY"})}s.acknowledgementReceived=!0;var h=r?JSON.parse(r):"";(r=h.phrase||""+h.subCode||"")||(r="errorCode is "+o);var u={requestCauseId:i,statusCode:o,errorDetails:r,errorCode:o.toString(),salt:[-1]};s.onResponseReceived.reject(u);var v="Failed on second attempt. causeId "+i+", errorDetails - "+r+", errorCode - "+o+", time taken is "+t.cleanupOutgoingCommand(i);t.logger.error(v+". "+t.getLogPrefixOutgoingCommand(s))}else t.logger.error("No valid outgoing command in request-failed. causeId - "+(n.causeId?n.causeId:"causeID not present"));e.fail({errorCode:o,errorMessage:r,causeId:i||"CauseId not present",reason:"TROUTER_AVAILABILITY"})}),n},e.prototype.getIBTTransportEndpoint=function(e,t,n,i){if(void 0===n&&(n=!1),void 0===i&&(i=!1),!e){if(this.logger.info("endpoint id is not given, trying to get it from pairedAndActive Endpoint"),!(r=this.transportDependencyProviderService.getPairedAndActiveEndpoint(t)))return this.logger.error("There is no active paired device to send the command."),null;e=r.endPointId}this.logger.info("trying to get endpoint from transport user for endpointid - "+e);var o;if(n){o=this.transportUser.discover().find(function(t){return t.getEndpointId()===e}),this.logger.info("endpoints retrieved using discover(). "+!!o);var r=this.transportDependencyProviderService.getPairedAndActiveEndpoint(t);o&&(r&&r.endPointId==e||i)&&o.setSessionEstablished(!0)}else o=this.transportUser.getEndpoints().find(function(t){return t.getEndpointId()===e}),this.logger.info("endpoints retrieved using getEndpoints(). "+!!o);return o},e.prototype.getIBTTransportEndpointForRemote=function(e){return this.transportDependencyProviderService.getRemoteControllerConnectionHandler().getConnectedEndpoints().find(function(t){return t.getEndpointId()===e})},e.prototype.isEndpointBetterTogether=function(e){return e.getEndpointType()===teamspace.services.EndpointType.BetterTogether},e.prototype.getNameForIncomingCommand=function(e){switch(e){case teamspace.services.IncomingCommand.Response:return this.constants.scenarios.betterTogether.incomingCommand.response;case teamspace.services.IncomingCommand.Broadcast:return this.constants.scenarios.betterTogether.incomingCommand.broadcast;case teamspace.services.IncomingCommand.Pair:return this.constants.scenarios.betterTogether.incomingCommand.pair;case teamspace.services.IncomingCommand.Unpair:return this.constants.scenarios.betterTogether.incomingCommand.unpair;case teamspace.services.IncomingCommand.Autopair:return this.constants.scenarios.betterTogether.incomingCommand.autoPair;case teamspace.services.IncomingCommand.Locked:return this.constants.scenarios.betterTogether.incomingCommand.incomingLock;case teamspace.services.IncomingCommand.Unlocked:return this.constants.scenarios.betterTogether.incomingCommand.incomingUnlock;case teamspace.services.IncomingCommand.ReplyOnDesktop:return this.constants.scenarios.betterTogether.incomingCommand.replyFromDesktop;case teamspace.services.IncomingCommand.OpenFileOnDesktop:return this.constants.scenarios.betterTogether.incomingCommand.openFile;case teamspace.services.IncomingCommand.UpdateEndpoint:return this.constants.scenarios.betterTogether.incomingCommand.updateEndpoint;case teamspace.services.IncomingCommand.OpenShare:return this.constants.scenarios.betterTogether.incomingCommand.openShare;case teamspace.services.IncomingCommand.StartCall:return this.constants.scenarios.betterTogether.incomingCommand.startcall;case teamspace.services.IncomingCommand.EndCall:return this.constants.scenarios.betterTogether.incomingCommand.endcall;case teamspace.services.IncomingCommand.Mute:return this.constants.scenarios.betterTogether.incomingCommand.mute;case teamspace.services.IncomingCommand.Unmute:return this.constants.scenarios.betterTogether.incomingCommand.unmute;case teamspace.services.IncomingCommand.StartVideo:return this.constants.scenarios.betterTogether.incomingCommand.startvideo;case teamspace.services.IncomingCommand.StopVideo:return this.constants.scenarios.betterTogether.incomingCommand.stopvideo;case teamspace.services.IncomingCommand.StartAudio:return this.constants.scenarios.betterTogether.incomingCommand.startaudio;case teamspace.services.IncomingCommand.StopAudio:return this.constants.scenarios.betterTogether.incomingCommand.stopaudio;case teamspace.services.IncomingCommand.HoldCall:return this.constants.scenarios.betterTogether.incomingCommand.holdcall;case teamspace.services.IncomingCommand.UnholdCall:return this.constants.scenarios.betterTogether.incomingCommand.unholdcall;case teamspace.services.IncomingCommand.ReportProblem:return this.constants.scenarios.betterTogether.incomingCommand.reportProblem;case teamspace.services.IncomingCommand.CameraOn:return this.constants.scenarios.betterTogether.incomingCommand.cameraOn;case teamspace.services.IncomingCommand.CameraOff:return this.constants.scenarios.betterTogether.incomingCommand.cameraOff;case teamspace.services.IncomingCommand.VolumeUp:return this.constants.scenarios.betterTogether.incomingCommand.volumeUp;case teamspace.services.IncomingCommand.VolumeDown:return this.constants.scenarios.betterTogether.incomingCommand.volumeDown;case teamspace.services.IncomingCommand.CaptionsOff:return this.constants.scenarios.betterTogether.incomingCommand.captionsOff;case teamspace.services.IncomingCommand.CaptionsOn:return this.constants.scenarios.betterTogether.incomingCommand.captionsOn;case teamspace.services.IncomingCommand.ShowVideoGallery:return this.constants.scenarios.betterTogether.incomingCommand.showVideoGallery;case teamspace.services.IncomingCommand.ShowContent:return this.constants.scenarios.betterTogether.incomingCommand.showContent;case teamspace.services.IncomingCommand.ShowVideoGalleryAndContent:return this.constants.scenarios.betterTogether.incomingCommand.showVideoGalleryAndContent;case teamspace.services.IncomingCommand.ShowLargeGallery:return this.constants.scenarios.betterTogether.incomingCommand.showLargeGallery;case teamspace.services.IncomingCommand.ShowTogether:return this.constants.scenarios.betterTogether.incomingCommand.showTogether;case teamspace.services.IncomingCommand.LeaveMeeting:return this.constants.scenarios.betterTogether.incomingCommand.leaveMeeting;default:return this.constants.scenarios.betterTogether.incomingCommand.invalidCommand}},e.prototype.getNameForOutgoingCommand=function(e){switch(e){case teamspace.services.OutgoingCommand.Response:return this.constants.scenarios.betterTogether.outgoingCommand.response;case teamspace.services.OutgoingCommand.KeepAlive:return this.constants.scenarios.betterTogether.outgoingCommand.keepAlive;case teamspace.services.OutgoingCommand.Unpair:return this.constants.scenarios.betterTogether.outgoingCommand.unpair;case teamspace.services.OutgoingCommand.Lock:return this.constants.scenarios.betterTogether.outgoingCommand.outgoingLock;case teamspace.services.OutgoingCommand.Unlock:return this.constants.scenarios.betterTogether.outgoingCommand.outgoingUnlock;case teamspace.services.OutgoingCommand.JoinCall:return this.constants.scenarios.betterTogether.outgoingCommand.joincall;case teamspace.services.OutgoingCommand.StartCall:return this.constants.scenarios.betterTogether.outgoingCommand.startcall;case teamspace.services.OutgoingCommand.CreateAndStartCall:return this.constants.scenarios.betterTogether.outgoingCommand.createandstartcall;case teamspace.services.OutgoingCommand.DialNumber:return this.constants.scenarios.betterTogether.outgoingCommand.dialNumber;case teamspace.services.OutgoingCommand.EndCall:return this.constants.scenarios.betterTogether.outgoingCommand.endcall;case teamspace.services.OutgoingCommand.Mute:return this.constants.scenarios.betterTogether.outgoingCommand.mute;case teamspace.services.OutgoingCommand.Unmute:return this.constants.scenarios.betterTogether.outgoingCommand.unmute;case teamspace.services.OutgoingCommand.StartVideo:return this.constants.scenarios.betterTogether.outgoingCommand.startvideo;case teamspace.services.OutgoingCommand.StopVideo:return this.constants.scenarios.betterTogether.outgoingCommand.stopvideo;case teamspace.services.OutgoingCommand.StartAudio:return this.constants.scenarios.betterTogether.outgoingCommand.startaudio;case teamspace.services.OutgoingCommand.StopAudio:return this.constants.scenarios.betterTogether.outgoingCommand.stopaudio;case teamspace.services.OutgoingCommand.StartVideo:return this.constants.scenarios.betterTogether.outgoingCommand.startvideo;case teamspace.services.OutgoingCommand.StopVideo:return this.constants.scenarios.betterTogether.outgoingCommand.stopvideo;case teamspace.services.OutgoingCommand.StartAudio:return this.constants.scenarios.betterTogether.outgoingCommand.startaudio;case teamspace.services.OutgoingCommand.StopAudio:return this.constants.scenarios.betterTogether.outgoingCommand.stopaudio;case teamspace.services.OutgoingCommand.HoldCall:return this.constants.scenarios.betterTogether.outgoingCommand.holdcall;case teamspace.services.OutgoingCommand.UnholdCall:return this.constants.scenarios.betterTogether.outgoingCommand.unholdcall;case teamspace.services.OutgoingCommand.ReportProblem:return this.constants.scenarios.betterTogether.outgoingCommand.reportProblem;case teamspace.services.OutgoingCommand.UpdateState:return this.constants.scenarios.betterTogether.outgoingCommand.updateState;case teamspace.services.OutgoingCommand.UpdateCapabilities:return this.constants.scenarios.betterTogether.outgoingCommand.updateCapabilities;default:return this.constants.scenarios.betterTogether.outgoingCommand.invalidCommand}},e}();t.TransportCommandRouter=c},2734:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(2735),o=n(2736),r=n(2737),s=n(2738),a=n(2739),c=n(2740),d=n(2741),l=n(2742),m=n(2743),p=n(2744),g=n(2745),h=n(2746),u=function(){function e(e,t,n,i,o,r,s,a,c,d,l,m,p,g,h,u,v,C,f,S){this.transportDependencyProviderService=e,this.constants=t,this.loggingService=n,this.appStateService=i,this.$q=o,this.settingsService=r,this.$translate=s,this.utilityService=a,this.resources=c,this.callingService=d,this.$injector=l,this.dialingService=m,this.$timeout=p,this.dialogService=g,this.deepLinkService=h,this.eventingService=u,this.$rootScope=v,this.channelService=C,this.multiWindowService=f,this.callingNavigationService=S,this.logger=n.newLogger("IncomingCommandFactory")}return e.prototype.createCommand=function(e,t){var n=e.command.toLowerCase(),u=JSON.parse(e.commandDetails),v=e.endpointId,C=e.causeId,f=this.shouldCreateCommand(n,u,v,C,t);if(!f.result)return f;switch(n){case teamspace.services.IncomingCommand.Broadcast:return new i.BroadcastCommand(u,v,C,this.transportDependencyProviderService,t,this.$q,this.$translate,this.utilityService,this.constants,this.resources);case teamspace.services.IncomingCommand.Pair:return new o.CompanionPairCommand(u,v,C,this.transportDependencyProviderService,t,this.$q,this.$translate,this.resources,this.dialogService,this.constants,this.$timeout);case teamspace.services.IncomingCommand.Unpair:return new r.UnpairCommand(u,v,C,this.transportDependencyProviderService,t,this.constants,this.$q);case teamspace.services.IncomingCommand.Autopair:return new s.AutopairCommand(u,v,C,this.transportDependencyProviderService,t,this.$q,this.settingsService,this.constants);case teamspace.services.IncomingCommand.Locked:return new a.LockedCommand(u,v,C,this.transportDependencyProviderService,t,this.$q,this.constants);case teamspace.services.IncomingCommand.Unlocked:return new c.UnlockedCommand(u,v,C,this.transportDependencyProviderService,t,this.$q,this.constants);case teamspace.services.IncomingCommand.ReplyOnDesktop:return new d.ReplyFromDesktopCommand(u,this.transportDependencyProviderService,t,this.$q,this.constants,this.channelService,this.multiWindowService,this.callingNavigationService);case teamspace.services.IncomingCommand.OpenFileOnDesktop:return new l.OpenFileCommand(u,this.transportDependencyProviderService,t,this.$q,this.constants,this.deepLinkService,this.loggingService);case teamspace.services.IncomingCommand.UpdateEndpoint:return new m.UpdateEndpointCommand(u,v,C,this.transportDependencyProviderService,t,this.settingsService,this.$q,this.constants);case teamspace.services.IncomingCommand.OpenShare:return new p.OpenShareCommand(u,this.transportDependencyProviderService,t,this.$q,this.constants,this.callingService,this.eventingService,this.$rootScope);case teamspace.services.IncomingCommand.StartCall:return new g.StartCallCommand(u,this.transportDependencyProviderService,t,this.loggingService,this.$q,this.callingService,this.constants,this.dialingService);case teamspace.services.IncomingCommand.EndCall:return new g.EndCallCommand(u,this.transportDependencyProviderService,t,this.$q,this.callingService,this.constants,this.loggingService,this.$injector);case teamspace.services.IncomingCommand.StartAudio:case teamspace.services.IncomingCommand.StopAudio:case teamspace.services.IncomingCommand.Mute:case teamspace.services.IncomingCommand.Unmute:case teamspace.services.IncomingCommand.StartVideo:case teamspace.services.IncomingCommand.StopVideo:case teamspace.services.IncomingCommand.HoldCall:case teamspace.services.IncomingCommand.UnholdCall:return new g.BaseCallToggleStateCommand(u,this.transportDependencyProviderService,n,t,this.$q,this.callingService,this.constants,this.loggingService,this.$timeout);case teamspace.services.IncomingCommand.ReportProblem:return new h.ReportProblemIncomingCommand(u,this.transportDependencyProviderService,t,this.constants,this.loggingService,this.settingsService,this.$q);default:return t.fail({errorMessage:"errorCode - "+this.constants.transportTelemetryErrorCode.incomingCommand.invalidCommand,endPointId:v,requestId:C,message:"commandName - "+n}),{result:!1,errorCode:this.constants.transportTelemetryErrorCode.incomingCommand.invalidCommand}}},e.prototype.shouldCreateCommand=function(e,t,n,i,o){var r=this.transportDependencyProviderService.getTransportConnectionHandler().getAllPairedDevices();if(!(e===teamspace.services.IncomingCommand.Broadcast||e===teamspace.services.IncomingCommand.Pair||e===teamspace.services.IncomingCommand.Autopair||e===teamspace.services.IncomingCommand.ReportProblem||!!r&&r.find(function(e){return e.endPointId===n}))){c={result:!1,errorCode:this.constants.transportTelemetryErrorCode.incomingCommand.deviceNotPaired};return this.logger.error(c.errorCode),o.fail({errorMessage:"errorCode - "+c.errorCode,endPointId:n,requestId:i}),c}if(!(e===teamspace.services.IncomingCommand.Broadcast||e===teamspace.services.IncomingCommand.Pair||e===teamspace.services.IncomingCommand.Unpair||e===teamspace.services.IncomingCommand.ReportProblem||this.transportDependencyProviderService.getTransportConnectionHandler().verifySalt(t))){c={result:!1,errorCode:this.constants.transportTelemetryErrorCode.incomingCommand.invalidSalt};return this.logger.error(c.errorCode),o.fail({errorMessage:"errorCode - "+c.errorCode,endPointId:n,requestId:i}),c}var s=!!this.transportDependencyProviderService.getPairedAndActiveEndpoint(!1);if(e===teamspace.services.IncomingCommand.Broadcast||e===teamspace.services.IncomingCommand.Autopair||e===teamspace.services.IncomingCommand.Pair||e===teamspace.services.IncomingCommand.Unpair||e===teamspace.services.IncomingCommand.Locked||e===teamspace.services.IncomingCommand.Unlocked||e===teamspace.services.IncomingCommand.UpdateEndpoint||e===teamspace.services.IncomingCommand.ReportProblem||s||this.transportDependencyProviderService.isCallingRelatedCommand(e)){var a=this.meetingsAllowed(e,t);return a.result||o.fail({errorMessage:"errorCode - "+a.errorCode+"; errorMsg - "+a.message,endPointId:n,requestId:i}),a}var c={result:!1,errorCode:this.constants.transportTelemetryErrorCode.incomingCommand.pairedButNotConnected},d="Cannot execute command with name - "+e;return this.logger.error(d),o.fail({errorMessage:"errorCode - "+c.errorCode,endPointId:n,requestId:i}),c},e.prototype.meetingsAllowed=function(e,t){var n,i=this.transportDependencyProviderService.isCallingRelatedCommand(e),o=t;return e===teamspace.services.IncomingCommand.StartCall&&this.appStateService.machineState==teamspace.services.MachineState.MachineLocked?(this.logger.error("start call command received, but machine is in locked state - ignore command"),n={result:!1,message:"Incoming StartCall ignored. Machine locked",errorCode:this.constants.transportTelemetryErrorCode.incomingCommand.calling.machinestateislocked}):(i?o.conversationId||o.pstnMri?n=this.transportDependencyProviderService.isConnectedToTransportEndpointForConversation({conversationId:o.conversationId,pstnMri:o.pstnMri}):(n={result:!1,message:"conversationId is null, command name - "+e,errorCode:this.constants.transportTelemetryErrorCode.incomingCommand.calling.conversationIdIsEmpty},this.logger.error("errorCode - "+n.errorCode+", errorDetails - "+n.message)):n={result:!0,message:""},n)},e}();t.IncomingCommandFactory=u},2735:function(e,t,n){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++){t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t,n,i,o,r,s,a,c,d){this.commandDetails=e,this.endpointId=t,this.requestCauseId=n,this.transportDependencyProviderService=i,this.incomingCommandReceivedScenario=o,this.$q=r,this.$translate=s,this.utilityService=a,this.constants=c,this.resources=d,this.commandDetails=e}return e.prototype.action=function(){var e=this;this.responseDeferred=this.$q.defer();var t=this.transportDependencyProviderService.getTransportConnectionHandler();return t.checkProximity(this.endpointId,this.commandDetails.endpointSignature).promise.then(function(n){if(n){var o=e.utilityService.getDesktopEnvironmentHostName()||e.$translate.instant(e.resources.strings.meeting_unknown_status_text),r=i({deviceName:o},t.getResponseDetails());e.incomingCommandReceivedScenario.stop({endPointId:e.endpointId,requestId:e.requestCauseId,message:"clientType - "+e.commandDetails.clientType+"; clientVersion - "+e.commandDetails.clientVersion}),e.responseDeferred.resolve(r)}else{r=i({errorCode:e.constants.transportTelemetryErrorCode.incomingCommand.broadcast.notInProximity},t.getResponseDetails());e.incomingCommandReceivedScenario.fail({errorMessage:r.errorCode,endPointId:e.endpointId,requestId:e.requestCauseId,message:"clientType - "+e.commandDetails.clientType+"; clientVersion - "+e.commandDetails.clientVersion}),e.responseDeferred.reject(r)}}).catch(function(n){var o=i({errorCode:e.constants.transportTelemetryErrorCode.incomingCommand.broadcast.errorInCheckingProximity,errorDetails:n},t.getResponseDetails());e.incomingCommandReceivedScenario.fail({errorMessage:o.errorCode,endPointId:e.endpointId,requestId:e.requestCauseId,message:"errorMsg - "+o.errorDetails+"; clientType - "+e.commandDetails.clientType+"; clientVersion - "+e.commandDetails.clientVersion}),e.responseDeferred.reject(o)}),this.responseDeferred},e}();t.BroadcastCommand=o},2736:function(e,t,n){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++){t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});!function(e){e.RejectedByUser="REJECTED_BY_USER",e.AcceptedByUser="ACCEPTED_BY_USER",e.RejectedByTimeout="REJECTED_BY_TIMEOUT"}(t.DialogResponse||(t.DialogResponse={}));var o=function(){function e(e,t,n,i,o,r,s,a,c,d,l){this.commandDetails=e,this.endpointId=t,this.requestCauseId=n,this.transportDependencyProviderService=i,this.incomingCommandReceivedScenario=o,this.$q=r,this.$translate=s,this.resources=a,this.dialogService=c,this.constants=d,this.$timeout=l}return e.prototype.action=function(){var e=this;this.responseDeferred=this.$q.defer();var t=this.transportDependencyProviderService.getTransportConnectionHandler(),n=this.$q.defer();return t.verifySalt(this.commandDetails)?n.resolve(!0):n=t.checkProximity(this.endpointId,this.commandDetails.endpointSignature),n.promise.then(function(n){if(n){var o="REJECTED_BY_USER",r={okButtonText:e.$translate.instant(e.resources.strings.better_together_pair_button),closeButtonText:e.$translate.instant(e.resources.strings.better_together_cancel_button),confirmMessageTitle:e.$translate.instant(e.resources.strings.better_together_pair_title),confirmMessageHtmlBody:e.$translate.instant(e.resources.strings.better_together_pair_message,{deviceName:e.commandDetails.deviceName}),callback:function(){o="ACCEPTED_BY_USER",e.onUserResponse(o)},preCloseCallback:function(t){"ACCEPTED_BY_USER"!=t&&("REJECTED_BY_TIMEOUT"==t?e.onUserResponse(t):e.onUserResponse("REJECTED_BY_USER"))}},s=e.dialogService.open(e.constants.dialogs.confirmDialog,r);e.$timeout(function(){s.close("REJECTED_BY_TIMEOUT")},5e4,!1)}else{var a=i({errorCode:e.constants.transportTelemetryErrorCode.incomingCommand.pair.notInProximity},t.getResponseDetails());e.incomingCommandReceivedScenario.fail({errorMessage:a.errorCode,endPointId:e.endpointId,requestId:e.requestCauseId,message:"clientType - "+e.commandDetails.clientType+"; clientVersion - "+e.commandDetails.clientVersion}),e.responseDeferred.reject(a)}}).catch(function(n){var o=i({errorCode:e.constants.transportTelemetryErrorCode.incomingCommand.pair.errorInCheckingProximity,errorDetails:n},t.getResponseDetails());e.incomingCommandReceivedScenario.fail({errorMessage:o.errorCode,endPointId:e.endpointId,requestId:e.requestCauseId,message:"errorMsg - "+o.errorDetails+"; clientType - "+e.commandDetails.clientType+"; clientVersion - "+e.commandDetails.clientVersion}),e.responseDeferred.reject(o)}),this.responseDeferred},e.prototype.onUserResponse=function(e,t){var n=this.transportDependencyProviderService.getTransportConnectionHandler(),o=i({accepted:"ACCEPTED_BY_USER"==e},n.getResponseDetails());if("ACCEPTED_BY_USER"==e){var r={endPointId:this.endpointId,deviceName:this.commandDetails.deviceName,connectionStatus:teamspace.services.PairedConnectionStatus.Connected,clientType:this.commandDetails.clientType,clientVersion:this.commandDetails.clientVersion,endpointSignature:this.commandDetails.endpointSignature};this.incomingCommandReceivedScenario.stop({endPointId:this.endpointId,requestId:this.requestCauseId,message:"message - "+e+"; clientType - "+this.commandDetails.clientType+"; clientVersion - "+this.commandDetails.clientVersion}),n.onNewDevicePaired(r),this.responseDeferred.resolve(o)}else o.accepted=!1,o.errorCode=e,this.incomingCommandReceivedScenario.stop({endPointId:this.endpointId,requestId:this.requestCauseId,message:"message - "+e+"; clientType - "+this.commandDetails.clientType+"; clientVersion - "+this.commandDetails.clientVersion}),this.responseDeferred.reject(o)},e}();t.CompanionPairCommand=o},2737:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,n,i,o,r,s){this.commandDetails=e,this.endPointId=t,this.requestCauseId=n,this.transportDependencyProviderService=i,this.incomingCommandReceivedScenario=o,this.constants=r,this.$q=s}return e.prototype.action=function(){this.responseDeferred=this.$q.defer();var e=this.transportDependencyProviderService.getTransportConnectionHandler(),t=e.getResponseDetails();return e.onDeviceUnpaired(this.endPointId)?(this.incomingCommandReceivedScenario.stop({endPointId:this.endPointId,requestId:this.requestCauseId}),this.responseDeferred.resolve(t)):(t.errorCode=this.constants.transportTelemetryErrorCode.incomingCommand.deviceNotPaired,this.incomingCommandReceivedScenario.fail({errorMessage:t.errorCode,endPointId:this.endPointId,requestId:this.requestCauseId}),this.responseDeferred.reject(t)),this.responseDeferred},e}();t.UnpairCommand=i},2738:function(e,t,n){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++){t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t,n,i,o,r,s,a){this.commandDetails=e,this.endpointId=t,this.requestCauseId=n,this.transportDependencyProviderService=i,this.incomingCommandReceivedScenario=o,this.$q=r,this.settingsService=s,this.constants=a,this.commandDetails=e}return e.prototype.action=function(){var e=this;this.responseDeferred=this.$q.defer();var t=this.transportDependencyProviderService.getTransportConnectionHandler();if(!!this.settingsService.valueAsBoolean(this.constants.settings.names.enableBetterTogetherEndpointSignature)){var n={endPointId:this.endpointId};if(this.commandDetails.endpointSignature){var o={deviceName:this.commandDetails.deviceName,clientType:this.commandDetails.clientType,clientVersion:this.commandDetails.clientVersion,endpointSignature:this.commandDetails.endpointSignature};n=i(i({},n),o)}t.onUpdateEndpoint(this.endpointId,n)}return t.checkProximity(this.endpointId,this.commandDetails.endpointSignature).promise.then(function(n){if(n){var o=t.reconnect(e.endpointId,!1);if(o.result)e.incomingCommandReceivedScenario.stop({endPointId:e.endpointId,requestId:e.requestCauseId,message:"clientType - "+e.commandDetails.clientType+"; clientVersion - "+e.commandDetails.clientVersion}),e.responseDeferred.resolve(t.getResponseDetails());else{r=i({errorCode:o.errorCode},t.getResponseDetails());e.incomingCommandReceivedScenario.fail({errorMessage:r.errorCode,message:"clientType - "+e.commandDetails.clientType+"; clientVersion - "+e.commandDetails.clientVersion,endPointId:e.endpointId,requestId:e.requestCauseId}),e.responseDeferred.reject(r)}}else{var r=i({errorCode:e.constants.transportTelemetryErrorCode.incomingCommand.autoPair.notInProximity},t.getResponseDetails());e.incomingCommandReceivedScenario.fail({errorMessage:r.errorCode,message:"clientType - "+e.commandDetails.clientType+"; clientVersion - "+e.commandDetails.clientVersion,endPointId:e.endpointId,requestId:e.requestCauseId}),e.responseDeferred.reject(r)}}).catch(function(n){var o=i({errorCode:e.constants.transportTelemetryErrorCode.incomingCommand.autoPair.errorInCheckingProximity,errorDetails:n},t.getResponseDetails());e.incomingCommandReceivedScenario.fail({errorMessage:o.errorCode,endPointId:e.endpointId,requestId:e.requestCauseId,message:"errorMsg - "+o.errorDetails+"; clientType - "+e.commandDetails.clientType+"; clientVersion - "+e.commandDetails.clientVersion}),e.responseDeferred.reject(o)}),this.responseDeferred},e}();t.AutopairCommand=o},2739:function(e,t,n){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++){t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t,n,i,o,r,s){this.commandDetails=e,this.endPointId=t,this.requestCauseId=n,this.transportDependencyProviderService=i,this.incomingCommandReceivedScenario=o,this.$q=r,this.constants=s}return e.prototype.action=function(){this.responseDeferred=this.$q.defer();var e=this.transportDependencyProviderService.getTransportConnectionHandler(),t=e.getResponseDetails();return e.onDeviceLocked(this.endPointId)?(this.incomingCommandReceivedScenario.stop({endPointId:this.endPointId,requestId:this.requestCauseId}),this.responseDeferred.resolve(t)):(t=i({errorCode:this.constants.transportTelemetryErrorCode.incomingCommand.deviceNotPaired},t),this.incomingCommandReceivedScenario.fail({errorMessage:t.errorCode,endPointId:this.endPointId,requestId:this.requestCauseId}),this.responseDeferred.reject(t)),this.responseDeferred},e}();t.LockedCommand=o},2740:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,n,i,o,r,s){this.commandDetails=e,this.endPointId=t,this.requestCauseId=n,this.transportDependencyProviderService=i,this.incomingCommandReceivedScenario=o,this.$q=r,this.constants=s}return e.prototype.action=function(){this.responseDeferred=this.$q.defer();var e=this.transportDependencyProviderService.getTransportConnectionHandler(),t=e.getResponseDetails();return e.onDeviceUnlocked(this.endPointId)?(this.incomingCommandReceivedScenario.stop({endPointId:this.endPointId,requestId:this.requestCauseId}),this.responseDeferred.resolve(t)):(t.errorCode=this.constants.transportTelemetryErrorCode.incomingCommand.deviceNotPaired,this.incomingCommandReceivedScenario.fail({errorMessage:t.errorCode,endPointId:this.endPointId,requestId:this.requestCauseId}),this.responseDeferred.reject(t)),this.responseDeferred},e}();t.UnlockedCommand=i},2741:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,n,i,o,r,s,a){this.commandDetails=e,this.transportDependencyProviderService=t,this.incomingCommandReceivedScenario=n,this.$q=i,this.constants=o,this.channelService=r,this.multiWindowService=s,this.callingNavigationService=a}return e.prototype.action=function(){var e=this;this.responseDeferred=this.$q.defer();var t=this.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails();if(this.commandDetails.conversationId){var n=this.channelService.getChannelByObjectId(this.commandDetails.conversationId);this.multiWindowService.enabled&&!n?this.multiWindowService.openWindow(new teamspace.services.ChatChildWindowParams(this.commandDetails.conversationId),"ReplyFromDesktopCommand").then(function(n){e.incomingCommandReceivedScenario.stop({message:"multi_window"}),e.responseDeferred.resolve(t)}).catch(function(n){t.errorCode=e.constants.transportTelemetryErrorCode.incomingCommand.replyFromDesktop.multiwindowError,t.errorDetails="error in opening new window with details - "+n,e.incomingCommandReceivedScenario.fail({message:t.errorCode,message1:t.errorDetails}),e.responseDeferred.reject(t)}):("0"==this.commandDetails.rootMessageId.toString()?this.callingNavigationService.navigateToConversation(this.commandDetails.conversationId):this.callingNavigationService.navigateToConversation(this.commandDetails.conversationId,this.commandDetails.rootMessageId.toString())).then(function(n){e.incomingCommandReceivedScenario.stop({message:"angular_window"}),e.responseDeferred.resolve(t)}).catch(function(n){t.errorCode=e.constants.transportTelemetryErrorCode.incomingCommand.replyFromDesktop.windowError,t.errorDetails="error in navigating to conversation with details - "+n,e.incomingCommandReceivedScenario.fail({message:t.errorCode,message1:t.errorDetails}),e.responseDeferred.reject(t)})}else t.errorCode=this.constants.transportTelemetryErrorCode.incomingCommand.replyFromDesktop.conversationIdIsEmpty,this.incomingCommandReceivedScenario.stop({message:t.errorCode}),this.responseDeferred.reject(t);return this.responseDeferred},e}();t.ReplyFromDesktopCommand=i},2742:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,n,i,o,r,s){this.commandDetails=e,this.transportDependencyProviderService=t,this.incomingCommandReceivedScenario=n,this.$q=i,this.constants=o,this.deepLinkService=r,this.logger=s.newLogger("TransportOpenFileCommand")}return e.prototype.action=function(){var e=this;this.responseDeferred=this.$q.defer();var t=this.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails();return this.commandDetails.objectUrl&&this.commandDetails.fileId?this.deepLinkService.resolveFileDeepLink(this.commandDetails).then(function(){e.incomingCommandReceivedScenario.stop(),e.responseDeferred.resolve(t)}).catch(function(n){t.errorCode=e.constants.transportTelemetryErrorCode.incomingCommand.openFile.deeplinkServiceError,e.incomingCommandReceivedScenario.fail({message:t.errorCode}),e.logger.error(t.errorCode+", error - "+n),e.responseDeferred.reject(t)}):(t.errorDetails="ObjectUrl is empty - "+!this.commandDetails.objectUrl+" or fileId is empty - "+!this.commandDetails.fileId,t.errorCode=this.constants.transportTelemetryErrorCode.incomingCommand.openFile.urlIsEmpty,this.incomingCommandReceivedScenario.fail({message:t.errorCode,message1:t.errorDetails}),this.responseDeferred.reject(t)),this.responseDeferred},e}();t.OpenFileCommand=i},2743:function(e,t,n){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++){t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t,n,i,o,r,s,a){this.commandDetails=e,this.requestCauseId=n,this.transportDependencyProviderService=i,this.incomingCommandReceivedScenario=o,this.settingsService=r,this.$q=s,this.constants=a}return e.prototype.action=function(){var e,t,n,o;this.responseDeferred=this.$q.defer();var r=this.transportDependencyProviderService.getTransportConnectionHandler(),s=r.getResponseDetails(),a=this.commandDetails.previousEndpointId,c={endPointId:this.commandDetails.newEndpointId};if(!!this.settingsService.valueAsBoolean(this.constants.settings.names.enableBetterTogetherEndpointSignature)&&this.commandDetails.newEndpointDetails){var d={deviceName:this.commandDetails.newEndpointDetails.deviceName,clientType:this.commandDetails.newEndpointDetails.clientType,clientVersion:this.commandDetails.newEndpointDetails.clientVersion,endpointSignature:this.commandDetails.newEndpointDetails.endpointSignature};c=i(i({},c),d)}return r.onUpdateEndpoint(a,c)?(this.incomingCommandReceivedScenario.stop({endPointId:this.commandDetails.previousEndpointId,requestId:this.requestCauseId,message:"clientType - "+(null===(e=this.commandDetails.newEndpointDetails)||void 0===e?void 0:e.clientType)+"; clientVersion - "+(null===(t=this.commandDetails.newEndpointDetails)||void 0===t?void 0:t.clientVersion)}),this.responseDeferred.resolve(s)):(s.errorCode=this.constants.transportTelemetryErrorCode.incomingCommand.deviceNotPaired,this.incomingCommandReceivedScenario.fail({errorMessage:s.errorCode,endPointId:this.commandDetails.previousEndpointId,requestId:this.requestCauseId,message:"newEndpointId - "+this.commandDetails.newEndpointId+"; clientType - "+(null===(n=this.commandDetails.newEndpointDetails)||void 0===n?void 0:n.clientType)+"; clientVersion - "+(null===(o=this.commandDetails.newEndpointDetails)||void 0===o?void 0:o.clientVersion)}),this.responseDeferred.reject(s)),this.responseDeferred},e}();t.UpdateEndpointCommand=o},2744:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,n,i,o,r,s,a){this.commandDetails=e,this.transportDependencyProviderService=t,this.incomingCommandReceivedScenario=n,this.$q=i,this.constants=o,this.callingService=r,this.eventingService=s,this.$rootScope=a}return e.prototype.action=function(){this.responseDeferred=this.$q.defer();var e={callId:this.commandDetails.callId,conversationId:this.commandDetails.conversationId,messageId:this.commandDetails.messageId,conversationUrl:this.commandDetails.conversationUrl},t=this.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails();if(this.commandDetails.conversationId)if(this.transportDependencyProviderService.getTransportCallKeeper().isCallActiveOnTransport(e)){var n=this.callingService.getCallByCallId(this.commandDetails.callId);if(!n)return t.errorDetails="No call found for callId = "+this.commandDetails.callId,t.errorCode=this.constants.transportTelemetryErrorCode.incomingCommand.openShare.callNotFound,this.incomingCommandReceivedScenario.fail({message:t.errorCode,message1:t.errorDetails}),this.responseDeferred.reject(t),this.responseDeferred;this.eventingService.$emit(this.constants.events.calling.openSharingPanel),this.$rootScope.$emit(this.constants.events.betterTogether.callingScreenStatusChanged,{__typename:"CallingScreenStatusChanged",teamsCallId:n.teamsCallId,callingScreenStatusData:{isShareTrayVisible:!0,timeStamp:Date.now()}}),this.responseDeferred.resolve(t),this.incomingCommandReceivedScenario.stop()}else t.errorCode=this.constants.transportTelemetryErrorCode.incomingCommand.calling.callNotPresent,this.responseDeferred.reject(t),this.incomingCommandReceivedScenario.fail({message:t.errorCode});else t.errorDetails="conversation id is not present, conversationId - "+this.commandDetails.conversationId+", messageId - "+this.commandDetails.messageId,t.errorCode=this.constants.transportTelemetryErrorCode.incomingCommand.calling.conversationIdIsEmpty,this.incomingCommandReceivedScenario.fail({message:t.errorCode,message1:t.errorDetails}),this.responseDeferred.reject(t);return this.responseDeferred},e}();t.OpenShareCommand=i},2745:function(e,t,n){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++){t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t,n,i,o,r,s,a){this.commandDetails=e,this.transportDependencyProviderService=t,this.incomingCommandReceivedScenario=n,this.$q=i,this.callingService=o,this.constants=r,this.$injector=a,this.logger=s.newLogger("TransportEndCallCommand")}return e.prototype.action=function(){var e=this;if(this.responseDeferred=this.$q.defer(),!this.commandDetails.callId||!this.commandDetails.conversationId&&!this.commandDetails.pstnMri){a=i({errorCode:this.constants.transportTelemetryErrorCode.incomingCommand.calling.conversationIdIsEmpty,errorDetails:"callId - "+(this.commandDetails.callId||"")+", conversationId -  "+(this.commandDetails.conversationId||"")+", messageId - "+(this.commandDetails.messageId||"")},this.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails());return this.logger.error("errorCode - "+a.errorCode+", errorDetails - "+a.errorDetails),this.incomingCommandReceivedScenario.fail({message:a.errorCode,message1:a.errorDetails}),this.responseDeferred.reject(a),this.responseDeferred}var t={callId:this.commandDetails.callId,conversationId:this.commandDetails.conversationId,messageId:this.commandDetails.messageId,pstnMri:this.commandDetails.pstnMri,conversationUrl:this.commandDetails.conversationUrl},n=this.transportDependencyProviderService.getTransportCallKeeper(),o=this.callingService.getAllCalls(),r=o&&o.length>0?o.filter(function(e){return n.isCallEqualTransportCall(e,t)}):[];if(r&&r.length>0){var s=r[0];s.removeCallFromTransportCompanionMode(),this.callingService.leaveCall(s,"EndCallCommand").then(function(){e.logger.info("End call succeeded"),e.incomingCommandReceivedScenario.stop(),e.responseDeferred.resolve(e.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails())}).catch(function(t){var n=i({errorCode:e.constants.transportTelemetryErrorCode.incomingCommand.calling.operationFailed,errorDetails:"Endcall failed with error "+t},e.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails());e.logger.error("errorCode - "+n.errorCode+", errorDetails - "+n.errorDetails),e.incomingCommandReceivedScenario.fail({message:n.errorCode,message1:n.errorDetails}),e.responseDeferred.reject(n)})}else if(this.transportDependencyProviderService.getTransportCallKeeper().removeActiveCall(t)&&(this.commandDetails.pstnMri||this.$injector.get("conversationsService").getCallingConversation(this.commandDetails.conversationId).isChat()))this.logger.info("End call succeeded for P2P call"),this.incomingCommandReceivedScenario.stop(),this.responseDeferred.resolve(this.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails());else{var a=i({errorCode:this.constants.transportTelemetryErrorCode.incomingCommand.calling.callNotPresent,errorDetails:"callId - "+(t.callId||"")+", conversationId -  "+(t.conversationId||"")+", messageId - "+(t.messageId||"")},this.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails());this.logger.error("errorCode - "+a.errorCode+", errorDetails - "+a.errorDetails),this.incomingCommandReceivedScenario.fail({message:a.errorCode}),this.responseDeferred.reject(a)}return this.responseDeferred},e}();t.EndCallCommand=o;var r=function(){function e(e,t,n,i,o,r,s,a){this.commandDetails=e,this.transportDependencyProviderService=t,this.incomingCommandReceivedScenario=n,this.$q=o,this.callingService=r,this.constants=s,this.dialingService=a,this.logger=i.newLogger("TransportCallingIncomingCommand")}return e.prototype.action=function(){var e=this;if(this.responseDeferred=this.$q.defer(),!this.commandDetails.callId||!this.commandDetails.conversationId&&!this.commandDetails.pstnMri){s=i({errorCode:this.constants.transportTelemetryErrorCode.incomingCommand.calling.conversationIdIsEmpty,errorDetails:"callId - "+(this.commandDetails.callId||"")+", conversationId -  "+(this.commandDetails.conversationId||"")+", messageId - "+(this.commandDetails.messageId||"")},this.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails());return this.logger.error("errorCode - "+s.errorCode+", errorDetails - "+s.errorDetails),this.incomingCommandReceivedScenario.fail({message:s.errorCode,message1:s.errorDetails}),this.responseDeferred.reject(s),this.responseDeferred}var t={isMicMuted:this.commandDetails.startCallOptions.isMicMuted,isVideoOn:this.commandDetails.startCallOptions.withVideo,isSpeakerMuted:this.commandDetails.startCallOptions.isSpeakerMuted,isCallOnHold:!1},n={callId:this.commandDetails.callId,conversationId:this.commandDetails.conversationId,messageId:this.commandDetails.messageId,pstnMri:this.commandDetails.pstnMri,conversationUrl:this.commandDetails.conversationUrl,callState:t},o=this.transportDependencyProviderService.getTransportCallKeeper();if(o.isCallActiveOnTransport(n)){var r=o.getTransportCallWithDetails(n),s=i({callId:r.callId,conversationId:r.conversationId,messageId:r.messageId,pstnMri:r.pstnMri,isBroadcast:!1,startCallOptions:{isMicMuted:r.callState.isMicMuted,isSpeakerMuted:r.callState.isSpeakerMuted,withVideo:r.callState.isVideoOn}},this.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails());this.logger.info("StartCallCommand CallId: "+this.commandDetails.callId+" is ActiveOnTransport mode"),this.incomingCommandReceivedScenario.stop(),this.responseDeferred.resolve(s)}else o.ringingCallResolved(n).then(function(){var t=e.callingService.getActiveCall();if(t&&o.isCallEqualTransportCall(t,n))e.logger.info("StartCallCommand  CallId: "+e.commandDetails.callId+" upgrade existing call to BT mode"),n.callState.isMicMuted=t.isMuted,n.callState.isSpeakerMuted=t.isSpeakerMuted,n.callState.isVideoOn=t.isVideoOn,n.callState.isCallOnHold=!1,e.transportDependencyProviderService.getTransportCallKeeper().addActiveCall(n),t.stopVideo(t.getTag()).then(function(){return t.muteSpeaker()}).then(function(){return t.mute()}).then(function(){t.initForTransportCompanion(),t.setupSlimCorePropsToTransportState();var o=i({callId:t.callId,conversationId:t.conversationId,messageId:t.messageId,pstnMri:n.pstnMri,isBroadcast:!1,startCallOptions:{isMicMuted:t.isMuted,isSpeakerMuted:t.isSpeakerMuted,withVideo:t.isVideoOn}},e.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails());e.responseDeferred.resolve(o)}).catch(function(t){var n=i({errorDetails:"Error changing call settings to BTmode "+JSON.stringify(t),errorCode:e.constants.transportTelemetryErrorCode.incomingCommand.calling.operationFailed},e.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails());e.logger.error(n.errorDetails),e.incomingCommandReceivedScenario.fail({message:n.errorCode,message1:n.errorDetails}),e.responseDeferred.reject(n)});else{e.logger.info("StartCallCommand CallId: "+e.commandDetails.callId+" not active. Start new call"),e.transportDependencyProviderService.getTransportCallKeeper().addActiveCall(n);var r=void 0;if(e.commandDetails.conversationId){var s={conversationId:e.commandDetails.conversationId,startCallScenarioPromise:e.$q.resolve(null),secondaryScenarios:[],withVideo:e.commandDetails.startCallOptions.withVideo,muted:e.commandDetails.startCallOptions.isMicMuted,callId:e.commandDetails.callId};r=e.callingService.startCall(s)}else{var a=e.commandDetails.pstnMri?e.commandDetails.pstnMri.replace(SkypeX.Services.ChatServiceUtils.PstnPrefix,""):void 0;r=e.dialingService.startPstnCall(a,null,e.$q.resolve(null),[],void 0,void 0,e.commandDetails.startCallOptions.isMicMuted,void 0,e.commandDetails.callId)}r.then(function(t){e.logger.info("Start call succeeded"),e.incomingCommandReceivedScenario.stop({message:e.constants.transportTelemetryErrorCode.incomingCommand.calling.callNotPresent}),e.responseDeferred.resolve(e.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails())}).catch(function(t){var n=i({errorDetails:"Start call failed with error "+JSON.stringify(t),errorCode:e.constants.transportTelemetryErrorCode.incomingCommand.calling.operationFailed},e.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails());e.incomingCommandReceivedScenario.fail({message:n.errorCode,message1:n.errorDetails}),e.logger.error(n.errorDetails),e.responseDeferred.reject(n)})}});return this.responseDeferred},e}();t.StartCallCommand=r;var s=function(){function e(e,t,n,i,o,r,s,a,c){this.commandDetails=e,this.transportDependencyProviderService=t,this.commandName=n,this.incomingCommandReceivedScenario=i,this.$q=o,this.callingService=r,this.constants=s,this.$timeout=c,this.logger=a.newLogger("TransportBaseCallToggleStateCommand")}return e.prototype.action=function(){var e=this;if(this.responseDeferred=this.$q.defer(),!this.commandDetails.callId||!this.commandDetails.conversationId&&!this.commandDetails.pstnMri){c=i({errorCode:this.constants.transportTelemetryErrorCode.incomingCommand.calling.conversationIdIsEmpty,errorDetails:"callId - "+(this.commandDetails.callId||"")+", conversationId -  "+(this.commandDetails.conversationId||"")+", messageId - "+(this.commandDetails.messageId||"")},this.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails());return this.logger.error("errorCode - "+c.errorCode+", errorDetails - "+c.errorDetails),this.incomingCommandReceivedScenario.fail({message:c.errorCode,message1:c.errorDetails}),this.responseDeferred.reject(c),this.responseDeferred}var t,n={callId:this.commandDetails.callId,conversationId:this.commandDetails.conversationId,messageId:this.commandDetails.messageId,pstnMri:this.commandDetails.pstnMri,conversationUrl:this.commandDetails.conversationUrl},o=this.transportDependencyProviderService.getTransportCallKeeper(),r=this.callingService.getAllCalls(!1,!1,!1),s=r?r.filter(function(e){return o.isCallEqualTransportCall(e,n)}):void 0;if(s&&s.length>0){var a=s[0];t=this.transportDependencyProviderService.getCallToggleDefer(this.commandName,a,n),this.commandName==teamspace.services.IncomingCommand.UnholdCall&&this.commandDetails.startCallOptions&&t.then(function(){e.transportDependencyProviderService.syncCallState(e.commandDetails.startCallOptions,a,n)})}else{var c=i({errorCode:this.constants.transportTelemetryErrorCode.incomingCommand.calling.callNotPresent},this.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails());this.logger.error("errorCode - "+c.errorCode),this.incomingCommandReceivedScenario.fail({message:c.errorCode}),this.responseDeferred.reject(c)}return t&&t.then(function(){e.incomingCommandReceivedScenario.stop(),e.$timeout(function(){return e.responseDeferred.resolve(e.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails())},0)}).catch(function(t){var n=i({errorCode:e.constants.transportTelemetryErrorCode.incomingCommand.calling.operationFailed,errorDetails:"Endcall failed with error "+JSON.stringify(t)},e.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails());e.logger.error("errorCode - "+n.errorCode+", errorDetails - "+n.errorDetails),e.incomingCommandReceivedScenario.fail({message:n.errorCode,message1:n.errorDetails}),e.responseDeferred.reject(n)}),this.responseDeferred},e}();t.BaseCallToggleStateCommand=s},2746:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,n,i,o,r,s){this.commandDetails=e,this.transportDependencyProviderService=t,this.incomingCommandReceivedScenario=n,this.constants=i,this.settingsService=r,this.$q=s,this.logger=o.newLogger("TransportReportProblemIncomingCommand")}return e.prototype.action=function(){var e=this,t=this.transportDependencyProviderService.getTransportConnectionHandler(),n=this.transportDependencyProviderService.getBrbV2FeedbackService(),i=this.$q.defer(),o=t.getResponseDetails();return this.settingsService.valueAsBoolean(this.constants.settings.names.enableBetterTogetherReportProblemSynching)?n?(n.extendFeedbackReport(this.commandDetails.brbContainerId,{category:"Better Together",title:"Addition of logfiles by laptop for Better Together problem report",description:"Addition of logfiles for endpointId "+this.commandDetails.targetEndpointId},!0).then(function(){e.incomingCommandReceivedScenario.stop(),i.resolve(o)}).catch(function(t){o.errorCode=e.constants.transportTelemetryErrorCode.incomingCommand.reportProblem.operationFailed,o.errorDetails=t,e.logger.error("errorCode - "+o.errorCode+", errorDetails - "+o.errorDetails),e.incomingCommandReceivedScenario.fail({message:o.errorCode,message1:o.errorDetails}),i.reject(o)}),i):(o.errorCode=this.constants.transportTelemetryErrorCode.incomingCommand.reportProblem.serviceNotLoaded,i.reject(o),this.incomingCommandReceivedScenario.fail({message:o.errorCode}),i):(o.errorCode=this.constants.transportTelemetryErrorCode.incomingCommand.featureDisabled,this.incomingCommandReceivedScenario.fail({message:o.errorCode}),i.reject(o),i)},e}();t.ReportProblemIncomingCommand=i},2747:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(2748),o=n(2749),r=n(2750),s=n(2751),a=n(2752),c=n(2753),d=n(2754),l=function(){function e(e,t,n,i,o,r,s,a,c){this.transportDependencyProviderService=e,this.constants=t,this.loggingService=n,this.$q=i,this.settingsService=o,this.utilityService=r,this.appStateService=s,this.dialingService=a,this.callingService=c,this.logger=n.newLogger("OutgoingCommandFactory")}return e.prototype.generateCauseId=function(){return this.utilityService.generateUUID()},e.prototype.createCommand=function(e,t,n,l){var m;if(this.appStateService.hasMachineState(teamspace.services.MachineState.MachineLocked)&&e!=teamspace.services.OutgoingCommand.Lock)return this.logger.error("Machine is in locked state. Outgoing command with name - "+e+" will not be created."),l.fail({errorMessage:this.constants.transportTelemetryErrorCode.outgoingCommand.desktopIsLocked,message:e.toLowerCase(),endPointId:t.targetEndpointId}),null;e=e.toLowerCase();var p=this.generateCauseId();switch(e){case teamspace.services.OutgoingCommand.Response:m=new i.ResponseCommand(p,n,t,l,this.constants,this.loggingService,this.$q);break;case teamspace.services.OutgoingCommand.KeepAlive:m=new o.KeepAliveCommand(p,n,t,this.transportDependencyProviderService,l,this.constants,this.settingsService,this.loggingService,this.$q);break;case teamspace.services.OutgoingCommand.Lock:m=new r.LockCommand(p,n,t,this.transportDependencyProviderService,l,this.loggingService,this.constants,this.$q);break;case teamspace.services.OutgoingCommand.Unlock:m=new s.UnlockCommand(p,n,t,this.transportDependencyProviderService,l,this.$q,this.loggingService,this.constants);break;case teamspace.services.OutgoingCommand.Unpair:m=new a.UnpairCommand(p,n,t,l,this.$q,this.constants,this.loggingService);break;case teamspace.services.OutgoingCommand.JoinCall:case teamspace.services.OutgoingCommand.StartCall:m=new c.StartCallOutgoingCommand(p,n,t,this.transportDependencyProviderService,l,this.$q,this.loggingService,this.dialingService,this.callingService,this.constants);break;case teamspace.services.OutgoingCommand.CreateAndStartCall:case teamspace.services.OutgoingCommand.DialNumber:m=new c.CreateAndStartCallOutgoingCommand(p,n,t,this.transportDependencyProviderService,l,this.$q,this.loggingService,this.constants);break;case teamspace.services.OutgoingCommand.EndCall:m=new c.EndCallOutgoingCommand(p,n,t,l,this.$q,this.constants,this.loggingService);break;case teamspace.services.OutgoingCommand.Mute:case teamspace.services.OutgoingCommand.Unmute:case teamspace.services.OutgoingCommand.StartAudio:case teamspace.services.OutgoingCommand.StopAudio:case teamspace.services.OutgoingCommand.StartVideo:case teamspace.services.OutgoingCommand.StopVideo:case teamspace.services.OutgoingCommand.HoldCall:case teamspace.services.OutgoingCommand.UnholdCall:m=new c.BaseCallCommand(p,n,t,l,this.$q,this.constants,this.loggingService);break;case teamspace.services.OutgoingCommand.ReportProblem:m=new d.ReportProblemOutgoingCommand(p,n,t,l,this.$q,this.loggingService,this.constants);break;default:return null}return m.name=e,m.startTime=new Date,m.isRetry=!1,m.acknowledgementReceived=!1,m},e}();t.OutgoingCommandFactory=l},2748:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,n,i,o,r,s){this.causeId=e,this.endpoint=t,this.commandDetails=n,this.sendOutgoingCommandScenario=i,this.constants=o,this.logger=r.newLogger("TransportResponseCommand"),n.companionResponseRequired=!1,this.onResponseReceived=s.defer(),this.onCommandReadyToSend=s.defer(),this.onCommandReadyToSend.resolve(!0);var a=this.onCommandExecuted.bind(this);this.onResponseReceived.promise.then(a).catch(a)}return e.prototype.onCommandExecuted=function(e){var t=this.endpoint.getEndpointId();if(e&&!e.errorDetails)this.sendOutgoingCommandScenario.stop({endPointId:t,requestId:this.causeId});else{var n=void 0,i=void 0;e?(n="Error response: "+e.errorDetails,i=e.errorCode?e.errorCode:this.constants.transportTelemetryErrorCode.outgoingCommand.operationFailedOnRemoteEndpoint):(n="",i=this.constants.transportTelemetryErrorCode.outgoingCommand.nullResponse),this.sendOutgoingCommandScenario.fail({endPointId:t,requestId:this.causeId,errorMessage:i,message:n}),this.logger.error("errorCode - "+i+", errorDetails - "+n)}},e}();t.ResponseCommand=i},2749:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i;!function(e){e.NotPaired="NotPaired"}(i||(i={}));var o=function(){function e(e,t,n,i,o,r,s,a,c){this.causeId=e,this.endpoint=t,this.commandDetails=n,this.transportDependencyProviderService=i,this.sendOutgoingCommandScenario=o,this.constants=r,this.settingsService=s,this.logger=a.newLogger("TransportKeepAliveCommand"),n.companionResponseRequired=!0;var d=this.onCommandExecuted.bind(this);this.onResponseReceived=c.defer(),this.onResponseReceived.promise.then(d).catch(d),this.onCommandReadyToSend=c.defer(),this.onCommandReadyToSend.resolve(!0)}return e.prototype.onCommandExecuted=function(e){var t=this.endpoint.getEndpointId();if(e&&!e.errorDetails)this.sendOutgoingCommandScenario.stop({endPointId:t,requestId:this.causeId});else{var n=void 0,i=void 0;e?(n="Error response: "+e.errorDetails,"NotPaired"===(i=e.errorCode?e.errorCode:this.constants.transportTelemetryErrorCode.outgoingCommand.operationFailedOnRemoteEndpoint)&&this.settingsService.valueAsBoolean(this.constants.settings.names.enableBetterTogetherRemoveOutofSyncPairing)&&(this.logger.error("Remove the device from the list of paired devices, endpointId - "+t),this.transportDependencyProviderService.getTransportConnectionHandler().onDeviceUnpaired(t))):(n="",i=this.constants.transportTelemetryErrorCode.outgoingCommand.nullResponse),this.sendOutgoingCommandScenario.fail({errorMessage:i,endPointId:t,requestId:this.causeId,message:n}),this.logger.error("errorCode - "+i+", errorDetails - "+n)}},e}();t.KeepAliveCommand=o},2750:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,n,i,o,r,s,a){this.causeId=e,this.endpoint=t,this.commandDetails=n,this.transportDependencyProviderService=i,this.sendOutgoingCommandScenario=o,this.constants=s,this.logger=r.newLogger("TransportLockCommand"),n.companionResponseRequired=!1,this.onResponseReceived=a.defer(),this.onCommandReadyToSend=a.defer(),this.onCommandReadyToSend.resolve(!0);var c=this.onCommandExecuted.bind(this);this.onResponseReceived.promise.then(c).catch(c)}return e.prototype.onCommandExecuted=function(e){var t=this.endpoint.getEndpointId();if(e&&!e.errorDetails)this.transportDependencyProviderService.getTransportConnectionHandler().onDeviceLocked(this.endpoint.getEndpointId()),this.logger.info("companion device locked"),this.sendOutgoingCommandScenario.stop({endPointId:t,requestId:this.causeId});else{var n=void 0,i=void 0;e?(n="Error response: "+e.errorDetails,i=e.errorCode?e.errorCode:this.constants.transportTelemetryErrorCode.outgoingCommand.operationFailedOnRemoteEndpoint):(n="",i=this.constants.transportTelemetryErrorCode.outgoingCommand.nullResponse),this.sendOutgoingCommandScenario.fail({endPointId:t,requestId:this.causeId,errorMessage:i,message:n}),this.logger.error("errorCode - "+i+", errorDetails - "+n)}},e}();t.LockCommand=i},2751:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,n,i,o,r,s,a){this.causeId=e,this.endpoint=t,this.commandDetails=n,this.transportDependencyProviderService=i,this.sendOutgoingCommandScenario=o,this.constants=a,this.logger=s.newLogger("TransportUnlockCommand"),n.companionResponseRequired=!0,this.onResponseReceived=r.defer(),this.onCommandReadyToSend=r.defer(),this.onCommandReadyToSend.resolve(!0);var c=this.onCommandExecuted.bind(this);this.onResponseReceived.promise.then(c).catch(c)}return e.prototype.onCommandExecuted=function(e){var t=this.endpoint.getEndpointId();if(e&&!e.errorDetails)this.transportDependencyProviderService.getTransportConnectionHandler().onDeviceUnlocked(this.endpoint.getEndpointId()),this.logger.info("companion device unlocked"),this.sendOutgoingCommandScenario.stop({endPointId:t,requestId:this.causeId});else{var n=void 0,i=void 0;e?(n="Error response: "+e.errorDetails,i=e.errorCode?e.errorCode:this.constants.transportTelemetryErrorCode.outgoingCommand.operationFailedOnRemoteEndpoint):(n="",i=this.constants.transportTelemetryErrorCode.outgoingCommand.nullResponse),this.sendOutgoingCommandScenario.fail({endPointId:t,requestId:this.causeId,errorMessage:i,message:n}),this.logger.error("errorCode - "+i+", errorDetails - "+n)}},e}();t.UnlockCommand=i},2752:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,n,i,o,r,s){this.causeId=e,this.endpoint=t,this.commandDetails=n,this.sendOutgoingCommandScenario=i,this.constants=r,n.companionResponseRequired=!1,this.logger=s.newLogger("TransportUnpairCommand"),this.onResponseReceived=o.defer();var a=this.onCommandExecuted.bind(this);this.onResponseReceived.promise.then(a).catch(a),this.onCommandReadyToSend=o.defer(),this.onCommandReadyToSend.resolve(!0)}return e.prototype.onCommandExecuted=function(e){var t=this.endpoint.getEndpointId();if(e&&!e.errorDetails)this.sendOutgoingCommandScenario.stop({endPointId:t,requestId:this.causeId});else{var n=void 0,i=void 0;e?(n="Error response: "+e.errorDetails,i=e.errorCode?e.errorCode:this.constants.transportTelemetryErrorCode.outgoingCommand.operationFailedOnRemoteEndpoint):(n="",i=this.constants.transportTelemetryErrorCode.outgoingCommand.nullResponse),this.sendOutgoingCommandScenario.fail({endPointId:t,requestId:this.causeId,errorMessage:i,message:n}),this.logger.error("errorCode - "+i+", errorDetails - "+n)}},e}();t.UnpairCommand=i},2753:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,n,i,o,r,s){this.causeId=e,this.endpoint=t,this.commandDetails=n,this.sendOutgoingCommandScenario=i,this.constants=r,this.logger=s.newLogger("TransportBaseCallCommand"),n.companionResponseRequired=!0,this.onResponseReceived=o.defer(),this.onCommandReadyToSend=o.defer(),this.onCommandReadyToSend.resolve(!0);var a=this.onCommandExecuted.bind(this);this.onResponseReceived.promise.then(a).catch(a)}return e.prototype.onCommandExecuted=function(e){if(e&&!e.errorDetails)this.sendOutgoingCommandScenario.stop({message1:"Completed command "+this.name+" for call id "+this.commandDetails.callId});else{var t=void 0,n=void 0;e?(t=this.name+" command failed for call id "+this.commandDetails.callId+", Error response: "+e.errorDetails,n=e.errorCode?e.errorCode:this.constants.transportTelemetryErrorCode.outgoingCommand.operationFailedOnRemoteEndpoint):(t="",n=this.constants.transportTelemetryErrorCode.outgoingCommand.nullResponse),this.sendOutgoingCommandScenario.fail({message:n,message1:t}),this.logger.error("errorCode - "+n+", errorDetails - "+t)}},e}();t.BaseCallCommand=i;var o=function(){function e(e,t,n,i,o,r,s,a,c,d){this.causeId=e,this.endpoint=t,this.commandDetails=n,this.transportDependencyProviderService=i,this.sendOutgoingCommandScenario=o,this.$q=r,this.dialingService=a,this.callingService=c,this.constants=d,n.companionResponseRequired=!0,this.onResponseReceived=r.defer(),this.onCommandReadyToSend=r.defer(),this.onCommandReadyToSend.resolve(!0);var l=this.onCommandExecuted.bind(this);this.onResponseReceived.promise.then(l).catch(l),this.logger=s.newLogger("TransportStartCallOutgoingCommand")}return e.prototype.onCommandExecuted=function(e){var t=this;if(e&&!e.errorDetails){var n={isMicMuted:e.startCallOptions?e.startCallOptions.isMicMuted:this.commandDetails.startCallOptions.isMicMuted,isVideoOn:e.startCallOptions?e.startCallOptions.withVideo:this.commandDetails.startCallOptions.withVideo,isSpeakerMuted:e.startCallOptions?e.startCallOptions.isSpeakerMuted:this.commandDetails.startCallOptions.isSpeakerMuted,isCallOnHold:!1},i={callId:this.commandDetails.callId,conversationId:e.conversationId,messageId:e.messageId,pstnMri:this.commandDetails.pstnMri,conversationUrl:e.conversationUrl,callState:n};this.commandDetails.isP2PCall||this.commandDetails.accepted?this.transportDependencyProviderService.getTransportCallKeeper().ringingCallResolved(i).then(function(){t.transportDependencyProviderService.getTransportCallKeeper().addActiveCall(i);var o;if(t.commandDetails.pstnMri){var r=t.commandDetails.pstnMri.replace(SkypeX.Services.ChatServiceUtils.PstnPrefix,"");o=t.dialingService.startPstnCall(r,null,t.$q.resolve(null),[],void 0,void 0,n.isMicMuted,void 0,t.commandDetails.callId)}else{var s={conversationId:e.conversationId,startCallScenarioPromise:t.$q.resolve(null),secondaryScenarios:[],withVideo:n.isVideoOn,muted:n.isSpeakerMuted,callId:t.commandDetails.callId};o=t.callingService.startCall(s)}o.then(function(e){t.logger.info("StartCallCommand for a P2P call CallId: "+t.commandDetails.callId+" is successful"),t.sendOutgoingCommandScenario.stop({message:t.commandDetails.pstnMri?"PSTN_CALL":"P2P_CALL",message1:"StartCallCommand for a P2P call CallId: "+t.commandDetails.callId+" is successful"})}).catch(function(e){t.transportDependencyProviderService.getTransportCallKeeper().removeActiveCall(i),t.logger.info("StartCallCommand for a P2P call CallId: "+t.commandDetails.callId+" failed with error - "+e),t.sendOutgoingCommandScenario.fail({message:(t.commandDetails.pstnMri?"PSTN_CALL":"P2P_CALL")+"_"+t.constants.transportTelemetryErrorCode.outgoingCommand.operationFailed,message1:"StartCallCommand for a P2P call CallId: "+t.commandDetails.callId+" failed with error - "+e})})}):(this.logger.info("StartCallCommand for other calls CallId: "+this.commandDetails.callId+". Start new call"),this.transportDependencyProviderService.getTransportCallKeeper().addActiveCall(i),this.sendOutgoingCommandScenario.stop({message:"MEETING",message1:"Other Calls with callid started on companion device "+this.commandDetails.callId}))}else{var o=void 0,r=void 0;e?(o="Error response: "+e.errorDetails,r=e.errorCode?e.errorCode:this.constants.transportTelemetryErrorCode.outgoingCommand.operationFailedOnRemoteEndpoint):(o="",r=this.constants.transportTelemetryErrorCode.outgoingCommand.nullResponse),r=this.commandDetails.isP2PCall?this.commandDetails.pstnMri?"PSTN_CALL_"+r:"P2P_CALL_"+r:"MEETING_"+r,this.sendOutgoingCommandScenario.fail({message:r,message1:o}),this.logger.error("errorCode - "+r+", errorDetails - "+o)}},e}();t.StartCallOutgoingCommand=o;var r=function(){function e(e,t,n,i,o,r,s,a){this.causeId=e,this.endpoint=t,this.commandDetails=n,this.transportDependencyProviderService=i,this.sendOutgoingCommandScenario=o,this.constants=a,n.companionResponseRequired=!0,this.onResponseReceived=r.defer(),this.onCommandReadyToSend=r.defer(),this.onCommandReadyToSend.resolve(!0);var c=this.onCommandExecuted.bind(this);this.onResponseReceived.promise.then(c).catch(c),this.logger=s.newLogger("TransportCreateAndStartCallOutgoingCommand");var d={isMicMuted:n.startCallOptions.isMicMuted,isVideoOn:n.startCallOptions.withVideo,isSpeakerMuted:n.startCallOptions.isSpeakerMuted,isCallOnHold:!1};this.activeCall={callId:n.callId,conversationId:n.conversationId,messageId:n.messageId,pstnMri:n.pstnMri,conversationUrl:n.conversationUrl,callState:d},i.getTransportCallKeeper().addActiveCall(this.activeCall)}return e.prototype.onCommandExecuted=function(e){if(e&&!e.errorDetails)if(e.callFailureReason)this.transportDependencyProviderService.getTransportCallKeeper().removeActiveCall(this.activeCall),this.logger.error("call failed on transport companion device callid "+this.commandDetails.callId+" with reason "+e.callFailureReason),this.sendOutgoingCommandScenario.stop({message:e.callFailureReason,message1:"call failed on transport companion device callid "+this.commandDetails.callId});else{var t={isMicMuted:e.startCallOptions?e.startCallOptions.isMicMuted:this.commandDetails.startCallOptions.isMicMuted,isVideoOn:e.startCallOptions?e.startCallOptions.withVideo:this.commandDetails.startCallOptions.withVideo,isSpeakerMuted:e.startCallOptions?e.startCallOptions.isSpeakerMuted:this.commandDetails.startCallOptions.isSpeakerMuted,isCallOnHold:!1};this.transportDependencyProviderService.getTransportCallKeeper().setCallStateForCall(this.activeCall,t),this.logger.info("Call with callid started on companion device "+this.commandDetails.callId),this.sendOutgoingCommandScenario.stop({message1:"Call with callid started on companion device "+this.commandDetails.callId})}else{this.transportDependencyProviderService.getTransportCallKeeper().removeActiveCall(this.activeCall);var n=void 0,i=void 0;e?(n="Error response: "+e.errorDetails,i=e.errorCode?e.errorCode:this.constants.transportTelemetryErrorCode.outgoingCommand.operationFailedOnRemoteEndpoint):(n="",i=this.constants.transportTelemetryErrorCode.outgoingCommand.nullResponse),this.sendOutgoingCommandScenario.fail({message:i,message1:n}),this.logger.error("errorCode - "+i+", errorDetails - "+n)}},e}();t.CreateAndStartCallOutgoingCommand=r;var s=function(){function e(e,t,n,i,o,r,s){this.causeId=e,this.endpoint=t,this.commandDetails=n,this.sendOutgoingCommandScenario=i,this.constants=r,this.logger=s.newLogger("TransportEndCallOutgoingCommand"),n.companionResponseRequired=!0,this.onResponseReceived=o.defer(),this.onCommandReadyToSend=o.defer(),this.onCommandReadyToSend.resolve(!0);var a=this.onCommandExecuted.bind(this);this.onResponseReceived.promise.then(a).catch(a)}return e.prototype.onCommandExecuted=function(e){if(e&&!e.errorDetails)this.sendOutgoingCommandScenario.stop({message1:"Call with callid stopped on companion device "+this.commandDetails.callId});else{var t=void 0,n=void 0;e?(t="Error response: "+e.errorDetails,n=e.errorCode?e.errorCode:this.constants.transportTelemetryErrorCode.outgoingCommand.operationFailedOnRemoteEndpoint):(t="",n=this.constants.transportTelemetryErrorCode.outgoingCommand.nullResponse),this.sendOutgoingCommandScenario.fail({message:n,message1:t}),this.logger.error("errorCode - "+n+", errorDetails - "+t)}},e}();t.EndCallOutgoingCommand=s},2754:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,n,i,o,r,s){this.causeId=e,this.endpoint=t,this.commandDetails=n,this.sendOutgoingCommandScenario=i,this.constants=s,this.logger=r.newLogger("TransportReportProblemOutgoingCommand"),n.companionResponseRequired=!1;var a=this.onCommandExecuted.bind(this);this.onResponseReceived=o.defer(),this.onResponseReceived.promise.then(a).catch(a),this.onCommandReadyToSend=o.defer(),this.onCommandReadyToSend.resolve(!0)}return e.prototype.onCommandExecuted=function(e){if(e&&!e.errorDetails)this.logger.info("Outgoing report problem command for brbContainerId "+this.commandDetails.brbContainerId+" successful for endpoint: "+this.endpoint.getEndpointId()+"."),this.sendOutgoingCommandScenario.stop();else{var t=void 0,n=void 0;e?(t="Error response: "+e.errorDetails,n=e.errorCode?e.errorCode:this.constants.transportTelemetryErrorCode.outgoingCommand.operationFailedOnRemoteEndpoint):(t="",n=this.constants.transportTelemetryErrorCode.outgoingCommand.nullResponse),this.sendOutgoingCommandScenario.fail({message:n,message1:t}),this.logger.error("errorCode - "+n+", errorDetails - "+t)}},e}();t.ReportProblemOutgoingCommand=i},2755:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(2756),o=n(2757),r=n(2758),s=n(2759),a=n(2760),c=n(2761),d=n(2762),l=n(2763),m=teamspace.services.IncomingCommand,p=function(){function e(e,t,n,i,o,r,s,a,c,d,l,m,p,g,h,u,v){this.transportDependencyProviderService=e,this.callTogglingService=t,this.loggingService=n,this.callingService=i,this.$q=o,this.constants=r,this.$translate=s,this.platformDetectService=a,this.callingAgentsService=c,this.settingsService=d,this.resources=l,this.$rootScope=m,this.rigelSpeakerService=p,this.authenticationService=g,this.rigelServiceHandler=h,this.eventingService=u,this.meetingRoomUbarService=v,this.logger=n.newLogger("RemoteControllerIncomingCommandFactory")}return e.prototype.createCommand=function(e,t){var n=e.command,p=JSON.parse(e.commandDetails),g=e.endpointId;switch(this.logger.info("Creating command:"+n+" causeId:"+e.causeId),n){case m.Pair:return new i.RemoteControllerPairCommand(p,g,this.transportDependencyProviderService,t,this.$translate,this.platformDetectService,this.callingAgentsService,this.constants,this.settingsService,this.$q,this.resources,this.callingService,this.loggingService,this.authenticationService,this.rigelServiceHandler);case m.Unpair:return new l.RemoteControllerUnpairCommand(p,this.transportDependencyProviderService,t,g,n,this.callingService,this.constants,this.loggingService,this.$q);case m.Mute:case m.Unmute:return new a.MuteToggleCommand(p,this.transportDependencyProviderService,t,n,this.callTogglingService,this.callingService,this.constants,this.loggingService,this.$q);case m.CameraOn:case m.CameraOff:return new c.VideoToggleCommand(p,this.transportDependencyProviderService,t,n,this.callingService,this.constants,this.loggingService,this.$q,this.callTogglingService);case m.VolumeUp:case m.VolumeDown:return new r.VolumeCommand(p,this.transportDependencyProviderService,t,n,this.callingService,this.constants,this.loggingService,this.$q,this.rigelSpeakerService,this.callingAgentsService,this.meetingRoomUbarService);case m.ShowVideoGallery:case m.ShowContent:case m.ShowVideoGalleryAndContent:case m.ShowLargeGallery:case m.ShowTogether:return new o.StageLayoutCommand(p,this.transportDependencyProviderService,t,n,this.callingService,this.constants,this.loggingService,this.$q,this.$rootScope,this.eventingService,this.meetingRoomUbarService);case m.CaptionsOff:case m.CaptionsOn:return new s.CaptionsToggleCommand(p,this.transportDependencyProviderService,t,n,this.callingService,this.constants,this.loggingService,this.$q);case m.LeaveMeeting:return new d.RemoteControllerEndCallCommand(this.constants,p,this.transportDependencyProviderService,t,n,this.callingService,this.loggingService,this.$q);default:return this.logger.error("Couldn't create command:"+n+" causeId:"+e.causeId),t.fail({message:this.constants.transportTelemetryErrorCode.incomingCommand.invalidCommand,message1:n}),{result:!1,errorCode:this.constants.transportTelemetryErrorCode.incomingCommand.invalidCommand}}},e}();t.RemoteControllerIncomingCommandFactory=p},2756:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(38),r=teamspace.services.IncomingCommand,s=function(e){function t(t,n,i,o,s,a,c,d,l,m,p,g,h,u,v){var C=e.call(this,t,i,o,r.Pair,g,d,h,m)||this;return C.commandDetails=t,C.endpointId=n,C._transportDependencyProviderService=i,C.$translate=s,C.platformDetectService=a,C.callingAgentsService=c,C._constants=d,C.settingsService=l,C.resources=p,C.authenticationService=u,C.rigelServiceHandler=v,C}return i(t,e),t.prototype.canExecuteAction=function(){return this._transportDependencyProviderService.getRemoteControllerConnectionHandler().isRemoteControllerUserEnabled&&this.rigelServiceHandler.allowRoomRemoteController},t.prototype.executeCommandSpecificAction=function(e){var t=this,n=this._transportDependencyProviderService.getRemoteControllerConnectionHandler(),i=this._transportDependencyProviderService.getRemoteControllerSessionManager();n.verifySalt(this.commandDetails)?i.waitForEndpoint(this.endpointId).then(function(e){var i=t.commandDetails.controllerEndpointInfo;t.logger.info("Endpoint with endpointId="+t.endpointId+" is paired to clientType="+(i.clientType||"")+", clientVersion="+(i.clientVersion||"")+"."),n.onNewEndpointPaired(e),t.authenticationService.getUserInformation().then(function(e){t.userName=e.profile.name,t.oid=e.profile.oid}).catch(function(e){t.userName="",t.logger.error("Failed to retrieve authenticated user from authenticaionService with error: "+e)}).finally(function(){t.markSuccessfulWithResponse(t.buildPairResponse(),"endpointId:"+t.endpointId+", clientType:"+(null===i||void 0===i?void 0:i.clientType)+", clientVersion: "+(null===i||void 0===i?void 0:i.clientVersion))})}).catch(function(){return t.markFailureResponse("Did not receive a matching pairing endpoint",t._constants.transportTelemetryErrorCode.incomingCommand.incorrectEndpointId)}):this.markFailureResponse("Invalid salt received",this._constants.transportTelemetryErrorCode.incomingCommand.invalidSalt)},t.prototype.buildPairResponse=function(){var e=window.desktopEnvironment&&window.desktopEnvironment.hostname?window.desktopEnvironment.hostname:this.$translate.instant(this.resources.strings.meeting_unknown_status_text),t=this.platformDetectService.getDesktopAppVersion()+"/"+this.settingsService.getVersion().clientVersion,n=this._transportDependencyProviderService.getRemoteControllerConnectionHandler().remoteControllerCallState;return{accepted:!0,roomEndpointInfo:{clientType:this.platformDetectService.getDeviceType(),clientVersion:t,deviceName:e,endpointId:this.callingAgentsService.getRegistrationId(),userDisplayName:this.userName,userObjectId:this.oid},supportedCapabilities:n.capabilities,initialState:n.state}},t}(o.RemoteControllerIncomingBaseCommand);t.RemoteControllerPairCommand=s},2757:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=teamspace.services.IncomingCommand,r=teamspace.shared.RigelLayoutType,s=teamspace.components.Calling.CustomLayoutSelection,a=n(38),c=teamspace.services.StageLayoutControlsCapabilities,d=teamspace.shared.RoomRemoteLayoutType,l=function(e){function t(t,n,i,o,r,s,a,c,d,l,m){var p=e.call(this,t,n,i,o,r,s,a,c)||this;return p._constants=s,p.$rootScope=d,p.eventingService=l,p.meetingRoomUbarService=m,p}return i(t,e),t.prototype.canExecuteAction=function(){var e,t=null===(e=this.transportDependencyProviderService.getRemoteControllerConnectionHandler().remoteControllerCallState)||void 0===e?void 0:e.capabilities.stageLayoutControls;switch(this.command){case o.ShowContent:return _.includes(t,c.ShowContent);case o.ShowVideoGalleryAndContent:return _.includes(t,c.ShowVideoGalleryAndContent);case o.ShowLargeGallery:return _.includes(t,c.ShowLargeGallery);case o.ShowTogether:return _.includes(t,c.ShowTogether);default:return this.logger.info("No capability restriction has been found for "+this.command+"."),!0}},t.prototype.executeCommandSpecificAction=function(e){if(this.logger.info("Executing action for "+this.command+"."),this.meetingRoomUbarService.isInCallHybridMode){var t=void 0;switch(this.command){case o.ShowVideoGallery:t=d.Grid;break;case o.ShowContent:t=d.ContentOnly;break;case o.ShowVideoGalleryAndContent:t=d.ContentAndPeople;break;case o.ShowLargeGallery:t=d.LargeGrid;break;case o.ShowTogether:t=d.Audience;break;default:return void this.markFailureResponseInvalidCommand()}t&&this.$rootScope.$emit(this._constants.events.calling.meetingRoomRemoteSelectedLayoutChanged,t)}else switch(this.command){case o.ShowVideoGallery:this.eventingService.$emit(this._constants.events.calling.currentViewChangeRequested,s.Grid);break;case o.ShowContent:this.$rootScope.$broadcast(this._constants.events.rigel.service.eventTypes.userSelectedLayout,r.Content);break;case o.ShowVideoGalleryAndContent:this.$rootScope.$broadcast(this._constants.events.rigel.service.eventTypes.userSelectedLayout,r.ContentWithGallery);break;case o.ShowLargeGallery:this.eventingService.$emit(this._constants.events.calling.currentViewChangeRequested,s.LargeGrid);break;case o.ShowTogether:this.eventingService.$emit(this._constants.events.calling.currentViewChangeRequested,s.Audience);break;default:return void this.markFailureResponseInvalidCommand()}this.markSuccessful()},t}(a.RemoteControllerIncomingBaseCommand);t.StageLayoutCommand=l},2758:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=teamspace.services.IncomingCommand,r=function(e){function t(t,n,i,o,r,s,a,c,d,l,m){var p=e.call(this,t,n,i,o,r,s,a,c)||this;return p.rigelSpeakerService=d,p.callingAgentsService=l,p.meetingRoomUbarService=m,p}return i(t,e),t.prototype.canExecuteAction=function(){return!0},t.prototype.executeCommandSpecificAction=function(e){switch(this.command){case o.VolumeUp:this.incomingCommandReceivedScenario.stop({message1:""+this.command}),this.meetingRoomUbarService.isInCallHybridMode?this.callingAgentsService.speakerVolume+=teamspace.services.SpeakerVolumeIncrement:this.rigelSpeakerService.volume=this.rigelSpeakerService.volume+teamspace.services.SpeakerVolumeIncrement,this.markSuccessful();break;case o.VolumeDown:this.incomingCommandReceivedScenario.stop({message1:""+this.command}),this.meetingRoomUbarService.isInCallHybridMode?this.callingAgentsService.speakerVolume-=teamspace.services.SpeakerVolumeIncrement:this.rigelSpeakerService.volume=this.rigelSpeakerService.volume-teamspace.services.SpeakerVolumeIncrement,this.markSuccessful();break;default:this.markFailureResponseInvalidCommand()}},t}(n(38).RemoteControllerIncomingBaseCommand);t.VolumeCommand=r},2759:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=teamspace.services.IncomingCommand,r=teamspace.services.CallClosedCaptionStatus,s=function(e){function t(t,n,i,o,r,s,a,c){return e.call(this,t,n,i,o,r,s,a,c)||this}return i(t,e),t.prototype.canExecuteAction=function(){var e=this.transportDependencyProviderService.getRemoteControllerConnectionHandler().remoteControllerCallState;return _.includes(null===e||void 0===e?void 0:e.capabilities.mediaControls,teamspace.services.MediaControlsCapabilities.ToggleCaptions)},t.prototype.executeCommandSpecificAction=function(e){var t=e.getClosedCaptionStatus();switch(this.command){case o.CaptionsOff:t===r.started?(e.stopClosedCaption(),this.markSuccessful()):this.markFailureStateAlreadySet("CaptionStatus:"+r[t]+", callId:"+e.callId);break;case o.CaptionsOn:t!==r.started&&t!==r.disabled?(e.startClosedCaption(),this.markSuccessful()):this.markFailureResponse("CaptionStatus:"+r[t]+", callId:"+e.callId);break;default:this.markFailureResponseInvalidCommand()}},t}(n(38).RemoteControllerIncomingBaseCommand);t.CaptionsToggleCommand=s},2760:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=teamspace.services.IncomingCommand,r=function(e){function t(t,n,i,o,r,s,a,c,d){var l=e.call(this,t,n,i,o,s,a,c,d)||this;return l.callTogglingService=r,l}return i(t,e),t.prototype.canExecuteAction=function(){var e=this.transportDependencyProviderService.getRemoteControllerConnectionHandler().remoteControllerCallState;return _.includes(null===e||void 0===e?void 0:e.capabilities.mediaControls,teamspace.services.MediaControlsCapabilities.ToggleMute)},t.prototype.executeCommandSpecificAction=function(e){var t=this;switch(this.command){case o.Mute:this.callTogglingService.isMuted(e)?this.markFailureStateAlreadySet("callId "+e.callId):this.callTogglingService.toggleMuteAudio(e,1,1).then(function(){t.markSuccessful()}).catch(function(n){t.markFailureResponseOperationFailed("error "+n+" callId "+e.callId)});break;case o.Unmute:this.callTogglingService.isMuted(e)?this.callTogglingService.toggleMuteAudio(e,1,2).then(function(){t.markSuccessful()}).catch(function(n){t.markFailureResponseOperationFailed("error "+n+" callId "+e.callId)}):this.markFailureStateAlreadySet("callId "+e.callId);break;default:this.markFailureResponseInvalidCommand()}},t}(n(38).RemoteControllerIncomingBaseCommand);t.MuteToggleCommand=r},2761:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=teamspace.services.IncomingCommand,r=function(e){function t(t,n,i,o,r,s,a,c,d){var l=e.call(this,t,n,i,o,r,s,a,c)||this;return l.callTogglingService=d,l}return i(t,e),t.prototype.canExecuteAction=function(){var e=this.transportDependencyProviderService.getRemoteControllerConnectionHandler().remoteControllerCallState;return _.includes(null===e||void 0===e?void 0:e.capabilities.mediaControls,teamspace.services.MediaControlsCapabilities.ToggleCamera)},t.prototype.executeCommandSpecificAction=function(e){var t=this;switch(this.command){case o.CameraOff:e.isVideoOn?this.callTogglingService.toggleVideo(e,"remote",!1).then(function(){t.markSuccessful()}).catch(function(n){t.markFailureResponseOperationFailed("error "+n+" callId "+e.callId)}):this.markFailureStateAlreadySet("callId "+e.callId);break;case o.CameraOn:e.isVideoOn?this.markFailureStateAlreadySet("Video is already turned on, callId "+e.callId):this.callTogglingService.toggleVideo(e,"remote",!0).then(function(){t.markSuccessful()}).catch(function(n){t.markFailureResponseOperationFailed("error "+n+" callId "+e.callId)});break;default:this.markFailureResponseInvalidCommand()}},t}(n(38).RemoteControllerIncomingBaseCommand);t.VideoToggleCommand=r},2762:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=teamspace.services.IncomingCommand,r=function(e){function t(t,n,i,o,r,s,a,c){var d=e.call(this,n,i,o,r,s,t,a,c)||this;return d._constants=t,d._callingService=s,d}return i(t,e),t.prototype.canExecuteAction=function(){return!0},t.prototype.executeCommandSpecificAction=function(e){var t=this;this.command==o.LeaveMeeting?(this.transportDependencyProviderService.getRemoteControllerConnectionHandler().unpair(),this._callingService.leaveCall(e,this._constants.scenarios.calling.context.remoteControllerEndCallCommand).then(function(){t.markSuccessful()}).catch(function(n){t.markFailureResponseOperationFailed("error "+n+" callId "+e.callId)})):this.markFailureResponseInvalidCommand()},t}(n(38).RemoteControllerIncomingBaseCommand);t.RemoteControllerEndCallCommand=r},2763:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=function(e){function t(t,n,i,o,r,s,a,c,d){var l=e.call(this,t,n,i,r,s,a,c,d)||this;return l.endpointId=o,l}return i(t,e),t.prototype.canExecuteAction=function(){return!0},t.prototype.executeCommandSpecificAction=function(e){this.transportDependencyProviderService.getRemoteControllerSessionManager().removeSessionByEndpointId(this.endpointId),this.markSuccessful()},t}(n(38).RemoteControllerIncomingBaseCommand);t.RemoteControllerUnpairCommand=o},2764:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(2765),o=teamspace.services.OutgoingCommand,r=function(){function e(e,t,n,i){this.loggingService=e,this.constants=t,this.$q=n,this.utilityService=i,this.logger=e.newLogger("RemoteControllerOutgoingCommandFactory")}return e.prototype.generateCauseId=function(){return this.utilityService.generateUUID()},e.prototype.createCommand=function(e,t,n,r){var s;e=e.toLowerCase();var a=this.generateCauseId();switch(e){case o.Response:case o.UpdateState:case o.UpdateCapabilities:case o.Unpair:s=new i.RemoteControllerOutgoingBaseCommand(a,n,t,r,e,this.$q,this.loggingService,this.constants);break;default:return this.logger.error("Coulnd't create command "+s),r.fail({message:this.constants.transportTelemetryErrorCode.outgoingCommand.invalidCommand,message1:e}),null}return s.name=e,s.startTime=new Date,s.isRetry=!1,s.acknowledgementReceived=!1,s},e}();t.RemoteControllerOutgoingCommandFactory=r},2765:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,n,i,o,r,s,a){this.causeId=e,this.endpoint=t,this.commandDetails=n,this.sendOutgoingCommandScenario=i,this.commandName=o,this.constants=a,this.logger=s.newLogger("RemoteControllerOutgoingBaseCommand"),n.companionResponseRequired=!1,this.onResponseReceived=r.defer(),this.onCommandReadyToSend=r.defer(),this.onCommandReadyToSend.resolve(!0);var c=this.onCommandExecuted.bind(this);this.onResponseReceived.promise.then(c).catch(c)}return e.prototype.onCommandExecuted=function(e){if(!e||_.isEmpty(e))this.logger.info("Command:"+this.commandName+" causeId:"+this.causeId+" successfully executed"),this.sendOutgoingCommandScenario.stop();else if(e.errorDetails||e.errorCode){var t=e.errorDetails?e.errorDetails:"<empty error details>",n=e.errorCode?e.errorCode:this.constants.transportTelemetryErrorCode.outgoingCommand.operationFailedOnRemoteEndpoint;this.sendOutgoingCommandScenario.fail({message:n,errorMessage:t}),this.logger.error("Command:"+this.commandName+" causeId:"+this.causeId+" execution failed with errorCode:"+n+", errorDetails:"+t)}else{var i="Did not expect response from command:"+this.commandName+" causeId:"+this.causeId+": "+JSON.stringify(e);this.logger.warn(i),this.sendOutgoingCommandScenario.fail({message:this.constants.transportTelemetryErrorCode.outgoingCommand.operationFailedOnRemoteEndpoint,errorMessage:i})}},e}();t.RemoteControllerOutgoingBaseCommand=i},2766:function(e,t,n){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++){t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e}).apply(this,arguments)},o=this&&this.__rest||function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var o=0,i=Object.getOwnPropertySymbols(e);o<i.length;o++)t.indexOf(i[o])<0&&Object.prototype.propertyIsEnumerable.call(e,i[o])&&(n[i[o]]=e[i[o]]);return n};Object.defineProperty(t,"__esModule",{value:!0});var r;!function(e){e.InitState="InitState",e.IsScanRunning="IsScanRunning",e.LastKeepAliveSentForSession="LastKeepAliveSentForSession",e.IsSendingKeepAlives="IsSendingKeepAlives",e.HasConnectedDevices="HasConnectedDevices",e.HasPairedDevices="HasPairedDevices",e.PairedDeviceCount="PairedDeviceCount",e.IsContinousScanRunning="IsContinousScanRunning"}(r=t.TransportConnectionHandlerStates||(t.TransportConnectionHandlerStates={}));var s=function(){function e(e,t,n,i,o,r,s,a,c,d,l,m){this.transportDependencyProviderService=e,this.transportCommandRouter=t,this.constants=n,this.storageService=i,this.bluetoothLEService=o,this.loggingService=r,this.settingsService=s,this.myUserPreferencesStore=a,this.$q=c,this.authenticationService=d,this.utilityService=l,this.appStateService=m,this.keepAliveInterval=3e4,this.deviceNotFoundThreshold=15e3,this.continousScanInterval=18e3,this.currentSalt=0,this.ComponentName="TransportConnectionHandler",this.disableProximityScan=!1,this.keepAliveTimer=void 0,this.logger=r.newLogger(this.ComponentName),this.logger.info("connectionHandler object successfully created, initialization is still pending.")}return e.prototype.initializeConnectionHandler=function(){var t=this;this.logger.info("initializing states and Ipc listeners, and rehydrating previous connection.");var n=void 0;if(this.settingsService.valueAsBoolean(this.constants.settings.names.enableUserPreferenceStoreForBetterTogether)){var i=this.loggingService.newScenario(this.constants.scenarios.betterTogether.connectionHandler.userPreferenceStoreInitialized,null,null,null,!0);n=this.myUserPreferencesStore.getUserPreferences().pairedTransportCompanionDevices,i.stop(),this.logger.info("initializeConnectionHandler -- Fetched stored paired devices from user preference "+JSON.stringify(this.stripPIIFromPairedDevices(n)))}n||(n=this.storageService.get(e.BTPairedDevicesKey),this.logger.info("initializeConnectionHandler -- Fetched stored paired devices from storage service "+JSON.stringify(this.stripPIIFromPairedDevices(n))),n?this.settingsService.valueAsBoolean(this.constants.settings.names.enableUserPreferenceStoreForBetterTogether)&&this.updateStoredPairedDevices(n):n=[]),n&&n.forEach(function(e){e.connectionStatus=teamspace.services.PairedConnectionStatus.PairedNotConnected}),this.pairedDevices=n,this.setupInitialStates(),this.setupIpcForMachineState(),this.ipcRenderer?(this.ipcRenderer.once(this.constants.events.desktopApp.getLockState,function(e,n){t.logger.info("state of machine is "+n),n===t.constants.desktopApp.lockState.unlocked&&(t.logger.info("machine is in unlocked state."),t.rehydratePreviousConnection(!1,"TransportConnectionHandler is initialized"))}),this.ipcRenderer.send(this.constants.events.desktopApp.getLockState)):this.logger.error("ipcRenderer is not available"),this.disableProximityScan=this.settingsService.valueAsBoolean(this.constants.settings.names.disableBetterTogetherProximityScan),this.states.set(r.InitState,teamspace.services.ITransportComponentState.Initialized),this.logger.info("connectionHandler successfully initialized")},e.prototype.updateStoredPairedDevices=function(t){if(t){var n=t.map(function(e){e.connectionStatus;return o(e,["connectionStatus"])});this.settingsService.valueAsBoolean(this.constants.settings.names.enableUserPreferenceStoreForBetterTogether)&&this.myUserPreferencesStore.setUserPreference(SkypeX.Services.MyUserPreferenceStorageKey.PairedTransportCompanionDevices,JSON.stringify(n)),this.storageService.set(e.BTPairedDevicesKey,n)}},e.prototype.onNewDevicePaired=function(t){this.logger.info("onNewDevicePaired -- Caching new device paired: "+JSON.stringify(t));var n;this.pairedDevices&&(n=this.pairedDevices.filter(function(e){return e.endPointId!==t.endPointId})),this.pairedDevices=n?n.concat(t):[t],this.logger.info("onNewDevicePaired -- Paired devices: "+JSON.stringify(this.stripPIIFromPairedDevices(this.pairedDevices))),this.updateStoredPairedDevices(this.pairedDevices),this.storageService.set(e.LastPairedDeviceEndpointKey,t.endPointId),this.storageService.set(this.constants.storageNames.transportCompanionSelected,!0),this.transportDependencyProviderService.setPairedDeviceInDeviceManager(!0),this.setupKeepAlive(t.endPointId,t.endpointSignature)},e.prototype.onDeviceUnpaired=function(t){if(this.pairedDevices){var n=this.pairedDevices.find(function(e){return e.endPointId===t});if(n)return n.connectionStatus===teamspace.services.PairedConnectionStatus.Connected&&(this.disconnect(!0,!1,"device unpaired",!0),this.storageService.set(e.LastPairedDeviceEndpointKey,""),this.storageService.set(e.LastSaltUpdateTimeKey,"0")),this.pairedDevices=this.pairedDevices.filter(function(e){return e.endPointId!==t}),this.updateStoredPairedDevices(this.pairedDevices),this.transportDependencyProviderService.setPairedDeviceInDeviceManager(!0),this.logger.info("onDeviceUnpaired -- Device unpaired with endpointId: "+t+"; Paired devices: "+JSON.stringify(this.stripPIIFromPairedDevices(this.pairedDevices))),!0;this.logger.error("onDeviceUnpaired -- Cannot unpair endpointId: "+t+"; Matching endpointId not found in list of pairedDevices.")}else this.logger.error("onDeviceUnpaired -- Cannot unpair endpointId: "+t+"; No Paired devices found.");return!1},e.prototype.unpairDevice=function(e){var t=this.pairedDevices;if(t&&t.find(function(t){return t.endPointId===e})){var n=this.getCommandDetails();this.transportCommandRouter.sendOutgoingCommand(teamspace.services.OutgoingCommand.Unpair,n,e),this.onDeviceUnpaired(e)}},e.prototype.onDeviceLocked=function(t){if(!t)return this.logger.error("Cannot mark device as locked, endpointid is null"),!1;if(this.pairedDevices){var n=this.pairedDevices.find(function(e){return e.endPointId===t});if(n)return n.connectionStatus=teamspace.services.PairedConnectionStatus.Locked,this.storageService.set(e.LastPairedDeviceEndpointKey,n.endPointId),this.transportDependencyProviderService.setPairedDeviceInDeviceManager(!1),this.logger.info("Paired device status set to: locked"),!0;this.logger.error("Device not found in list of pairedDevices")}else this.logger.error("No paired devices found");return!1},e.prototype.onDeviceUnlocked=function(t){if(!t)return this.logger.error("Cannot mark device as unlocked, endpointid is null"),!1;if(this.pairedDevices){var n=this.pairedDevices.find(function(e){return e.endPointId===t});if(n)return n.connectionStatus=teamspace.services.PairedConnectionStatus.Connected,this.storageService.set(e.LastPairedDeviceEndpointKey,n.endPointId),this.transportDependencyProviderService.setPairedDeviceInDeviceManager(!1),this.logger.info("Paired device status set to: unlocked and connected"),!0;this.logger.error("Device not found in list of pairedDevices")}else this.logger.error("Device unlocked but no paired devices found");return!1},e.prototype.onUpdateEndpoint=function(e,t){if(!this.pairedDevices)return this.logger.error("onUpdateEndpoint -- No paired devices found. previousEndpointId - "+e+", newEndpointId - "+t.endPointId),!1;var n=this.pairedDevices.find(function(t){return t.endPointId===e});if(!n)return this.logger.error("onUpdateEndpoint -- Device not found in list of pairedDevices. previousEndpointId - "+e+", newEndpointId - "+t.endPointId),!1;this.logger.info("onUpdateEndpoint -- Updating for "+JSON.stringify(t)),t.endpointSignature||(n.endpointSignature=void 0);var i=n.endPointId!==t.endPointId;for(var o in t)n[o]=t[o];return this.logger.info("onUpdateEndpoint -- Paired devices updated to "+JSON.stringify(this.stripPIIFromPairedDevices(this.pairedDevices))),this.updateStoredPairedDevices(this.pairedDevices),i&&(this.logger.info("onUpdateEndpoint -- EndpointId changed, stopping old session with previousEndpointId - "+e+" and starting new session with "+t.endPointId),this.transportCommandRouter.endSession(e),this.transportCommandRouter.startSession(t.endPointId)),!0},e.prototype.getConnectedDevice=function(){var e=this.getAllPairedDevices();if(e)return e.find(function(e){return e.connectionStatus===teamspace.services.PairedConnectionStatus.Connected})},e.prototype.continousCheckProximity=function(e){var t=this;void 0===e&&(e=!1),this.continousCheckProximityInterval?this.logger.error("A continous check for proximity is already running, isReconnectCallback is - "+e):(this.continousCheckProximityDeferred=this.checkProximity(),e?this.continousCheckProximityDeferred.promise.then(this.reconnectCallback):this.continousCheckProximityDeferred.promise.catch(function(){t.logger.info("checkProximity failed, dont have a reconnectCallback function")}),this.continousCheckProximityInterval=setInterval(function(){t.continousCheckProximityDeferred=t.checkProximity(),e?t.continousCheckProximityDeferred.promise.then(t.reconnectCallback):t.continousCheckProximityDeferred.promise.catch(function(){t.logger.info("checkProximity failed, dont have a reconnectCallback function"),t.transportDependencyProviderService.setPairedDeviceInDeviceManager(!0)})},this.continousScanInterval))},e.prototype.checkProximity=function(e,t){var n=this;this.logger.info("Attempting Proximity check");var i=this.$q.defer(),o=this.bluetoothLEService;return this.transportDependencyProviderService.canInitializeTransport()?this.disableProximityScan?(i.resolve(!0),i):(teamspace.services.QCancelable.toCancelablePromise(this.$q,o.onceInitialized()).then(function(){if(!o.isBLEsupported||!o.isBluetoothRadioOn){var s="Bluetooth scan was not started. BLE might not be supported";return n.logger.error(s),i.reject(s),i}n.logger.info("Scan started for better together companion devices."),n.states.set(r.IsScanRunning,!0);var a,c=setTimeout(function(){o.unsubscribe(a),n.logger.log("Unsubscribed for blehandle "+a+" due to timeout."),i.resolve(!1),n.logger.error("Timeout reached. Device not found. Scan stopped"),n.states.set(r.IsScanRunning,!1)},n.deviceNotFoundThreshold);a=o.subscribe(function(o,r){n.onCompanionDevicesFound(r,i,a,c,e,t)},n.constants.events.bluetoothLE.adjacent,n.constants.events.bluetoothLE.companionDiscovery)}).catch(function(e){e="Bluetooth scan was not started. BLE might not be supported due to error - "+e.toString(),n.logger.error(e),i.reject(e),n.states.set(r.IsScanRunning,!1)}),i):(i.reject("transportation can not be initialised"),i)},e.prototype.verifySalt=function(e){return e.salt[0]===this.currentSalt||!!e.salt[1]&&e.salt[1]===this.currentSalt||this.disableProximityScan},e.prototype.getCommandDetails=function(){return{salt:[this.currentSalt]}},e.prototype.getResponseDetails=function(){return{salt:[this.currentSalt]}},e.prototype.getStates=function(){var e=this.getAllPairedDevices(),t=this.getConnectedDevice();return this.states.set(r.HasConnectedDevices,!!t),this.states.set(r.HasPairedDevices,e&&e.length>0),this.states.set(r.PairedDeviceCount,e?e.length:0),this.states},e.prototype.setupInitialStates=function(){this.states=new Map,this.states.set(r.InitState,teamspace.services.ITransportComponentState.Uninitialized),this.states.set(r.IsScanRunning,!1),this.states.set(r.LastKeepAliveSentForSession,""),this.states.set(r.IsSendingKeepAlives,!1)},e.prototype.getAllPairedDevices=function(){return _.cloneDeep(this.pairedDevices)},e.prototype.rehydratePreviousConnection=function(t,n){var o=this,r=this.pairedDevices;if(r&&r.length>0){this.logger.info("Rehydrating transport connection"),this.setAllPairedDevicesAsDisconnected(!1);var s=this.storageService.get(e.LastSaltUpdateTimeKey);if((s=(new Date).getTime()-s)<6e4&&t){var a=this.storageService.get(e.LastPairedDeviceEndpointKey);this.logger.info("sending unlock command using quick strategy, lastSaltUpdateTime is "+s+", reason - "+n);var c=i({reason:"sending unlock command using quick strategy, lastSaltUpdateTime is "+s+", reason - "+n},this.getCommandDetails()),d=this.transportCommandRouter.sendOutgoingCommand(teamspace.services.OutgoingCommand.Unlock,c,a);if(!d){var l="unlock command not created for quick unlock strategy, trying with long unlock strategy, reason - "+n;this.logger.error(l),this.reconnectCallback=this.findProximalDeviceAndReconnect.bind(this,l),this.continousCheckProximity(!0)}d.promise.then(function(){o.logger.info("Unlock succeeded with quick unlock strategy"),o.reconnect(a,!1)}).catch(function(e){var t="unlock command failed due to error - "+JSON.stringify(e)+" in quick unlock strategy, reason - "+n;o.logger.error(t),o.reconnectCallback=o.findProximalDeviceAndReconnect.bind(o,t),o.continousCheckProximity(!0)})}else{var m="salt is not updated, trying to unlock by long unlock strategy, reason - "+n;this.logger.info(m),this.reconnectCallback=this.findProximalDeviceAndReconnect.bind(this,m),this.continousCheckProximity(!0)}}},e.prototype.onCompanionDevicesFound=function(e,t,n,i,o,s){var a=this;if(e){var c=e.data,d=!!this.settingsService.valueAsBoolean(this.constants.settings.names.enableBetterTogetherEndpointSignature);this.authenticationService.getUserInformation().then(function(e){var l=a.utilityService.packetGUID2String(c),m=a.pairedDevices,p=!1,g=a.loggingService.newScenario(a.constants.scenarios.betterTogether.connectionHandler.endpointMatched,null,null,null,!0);try{p=a.hasEndpointsMatched(a.utilityService,d,c,m,o,s),g.stop({endPointId:o,reason:"endpointMatched: "+p+". endpointSignature: "+s+", payloadOid: "+l+", Beacon Length: "+c.byteLength})}catch(e){g.fail({endPointId:o,reason:"endpointMatched: false, error - "+e+". endpointSignature: "+s+", payloadOid: "+l+", Beacon Length: "+c.byteLength})}e.profile.oid===l&&p&&(a.logger.info("Better together companion device found and bleHandle is "+n+". Unsubscribing now"),a.bluetoothLEService.unsubscribe(n),a.updateSalt(c,o),clearTimeout(i),a.states.set(r.IsScanRunning,!1),t.resolve(!0))}).catch(function(e){a.logger.error("device with incorrect authentication sent payload"+e)})}},e.prototype.hasEndpointsMatched=function(e,t,n,i,o,r){var s=e.packetGUID2String(n);this.logger.info("hasEndpointsMatched -- Matching for endpointId = "+o+", endpointSignature = "+r+", payloadOid: "+s);var a=new DataView(n.buffer),c=t?a.getInt16(19,!0):null;if(t&&void 0!==r&&c===r)return this.logger.info("hasEndpointsMatched -- endpointSignature matched."),!0;if(o){l=e.convertGUIDString2Uint8Array(o);if(n[19]===l[15]&&n[20]===l[14])return this.logger.info("hasEndpointsMatched -- endpointId's matched."),!0}else if(i&&i.length>0){this.logger.info("hasEndpointsMatched -- Paired devices: "+JSON.stringify(this.stripPIIFromPairedDevices(i)));for(var d=0;d<i.length;d++){if(t&&i[d].endpointSignature&&c===i[d].endpointSignature)return this.logger.info("hasEndpointsMatched -- endpointSignature matched for paired devices."),!0;if(i[d].endPointId){var l=e.convertGUIDString2Uint8Array(i[d].endPointId);if(n[19]===l[15]&&n[20]===l[14])return this.logger.info("hasEndpointsMatched -- endpointId matched for paired devices."),!0}}}return!1},e.prototype.findProximalDeviceAndReconnect=function(e,t){var n=this;if(t&&!this.appStateService.hasMachineState(teamspace.services.MachineState.MachineLocked)){this.logger.info("Paired device in proximity. Will attempt keep alive to all paired devices");var i=this.pairedDevices;i&&0!==i.length&&i.forEach(function(t){n.logger.info("Sending keep alive to get status from "+t.endPointId);var i=n.transportCommandRouter.sendOutgoingCommand(teamspace.services.OutgoingCommand.KeepAlive,n.getCommandDetails(),t.endPointId);i&&i.promise.then(function(i){n.logger.info("Keep alive successful from "+t.endPointId),n.reconnect(t.endPointId,!0,"keepAlive successful, reason - "+e),n.states.set(r.LastKeepAliveSentForSession,new Date)})})}},e.prototype.reconnect=function(e,t,n){var o=this;if(this.appStateService.hasMachineState(teamspace.services.MachineState.MachineLocked))return this.logger.info("machine is in locked state, cancelling reconnect."),{result:!1,errorCode:this.constants.transportTelemetryErrorCode.incomingCommand.desktopIsLocked};this.logger.info("Reconnecting to endpoint "+e);var r=this.pairedDevices.find(function(t){return t.endPointId===e});if(!r)return{result:!1,errorCode:this.constants.transportTelemetryErrorCode.incomingCommand.deviceNotPaired};var s=this.$q.defer();if(t){var a=i({reason:"trying to send a unlock command from reconnect function, reason - "+n},this.getCommandDetails());s=this.transportCommandRouter.sendOutgoingCommand(teamspace.services.OutgoingCommand.Unlock,a,e)}else s.resolve();return s.promise.then(function(){o.onDeviceUnlocked(e),o.transportCommandRouter.startSession(e),o.setupKeepAlive(e,r.endpointSignature),o.cleanUpContinousProximityScan()}),{result:!0}},e.prototype.disconnect=function(t,n,o,s){var a=this;this.logger.info("Disconnecting from paired device.");var c=this.pairedDevices,d=c?c.find(function(e){return e.connectionStatus===teamspace.services.PairedConnectionStatus.Connected}):void 0;if(d){if(clearInterval(this.keepAliveTimer),this.keepAliveTimer=void 0,this.keepAliveDeferred&&this.keepAliveDeferred.reject(e.KeepAliveCancelled),this.states.set(r.IsSendingKeepAlives,!1),t)this.transportCommandRouter.endSession(d.endPointId);else{var l=i({reason:"sending lock command from disconnect function, reason - "+o},this.getCommandDetails());this.transportCommandRouter.sendOutgoingCommand(teamspace.services.OutgoingCommand.Lock,l).promise.finally(function(){a.transportCommandRouter.endSession(d.endPointId)})}d.connectionStatus=teamspace.services.PairedConnectionStatus.PairedNotConnected,this.storageService.set(e.LastPairedDeviceEndpointKey,d.endPointId),this.setAllPairedDevicesAsDisconnected(s),n&&this.keepScanOn()}},e.prototype.setAllPairedDevicesAsDisconnected=function(e){this.pairedDevices.forEach(function(e){e.connectionStatus=teamspace.services.PairedConnectionStatus.PairedNotConnected}),this.transportDependencyProviderService.setPairedDeviceInDeviceManager(e)},e.prototype.onProximityLost=function(){this.logger.error("Proximity lost. Stopping keep alive and starting continous scan for autopair"),this.disconnect(!1,!1,"On proximity lost.",!0),this.rehydratePreviousConnection(!1,"On proximity lost")},e.prototype.setupKeepAlive=function(t,n){var i=this;this.keepAliveTimer||(this.logger.info("Setting up keep alive"),this.states.set(r.IsSendingKeepAlives,!0),this.keepAliveTimer=setInterval(function(){i.sendKeepAlive(t,n).promise.catch(function(o){i.logger.error("keep alive failed for 1st time - error "+o),o!==e.KeepAliveCancelled&&i.onKeepAliveCheckFailed(t,n)})},this.keepAliveInterval))},e.prototype.onKeepAliveCheckFailed=function(t,n){var i=this;clearInterval(this.keepAliveTimer),this.keepAliveTimer=void 0,this.sendKeepAlive(t,n).promise.then(function(){i.setupKeepAlive(t,n)}).catch(function(t){t!==e.KeepAliveCancelled&&(i.logger.error("Proximity lost, KeepAlive failed 2 times."),i.onProximityLost())})},e.prototype.sendKeepAlive=function(e,t){var n=this;return this.keepAliveDeferred=this.$q.defer(),this.logger.info("checking proximity when trying to send keepAlive command"),this.checkProximity(e,t).promise.then(function(t){if(t){var i=n.getCommandDetails(),o=n.transportCommandRouter.sendOutgoingCommand(teamspace.services.OutgoingCommand.KeepAlive,i,e);n.states.set(r.LastKeepAliveSentForSession,new Date),o.promise.then(function(){n.keepAliveDeferred.resolve("keepAlive successfull")}).catch(function(e){n.logger.error("keepAlive command failed, because of error - "+JSON.stringify(e)),n.keepAliveDeferred.reject("keepAlive command failed, because of error - "+JSON.stringify(e))})}else n.keepAliveDeferred.reject("checkProximity failed, device not in proximity")}).catch(function(e){n.keepAliveDeferred.reject("sending keepAlive failed with error - "+e)}),this.keepAliveDeferred},e.prototype.updateSalt=function(t,n){if(t.length>18){var i=t[18]<<8|t[17];if(this.currentSalt!==i){this.logger.info("Salt updated. previous salt - "+this.currentSalt+", new salt - "+i+", endpointId: "+(n||null)),this.currentSalt=i;var o=new Date;this.storageService.set(e.LastSaltUpdateTimeKey,o.getTime())}}},e.prototype.keepScanOn=function(){this.logger.log("Starting continous scan for keeping scan on for quick unlock strategy"),this.continousCheckProximity()},e.prototype.setupIpcForMachineState=function(){var e=this;this.ipcRenderer=window.electronSafeIpc,this.isConsecutiveLock=!1,this.ipcRenderer&&this.transportDependencyProviderService.canInitializeTransport()?(this.ipcEventHandler=function(t,n){n!==e.constants.events.desktopApp.machineLock||e.isConsecutiveLock?n===e.constants.events.desktopApp.machineUnlock&&(e.isConsecutiveLock=!1,e.logger.info("Got machine unlocked event"),e.cleanUpContinousProximityScan(),e.rehydratePreviousConnection(!0,"Got machine unlocked event")):(e.isConsecutiveLock=!0,e.logger.info("Got machine locked event"),e.cleanUpContinousProximityScan(),e.disconnect(!1,!0,"Got machine locked event",!1))},this.ipcEventHandler=this.ipcEventHandler.bind(this),this.ipcRenderer.on(this.constants.events.desktopApp.machineInactiveResponse,this.ipcEventHandler),this.ipcRenderer.on(this.constants.desktopApp.powerMonitor.suspend,function(){!e.isConsecutiveLock&&e.settingsService.valueAsBoolean(e.constants.settings.names.enableBetterTogetherLockonAppSuspend)&&(e.isConsecutiveLock=!0,e.logger.info("Got machine suspended event"),e.loggingService.newScenario(e.constants.scenarios.betterTogether.connectionHandler.machineSuspend,null,null,null,!0).stop(),e.cleanUpContinousProximityScan(),e.disconnect(!1,!0,"Got machine suspended event",!1))})):this.logger.error("ipcRenderer is not defined.")},e.prototype.cleanUpConnectionHandler=function(){this.logger.info("clean up of connectionHandler has been called. disconnecting the current device and removing all listeners to ipcRenderer"),this.disconnect(!1,!1,"cleanup of connectionHandler has been called.",!0),this.cleanUpContinousProximityScan(),this.ipcRenderer.removeListener(this.constants.events.desktopApp.machineInactiveResponse,this.ipcEventHandler),this.transportCommandRouter=void 0},e.prototype.cleanUpContinousProximityScan=function(){var e="cleaning up continousProximityScan related promise and bleHandle.";this.logger.info(e),clearInterval(this.continousCheckProximityInterval),this.continousCheckProximityDeferred&&this.continousCheckProximityDeferred.reject(e),this.continousCheckProximityInterval=void 0},e.prototype.stripPIIFromPairedDevices=function(e){return e&&e.map(function(e){e.deviceName;return o(e,["deviceName"])})},e.BTPairedDevicesKey="BTPairedDevices",e.KeepAliveCancelled="keepAlive deferred cancelled in disconnect function.",e.LastSaltUpdateTimeKey="LastSaltUpdateTime",e.LastPairedDeviceEndpointKey="LastPairedDeviceEndpoint",e}();t.TransportConnectionHandler=s},2767:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(2768),o=teamspace.services.OutgoingCommand,r=function(){function e(e,t,n,i,o,r,s,a){this.transportDependencyProviderService=e,this.devicesBLEService=t,this.loggingService=n,this.callTogglingService=i,this.$rootScope=o,this.constants=r,this.callingService=s,this.meetingRoomUbarService=a,this.ComponentName="RemoteControllerConnectionHandler",this._isRemoteControllerUserEnabled=!0,this.logger=n.newLogger(this.ComponentName),this.logger.info("remoteControllerConnectionHandler object successfully created."),this.connectedEndpoints=[],this.userEnableSubscription=o.$on(r.events.remoteController.userEnabled,this.updateRemoteControl.bind(this)),a.isInCallHybridMode?this._isRemoteControllerUserEnabled=a.isRoomRemoteUserEnabled:o.$emit(r.events.remoteController.getUserEnabledState)}return e.prototype.cleanup=function(){this.userEnableSubscription()},e.prototype.verifySalt=function(e){var t;if(!e.salt||0===e.salt.length)return this.logger.error("Salt field is missing."),!1;var n=this.ToUInt16(e.salt[0]);return this.logger.info("Received salt uint16Salt:"+n+", current MTR salt "+(null===(t=this.devicesBLEService.pvService)||void 0===t?void 0:t.getSalt())),this.devicesBLEService.isSaltValid(n)},e.prototype.getConnectedEndpoints=function(){return this.connectedEndpoints},e.prototype.onNewEndpointPaired=function(e){var t=e.getEndpointId();this.logger.info(this.onNewEndpointPaired.name+": endpoint="+t),this.connectedEndpoints.find(function(e){return e.getEndpointId()===t})&&(this.logger.error("There is already a paired device with this endpoint="+t+". Removing the older one."),this.onEndpointUnpaired(t)),this.connectedEndpoints.push(e),this.markCurrentlyPaired(t)},e.prototype.onEndpointUnpaired=function(e){var t=this;this.logger.info(this.onEndpointUnpaired.name+": endpoint="+e),this.connectedEndpoints=this.connectedEndpoints.filter(function(n){return n.getEndpointId()!==e||(t.logger.info("Removing device from the list of currently paired remote controllers with endpointId="+e),!1)}),this.markCurrentlyPaired(e,!1)},Object.defineProperty(e.prototype,"remoteControllerCallState",{get:function(){var e=this;return this.activeCall||this._remoteControllerCallState||(this.activeCall=this.callingService.getActiveCall(),this._remoteControllerCallState=new i.RemoteControllerCallState(this.activeCall,this.transportDependencyProviderService,this.loggingService,this.callTogglingService,this.$rootScope,this.constants,this.meetingRoomUbarService),this.activeCallSubscription=this.activeCall.on("callStateChanged",function(){return e.onCallStateChanged(e.activeCall)})),this._remoteControllerCallState},enumerable:!0,configurable:!0}),e.prototype.sendUpdateState=function(e){this.sendOutgoingCommand(o.UpdateState,e)},e.prototype.sendUpdateCapabilities=function(e){this.sendOutgoingCommand(o.UpdateCapabilities,e)},e.prototype.unpair=function(){this.sendOutgoingCommand(o.Unpair,{})},e.prototype.sendOutgoingCommand=function(e,t){var n=this,i=this.transportDependencyProviderService.getTransportCommandRouter();this.connectedEndpoints.forEach(function(r){var s=r.getEndpointId();n.logger.info("Sending outgoing command "+e+" to endpoint: "+s+"...");var a={};a.commandDetails=t,i.sendOutgoingCommand(e,a,s).promise.then(function(){n.logger.info("Sending outgoing command:"+e+" to endpoint: "+s+" succeeded")}).catch(function(t){n.logger.error("Sending outgoing command:"+e+" to endpoint: "+s+" failed with "+t+".")}).finally(function(){e===o.Unpair&&n.transportDependencyProviderService.getRemoteControllerSessionManager().removeSessionByEndpointId(s)})})},Object.defineProperty(e.prototype,"isRemoteControllerUserEnabled",{get:function(){return this._isRemoteControllerUserEnabled},enumerable:!0,configurable:!0}),e.prototype.updateRemoteControl=function(e,t){this.logger.info("Receive RemoteController "+this.constants.events.remoteController.userEnabled+" event, isOn="+t+" "),this._isRemoteControllerUserEnabled===t?this.logger.info("RemoteController state was already "+this._isRemoteControllerUserEnabled):(this._isRemoteControllerUserEnabled=t,t||this.unpair())},e.prototype.onCallStateChanged=function(e){7===e.state&&(this.unpair(),this.connectedEndpoints=[],this.disconnectListeningFromActiveCall())},e.prototype.disconnectListeningFromActiveCall=function(){this.activeCallSubscription.dispose(),this.activeCall=null,this._remoteControllerCallState.dispose(),this._remoteControllerCallState=null},e.prototype.markCurrentlyPaired=function(e,t){void 0===t&&(t=!0),this.logger.info("Currently connected endpoints="+this.connectedEndpoints.length),this.loggingService.newScenario(this.constants.scenarios.betterTogether.remoteController.pairedDevicesCount,null,null,null,!0).stop({source:""+(t?this.constants.scenarios.betterTogether.remoteController.onPair:this.constants.scenarios.betterTogether.remoteController.onUnpair),message:"endpoint:"+e+", pairedDevices:"+this.connectedEndpoints.length})},e.prototype.ToUInt16=function(e){return 65535&e},e}();t.RemoteControllerConnectionHandler=r},2768:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i,o=teamspace.services.CallClosedCaptionStatus,r=teamspace.shared.RigelLayoutType,s=teamspace.components.Calling.CustomLayoutSelection,a=teamspace.services.TeamsCallService,c=teamspace.services.CallTogglingService,d=teamspace.services.MediaControlsCapabilities,l=teamspace.services.MeetingControlsCapabilities,m=teamspace.services.StageLayoutControlsCapabilities,p=teamspace.shared.RoomRemoteLayoutType;!function(e){e.ToggleMute="toggleMute",e.ToggleCamera="toggleCamera",e.ToggleCaptions="toggleCaptions",e.StageLayoutControls="stageLayoutControls"}(i=t.UpdateCapabilities||(t.UpdateCapabilities={}));var g=function(){function e(e,t,n,i,o,r,s){var d=this;this.activeCall=e,this.transportDependencyProvider=t,this.callTogglingService=i,this.$rootScope=o,this.constants=r,this.meetingRoomUbarService=s,this.currentStageLayout=m.ShowVideoGallery,this.lastGalleryStage=m.ShowVideoGallery,this.capabilityBuffer=void 0,this.EnableString="enable",this.DisableString="disable",this.logger=n.newLogger("RemoteControllerCallState"),this.audioCompletedSubscription=i.subscribe(this.sendStateUpdateCommand.bind(this),c.Type_CallTogglingAudioCompleted,a.getTeamsCallIdAsString(e.teamsCallId)),this.videoCompletedSubscription=i.subscribe(this.sendStateUpdateCommand.bind(this),c.Type_CallTogglingOutgoingVideoCompleted,a.getTeamsCallIdAsString(e.teamsCallId)),this.closedCaptionsStatusChangedSubScription=e.on("closedCaptionsStatusChanged",this.sendStateUpdateCommand.bind(this)),this.wholeStateUpdateSubscription=o.$on(r.events.remoteController.wholeStateUpdate,this.wholeStateUpdate.bind(this)),s.isInCallHybridMode?(this.meetingRoomLocalSelectedLayoutSubscription=o.$on(r.events.calling.meetingRoomLocalSelectedLayoutChanged,this.localLayoutUpdate.bind(this)),this.wholeStateUpdate(void 0,s.stateMap)):(this.userSelectedLayoutSubscription=o.$on(r.events.rigel.service.eventTypes.userSelectedLayout,this.updateStageLayout.bind(this)),this.callingScreenGalleryTypeChangedSubscription=o.$on(r.events.calling.callingScreenGalleryTypeChanged,this.updateScreenGalleryType.bind(this)),this.allHandlersStateUpdateSubscription=o.$on(r.events.remoteController.handlerStateUpdate,function(e,t,n){return d.updateCapability(t,n)}),o.$emit(r.events.remoteController.subscribeHandlersStateUpdate))}return e.prototype.dispose=function(){this.logger.info("Disposing RemoteControllerCallState object."),this.$rootScope.$emit(this.constants.events.remoteController.unsubscribeHandlersStateUpdate),this.callTogglingService.unsubscribe(this.audioCompletedSubscription),this.callTogglingService.unsubscribe(this.videoCompletedSubscription),this.meetingRoomUbarService.isInCallHybridMode?this.meetingRoomLocalSelectedLayoutSubscription():(this.userSelectedLayoutSubscription(),this.callingScreenGalleryTypeChangedSubscription(),this.allHandlersStateUpdateSubscription()),this.wholeStateUpdateSubscription(),this.closedCaptionsStatusChangedSubScription.dispose()},Object.defineProperty(e.prototype,"state",{get:function(){var e={};return e.toggleMute=this.callTogglingService.isMuted(this.activeCall),e.toggleCamera=this.activeCall.isVideoOn,e.toggleCaptions=this.activeCall.getClosedCaptionStatus()===o.started,e.stageLayout=this.currentStageLayout,e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"capabilities",{get:function(){var e={};return e.mediaControls=this.mediaControlsCapability,e.stageLayoutControls=this.stageLayoutControlsCapabilities,e.meetingControls=this.meetingControlsCapability,e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"mediaControlsCapability",{get:function(){var e=[];return this.toggleMuteCapability&&e.push(d.ToggleMute),this.toggleCameraCapability&&e.push(d.ToggleCamera),this.toggleCaptionsCapability&&e.push(d.ToggleCaptions),e.push(d.Volume),e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"meetingControlsCapability",{get:function(){return[l.LeaveMeeting]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stageLayoutControlsCapabilities",{get:function(){var e=[];return e.push(m.ShowVideoGallery),this.showContentCapability&&(e.push(m.ShowContent),e.push(m.ShowVideoGalleryAndContent)),this.showLargeGalleryCapability&&e.push(m.ShowLargeGallery),this.showTogetherCapability&&e.push(m.ShowTogether),e},enumerable:!0,configurable:!0}),e.prototype.wholeStateUpdate=function(e,t){var n=this;t.forEach(function(e,t,i){n.updateCapability(t,e)})},e.prototype.updateCapability=function(t,n){var i,o,r=n.visible&&!n.disabled;switch(t){case this.constants.ubarButtonIds.video:i=this.toggleCameraCapability,this.toggleCameraCapability=r,o=d.ToggleCamera;break;case this.constants.ubarButtonIds.microphone:i=this.toggleMuteCapability,this.toggleMuteCapability=r,o=d.ToggleMute;break;case this.constants.ubarButtonIds.closedCaptions:i=this.toggleCaptionsCapability,this.toggleCaptionsCapability=r,o=d.ToggleCaptions;break;case this.constants.ubarButtonIds.gridSwitchLayout:i=this.showLargeGalleryCapability,this.showLargeGalleryCapability=r,o=m.ShowLargeGallery;break;case this.constants.ubarButtonIds.audienceSwitchLayout:i=this.showTogetherCapability,this.showTogetherCapability=r,o=m.ShowTogether;break;case this.constants.ubarButtonIds.gallerySwitchLayout:break;case this.constants.ubarButtonIds.layoutSwitch:i=this.showContentCapability,this.showContentCapability=r,o=m.ShowContent;break;default:this.logger.warn("Received update for "+t+" with value "+r+", but "+e.name+" does not track it.")}o&&r!=i&&this.sendCapabilitiesUpdateCommand(o)},e.prototype.updateStageLayout=function(e,t){switch(t){case r.None:case r.Gallery:this.currentStageLayout=this.lastGalleryStage;break;case r.Content:this.currentStageLayout=m.ShowContent;break;case r.ContentWithGallery:this.currentStageLayout=m.ShowVideoGalleryAndContent}this.sendStateUpdateCommand()},e.prototype.updateScreenGalleryType=function(e,t){switch(t){case s.Audience:this.currentStageLayout=m.ShowTogether;break;case s.Grid:this.currentStageLayout=m.ShowVideoGallery;break;case s.LargeGrid:this.currentStageLayout=m.ShowLargeGallery}this.lastGalleryStage=this.currentStageLayout,this.sendStateUpdateCommand()},e.prototype.localLayoutUpdate=function(e,t){switch(t){case p.Audience:this.currentStageLayout=m.ShowTogether,this.lastGalleryStage=this.currentStageLayout;break;case p.LargeGrid:this.currentStageLayout=m.ShowLargeGallery,this.lastGalleryStage=this.currentStageLayout;break;case p.Grid:this.currentStageLayout=m.ShowVideoGallery,this.lastGalleryStage=this.currentStageLayout;break;case p.PeopleOnly:this.currentStageLayout=this.lastGalleryStage;break;case p.ContentAndPeople:this.currentStageLayout=m.ShowVideoGalleryAndContent;break;case p.ContentOnly:this.currentStageLayout=m.ShowContent}this.sendStateUpdateCommand()},e.prototype.sendStateUpdateCommand=function(){this.transportDependencyProvider.getRemoteControllerConnectionHandler().sendUpdateState(this.state)},e.prototype.sendCapabilitiesUpdateCommand=function(e){var t=this;switch(this.capabilityBuffer||(this.capabilityBuffer={},setTimeout(function(){var e=t.capabilityBuffer;t.capabilityBuffer=void 0,t.transportDependencyProvider.getRemoteControllerConnectionHandler().sendUpdateCapabilities(e),t.sendStateUpdateCommand()},200)),e){case d.ToggleCamera:this.capabilityBuffer[i.ToggleCamera]=this.toggleCameraCapability?this.EnableString:this.DisableString;break;case d.ToggleMute:this.capabilityBuffer[i.ToggleMute]=this.toggleMuteCapability?this.EnableString:this.DisableString;break;case d.ToggleCaptions:this.capabilityBuffer[i.ToggleCaptions]=this.toggleCaptionsCapability?this.EnableString:this.DisableString;break;case m.ShowVideoGallery:case m.ShowContent:case m.ShowVideoGalleryAndContent:case m.ShowLargeGallery:case m.ShowTogether:this.capabilityBuffer[i.StageLayoutControls]=this.stageLayoutControlsCapabilities}},e}();t.RemoteControllerCallState=g},2769:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(t,n,i,o,r,s,a,c){this.transportDependencyProviderService=t,this.transportStack=n,this.transportUser=i,this.utilityService=o,this.settingsService=r,this.constants=s,this.loggingService=a,this.$q=c,this.sessionsEndpointMap=new Map,this.pendingPairingPromises=new Map,this.logger=a.newLogger(""+e.name)}return e.prototype.cleanup=function(){var e=this;this.sessionsEndpointMap.forEach(function(t,n){e.endSession(n)}),this.pendingPairingPromises=void 0,this.sessionsEndpointMap=void 0},e.prototype.addSession=function(e){var t=this;this.logger.info("Incoming session:"+e);var n=this.loggingService.newScenario(this.constants.scenarios.betterTogether.remoteController.incomingSession,null,null,null,!0);n.appendEventData({id:e});var i=this.transportUser.getSession(e);if(this.sessionsEndpointMap.has(i))this.logger.error("Session is already accepted and endpoint received:"+e);else{var o=this.settingsService.valueFor(this.constants.settings.names.rigel).roomRemoteSessionExpirationInMs;setTimeout(function(){return t.flushPendingSession(i,n)},o),this.acceptSession(i,n)}},e.prototype.waitForEndpoint=function(e){var t,n=this,i=this.$q.defer();if(this.sessionsEndpointMap.forEach(function(o,r){o.getEndpointId()===e&&(n.logger.log(n.waitForEndpoint.name+": An endpoint has already been found. Continuing with pairing."),t=o,i.resolve(t))}),!t){this.logger.log(this.waitForEndpoint.name+": No endpoint has been found for endpointId:"+e+", parking promise."),this.pendingPairingPromises.has(e)&&(this.logger.warn(this.waitForEndpoint.name+": Deleting older pairing promise for the same endpoint:"+e),this.pendingPairingPromises(e).reject(),this.pendingPairingPromises.delete(e)),this.pendingPairingPromises.set(e,i);var o=this.settingsService.valueFor(this.constants.settings.names.rigel).roomRemotePairingExpirationInMs;setTimeout(function(){return n.flushPairingPromise(e)},o)}return i.promise},e.prototype.removeSession=function(e){var t=this;this.sessionsEndpointMap.forEach(function(n,i){i.getSessionId()===e&&(t.logger.info("Removing session:"+e+", "+t.sessionsEndpointMap+".size="+t.sessionsEndpointMap.size),t.transportDependencyProviderService.getRemoteControllerConnectionHandler().onEndpointUnpaired(n.getEndpointId()),t.sessionsEndpointMap.delete(i),t.endSession(i))})},e.prototype.removeSessionByEndpointId=function(e){var t=this;this.logger.info(this.removeSessionByEndpointId.name+":"+e),this.transportDependencyProviderService.getRemoteControllerConnectionHandler().onEndpointUnpaired(e),this.sessionsEndpointMap.forEach(function(n,i){n.getEndpointId()===e&&(t.logger.info(t.removeSessionByEndpointId.name+": Removing session with endpointId="+e+", "+t.sessionsEndpointMap+".size="+t.sessionsEndpointMap.size),t.sessionsEndpointMap.delete(i),t.endSession(i))})},e.prototype.acceptSession=function(e,t){var n=this,i=this.utilityService.generateGuidForTeamsContext(),o=e.getSessionId(),r=this.getNewOutgoingCommandResponse(o,""+this.acceptSession.name),s=this.transportStack.createBTSessionCallback();s.on("endpoint-received",function(i){return n.onEndpointReceived(i.causeId,i.endpointId,e,t)}),this.logger.info("Accepting session="+o+" causeId:"+i),e.accept(s,i,"","",r)},e.prototype.endSession=function(e){var t=this.utilityService.generateGuidForTeamsContext(),n=e.getSessionId(),i=this.getNewOutgoingCommandResponse(n,""+this.endSession.name);this.logger.info("Removing session="+e.getSessionId()+" causeId:"+t),e.end(t,"","",i)},e.prototype.onEndpointReceived=function(e,t,n,i){this.logger.info("Endpoint received causeId="+e+", endpointId="+t+", sessionId="+n.getSessionId()),this.removeSessionByEndpointId(t);var o=n.getEndpoint(t);o?(this.sessionsEndpointMap.set(n,o),this.logger.info("Added endpointId="+t+", sessionId="+n.getSessionId()+" to "+this.sessionsEndpointMap+".size="+this.sessionsEndpointMap.size),this.finalizePairingPromise(o)):(this.logger.error("session.getEndpoint("+t+") did not return a valid object"),this.endSession(n),i.appendEventData({message:"Invalid endpoint"}))},e.prototype.finalizePairingPromise=function(e){var t=e.getEndpointId();if(this.pendingPairingPromises.has(t)){var n=this.pendingPairingPromises.get(t);this.pendingPairingPromises.delete(t),this.logger.info("Resolving parked pairing promise for endpointId="+t),n.resolve(e)}else this.logger.info("There was no pairing awaiting for endpointId="+t)},e.prototype.flushPairingPromise=function(e){if(this.pendingPairingPromises.has(e)){var t=this.pendingPairingPromises.get(e);this.pendingPairingPromises.delete(e),this.logger.warn("Timeout fired: Flushing pending pairing promise for endpoint="+e+" since no matching endpoint has been received."),t.reject()}},e.prototype.flushPendingSession=function(e,t){this.isEndpointConnected(e)?t.stop():(this.logger.error("Timeout fired: Ending the pending session="+e.getSessionId()+"."),this.endSession(e),t.fail({message:"No pairing request"}))},e.prototype.isEndpointConnected=function(e){if(this.sessionsEndpointMap.has(e)){var t=this.sessionsEndpointMap.get(e);if(this.transportDependencyProviderService.getRemoteControllerConnectionHandler().getConnectedEndpoints().find(function(e){return e===t}))return!0;this.logger.error("Pairing was not finalized for sessionId:"+e.getSessionId()+".")}else this.logger.error("No endpointId has been received for sessionId:"+e.getSessionId()+" .");return!1},e.prototype.getNewOutgoingCommandResponse=function(e,t){var n=this,i=this.transportStack.createOutgoingCommandResponse();return i.on("request-succeeded",function(i){n.logger.info(t+" request for sessionId="+e+" causeId="+i.causeId+" succeeded with response="+i.responseBody)}),i.on("request-failed",function(i){n.logger.error(t+" request sessionId="+e+" causeId="+i.causeId+" failed with errorCode="+i.errorCode+", errorDetails="+i.errorDetails)}),i},e}();t.RemoteControllerSessionManager=i},2770:function(e,t,n){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++){t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){this.transportCommandRouter=e,this.transportConnectionHandler=t}return e.prototype.sendReportProblemId=function(e){var t=this,n=i({brbContainerId:e},this.transportConnectionHandler.getCommandDetails());this.transportConnectionHandler.getAllPairedDevices().map(function(e){t.transportCommandRouter.sendOutgoingCommand(teamspace.services.OutgoingCommand.ReportProblem,n,e.endPointId)})},e}();t.TransportAgentHandler=o},2771:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i;!function(e){e.InitState="InitState",e.ActiveCallDetails="ActiveCallDetails"}(i||(i={}));var o=function(){function e(e,t,n){this.$q=e,this.$injector=n,this.logger=t.newLogger("TransportCallkeeper"),this.activeCompanionDeviceCalls=[],this.isActiveCompannionDeviceCallsDeferred=void 0,this.activeRingingCalls=[],this.states=new Map,this.logger.info("TransportCallkeeper initialized."),this.states.set(i.InitState,teamspace.services.ITransportComponentState.Initialized)}return e.prototype.ringingCallResolved=function(e){var t=this,n=this.activeRingingCalls.find(function(n){return t.areTransportCallsEqual(n.transportCall,e)});if(n)return n.defer.promise;var i=this.$q.defer();return i.resolve(),i.promise},e.prototype.activeCallResolved=function(){var e=this.$q.defer(),t=this.activeCompanionDeviceCalls?this.activeCompanionDeviceCalls.filter(function(e){return 1!=e.disableCallTransfer}):void 0;return this.isActiveCompannionDeviceCallsDeferred?e.reject():t&&t.length>0?this.isActiveCompannionDeviceCallsDeferred=e:e.resolve(),e},e.prototype.addRingingCall=function(e){var t={callId:e.callId,conversationId:e.conversationId,messageId:e.messageId},n=e.callQueueInfo&&e.callQueueInfo.onBehalfOf?e.callQueueInfo.onBehalfOf.id:e.callerMri;SkypeX.Services.ChatServiceUtils.isPstnMri(n)&&(t.pstnMri=n);var i={transportCall:t,defer:this.$q.defer()};this.activeRingingCalls.push(i),this.logger.info("Added ringing call with callId: "+e.callId+", conversationId: "+e.conversationId+", messageId: "+e.messageId)},e.prototype.removeRingingCallFromNotification=function(e){var t=this,n=this.activeRingingCalls.find(function(n){return t.areTransportCallsEqual(n.transportCall,e)});n&&!n.transportCall.intentId&&(n.defer.resolve(),this.activeRingingCalls=this.activeRingingCalls.filter(function(n){return!t.areTransportCallsEqual(n.transportCall,e)}),this.logger.info("Removed ringing call with callId: "+e.callId+", conversationId: "+e.conversationId+", messageId: "+e.messageId))},e.prototype.removeRingingCallByIntentId=function(e){var t=this.activeRingingCalls.find(function(t){return!!e&&t.transportCall.intentId==e});t&&(t.defer.resolve(),this.activeRingingCalls=this.activeRingingCalls.filter(function(t){return!(e&&t.transportCall.intentId==e)}),this.logger.info("Removed ringing transport  call with intentId "+e))},e.prototype.addIntentIdToRingingCall=function(e){var t=this,n=this.activeRingingCalls.find(function(n){return t.areTransportCallsEqual(n.transportCall,e)});n&&(n.transportCall.intentId=e.intentId,this.logger.info("Added intentId to ringing transport call with callId: "+e.callId+", conversationId: "+e.conversationId+", messageId: "+e.messageId+" and intentId "+e.intentId))},e.prototype.addActiveCall=function(e){this.activeCompanionDeviceCalls.push(e),this.logger.info("Added active call with callId: "+e.callId+", conversationId: "+e.conversationId+", messageId: "+e.messageId)},e.prototype.removeActiveCall=function(e){var t=this,n=this.isCallActiveOnTransport(e);return this.activeCompanionDeviceCalls=this.activeCompanionDeviceCalls.filter(function(n){return!t.areTransportCallsEqual(n,e)}),this.logger.info("Removed call with callId: "+e.callId+", conversationId: "+e.conversationId+", messageId: "+e.messageId),0==this.activeCompanionDeviceCalls.filter(function(e){return 1!=e.disableCallTransfer}).length&&this.isActiveCompannionDeviceCallsDeferred&&(this.isActiveCompannionDeviceCallsDeferred.resolve(),this.isActiveCompannionDeviceCallsDeferred=void 0),n},e.prototype.updateCall=function(e,t){var n=this;this.activeCompanionDeviceCalls=this.activeCompanionDeviceCalls.filter(function(t){return!n.areTransportCallsEqual(t,e)}),this.activeCompanionDeviceCalls.push(t);var i=this.activeRingingCalls.find(function(t){return n.areTransportCallsEqual(t.transportCall,e)});i&&(i.transportCall=t)},e.prototype.isCallActiveOnTransport=function(e){var t=this;return-1!==this.activeCompanionDeviceCalls.findIndex(function(n){return t.areTransportCallsEqual(n,e)})},e.prototype.getTransportCallWithDetails=function(e){var t=this;return this.activeCompanionDeviceCalls.find(function(n){return t.areTransportCallsEqual(n,e)})},e.prototype.getCallStateForCall=function(e){var t=this.getTransportCallWithDetails(e);return t?t.callState:void 0},e.prototype.setCallStateForCall=function(e,t){var n=this;this.activeCompanionDeviceCalls.find(function(t){return n.areTransportCallsEqual(t,e)}).callState=t,this.logger.info("Updated call state for the transport call with callId: "+e.callId+", conversationId: "+e.conversationId+", messageId: "+e.messageId)},e.prototype.disableCallTransfer=function(){this.activeCompanionDeviceCalls.forEach(function(e){e.disableCallTransfer=!0}),this.isActiveCompannionDeviceCallsDeferred&&(this.isActiveCompannionDeviceCallsDeferred.resolve(),this.isActiveCompannionDeviceCallsDeferred=void 0),this.logger.info("disable IncallDevice Settings for all transport calls - "+JSON.stringify(this.activeCompanionDeviceCalls))},e.prototype.enableCallTransfer=function(){this.activeCompanionDeviceCalls.forEach(function(e){e.disableCallTransfer=!1}),this.logger.info("enabled IncallDevice Settings for activeCompanionDeviceCalls")},e.prototype.areTransportCallsEqual=function(e,t){return e.callId==t.callId},e.prototype.isCallEqualTransportCall=function(e,t){var n=e.callId==t.callId||t.conversationId==e.conversationId&&(!t.messageId||"0"==t.messageId||t.messageId==e.messageId);if(!n&&this.$injector.get("conversationsService")){var i=e.getCallingConversation();i.isOneToOnePstn()&&(n=i.members.find(function(e){return SkypeX.Services.ChatServiceUtils.isPstnMri(e.id)}).id==t.pstnMri&&!!t.pstnMri)}return n},e.prototype.cleanupCallKeeper=function(){this.activeCompanionDeviceCalls=[],this.states=void 0},e.prototype.getStates=function(){return this.states.set(i.ActiveCallDetails,JSON.stringify(this.activeCompanionDeviceCalls)),this.states},e}();t.TransportCallKeeper=o},38:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,n,i,o,r,s,a){this.commandDetails=e,this.transportDependencyProviderService=t,this.incomingCommandReceivedScenario=n,this.command=i,this.callingService=o,this.constants=r,this.$q=a,this.logger=s.newLogger(""+this.constructor.name),this.logger.info("Instantiated "+this.constructor.name+", subtype "+i+".")}return e.prototype.action=function(){this.responseDeferred=this.$q.defer();var e=this.callingService.getActiveCall();return e?this.canExecuteAction()?this.executeCommandSpecificAction(e):this.markFailureResponseNotAllowed("Action is disabled for current command="+this.command+"."):this.markFailureResponse("No active call going on.",this.constants.transportTelemetryErrorCode.incomingCommand.calling.callNotPresent),this.responseDeferred},e.prototype.markSuccessful=function(){this.wrapUpResponse(!0)},e.prototype.markSuccessfulWithResponse=function(e,t){this.wrapUpResponse(!0,e,t)},e.prototype.markFailureResponse=function(e,t){this.wrapUpResponse(!1,void 0,e,t)},e.prototype.markFailureResponseOperationFailed=function(e){this.markFailureResponse(e,this.constants.transportTelemetryErrorCode.incomingCommand.calling.operationFailed)},e.prototype.markFailureResponseInvalidCommand=function(){this.logger.error("Command not supported: "+this.command+"."),this.markFailureResponse("Received unexpected command subtype on this command: "+this.command,this.constants.transportTelemetryErrorCode.incomingCommand.invalidCommandRequest)},e.prototype.markFailureResponseNotAllowed=function(e){this.markFailureResponse(e,this.constants.transportTelemetryErrorCode.incomingCommand.remoteController.capabilityDisabled)},e.prototype.markFailureStateAlreadySet=function(e){this.markFailureResponse("State already set, "+e,this.constants.transportTelemetryErrorCode.incomingCommand.calling.stateAlreadySet)},e.prototype.wrapUpResponse=function(e,t,n,i){t||(t={}),e?(this.incomingCommandReceivedScenario.stop({message:"Success: "+this.command+" "+(n||"")}),t.statusCode=200,this.responseDeferred.resolve(t)):(this.logger.error(n),this.incomingCommandReceivedScenario.fail({message:"Error: "+n}),t.errorCode=i,t.errorDetails=n,this.responseDeferred.reject(t))},e}();t.RemoteControllerIncomingBaseCommand=i}},[2731]);