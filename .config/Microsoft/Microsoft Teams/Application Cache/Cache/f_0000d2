webpackJsonp([6],{131:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});!function(e){e[e.NotSet=0]="NotSet",e[e.DistinguishedName=1]="DistinguishedName",e[e.GenericData=2]="GenericData",e[e.IPV4Address=3]="IPV4Address",e[e.IPv6Address=4]="IPv6Address",e[e.MailSubject=5]="MailSubject",e[e.PhoneNumber=6]="PhoneNumber",e[e.QueryString=7]="QueryString",e[e.SipAddress=8]="SipAddress",e[e.SmtpAddress=9]="SmtpAddress",e[e.Identity=10]="Identity",e[e.Uri=11]="Uri",e[e.Fqdn=12]="Fqdn",e[e.IPV4AddressLegacy=13]="IPV4AddressLegacy"}(t.AWTPiiKind||(t.AWTPiiKind={}))},2147:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n(2148),n(2149),n(2150),n(2151),n(2152),n(2153),n(2154),n(2155),n(2156),n(2157),n(2158),n(241),n(2159),n(2160),n(2188),n(2189),n(307),n(2190),n(2191),n(2192),n(2193),angular.module("teamspace.cortanaJSService",["teamspace.cortanaService"]).factory("cortanaJSService",["$injector",function(e){return e.get("cortanaService")}])},2148:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(11),o=function(e){function t(t,n,i,o,a){var s=e.call(this,r.ClientSkillsId.communication)||this;return s.$rootScope=t,s.constants=n,s.callingSupportService=i,s.platformDetectService=o,s.settingsService=a,s}return i(t,e),t.$inject=["$rootScope","constants","callingSupportService","platformDetectService","settingsService"],t.prototype.initialize=function(){var e=this;return this.pstnCallingAllowedSubscription=this.callingSupportService.subscribe(function(){e.onCallingAggregatedSettingsUpdated(),e.triggerConfigUpdated()},teamspace.services.CallingSupportServiceEvents.Type_isPstnCallingAllowedChanged),this.callingAllowedSubscription=this.callingSupportService.subscribe(function(){e.onCallingAggregatedSettingsUpdated(),e.triggerConfigUpdated()},teamspace.services.CallingSupportServiceEvents.Type_isCallingAllowedChanged),this.$rootScope.$on("$destroy",function(){e.pstnCallingAllowedSubscription&&e.callingSupportService.unsubscribe(e.pstnCallingAllowedSubscription),e.callingAllowedSubscription&&e.callingSupportService.unsubscribe(e.callingAllowedSubscription)}),this.currentConfig={channelsSettings:{},preferences:{maxContactsForDisambig:3,preferredCallingChannel:"teams",preferredMessagingChannel:"teams"}},this.onCallingAggregatedSettingsUpdated(),Promise.resolve(!0)},t.prototype.deinitialize=function(){this.pstnCallingAllowedSubscription&&(this.callingSupportService.unsubscribe(this.pstnCallingAllowedSubscription),this.pstnCallingAllowedSubscription=void 0),this.callingAllowedSubscription&&(this.callingSupportService.unsubscribe(this.callingAllowedSubscription),this.callingAllowedSubscription=void 0),this.currentConfig=null},t.prototype.getConfig=function(){return this.currentConfig},t.prototype.onCallingAggregatedSettingsUpdated=function(){this.currentConfig.channelsSettings.teams={canSupplyContacts:!1,supportsCalling:!!this.callingSupportService.isCallingAllowed(),supportsCallingMultipleContacts:!1,supportsAddToCall:!0,supportsAddToCallMultipleContacts:!1,supportsHoldResume:!this.platformDetectService.isRigel(),supportsTransferCall:!this.platformDetectService.isRigel(),supportsFetchMessages:!1,supportsMarkMessages:!1,supportsSendMessage:!this.platformDetectService.isRigel(),supportsMultipleCalls:!this.platformDetectService.isRigel(),permissionsSettings:{enableCallAContact:this.settingsService.valueFor(this.constants.settings.names.rigel).enableCortanaFastFollow&&this.callingSupportService.isCallingAllowed(),enableCallANumber:!!this.callingSupportService.isPSTNCallingAllowed(),enableAddAContact:this.settingsService.valueFor(this.constants.settings.names.rigel).enableCortanaFastFollow&&this.callingSupportService.isCallingAllowed(),enableAddANumber:!!this.callingSupportService.isPSTNCallingAllowed(),enableSendMessage:!this.platformDetectService.isRigel()}}},t}(n(300).CortanaConfigProviderBase);t.CommunicationSkillConfigProvider=o,angular.module("teamspace.communicationSkillConfigProvider",["teamspace.callingSupportService","teamspace.constants","teamspace.platformDetectService","teamspace.settingsService"]).service("communicationSkillConfigProvider",o)},2149:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(11),o=function(e){function t(t,n,i,o,a,s){var c=e.call(this,r.ClientSkillsId.system)||this;return c.$rootScope=t,c.constants=n,c.loggingService=i,c.myUserPreferencesStore=o,c.platformDetectService=a,c.settingsService=s,c.logger=i.newLogger("SystemSkillConfigProvider"),c}return i(t,e),t.$inject=["$rootScope","constants","loggingService","myUserPreferencesStore","platformDetectService","settingsService"],t.prototype.initialize=function(){var e=this;return this.myUserPreferencesStore.waitForPreferenceStoreToInitialize().then(function(){return e.updateConfig(),e.preferencesStoreToken=e.myUserPreferencesStore.safeSubscribe(e.$rootScope,function(t,n){n&&_.find(n,function(e){return e===SkypeX.Services.MyUserPreferenceStorageKey.Locale})&&(e.updateConfig(),e.triggerConfigUpdated())},e.constants.MyUserPreferencesStore.Type_UserPreference),!0})},t.prototype.deinitialize=function(){this.preferencesStoreToken&&(this.myUserPreferencesStore.unsubscribe(this.preferencesStoreToken),this.preferencesStoreToken=void 0),this.currentConfig=null},t.prototype.getConfig=function(){return this.currentConfig},t.prototype.updateConfig=function(){this.logger.info("user locale updated {0}, force locale to {1}",this.myUserPreferencesStore.getUserPreferences().locale,"en-us");var e="en-us",t=-(new Date).getTimezoneOffset(),n=this.settingsService.valueFor(this.constants.settings.environment),i=this.settingsService.valueFor(this.constants.settings.names.cortanaConstants),r=this.platformDetectService.getClientVersion(),o=this.platformDetectService.getDesktopBuildVersion();o&&(r=r.concat("_",o)),this.currentConfig={sdk:null,language:e.toLowerCase(),region:"us",timezoneOffset:t,app:{name:i.appName,flavor:i.appFlavorPrefix+"_"+(n&&n.platformId),version:r},deviceId:this.loggingService.deviceId(),deviceName:i.deviceNamePrefix+"+"+this.platformDetectService.getDeviceType(),device:{manufacturer:i.deviceManufacturer,model:this.platformDetectService.getBrowser(),version:this.platformDetectService.getBrowserVersion()},os:{platform:this.platformDetectService.getDesktopOsArchitecture(),name:this.platformDetectService.getOS(),version:this.platformDetectService.getOSVersion()}}},t}(n(300).CortanaConfigProviderBase);t.SystemSkillConfigProvider=o,angular.module("teamspace.systemSkillConfigProvider",["skypeX.myUserPreferencesStore","teamspace.constants","teamspace.loggingService","teamspace.platformDetectService","teamspace.settingsService"]).service("systemSkillConfigProvider",o)},2150:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(19),o=n(11),a=(teamspace.services,function(e){function t(t,n,i,o,a,s,c,l,u,d,p,h,g,f){var v=e.call(this,r.TeamsActionsId.callingAction)||this;return v.addParticipantService=t,v.callingService=n,v.callingSupportService=i,v.callingNavigationService=o,v.callTogglingService=a,v.callTransferService=s,v.callingUserActionService=c,v.constants=l,v.conversationsService=u,v.peopleService=p,v.platformDetectService=h,v.pstnNumberService=g,v.callParkService=f,v.logger=d.newLogger("CallingActionHandler"),v}return i(t,e),t.$inject=["addParticipantService","callingService","callingSupportService","callingNavigationService","callTogglingService","callTransferService","callingUserActionService","constants","conversationsService","loggingService","peopleService","platformDetectService","pstnNumberService","callParkService"],t.prototype.handleAction=function(e){var t=e;if(!t||!t.type)return Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.EmptyResponse));if(this.logger.info("calling type: {0}",t.type),!this.callingSupportService.isSupportedEnvironment())return this.logger.info("Voice Skills: calling unsupported environment"),Promise.resolve(this.callingActionResult(t.type,r.TeamsCortanaActionStatus.NotSupported));var n=t.contacts&&t.contacts[0]?t.contacts[0]:null;switch(this.logger.info("Voice Skills: Requesting {0}",t.type),t.type){case o.ClientSkillsActions.makeCall:return this.handleMakeCallAction(n);case o.ClientSkillsActions.transferCall:return this.handleTransferCallAction(n,t.callId);case o.ClientSkillsActions.addToCall:return this.handleAddToCallAction(n,t.callId);case o.ClientSkillsActions.resumeCall:case o.ClientSkillsActions.holdCall:return this.handleHoldResumeCallAction(t.type===o.ClientSkillsActions.holdCall,t.callId);case o.ClientSkillsActions.muteCall:case o.ClientSkillsActions.unmuteCall:return this.handleMuteUnmuteCallAction(t.type===o.ClientSkillsActions.muteCall,t.callId);case o.ClientSkillsActions.endCall:return this.handleEndCallAction(t.callId);default:return Promise.resolve(this.callingActionResult(t.type,r.TeamsCortanaActionStatus.InvalidAction))}},t.prototype.getCallByIdOrCurrentCall=function(e){var t;return e&&(t=this.callingService.getCallByCallId(e)),t||this.callingService.getActiveCall()},t.prototype.isActionAllowed=function(e,t,n){switch(void 0===t&&(t=!1),e){case o.ClientSkillsActions.makeCall:return t?this.callingSupportService.isPSTNCallingAllowed():this.callingSupportService.isCallingAllowed();case o.ClientSkillsActions.addToCall:return t?this.callingSupportService.isAddingParticipantAllowed(n)&&n.isPstnAvailable:this.callingSupportService.isAddingParticipantAllowed(n);case o.ClientSkillsActions.holdCall:return this.callingSupportService.isHoldResumeAllowed(n);case o.ClientSkillsActions.resumeCall:return n&&4===n.state;case o.ClientSkillsActions.transferCall:return this.callingSupportService.isTransferAllowed(n);case o.ClientSkillsActions.endCall:return!0;default:return!1}},t.prototype.formatContactNumber=function(e){return this.pstnNumberService.normalizePstnNumber(e)},t.prototype.handleMakeCallAction=function(e){var t=this,n=o.ClientSkillsActions.makeCall;return e?this.platformDetectService.isRigel()||this.isActionAllowed(n,!!e.number)?e.number?this.callPstnNumber(this.formatContactNumber(e.number)):e.mri?this.callContact(e.mri):e.upn?this.getProfileByContactId(e.upn,!0).then(function(e){return t.callContact(e.mri)}).catch(function(e){return t.logger.warn("VoiceSkills: failed to get profile by contact id : {0}",e),t.callingActionResult(o.ClientSkillsActions.makeCall,r.TeamsCortanaActionStatus.Error,t.getErrorMessage(e))}):Promise.resolve(this.callingActionResult(o.ClientSkillsActions.makeCall,r.TeamsCortanaActionStatus.InvalidActionData)):Promise.resolve(this.callingActionResult(o.ClientSkillsActions.makeCall,r.TeamsCortanaActionStatus.NotSupported)):Promise.resolve(this.callingActionResult(o.ClientSkillsActions.makeCall,r.TeamsCortanaActionStatus.InvalidActionData))},t.prototype.handleHoldResumeCallAction=function(e,t){var n=this,i=e?o.ClientSkillsActions.holdCall:o.ClientSkillsActions.resumeCall,a=this.getCallByIdOrCurrentCall(t);return a?this.isActionAllowed(i,!1,a)?e&&4!==a.state||!e&&4===a.state?(e||this.platformDetectService.isRigel()||this.callingNavigationService.navigateToCallScreen(a),this.callParkService.toggleHold(a,this.constants.scenarios.calling.context.voiceSkills.holdResume).then(function(){return n.callingActionResult(i,r.TeamsCortanaActionStatus.Success)}).catch(function(e){return n.logger.warn("VoiceSkills: failed to hold/resume [call][callId:"+t+"] with [error:"+e+"]"),n.callingActionResult(i,r.TeamsCortanaActionStatus.Error,n.getErrorMessage(e))})):Promise.resolve(this.callingActionResult(i,r.TeamsCortanaActionStatus.Error)):Promise.resolve(this.callingActionResult(i,r.TeamsCortanaActionStatus.NotSupported)):Promise.resolve(this.callingActionResult(i,r.TeamsCortanaActionStatus.InvalidActionData))},t.prototype.handleMuteUnmuteCallAction=function(e,t){var n,i=this,a=e?o.ClientSkillsActions.muteCall:o.ClientSkillsActions.unmuteCall,s=this.getCallByIdOrCurrentCall(t);return s?this.callTogglingService.toggleMuteAudio(s,1,e?1:2,(n={},n[this.constants.counters.eventNames.context]=this.constants.scenarios.calling.context.voiceSkills.muteUnmute,n)).then(function(){return i.callingActionResult(a,r.TeamsCortanaActionStatus.Success)}).catch(function(e){return i.logger.warn("VoiceSkills: failed to mute/unmute call: "+t+" with error: "+e),i.callingActionResult(a,r.TeamsCortanaActionStatus.Error,i.getErrorMessage(e))}):Promise.resolve(this.callingActionResult(a,r.TeamsCortanaActionStatus.InvalidActionData))},t.prototype.handleEndCallAction=function(e){var t=this,n=this.getCallByIdOrCurrentCall(e);return n?this.callingService.leaveCall(n,this.constants.scenarios.calling.context.voiceSkills.endCall).then(function(){return t.callingActionResult(o.ClientSkillsActions.endCall,r.TeamsCortanaActionStatus.Success)}).catch(function(n){return t.logger.warn("VoiceSkills: failed to end call: "+e+" with error: "+n),t.callingActionResult(o.ClientSkillsActions.endCall,r.TeamsCortanaActionStatus.Error,t.getErrorMessage(n))}):Promise.resolve(this.callingActionResult(o.ClientSkillsActions.endCall,r.TeamsCortanaActionStatus.InvalidActionData))},t.prototype.handleTransferCallAction=function(e,t){var n=this,i=o.ClientSkillsActions.transferCall,a=this.getCallByIdOrCurrentCall(t);return a&&(e.mri||e.upn||e.number)?this.isActionAllowed(i,!1,a)?(e.number?this.getProfileByContactNumber(this.formatContactNumber(e.number)):this.getProfileByContactId(e.mri||e.upn,!e.mri)).then(function(e){return e&&e.mri?(n.callTransferService.transferCall(a,e),n.callingActionResult(i,r.TeamsCortanaActionStatus.Success)):(n.logger.error("failed to find call contact"),n.callingActionResult(i,r.TeamsCortanaActionStatus.UserNotFound))}).catch(function(e){return n.logger.warn("VoiceSkills: failed to transfer call: "+t+" with error: "+e),n.callingActionResult(i,r.TeamsCortanaActionStatus.Error,n.getErrorMessage(e))}):Promise.resolve(this.callingActionResult(i,r.TeamsCortanaActionStatus.NotSupported)):Promise.resolve(this.callingActionResult(i,r.TeamsCortanaActionStatus.InvalidActionData))},t.prototype.handleAddToCallAction=function(e,t){var n=this,i=o.ClientSkillsActions.addToCall,a=this.getCallByIdOrCurrentCall(t);return a&&(e.mri||e.upn||e.number)?this.isActionAllowed(i,!!e.number,a)?(e.number?this.getProfileByContactNumber(this.formatContactNumber(e.number)):this.getProfileByContactId(e.mri||e.upn,!e.mri)).then(function(e){return e&&e.mri?(n.addParticipantService.handleAddParticipant(a,e,n.constants.scenarios.calling.context.voiceSkills.addToCall),n.callingActionResult(i,r.TeamsCortanaActionStatus.Success)):(n.logger.error("failed to find call contact"),n.callingActionResult(i,r.TeamsCortanaActionStatus.UserNotFound))}).catch(function(e){return n.logger.warn("VoiceSkills: failed to add to call: "+t+" with error: "+e),n.callingActionResult(i,r.TeamsCortanaActionStatus.Error,n.getErrorMessage(e))}):Promise.resolve(this.callingActionResult(i,r.TeamsCortanaActionStatus.NotSupported)):Promise.resolve(this.callingActionResult(i,r.TeamsCortanaActionStatus.InvalidActionData))},t.prototype.callPstnNumber=function(e){var t=this,n={dialoutNumber:e,dtmfPortion:"",context:teamspace.services.CallTelemetryContext.VoiceSkillsPstnCall,withVideo:!1,muted:!1};return this.callingUserActionService.startPstnCall(n).then(function(){return t.callingActionResult(o.ClientSkillsActions.makeCall,r.TeamsCortanaActionStatus.Success)}).catch(function(e){return t.callingActionResult(o.ClientSkillsActions.makeCall,r.TeamsCortanaActionStatus.Error,t.getErrorMessage(e))})},t.prototype.callContact=function(e){var t=this;if(!e)return Promise.resolve(this.callingActionResult(o.ClientSkillsActions.makeCall,r.TeamsCortanaActionStatus.UserNotFound));var n={messageId:null,conversationId:this.conversationsService.getChatConversationWith(e).id,isChannelMeeting:!1,withVideo:!1,context:teamspace.services.CallTelemetryContext.VoiceSkillsCall};return this.callingUserActionService.placeCall(n).then(function(){return t.callingActionResult(o.ClientSkillsActions.makeCall,r.TeamsCortanaActionStatus.Success)}).catch(function(e){return t.callingActionResult(o.ClientSkillsActions.makeCall,r.TeamsCortanaActionStatus.Error,t.getErrorMessage(e))})},t.prototype.getProfileByContactId=function(e,t){var n=this;return void 0===t&&(t=!1),e?this.peopleService.getPeopleProfile(e,"callingActionHandler",t).then(function(e){return e&&e.mri?e:(n.logger.error("failed to find call contact by contactId"),null)}):null},t.prototype.getProfileByContactNumber=function(e){var t=this;if(!e)return null;var n={includePstn:!0};return this.peopleService.searchContacts(e,"callingActionHandler",n).then(function(e){return e&&e.results&&e.results[0]?e.results[0]:(t.logger.error("failed to find call contact by pstn"),null)})},t.prototype.callingActionResult=function(e,t,n,i){return void 0===n&&(n=""),void 0===i&&(i=!0),{status:t,actionId:this.actionId,dismissOnAction:i,actionResponseData:this.getCallingResponseData(e,t===r.TeamsCortanaActionStatus.Success,n)}},t.prototype.getCallingResponseData=function(e,t,n){return e?{id:o.ClientSkillsId.communication,event:e,slots:{success:t,errorMessage:n||""}}:null},t}(r.TeamsCortanaActionHandlerBase));t.CallingActionHandler=a,angular.module("teamspace.callingActionHandler",["teamspace.addParticipantService","teamspace.callingService","teamspace.callingSupportService","teamspace.callingUserActionService","teamspace.callTogglingService","teamspace.callTransferService","teamspace.conversationsService","teamspace.loggingService","teamspace.peopleService","teamspace.pstnNumberService","teamspace.callParkService"]).service("callingActionHandler",a)},2151:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(19),o=function(e){function t(t,n,i,o,a){var s=e.call(this,r.TeamsActionsId.downloadFilesAction)||this;return s.$q=t,s.constants=n,s.downloadManagerService=i,s.filesActionService=o,s.logger=a.newLogger("DownloadFilesActionHandler"),s}return i(t,e),t.$inject=["$q","constants","downloadManagerService","filesActionService","loggingService"],t.prototype.handleAction=function(e){var t=this,n=e;if(!n||!n.files||0===n.files.length)return Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Error));n.files=n.files?n.files:[n.file];var i=_.map(n.files,function(e){return{downloadUrl:e.objectUrl,objectId:e.objectId,objectUrl:e.objectUrl,title:e.title,type:e.type}});return this.downloadManagerService.download(i,function(e){return t.$q.resolve({serviceName:t.constants.files.serviceName.recent,objectUrl:e.objectUrl,title:e.title})}).then(function(e){t.filesActionService.handleBatchResults(e,i,null,teamspace.services.EntityActionType.Download,t.constants.events.files.batchDownloadSuccess,t.constants.events.files.batchDownloadFailed,!1)}).catch(function(e){t.logger.error("download failed {0}",e)}),Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Success))},t}(r.TeamsCortanaActionHandlerBase);t.DownloadFilesActionHandler=o,angular.module("teamspace.downloadFilesActionHandler",["teamspace.downloadManagerService","teamspace.filesActionService","teamspace.loggingService"]).service("downloadFilesActionHandler",o)},2152:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(19),o=function(e){function t(t,n){var i=e.call(this,r.TeamsActionsId.openFileAction)||this;return i.constants=t,i.navigationService=n,i}return i(t,e),t.$inject=["constants","navigationService"],t.prototype.handleAction=function(e){var t=this,n=e;if(!n||!n.file)return Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Error));var i=n.file,o={documentViewerParams:{baseUrl:null,ctx:"cortana",fileId:i.objectId,fileType:i.type,objectUrl:i.objectUrl,serviceName:"teams",viewerAction:"view"},viewerState:this.constants.states.appDocumentViewer};return this.navigationService.navigateToFileViewer(o).then(function(e){return t.actionResult(e?r.TeamsCortanaActionStatus.Success:r.TeamsCortanaActionStatus.Error)})},t}(r.TeamsCortanaActionHandlerBase);t.FileActionHandler=o,angular.module("teamspace.fileActionHandler",["teamspace.navigationService"]).service("fileActionHandler",o)},2153:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(19),o=n(11),a=function(e){function t(t,n,i,o,a,s,c){var l=e.call(this,r.TeamsActionsId.meetingAction)||this;return l.calendarService=t,l.callingSupportService=n,l.callingUserActionService=i,l.callingDeepLinkService=o,l.conversationsAsyncService=a,l.platformDetectService=c,l.logger=s.newLogger("MeetingActionHandler"),l}return i(t,e),t.$inject=["calendarService","callingSupportService","callingUserActionService","callingDeepLinkService","conversationsAsyncService","loggingService","platformDetectService"],t.prototype.handleAction=function(e){var t=e;return t&&t.type?(this.logger.info("meeting action type: {0}",t.type),t.type!==o.ClientSkillsActions.meeting.joinMeeting?Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.InvalidAction)):this.handleJoinMeeting(t)):Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.EmptyResponse))},t.prototype.handleJoinMeeting=function(e){var t=this;return new Promise(function(n){var i=e.skypeTeamsMeetingUrl,a=e.conversationId;if(i&&a){var s=t.callingDeepLinkService.getDeeplinkParamsFromUrl(i),c=i.contains("IsBroadcastMeeting"),l={conversationId:a,skypeTeamsMeetingUrl:i,tenantId:s&&s.context&&s.context.Tid,organizerId:s&&s.context&&s.context.Oid,meetingType:teamspace.services.MeetingType.Chat,isBroadcast:c},u={context:teamspace.services.CallTelemetryContext.VoiceSkillsJoinMeeting,withOutgoingAudio:t.callingSupportService.isIPAudioModeEnabled,withOutgoingVideo:t.callingSupportService.isIPVideoModeEnabled};t.shouldBypassPrejoin()&&(u.bypassPrejoin=!0);var d=t.calendarService.getICaluidForConvID(a),p=function(e){return t.conversationsAsyncService.getConversation(e).then(function(e){if(!e)return!1;if(!d){var t=e.getMeetingInfo();d=t?t.iCalUid:""}return!0})};p(a).then(function(e){e?n(t.meetingActionResult(o.ClientSkillsActions.meeting.joinMeeting,r.TeamsCortanaActionStatus.Success,d)):t.calendarService.showPrivateMeetingConversation(a,"join_meeting_from_cortana").then(function(){return p(a)}).then(function(){return n(t.meetingActionResult(o.ClientSkillsActions.meeting.joinMeeting,r.TeamsCortanaActionStatus.Success,d))}).catch(function(e){return n(t.meetingActionResult(o.ClientSkillsActions.meeting.joinMeeting,r.TeamsCortanaActionStatus.Error,d,t.getErrorMessage(e)))});var i=s&&s.context&&s.context.correlationId,c=t.callingUserActionService.intentFromMeetingParameters(l,u,i);t.callingUserActionService.startOrJoinCallFromIntent(c)})}else n(t.actionResult(r.TeamsCortanaActionStatus.InvalidActionData))})},t.prototype.meetingActionResult=function(e,t,n,i,o){return void 0===i&&(i=""),void 0===o&&(o=!0),{status:t,actionId:this.actionId,dismissOnAction:o,actionResponseData:this.getMeetingResponseData(e,t===r.TeamsCortanaActionStatus.Success,n,i)}},t.prototype.getMeetingResponseData=function(e,t,n,i){return e?{id:"meeting",event:e,slots:{success:t,errorMessage:i||"",iCalUid:n}}:null},t.prototype.shouldBypassPrejoin=function(){return this.platformDetectService.isRigel()},t}(r.TeamsCortanaActionHandlerBase);t.MeetingActionHandler=a,angular.module("teamspace.meetingActionHandler",["teamspace.calendarService","teamspace.callingDeepLinkService","teamspace.callingService","teamspace.callingSupportService","teamspace.callingUserActionService","teamspace.conversationsAsyncService","teamspace.loggingService","teamspace.platformDetectService"]).service("meetingActionHandler",a)},2154:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(19),o=function(e){function t(t,n,i,o,a,s,c,l,u,d,p,h,g){var f=e.call(this,r.TeamsActionsId.navigation)||this;return f.constants=t,f.$q=n,f.$state=i,f.brbV2FeedbackService=o,f.conversationsAsyncService=a,f.dialogService=s,f.eventingService=c,f.navigationService=l,f.callingNavigationService=u,f.peopleService=d,f.shortcutService=p,f.teamActionDialogUtilityService=h,f.layoutService=g,f}return i(t,e),t.$inject=["constants","$q","$state","brbV2FeedbackService","conversationsAsyncService","dialogService","eventingService","navigationService","callingNavigationService","peopleService","shortcutService","teamActionDialogUtilityService","layoutService"],t.prototype.handleAction=function(e){var t=e;if(!t||!t.destination&&!t.channelId)return Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Error));if(t.channelId)return this.navigationService.navigateToChannel(t.channelId,"cortana"),Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Success,!0,null,"channel"));var n;switch(t.destination){case r.NavigationDestinations.recentFiles:n=this.navigationResultToActionResult(this.navigationService.navigateToRecentFiles());break;case r.NavigationDestinations.feed:n=this.navigationResultToActionResult(this.navigationService.navigateToActivityFeed());break;case r.NavigationDestinations.atMentions:n=this.navigationResultToActionResult(this.navigationService.navigateToMentionsState());break;case r.NavigationDestinations.calendar:n=this.navigationResultToActionResult(this.navigationService.navigateToCalendar());break;case r.NavigationDestinations.createTeam:this.teamActionDialogUtilityService.openCreateTeamDialog(),n=Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Success));break;case r.NavigationDestinations.downloads:n=this.navigationResultToActionResult(this.navigationService.navigateToDownloads());break;case r.NavigationDestinations.feedback:this.brbV2FeedbackService.openDialog(!1,void 0,this.constants.feedback.categories.cortana),n=Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Success));break;case r.NavigationDestinations.joinTeam:this.$state.go(this.constants.states.appDiscover),n=Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Success));break;case r.NavigationDestinations.myActivity:n=this.navigationResultToActionResult(this.navigationService.navigateToMyActivity());break;case r.NavigationDestinations.saved:n=this.navigationResultToActionResult(this.navigationService.navigateToDefaultMySavedState());break;case r.NavigationDestinations.unreadActivity:n=this.navigationResultToActionResult(this.navigationService.navigateToUnreadState());break;case r.NavigationDestinations.help:this.eventingService.$emit(this.constants.events.cortana.openEducationalPage),n=Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Success,!1));break;case r.NavigationDestinations.openSettings:this.dialogService.open(this.constants.dialogs.optionsSettingsDialog),n=Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Success));break;case r.NavigationDestinations.keyboardShortcuts:this.shortcutService.executeCommand(teamspace.services.CommandIdentifier.ShowShortcuts),n=Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Success));break;case r.NavigationDestinations.store:n=this.navigationResultToActionResult(this.navigationService.navigateToAppsView());break;case r.NavigationDestinations.otherPersonActivity:case r.NavigationDestinations.otherPersonChat:case r.NavigationDestinations.otherPersonOrganization:n=this.navigationResultToActionResult(this.handleOtherPersonNavigation(t));break;case r.NavigationDestinations.teamsApp:n=t.appId?this.navigationResultToActionResult(this.navigationService.navigateToUserAppId(t.appId,"cortana")):Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.InvalidActionData));break;case r.NavigationDestinations.teams:n=this.navigationResultToActionResult(this.navigationService.navigateToTeamsAndChannels(this.$state.current.params.navCtx));break;case r.NavigationDestinations.calls:n=this.navigationResultToActionResult(this.navigationService.navigateToDefaultCallingStateAndSetFocus());break;case r.NavigationDestinations.chat:n=this.navigationResultToActionResult(this.navigationService.navigateToMyChat());break;case r.NavigationDestinations.voicemail:n=this.navigationResultToActionResult(this.callingNavigationService.navigateToCallTab(this.constants.callListTab.panes.voicemail));break;case r.NavigationDestinations.contacts:n=this.navigationResultToActionResult(this.callingNavigationService.navigateToCallTab(this.constants.callListTab.panes.saved));break;case r.NavigationDestinations.back:this.layoutService.back(),n=Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Success));break;case r.NavigationDestinations.forward:this.layoutService.forward(),n=Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Success));break;default:n=Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Error))}return n.then(function(e){return e.actionInfo=t.destination,e})},t.prototype.navigationResultToActionResult=function(e){var t=this;return e?e.then(function(e){return e?t.actionResult(r.TeamsCortanaActionStatus.Success):t.actionResult(r.TeamsCortanaActionStatus.Error)}):Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Error))},t.prototype.handleOtherPersonNavigation=function(e){var t=this;return e.userPrincipalName?e.destination===r.NavigationDestinations.otherPersonActivity?this.navigationService.navigateToPerson(e.userPrincipalName,this.constants.peopleTab.panes.activity):e.destination===r.NavigationDestinations.otherPersonOrganization?this.navigationService.navigateToPerson(e.userPrincipalName,this.constants.peopleTab.panes.organization):e.destination===r.NavigationDestinations.otherPersonChat?this.peopleService.getPeopleProfile(e.userPrincipalName,"navigationActionHandler",!0).then(function(e){var n=e.mri;return t.conversationsAsyncService.getChatConversationWith(n).then(function(e){var n=e?e.id:null;if(n){var i={slug:n,middlePane:t.constants.messages.panes.conversations,ctx:t.constants.navigation.context.chat,navCtx:"cortana"};return t.navigationService.navigateDirectPromise(t.constants.states.appConversation,i)}return t.$q.resolve(null)}).catch(function(e){var n=teamspace.services.AppsServiceUtils.getSafeError(e);return t.logger.error("handleOtherPersonNavigation getChatConversationWith failed with error "+n),t.$q.resolve(null)})}):this.$q.resolve(null):this.$q.resolve(null)},t}(r.TeamsCortanaActionHandlerBase);t.NavigationActionHandler=o,angular.module("teamspace.navigationActionHandler",["teamspace.brbV2FeedbackService","teamspace.conversationsAsyncService","teamspace.dialogService","teamspace.eventingService","teamspace.navigationService","teamspace.callingNavigationService","teamspace.peopleService","teamspace.shortcutService","teamspace.teamActionDialogUtilityService","teamspace.layoutService"]).service("navigationActionHandler",o)},2155:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(19),o=n(11),a=function(e){function t(t,n,i,o,a,s,c,l){var u=e.call(this,r.TeamsActionsId.present)||this;return u.$state=t,u.callingService=n,u.callingNavigationService=i,u.callingTelemetryService=o,u.constants=a,u.contentSharingService=s,u.eventingService=c,u.logger=l.newLogger("PresentActionHandler"),u}return i(t,e),t.$inject=["$state","callingService","callingNavigationService","callingTelemetryService","constants","contentSharingService","eventingService","loggingService"],t.prototype.handleAction=function(e){var t=e;if(!t||!t.type)return Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.EmptyResponse));this.logger.info("Voice Skills: present action type: {0}",t.type);var n=this.getCallFromActionDetails(t);if(!n)return Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.InvalidAction));switch(t.type){case o.ClientSkillsActions.meeting.present:return this.callingNavigationService.navigateToCallScreen(n),this.presentDeck(n.callId,t.deckName,t.deckUrl,t.attachmentInfo);case o.ClientSkillsActions.meeting.stopSharingDeck:return this.stopPresentingDeck(n);case o.ClientSkillsActions.meeting.nextSlide:return this.goToNextSlide(n.callId);case o.ClientSkillsActions.meeting.previousSlide:return this.goToPreviousSlide(n.callId);case o.ClientSkillsActions.meeting.goToSlide:return this.goToSlide(n.callId,t.slideIndex);default:return Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.InvalidAction))}},t.prototype.getCallFromActionDetails=function(e){var t,n=e.conversationId||this.$state.params.conversationId;return e.callId||n?(e.callId&&(t=this.callingService.getCallByCallId(e.callId)),!t&&n&&(t=_.find(this.callingService.getActiveCalls(),function(e){return e.conversationId&&e.conversationId===n})),t||(this.logger.error("Voice Skills: No active call corresponding to the conversationId "+n),null)):null},t.prototype.presentDeck=function(e,t,n,i){var a=this;if(!n&&!i)return this.logger.info("Voice Skills: no deckUrl in the response to present the deck"),Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.InvalidParameters));var s={type:"ppt",id:i?i.attachmentId:e,name:t,url:i?void 0:n,siteUrl:void 0,contentBundleUrl:void 0,fileGetUrl:void 0,fileCommandsUrl:void 0,majorVersion:void 0,fileSize:void 0,source:"cortana",exchangeMeta:i?{type:i.type,eventId:i.eventId}:void 0,replaceFile:!0};return this.contentSharingService.startSharingContent(s).then(function(){a.logger.info("Voice Skills: presenting the deck")}).catch(function(e){e.code!==teamspace.services.ContentSharingErrorCode.Cancelled?a.logger.error("Content sharing stopped: sharing failed"):a.logger.info("Content sharing stopped: sharing cancelled.")}),Promise.resolve(this.presentActionResult(o.ClientSkillsActions.meeting.present,r.TeamsCortanaActionStatus.Success))},t.prototype.stopPresentingDeck=function(e){var t=this;if(this.logger.info("Voice Skills: stop presenting the current deck on callId "+e.callId),!e.contentSharingSessions||!this.contentSharingService.activeSessions)return Promise.resolve(this.presentActionResult(o.ClientSkillsActions.meeting.stopSharingDeck,r.TeamsCortanaActionStatus.InvalidAction));var n=this.getActivePptSharingSession();if(!n)return Promise.resolve(this.presentActionResult(o.ClientSkillsActions.meeting.stopSharingDeck,r.TeamsCortanaActionStatus.Error,"PPT session doesn't exist"));if(n.mode!==teamspace.services.ContentMode.Presenting)return Promise.resolve(this.presentActionResult(o.ClientSkillsActions.meeting.stopSharingDeck,r.TeamsCortanaActionStatus.Error,"PPT session in non-presenting mode"));var i=this.callingTelemetryService.newContentSharingScenario(e,this.constants.scenarios.contentSharing.cortanaPptSharingStop,n.id,n.contentType);return n.stopSharing(e,i).then(function(){return Promise.resolve(t.presentActionResult(o.ClientSkillsActions.meeting.stopSharingDeck,r.TeamsCortanaActionStatus.Success))}).catch(function(e){return Promise.resolve(t.presentActionResult(o.ClientSkillsActions.meeting.stopSharingDeck,r.TeamsCortanaActionStatus.Error,e))})},t.prototype.goToNextSlide=function(e){return this.logger.info("Voice Skills: navigate to next slide for active presentation on callId "+e),this.eventingService.$emit(this.constants.events.calling.pptSharingNext,{callId:e}),Promise.resolve(this.presentActionResult(o.ClientSkillsActions.meeting.navigateDeck,r.TeamsCortanaActionStatus.Success))},t.prototype.goToPreviousSlide=function(e){return this.logger.info("Voice Skills: navigate to previous slide for active presentation on callId "+e),this.eventingService.$emit(this.constants.events.calling.pptSharingPrev,{callId:e}),Promise.resolve(this.presentActionResult(o.ClientSkillsActions.meeting.navigateDeck,r.TeamsCortanaActionStatus.Success))},t.prototype.goToSlide=function(e,t){return this.logger.info("Voice Skills: navigate to slide "+t+" for active presentation on callId "+e),this.eventingService.$emit(this.constants.events.calling.pptSharingGoTo,{callId:e,index:parseInt(t).toString()}),Promise.resolve(this.presentActionResult(o.ClientSkillsActions.meeting.navigateDeck,r.TeamsCortanaActionStatus.Success))},t.prototype.presentActionResult=function(e,t,n,i){return void 0===n&&(n=""),void 0===i&&(i=!0),{status:t,actionId:this.actionId,dismissOnAction:i,actionResponseData:this.getPresentResponseData(e,t===r.TeamsCortanaActionStatus.Success,n)}},t.prototype.getPresentResponseData=function(e,t,n){return e?{id:o.ClientSkillsId.meeting,event:e,slots:{success:t,errorMessage:n||""}}:null},t.prototype.getActivePptSharingSession=function(){var e=_.find(this.contentSharingService.activeSessions,function(e){return e.session&&"ppt"===e.session.contentType});return e&&e.session},t}(r.TeamsCortanaActionHandlerBase);t.PresentActionHandler=a,angular.module("teamspace.presentActionHandler",["teamspace.callingService","teamspace.callingNavigationService","teamspace.contentSharingService","teamspace.eventingService","teamspace.loggingService"]).service("presentActionHandler",a)},2156:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(19),o=function(e){function t(t,n){var i=e.call(this,r.TeamsActionsId.teamsMiscAction)||this;return i.constants=t,i.eventingService=n,i}return i(t,e),t.$inject=["constants","eventingService"],t.prototype.handleAction=function(e){var t=e;return t&&t.type?t.type===r.TeamsMiscActionType.Search&&t.query?(this.eventingService.$emit(this.constants.events.search.performSearch,{searchStr:t.query}),Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Success,!0,null,r.TeamsMiscActionType.Search))):t.type===r.TeamsMiscActionType.Dismiss?Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Success,!0,null,r.TeamsMiscActionType.Dismiss)):Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.InvalidActionData)):Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Error))},t}(r.TeamsCortanaActionHandlerBase);t.TeamsMiscActionHandler=o,angular.module("teamspace.teamsMiscActionHandler",["teamspace.eventingService"]).service("teamsMiscActionHandler",o)},2157:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(19),o=function(e){function t(t,n,i,o,a,s,c){var l=e.call(this,r.TeamsActionsId.sendMessageAction)||this;return l.$q=t,l.conversationsAsyncService=n,l.htmlSanitizer=i,l.messageService=a,l.peopleService=s,l.utilityService=c,l.logger=o.newLogger("SendMessageActionHandler"),l}return i(t,e),t.$inject=["$q","conversationsAsyncService","htmlSanitizer","loggingService","messageService","peopleService","utilityService"],t.prototype.handleAction=function(e){var t=this,n=e;if(this.logger.info("send message invoked"),!n)return this.logger.info("empty send message action"),Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Error));var i=n.mris&&n.mris.length>0,o=n.userPrincipalNames&&n.userPrincipalNames.length>0,a=n.conversationId,s=n.replyChainId;if(!o&&!a&&!i)return this.logger.info("missing missing upns, conversation, and mri"),Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Error));var c;if(n.conversationId)this.logger.info("invoking via conversation ID"),c=Promise.resolve(n.conversationId);else{this.logger.info("invoked with upn or mri");var l=Promise.resolve(null);o&&(l=this.peopleService.getAllShortPeopleProfile(n.userPrincipalNames,"sendMessageActionHandler",!0).then(function(e){return e&&e.length?_.map(e,function(e){return e.mri}):(t.logger.error("failed to find message contact by contactId"),null)})),c=l.then(function(e){return e=e||[],n.mris&&(e=e.concat(n.mris)),t.conversationsAsyncService.getChatConversationWith(e)}).then(function(e){return e?e.id:""})}var u=this.utilityService.escapeHtml(n.message);return n.hyperlinks&&_.forEach(n.hyperlinks,function(e){u+="<a href='"+e.href+"'>"+t.utilityService.escapeHtml(e.text)+"</a>"}),this.htmlSanitizer.sanitizeHtml(u),c.then(function(e){if(!e)return t.$q.reject("threadId is empty");var n=SkypeX.Services.Utilities.newClientMessageId();return t.messageService.createMessage({conversationId:e,replyChainId:s,messageSubject:null,messageBody:u,messagePreview:u,fileAttachments:null,extensions:null,mentions:null,inputExtensionAttachments:null,embeddedLinks:null,isHtml:!0,importance:null,clientId:n,externalId:null,draftObjectId:null,inlineImages:null})}).then(function(){return t.sendMessageActionResult(n.eventInfo,r.TeamsCortanaActionStatus.Success)}).catch(function(e){return t.logger.error(e),t.sendMessageActionResult(n.eventInfo,r.TeamsCortanaActionStatus.Error,e)})},t.prototype.sendMessageActionResult=function(e,t,n){return void 0===n&&(n=!0),{status:t,actionId:this.actionId,dismissOnAction:n,actionResponseData:this.getSendMessageResponseData(e,t===r.TeamsCortanaActionStatus.Success)}},t.prototype.getSendMessageResponseData=function(e,t,n){return e&&(e.id||e.event||e.domain||e.intent)?{id:e.id,event:e.event,slots:{success:t,errorMessage:n||""}}:null},t}(r.TeamsCortanaActionHandlerBase);t.SendMessageActionHandler=o,angular.module("teamspace.sendMessageActionHandler",["teamspace.conversationsAsyncService","teamspace.htmlSanitizer","teamspace.loggingService","teamspace.messageService","teamspace.peopleService","teamspace.utilityService"]).service("sendMessageActionHandler",o)},2158:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(19),o=function(e){function t(t,n){var i=e.call(this,r.TeamsActionsId.setStatus)||this;return i.presenceService=n,i.userStatusMap={available:SkypeX.Services.UserStatus.Online,away:SkypeX.Services.UserStatus.Away,beRightBack:SkypeX.Services.UserStatus.BeRightBack,busy:SkypeX.Services.UserStatus.Busy,doNotDisturb:SkypeX.Services.UserStatus.OutToLunch,outOfOffice:SkypeX.Services.UserStatus.OutOfOffice},i.logger=t.newLogger("SetStatusActionHandler"),i}return i(t,e),t.$inject=["loggingService","presenceService"],t.prototype.handleAction=function(e){var t=this,n=e;if(!n)return this.logger.error("null setStatusAction"),Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Error));var i=this.userStatusMap[n.userStatus];if(!i)return this.logger.error("invalid user status passed in: "+n.userStatus),Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Error));this.logger.info("setting user status to "+i);var o=this.presenceService.createPanelActionEventData(teamspace.components.PanelActionGesture.submit,teamspace.components.PanelActionOutcome.submit,teamspace.components.PanelModuleName.setPresence,teamspace.components.PanelModuleType.menu,"cortanaService.SetStatusActionHandler");return this.presenceService.setMyStatus(i,o,!0,!0).then(function(){return t.actionResult(r.TeamsCortanaActionStatus.Success,!0,null,n.userStatus)}).catch(function(e){return t.logger.error(e),t.actionResult(r.TeamsCortanaActionStatus.Error)})},t}(r.TeamsCortanaActionHandlerBase);t.SetStatusActionHandler=o,angular.module("teamspace.setStatusActionHandler",["skypeX.presenceService","teamspace.loggingService"]).service("setStatusActionHandler",o)},2159:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(19),o=function(e){function t(t,n,i,o,a,s){var c=e.call(this,r.TeamsActionsId.channelAction)||this;return c.channelService=t,c.peopleService=i,c.personalConversationService=o,c.teamMembershipService=a,c.teamMembershipPropertiesService=s,c.logger=n.newLogger("TeamChannelActionHandler"),c}return i(t,e),t.$inject=["channelService","loggingService","peopleService","personalConversationService","teamMembershipService","teamMembershipPropertiesService"],t.prototype.handleAction=function(e){var t=this,n=e;if(!n||!n.type)return Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Error));if(!n.channelId&&!n.teamId)return this.logger.error("no channel or team id received"),Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Error));var i=n.type,o=null;return i===r.TeamChannelActionType.favorite||i===r.TeamChannelActionType.unfavorite?o=this.favoriteAction(n.teamId,n.channelId,i===r.TeamChannelActionType.favorite):i===r.TeamChannelActionType.follow||i===r.TeamChannelActionType.unfollow?o=this.followAction(n.channelId,i===r.TeamChannelActionType.follow):i===r.TeamChannelActionType.addToTeam?o=this.addToTeam(n.teamId,n.userPrincipalNames):i===r.TeamChannelActionType.removeFromTeam&&(o=this.removeFromTeam(n.teamId,n.userPrincipalNames)),o?o.then(function(e){var n=t.actionResult(e?r.TeamsCortanaActionStatus.Success:r.TeamsCortanaActionStatus.Error);return n.actionInfo=i,n}):Promise.resolve(this.actionResult(r.TeamsCortanaActionStatus.Error))},t.prototype.addToTeam=function(e,t){var n=this;if(!e||!t||0===t.length)return this.logger.error("missing team id or user id for add to team action"),Promise.resolve(!1);var i=t[0];return new Promise(function(t,r){try{var o;n.peopleService.getAllShortPeopleProfile([i],"teamChannelActionHandler-addToTeam",!0).then(function(t){return t&&0!==t.length?(o=t[0],o.isOwner=!1,o.isOwnerSpecified=!1,o.role=teamspace.middletier.Role.Member,n.channelService.getTeamById(e)):(n.logger.error("cannot find user to add to team"),null)}).then(function(e){return e?n.teamMembershipPropertiesService.isAdmin(e.objectId)?n.teamMembershipService.addTeamUsers(e,[o]):(n.logger.error("user is not an admin for this team"),null):null}).then(function(e){!e||e.addedMembers&&1===e.addedMembers.length||n.logger.error("failed to add user to the team"),t(!0)}).catch(function(e){n.logger.error("add to team action failed"),t(!1)})}catch(e){r(e)}})},t.prototype.removeFromTeam=function(e,t){var n=this;if(!e||!t||0===t.length)return this.logger.error("missing team id or user id for remove from team action"),Promise.resolve(!1);var i=t[0];return new Promise(function(t,r){try{n.peopleService.getAllShortPeopleProfile([i],"teamChannelActionHandler-removeFromTeam",!0).then(function(e){return e&&0!==e.length?e[0].mri:(n.logger.error("cannot find user to remove from team"),null)}).then(function(t){return n.teamMembershipService.removeTeamUser(e,i,t)}).then(function(e){t(!0)}).catch(function(e){n.logger.error("remove from team action failed"),t(!1)})}catch(e){r(e)}})},t.prototype.followAction=function(e,t){var n=this;return e?new Promise(function(i,r){try{var o,a;n.channelService.getChannelById(e).then(function(e){if(o=e,(a=o.isFollowed!==t)&&t)return n.personalConversationService.toggleFavoriteSettingForChannel(o,!1,!0)}).then(function(){a&&n.personalConversationService.toggleFollowSettingForChannel(o),i(!0)}).catch(function(e){n.logger.error("failed to get channel for follow action"),i(!1)})}catch(e){r(e)}}):(this.logger.error("missing channel id for follow action"),Promise.resolve(!1))},t.prototype.favoriteAction=function(e,t,n){var i=this;return e&&t?e===t?(this.personalConversationService.toggleFavoriteSettingForTeam(e,n),Promise.resolve(!0)):new Promise(function(e,r){try{i.channelService.getChannelById(t).then(function(t){i.personalConversationService.toggleFavoriteSettingForChannel(t,!1,n),e(!0)}).catch(function(t){i.logger.error("failed to get channel for favorite action"),e(!1)})}catch(e){r(e)}}):(this.logger.error("missing team or channel id for favorite action"),Promise.resolve(!1))},t}(r.TeamsCortanaActionHandlerBase);t.TeamChannelActionHandler=o,angular.module("teamspace.teamChannelActionHandler",["teamspace.channelService","teamspace.loggingService","teamspace.peopleService","teamspace.personalConversationService","teamspace.teamMembershipService"]).service("teamChannelActionHandler",o)},2160:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var r,o=n(301),a=teamspace.services.CortanaDevToolsStorageKeys,s=n(306),c="CortanaAuthService";!function(e){e.Started="started",e.Fail="fail",e.Success="success"}(r||(r={}));var l=function(e){function t(t,n,i,r,o,a){var s=e.call(this,a)||this;return s.authenticationService=t,s.constants=n,s.settingsService=i,s.storageService=r,s.loggingService=o,s.logger=o.newLogger(c),s.initializeOnAppLaunchAndReinit("launch"),s}return i(t,e),t.$inject=["authenticationService","constants","settingsService","storageService","loggingService","orchestrationService"],t.prototype.initializeOnAppLaunchAndReinit=function(e){this.logger.info("initializeOnAppLaunchAndReinit: reason = {0}",e),this.cortanaConstants=this.settingsService.valueFor(this.constants.settings.names.cortanaConstants),this.telemetryCb=function(e,t,n){}},t.prototype.cleanupOnAppTeardown=function(){this.telemetryCb=null,this.cortanaConstants=null},t.prototype.mtmaTelemetryIdentifier=function(){return c},t.prototype.setTelemetryCallback=function(e){this.telemetryCb=e},t.prototype.getToken=function(e){var t=this;return new Promise(function(n,i){var o=t.loggingService.newScenario(t.constants.scenarios.cortana.auth),a=t.cortanaConstants.serviceResource,s={status:r.Started};return t.telemetryCb(teamspace.services.CortanaScenarioLogType.Mark,teamspace.services.CortanaScenarioEventsType.Auth,s),t.authenticationService.getAuthTokens([a]).then(function(i){var a={status:r.Success},s=t.parseTokenExpiry(i);o.stop({cortanaDatabag:JSON.stringify({tokenFetchState:e,expiresIn:s})}),t.telemetryCb(teamspace.services.CortanaScenarioLogType.Mark,teamspace.services.CortanaScenarioEventsType.Auth,a);var c={expiresIn:s,token:i};return t.logger.info("parsed auth token and expiresIn {0}",s),n(c)}).catch(function(n){t.logger.error("cortana auth token failed {0}",n);var r={cortanaDatabag:JSON.stringify({errorMessage:n,tokenFetchState:e})};return o.fail(r),t.telemetryCb(teamspace.services.CortanaScenarioLogType.Mark,teamspace.services.CortanaScenarioEventsType.Auth,r),i(n)})})},t.prototype.getTokenAsync=function(e,t){this.getToken(s.TokenFetchState.AfterSdkInit).then(function(e){t(e)})},Object.defineProperty(t.prototype,"authProviderType",{get:function(){var e,t={authType:e="true"===this.storageService.get(a.useMSA)?o.AuthenticationProviderType.MSA:o.AuthenticationProviderType.AAD};return this.telemetryCb(teamspace.services.CortanaScenarioLogType.Mark,teamspace.services.CortanaScenarioEventsType.Auth,t),this.logger.info("auth type {0}",e),e},enumerable:!0,configurable:!0}),t.prototype.getTokenExpiry=function(){return this.storageService.get("ctokenexpiresat")||0},t.prototype.parseTokenExpiry=function(e){var t=teamspace.services.UtilityServiceStatics.parseJwt(e);if(!t||!t.JWSPayload)return 0;try{var n=teamspace.services.UtilityServiceStatics.base64DecodeStringUrlSafe(t.JWSPayload);if(!n)return 0;var i=JSON.parse(n);return i.exp?i.exp-(new Date).getTime()/1e3:0}catch(e){return 0}},t}(teamspace.services.MTMABase);t.CortanaAuthService=l,angular.module("teamspace.cortanaAuthService",["teamspace.authenticationService","teamspace.loggingService","teamspace.settingsService","teamspace.storageService"]).service("cortanaAuthService",l)},2161:function(e,t,n){"use strict";function i(e,t){if(!e)throw new Error(t+" required");return e}function r(e,t,n){if("number"!=typeof e||e&~t)throw new Error(n+" has wrong values.");return e}Object.defineProperty(t,"__esModule",{value:!0}),t.cortanaStart=t.AuthenticationProviderType=t.CortanaOutputState=t.TtsStreamingType=t.CortanaAudioType=t.SpeechPhraseType=t.UserConsent=t.KwsResult=t.FocusMode=t.CortanaState=t.AudioError=t.CortanaError=t.DialogMode=t.FeedbackType=t.SDKBuild=void 0;var o=n(2162),a=n(2163),s=n(2173),c=n(2174);t.SDKBuild=s.environment;var l;!function(e){e[e.User=0]="User",e[e.Crash=1]="Crash"}(l=t.FeedbackType||(t.FeedbackType={}));!function(e){e.Default="default",e.AudioOnly="audioOnly",e.Distracted="distracted",e.FullAttention="fullAttention"}(t.DialogMode||(t.DialogMode={}));var u;!function(e){e[e.Success=0]="Success",e[e.Timeout=2384461827]="Timeout",e[e.NotOnline=2384461840]="NotOnline",e[e.NoTokens=2384461841]="NoTokens",e[e.NoResponse=2384461843]="NoResponse",e[e.AuthError=2384461850]="AuthError",e[e.Denied=2384461851]="Denied",e[e.UnknownMediaError=2385510401]="UnknownMediaError",e[e.MediaDeviceUnavailable=2385510402]="MediaDeviceUnavailable",e[e.AudioOutput=2385510403]="AudioOutput",e[e.LanguageError=2385510404]="LanguageError"}(u=t.CortanaError||(t.CortanaError={}));!function(e){e[e.None=0]="None",e[e.XRun=1]="XRun",e[e.BuffFull=2]="BuffFull",e[e.BusyLoop=3]="BusyLoop",e[e.InputStall=4]="InputStall",e[e.DeviceLost=5]="DeviceLost",e[e.SessionDisconnected=6]="SessionDisconnected",e[e.SndPrepare=7]="SndPrepare",e[e.TtsAborted=8]="TtsAborted",e[e.TtsCanceled=9]="TtsCanceled",e[e.UnkownFailure=10]="UnkownFailure"}(t.AudioError||(t.AudioError={}));var d;!function(e){e.Ready="ready",e.Listening="listening",e.Thinking="thinking",e.Speaking="speaking"}(d=t.CortanaState||(t.CortanaState={}));!function(e){e.Enter="enter",e.Exit="exit"}(t.FocusMode||(t.FocusMode={}));!function(e){e[e.LocalKwsAccept=1]="LocalKwsAccept",e[e.ServiceKwsAccept=2]="ServiceKwsAccept",e[e.ServiceKwsReject=3]="ServiceKwsReject"}(t.KwsResult||(t.KwsResult={}));var p;!function(e){e[e.None=0]="None",e[e.AllowRecording=1]="AllowRecording",e[e.AllowCortanaLogging=2]="AllowCortanaLogging"}(p=t.UserConsent||(t.UserConsent={}));!function(e){e[e.Partial=1]="Partial",e[e.Final=2]="Final",e[e.ErrorSilence=3]="ErrorSilence"}(t.SpeechPhraseType||(t.SpeechPhraseType={}));!function(e){e[e.Default=0]="Default",e[e.Speech=1]="Speech",e[e.Voice=2]="Voice",e[e.Music=3]="Music",e[e.TelephonyInput=4]="TelephonyInput",e[e.Timer=5]="Timer",e[e.Alarm=6]="Alarm",e[e.Earcon=7]="Earcon",e[e.TelephonyOut=8]="TelephonyOut"}(t.CortanaAudioType||(t.CortanaAudioType={}));var h;!function(e){e[e.Websocket=0]="Websocket",e[e.Streaming=1]="Streaming"}(h=t.TtsStreamingType||(t.TtsStreamingType={}));var g;!function(e){e.Running="running",e.Stopped="stopped",e.Paused="paused"}(g=t.CortanaOutputState||(t.CortanaOutputState={}));!function(e){e.MSA="MSA",e.AAD="AAD",e.Office="Office"}(t.AuthenticationProviderType||(t.AuthenticationProviderType={}));var f=function(){function e(e){this.skills=[],this.cortana=e}return e.prototype.execute=function(e){var t=this.getSkill(e.id);t&&t.execute(JSON.parse(e.context))},e.prototype.context=function(e){var t=this.getSkill(e);return t?t.context:null},e.prototype.add=function(e){if(i(e,"skill"),i(e.id,"id"),this.getSkill(e.id))throw new Error("Duplicate skill "+e.id+" registered.");this.skills.push(e),e.onRegistered&&e.onRegistered(this.cortana),this.onSkillRegistered(e)},e.prototype.remove=function(e){this.requireSkill(e.id),this.onSkillRemoved(e)},e.prototype.sendEvent=function(e,t,n){this.requireSkill(e.id),i(t,"name"),this.onSkillEvent(e,t,n)},e.prototype.requireSkill=function(e){if(!this.getSkill(e))throw new Error("Skill "+e+" not found.")},e.prototype.getSkill=function(e){for(var t=0;t<this.skills.length;++t)if(this.skills[t].id==e)return this.skills[t];return null},e}(),v=function(){function e(e,t){this.decoding=!1,this.logger=t,this.url=e,this.ctx=new AudioContext,this.gain=this.ctx.createGain(),this.gain.connect(this.ctx.destination)}return e.prototype.play=function(){var e=this.paused;this.paused=!1,this.source?e||this.source.start(this.currentTime):(this.currentTime=0,this.decoding=!1,this.streams=[],this.buffers=[]),this.dowork()},e.prototype.stop=function(){this.source&&(this.source.stop(),this.source.disconnect(),this.source=null),this.ctx&&(this.ctx.destination.disconnect(),this.ctx.close())},e.prototype.pause=function(){this.paused=!0,this.source&&(this.currentTime=this.source.context.currentTime,this.source.stop())},Object.defineProperty(e.prototype,"volume",{set:function(e){this.gain.gain.value=e},enumerable:!1,configurable:!0}),e.prototype.getHeader=function(e,t){for(var n=e.split("\n"),i=0;i<n.length;++i){var r=n[i].split(":");if(r[0].trim().toLowerCase()==t.toLowerCase())return r[1].trim()}return null},e.prototype.arrayBufferToString=function(e){for(var t="",n=new Int8Array(e),i=0;i<n.length;++i){var r=n[i];t+=String.fromCharCode(r)}return t},e.prototype.dowork=function(){var e;if(!this.paused){if(this.logger.error("dowork decoding:"+this.decoding+" buffers:"+this.buffers.length+" streams:"+this.streams.length),!this.decoding&&this.buffers.length>0){var t=this.buffers[0];this.buffers=this.buffers.slice(1),this.playBuffer(t)}0==this.buffers.length&&(0==this.streams.length&&this.streams.push(this.url),0!=this.streams.length&&(e=this.streams[0],this.streams=this.streams.slice(1),this.logger.error("hls "+e),this.download(e)))}},e.prototype.download=function(e){var t=this,n=new XMLHttpRequest;n.open("GET",e),n.responseType="arraybuffer",n.onload=function(){if(4==n.readyState&&(t.logger.error("url done "+e),n.response)){var i=t.getHeader(n.getAllResponseHeaders(),"Content-Type");if(i)switch(i.toLowerCase()){case"application/vnd.apple.mpegurl":t.handleHLS(t.arrayBufferToString(n.response));break;default:t.decodeBuffer(n.response)}t.dowork()}},n.send()},e.prototype.decodeBuffer=function(e){var t=this,n=this.ctx.createBufferSource();this.ctx.decodeAudioData(e,function(e){n.buffer=e,t.buffers.push(n)},function(){t.logger.error("fail!")})},e.prototype.playBuffer=function(e){var t=this;this.decoding=!0,e.onended=function(){t.decoding=!1,t.dowork(),e.buffer&&(t.currentTime+=e.buffer.duration),t.timechanged()},this.source=e,e.connect(this.gain),e.start()},e.prototype.handleHLS=function(e){for(var t,n,i=e.split("\n"),r=0;r<i.length;++r)if("#"==i[r][0]){var o=i[r].indexOf(":"),a=[i[r].substr(0,o),i[r].substr(o+1)];switch(a[0]){case"#EXT-X-STREAM-INF":this.streams.push(i[++r]);break;case"#EXTINF":n=!1,(t=this.getHLSMeta(a[1])).title&&(this.track=t.title,n=!0),t.amgArtworkURL&&(this.imageUri=t.amgArtworkURL,n=!0),t.artist&&(this.artist=t.artist,n=!0),n&&this.ontrackchanged&&this.ontrackchanged(),this.streams.push(i[++r])}}},e.prototype.stripQuotes=function(e){return!(e=e.trim()).length||'"'!=e[0]&&"'"!=e[0]||(e=e.substr(1,e.length-2)),e},e.prototype.splitNameValue=function(e){var t=e.indexOf("=");return-1==t?null:[e.substr(0,t).trim(),this.stripQuotes(e.substr(t+1).trim())]},e.prototype.splitWithQuotes=function(e,t){for(var n,i={},r=0,o=[],a=0;a<e.length;++a)if(o.length&&o[o.length-1]==e[a])o=o.slice(0,o.length-1);else switch(e[a]){case'"':case"'":o.push(e[a]);break;case t:n=this.splitNameValue(e.substr(r,a-r)),r=a+1,n&&(i[n[0]]=n[1])}return r<e.length&&(n=this.splitNameValue(e.substr(r)))&&(i[n[0]]=n[1]),i},e.prototype.getHLSMeta=function(e){var t={};if((t=this.splitWithQuotes(e,",")).url){var n=this.splitWithQuotes(t.url.replace(/\\"/g,'"')," ");for(var i in n)t[i]=n[i]}return t},e.prototype.timechanged=function(){this.ontimeupdate&&this.ontimeupdate()},e}(),m=function(){function e(e,t){var n=this;this.logger=t,this.cortana=e,this.audio=document.createElement("audio"),this.audio.crossorigin="anonymous",this.source=document.createElement("source"),this.audio.appendChild(this.source),document.body.appendChild(this.audio),this.audio.onended=function(){n.stop()},this.audio.ontimeupdate=function(){n.currentTime=n.audio.currentTime,n.timeUpdate()}}return e.prototype.playStream=function(e){if(this.pause(),e.streamUri=e.streamUri.replace("http:","https:"),this.album=e.album,this.artist=e.artist,this.track=e.track,this.imageUris=[],e.imageUri&&this.imageUris.push(e.imageUri),this.trackchanged(),e.streamFormat)switch(e.streamFormat){case"SECURE_HLS":return void this.handleHLS(e.streamUri)}this.source.src=e.streamUri,this.contentLoaded()},e.prototype.stop=function(){this.loaded=!1,this.hls?(this.hls.stop(),this.hls=null):(this.audio.pause(),this.source.src=""),this.cortana.mediaPlayer=null},e.prototype.pause=function(){this.hls?this.hls.pause():this.audio.pause()},e.prototype.play=function(){var e=this;this.hls?this.hls.play():this.audio.play().catch(function(t){"NotAllowedError"==t.name&&e.onNeedsAcceptance&&e.onNeedsAcceptance()})},e.prototype.next=function(){},e.prototype.previous=function(){},Object.defineProperty(e.prototype,"volume",{get:function(){return this.audio.volume},set:function(e){this.audio.volume=e,this.hls&&(this.hls.volume=e)},enumerable:!1,configurable:!0}),e.prototype.handleHLS=function(e){var t=this,n=new v(e,this.logger);n.ontimeupdate=function(){t.logger.error("ontimeupdate"),t.currentTime=n.currentTime,t.timeUpdate()},n.ontrackchanged=function(){t.logger.error("trackchanged"),t.album=n.album||t.album,t.artist=n.artist||t.artist,t.track=n.track||t.track,t.imageUris=n.imageUri?[n.imageUri]:t.imageUris,t.trackchanged()},this.hls=n,this.hls.volume=this.audio.volume,this.hls.play()},e.prototype.contentLoaded=function(){this.loaded||(this.loaded=!0,this.audio.load())},e.prototype.timeUpdate=function(){this.ontimeupdate&&this.ontimeupdate()},e.prototype.trackchanged=function(){this.ontrackchanged&&this.ontrackchanged()},e}(),S="skill",y="crash",C="listening.slk",A="C_113_c_unabletoreachinternet.slk",w="C_117_c_serviceerror.slk",_=function(){function e(e,t){var r=this;this.musicVol_=1,this.loadSteps=0,this.loadStep=0,this.ready=!1,i(e,"IHostConfig"),this.logger=e.logger||console,window.AWT?window.AWT.initialize=function(){}:window.AWT=a.AWT,this.config=this.getConfig(e),this.checkAuthenticatorNullability(),this.resourceMap={"cortanabox.prod.wasm":n(2177),"heycortana_en-US.table":n(2178),"done_listening.slk":n(2179),"processing.slk":n(2180),"S_305_d_volumeup.slk":n(2181),"S_306_d_volumedown.slk":n(2182),"timer.slk":n(2183),"alarm.slk":n(2184)},this.resourceMap[A]=n(2185),this.resourceMap[w]=n(2186),this.resourceMap[C]=n(2187),this.setLoadState(0,3,"initializing"),this.player_=new m(this,this.logger),this.feedback=e.feedback;var o=new f(this);o.onSkillRegistered=function(e){r.sendEvent(S,"add",{id:e.id,contextName:e.contextName})},o.onSkillRemoved=function(e){r.sendEvent(S,"remove",{id:e.id})},o.onSkillEvent=function(e,t,n){r.sendCustomEvent(e.id,t,n)},this.skills=o;var s={onAbort:function(e){r.feedback&&r.feedback.sendFeedback(l.Crash,e),localStorage.setItem(y,"1")},locateFile:function(t,n){r.scriptDirectory=r.scriptDirectory||n;var i=r.resourceMap[t];if(i){if(/^(http(s?)):/.test(i))return i;"cortanabox.prod.wasm"===t?e.binPath&&(n=e.binPath):e.dataPath&&(n=e.dataPath),t=i}return n+t},print:function(e){r.logger.log(e)},printErr:function(e){r.logger.warn(e)}};this.setLoadState(0,2,"WASM module loading"),c(s).then(function(n){r.wasmModule=n,r.wasmModule.onAudioData=function(e){r.onAudioData&&r.onAudioData(e)},window.onWasmModule&&window.onWasmModule(r.wasmModule),r.setLoadState(1,0,"WASM runtime loaded"),r.wasmModule.onPostMessage=function(e){r.postMessage(JSON.parse(e))},r.handle=r.wasmModule._host_create(),e.skills&&e.skills.forEach(function(e){r.skills.add(e)}),r.setLoadState(1,0,"initialized"),t()}),this.setLoadState(1,0,"WASM module loaded")}return e.prototype.start=function(e){if(this.wasmModule){this._startcomplete=e,this.skills.add(new o.AdaptiveCardSkill),this.config.dataPath&&this.sendEvent("cortana","dataPath",this.config.dataPath),this.authenticator=this.config.authenticator,this.sendEvent("auth","type",this.config.authenticator.authProviderType);var n=this.config.app.version+" WebSDK/"+t.SDKBuild.version;this.sendEvent("settings","config",{app:{company:this.config.app.company,flavor:this.config.app.flavor,name:this.config.app.name,ring:this.config.app.ring,version:n},device:this.config.device,qos:this.config.qos,earcon:this.config.soundEffects?1:0,endpoint:this.config.endpoint}),this.sendEvent("cortana","start"),this.updateLocation()}},e.prototype.close=function(){this.sendEvent("cortana","stop"),this.wasmModule._host_destroy(this.handle),window.onUnloadWasmModule&&window.onUnloadWasmModule(this.wasmModule),this.wasmModule=null},Object.defineProperty(e.prototype,"coords",{set:function(e){this.sendEvent("settings","coords",{latitude:e.latitude,longitude:e.longitude})},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"timeZone",{set:function(e){this.sendEvent("settings","timeZone",e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"language",{get:function(){return this.language_},set:function(e){if(this.language_=e,this.sendEvent("settings","language",e)==u.LanguageError)throw new Error("Error 0x"+u.LanguageError.toString(16)+": The language provided is not in the correct format (lowercase-UPPERCASE)")},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"mediaPlayer",{get:function(){return this.mediaPlayer_},set:function(e){this.mediaPlayer_=e,this.sendEvent("mediactl",e?"reg":"unreg"),e&&(e.volume=this.musicVol_),this.onPlayerChanged&&this.onPlayerChanged(e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"keywordSpotting",{get:function(){return this.keywordSpotting_},set:function(e){this.keywordSpotting_=e,this.sendEvent("cortana","kwsState",e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"voiceFont",{get:function(){return this.voiceFont_},set:function(e){this.voiceFont_=e,this.sendEvent("cortana","voiceFont",e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"dialogMode",{get:function(){return this.dialogMode_},set:function(e){this.dialogMode_=e,this.sendEvent("cortana","dialogMode",e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"userConsent",{get:function(){return this.userConsent_},set:function(e){this.userConsent_=r(e,p.AllowRecording|p.AllowCortanaLogging,"userConsent"),this.sendEvent("cortana","userConsent",e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"kwsConfidenceThreshold",{get:function(){return this.kwsConfidenceThreshold_},set:function(e){this.kwsConfidenceThreshold_=e,this.sendEvent("cortana","kwsConfidence",e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"audioOutputId",{set:function(e){this.sendEvent("cortana","AudioOutputId",e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"audioInputId",{set:function(e){this.sendEvent("cortana","AudioInputId",e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"authenticator",{get:function(){return this.authenticator_},set:function(e){this.authenticator_=e,this.config.authenticator=e,this.checkAuthenticatorNullability(),this.sendEvent("auth","type",this.config.authenticator.authProviderType)},enumerable:!1,configurable:!0}),e.prototype.listen=function(){this.setCortanaState(d.Listening)},e.prototype.stopListening=function(){this.setCortanaState(d.Ready)},e.prototype.cancel=function(){this.sendEvent("cortana","cancel")},e.prototype.actionComplete=function(){this.sendEvent("cortana","actionComplete")},e.prototype.onPlayerStateChanged=function(e){this.sendEvent("mediactl",e)},e.prototype.sendFeedback=function(){this.feedback&&this.feedback.sendFeedback(l.User)},e.prototype.textQuery=function(e){switch(e=e.trim()){case"/sendfeedback":return this.sendFeedback()}this.sendEvent("text","text",e)},e.prototype.sendCustomEvent=function(e,t,n){this.sendEvent(S,"evt",{id:e,name:t,context:n})},e.prototype.pauseAudioOutput=function(e){this.sendEvent("cortana","pauseAudioOutput",e)},e.prototype.stopAudioOutput=function(e){this.sendEvent("cortana","stopAudioOutput",e)},e.prototype.resumeAudioOutput=function(e){this.sendEvent("cortana","resumeAudioOutput",e)},e.prototype.muteAudioInput=function(e){this.sendEvent("cortana","muteAudioInput",e)},e.prototype.playNextAudioOutput=function(e){this.sendEvent("cortana","playNextAudioOutput",e)},e.prototype.setTtsAutoPlay=function(e){this.sendEvent("cortana","setTtsAutoPlay",e)},e.prototype.setTtsStreaming=function(e){e==h.Websocket&&this.sendEvent("cortana","enableTtsStreaming",e)},e.prototype.prefetchResources=function(){var e=this;[C,A,w].forEach(function(t){fetch(e.wasmModule.locateFile(t,e.scriptDirectory)).then(function(){})})},e.prototype.checkAuthenticatorNullability=function(){i(this.config.authenticator,"IHostConfig.authenticator"),i(this.config.authenticator.authProviderType,"IHostConfig.authenticator.authProviderType")},e.prototype.setLoadState=function(e,t,n){this.loadStep+=e,this.loadSteps+=t;var i=this.loadStep/this.loadSteps;this.config.loadProgress&&this.config.loadProgress(i,n)},e.prototype.postMessage=function(e){var t=this;if(e)switch(e.event){case"stateChanged":this.stateChanged(this.stringToCortanaState(e.state));break;case"audio.vol":this.setVolume(e);break;case"speech.phrase":this.speechPhrase(e);break;case"displayText":this.displayText(e.text);break;case"focusMode":this.focusMode(e.mode);break;case"player.playStream":this.playerPlayStream(e);break;case"error":this.handleError(e.error);break;case"tokenRequest":this.handleTokenRequest(e.scope);break;case"requestinfo":e.correlationId&&(this.correlationId=e.correlationId,this.logger.log("correlationId:"+this.correlationId)),e.serviceTag&&(this.serviceTag=e.serviceTag,this.logger.log("serviceTag:"+this.serviceTag)),["correlationId","serviceTag","devicethumbprint"].forEach(function(n){e[n]&&t.feedback&&t.feedback.setProperty(n,e[n])});break;case"skill.exec":this.skills.execute(e);break;case"skill.context":this.handleSkillContext(e);break;case"initialized":this.setLoadState(1,0,"config prepared");break;case"AudioError":this.audioError(e.error);break;case"AudioProgress":this.audioProgress(e.offsetBytes,e.totalBytes);break;case"AudioOutputState":this.audioOutputState(this.stringToAudioOutputState(e.state));break;case"KeywordSpotterEvent":this.keywordSpotterEvent(e.result,e.confidence);break;default:var n=e.event.split(".");if(2==n.length)switch(n[0]){case"player":return i(this.mediaPlayer,"mediaPlayer")[n[1]](),void("stop"===n[1]&&(this.mediaPlayer=null))}this.logger.error("Unhandled message: "+JSON.stringify(e))}else this.logger.error("Unhandled message: "+e)},e.prototype.getConfig=function(e){e.device||(e.device={}),i(e.app,"IHostConfig.app");var t,n=navigator.userAgent;if(!e.device.model)if(window.chrome&&"Google Inc."==navigator.vendor){e.device.model="Chrome";var r=/Chrome\/([0-9.]+)(.*)/g.exec(n);r&&r.length&&(t=r[1])}else{e.device.model=n;for(var o=["Electron","Edge","Firefox","Safari"],a=0;a<o.length;a++){var s=o[a],c=n.indexOf(s+"/");if(c>0){e.device.model=s,t=n.substr(c+s.length+1).split(" ")[0];break}}}return e.device.version||(e.device.version=e.app.version||t),e},e.prototype.stringToCortanaState=function(e){switch(e){case d.Listening:return d.Listening;case d.Speaking:return d.Speaking;case d.Thinking:return d.Thinking;default:return d.Ready}},e.prototype.stringToAudioOutputState=function(e){switch(e){case g.Running:return g.Running;case g.Stopped:return g.Stopped;case g.Paused:return g.Paused;default:return g.Stopped}},e.prototype.handleError=function(e){this.onError&&this.onError(e)},e.prototype.updateLocation=function(){var e=this;this.timeZone=Intl.DateTimeFormat().resolvedOptions().timeZone,this.config.disableGeolocation?this.config.coords&&(this.coords=this.config.coords):navigator.geolocation.getCurrentPosition(function(t){e.coords=t.coords})},e.prototype.setCortanaState=function(e){this.sendEvent("cortana","state",e)},e.prototype.sendEvent=function(e,t,n){var i={event:{id:e,event:t}};return void 0!==n&&(i.event[t]=n),this.sendMessage(i)},e.prototype.stateChanged=function(e){this.logger.log("stateChanged:"+e),this.ready||e!=d.Ready||(this.ready=!0,this.setLoadState(1,0,"ready"),this._startcomplete&&this._startcomplete(),this.prefetchResources()),this.onStateChange&&this.onStateChange(e)},e.prototype.audioError=function(e){this.logger.log("audioError:"+e),this.onAudioError&&this.onAudioError(e)},e.prototype.audioOutputState=function(e){this.onAudioOutputState&&this.onAudioOutputState(e)},e.prototype.audioProgress=function(e,t){this.logger.log("audio progress, offset: "+e+" + total: "+t),this.onAudioProgress&&this.onAudioProgress(e,t)},e.prototype.speechPhrase=function(e){this.onSpeechPhrase&&this.onSpeechPhrase(e)},e.prototype.displayText=function(e){this.onDisplayText&&this.onDisplayText(e)},e.prototype.focusMode=function(e){this.onFocusModeChanged&&this.onFocusModeChanged(e)},e.prototype.keywordSpotterEvent=function(e,t){this.onKeywordSpotterEvent&&this.onKeywordSpotterEvent(e,t)},e.prototype.setVolume=function(e){this.musicVol_=e.vol,this.mediaPlayer&&(this.mediaPlayer.volume=this.musicVol_)},e.prototype.playerPlayStream=function(e){this.mediaPlayer=this.player_,this.player_.playStream(e)},e.prototype.handleTokenRequest=function(e){var t=this;this.config.authenticator.getTokenAsync(e,function(n){t.sendEvent("auth","token",{scope:e,token:n.token,expires:n.expiresIn})})},e.prototype.handleSkillContext=function(e){var t=this.skills.context(e.id);if(t){var n=this.wasmModule.allocateUTF8(JSON.stringify(t));this.wasmModule._skillctx(e.cb,n,e.context),this.wasmModule._free(n)}},e.prototype.sendMessage=function(e){var t=this.wasmModule.allocateUTF8(JSON.stringify(e)),n=this.wasmModule._host_postmessage(this.handle,t);return this.wasmModule&&this.wasmModule._free(t),n},e}();t.cortanaStart=function(e,t){return new Promise(function(n,i){var r=new _(e,function(){t&&t(r);try{r.start(function(){n(r)})}catch(e){r.close(),i(e)}})})}},2162:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AdaptiveCardSkill=void 0;var i=function(){function e(){}return Object.defineProperty(e.prototype,"id",{get:function(){return"skill:card"},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"contextName",{get:function(){return"card"},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"context",{get:function(){return{version:1,settings:{renderingFormat:"Adaptive"}}},enumerable:!1,configurable:!0}),e.prototype.onRegistered=function(e){this.cortana=e},e.prototype.execute=function(e){e.action&&this[e.action]&&this[e.action](e)},e.prototype.render=function(e){this.cortana&&this.cortana.onAdaptiveCards&&this.cortana.onAdaptiveCards(e.cards)},e}();t.AdaptiveCardSkill=i},2163:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(131);t.AWTPiiKind=i.AWTPiiKind;var r=n(2164);t.AWT=r.default,t.AWT_COLLECTOR_URL_UNITED_STATES="https://us.pipe.aria.microsoft.com/Collector/3.0/",t.AWT_COLLECTOR_URL_GERMANY="https://de.pipe.aria.microsoft.com/Collector/3.0/",t.AWT_COLLECTOR_URL_JAPAN="https://jp.pipe.aria.microsoft.com/Collector/3.0/",t.AWT_COLLECTOR_URL_AUSTRALIA="https://au.pipe.aria.microsoft.com/Collector/3.0/",t.AWT_COLLECTOR_URL_EUROPE="https://eu.pipe.aria.microsoft.com/Collector/3.0/"},2164:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(131),r=n(2165),o=n(303),a=n(304),s=/^[a-zA-Z0-9]([a-zA-Z0-9]|_){2,98}[a-zA-Z0-9]$/,c=/\./g,l=/^[a-zA-Z0-9](([a-zA-Z0-9|_|\.]){0,98}[a-zA-Z0-9])?$/,u=function(){function e(){}return e.initialize=function(e,t){if(void 0===t&&(t={}),this._isInitialized)throw"Already Initialized";this._defaultTenantToken=e,this._overrideValuesFromConfig(t),r.default.initialize(this._config),this._isInitialized=!0},e.flush=function(e){this._isInitialized&&!this._isDestroyed&&r.default.flush(e)},e.flushAndTeardown=function(){this._isInitialized&&!this._isDestroyed&&(this._isDestroyed=!0,r.default.flushAndTeardown())},e.setContext=function(e,t,n){void 0===n&&(n="allTkns"),null!==(t=this._sanitizeProperty(e,t))&&(this._contextProperties[n]||(this._contextProperties[n]={}),this._contextProperties[n][e]=t)},e.logEvent=function(e){var t=this;if(this._isInitialized){if(!e.name||!e.properties)return;e.name=e.name.toLowerCase(),e.name.replace(c,"_");var n="";if(e.type?(e.type.toLowerCase(),n="custom."):e.type="custom",!s.test(e.name)||!s.test(e.type))return;if(e.type=n+e.type,isNaN(e.timestamp)&&(e.timestamp=(new Date).getTime()),e.tenantToken||(e.tenantToken=this._defaultTenantToken),e.id=o.newGuid(),Object.keys(e.properties).forEach(function(n){e.properties[n]=t._sanitizeProperty(n,e.properties[n]),null===e.properties[n]&&delete e.properties[n]}),this._addContextIfAbsent(e,e.tenantToken),this._addContextIfAbsent(e,"allTkns"),0===Object.keys(e.properties).length)return;this._setDefaultProperty(e,"EventInfo.InitId",this._getInitId(e.tenantToken)),this._setDefaultProperty(e,"EventInfo.Sequence",this._getSequenceId(e.tenantToken)),this._setDefaultProperty(e,"EventInfo.SdkVersion",a.FullVersionString),this._setDefaultProperty(e,"EventInfo.Name",e.name),this._setDefaultProperty(e,"EventInfo.Time",new Date(e.timestamp).toISOString()),r.default.sendEvent(e)}},e._overrideValuesFromConfig=function(e){e.collectorUrl&&(this._config.collectorUrl=e.collectorUrl),e.sendingTimer>1e3&&(this._config.sendingTimer=e.sendingTimer)},e._getInitId=function(e){return void 0===this._initIdMap[e]&&(this._initIdMap[e]=o.newGuid()),this._initIdMap[e]},e._getSequenceId=function(e){return void 0===this._sequenceIdMap[e]&&(this._sequenceIdMap[e]=0),(++this._sequenceIdMap[e]).toString()},e._setDefaultProperty=function(e,t,n){e.properties[t]={value:n,pii:i.AWTPiiKind.NotSet}},e._addContextIfAbsent=function(e,t){if(this._contextProperties[t]){var n=this._contextProperties[t];Object.keys(n).forEach(function(t){e.properties[t]||(e.properties[t]=n[t])})}},e._sanitizeProperty=function(e,t){return"string"!=typeof t&&"number"!=typeof t&&"boolean"!=typeof t||(t={value:t}),l.test(e)&&void 0!==t&&null!==t&&null!==t.value&&void 0!==t.value&&""!==t.value?(void 0===t.pii&&(t.pii=i.AWTPiiKind.NotSet),t.value=t.value.toString(),o.isPii(t.pii)?t:null):null},e._isInitialized=!1,e._isDestroyed=!1,e._contextProperties={},e._sequenceIdMap={},e._initIdMap={},e._config={collectorUrl:"https://browser.pipe.aria.microsoft.com/Collector/3.0/",sendingTimer:1e3},e}();t.default=u},2165:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(2166),r=n(302),o=n(2171),a=n(2172),s=n(304),c=function(){function e(){}return e.initialize=function(e){this._inboundQueues.push([]),this._recordBatcher=new i.default(2936012,this._outboundQueue),this._newEventsAllowed=!0,"undefined"==typeof Uint8Array&&(this._urlString+="&content-encoding=base64"),this._sendingTimer=e.sendingTimer,this._urlString=e.collectorUrl+this._urlString+"&x-apikey="},e.sendEvent=function(e){var t=this;this._newEventsAllowed&&(this._inboundQueues[this._inboundQueues.length-1].push(e),!this._running&&this._timeout<0&&!this._isCurrentlyFlushing&&(this._timeout=setTimeout(function(){return t._batchAndSendEvents(!1)},this._sendingTimer)))},e.flushAndTeardown=function(){this._newEventsAllowed=!1,this._batchAndSendEvents(!0)},e.flush=function(e){this._inboundQueues.push([]),this._isCurrentlyFlushing?this._flushQueue.push(e):(this._isCurrentlyFlushing=!0,this._flush(e))},e._batchAndSendEvents=function(e){for(this._running=!0;this._inboundQueues[0].length>0&&this._outboundQueue.length<1;)this._recordBatcher.addEventToBatch(this._inboundQueues[0].pop());0===this._outboundQueue.length&&this._recordBatcher.flushBatch(),this._sendRequest(this._outboundQueue.pop(),0,e)},e._retryRequestIfNeeded=function(e,t,n,i,r){var a=this,s=!0;e&&void 0!==e.status&&(this._killSwitch.setKillSwitchTenants(e.getResponseHeader("kill-tokens"),e.getResponseHeader("kill-duration-seconds")).forEach(function(e){delete t[e],n--}),(!o.default.shouldRetryForStatus(e.status)||n<=0)&&(s=!1)),s&&r<4?setTimeout(function(){return a._sendRequest(t,r+1,!1)},o.default.getMillisToBackoffForRetry(r)):this._handleRequestFinished(null)},e._sendRequest=function(e,t,n){var i=this,o=new XMLHttpRequest,a=0,s="";if(Object.keys(e).forEach(function(t){i._killSwitch.isTenantKilled(t)?delete e[t]:(s.length>0&&(s+=","),s+=t,a++)}),o.open("POST",this._urlString+s,!n),n||(o.ontimeout=function(){i._retryRequestIfNeeded(o,e,a,s,t)},o.onerror=function(){i._retryRequestIfNeeded(o,e,a,s,t)},o.onload=function(){i._handleRequestFinished(o)}),a>0){var c=r.default.getPayloadBlob(e,a);"undefined"==typeof Uint8Array?o.send(r.default.base64Encode(c)):o.send(new Uint8Array(c))}else n&&this._handleRequestFinished(null)},e._handleRequestFinished=function(e){var t=this;e&&this._killSwitch.setKillSwitchTenants(e.getResponseHeader("kill-tokens"),e.getResponseHeader("kill-duration-seconds")),this._inboundQueues[0].length>0?this._timeout=setTimeout(function(){return t._batchAndSendEvents(!1)},this._sendingTimer):(this._timeout=-1,this._running=!1)},e._flush=function(e){var t=this;this._running||(this._timeout>-1&&(clearTimeout(this._timeout),this._timeout=-1),this._inboundQueues[0].length>0&&this._batchAndSendEvents(!1)),this._checkPrimaryInboundQueueEmpty(function(){t._inboundQueues.shift(),null!==e&&void 0!==e&&e(),t._flushQueue.length>0?setTimeout(function(){return t._flush(t._flushQueue.shift())},t._sendingTimer):(t._isCurrentlyFlushing=!1,t._inboundQueues[0].length>0&&(t._timeout=setTimeout(function(){return t._batchAndSendEvents(!1)},t._sendingTimer)))})},e._checkPrimaryInboundQueueEmpty=function(e){var t=this;0===this._inboundQueues[0].length?this._checkOutboundQueueEmptyAndSent(e):setTimeout(function(){return t._checkPrimaryInboundQueueEmpty(e)},250)},e._checkOutboundQueueEmptyAndSent=function(e){var t=this;this._running?setTimeout(function(){return t._checkOutboundQueueEmptyAndSent(e)},250):e()},e._outboundQueue=[],e._inboundQueues=[],e._newEventsAllowed=!1,e._killSwitch=new a.default,e._isCurrentlyFlushing=!1,e._flushQueue=[],e._running=!1,e._timeout=-1,e._urlString="?qsp=true&content-type=application%2Fbond-compact-binary&client-id=NO_AUTH&sdk-version="+s.FullVersionString,e}();t.default=c},2166:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(302),r=function(){function e(e,t){this._maxRequestSize=e,this._outboundQueue=t,this._currentBatch={},this._currentBatchSize=0}return e.prototype.addEventToBatch=function(e){var t=i.default.getEventBlob(e);t.length>this._maxRequestSize||(this._currentBatchSize+t.length>this._maxRequestSize?this.flushBatch():(void 0===this._currentBatch[e.tenantToken]&&(this._currentBatch[e.tenantToken]=[]),this._currentBatch[e.tenantToken].push(t),this._currentBatchSize+=t.length))},e.prototype.flushBatch=function(){this._currentBatchSize>0&&(this._outboundQueue.push(this._currentBatch),this._currentBatch={},this._currentBatchSize=0)},e}();t.default=r},2167:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(2168);t.BondDataType=i.BondDataType;var r=n(2169);t.Encoding=r;var o=n(2170);t.IO=o;var a=n(89);t.Int64=a.Int64,t.UInt64=a.UInt64,t.Number=a.Number;var s=function(){function e(e){this._stream=e}return e.prototype.WriteBlob=function(e){this._stream.Write(e,0,e.length)},e.prototype.WriteContainerBegin=function(e,t){this.WriteUInt8(t),this.WriteUInt32(e)},e.prototype.WriteMapContainerBegin=function(e,t,n){this.WriteUInt8(t),this.WriteUInt8(n),this.WriteUInt32(e)},e.prototype.WriteFieldBegin=function(e,t){t<=5?this._stream.WriteByte(e|t<<5):t<=255?(this._stream.WriteByte(192|e),this._stream.WriteByte(t)):(this._stream.WriteByte(224|e),this._stream.WriteByte(t),this._stream.WriteByte(t>>8))},e.prototype.WriteInt32=function(e){e=r.Zigzag.EncodeZigzag32(e),this.WriteUInt32(e)},e.prototype.WriteInt64=function(e){this.WriteUInt64(r.Zigzag.EncodeZigzag64(e))},e.prototype.WriteString=function(e){if(""===e)this.WriteUInt32(0);else{var t=r.Utf8.GetBytes(e);this.WriteUInt32(t.length),this._stream.Write(t,0,t.length)}},e.prototype.WriteStructEnd=function(e){this.WriteUInt8(e?i.BondDataType.BT_STOP_BASE:i.BondDataType.BT_STOP)},e.prototype.WriteUInt32=function(e){var t=r.Varint.GetBytes(a.Number.ToUInt32(e));this._stream.Write(t,0,t.length)},e.prototype.WriteUInt64=function(e){var t=r.Varint64.GetBytes(e);this._stream.Write(t,0,t.length)},e.prototype.WriteUInt8=function(e){this._stream.WriteByte(a.Number.ToUInt8(e))},e}();t.CompactBinaryProtocolWriter=s},2168:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});!function(e){e[e.BT_STOP=0]="BT_STOP",e[e.BT_STOP_BASE=1]="BT_STOP_BASE",e[e.BT_UINT8=3]="BT_UINT8",e[e.BT_UINT32=5]="BT_UINT32",e[e.BT_UINT64=6]="BT_UINT64",e[e.BT_STRING=9]="BT_STRING",e[e.BT_STRUCT=10]="BT_STRUCT",e[e.BT_LIST=11]="BT_LIST",e[e.BT_MAP=13]="BT_MAP",e[e.BT_INT32=16]="BT_INT32",e[e.BT_INT64=17]="BT_INT64",e[e.BT_UNAVAILABLE=127]="BT_UNAVAILABLE"}(t.BondDataType||(t.BondDataType={}))},2169:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(89),r=function(){function e(){}return e.GetBytes=function(e){for(var t=[],n=0;n<e.length;++n){var i=e.charCodeAt(n);i<128?t.push(i):i<2048?t.push(192|i>>6,128|63&i):i<55296||i>=57344?t.push(224|i>>12,128|i>>6&63,128|63&i):(i=65536+((1023&i)<<10|1023&e.charCodeAt(++n)),t.push(240|i>>18,128|i>>12&63,128|i>>6&63,128|63&i))}return t},e}();t.Utf8=r;var o=function(){function e(){}return e.GetString=function(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=[],i=e.length%3,r=0,o=e.length-i;r<o;r+=3){a=(e[r]<<16)+(e[r+1]<<8)+e[r+2];n.push(function(e){return[t.charAt(e>>18&63),t.charAt(e>>12&63),t.charAt(e>>6&63),t.charAt(63&e)].join("")}(a))}switch(i){case 1:var a=e[e.length-1];n.push(t.charAt(a>>2)),n.push(t.charAt(a<<4&63)),n.push("==");break;case 2:var s=(e[e.length-2]<<8)+e[e.length-1];n.push(t.charAt(s>>10)),n.push(t.charAt(s>>4&63)),n.push(t.charAt(s<<2&63)),n.push("=")}return n.join("")},e}();t.Base64=o;var a=function(){function e(){}return e.GetBytes=function(e){for(var t=[];4294967168&e;)t.push(127&e|128),e>>>=7;return t.push(127&e),t},e}();t.Varint=a;var s=function(){function e(){}return e.GetBytes=function(e){for(var t=e.low,n=e.high,i=[];n||4294967168&t;)i.push(127&t|128),t=(127&n)<<25|t>>>7,n>>>=7;return i.push(127&t),i},e}();t.Varint64=s;var c=function(){function e(){}return e.EncodeZigzag32=function(e){return(e=i.Number.ToInt32(e))<<1^e>>31},e.EncodeZigzag64=function(e){var t=e.low,n=e.high,r=n<<1|t>>>31,o=t<<1;2147483648&n&&(r=~r,o=~o);var a=new i.UInt64("0");return a.low=o,a.high=r,a},e}();t.Zigzag=c},2170:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(89),r=function(){function e(){this._buffer=[]}return e.prototype.WriteByte=function(e){this._buffer.push(i.Number.ToByte(e))},e.prototype.Write=function(e,t,n){for(;n--;)this.WriteByte(e[t++])},e.prototype.GetBuffer=function(){return this._buffer},e}();t.MemoryStream=r},2171:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){}return e.shouldRetryForStatus=function(e){return!(e>=300&&e<500&&408!==e||501===e||505===e)},e.getMillisToBackoffForRetry=function(e){var t=0,n=Math.floor(1200*Math.random())+2400;return t=Math.pow(4,e)*n,Math.min(t,12e4)},e}();t.default=i},2172:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){this._killedTokenDictionary={}}return e.prototype.setKillSwitchTenants=function(e,t){var n=this;if(e&&t)try{var i=e.split(",");if("this-request-only"===t)return i;var r=1e3*parseInt(t,10);i.forEach(function(e){n._killedTokenDictionary[e]=Date.now()+r})}catch(e){return[]}return[]},e.prototype.isTenantKilled=function(e){return void 0!==this._killedTokenDictionary[e]&&this._killedTokenDictionary[e]>Date.now()||(delete this._killedTokenDictionary[e],!1)},e}();t.default=i},2173:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.environment=void 0,t.environment={version:"174260",time:"2021-08-07T01:05:22.206Z"}},2174:function(e,t,n){(function(t){var n=function(){var e="undefined"!=typeof document&&document.currentScript?document.currentScript.src:void 0;return function(n){function i(e){return Q.locateFile?Q.locateFile(e,ce):ce+e}function r(e,t){return t||(t=pe),Math.ceil(e/t)*t}function o(e){o.shown||(o.shown={}),o.shown[e]||(o.shown[e]=1,ue(e))}function a(e,t){e||k("Assertion failed: "+t)}function s(e,t,n){for(var i=t+n,r=t;e[r]&&!(r>=i);)++r;if(r-t>16&&e.subarray&&Ee)return Ee.decode(e.subarray(t,r));for(var o="";t<r;){var a=e[t++];if(128&a){var s=63&e[t++];if(192!=(224&a)){var c=63&e[t++];if((a=224==(240&a)?(15&a)<<12|s<<6|c:(7&a)<<18|s<<12|c<<6|63&e[t++])<65536)o+=String.fromCharCode(a);else{var l=a-65536;o+=String.fromCharCode(55296|l>>10,56320|1023&l)}}else o+=String.fromCharCode((31&a)<<6|s)}else o+=String.fromCharCode(a)}return o}function c(e,t){return e?s(Se,e,t):""}function l(e,t,n,i){if(!(i>0))return 0;for(var r=n,o=n+i-1,a=0;a<e.length;++a){var s=e.charCodeAt(a);if(s>=55296&&s<=57343&&(s=65536+((1023&s)<<10)|1023&e.charCodeAt(++a)),s<=127){if(n>=o)break;t[n++]=s}else if(s<=2047){if(n+1>=o)break;t[n++]=192|s>>6,t[n++]=128|63&s}else if(s<=65535){if(n+2>=o)break;t[n++]=224|s>>12,t[n++]=128|s>>6&63,t[n++]=128|63&s}else{if(n+3>=o)break;t[n++]=240|s>>18,t[n++]=128|s>>12&63,t[n++]=128|s>>6&63,t[n++]=128|63&s}}return t[n]=0,n-r}function u(e,t,n){return l(e,Se,t,n)}function d(e){for(var t=0,n=0;n<e.length;++n){var i=e.charCodeAt(n);i>=55296&&i<=57343&&(i=65536+((1023&i)<<10)|1023&e.charCodeAt(++n)),i<=127?++t:t+=i<=2047?2:i<=65535?3:4}return t}function p(e){var t=d(e)+1,n=mt(t);return n&&l(e,me,n,t),n}function h(e,t){me.set(e,t)}function g(e,t,n){for(var i=0;i<e.length;++i)me[t++>>0]=e.charCodeAt(i);n||(me[t>>0]=0)}function f(e){ve=e,Q.HEAP8=me=new Int8Array(e),Q.HEAP16=ye=new Int16Array(e),Q.HEAP32=Ae=new Int32Array(e),Q.HEAPU8=Se=new Uint8Array(e),Q.HEAPU16=Ce=new Uint16Array(e),Q.HEAPU32=we=new Uint32Array(e),Q.HEAPF32=_e=new Float32Array(e),Q.HEAPF64=be=new Float64Array(e)}function v(){if(Q.preRun)for("function"==typeof Q.preRun&&(Q.preRun=[Q.preRun]);Q.preRun.length;)C(Q.preRun.shift());D(Ie)}function m(){xe=!0,Q.noFSInit||$e.init.initialized||$e.init(),We.init(),D(Pe)}function S(){$e.ignorePermissions=!1,D(De)}function y(){if(Q.postRun)for("function"==typeof Q.postRun&&(Q.postRun=[Q.postRun]);Q.postRun.length;)A(Q.postRun.shift());D(Me)}function C(e){Ie.unshift(e)}function A(e){Me.unshift(e)}function w(e){return e}function _(e){Re++,Q.monitorRunDependencies&&Q.monitorRunDependencies(Re)}function b(e){if(Re--,Q.monitorRunDependencies&&Q.monitorRunDependencies(Re),0==Re&&(null!==Oe&&(clearInterval(Oe),Oe=null),Fe)){var t=Fe;Fe=null,t()}}function k(e){Q.onAbort&&Q.onAbort(e),ue(e+=""),Te=!0,fe=1,e="abort("+e+"). Build with -s ASSERTIONS=1 for more info.";var t=new WebAssembly.RuntimeError(e);throw Y(t),t}function T(e,t){return String.prototype.startsWith?e.startsWith(t):0===e.indexOf(t)}function E(e){return T(e,Le)}function I(e){try{if(e==Ue&&de)return new Uint8Array(de);if(ne)return ne(e);throw"both async and sync fetching of the wasm failed"}catch(e){k(e)}}function P(){return de||!oe&&!ae||"function"!=typeof fetch?Promise.resolve().then(function(){return I(Ue)}):fetch(Ue,{credentials:"same-origin"}).then(function(e){if(!e.ok)throw"failed to load wasm binary file at '"+Ue+"'";return e.arrayBuffer()}).catch(function(){return I(Ue)})}function D(e){for(;e.length>0;){var t=e.shift();if("function"!=typeof t){var n=t.func;"number"==typeof n?void 0===t.arg?ke.get(n)():ke.get(n)(t.arg):n(void 0===t.arg?null:t.arg)}else t(Q)}}function M(e,t){var n=new Date(1e3*Ae[e>>2]);Ae[t>>2]=n.getUTCSeconds(),Ae[t+4>>2]=n.getUTCMinutes(),Ae[t+8>>2]=n.getUTCHours(),Ae[t+12>>2]=n.getUTCDate(),Ae[t+16>>2]=n.getUTCMonth(),Ae[t+20>>2]=n.getUTCFullYear()-1900,Ae[t+24>>2]=n.getUTCDay(),Ae[t+36>>2]=0,Ae[t+32>>2]=0;var i=Date.UTC(n.getUTCFullYear(),0,1,0,0,0,0),r=(n.getTime()-i)/864e5|0;return Ae[t+28>>2]=r,M.GMTString||(M.GMTString=p("GMT")),Ae[t+40>>2]=M.GMTString,t}function x(){function e(e){var t=e.toTimeString().match(/\(([A-Za-z ]+)\)$/);return t?t[1]:"GMT"}if(!x.called){x.called=!0;var t=(new Date).getFullYear(),n=new Date(t,0,1),i=new Date(t,6,1),r=n.getTimezoneOffset(),o=i.getTimezoneOffset(),a=Math.max(r,o);Ae[xt()>>2]=60*a,Ae[Mt()>>2]=Number(r!=o);var s=e(n),c=e(i),l=p(s),u=p(c);o<r?(Ae[Dt()>>2]=l,Ae[Dt()+4>>2]=u):(Ae[Dt()>>2]=u,Ae[Dt()+4>>2]=l)}}function R(e,t){x();var n=new Date(1e3*Ae[e>>2]);Ae[t>>2]=n.getSeconds(),Ae[t+4>>2]=n.getMinutes(),Ae[t+8>>2]=n.getHours(),Ae[t+12>>2]=n.getDate(),Ae[t+16>>2]=n.getMonth(),Ae[t+20>>2]=n.getFullYear()-1900,Ae[t+24>>2]=n.getDay();var i=new Date(n.getFullYear(),0,1),r=(n.getTime()-i.getTime())/864e5|0;Ae[t+28>>2]=r,Ae[t+36>>2]=-60*n.getTimezoneOffset();var o=new Date(n.getFullYear(),6,1).getTimezoneOffset(),a=i.getTimezoneOffset(),s=0|(o!=a&&n.getTimezoneOffset()==Math.min(a,o));Ae[t+32>>2]=s;var c=Ae[Dt()+(s?4:0)>>2];return Ae[t+40>>2]=c,t}function O(e){return Ae[Pt()>>2]=e,e}function F(){if("object"==typeof crypto&&"function"==typeof crypto.getRandomValues){var e=new Uint8Array(1);return function(){return crypto.getRandomValues(e),e[0]}}return function(){k("randomDevice")}}function L(e){for(var t=r(e,16384),n=mt(t);e<t;)me[n+e++]=0;return n}function U(e,n){if(Ke.mainLoop.timingMode=e,Ke.mainLoop.timingValue=n,!Ke.mainLoop.func)return 1;if(0==e)Ke.mainLoop.scheduler=function(){var e=0|Math.max(0,Ke.mainLoop.tickStartTime+n-je());setTimeout(Ke.mainLoop.runner,e)},Ke.mainLoop.method="timeout";else if(1==e)Ke.mainLoop.scheduler=function(){Ke.requestAnimationFrame(Ke.mainLoop.runner)},Ke.mainLoop.method="rAF";else if(2==e){if(void 0===t){var i=[];addEventListener("message",function(e){"setimmediate"!==e.data&&"setimmediate"!==e.data.target||(e.stopPropagation(),i.shift()())},!0),t=function(e){i.push(e),ae?(void 0===Q.setImmediates&&(Q.setImmediates=[]),Q.setImmediates.push(e),postMessage({target:"setimmediate"})):postMessage("setimmediate","*")}}Ke.mainLoop.scheduler=function(){t(Ke.mainLoop.runner)},Ke.mainLoop.method="immediate"}return 0}function B(e,t,n,i,r){he=!0,a(!Ke.mainLoop.func,"emscripten_set_main_loop: there can only be one main loop function at once: call emscripten_cancel_main_loop to cancel the previous one before setting a new one with different parameters."),Ke.mainLoop.func=e,Ke.mainLoop.arg=i;var o=Ke.mainLoop.currentlyRunningMainloop;if(Ke.mainLoop.runner=function(){if(!Te)if(Ke.mainLoop.queue.length>0){var t=Date.now(),n=Ke.mainLoop.queue.shift();if(n.func(n.arg),Ke.mainLoop.remainingBlockers){var i=Ke.mainLoop.remainingBlockers,r=i%1==0?i-1:Math.floor(i);n.counted?Ke.mainLoop.remainingBlockers=r:(r+=.5,Ke.mainLoop.remainingBlockers=(8*i+r)/9)}if(console.log('main loop blocker "'+n.name+'" took '+(Date.now()-t)+" ms"),Ke.mainLoop.updateStatus(),o<Ke.mainLoop.currentlyRunningMainloop)return;setTimeout(Ke.mainLoop.runner,0)}else o<Ke.mainLoop.currentlyRunningMainloop||(Ke.mainLoop.currentFrameNumber=Ke.mainLoop.currentFrameNumber+1|0,1==Ke.mainLoop.timingMode&&Ke.mainLoop.timingValue>1&&Ke.mainLoop.currentFrameNumber%Ke.mainLoop.timingValue!=0?Ke.mainLoop.scheduler():(0==Ke.mainLoop.timingMode&&(Ke.mainLoop.tickStartTime=je()),Ke.mainLoop.runIter(e),o<Ke.mainLoop.currentlyRunningMainloop||("object"==typeof SDL&&SDL.audio&&SDL.audio.queueNewAudioData&&SDL.audio.queueNewAudioData(),Ke.mainLoop.scheduler())))},r||(t&&t>0?U(0,1e3/t):U(1,1),Ke.mainLoop.scheduler()),n)throw"unwind"}function N(e){k("OOM")}function j(){return re||"./this.program"}function z(){if(!z.strings){var e={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:("object"==typeof navigator&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:j()};for(var t in Xe)e[t]=Xe[t];var n=[];for(var t in e)n.push(t+"="+e[t]);z.strings=n}return z.strings}function H(e,t){var n=window.g_objmap[e];n.buffers=[],n.context||(n.context=new AudioContext,n.volumeControl=n.context.createGain()),n.context.createMediaStreamDestination&&n.audioOutputId?(n.destination=n.context.createMediaStreamDestination(),n.audio=new Audio,n.audio.srcObject=n.destination.stream,n.audio.setSinkId(n.audioOutputId).then(function(){le(e+": Succesfully set output id to: "+n.audioOutputId)}).catch(function(n){ue(e+": Error in setting audio output: "+n.message),ot(t,2385510403)}),n.volumeControl.connect(n.destination)):n.volumeControl.connect(n.context.destination)}function W(e){return e%4==0&&(e%100!=0||e%400==0)}function q(e,t){for(var n=0,i=0;i<=t;n+=e[i++]);return n}function $(e,t){for(var n=new Date(e.getTime());t>0;){var i=W(n.getFullYear()),r=n.getMonth(),o=(i?Ye:Qe)[r];if(!(t>o-n.getDate()))return n.setDate(n.getDate()+t),n;t-=o-n.getDate()+1,n.setDate(1),r<11?n.setMonth(r+1):(n.setMonth(0),n.setFullYear(n.getFullYear()+1))}return n}function V(e,t,n){var i=n>0?n:d(e)+1,r=new Array(i),o=l(e,r,0,r.length);return t&&(r.length=o),r}function G(e){this.name="ExitStatus",this.message="Program terminated with exit("+e+")",this.status=e}function K(e){function t(){Rt||(Rt=!0,Q.calledRun=!0,Te||(m(),S(),X(Q),Q.onRuntimeInitialized&&Q.onRuntimeInitialized(),y()))}e=e||ie,Re>0||(v(),Re>0||(Q.setStatus?(Q.setStatus("Running..."),setTimeout(function(){setTimeout(function(){Q.setStatus("")},1),t()},1)):t()))}var X,Y,Q=void 0!==(n=n||{})?n:{};Q.ready=new Promise(function(e,t){X=e,Y=t});var J,Z={};for(J in Q)Q.hasOwnProperty(J)&&(Z[J]=Q[J]);var ee,te,ne,ie=[],re="./this.program",oe=!0,ae=!1,se=!1,ce="";(oe||ae)&&(ae?ce=self.location.href:"undefined"!=typeof document&&document.currentScript&&(ce=document.currentScript.src),e&&(ce=e),ce=0!==ce.indexOf("blob:")?ce.substr(0,ce.lastIndexOf("/")+1):"",ee=function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(null),t.responseText},ae&&(ne=function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)}),te=function(e,t,n){var i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.onload=function(){200==i.status||0==i.status&&i.response?t(i.response):n()},i.onerror=n,i.send(null)});var le=Q.print||console.log.bind(console),ue=Q.printErr||console.warn.bind(console);for(J in Z)Z.hasOwnProperty(J)&&(Q[J]=Z[J]);Z=null,Q.arguments&&(ie=Q.arguments),Q.thisProgram&&(re=Q.thisProgram),Q.quit&&Q.quit;var de,pe=16;Q.wasmBinary&&(de=Q.wasmBinary);var he;Q.noExitRuntime&&(he=Q.noExitRuntime),"object"!=typeof WebAssembly&&k("no native wasm support detected");var ge,fe,ve,me,Se,ye,Ce,Ae,we,_e,be,ke,Te=!1,Ee="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0,Ie=(Q.INITIAL_MEMORY,[]),Pe=[],De=[],Me=[],xe=!1;Pe.push({func:function(){et()}});var Re=0,Oe=null,Fe=null;Q.preloadedImages={},Q.preloadedAudios={};var Le="data:application/octet-stream;base64,",Ue="cortanabox.prod.wasm";E(Ue)||(Ue=i(Ue));var Be,Ne,je,ze={splitPath:function(e){return/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/.exec(e).slice(1)},normalizeArray:function(e,t){for(var n=0,i=e.length-1;i>=0;i--){var r=e[i];"."===r?e.splice(i,1):".."===r?(e.splice(i,1),n++):n&&(e.splice(i,1),n--)}if(t)for(;n;n--)e.unshift("..");return e},normalize:function(e){var t="/"===e.charAt(0),n="/"===e.substr(-1);return(e=ze.normalizeArray(e.split("/").filter(function(e){return!!e}),!t).join("/"))||t||(e="."),e&&n&&(e+="/"),(t?"/":"")+e},dirname:function(e){var t=ze.splitPath(e),n=t[0],i=t[1];return n||i?(i&&(i=i.substr(0,i.length-1)),n+i):"."},basename:function(e){if("/"===e)return"/";var t=(e=(e=ze.normalize(e)).replace(/\/$/,"")).lastIndexOf("/");return-1===t?e:e.substr(t+1)},extname:function(e){return ze.splitPath(e)[3]},join:function(){var e=Array.prototype.slice.call(arguments,0);return ze.normalize(e.join("/"))},join2:function(e,t){return ze.normalize(e+"/"+t)}},He={resolve:function(){for(var e="",t=!1,n=arguments.length-1;n>=-1&&!t;n--){var i=n>=0?arguments[n]:$e.cwd();if("string"!=typeof i)throw new TypeError("Arguments to path.resolve must be strings");if(!i)return"";e=i+"/"+e,t="/"===i.charAt(0)}return e=ze.normalizeArray(e.split("/").filter(function(e){return!!e}),!t).join("/"),(t?"/":"")+e||"."},relative:function(e,t){function n(e){for(var t=0;t<e.length&&""===e[t];t++);for(var n=e.length-1;n>=0&&""===e[n];n--);return t>n?[]:e.slice(t,n-t+1)}e=He.resolve(e).substr(1),t=He.resolve(t).substr(1);for(var i=n(e.split("/")),r=n(t.split("/")),o=Math.min(i.length,r.length),a=o,s=0;s<o;s++)if(i[s]!==r[s]){a=s;break}for(var c=[],s=a;s<i.length;s++)c.push("..");return(c=c.concat(r.slice(a))).join("/")}},We={ttys:[],init:function(){},shutdown:function(){},register:function(e,t){We.ttys[e]={input:[],output:[],ops:t},$e.registerDevice(e,We.stream_ops)},stream_ops:{open:function(e){var t=We.ttys[e.node.rdev];if(!t)throw new $e.ErrnoError(43);e.tty=t,e.seekable=!1},close:function(e){e.tty.ops.flush(e.tty)},flush:function(e){e.tty.ops.flush(e.tty)},read:function(e,t,n,i,r){if(!e.tty||!e.tty.ops.get_char)throw new $e.ErrnoError(60);for(var o=0,a=0;a<i;a++){var s;try{s=e.tty.ops.get_char(e.tty)}catch(e){throw new $e.ErrnoError(29)}if(void 0===s&&0===o)throw new $e.ErrnoError(6);if(null===s||void 0===s)break;o++,t[n+a]=s}return o&&(e.node.timestamp=Date.now()),o},write:function(e,t,n,i,r){if(!e.tty||!e.tty.ops.put_char)throw new $e.ErrnoError(60);try{for(var o=0;o<i;o++)e.tty.ops.put_char(e.tty,t[n+o])}catch(e){throw new $e.ErrnoError(29)}return i&&(e.node.timestamp=Date.now()),o}},default_tty_ops:{get_char:function(e){if(!e.input.length){var t=null;if("undefined"!=typeof window&&"function"==typeof window.prompt?null!==(t=window.prompt("Input: "))&&(t+="\n"):"function"==typeof readline&&null!==(t=readline())&&(t+="\n"),!t)return null;e.input=V(t,!0)}return e.input.shift()},put_char:function(e,t){null===t||10===t?(le(s(e.output,0)),e.output=[]):0!=t&&e.output.push(t)},flush:function(e){e.output&&e.output.length>0&&(le(s(e.output,0)),e.output=[])}},default_tty1_ops:{put_char:function(e,t){null===t||10===t?(ue(s(e.output,0)),e.output=[]):0!=t&&e.output.push(t)},flush:function(e){e.output&&e.output.length>0&&(ue(s(e.output,0)),e.output=[])}}},qe={ops_table:null,mount:function(e){return qe.createNode(null,"/",16895,0)},createNode:function(e,t,n,i){if($e.isBlkdev(n)||$e.isFIFO(n))throw new $e.ErrnoError(63);qe.ops_table||(qe.ops_table={dir:{node:{getattr:qe.node_ops.getattr,setattr:qe.node_ops.setattr,lookup:qe.node_ops.lookup,mknod:qe.node_ops.mknod,rename:qe.node_ops.rename,unlink:qe.node_ops.unlink,rmdir:qe.node_ops.rmdir,readdir:qe.node_ops.readdir,symlink:qe.node_ops.symlink},stream:{llseek:qe.stream_ops.llseek}},file:{node:{getattr:qe.node_ops.getattr,setattr:qe.node_ops.setattr},stream:{llseek:qe.stream_ops.llseek,read:qe.stream_ops.read,write:qe.stream_ops.write,allocate:qe.stream_ops.allocate,mmap:qe.stream_ops.mmap,msync:qe.stream_ops.msync}},link:{node:{getattr:qe.node_ops.getattr,setattr:qe.node_ops.setattr,readlink:qe.node_ops.readlink},stream:{}},chrdev:{node:{getattr:qe.node_ops.getattr,setattr:qe.node_ops.setattr},stream:$e.chrdev_stream_ops}});var r=$e.createNode(e,t,n,i);return $e.isDir(r.mode)?(r.node_ops=qe.ops_table.dir.node,r.stream_ops=qe.ops_table.dir.stream,r.contents={}):$e.isFile(r.mode)?(r.node_ops=qe.ops_table.file.node,r.stream_ops=qe.ops_table.file.stream,r.usedBytes=0,r.contents=null):$e.isLink(r.mode)?(r.node_ops=qe.ops_table.link.node,r.stream_ops=qe.ops_table.link.stream):$e.isChrdev(r.mode)&&(r.node_ops=qe.ops_table.chrdev.node,r.stream_ops=qe.ops_table.chrdev.stream),r.timestamp=Date.now(),e&&(e.contents[t]=r,e.timestamp=r.timestamp),r},getFileDataAsRegularArray:function(e){if(e.contents&&e.contents.subarray){for(var t=[],n=0;n<e.usedBytes;++n)t.push(e.contents[n]);return t}return e.contents},getFileDataAsTypedArray:function(e){return e.contents?e.contents.subarray?e.contents.subarray(0,e.usedBytes):new Uint8Array(e.contents):new Uint8Array(0)},expandFileStorage:function(e,t){var n=e.contents?e.contents.length:0;if(!(n>=t)){t=Math.max(t,n*(n<1048576?2:1.125)>>>0),0!=n&&(t=Math.max(t,256));var i=e.contents;e.contents=new Uint8Array(t),e.usedBytes>0&&e.contents.set(i.subarray(0,e.usedBytes),0)}},resizeFileStorage:function(e,t){if(e.usedBytes!=t){if(0==t)return e.contents=null,void(e.usedBytes=0);if(!e.contents||e.contents.subarray){var n=e.contents;return e.contents=new Uint8Array(t),n&&e.contents.set(n.subarray(0,Math.min(t,e.usedBytes))),void(e.usedBytes=t)}if(e.contents||(e.contents=[]),e.contents.length>t)e.contents.length=t;else for(;e.contents.length<t;)e.contents.push(0);e.usedBytes=t}},node_ops:{getattr:function(e){var t={};return t.dev=$e.isChrdev(e.mode)?e.id:1,t.ino=e.id,t.mode=e.mode,t.nlink=1,t.uid=0,t.gid=0,t.rdev=e.rdev,$e.isDir(e.mode)?t.size=4096:$e.isFile(e.mode)?t.size=e.usedBytes:$e.isLink(e.mode)?t.size=e.link.length:t.size=0,t.atime=new Date(e.timestamp),t.mtime=new Date(e.timestamp),t.ctime=new Date(e.timestamp),t.blksize=4096,t.blocks=Math.ceil(t.size/t.blksize),t},setattr:function(e,t){void 0!==t.mode&&(e.mode=t.mode),void 0!==t.timestamp&&(e.timestamp=t.timestamp),void 0!==t.size&&qe.resizeFileStorage(e,t.size)},lookup:function(e,t){throw $e.genericErrors[44]},mknod:function(e,t,n,i){return qe.createNode(e,t,n,i)},rename:function(e,t,n){if($e.isDir(e.mode)){var i;try{i=$e.lookupNode(t,n)}catch(e){}if(i)for(var r in i.contents)throw new $e.ErrnoError(55)}delete e.parent.contents[e.name],e.parent.timestamp=Date.now(),e.name=n,t.contents[n]=e,t.timestamp=e.parent.timestamp,e.parent=t},unlink:function(e,t){delete e.contents[t],e.timestamp=Date.now()},rmdir:function(e,t){var n=$e.lookupNode(e,t);for(var i in n.contents)throw new $e.ErrnoError(55);delete e.contents[t],e.timestamp=Date.now()},readdir:function(e){var t=[".",".."];for(var n in e.contents)e.contents.hasOwnProperty(n)&&t.push(n);return t},symlink:function(e,t,n){var i=qe.createNode(e,t,41471,0);return i.link=n,i},readlink:function(e){if(!$e.isLink(e.mode))throw new $e.ErrnoError(28);return e.link}},stream_ops:{read:function(e,t,n,i,r){var o=e.node.contents;if(r>=e.node.usedBytes)return 0;var a=Math.min(e.node.usedBytes-r,i);if(a>8&&o.subarray)t.set(o.subarray(r,r+a),n);else for(var s=0;s<a;s++)t[n+s]=o[r+s];return a},write:function(e,t,n,i,r,o){if(!i)return 0;var a=e.node;if(a.timestamp=Date.now(),t.subarray&&(!a.contents||a.contents.subarray)){if(o)return a.contents=t.subarray(n,n+i),a.usedBytes=i,i;if(0===a.usedBytes&&0===r)return a.contents=t.slice(n,n+i),a.usedBytes=i,i;if(r+i<=a.usedBytes)return a.contents.set(t.subarray(n,n+i),r),i}if(qe.expandFileStorage(a,r+i),a.contents.subarray&&t.subarray)a.contents.set(t.subarray(n,n+i),r);else for(var s=0;s<i;s++)a.contents[r+s]=t[n+s];return a.usedBytes=Math.max(a.usedBytes,r+i),i},llseek:function(e,t,n){var i=t;if(1===n?i+=e.position:2===n&&$e.isFile(e.node.mode)&&(i+=e.node.usedBytes),i<0)throw new $e.ErrnoError(28);return i},allocate:function(e,t,n){qe.expandFileStorage(e.node,t+n),e.node.usedBytes=Math.max(e.node.usedBytes,t+n)},mmap:function(e,t,n,i,r,o){if(0!==t)throw new $e.ErrnoError(28);if(!$e.isFile(e.node.mode))throw new $e.ErrnoError(43);var a,s,c=e.node.contents;if(2&o||c.buffer!==ve){if((i>0||i+n<c.length)&&(c=c.subarray?c.subarray(i,i+n):Array.prototype.slice.call(c,i,i+n)),s=!0,!(a=L(n)))throw new $e.ErrnoError(48);me.set(c,a)}else s=!1,a=c.byteOffset;return{ptr:a,allocated:s}},msync:function(e,t,n,i,r){if(!$e.isFile(e.node.mode))throw new $e.ErrnoError(43);if(2&r)return 0;qe.stream_ops.write(e,t,0,i,n,!1);return 0}}},$e={root:null,mounts:[],devices:{},streams:[],nextInode:1,nameTable:null,currentPath:"/",initialized:!1,ignorePermissions:!0,trackingDelegate:{},tracking:{openFlags:{READ:1,WRITE:2}},ErrnoError:null,genericErrors:{},filesystems:null,syncFSRequests:0,lookupPath:function(e,t){if(e=He.resolve($e.cwd(),e),t=t||{},!e)return{path:"",node:null};var n={follow_mount:!0,recurse_count:0};for(var i in n)void 0===t[i]&&(t[i]=n[i]);if(t.recurse_count>8)throw new $e.ErrnoError(32);for(var r=ze.normalizeArray(e.split("/").filter(function(e){return!!e}),!1),o=$e.root,a="/",s=0;s<r.length;s++){var c=s===r.length-1;if(c&&t.parent)break;if(o=$e.lookupNode(o,r[s]),a=ze.join2(a,r[s]),$e.isMountpoint(o)&&(!c||c&&t.follow_mount)&&(o=o.mounted.root),!c||t.follow)for(var l=0;$e.isLink(o.mode);){var u=$e.readlink(a);if(a=He.resolve(ze.dirname(a),u),o=$e.lookupPath(a,{recurse_count:t.recurse_count}).node,l++>40)throw new $e.ErrnoError(32)}}return{path:a,node:o}},getPath:function(e){for(var t;;){if($e.isRoot(e)){var n=e.mount.mountpoint;return t?"/"!==n[n.length-1]?n+"/"+t:n+t:n}t=t?e.name+"/"+t:e.name,e=e.parent}},hashName:function(e,t){for(var n=0,i=0;i<t.length;i++)n=(n<<5)-n+t.charCodeAt(i)|0;return(e+n>>>0)%$e.nameTable.length},hashAddNode:function(e){var t=$e.hashName(e.parent.id,e.name);e.name_next=$e.nameTable[t],$e.nameTable[t]=e},hashRemoveNode:function(e){var t=$e.hashName(e.parent.id,e.name);if($e.nameTable[t]===e)$e.nameTable[t]=e.name_next;else for(var n=$e.nameTable[t];n;){if(n.name_next===e){n.name_next=e.name_next;break}n=n.name_next}},lookupNode:function(e,t){var n=$e.mayLookup(e);if(n)throw new $e.ErrnoError(n,e);for(var i=$e.hashName(e.id,t),r=$e.nameTable[i];r;r=r.name_next){var o=r.name;if(r.parent.id===e.id&&o===t)return r}return $e.lookup(e,t)},createNode:function(e,t,n,i){var r=new $e.FSNode(e,t,n,i);return $e.hashAddNode(r),r},destroyNode:function(e){$e.hashRemoveNode(e)},isRoot:function(e){return e===e.parent},isMountpoint:function(e){return!!e.mounted},isFile:function(e){return 32768==(61440&e)},isDir:function(e){return 16384==(61440&e)},isLink:function(e){return 40960==(61440&e)},isChrdev:function(e){return 8192==(61440&e)},isBlkdev:function(e){return 24576==(61440&e)},isFIFO:function(e){return 4096==(61440&e)},isSocket:function(e){return 49152==(49152&e)},flagModes:{r:0,"r+":2,w:577,"w+":578,a:1089,"a+":1090},modeStringToFlags:function(e){var t=$e.flagModes[e];if(void 0===t)throw new Error("Unknown file open mode: "+e);return t},flagsToPermissionString:function(e){var t=["r","w","rw"][3&e];return 512&e&&(t+="w"),t},nodePermissions:function(e,t){return $e.ignorePermissions?0:(-1===t.indexOf("r")||292&e.mode)&&(-1===t.indexOf("w")||146&e.mode)&&(-1===t.indexOf("x")||73&e.mode)?0:2},mayLookup:function(e){var t=$e.nodePermissions(e,"x");return t||(e.node_ops.lookup?0:2)},mayCreate:function(e,t){try{$e.lookupNode(e,t);return 20}catch(e){}return $e.nodePermissions(e,"wx")},mayDelete:function(e,t,n){var i;try{i=$e.lookupNode(e,t)}catch(e){return e.errno}var r=$e.nodePermissions(e,"wx");if(r)return r;if(n){if(!$e.isDir(i.mode))return 54;if($e.isRoot(i)||$e.getPath(i)===$e.cwd())return 10}else if($e.isDir(i.mode))return 31;return 0},mayOpen:function(e,t){return e?$e.isLink(e.mode)?32:$e.isDir(e.mode)&&("r"!==$e.flagsToPermissionString(t)||512&t)?31:$e.nodePermissions(e,$e.flagsToPermissionString(t)):44},MAX_OPEN_FDS:4096,nextfd:function(e,t){e=e||0,t=t||$e.MAX_OPEN_FDS;for(var n=e;n<=t;n++)if(!$e.streams[n])return n;throw new $e.ErrnoError(33)},getStream:function(e){return $e.streams[e]},createStream:function(e,t,n){$e.FSStream||($e.FSStream=function(){},$e.FSStream.prototype={object:{get:function(){return this.node},set:function(e){this.node=e}},isRead:{get:function(){return 1!=(2097155&this.flags)}},isWrite:{get:function(){return 0!=(2097155&this.flags)}},isAppend:{get:function(){return 1024&this.flags}}});var i=new $e.FSStream;for(var r in e)i[r]=e[r];e=i;var o=$e.nextfd(t,n);return e.fd=o,$e.streams[o]=e,e},closeStream:function(e){$e.streams[e]=null},chrdev_stream_ops:{open:function(e){var t=$e.getDevice(e.node.rdev);e.stream_ops=t.stream_ops,e.stream_ops.open&&e.stream_ops.open(e)},llseek:function(){throw new $e.ErrnoError(70)}},major:function(e){return e>>8},minor:function(e){return 255&e},makedev:function(e,t){return e<<8|t},registerDevice:function(e,t){$e.devices[e]={stream_ops:t}},getDevice:function(e){return $e.devices[e]},getMounts:function(e){for(var t=[],n=[e];n.length;){var i=n.pop();t.push(i),n.push.apply(n,i.mounts)}return t},syncfs:function(e,t){function n(e){return $e.syncFSRequests--,t(e)}function i(e){if(e){if(!i.errored)return i.errored=!0,n(e)}else++o>=r.length&&n(null)}"function"==typeof e&&(t=e,e=!1),$e.syncFSRequests++,$e.syncFSRequests>1&&ue("warning: "+$e.syncFSRequests+" FS.syncfs operations in flight at once, probably just doing extra work");var r=$e.getMounts($e.root.mount),o=0;r.forEach(function(t){if(!t.type.syncfs)return i(null);t.type.syncfs(t,e,i)})},mount:function(e,t,n){var i,r="/"===n,o=!n;if(r&&$e.root)throw new $e.ErrnoError(10);if(!r&&!o){var a=$e.lookupPath(n,{follow_mount:!1});if(n=a.path,i=a.node,$e.isMountpoint(i))throw new $e.ErrnoError(10);if(!$e.isDir(i.mode))throw new $e.ErrnoError(54)}var s={type:e,opts:t,mountpoint:n,mounts:[]},c=e.mount(s);return c.mount=s,s.root=c,r?$e.root=c:i&&(i.mounted=s,i.mount&&i.mount.mounts.push(s)),c},unmount:function(e){var t=$e.lookupPath(e,{follow_mount:!1});if(!$e.isMountpoint(t.node))throw new $e.ErrnoError(28);var n=t.node,i=n.mounted,r=$e.getMounts(i);Object.keys($e.nameTable).forEach(function(e){for(var t=$e.nameTable[e];t;){var n=t.name_next;-1!==r.indexOf(t.mount)&&$e.destroyNode(t),t=n}}),n.mounted=null;var o=n.mount.mounts.indexOf(i);n.mount.mounts.splice(o,1)},lookup:function(e,t){return e.node_ops.lookup(e,t)},mknod:function(e,t,n){var i=$e.lookupPath(e,{parent:!0}).node,r=ze.basename(e);if(!r||"."===r||".."===r)throw new $e.ErrnoError(28);var o=$e.mayCreate(i,r);if(o)throw new $e.ErrnoError(o);if(!i.node_ops.mknod)throw new $e.ErrnoError(63);return i.node_ops.mknod(i,r,t,n)},create:function(e,t){return t=void 0!==t?t:438,t&=4095,t|=32768,$e.mknod(e,t,0)},mkdir:function(e,t){return t=void 0!==t?t:511,t&=1023,t|=16384,$e.mknod(e,t,0)},mkdirTree:function(e,t){for(var n=e.split("/"),i="",r=0;r<n.length;++r)if(n[r]){i+="/"+n[r];try{$e.mkdir(i,t)}catch(e){if(20!=e.errno)throw e}}},mkdev:function(e,t,n){return void 0===n&&(n=t,t=438),t|=8192,$e.mknod(e,t,n)},symlink:function(e,t){if(!He.resolve(e))throw new $e.ErrnoError(44);var n=$e.lookupPath(t,{parent:!0}).node;if(!n)throw new $e.ErrnoError(44);var i=ze.basename(t),r=$e.mayCreate(n,i);if(r)throw new $e.ErrnoError(r);if(!n.node_ops.symlink)throw new $e.ErrnoError(63);return n.node_ops.symlink(n,i,e)},rename:function(e,t){var n,i,r,o=ze.dirname(e),a=ze.dirname(t),s=ze.basename(e),c=ze.basename(t);if(n=$e.lookupPath(e,{parent:!0}),i=n.node,n=$e.lookupPath(t,{parent:!0}),r=n.node,!i||!r)throw new $e.ErrnoError(44);if(i.mount!==r.mount)throw new $e.ErrnoError(75);var l=$e.lookupNode(i,s),u=He.relative(e,a);if("."!==u.charAt(0))throw new $e.ErrnoError(28);if("."!==(u=He.relative(t,o)).charAt(0))throw new $e.ErrnoError(55);var d;try{d=$e.lookupNode(r,c)}catch(e){}if(l!==d){var p=$e.isDir(l.mode),h=$e.mayDelete(i,s,p);if(h)throw new $e.ErrnoError(h);if(h=d?$e.mayDelete(r,c,p):$e.mayCreate(r,c))throw new $e.ErrnoError(h);if(!i.node_ops.rename)throw new $e.ErrnoError(63);if($e.isMountpoint(l)||d&&$e.isMountpoint(d))throw new $e.ErrnoError(10);if(r!==i&&(h=$e.nodePermissions(i,"w")))throw new $e.ErrnoError(h);try{$e.trackingDelegate.willMovePath&&$e.trackingDelegate.willMovePath(e,t)}catch(n){ue("FS.trackingDelegate['willMovePath']('"+e+"', '"+t+"') threw an exception: "+n.message)}$e.hashRemoveNode(l);try{i.node_ops.rename(l,r,c)}catch(e){throw e}finally{$e.hashAddNode(l)}try{$e.trackingDelegate.onMovePath&&$e.trackingDelegate.onMovePath(e,t)}catch(n){ue("FS.trackingDelegate['onMovePath']('"+e+"', '"+t+"') threw an exception: "+n.message)}}},rmdir:function(e){var t=$e.lookupPath(e,{parent:!0}).node,n=ze.basename(e),i=$e.lookupNode(t,n),r=$e.mayDelete(t,n,!0);if(r)throw new $e.ErrnoError(r);if(!t.node_ops.rmdir)throw new $e.ErrnoError(63);if($e.isMountpoint(i))throw new $e.ErrnoError(10);try{$e.trackingDelegate.willDeletePath&&$e.trackingDelegate.willDeletePath(e)}catch(t){ue("FS.trackingDelegate['willDeletePath']('"+e+"') threw an exception: "+t.message)}t.node_ops.rmdir(t,n),$e.destroyNode(i);try{$e.trackingDelegate.onDeletePath&&$e.trackingDelegate.onDeletePath(e)}catch(t){ue("FS.trackingDelegate['onDeletePath']('"+e+"') threw an exception: "+t.message)}},readdir:function(e){var t=$e.lookupPath(e,{follow:!0}).node;if(!t.node_ops.readdir)throw new $e.ErrnoError(54);return t.node_ops.readdir(t)},unlink:function(e){var t=$e.lookupPath(e,{parent:!0}).node,n=ze.basename(e),i=$e.lookupNode(t,n),r=$e.mayDelete(t,n,!1);if(r)throw new $e.ErrnoError(r);if(!t.node_ops.unlink)throw new $e.ErrnoError(63);if($e.isMountpoint(i))throw new $e.ErrnoError(10);try{$e.trackingDelegate.willDeletePath&&$e.trackingDelegate.willDeletePath(e)}catch(t){ue("FS.trackingDelegate['willDeletePath']('"+e+"') threw an exception: "+t.message)}t.node_ops.unlink(t,n),$e.destroyNode(i);try{$e.trackingDelegate.onDeletePath&&$e.trackingDelegate.onDeletePath(e)}catch(t){ue("FS.trackingDelegate['onDeletePath']('"+e+"') threw an exception: "+t.message)}},readlink:function(e){var t=$e.lookupPath(e).node;if(!t)throw new $e.ErrnoError(44);if(!t.node_ops.readlink)throw new $e.ErrnoError(28);return He.resolve($e.getPath(t.parent),t.node_ops.readlink(t))},stat:function(e,t){var n=$e.lookupPath(e,{follow:!t}).node;if(!n)throw new $e.ErrnoError(44);if(!n.node_ops.getattr)throw new $e.ErrnoError(63);return n.node_ops.getattr(n)},lstat:function(e){return $e.stat(e,!0)},chmod:function(e,t,n){var i;if(!(i="string"==typeof e?$e.lookupPath(e,{follow:!n}).node:e).node_ops.setattr)throw new $e.ErrnoError(63);i.node_ops.setattr(i,{mode:4095&t|-4096&i.mode,timestamp:Date.now()})},lchmod:function(e,t){$e.chmod(e,t,!0)},fchmod:function(e,t){var n=$e.getStream(e);if(!n)throw new $e.ErrnoError(8);$e.chmod(n.node,t)},chown:function(e,t,n,i){var r;if(!(r="string"==typeof e?$e.lookupPath(e,{follow:!i}).node:e).node_ops.setattr)throw new $e.ErrnoError(63);r.node_ops.setattr(r,{timestamp:Date.now()})},lchown:function(e,t,n){$e.chown(e,t,n,!0)},fchown:function(e,t,n){var i=$e.getStream(e);if(!i)throw new $e.ErrnoError(8);$e.chown(i.node,t,n)},truncate:function(e,t){if(t<0)throw new $e.ErrnoError(28);var n;if(!(n="string"==typeof e?$e.lookupPath(e,{follow:!0}).node:e).node_ops.setattr)throw new $e.ErrnoError(63);if($e.isDir(n.mode))throw new $e.ErrnoError(31);if(!$e.isFile(n.mode))throw new $e.ErrnoError(28);var i=$e.nodePermissions(n,"w");if(i)throw new $e.ErrnoError(i);n.node_ops.setattr(n,{size:t,timestamp:Date.now()})},ftruncate:function(e,t){var n=$e.getStream(e);if(!n)throw new $e.ErrnoError(8);if(0==(2097155&n.flags))throw new $e.ErrnoError(28);$e.truncate(n.node,t)},utime:function(e,t,n){var i=$e.lookupPath(e,{follow:!0}).node;i.node_ops.setattr(i,{timestamp:Math.max(t,n)})},open:function(e,t,n,i,r){if(""===e)throw new $e.ErrnoError(44);t="string"==typeof t?$e.modeStringToFlags(t):t,n=void 0===n?438:n,n=64&t?4095&n|32768:0;var o;if("object"==typeof e)o=e;else{e=ze.normalize(e);try{o=$e.lookupPath(e,{follow:!(131072&t)}).node}catch(e){}}var a=!1;if(64&t)if(o){if(128&t)throw new $e.ErrnoError(20)}else o=$e.mknod(e,n,0),a=!0;if(!o)throw new $e.ErrnoError(44);if($e.isChrdev(o.mode)&&(t&=-513),65536&t&&!$e.isDir(o.mode))throw new $e.ErrnoError(54);if(!a){var s=$e.mayOpen(o,t);if(s)throw new $e.ErrnoError(s)}512&t&&$e.truncate(o,0),t&=-131713;var c=$e.createStream({node:o,path:$e.getPath(o),flags:t,seekable:!0,position:0,stream_ops:o.stream_ops,ungotten:[],error:!1},i,r);c.stream_ops.open&&c.stream_ops.open(c),!Q.logReadFiles||1&t||($e.readFiles||($e.readFiles={}),e in $e.readFiles||($e.readFiles[e]=1,ue("FS.trackingDelegate error on read file: "+e)));try{if($e.trackingDelegate.onOpenFile){var l=0;1!=(2097155&t)&&(l|=$e.tracking.openFlags.READ),0!=(2097155&t)&&(l|=$e.tracking.openFlags.WRITE),$e.trackingDelegate.onOpenFile(e,l)}}catch(t){ue("FS.trackingDelegate['onOpenFile']('"+e+"', flags) threw an exception: "+t.message)}return c},close:function(e){if($e.isClosed(e))throw new $e.ErrnoError(8);e.getdents&&(e.getdents=null);try{e.stream_ops.close&&e.stream_ops.close(e)}catch(e){throw e}finally{$e.closeStream(e.fd)}e.fd=null},isClosed:function(e){return null===e.fd},llseek:function(e,t,n){if($e.isClosed(e))throw new $e.ErrnoError(8);if(!e.seekable||!e.stream_ops.llseek)throw new $e.ErrnoError(70);if(0!=n&&1!=n&&2!=n)throw new $e.ErrnoError(28);return e.position=e.stream_ops.llseek(e,t,n),e.ungotten=[],e.position},read:function(e,t,n,i,r){if(i<0||r<0)throw new $e.ErrnoError(28);if($e.isClosed(e))throw new $e.ErrnoError(8);if(1==(2097155&e.flags))throw new $e.ErrnoError(8);if($e.isDir(e.node.mode))throw new $e.ErrnoError(31);if(!e.stream_ops.read)throw new $e.ErrnoError(28);var o=void 0!==r;if(o){if(!e.seekable)throw new $e.ErrnoError(70)}else r=e.position;var a=e.stream_ops.read(e,t,n,i,r);return o||(e.position+=a),a},write:function(e,t,n,i,r,o){if(i<0||r<0)throw new $e.ErrnoError(28);if($e.isClosed(e))throw new $e.ErrnoError(8);if(0==(2097155&e.flags))throw new $e.ErrnoError(8);if($e.isDir(e.node.mode))throw new $e.ErrnoError(31);if(!e.stream_ops.write)throw new $e.ErrnoError(28);e.seekable&&1024&e.flags&&$e.llseek(e,0,2);var a=void 0!==r;if(a){if(!e.seekable)throw new $e.ErrnoError(70)}else r=e.position;var s=e.stream_ops.write(e,t,n,i,r,o);a||(e.position+=s);try{e.path&&$e.trackingDelegate.onWriteToFile&&$e.trackingDelegate.onWriteToFile(e.path)}catch(t){ue("FS.trackingDelegate['onWriteToFile']('"+e.path+"') threw an exception: "+t.message)}return s},allocate:function(e,t,n){if($e.isClosed(e))throw new $e.ErrnoError(8);if(t<0||n<=0)throw new $e.ErrnoError(28);if(0==(2097155&e.flags))throw new $e.ErrnoError(8);if(!$e.isFile(e.node.mode)&&!$e.isDir(e.node.mode))throw new $e.ErrnoError(43);if(!e.stream_ops.allocate)throw new $e.ErrnoError(138);e.stream_ops.allocate(e,t,n)},mmap:function(e,t,n,i,r,o){if(0!=(2&r)&&0==(2&o)&&2!=(2097155&e.flags))throw new $e.ErrnoError(2);if(1==(2097155&e.flags))throw new $e.ErrnoError(2);if(!e.stream_ops.mmap)throw new $e.ErrnoError(43);return e.stream_ops.mmap(e,t,n,i,r,o)},msync:function(e,t,n,i,r){return e&&e.stream_ops.msync?e.stream_ops.msync(e,t,n,i,r):0},munmap:function(e){return 0},ioctl:function(e,t,n){if(!e.stream_ops.ioctl)throw new $e.ErrnoError(59);return e.stream_ops.ioctl(e,t,n)},readFile:function(e,t){if(t=t||{},t.flags=t.flags||0,t.encoding=t.encoding||"binary","utf8"!==t.encoding&&"binary"!==t.encoding)throw new Error('Invalid encoding type "'+t.encoding+'"');var n,i=$e.open(e,t.flags),r=$e.stat(e).size,o=new Uint8Array(r);return $e.read(i,o,0,r,0),"utf8"===t.encoding?n=s(o,0):"binary"===t.encoding&&(n=o),$e.close(i),n},writeFile:function(e,t,n){(n=n||{}).flags=n.flags||577;var i=$e.open(e,n.flags,n.mode);if("string"==typeof t){var r=new Uint8Array(d(t)+1),o=l(t,r,0,r.length);$e.write(i,r,0,o,void 0,n.canOwn)}else{if(!ArrayBuffer.isView(t))throw new Error("Unsupported data type");$e.write(i,t,0,t.byteLength,void 0,n.canOwn)}$e.close(i)},cwd:function(){return $e.currentPath},chdir:function(e){var t=$e.lookupPath(e,{follow:!0});if(null===t.node)throw new $e.ErrnoError(44);if(!$e.isDir(t.node.mode))throw new $e.ErrnoError(54);var n=$e.nodePermissions(t.node,"x");if(n)throw new $e.ErrnoError(n);$e.currentPath=t.path},createDefaultDirectories:function(){$e.mkdir("/tmp"),$e.mkdir("/home"),$e.mkdir("/home/web_user")},createDefaultDevices:function(){$e.mkdir("/dev"),$e.registerDevice($e.makedev(1,3),{read:function(){return 0},write:function(e,t,n,i,r){return i}}),$e.mkdev("/dev/null",$e.makedev(1,3)),We.register($e.makedev(5,0),We.default_tty_ops),We.register($e.makedev(6,0),We.default_tty1_ops),$e.mkdev("/dev/tty",$e.makedev(5,0)),$e.mkdev("/dev/tty1",$e.makedev(6,0));var e=F();$e.createDevice("/dev","random",e),$e.createDevice("/dev","urandom",e),$e.mkdir("/dev/shm"),$e.mkdir("/dev/shm/tmp")},createSpecialDirectories:function(){$e.mkdir("/proc");var e=$e.mkdir("/proc/self");$e.mkdir("/proc/self/fd"),$e.mount({mount:function(){var t=$e.createNode(e,"fd",16895,73);return t.node_ops={lookup:function(e,t){var n=+t,i=$e.getStream(n);if(!i)throw new $e.ErrnoError(8);var r={parent:null,mount:{mountpoint:"fake"},node_ops:{readlink:function(){return i.path}}};return r.parent=r,r}},t}},{},"/proc/self/fd")},createStandardStreams:function(){Q.stdin?$e.createDevice("/dev","stdin",Q.stdin):$e.symlink("/dev/tty","/dev/stdin"),Q.stdout?$e.createDevice("/dev","stdout",null,Q.stdout):$e.symlink("/dev/tty","/dev/stdout"),Q.stderr?$e.createDevice("/dev","stderr",null,Q.stderr):$e.symlink("/dev/tty1","/dev/stderr");$e.open("/dev/stdin",0),$e.open("/dev/stdout",1),$e.open("/dev/stderr",1)},ensureErrnoError:function(){$e.ErrnoError||($e.ErrnoError=function(e,t){this.node=t,this.setErrno=function(e){this.errno=e},this.setErrno(e),this.message="FS error"},$e.ErrnoError.prototype=new Error,$e.ErrnoError.prototype.constructor=$e.ErrnoError,[44].forEach(function(e){$e.genericErrors[e]=new $e.ErrnoError(e),$e.genericErrors[e].stack="<generic error, no stack>"}))},staticInit:function(){$e.ensureErrnoError(),$e.nameTable=new Array(4096),$e.mount(qe,{},"/"),$e.createDefaultDirectories(),$e.createDefaultDevices(),$e.createSpecialDirectories(),$e.filesystems={MEMFS:qe}},init:function(e,t,n){$e.init.initialized=!0,$e.ensureErrnoError(),Q.stdin=e||Q.stdin,Q.stdout=t||Q.stdout,Q.stderr=n||Q.stderr,$e.createStandardStreams()},quit:function(){$e.init.initialized=!1;var e=Q._fflush;e&&e(0);for(var t=0;t<$e.streams.length;t++){var n=$e.streams[t];n&&$e.close(n)}},getMode:function(e,t){var n=0;return e&&(n|=365),t&&(n|=146),n},findObject:function(e,t){var n=$e.analyzePath(e,t);return n.exists?n.object:null},analyzePath:function(e,t){try{e=(i=$e.lookupPath(e,{follow:!t})).path}catch(e){}var n={isRoot:!1,exists:!1,error:0,name:null,path:null,object:null,parentExists:!1,parentPath:null,parentObject:null};try{var i=$e.lookupPath(e,{parent:!0});n.parentExists=!0,n.parentPath=i.path,n.parentObject=i.node,n.name=ze.basename(e),i=$e.lookupPath(e,{follow:!t}),n.exists=!0,n.path=i.path,n.object=i.node,n.name=i.node.name,n.isRoot="/"===i.path}catch(e){n.error=e.errno}return n},createPath:function(e,t,n,i){e="string"==typeof e?e:$e.getPath(e);for(var r=t.split("/").reverse();r.length;){var o=r.pop();if(o){var a=ze.join2(e,o);try{$e.mkdir(a)}catch(e){}e=a}}return a},createFile:function(e,t,n,i,r){var o=ze.join2("string"==typeof e?e:$e.getPath(e),t),a=$e.getMode(i,r);return $e.create(o,a)},createDataFile:function(e,t,n,i,r,o){var a=t?ze.join2("string"==typeof e?e:$e.getPath(e),t):e,s=$e.getMode(i,r),c=$e.create(a,s);if(n){if("string"==typeof n){for(var l=new Array(n.length),u=0,d=n.length;u<d;++u)l[u]=n.charCodeAt(u);n=l}$e.chmod(c,146|s);var p=$e.open(c,577);$e.write(p,n,0,n.length,0,o),$e.close(p),$e.chmod(c,s)}return c},createDevice:function(e,t,n,i){var r=ze.join2("string"==typeof e?e:$e.getPath(e),t),o=$e.getMode(!!n,!!i);$e.createDevice.major||($e.createDevice.major=64);var a=$e.makedev($e.createDevice.major++,0);return $e.registerDevice(a,{open:function(e){e.seekable=!1},close:function(e){i&&i.buffer&&i.buffer.length&&i(10)},read:function(e,t,i,r,o){for(var a=0,s=0;s<r;s++){var c;try{c=n()}catch(e){throw new $e.ErrnoError(29)}if(void 0===c&&0===a)throw new $e.ErrnoError(6);if(null===c||void 0===c)break;a++,t[i+s]=c}return a&&(e.node.timestamp=Date.now()),a},write:function(e,t,n,r,o){for(var a=0;a<r;a++)try{i(t[n+a])}catch(e){throw new $e.ErrnoError(29)}return r&&(e.node.timestamp=Date.now()),a}}),$e.mkdev(r,o,a)},forceLoadFile:function(e){if(e.isDevice||e.isFolder||e.link||e.contents)return!0;if("undefined"!=typeof XMLHttpRequest)throw new Error("Lazy loading should have been performed (contents set) in createLazyFile, but it was not. Lazy loading only works in web workers. Use --embed-file or --preload-file in emcc on the main thread.");if(!ee)throw new Error("Cannot load without read() or XMLHttpRequest.");try{e.contents=V(ee(e.url),!0),e.usedBytes=e.contents.length}catch(e){throw new $e.ErrnoError(29)}},createLazyFile:function(e,t,n,i,r){function o(){this.lengthKnown=!1,this.chunks=[]}if(o.prototype.get=function(e){if(!(e>this.length-1||e<0)){var t=e%this.chunkSize,n=e/this.chunkSize|0;return this.getter(n)[t]}},o.prototype.setDataGetter=function(e){this.getter=e},o.prototype.cacheLength=function(){var e=new XMLHttpRequest;if(e.open("HEAD",n,!1),e.send(null),!(e.status>=200&&e.status<300||304===e.status))throw new Error("Couldn't load "+n+". Status: "+e.status);var t,i=Number(e.getResponseHeader("Content-length")),r=(t=e.getResponseHeader("Accept-Ranges"))&&"bytes"===t,o=(t=e.getResponseHeader("Content-Encoding"))&&"gzip"===t,a=1048576;r||(a=i);var s=function(e,t){if(e>t)throw new Error("invalid range ("+e+", "+t+") or no bytes requested!");if(t>i-1)throw new Error("only "+i+" bytes available! programmer error!");var r=new XMLHttpRequest;if(r.open("GET",n,!1),i!==a&&r.setRequestHeader("Range","bytes="+e+"-"+t),"undefined"!=typeof Uint8Array&&(r.responseType="arraybuffer"),r.overrideMimeType&&r.overrideMimeType("text/plain; charset=x-user-defined"),r.send(null),!(r.status>=200&&r.status<300||304===r.status))throw new Error("Couldn't load "+n+". Status: "+r.status);return void 0!==r.response?new Uint8Array(r.response||[]):V(r.responseText||"",!0)},c=this;c.setDataGetter(function(e){var t=e*a,n=(e+1)*a-1;if(n=Math.min(n,i-1),void 0===c.chunks[e]&&(c.chunks[e]=s(t,n)),void 0===c.chunks[e])throw new Error("doXHR failed!");return c.chunks[e]}),!o&&i||(a=i=1,i=this.getter(0).length,a=i,le("LazyFiles on gzip forces download of the whole file when length is accessed")),this._length=i,this._chunkSize=a,this.lengthKnown=!0},"undefined"!=typeof XMLHttpRequest){if(!ae)throw"Cannot do synchronous binary XHRs outside webworkers in modern browsers. Use --embed-file or --preload-file in emcc";var a=new o;Object.defineProperties(a,{length:{get:function(){return this.lengthKnown||this.cacheLength(),this._length}},chunkSize:{get:function(){return this.lengthKnown||this.cacheLength(),this._chunkSize}}});s={isDevice:!1,contents:a}}else var s={isDevice:!1,url:n};var c=$e.createFile(e,t,s,i,r);s.contents?c.contents=s.contents:s.url&&(c.contents=null,c.url=s.url),Object.defineProperties(c,{usedBytes:{get:function(){return this.contents.length}}});var l={};return Object.keys(c.stream_ops).forEach(function(e){var t=c.stream_ops[e];l[e]=function(){return $e.forceLoadFile(c),t.apply(null,arguments)}}),l.read=function(e,t,n,i,r){$e.forceLoadFile(c);var o=e.node.contents;if(r>=o.length)return 0;var a=Math.min(o.length-r,i);if(o.slice)for(s=0;s<a;s++)t[n+s]=o[r+s];else for(var s=0;s<a;s++)t[n+s]=o.get(r+s);return a},c.stream_ops=l,c},createPreloadedFile:function(e,t,n,i,r,o,a,s,c,l){function u(n){function u(n){l&&l(),s||$e.createDataFile(e,t,n,i,r,c),o&&o(),b(p)}var h=!1;Q.preloadPlugins.forEach(function(e){h||e.canHandle(d)&&(e.handle(n,d,u,function(){a&&a(),b(p)}),h=!0)}),h||u(n)}Ke.init();var d=t?He.resolve(ze.join2(e,t)):e,p=w("cp "+d);_(p),"string"==typeof n?Ke.asyncLoad(n,function(e){u(e)},a):u(n)},indexedDB:function(){return window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB},DB_NAME:function(){return"EM_FS_"+window.location.pathname},DB_VERSION:20,DB_STORE_NAME:"FILE_DATA",saveFilesToDB:function(e,t,n){t=t||function(){},n=n||function(){};var i=$e.indexedDB();try{var r=i.open($e.DB_NAME(),$e.DB_VERSION)}catch(e){return n(e)}r.onupgradeneeded=function(){le("creating db"),r.result.createObjectStore($e.DB_STORE_NAME)},r.onsuccess=function(){function i(){0==c?t():n()}var o=r.result.transaction([$e.DB_STORE_NAME],"readwrite"),a=o.objectStore($e.DB_STORE_NAME),s=0,c=0,l=e.length;e.forEach(function(e){var t=a.put($e.analyzePath(e).object.contents,e);t.onsuccess=function(){++s+c==l&&i()},t.onerror=function(){s+ ++c==l&&i()}}),o.onerror=n},r.onerror=n},loadFilesFromDB:function(e,t,n){t=t||function(){},n=n||function(){};var i=$e.indexedDB();try{var r=i.open($e.DB_NAME(),$e.DB_VERSION)}catch(e){return n(e)}r.onupgradeneeded=n,r.onsuccess=function(){function i(){0==l?t():n()}var o=r.result;try{var a=o.transaction([$e.DB_STORE_NAME],"readonly")}catch(e){return void n(e)}var s=a.objectStore($e.DB_STORE_NAME),c=0,l=0,u=e.length;e.forEach(function(e){var t=s.get(e);t.onsuccess=function(){$e.analyzePath(e).exists&&$e.unlink(e),$e.createDataFile(ze.dirname(e),ze.basename(e),t.result,!0,!0,!0),++c+l==u&&i()},t.onerror=function(){c+ ++l==u&&i()}}),a.onerror=n},r.onerror=n}},Ve={mappings:{},DEFAULT_POLLMASK:5,umask:511,calculateAt:function(e,t){if("/"!==t[0]){var n;if(-100===e)n=$e.cwd();else{var i=$e.getStream(e);if(!i)throw new $e.ErrnoError(8);n=i.path}t=ze.join2(n,t)}return t},doStat:function(e,t,n){try{var i=e(t)}catch(e){if(e&&e.node&&ze.normalize(t)!==ze.normalize($e.getPath(e.node)))return-54;throw e}return Ae[n>>2]=i.dev,Ae[n+4>>2]=0,Ae[n+8>>2]=i.ino,Ae[n+12>>2]=i.mode,Ae[n+16>>2]=i.nlink,Ae[n+20>>2]=i.uid,Ae[n+24>>2]=i.gid,Ae[n+28>>2]=i.rdev,Ae[n+32>>2]=0,Ne=[i.size>>>0,(Be=i.size,+Math.abs(Be)>=1?Be>0?(0|Math.min(+Math.floor(Be/4294967296),4294967295))>>>0:~~+Math.ceil((Be-+(~~Be>>>0))/4294967296)>>>0:0)],Ae[n+40>>2]=Ne[0],Ae[n+44>>2]=Ne[1],Ae[n+48>>2]=4096,Ae[n+52>>2]=i.blocks,Ae[n+56>>2]=i.atime.getTime()/1e3|0,Ae[n+60>>2]=0,Ae[n+64>>2]=i.mtime.getTime()/1e3|0,Ae[n+68>>2]=0,Ae[n+72>>2]=i.ctime.getTime()/1e3|0,Ae[n+76>>2]=0,Ne=[i.ino>>>0,(Be=i.ino,+Math.abs(Be)>=1?Be>0?(0|Math.min(+Math.floor(Be/4294967296),4294967295))>>>0:~~+Math.ceil((Be-+(~~Be>>>0))/4294967296)>>>0:0)],Ae[n+80>>2]=Ne[0],Ae[n+84>>2]=Ne[1],0},doMsync:function(e,t,n,i,r){var o=Se.slice(e,e+n);$e.msync(t,o,r,n,i)},doMkdir:function(e,t){return"/"===(e=ze.normalize(e))[e.length-1]&&(e=e.substr(0,e.length-1)),$e.mkdir(e,t,0),0},doMknod:function(e,t,n){switch(61440&t){case 32768:case 8192:case 24576:case 4096:case 49152:break;default:return-28}return $e.mknod(e,t,n),0},doReadlink:function(e,t,n){if(n<=0)return-28;var i=$e.readlink(e),r=Math.min(n,d(i)),o=me[t+r];return u(i,t,n+1),me[t+r]=o,r},doAccess:function(e,t){if(-8&t)return-28;var n;if(!(n=$e.lookupPath(e,{follow:!0}).node))return-44;var i="";return 4&t&&(i+="r"),2&t&&(i+="w"),1&t&&(i+="x"),i&&$e.nodePermissions(n,i)?-2:0},doDup:function(e,t,n){var i=$e.getStream(n);return i&&$e.close(i),$e.open(e,t,0,n,n).fd},doReadv:function(e,t,n,i){for(var r=0,o=0;o<n;o++){var a=Ae[t+8*o>>2],s=Ae[t+(8*o+4)>>2],c=$e.read(e,me,a,s,i);if(c<0)return-1;if(r+=c,c<s)break}return r},doWritev:function(e,t,n,i){for(var r=0,o=0;o<n;o++){var a=Ae[t+8*o>>2],s=Ae[t+(8*o+4)>>2],c=$e.write(e,me,a,s,i);if(c<0)return-1;r+=c}return r},varargs:void 0,get:function(){return Ve.varargs+=4,Ae[Ve.varargs-4>>2]},getStr:function(e){return c(e)},getStreamFromFD:function(e){var t=$e.getStream(e);if(!t)throw new $e.ErrnoError(8);return t},get64:function(e,t){return e}};je=function(){return performance.now()};var Ge=!0,Ke={mainLoop:{scheduler:null,method:"",currentlyRunningMainloop:0,func:null,arg:0,timingMode:0,timingValue:0,currentFrameNumber:0,queue:[],pause:function(){Ke.mainLoop.scheduler=null,Ke.mainLoop.currentlyRunningMainloop++},resume:function(){Ke.mainLoop.currentlyRunningMainloop++;var e=Ke.mainLoop.timingMode,t=Ke.mainLoop.timingValue,n=Ke.mainLoop.func;Ke.mainLoop.func=null,B(n,0,!1,Ke.mainLoop.arg,!0),U(e,t),Ke.mainLoop.scheduler()},updateStatus:function(){if(Q.setStatus){var e=Q.statusMessage||"Please wait...",t=Ke.mainLoop.remainingBlockers,n=Ke.mainLoop.expectedBlockers;t?t<n?Q.setStatus(e+" ("+(n-t)+"/"+n+")"):Q.setStatus(e):Q.setStatus("")}},runIter:function(e){if(!(Te||Q.preMainLoop&&!1===Q.preMainLoop())){try{e()}catch(e){if(e instanceof G)return;if("unwind"==e)return;throw e&&"object"==typeof e&&e.stack&&ue("exception thrown: "+[e,e.stack]),e}Q.postMainLoop&&Q.postMainLoop()}}},isFullscreen:!1,pointerLock:!1,moduleContextCreatedCallbacks:[],workers:[],init:function(){function e(){Ke.pointerLock=document.pointerLockElement===Q.canvas||document.mozPointerLockElement===Q.canvas||document.webkitPointerLockElement===Q.canvas||document.msPointerLockElement===Q.canvas}if(Q.preloadPlugins||(Q.preloadPlugins=[]),!Ke.initted){Ke.initted=!0;try{new Blob,Ke.hasBlobConstructor=!0}catch(e){Ke.hasBlobConstructor=!1,console.log("warning: no blob constructor, cannot create blobs with mimetypes")}Ke.BlobBuilder="undefined"!=typeof MozBlobBuilder?MozBlobBuilder:"undefined"!=typeof WebKitBlobBuilder?WebKitBlobBuilder:Ke.hasBlobConstructor?null:console.log("warning: no BlobBuilder"),Ke.URLObject="undefined"!=typeof window?window.URL?window.URL:window.webkitURL:void 0,Q.noImageDecoding||void 0!==Ke.URLObject||(console.log("warning: Browser does not support creating object URLs. Built-in browser image decoding will not be available."),Q.noImageDecoding=!0);var t={};t.canHandle=function(e){return!Q.noImageDecoding&&/\.(jpg|jpeg|png|bmp)$/i.test(e)},t.handle=function(e,t,n,i){var r=null;if(Ke.hasBlobConstructor)try{(r=new Blob([e],{type:Ke.getMimetype(t)})).size!==e.length&&(r=new Blob([new Uint8Array(e).buffer],{type:Ke.getMimetype(t)}))}catch(e){o("Blob constructor present but fails: "+e+"; falling back to blob builder")}if(!r){var s=new Ke.BlobBuilder;s.append(new Uint8Array(e).buffer),r=s.getBlob()}var c=Ke.URLObject.createObjectURL(r),l=new Image;l.onload=function(){a(l.complete,"Image "+t+" could not be decoded");var i=document.createElement("canvas");i.width=l.width,i.height=l.height,i.getContext("2d").drawImage(l,0,0),Q.preloadedImages[t]=i,Ke.URLObject.revokeObjectURL(c),n&&n(e)},l.onerror=function(e){console.log("Image "+c+" could not be decoded"),i&&i()},l.src=c},Q.preloadPlugins.push(t);var n={};n.canHandle=function(e){return!Q.noAudioDecoding&&e.substr(-4)in{".ogg":1,".wav":1,".mp3":1}},n.handle=function(e,t,n,i){function r(i){a||(a=!0,Q.preloadedAudios[t]=i,n&&n(e))}function o(){a||(a=!0,Q.preloadedAudios[t]=new Audio,i&&i())}var a=!1;if(!Ke.hasBlobConstructor)return o();try{var s=new Blob([e],{type:Ke.getMimetype(t)})}catch(e){return o()}var c=Ke.URLObject.createObjectURL(s),l=new Audio;l.addEventListener("canplaythrough",function(){r(l)},!1),l.onerror=function(n){a||(console.log("warning: browser could not fully decode audio "+t+", trying slower base64 approach"),l.src="data:audio/x-"+t.substr(-3)+";base64,"+function(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n="",i=0,r=0,o=0;o<e.length;o++)for(i=i<<8|e[o],r+=8;r>=6;){var a=i>>r-6&63;r-=6,n+=t[a]}return 2==r?(n+=t[(3&i)<<4],n+="=="):4==r&&(n+=t[(15&i)<<2],n+="="),n}(e),r(l))},l.src=c,Ke.safeSetTimeout(function(){r(l)},1e4)},Q.preloadPlugins.push(n);var i=Q.canvas;i&&(i.requestPointerLock=i.requestPointerLock||i.mozRequestPointerLock||i.webkitRequestPointerLock||i.msRequestPointerLock||function(){},i.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock||document.msExitPointerLock||function(){},i.exitPointerLock=i.exitPointerLock.bind(document),document.addEventListener("pointerlockchange",e,!1),document.addEventListener("mozpointerlockchange",e,!1),document.addEventListener("webkitpointerlockchange",e,!1),document.addEventListener("mspointerlockchange",e,!1),Q.elementPointerLock&&i.addEventListener("click",function(e){!Ke.pointerLock&&Q.canvas.requestPointerLock&&(Q.canvas.requestPointerLock(),e.preventDefault())},!1))}},createContext:function(e,t,n,i){if(t&&Q.ctx&&e==Q.canvas)return Q.ctx;var r,o;if(t){var s={antialias:!1,alpha:!1,majorVersion:1};if(i)for(var c in i)s[c]=i[c];"undefined"!=typeof GL&&(o=GL.createContext(e,s))&&(r=GL.getContext(o).GLctx)}else r=e.getContext("2d");return r?(n&&(t||a("undefined"==typeof GLctx,"cannot set in module if GLctx is used, but we are a non-GL context that would replace it"),Q.ctx=r,t&&GL.makeContextCurrent(o),Q.useWebGL=t,Ke.moduleContextCreatedCallbacks.forEach(function(e){e()}),Ke.init()),r):null},destroyContext:function(e,t,n){},fullscreenHandlersInstalled:!1,lockPointer:void 0,resizeCanvas:void 0,requestFullscreen:function(e,t){function n(){Ke.isFullscreen=!1;var e=i.parentNode;(document.fullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitFullscreenElement||document.webkitCurrentFullScreenElement)===e?(i.exitFullscreen=Ke.exitFullscreen,Ke.lockPointer&&i.requestPointerLock(),Ke.isFullscreen=!0,Ke.resizeCanvas?Ke.setFullscreenCanvasSize():Ke.updateCanvasDimensions(i)):(e.parentNode.insertBefore(i,e),e.parentNode.removeChild(e),Ke.resizeCanvas?Ke.setWindowedCanvasSize():Ke.updateCanvasDimensions(i)),Q.onFullScreen&&Q.onFullScreen(Ke.isFullscreen),Q.onFullscreen&&Q.onFullscreen(Ke.isFullscreen)}Ke.lockPointer=e,Ke.resizeCanvas=t,void 0===Ke.lockPointer&&(Ke.lockPointer=!0),void 0===Ke.resizeCanvas&&(Ke.resizeCanvas=!1);var i=Q.canvas;Ke.fullscreenHandlersInstalled||(Ke.fullscreenHandlersInstalled=!0,document.addEventListener("fullscreenchange",n,!1),document.addEventListener("mozfullscreenchange",n,!1),document.addEventListener("webkitfullscreenchange",n,!1),document.addEventListener("MSFullscreenChange",n,!1));var r=document.createElement("div");i.parentNode.insertBefore(r,i),r.appendChild(i),r.requestFullscreen=r.requestFullscreen||r.mozRequestFullScreen||r.msRequestFullscreen||(r.webkitRequestFullscreen?function(){r.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}:null)||(r.webkitRequestFullScreen?function(){r.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}:null),r.requestFullscreen()},exitFullscreen:function(){return!!Ke.isFullscreen&&((document.exitFullscreen||document.cancelFullScreen||document.mozCancelFullScreen||document.msExitFullscreen||document.webkitCancelFullScreen||function(){}).apply(document,[]),!0)},nextRAF:0,fakeRequestAnimationFrame:function(e){var t=Date.now();if(0===Ke.nextRAF)Ke.nextRAF=t+1e3/60;else for(;t+2>=Ke.nextRAF;)Ke.nextRAF+=1e3/60;var n=Math.max(Ke.nextRAF-t,0);setTimeout(e,n)},requestAnimationFrame:function(e){"function"!=typeof requestAnimationFrame?(0,Ke.fakeRequestAnimationFrame)(e):requestAnimationFrame(e)},safeCallback:function(e){return function(){if(!Te)return e.apply(null,arguments)}},allowAsyncCallbacks:!0,queuedAsyncCallbacks:[],pauseAsyncCallbacks:function(){Ke.allowAsyncCallbacks=!1},resumeAsyncCallbacks:function(){if(Ke.allowAsyncCallbacks=!0,Ke.queuedAsyncCallbacks.length>0){var e=Ke.queuedAsyncCallbacks;Ke.queuedAsyncCallbacks=[],e.forEach(function(e){e()})}},safeRequestAnimationFrame:function(e){return Ke.requestAnimationFrame(function(){Te||(Ke.allowAsyncCallbacks?e():Ke.queuedAsyncCallbacks.push(e))})},safeSetTimeout:function(e,t){return he=!0,setTimeout(function(){Te||(Ke.allowAsyncCallbacks?e():Ke.queuedAsyncCallbacks.push(e))},t)},safeSetInterval:function(e,t){return he=!0,setInterval(function(){Te||Ke.allowAsyncCallbacks&&e()},t)},getMimetype:function(e){return{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",bmp:"image/bmp",ogg:"audio/ogg",wav:"audio/wav",mp3:"audio/mpeg"}[e.substr(e.lastIndexOf(".")+1)]},getUserMedia:function(e){window.getUserMedia||(window.getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia),window.getUserMedia(e)},getMovementX:function(e){return e.movementX||e.mozMovementX||e.webkitMovementX||0},getMovementY:function(e){return e.movementY||e.mozMovementY||e.webkitMovementY||0},getMouseWheelDelta:function(e){var t=0;switch(e.type){case"DOMMouseScroll":t=e.detail/3;break;case"mousewheel":t=e.wheelDelta/120;break;case"wheel":switch(t=e.deltaY,e.deltaMode){case 0:t/=100;break;case 1:t/=3;break;case 2:t*=80;break;default:throw"unrecognized mouse wheel delta mode: "+e.deltaMode}break;default:throw"unrecognized mouse wheel event: "+e.type}return t},mouseX:0,mouseY:0,mouseMovementX:0,mouseMovementY:0,touches:{},lastTouches:{},calculateMouseEvent:function(e){if(Ke.pointerLock)"mousemove"!=e.type&&"mozMovementX"in e?Ke.mouseMovementX=Ke.mouseMovementY=0:(Ke.mouseMovementX=Ke.getMovementX(e),Ke.mouseMovementY=Ke.getMovementY(e)),"undefined"!=typeof SDL?(Ke.mouseX=SDL.mouseX+Ke.mouseMovementX,Ke.mouseY=SDL.mouseY+Ke.mouseMovementY):(Ke.mouseX+=Ke.mouseMovementX,Ke.mouseY+=Ke.mouseMovementY);else{var t=Q.canvas.getBoundingClientRect(),n=Q.canvas.width,i=Q.canvas.height,r=void 0!==window.scrollX?window.scrollX:window.pageXOffset,o=void 0!==window.scrollY?window.scrollY:window.pageYOffset;if("touchstart"===e.type||"touchend"===e.type||"touchmove"===e.type){var a=e.touch;if(void 0===a)return;var s=a.pageX-(r+t.left),c=a.pageY-(o+t.top),l={x:s*=n/t.width,y:c*=i/t.height};if("touchstart"===e.type)Ke.lastTouches[a.identifier]=l,Ke.touches[a.identifier]=l;else if("touchend"===e.type||"touchmove"===e.type){var u=Ke.touches[a.identifier];u||(u=l),Ke.lastTouches[a.identifier]=u,Ke.touches[a.identifier]=l}return}var d=e.pageX-(r+t.left),p=e.pageY-(o+t.top);d*=n/t.width,p*=i/t.height,Ke.mouseMovementX=d-Ke.mouseX,Ke.mouseMovementY=p-Ke.mouseY,Ke.mouseX=d,Ke.mouseY=p}},asyncLoad:function(e,t,n,i){var r=i?"":w("al "+e);te(e,function(n){a(n,'Loading data file "'+e+'" failed (no arrayBuffer).'),t(new Uint8Array(n)),r&&b(r)},function(t){if(!n)throw'Loading data file "'+e+'" failed.';n()}),r&&_(r)},resizeListeners:[],updateResizeListeners:function(){var e=Q.canvas;Ke.resizeListeners.forEach(function(t){t(e.width,e.height)})},setCanvasSize:function(e,t,n){var i=Q.canvas;Ke.updateCanvasDimensions(i,e,t),n||Ke.updateResizeListeners()},windowedWidth:0,windowedHeight:0,setFullscreenCanvasSize:function(){if("undefined"!=typeof SDL){var e=we[SDL.screen>>2];e|=8388608,Ae[SDL.screen>>2]=e}Ke.updateCanvasDimensions(Q.canvas),Ke.updateResizeListeners()},setWindowedCanvasSize:function(){if("undefined"!=typeof SDL){var e=we[SDL.screen>>2];e&=-8388609,Ae[SDL.screen>>2]=e}Ke.updateCanvasDimensions(Q.canvas),Ke.updateResizeListeners()},updateCanvasDimensions:function(e,t,n){t&&n?(e.widthNative=t,e.heightNative=n):(t=e.widthNative,n=e.heightNative);var i=t,r=n;if(Q.forcedAspectRatio&&Q.forcedAspectRatio>0&&(i/r<Q.forcedAspectRatio?i=Math.round(r*Q.forcedAspectRatio):r=Math.round(i/Q.forcedAspectRatio)),(document.fullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitFullscreenElement||document.webkitCurrentFullScreenElement)===e.parentNode&&"undefined"!=typeof screen){var o=Math.min(screen.width/i,screen.height/r);i=Math.round(i*o),r=Math.round(r*o)}Ke.resizeCanvas?(e.width!=i&&(e.width=i),e.height!=r&&(e.height=r),void 0!==e.style&&(e.style.removeProperty("width"),e.style.removeProperty("height"))):(e.width!=t&&(e.width=t),e.height!=n&&(e.height=n),void 0!==e.style&&(i!=t||r!=n?(e.style.setProperty("width",i+"px","important"),e.style.setProperty("height",r+"px","important")):(e.style.removeProperty("width"),e.style.removeProperty("height"))))},wgetRequests:{},nextWgetRequestHandle:0,getNextWgetRequestHandle:function(){var e=Ke.nextWgetRequestHandle;return Ke.nextWgetRequestHandle++,e}},Xe={},Ye=[31,29,31,30,31,30,31,31,30,31,30,31],Qe=[31,28,31,30,31,30,31,31,30,31,30,31],Je=function(e,t,n,i){e||(e=this),this.parent=e,this.mount=e.mount,this.mounted=null,this.id=$e.nextInode++,this.name=t,this.mode=n,this.node_ops={},this.stream_ops={},this.rdev=i};Object.defineProperties(Je.prototype,{read:{get:function(){return 365==(365&this.mode)},set:function(e){e?this.mode|=365:this.mode&=-366}},write:{get:function(){return 146==(146&this.mode)},set:function(e){e?this.mode|=146:this.mode&=-147}},isFolder:{get:function(){return $e.isDir(this.mode)}},isDevice:{get:function(){return $e.isChrdev(this.mode)}}}),$e.FSNode=Je,$e.staticInit(),Q.requestFullscreen=function(e,t){Ke.requestFullscreen(e,t)},Q.requestAnimationFrame=function(e){Ke.requestAnimationFrame(e)},Q.setCanvasSize=function(e,t,n){Ke.setCanvasSize(e,t,n)},Q.pauseMainLoop=function(){Ke.mainLoop.pause()},Q.resumeMainLoop=function(){Ke.mainLoop.resume()},Q.getUserMedia=function(){Ke.getUserMedia()},Q.createContext=function(e,t,n,i){return Ke.createContext(e,t,n,i)};var Ze={ga:function(e,t){return M(e,t)},fa:function(e,t){return R(e,t)},p:function(e,t,n){Ve.varargs=n;try{var i=Ve.getStreamFromFD(e);switch(t){case 0:return(r=Ve.get())<0?-28:$e.open(i.path,i.flags,0,r).fd;case 1:case 2:return 0;case 3:return i.flags;case 4:return r=Ve.get(),i.flags|=r,0;case 12:var r=Ve.get();return ye[r+0>>1]=2,0;case 13:case 14:return 0;case 16:case 8:return-28;case 9:return O(28),-1;default:return-28}}catch(e){return void 0!==$e&&e instanceof $e.ErrnoError||k(e),-e.errno}},da:function(e,t,n){Ve.varargs=n;try{var i=Ve.getStreamFromFD(e);switch(t){case 21509:case 21505:return i.tty?0:-59;case 21510:case 21511:case 21512:case 21506:case 21507:case 21508:return i.tty?0:-59;case 21519:return i.tty?(r=Ve.get(),Ae[r>>2]=0,0):-59;case 21520:return i.tty?-28:-59;case 21531:var r=Ve.get();return $e.ioctl(i,t,r);case 21523:case 21524:return i.tty?0:-59;default:k("bad ioctl syscall "+t)}}catch(e){return void 0!==$e&&e instanceof $e.ErrnoError||k(e),-e.errno}},ea:function(e,t,n){Ve.varargs=n;try{var i=Ve.getStr(e),r=n?Ve.get():0;return $e.open(i,t,r).fd}catch(e){return void 0!==$e&&e instanceof $e.ErrnoError||k(e),-e.errno}},a:function(){k()},$:function(e,t){window.AWT.setContext(c(e),t)},_:function(e,t){window.AWT.setContext(c(e),c(t))},e:function(e){window._ariamap.delete(e)},Z:function(e,t,n){window._ariamap.get(e).properties[c(t)]=n},Y:function(e,t,n){window._ariamap.get(e).properties[c(t)]=n},X:function(e,t,n){window._ariamap.get(e).properties[c(t)]=c(n)},W:function(e){window.AWT.initialize(window.webSDKAriaKey||c(e))},d:function(e){window.AWT.logEvent(window._ariamap.get(e))},V:function(e,t){window._ariamap||(window._ariamap=new Map),window._ariamap.set(e,{name:c(t),properties:{}})},U:function(e,t){var n;if(0===e)n=Date.now();else{if(1!==e&&4!==e||!Ge)return O(28),-1;n=je()}return Ae[t>>2]=n/1e3|0,Ae[t+4>>2]=n%1e3*1e3*1e3|0,0},m:function(){window.AudioContext=window.AudioContext||window.webkitAudioContext,window.g_objmap||(window.g_objmap=[],window.g_objmap_id=0);var e=++window.g_objmap_id,t={};return window.g_objmap[e]=t,e},T:function(e,t){return e-t},S:function(e,t,n){function i(){ke.get(e)(t)}he=!0,n>=0?Ke.safeSetTimeout(i,n):Ke.safeRequestAnimationFrame(i)},R:function(){Ke.mainLoop.pause(),Ke.mainLoop.func=null},l:je,Q:function(e,t,n){Se.copyWithin(e,t,t+n)},P:function(){Ke.mainLoop.pause()},O:function(e){N(e>>>=0)},k:function(){Ke.mainLoop.resume()},N:function(e,t,n,i){B(function(){ke.get(e)(t)},n,i,t)},M:U,L:function(e){for(var t=je();je()-t<e;);},ca:function(e,t){try{var n=0;return z().forEach(function(i,r){var o=t+n;Ae[e+4*r>>2]=o,g(i,o),n+=i.length+1}),0}catch(e){return void 0!==$e&&e instanceof $e.ErrnoError||k(e),e.errno}},ba:function(e,t){try{var n=z();Ae[e>>2]=n.length;var i=0;return n.forEach(function(e){i+=e.length+1}),Ae[t>>2]=i,0}catch(e){return void 0!==$e&&e instanceof $e.ErrnoError||k(e),e.errno}},o:function(e){try{var t=Ve.getStreamFromFD(e);return $e.close(t),0}catch(e){return void 0!==$e&&e instanceof $e.ErrnoError||k(e),e.errno}},aa:function(e,t,n,i){try{var r=Ve.getStreamFromFD(e),o=Ve.doReadv(r,t,n);return Ae[i>>2]=o,0}catch(e){return void 0!==$e&&e instanceof $e.ErrnoError||k(e),e.errno}},C:function(e,t,n,i,r){try{var o=Ve.getStreamFromFD(e),a=4294967296*n+(t>>>0);return a<=-9007199254740992||a>=9007199254740992?-61:($e.llseek(o,a,i),Ne=[o.position>>>0,(Be=o.position,+Math.abs(Be)>=1?Be>0?(0|Math.min(+Math.floor(Be/4294967296),4294967295))>>>0:~~+Math.ceil((Be-+(~~Be>>>0))/4294967296)>>>0:0)],Ae[r>>2]=Ne[0],Ae[r+4>>2]=Ne[1],o.getdents&&0===a&&0===i&&(o.getdents=null),0)}catch(e){return void 0!==$e&&e instanceof $e.ErrnoError||k(e),e.errno}},n:function(e,t,n,i){try{var r=Ve.getStreamFromFD(e),o=Ve.doWritev(r,t,n);return Ae[i>>2]=o,0}catch(e){return void 0!==$e&&e instanceof $e.ErrnoError||k(e),e.errno}},K:function(e,t){var n=c(t);$e.mkdir(n),$e.mount({mount:function(){var e=$e.createNode({},"fd",16895,73);return e.cache=[],e.node_ops={lookup:function(t,r){var o={parent:null,name:r,mount:{mountpoint:n},node_ops:{readlink:function(){return stream.path},getattr:function(t){var n={};n.dev=1,n.ino=n.uid=n.gid=n.rdev=0,n.mode=33152,n.nlink=1;var i=e.cache[t.name];return n.size=i?i.length:0,n.atime=n.mtime=n.ctime=new Date,n.blksize=4096,n.blocks=Math.ceil(n.size/n.blksize),n}},stream_ops:{open:function(t){if(e.cache[r])t.payload=e.cache[r];else{var n=new XMLHttpRequest;if(n.open("GET",i(r),!1),n.overrideMimeType("text/plain; charset=x-user-defined"),n.onload=function(i){4===n.readyState&&200===n.status&&("string"==typeof n.response?t.payload=Uint8Array.from(n.response,function(e){return 255&e.charCodeAt(0)}):t.payload=n.response,e.cache[r]=t.payload)},n.send(null),!t.payload)throw new $e.ErrnoError(44)}},close:function(e){},llseek:function(e,t,n){var i=t;if(1===n?i+=e.position:2===n&&(i+=e.payload.length),i<0)throw new $e.ErrnoError(28);return i},read:function(e,t,n,i,r){return r+i>e.payload.length&&(i=e.payload.length-r),t.set(e.payload.slice(r,r+i),n),i},write:function(e,t,n,i,r){throw new $e.ErrnoError(28)}},mode:292};return o.parent=o,o}},e}},{},n)},c:function(e){var t=Date.now();return Ae[e>>2]=t/1e3|0,Ae[e+4>>2]=t%1e3*1e3|0,0},J:M,I:function(){window.g_objmap=null},j:function(e,t,n){var i=localStorage.getItem(c(e)),r=i?p(i):0;ke.get(t)(e,r,n),r&&vt(r)},H:function(e){Q.onPostMessage&&Q.onPostMessage(c(e))},i:function(e,t){localStorage.setItem(c(e),c(t))},G:function(e,t,n,i,r){var o=c(t),a="GET"==o?null:o,s=JSON.parse(c(i));fetch(c(e),{method:o,body:a,mode:"cors",headers:s}).then(function(e){return dt(r,e.status),e.arrayBuffer()}).then(function(e){var t=mt(e.byteLength);h(new Uint8Array(e.data),t),pt(r,t),vt(t)}).catch(function(e){console.log("[http.js] Request failed: "+e)})},F:function(e){var t=window.g_objmap[e];t.dataPtr=0,t.mediaChange&&(navigator.mediaDevices.removeEventListener("devicechange",t.mediaChange),t.mediaChange=null),t.context&&(t.stream.getAudioTracks().forEach(function(e){e.stop()}),t.context.destination.disconnect(),t.micSource&&(t.micSource.disconnect(),t.micSource=null),t.destination&&(t.destination.onaudioprocess=null,t.destination.port&&(t.destination.port.onmessage=null),t.destination.disconnect(),t.destination=null),t.context.close(),t.context=null,t.q=[])},E:function(e,t){window.g_objmap[e].audioInputId=c(t)},D:function(e,t,n,i){var r=navigator.mediaDevices,o=window.g_objmap[e];if(o.bufferSize=t*Float32Array.BYTES_PER_ELEMENT,o.dataPtr=i,!r||!r.getUserMedia)return ue("Cannot access microphone on this browser."),void ot(n,2385510402);var a={audio:{}};o.audioInputId&&(a={audio:{deviceId:{exact:o.audioInputId}}});var s=function(e,t,n,i){return new Promise(function(r,o){if(0==/Electron\/([0-3.]+)./g.test(navigator.userAgent)&&e.audioWorklet&&"function"==typeof e.audioWorklet.addModule){le("using worklet processor");var a=new Blob(["class PCMProcessor extends AudioWorkletProcessor {                              constructor() {                                  super();                                  this._offset = 0;                                  this._buff = new Float32Array(512);                              }                              process(inputs, outputs) {                                  var f32 = inputs[0][0];                                  this._buff.set(f32, this._offset);                                  this._offset += f32.length;                                  if (this._offset == this._buff.length) {                                      this._offset = 0;                                      this.port.postMessage(this._buff);                                   }                                  return true;                              }                          }                          registerProcessor('pcmproc', PCMProcessor);"],{type:"application/javascript"});e.audioWorklet.addModule(URL.createObjectURL(a)).then(function(){var t=new AudioWorkletNode(e,"pcmproc");t.port.onmessage=function(e){i(e.data)},r(t)}).catch(o)}else{le("using script processor");var s=e.createScriptProcessor(n,1,1),c=0;s.onaudioprocess=function(e){if(s!==e.target)return Q._audio_raise_error(t,2386558977),void e.target.disconnect();e.playbackTime&&e.playbackTime==c?Q._audio_raise_error(t,2386558981):(c=e.playbackTime,i(e.inputBuffer.getChannelData(0)))},r(s)}})},c=function(){o.inGUM=!1,o.mediaChange||(o.mediaChange=function(){le("input device change"),Q._audio_device_change(),o.inGUM?ue("mediaChange already in gUM"):(Q._audio_input_stop(n),Q._audio_input_start(n))},r.addEventListener("devicechange",o.mediaChange)),o.needsGUM&&(o.needsGUM=!1,o.mediaChange())},l=function(e){Q._audio_raise_error(n,e),c()},u=function(e){ue(e.name+":"+e.message);var t=2385510401;switch(e.name){case"AbortError":t=2386558982;break;case"NotAllowedError":t=2386558993;break;case"NotFoundError":t=2386558984;break;case"NotReadableError":t=2386558985;break;case"SecurityError":t=2386558992;break;case"TypeError":t=2386558983;break;default:t=2385510401}ot(n,t),c()};!function(){if(o.inGUM)return ue("Already in gUM"),void(o.needsGUM=!0);o.context?Q._audio_raise_error(n,2386558980):(o.inGUM=!0,r.getUserMedia(a).then(function(e){if(o.dataPtr)if(o.context)l(2386558979);else{o.stream=e;var i=p(e.getAudioTracks()[0].label);st(n,i),vt(i),o.context=new AudioContext,c(),o.micSource=o.context.createMediaStreamSource(e);var r=[],a=function(){r.forEach(function(e){Q.HEAPU8.set(new Uint8Array(e.buffer),o.dataPtr),Q._audio_ondata(n,o.dataPtr,t,o.sampleRate),Q.onAudioData&&Q.onAudioData(e)}),r=[]};s(o.context,n,t,function(e){o.context?(o.sampleRate=o.context.sampleRate,r.push(e.map(function(e){return e})),a()):Q._audio_raise_error(n,2386558977)}).then(function(e){o.context?o.dataPtr?(o.destination=e,o.micSource.connect(o.destination),o.destination.connect(o.context.destination)):Q._audio_raise_error(n,2386558978):Q._audio_raise_error(n,2386558977)}).catch(u)}else l(2386558978)}).catch(u))}()},h:R,g:function(e){x();var t=new Date(Ae[e+20>>2]+1900,Ae[e+16>>2],Ae[e+12>>2],Ae[e+8>>2],Ae[e+4>>2],Ae[e>>2],0),n=Ae[e+32>>2],i=t.getTimezoneOffset(),r=new Date(t.getFullYear(),0,1),o=new Date(t.getFullYear(),6,1).getTimezoneOffset(),a=r.getTimezoneOffset(),s=Math.min(a,o);if(n<0)Ae[e+32>>2]=Number(o!=a&&s==i);else if(n>0!=(s==i)){var c=Math.max(a,o),l=n>0?s:c;t.setTime(t.getTime()+6e4*(l-i))}Ae[e+24>>2]=t.getDay();var u=(t.getTime()-r.getTime())/864e5|0;return Ae[e+28>>2]=u,Ae[e>>2]=t.getSeconds(),Ae[e+4>>2]=t.getMinutes(),Ae[e+8>>2]=t.getHours(),Ae[e+12>>2]=t.getDate(),Ae[e+16>>2]=t.getMonth(),t.getTime()/1e3|0},B:function(e){return window.g_objmap[e].buffers.length},A:function(e){var t=window.g_objmap[e];t.buffers.forEach(function(e){e.disconnect(),e.stop()}),t.buffers=[],t.audio&&t.audio.pause()},z:function(e,t){H(e,t)},y:function(e,t,n,i){var r=window.g_objmap[e],o=r.context.createBufferSource(),a=r.context.createBuffer(1,n,i);t>>=2,a.getChannelData(0).set(_e.slice(t,t+n)),o.buffer=a,o.onended=function(){r.buffers=r.buffers.slice(1),o.disconnect(),o.stop()},o.connect(r.volumeControl),r.buffers.push(o),o.start(r.startTime),r.startTime+=o.buffer.duration},x:function(e,t,n){var i=window.g_objmap[e];i.audioOutputId=c(t),i.context&&(i.volumeControl&&i.volumeControl.disconnect(),H(e,n))},w:function(e,t){var n=window.g_objmap[e],i=t/100;n.volumeControl&&(n.volumeControl.gain.value=i)},v:function(e){var t=window.g_objmap[e];t.startTime=t.context.currentTime+.05,t.audio&&t.audio.play()},f:function(e,t,n,i){function r(e,t,n){for(var i="number"==typeof e?e.toString():e||"";i.length<t;)i=n[0]+i;return i}function o(e,t){return r(e,t,"0")}function a(e,t){function n(e){return e<0?-1:e>0?1:0}var i;return 0===(i=n(e.getFullYear()-t.getFullYear()))&&0===(i=n(e.getMonth()-t.getMonth()))&&(i=n(e.getDate()-t.getDate())),i}function s(e){switch(e.getDay()){case 0:return new Date(e.getFullYear()-1,11,29);case 1:return e;case 2:return new Date(e.getFullYear(),0,3);case 3:return new Date(e.getFullYear(),0,2);case 4:return new Date(e.getFullYear(),0,1);case 5:return new Date(e.getFullYear()-1,11,31);case 6:return new Date(e.getFullYear()-1,11,30)}}function l(e){var t=$(new Date(e.tm_year+1900,0,1),e.tm_yday),n=new Date(t.getFullYear(),0,4),i=new Date(t.getFullYear()+1,0,4),r=s(n),o=s(i);return a(r,t)<=0?a(o,t)<=0?t.getFullYear()+1:t.getFullYear():t.getFullYear()-1}var u=Ae[i+40>>2],d={tm_sec:Ae[i>>2],tm_min:Ae[i+4>>2],tm_hour:Ae[i+8>>2],tm_mday:Ae[i+12>>2],tm_mon:Ae[i+16>>2],tm_year:Ae[i+20>>2],tm_wday:Ae[i+24>>2],tm_yday:Ae[i+28>>2],tm_isdst:Ae[i+32>>2],tm_gmtoff:Ae[i+36>>2],tm_zone:u?c(u):""},p=c(n),g={"%c":"%a %b %d %H:%M:%S %Y","%D":"%m/%d/%y","%F":"%Y-%m-%d","%h":"%b","%r":"%I:%M:%S %p","%R":"%H:%M","%T":"%H:%M:%S","%x":"%m/%d/%y","%X":"%H:%M:%S","%Ec":"%c","%EC":"%C","%Ex":"%m/%d/%y","%EX":"%H:%M:%S","%Ey":"%y","%EY":"%Y","%Od":"%d","%Oe":"%e","%OH":"%H","%OI":"%I","%Om":"%m","%OM":"%M","%OS":"%S","%Ou":"%u","%OU":"%U","%OV":"%V","%Ow":"%w","%OW":"%W","%Oy":"%y"};for(var f in g)p=p.replace(new RegExp(f,"g"),g[f]);var v=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],m=["January","February","March","April","May","June","July","August","September","October","November","December"],S={"%a":function(e){return v[e.tm_wday].substring(0,3)},"%A":function(e){return v[e.tm_wday]},"%b":function(e){return m[e.tm_mon].substring(0,3)},"%B":function(e){return m[e.tm_mon]},"%C":function(e){return o((e.tm_year+1900)/100|0,2)},"%d":function(e){return o(e.tm_mday,2)},"%e":function(e){return r(e.tm_mday,2," ")},"%g":function(e){return l(e).toString().substring(2)},"%G":function(e){return l(e)},"%H":function(e){return o(e.tm_hour,2)},"%I":function(e){var t=e.tm_hour;return 0==t?t=12:t>12&&(t-=12),o(t,2)},"%j":function(e){return o(e.tm_mday+q(W(e.tm_year+1900)?Ye:Qe,e.tm_mon-1),3)},"%m":function(e){return o(e.tm_mon+1,2)},"%M":function(e){return o(e.tm_min,2)},"%n":function(){return"\n"},"%p":function(e){return e.tm_hour>=0&&e.tm_hour<12?"AM":"PM"},"%S":function(e){return o(e.tm_sec,2)},"%t":function(){return"\t"},"%u":function(e){return e.tm_wday||7},"%U":function(e){var t=new Date(e.tm_year+1900,0,1),n=0===t.getDay()?t:$(t,7-t.getDay()),i=new Date(e.tm_year+1900,e.tm_mon,e.tm_mday);if(a(n,i)<0){var r=q(W(i.getFullYear())?Ye:Qe,i.getMonth()-1)-31,s=31-n.getDate()+r+i.getDate();return o(Math.ceil(s/7),2)}return 0===a(n,t)?"01":"00"},"%V":function(e){var t=new Date(e.tm_year+1900,0,4),n=new Date(e.tm_year+1901,0,4),i=s(t),r=s(n),c=$(new Date(e.tm_year+1900,0,1),e.tm_yday);if(a(c,i)<0)return"53";if(a(r,c)<=0)return"01";var l;return l=i.getFullYear()<e.tm_year+1900?e.tm_yday+32-i.getDate():e.tm_yday+1-i.getDate(),o(Math.ceil(l/7),2)},"%w":function(e){return e.tm_wday},"%W":function(e){var t=new Date(e.tm_year,0,1),n=1===t.getDay()?t:$(t,0===t.getDay()?1:7-t.getDay()+1),i=new Date(e.tm_year+1900,e.tm_mon,e.tm_mday);if(a(n,i)<0){var r=q(W(i.getFullYear())?Ye:Qe,i.getMonth()-1)-31,s=31-n.getDate()+r+i.getDate();return o(Math.ceil(s/7),2)}return 0===a(n,t)?"01":"00"},"%y":function(e){return(e.tm_year+1900).toString().substring(2)},"%Y":function(e){return e.tm_year+1900},"%z":function(e){var t=e.tm_gmtoff,n=t>=0;return t=Math.abs(t)/60,t=t/60*100+t%60,(n?"+":"-")+String("0000"+t).slice(-4)},"%Z":function(e){return e.tm_zone},"%%":function(){return"%"}};for(var f in S)p.indexOf(f)>=0&&(p=p.replace(new RegExp(f,"g"),S[f](d)));var y=V(p,!1);return y.length>t?0:(h(y,e),y.length-1)},b:function(e){var t=Date.now()/1e3|0;return e&&(Ae[e>>2]=t),t},u:function(e){var t=null;if(se||oe&&void 0!==window.crypto&&void 0!==window.crypto.getRandomValues&&(t=new Uint8Array(16),window.crypto.getRandomValues(t)),!t){t=new Array(16);for(var n=(new Date).getTime(),i=0;i<16;i++){var r=(n+256*Math.random())%256|0;n=n/256|0,t[i]=r}}t[6]=15&t[6]|64,t[8]=127&t[8]|128,h(t,e)},t:function(e,t,n){var i=0;u("xxxx-xx-xx-xx-xxxxxx".replace(/[x]/g,function(t){var r=n?Se[e+i>>0].toString(16).toUpperCase():Se[e+i>>0].toString(16);return r=1===r.length?"0"+r:r,i++,r}),t,37)},s:function(e,t,n){window.g_objmap||(window.g_objmap=[],window.g_objmap_id=0);var i,r=++window.g_objmap_id;n&&(i=c(n));var o=new WebSocket(c(e),i);return o.binaryType="arraybuffer",window.g_objmap[r]=o,o.onopen=function(e){ht(t)},o.onmessage=function(e){var n,i,r;if("string"==typeof e.data)i=0,r=d(e.data)+1,n=mt(r),l(e.data,me,n,r),r-=1;else{if(!(e.data instanceof ArrayBuffer))return void ue("unhandled WS type "+typeof e.data);i=1,r=e.data.byteLength,n=mt(r),h(new Uint8Array(e.data),n)}Q._wsio_onmsg(t,i,n,r),vt(n)},o.onclose=function(e){gt(t)},r},r:function(e,t,n){window.g_objmap[e].send(new Uint8Array(Se.buffer,t,n))},q:function(e,t,n){window.g_objmap[e].send(c(t,n))}},et=(function(){function e(e,t){var n=e.exports;Q.asm=n,f((ge=Q.asm.ha).buffer),ke=Q.asm.ia,b("wasm-instantiate")}function t(t){e(t.instance)}function n(e){return P().then(function(e){return WebAssembly.instantiate(e,i)}).then(e,function(e){ue("failed to asynchronously prepare wasm: "+e),k(e)})}var i={a:Ze};if(_("wasm-instantiate"),Q.instantiateWasm)try{return Q.instantiateWasm(i,e)}catch(e){return ue("Module.instantiateWasm callback failed with error: "+e),!1}(de||"function"!=typeof WebAssembly.instantiateStreaming||E(Ue)||"function"!=typeof fetch?n(t):fetch(Ue,{credentials:"same-origin"}).then(function(e){return WebAssembly.instantiateStreaming(e,i).then(t,function(e){return ue("wasm streaming compile failed: "+e),ue("falling back to ArrayBuffer instantiation"),n(t)})})).catch(Y)}(),Q.___wasm_call_ctors=function(){return(et=Q.___wasm_call_ctors=Q.asm.ja).apply(null,arguments)}),tt=Q._host_create=function(){return(tt=Q._host_create=Q.asm.ka).apply(null,arguments)},nt=Q._host_destroy=function(){return(nt=Q._host_destroy=Q.asm.la).apply(null,arguments)},it=Q._host_postmessage=function(){return(it=Q._host_postmessage=Q.asm.ma).apply(null,arguments)},rt=Q._skillctx=function(){return(rt=Q._skillctx=Q.asm.na).apply(null,arguments)},ot=Q._audio_raise_error=function(){return(ot=Q._audio_raise_error=Q.asm.oa).apply(null,arguments)},at=Q._audio_device_change=function(){return(at=Q._audio_device_change=Q.asm.pa).apply(null,arguments)},st=Q._audio_start=function(){return(st=Q._audio_start=Q.asm.qa).apply(null,arguments)},ct=Q._audio_ondata=function(){return(ct=Q._audio_ondata=Q.asm.ra).apply(null,arguments)},lt=Q._audio_input_stop=function(){return(lt=Q._audio_input_stop=Q.asm.sa).apply(null,arguments)},ut=Q._audio_input_start=function(){return(ut=Q._audio_input_start=Q.asm.ta).apply(null,arguments)},dt=Q._http_client_on_open=function(){return(dt=Q._http_client_on_open=Q.asm.ua).apply(null,arguments)},pt=Q._http_client_complete=function(){return(pt=Q._http_client_complete=Q.asm.va).apply(null,arguments)},ht=Q._ws_client_on_open=function(){return(ht=Q._ws_client_on_open=Q.asm.wa).apply(null,arguments)},gt=Q._ws_client_on_close=function(){return(gt=Q._ws_client_on_close=Q.asm.xa).apply(null,arguments)},ft=Q._wsio_onmsg=function(){return(ft=Q._wsio_onmsg=Q.asm.ya).apply(null,arguments)},vt=Q._free=function(){return(vt=Q._free=Q.asm.za).apply(null,arguments)},mt=Q._malloc=function(){return(mt=Q._malloc=Q.asm.Aa).apply(null,arguments)},St=Q._keyword_spotter_initialize=function(){return(St=Q._keyword_spotter_initialize=Q.asm.Ba).apply(null,arguments)},yt=Q._keyword_spotter_open=function(){return(yt=Q._keyword_spotter_open=Q.asm.Ca).apply(null,arguments)},Ct=Q._keyword_spotter_setcallbacks=function(){return(Ct=Q._keyword_spotter_setcallbacks=Q.asm.Da).apply(null,arguments)},At=Q._keyword_spotter_close=function(){return(At=Q._keyword_spotter_close=Q.asm.Ea).apply(null,arguments)},wt=Q._keyword_spotter_reset=function(){return(wt=Q._keyword_spotter_reset=Q.asm.Fa).apply(null,arguments)},_t=Q._keyword_spotter_write=function(){return(_t=Q._keyword_spotter_write=Q.asm.Ga).apply(null,arguments)},bt=Q.__Z25keyword_spotter_configureP10KWSCONTEXT=function(){return(bt=Q.__Z25keyword_spotter_configureP10KWSCONTEXT=Q.asm.Ha).apply(null,arguments)},kt=Q._keyword_spotter_setfirststagecallbacks=function(){return(kt=Q._keyword_spotter_setfirststagecallbacks=Q.asm.Ia).apply(null,arguments)},Tt=Q._keyword_spotter_get_locale_id=function(){return(Tt=Q._keyword_spotter_get_locale_id=Q.asm.Ja).apply(null,arguments)},Et=Q._keyword_spotter_load_keyword_model=function(){return(Et=Q._keyword_spotter_load_keyword_model=Q.asm.Ka).apply(null,arguments)},It=Q._keyword_spotter_get_string_parameter=function(){return(It=Q._keyword_spotter_get_string_parameter=Q.asm.La).apply(null,arguments)},Pt=Q.___errno_location=function(){return(Pt=Q.___errno_location=Q.asm.Ma).apply(null,arguments)},Dt=Q.__get_tzname=function(){return(Dt=Q.__get_tzname=Q.asm.Na).apply(null,arguments)},Mt=Q.__get_daylight=function(){return(Mt=Q.__get_daylight=Q.asm.Oa).apply(null,arguments)},xt=Q.__get_timezone=function(){return(xt=Q.__get_timezone=Q.asm.Pa).apply(null,arguments)};Q.UTF8ToString=c,Q.FS=$e,Q.allocateUTF8=p;var Rt;if(Fe=function e(){Rt||K(),Rt||(Fe=e)},Q.run=K,Q.preInit)for("function"==typeof Q.preInit&&(Q.preInit=[Q.preInit]);Q.preInit.length>0;)Q.preInit.pop()();return he=!0,K(),n.ready}}();e.exports=n}).call(t,n(2175).setImmediate)},2175:function(e,t,n){(function(e){function i(e,t){this._id=e,this._clearFn=t}var r=Function.prototype.apply;t.setTimeout=function(){return new i(r.call(setTimeout,window,arguments),clearTimeout)},t.setInterval=function(){return new i(r.call(setInterval,window,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},i.prototype.unref=i.prototype.ref=function(){},i.prototype.close=function(){this._clearFn.call(window,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout(function(){e._onTimeout&&e._onTimeout()},t))},n(2176),t.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==e&&e.setImmediate||this&&this.setImmediate,t.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==e&&e.clearImmediate||this&&this.clearImmediate}).call(t,n(54))},2176:function(e,t,n){(function(e,t){!function(e,n){"use strict";function i(e){delete c[e]}function r(e){var t=e.callback,i=e.args;switch(i.length){case 0:t();break;case 1:t(i[0]);break;case 2:t(i[0],i[1]);break;case 3:t(i[0],i[1],i[2]);break;default:t.apply(n,i)}}function o(e){if(l)setTimeout(o,0,e);else{var t=c[e];if(t){l=!0;try{r(t)}finally{i(e),l=!1}}}}if(!e.setImmediate){var a,s=1,c={},l=!1,u=e.document,d=Object.getPrototypeOf&&Object.getPrototypeOf(e);d=d&&d.setTimeout?d:e,"[object process]"==={}.toString.call(e.process)?a=function(e){t.nextTick(function(){o(e)})}:function(){if(e.postMessage&&!e.importScripts){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}}()?function(){var t="setImmediate$"+Math.random()+"$",n=function(n){n.source===e&&"string"==typeof n.data&&0===n.data.indexOf(t)&&o(+n.data.slice(t.length))};e.addEventListener?e.addEventListener("message",n,!1):e.attachEvent("onmessage",n),a=function(n){e.postMessage(t+n,"*")}}():e.MessageChannel?function(){var e=new MessageChannel;e.port1.onmessage=function(e){o(e.data)},a=function(t){e.port2.postMessage(t)}}():u&&"onreadystatechange"in u.createElement("script")?function(){var e=u.documentElement;a=function(t){var n=u.createElement("script");n.onreadystatechange=function(){o(t),n.onreadystatechange=null,e.removeChild(n),n=null},e.appendChild(n)}}():a=function(e){setTimeout(o,0,e)},d.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),n=0;n<t.length;n++)t[n]=arguments[n+1];var i={callback:e,args:t};return c[s]=i,a(s),s++},d.clearImmediate=i}}("undefined"==typeof self?void 0===e?this:e:self)}).call(t,n(54),n(305))},2177:function(e,t,n){e.exports=n.p+"cortanabox.prod-62ce3479c11d78081e01bb1cbecb8387.wasm"},2178:function(e,t,n){e.exports=n.p+"heycortana_en-US-2923a9ce157f72e9fcd1b840e6528ba0.table"},2179:function(e,t,n){e.exports=n.p+"done_listening-cc1408d044f1da7acb9b16c19c96f5ee.slk"},2180:function(e,t,n){e.exports=n.p+"processing-4ef6766c883e7c2e5fe5df7c04e31341.slk"},2181:function(e,t,n){e.exports=n.p+"S_305_d_volumeup-2f71464b815c5e935374b39cdbdaff1f.slk"},2182:function(e,t,n){e.exports=n.p+"S_306_d_volumedown-cd2dacdb874e066468233860a839407a.slk"},2183:function(e,t,n){e.exports=n.p+"timer-981eb74453cb19568cef403ba88f66bf.slk"},2184:function(e,t,n){e.exports=n.p+"alarm-981eb74453cb19568cef403ba88f66bf.slk"},2185:function(e,t,n){e.exports=n.p+"C_113_c_unabletoreachinternet-1900be2ebe407de6474af418522b6599.slk"},2186:function(e,t,n){e.exports=n.p+"C_117_c_serviceerror-c4418c23b76c6da4f17218daafdd33b8.slk"},2187:function(e,t,n){e.exports=n.p+"listening-82347cef293e9d0e9bfb72efbcf822bc.slk"},2188:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(11),o=function(e){function t(t,n,i,o,a,s,c,l,u,d,p,h,g,f,v,m){var S=e.call(this,t)||this;return S.orchestrationService=t,S.$rootScope=n,S.authenticationService=i,S.callForwardingSettingsService=o,S.callingService=a,S.callingSupportService=s,S.channelService=c,S.constants=l,S.contentSharingService=u,S.eventingService=d,S.geoRoutingService=p,S.routeUtilityService=g,S.settingsService=f,S.tabService=v,S.platformDetectService=m,S.teamsClientContextVersion=2,S.logger=h.newLogger("CortanaClientContextService"),S.teamsToSkillCallStateMap=new Map,S.teamsToSkillCallStateMap.set(0,r.ICommCallState.idle),S.teamsToSkillCallStateMap.set(1,r.ICommCallState.calling),S.teamsToSkillCallStateMap.set(2,r.ICommCallState.calling),S.teamsToSkillCallStateMap.set(3,r.ICommCallState.inCall),S.teamsToSkillCallStateMap.set(4,r.ICommCallState.onHold),S.teamsToSkillCallStateMap.set(5,r.ICommCallState.inCall),S.teamsToSkillCallStateMap.set(6,r.ICommCallState.inCall),S.teamsToSkillCallStateMap.set(7,r.ICommCallState.idle),S.teamsToSkillCallStateMap.set(8,r.ICommCallState.idle),S.teamsToSkillCallTypeMap=new Map,S.teamsToSkillCallTypeMap.set(-1,r.ICommCallType.Unknown),S.teamsToSkillCallTypeMap.set(1,r.ICommCallType.P2P),S.teamsToSkillCallTypeMap.set(2,r.ICommCallType.Conference),S.initializeOnAppLaunchAndReinit("Init"),S}return i(t,e),t.$inject=["orchestrationService","$rootScope","authenticationService","callForwardingSettingsService","callingService","callingSupportService","channelService","constants","contentSharingService","eventingService","geoRoutingService","loggingService","routeUtilityService","settingsService","tabService","platformDetectService"],t.prototype.initializeOnAppLaunchAndReinit=function(e){this.logger.info("initializeOnAppLaunchAndReinit: reason = {0}",e)},t.prototype.cleanupOnAppTeardown=function(e){this.logger.info("cleanupOnAppTeardown: reason = {0}",e),this.deinitialize(),this.mtEndpoint=null,this.mtImageEndpoint=null,this.profilePicUrlFormat=null,this.currentUser=null,this.isForwardingActive=!1,this.pptSharingSession=null,this.forwardingSettingsListener=null,this.frontOfRoomPptSlidesCountListener=null,this.sharingSessionCreatedSubscription=null,this.sharingSessionDisposedSubscription=null},t.prototype.mtmaTelemetryIdentifier=function(){return"CortanaClientContextService"},t.prototype.initialize=function(){var e=this;this.initializeCommunication(),this.subscribeContentSharingChanges();var t=this.settingsService.valueFor(this.constants.settings.names.middleTierConstants);return Promise.all([this.geoRoutingService.getServiceEndpoint(t.newEndpointAddress),this.geoRoutingService.getServiceEndpoint(t.newEndpointAddressImg),this.authenticationService.getUserInformation()]).then(function(t){return 3===t.length&&t[0]&&t[1]?t[2]&&t[2].profile?(e.mtEndpoint=t[0],e.mtImageEndpoint=t[1],e.profilePicUrlFormat=t[1]+e.constants.urls.cortana.profilePicPathFormat,e.currentUser={id:t[2].profile.upn,displayName:t[2].profile.name,firstName:t[2].profile.given_name,lastName:t[2].profile.family_name},!0):(e.logger.error("failed to get user information"),!1):(e.logger.error("failed to get service endpoint"),!1)}).catch(function(t){return e.logger.error("failed to get service endpoint"),!1})},t.prototype.deinitialize=function(){this.forwardingSettingsListener&&(this.forwardingSettingsListener(),this.forwardingSettingsListener=null),this.frontOfRoomPptSlidesCountListener&&(this.frontOfRoomPptSlidesCountListener(),this.frontOfRoomPptSlidesCountListener=null),this.sharingSessionCreatedSubscription&&(this.sharingSessionCreatedSubscription.dispose(),this.sharingSessionCreatedSubscription=null),this.sharingSessionDisposedSubscription&&(this.sharingSessionDisposedSubscription.dispose(),this.sharingSessionDisposedSubscription=null),this.mtEndpoint=null,this.mtImageEndpoint=null,this.profilePicUrlFormat=null,this.currentUser=null,this.isForwardingActive=!1,this.pptSharingSession=null},t.prototype.getClientContext=function(){var e=this.settingsService.getRing(),t={version:this.teamsClientContextVersion,mtEndpoint:this.mtEndpoint,mtImageEndpoint:this.mtImageEndpoint,profilePicUrlFormat:this.profilePicUrlFormat,teamsRing:e?e.id:"",user:this.currentUser},n={teamsContext:t,communicationContextState:this.getCommunicationState(),inMeetingPrivateContext:this.getPrivateInMeetingContext(),currentLocation:null},i=this.routeUtilityService.getRootRouteParams();this.setCurrentTeamAndChannel(t);var r=this.tabService.getCurrentTab();return t.teamsPlatform={personalAppId:i.appId,tabId:r&&r.id},i.objectUrl&&(t.file={objectId:i.fileId,objectUrl:i.objectUrl,type:i.fileType}),n.communicationContextState&&n.communicationContextState.calls&&n.communicationContextState.calls.length>0&&(t.meetings||(t.meetings=[]),n.communicationContextState.calls.forEach(function(e){t.meetings.push({iCalUid:e.iCalUid,eventId:e.eventId,state:e.state})})),i&&i.eventId&&i.panelInfo&&i.panelInfo[0]&&i.panelInfo[0].directiveName&&"calendarV2SchedulingForm"==i.panelInfo[0].directiveName&&(t.meetings||(t.meetings=[]),t.meetings.push({eventId:i&&i.eventId})),n},t.prototype.setCurrentTeamAndChannel=function(e){var t=this.channelService.getCurrentTeamAndChannel();t&&(t.team&&(e.team={objectId:t.team.objectId,displayName:t.team.displayName}),t.channel&&(e.channel={objectId:t.channel.objectId,displayName:t.channel.displayName}))},t.prototype.subscribeContentSharingChanges=function(){var e=this;this.sharingSessionCreatedSubscription=this.contentSharingService.onSharingSessionCreated(function(t){"ppt"===t.contentType&&(e.logger.info("New ppt Content sharing session created, updating VoiceSkills pptSession"),e.pptSharingSession=t)}),this.sharingSessionDisposedSubscription=this.contentSharingService.onSharingSessionDisposed(function(t){e.pptSharingSession&&e.pptSharingSession.id===t&&(e.logger.info("Existing pptSession ended updating VoiceSkills pptSession"),e.pptSharingSession=null)}),this.frontOfRoomPptSlidesCountListener=this.eventingService.$onWithTenantScope(this.$rootScope,this.constants.events.rigel.service.eventTypes.frontOfRoomPptSlidesCount,function(t,n){e.platformDetectService.isRigel()&&e.pptSharingSession&&(e.pptSharingSession.slidesCount=n)})},t.prototype.initializeCommunication=function(){var e=this;return this.callForwardingSettingsService.getSettings().then(function(t){return e.updateForwardingSettings(t),e.forwardingSettingsListener=e.eventingService.$onWithTenantScope(e.$rootScope,e.constants.events.calling.callForwardingSettingsChanged,function(t,n){n&&n.callForwardingSettings&&e.updateForwardingSettings(n.callForwardingSettings)}),!0}).catch(function(){return e.logger.error("failed to initialize communication data"),!1})},t.prototype.updateForwardingSettings=function(e){e&&(this.isForwardingActive=e.callForwardingSettings&&e.callForwardingSettings.isEnabled)},t.prototype.getCommunicationState=function(){var e=this,t={calls:[],forwardCallsActive:!!this.isForwardingActive},n=this.callingService.getAllCalls();return n&&(t.calls=n.map(function(t){var n=t.getCallingConversation();return{callId:t.callId,channel:"teams",state:e.teamsToSkillCallStateMap.get(t.state)||r.ICommCallState.idle,iCalUid:n&&n.meetingInfo?n.meetingInfo.iCalUid:t.meetingDetails?t.meetingDetails.iCalUid:"",eventId:n&&n.meetingInfo?n.meetingInfo.exchangeId:"",supportsAddContactToCall:e.settingsService.valueFor(e.constants.settings.names.rigel).enableCortanaFastFollow&&e.callingSupportService.isAddingParticipantAllowed(t),supportsAddNumberToCall:e.callingSupportService.isAddingParticipantAllowed(t)&&t.isPstnAvailable,supportsHold:e.callingSupportService.isHoldResumeAllowed(t),supportsResume:4===t.state,supportsTransferCall:e.callingSupportService.isTransferAllowed(t),teamsData:{conversationId:t.conversationId,callType:e.teamsToSkillCallTypeMap.get(t.teamsCallType)||r.ICommCallType.Unknown}}})),t},t.prototype.getPrivateInMeetingContext=function(){var e=this.settingsService.valueFor(this.constants.settings.names.rigel).enableCortanaPresentations,t={version:"1.0.0",presentations:[],settings:{channelsSettings:{teams:{supportsPresenting:e}}}},n=this.callingService.getActiveCalls();return e&&n&&n[0]&&this.pptSharingSession&&(t.presentations.push({isUserPresentor:this.pptSharingSession.mode===teamspace.services.ContentMode.Presenting,deckUrl:this.pptSharingSession.contentDto.url,numberOfSlides:this.pptSharingSession.slidesCount,currentSlideIndex:this.pptSharingSession.slide.slideIndex,callId:n[0].callId}),this.pptSharingSession.mode!==teamspace.services.ContentMode.Presenting&&(this.platformDetectService.isRigel()?t.settings.channelsSettings.teams={supportsPrivateNavigation:!1}:t.settings.channelsSettings.teams={supportsPrivateNavigation:!this.settingsService.valueAsBoolean(this.constants.settings.names.disablePrivateViewingOfPptConsuming)||this.pptSharingSession.privateViewingEnabled})),t},t}(teamspace.services.MTMABase);t.CortanaClientContextService=o,angular.module("teamspace.cortanaClientContextService",["teamspace.constants","teamspace.callForwardingSettingsService","teamspace.callingService","teamspace.callingSupportService","teamspace.channelService","teamspace.eventingService","teamspace.geoRoutingService","teamspace.loggingService","teamspace.routeUtilityService","teamspace.settingsService","teamspace.tabService","teamspace.contentSharingService"]).service("cortanaClientContextService",o)},2189:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(t,n,i,r){var o=e.call(this,t)||this;return o.orchestrationService=t,o.logger=i.newLogger("CortanaClientSkillsConfigService"),o.providers=[r,n],o.initializeOnAppLaunchAndReinit("launch"),o}return i(t,e),t.$inject=["orchestrationService","communicationSkillConfigProvider","loggingService","systemSkillConfigProvider"],t.prototype.initializeOnAppLaunchAndReinit=function(e){this.logger.info("initializeOnAppLaunchAndReinit: reason = {0}",e)},t.prototype.cleanupOnAppTeardown=function(e){this.logger.info("cleanupOnAppTeardown: reason = {0}",e),this.deinitialize()},t.prototype.mtmaTelemetryIdentifier=function(){return"CortanaClientSkillsConfigService"},t.prototype.initialize=function(){var e=this;return Promise.all(this.providers.map(function(e){return e.initialize()})).then(function(t){return t.every(function(e){return e})?(e.logger.info("{0} providers loaded and ready",e.providers.length),!0):(e.logger.error("failed to initialize config providers"),!1)})},t.prototype.deinitialize=function(){this.providers.forEach(function(e){e.clearCallback(),e.deinitialize()})},t.prototype.getConfigProviders=function(){return this.providers},t}(teamspace.services.MTMABase);t.CortanaClientSkillsConfigService=r,angular.module("teamspace.cortanaClientSkillsConfigService",["teamspace.loggingService","teamspace.communicationSkillConfigProvider","teamspace.systemSkillConfigProvider"]).service("cortanaClientSkillsConfigService",r)},2190:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var r=teamspace.services.CortanaConfigurationServiceEvents,o=teamspace.services.CortanaServiceEvents,a=teamspace.services.MTMASubscriptionUtility,s=SkypeX.Services.ObservableBase,c=teamspace.services.RigelServiceHandlerEvents,l=teamspace.services.SfBState,u=function(e){function t(t,n,i,r,o,a,s,c,l,u,d,p,h,g){var f=e.call(this)||this;return f.$q=t,f.$rootScope=n,f.analyticsService=i,f.constants=r,f.cortanaConfigurationService=o,f.cortanaEventingService=a,f.cortanaLoaderService=s,f.electronSafeIpcService=c,f.eventingService=l,f.loggingService=u,f.orchestrationService=d,f.platformDetectService=p,f.rigelServiceHandler=h,f.utilityService=g,d.registerForMtma(f),f.logger=u.newLogger("CortanaRigelService"),f.initializeOnAppLaunchAndReinit("launch"),f}return i(t,e),t.$inject=["$q","$rootScope","analyticsService","constants","cortanaConfigurationService","cortanaEventingService","cortanaLoaderService","electronSafeIpcService","eventingService","loggingService","orchestrationService","platformDetectService","rigelServiceHandler","utilityService"],t.prototype.whenInitialized=function(){return this.initializationDeferred.promise()},t.prototype.initializeOnAppLaunchAndReinit=function(e){var t=this;this.platformDetectService.isRigel()&&(this.initializationDeferred=this.utilityService.createDefer(),this.logger.info("initializeOnAppLaunchAndReinit: reason = "+e),this.initialize().catch(function(e){t.logger.warn("initializeOnAppLaunchAndReinit failed: "+e)}).finally(function(){return t.initializationDeferred.resolve()}))},t.prototype.initialize=function(){var e=this;return a.subscribe(this.rigelServiceHandler,function(t,n){return e.onCortanaToggled(n)},c.cortanaToggled),a.subscribe(this.rigelServiceHandler,function(){return e.onCortanaOpened()},c.cortanaOpened),a.subscribe(this.rigelServiceHandler,function(t,n){return e.onSfBStateUpdated(n)},c.sfbStateUpdated),a.subscribe(this.cortanaConfigurationService,function(){return e.onCortanaConfigurationUpdated()},r.configurationUpdated),a.subscribe(this.cortanaEventingService,function(){return e.onCortanaInitialize()},o.initialize),a.subscribe(this.cortanaEventingService,function(){return e.onCortanaDestroyed()},o.destroyed),this.eventingService.$onWithTenantScope(this.$rootScope,this.constants.events.cortana.activated,function(){return e.onCortanaActivated()}),this.eventingService.$onWithTenantScope(this.$rootScope,this.constants.events.rigel.call.eventTypes.callCreated,function(t,n){var i=n.teamsCallId,r=e.eventingService.$onWithTenantScope(e.$rootScope,e.constants.events.calling.callDisposed,function(t,n){e.onCallDisposed(n,i),r()})}),this.onCortanaConfigurationUpdated().then(function(){return e.onCortanaInitialize()}).catch(function(t){return e.logger.warn("initialize failed: "+t),e.sendCortanaToggleState(),e.$q.reject(t)})},t.prototype.mtmaTelemetryIdentifier=function(){return"CortanaRigelService"},t.prototype.cleanupOnAppTeardown=function(e){this.logger.info("cleanupOnAppTeardown: reason = {0}",e),this.initializationDeferred=null,this.cortanaService=null},t.prototype.onCortanaConfigurationUpdated=function(){var e=this,t=[this.cortanaConfigurationService.isCortanaEnabled(),this.cortanaConfigurationService.isWakeWordEnabled()];return this.$q.all(t).then(function(t){var n=t[0],i=t[1];e.logger.info("onCortanaConfigurationUpdated isCortanaEnabled: "+n+", isWakeWordEnabled: "+i),e.sendCortanaConfiguration({isCortanaEnabled:n,isWakeWordEnabled:i})}).catch(function(t){return e.logger.error("onCortanaConfigurationUpdated failed: Cortana is disabled, err: "+t),e.sendCortanaConfiguration({isCortanaEnabled:!1,isWakeWordEnabled:!1}),e.$q.reject(t)})},t.prototype.onCortanaInitialize=function(){var e=this;this.cortanaService?this.onCortanaInitializeHelper():(this.logger.info("onCortanaInitialize: no Cortana instance, getting it from the loader..."),this.cortanaLoaderService.getCortanaService().then(function(t){e.cortanaService=t,e.onCortanaInitializeHelper()}).catch(function(t){e.logger.error("onCortanaInitialize failed: "+t),e.sendCortanaToggleState()}))},t.prototype.onCortanaInitializeHelper=function(){this.cortanaConfigurationService.hasUserConsented()||(this.logger.info("onCortanaInitialize: reset consent"),this.cortanaConfigurationService.resetConsent(!0)),this.logger.info("onCortanaInitialize: reset wake word"),this.resetWakeWord(),this.logger.info("onCortanaInitialize: turn on Rigel's Cortana toggle"),this.sendCortanaToggleState()},t.prototype.onCortanaDestroyed=function(){this.logger.info("onCortanaDestroyed: turn off Rigel's Cortana toggle"),this.sendCortanaToggleState()},t.prototype.sendCortanaConfiguration=function(e){this.electronSafeIpcService.send(this.constants.events.rigel.service.callback,{type:this.constants.events.rigel.service.eventTypes.updateCortanaConfiguration,data:e})},t.prototype.sendCortanaToggleState=function(){var e=!!this.cortanaService&&this.cortanaService.isCortanaInitialized();this.logger.info("sendCortanaToggleState: toggle isOn: "+e),this.electronSafeIpcService.send(this.constants.events.rigel.service.callback,{type:this.constants.events.rigel.service.eventTypes.toggleCortana,data:e})},t.prototype.onCortanaActivated=function(){this.logger.info("onCortanaActivated: close the OEM plugin"),this.rigelServiceHandler.displayOemPlugin(!1)},t.prototype.onSfBStateUpdated=function(e){e!==l.Idle?(this.logger.info("onSfBStateUpdated: sfbState is "+e+", disable wakeword"),this.cortanaService&&this.cortanaService.toggleWakeWord(!1)):(this.logger.info("onSfBStateUpdated: sfbState is "+e+", reset wakeword"),this.resetWakeWord())},t.prototype.resetWakeWord=function(){var e=this;return this.cortanaService?this.cortanaConfigurationService.isWakeWordEnabled().then(function(t){e.logger.info("resetWakeWord: set wake word, isWakeWordEnabled: "+t),e.cortanaService.toggleWakeWord(t)}).catch(function(t){e.logger.error("resetWakeWord failed: disable wake word, err: "+t),e.cortanaService.toggleWakeWord(!1)}):this.$q.reject("resetWakeWord failed: no Cortana instance")},t.prototype.sendCortanaToggledUserBiTelemetry=function(e){var t=this,n={action:{gesture:teamspace.components.PanelActionGesture.toggle,outcome:teamspace.shared.AttributeHelper.tryGetEnum(e?teamspace.components.PanelActionOutcome.cortanaOn.toString():teamspace.components.PanelActionOutcome.cortanaOff.toString(),teamspace.components.PanelActionOutcome,this.loggingService),scenario:teamspace.shared.AttributeHelper.tryGetEnum(teamspace.components.PanelActionScenario.cortanaToggle.toString(),teamspace.components.PanelActionScenario,this.loggingService),scenarioType:teamspace.shared.AttributeHelper.tryGetEnum(teamspace.components.PanelActionScenarioType.cortana.toString(),teamspace.components.PanelActionScenarioType,this.loggingService)},module:{name:teamspace.shared.AttributeHelper.tryGetEnum(teamspace.components.PanelModuleName.cortanaToggle.toString(),teamspace.components.PanelModuleName,this.loggingService),type:teamspace.shared.AttributeHelper.tryGetEnum(teamspace.components.PanelModuleType.toggle.toString(),teamspace.components.PanelModuleType,this.loggingService),summary:"Toggle Cortana on/off"}};this.analyticsService.getAnalyticsPanelActionEventData(n).then(function(e){t.analyticsService.sendPanelAction(e)}).catch(function(){t.loggingService.error("Cortana toggle on/off userbi telemetry failed.")})},t.prototype.onCortanaToggled=function(e){var t=this;if(this.logger.info("onCortanaToggled: toggle "+e+" ..."),!this.cortanaService)return this.logger.error("onCortanaToggled: Cortana service unavailable, can't toggle: "+e),void this.onCortanaDestroyed();e?(this.cortanaService.initializeCortana().catch(function(e){t.logger.error("onCortanaToggled: turning off the toggle, intializeCortana failed: "+e),t.onCortanaDestroyed()}),this.sendCortanaToggledUserBiTelemetry(!0)):(this.cortanaService.destroyCortana(),this.sendCortanaToggledUserBiTelemetry(!1))},t.prototype.onCortanaOpened=function(){this.logger.info("onCortanaOpened: invoking Cortana ..."),this.rigelServiceHandler.sfbState===l.Idle?this.eventingService.$emit(this.constants.events.cortana.invoke,{isCancel:!0}):this.logger.info("onCortanaOpened: ignoring, sfbState: "+this.rigelServiceHandler.sfbState)},t.prototype.onCallDisposed=function(e,t){var n=this,i=e.teamsCallId;t===i&&this.cortanaService&&!this.cortanaService.isCortanaInitialized()&&(this.logger.info("onCallDisposed: intialize Cortana, teamsCallId: "+i),this.cortanaService.initializeCortana().catch(function(e){n.logger.error("onCallDisposed failed: intializeCortana failed, teamsCallId: "+i+", err: "+e),n.onCortanaDestroyed()}))},t}(s);t.CortanaRigelService=u,angular.module("teamspace.cortanaRigelService",["teamspace.constants","teamspace.cortanaConfigurationService","teamspace.cortanaLoaderService","teamspace.cortanaEventingService","teamspace.electronSafeIpcService","teamspace.eventingService","teamspace.loggingService","teamspace.orchestrationService","teamspace.platformDetectService","teamspace.rigelServiceHandler","teamspace.utilityService"]).service("cortanaRigelService",u)},2191:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),r=this&&this.__assign||function(){return(r=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++){t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e}).apply(this,arguments)},o=this&&this.__awaiter||function(e,t,n,i){function r(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,o){function a(e){try{c(i.next(e))}catch(e){o(e)}}function s(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){e.done?n(e.value):r(e.value).then(a,s)}c((i=i.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){function n(e){return function(t){return i([e,t])}}function i(n){if(r)throw new TypeError("Generator is already executing.");for(;c;)try{if(r=1,o&&(a=2&n[0]?o.return:n[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,n[1])).done)return a;switch(o=0,a&&(n=[2&n[0],a.value]),n[0]){case 0:case 1:a=n;break;case 4:return c.label++,{value:n[1],done:!1};case 5:c.label++,o=n[1],n=[0];continue;case 7:n=c.ops.pop(),c.trys.pop();continue;default:if(a=c.trys,!(a=a.length>0&&a[a.length-1])&&(6===n[0]||2===n[0])){c=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){c.label=n[1];break}if(6===n[0]&&c.label<a[1]){c.label=a[1],a=n;break}if(a&&c.label<a[2]){c.label=a[2],c.ops.push(n);break}a[2]&&c.ops.pop(),c.trys.pop();continue}n=t.call(e,c)}catch(e){n=[6,e],o=0}finally{r=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var r,o,a,s,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s};Object.defineProperty(t,"__esModule",{value:!0});var s,c=n(307),l=n(301),u=n(306),d=n(11),p=teamspace.services.CortanaDevToolsStorageKeys,h=teamspace.services.CortanaScenarioEventsType,g="CortanaService";!function(e){e.NotInitialized="notInitialized",e.GettingAuthToken="gettingAuthToken",e.GettingMediaDevices="gettingMediaDevices",e.PreStarted="preStarted",e.Started="started",e.Errored="errored"}(s=t.CortanaInitState||(t.CortanaInitState={}));var f=function(e){function t(t,n,i,r,o,a,c,l,u,d,p,h,f,v,m,S,y,C,A,w){var _=e.call(this,a)||this;return _.$rootScope=t,_.callingAgentsService=n,_.constants=i,_.cortanaConfigurationService=r,_.loggingService=o,_.orchestrationService=a,_.settingsService=c,_.platformDetectService=l,_.storageService=u,_.cortanaAuthService=d,_.cortanaDeviceService=p,_.cortanaSkillManager=h,_.cortanaEventingService=f,_.eventingService=v,_.resources=m,_.$translate=S,_.localizationService=y,_.tokenWarmingUtility=C,_.filesUtilityService=A,_.$interval=w,_.cortanaInstance=null,_.initState=s.NotInitialized,_.cortanaState=null,_.correlationId=null,_.serviceTag=null,_.isDevicesChangedPendingStart=!1,_.audioFragments={},_.audioFragmentCount=0,_.queryCortana=function(e){if(_.cortanaInstance){var t={actionType:teamspace.services.CortanaScenarioEventsActionType.TextQuery};_.updateTelemetry(teamspace.services.CortanaScenarioLogType.Mark,teamspace.services.CortanaScenarioEventsType.Action,t),e&&_.cortanaInstance.textQuery(e)}},_.sendCustomEvent=function(e,t,n){if(_.cortanaInstance){_.logger.info("Custom event called id = {0} eventName = {1} serviceTag = {2} context = {3}",e,t,_.cortanaInstance.serviceTag,n);var i={actionType:teamspace.services.CortanaScenarioEventsActionType.SendCustomEvent,eventType:e,eventName:t};_.updateTelemetry(teamspace.services.CortanaScenarioLogType.Mark,teamspace.services.CortanaScenarioEventsType.Action,i),_.cortanaInstance.sendCustomEvent(e,t,n)}},_.logger=o.newLogger(g),_.initializeOnAppLaunchAndReinit("launch"),_}return i(t,e),t.$inject=["$rootScope","callingAgentsService","constants","cortanaConfigurationService","loggingService","orchestrationService","settingsService","platformDetectService","storageService","cortanaAuthService","cortanaDeviceService","cortanaSkillManager","cortanaEventingService","eventingService","resources","$translate","localizationService","tokenWarmingUtility","filesUtilityService","$interval"],t.prototype.initializeOnAppLaunchAndReinit=function(e){var t=this;this.logger.info("initializeOnAppLaunchAndReinit cortanaService: reason = {0}",e),this.initState=s.NotInitialized,this.settingsService.valueAsBoolean(this.constants.settings.names.enableRefreshingCortanaAuthToken)&&this.registerResourceForWarmup(),this.cortanaSkillManager.setTelemetryCallback(this.updateTelemetry.bind(this)),this.eventingService.$onWithTenantScope(this.$rootScope,this.constants.events.cortana.cortanaVoiceUpdated,function(){t.cortanaInstance&&t.cortanaInstance.voiceFont&&(t.cortanaInstance.voiceFont=t.storageService.get(t.constants.storageServiceKeys.cortanaVoice),t.logger.info("CortanaInstance voiceFont: "+t.cortanaInstance.voiceFont))}),teamspace.services.MTMASubscriptionUtility.subscribe(this.cortanaConfigurationService,function(e,n){t.onConfigurationUpdated(n)},teamspace.services.CortanaConfigurationServiceEvents.configurationUpdated),teamspace.services.MTMASubscriptionUtility.subscribe(this.cortanaDeviceService,function(){t.onDevicesChanged()},c.CortanaDeviceServiceEvents.devicesChanged)},t.prototype.registerResourceForWarmup=function(){var e=this.settingsService.valueFor(this.constants.settings.names.cortanaConstants);this.tokenWarmingUtility.addCustomTokenRuleForKey("{cortana}",e.serviceResource)},t.prototype.cleanupOnAppTeardown=function(e){this.logger.info("cleanupOnAppTeardown: reason = {0}",e),this.scenarioInstance=null,this.correlationId=null,this.serviceTag=null,this.destroyCortana(),this.initState=s.NotInitialized,this.cortanaInstance=null,this.cortanaState=null,this.registeredSkills=null,this.cortanaInvocationLatencyScenario=null,this.cortanaInvoked=!1,this.firstTextTranscribing=!1,this.isDevicesChangedPendingStart=!1,this.audioFragmentCount=0,this.audioFragments={}},t.prototype.mtmaTelemetryIdentifier=function(){return g},t.prototype.getTelemetryObjWithDataBag=function(e){return r(r({},e),{cortanaDatabag:JSON.stringify(e)})},t.prototype.initializeCortana=function(e,t){return o(this,void 0,void 0,function(){var n,i,r,o,c,l,d,p;return a(this,function(a){switch(a.label){case 0:if(this.logger.info("initializeCortana: begin intialization, forceReinitialize: "+e+", initState: "+this.initState),n=!!t,t||(t=this.loggingService.newScenario(this.constants.scenarios.cortana.init)),i={},e&&(i.forceDestroy=!0,this.destroyCortana("forceReinitialize")),this.initState!==s.Started)return[3,5];this.logger.info("initializeCortana: already started, aborting"),this.cortanaEventingService.triggerEvent(teamspace.services.CortanaServiceEvents.initialize,!0,null),i.success=!0,i.newInit=!1,t.mark(h.InitSDK,i),r=!1,a.label=1;case 1:return a.trys.push([1,3,,4]),[4,this.cortanaConfigurationService.isWakeWordEnabled()];case 2:return r=a.sent(),this.toggleWakeWord(r),i.kwsMode=r?"true":"false",[3,4];case 3:return o=a.sent(),this.logger.error("initializeCortana: couldn't get wake word config, err: "+o),i.getKwsModeError=o,[3,4];case 4:return[2];case 5:if(this.initState!==s.NotInitialized&&this.initState!==s.Errored)return this.logger.info("initializeCortana: already in progress, aborting, initState: "+this.initState),[2];c=!1,a.label=6;case 6:return a.trys.push([6,8,,9]),[4,this.cortanaConfigurationService.isCortanaEnabled()];case 7:return c=a.sent(),[3,9];case 8:throw l=a.sent(),this.logger.error("initializeCortana failed: aborting, err: "+l),this.initState=s.Errored,i.errorMessage=l,t.fail(this.getTelemetryObjWithDataBag(i)),l;case 9:if(!c)throw this.logger.info("initializeCortana: Cortana is disabled, aborting"),this.initState=s.NotInitialized,i.isCortanaEnabled=!1,new Error("Cortana is disabled");this.initState=s.GettingAuthToken,a.label=10;case 10:return a.trys.push([10,12,,13]),this.logger.info("initializeCortana: fetching auth token..."),[4,this.cortanaAuthService.getToken(u.TokenFetchState.BeforeSdkInit)];case 11:return a.sent(),this.logger.info("initializeCortana: token fetch succeeded"),[3,13];case 12:return d=a.sent(),this.logger.error("initializeCortana: token fetch failed, continuing. err: "+d),[3,13];case 13:return a.trys.push([13,15,,16]),[4,this.initializeSdkInternal(i,t,n)];case 14:return a.sent(),this.logger.info("initializeCortana: raising the initialize event"),this.cortanaEventingService.triggerEvent(teamspace.services.CortanaServiceEvents.initialize,!0,null),[3,16];case 15:throw p=a.sent(),this.logger.error("initializeCortana failed: "+p),p;case 16:return[2]}})})},t.prototype.initializeSdkInternal=function(e,t,n){return o(this,void 0,void 0,function(){var i,r,o,c,u,d,p,h,g,f,v=this;return a(this,function(a){switch(a.label){case 0:return this.logger.info("initializeSdkInternal: intitialize the Cortana SDK ..."),[4,this.cortanaConfigurationService.eligibilityEndpoint()];case 1:i=a.sent(),r=this.getConfig(e,i),this.cortanaAuthService.setTelemetryCallback(this.updateTelemetry.bind(this)),o=[null,null],c=!1,a.label=2;case 2:return a.trys.push([2,4,,5]),[4,this.cortanaConfigurationService.isWakeWordEnabled()];case 3:return c=a.sent(),[3,5];case 4:return u=a.sent(),this.logger.error("initializeSdkInternal: couldn't get wake word config, err: "+u),e.getKwsModeError=u,[3,5];case 5:e.kwsMode=c?"true":"false",(d=this.storageService.get(this.constants.storageServiceKeys.cortanaVoice))||(d=teamspace.services.cortanaVoiceDefault),p=function(t){v.logger.info("initializeSdkInternal: Cortana SDK pre-start invoked..."),v.initState=s.PreStarted,v.cortanaInstance=t;var n,i=v.localizationService.getLocale().split("-"),r=i[0],a=i[1];n=r&&a?r.toLowerCase()+"-"+a.toUpperCase():"en-US",v.logger.info("user locale {0}",n),e.locale=n,t.language=n,t.keywordSpotting=c,t.voiceFont=d,t.userConsent=l.UserConsent.None,v.cortanaConfigurationService.getUserLongConsentStatus()===v.constants.cortanaLongCosentKey.AllowRecording&&(t.userConsent=l.UserConsent.AllowRecording),v.settingsService.valueFor(v.constants.settings.names.rigel).enableCortanaLoggingConsent&&(v.logger.info("initializeSdkInternal: Received ecs flag enableCortanaLoggingConsent as true, setting Consent to allow recording and logging"),t.userConsent=l.UserConsent.AllowRecording|l.UserConsent.AllowCortanaLogging);var u=o[0],p=o[1];if(u&&(v.logger.info("initializeSdkInternal: using audio input: "+JSON.stringify(u,["label","deviceId"])),t.audioInputId=u.deviceId),p&&(v.logger.info("initializeSdkInternal: using audio output: "+JSON.stringify(p,["label","deviceId"])),t.audioOutputId=p.deviceId),t.dialogMode=l.DialogMode.FullAttention,t.onStateChange=function(e){return v.updateCortanaState(e)},t.onSpeechPhrase=function(e){return v.updateSpeechPhrase(e)},t.onDisplayText=function(e){return v.updateCortanaMessage(e)},t.onAdaptiveCards=function(e){return v.updateAdaptiveCards(e)},t.onSuggestions=function(e){return v.updateSuggestions(e)},t.onError=function(e){return v.updateErrorMessage(e)},v.settingsService.valueFor(v.constants.settings.names.rigel).enableCortanaAudioLogging){var h=v.settingsService.valueFor(v.constants.settings.names.rigel).cortanaAudioLoggingTime||v.constants.timeInMiliseconds.fiveMinutes;t.onAudioData=function(e){return v.recordPCMAudioData(e)},v.$interval(function(){v.audioFragmentCount=0,v.audioFragments={}},h)}v.settingsService.valueFor(v.constants.settings.names.rigel).enableCortanaKwsUx&&(t.onKeywordSpotterEvent=function(e,t){return v.raiseKeywordSpotterEvent(e)})},this.logger.info("initializeSdkInternal: getting media devices..."),this.initState=s.GettingMediaDevices,a.label=6;case 6:return a.trys.push([6,8,,9]),[4,this.cortanaDeviceService.getSuggestedDevices(["audioinput","audiooutput"])];case 7:return o=a.sent(),[3,9];case 8:return h=a.sent(),this.logger.error("initializeSdkInternal: getting media devices failed, but continuing. err: "+h),[3,9];case 9:this.logger.info("initializeSdkInternal: starting the Cortana SDK..."),a.label=10;case 10:return a.trys.push([10,12,,13]),[4,l.cortanaStart(r,p)];case 11:return g=a.sent(),this.logger.info("initializeSdkInternal: Cortana SDK started"),this.initState=s.Started,e.newInit="true",e.CortanaActionType="newInit",e.deviceThumbprint=localStorage.getItem("device_thumbprint"),n?t.mark(teamspace.services.CortanaScenarioEventsType.InitSDK,this.getTelemetryObjWithDataBag(e)):t.stop(this.getTelemetryObjWithDataBag(e)),this.isDevicesChangedPendingStart&&(this.logger.info("initializeSdkInternal: media devices changed while the SDK was starting, update it now"),this.onDevicesChanged()),this.isDevicesChangedPendingStart=!1,[2,g];case 12:throw f=a.sent(),this.logger.info("initializeSdkInternal failed: "+f),this.cortanaInstance=null,this.initState=s.Errored,this.isDevicesChangedPendingStart=!1,e.newInit="false",f;case 13:return[2]}})})},t.prototype.destroyCortana=function(e){this.logger.info("destroyCortana, reason: "+e+", initState: "+this.initState),this.cortanaInstance&&this.cortanaInstance.close(),this.cortanaInstance=null,this.initState=s.NotInitialized,this.registeredSkills&&this.registeredSkills.forEach(function(e){e.cleanup&&e.cleanup()}),this.isDevicesChangedPendingStart=!1,this.cortanaEventingService.triggerEvent(teamspace.services.CortanaServiceEvents.destroyed,!0,null)},t.prototype.isCortanaInitialized=function(){return!!this.cortanaInstance&&this.initState===s.Started},t.prototype.getCortanaState=function(){return this.cortanaState},t.prototype.getConfig=function(e,t){var n=this.settingsService.valueFor(this.constants.settings.environment),i=this.settingsService.valueFor(this.constants.settings.names.cortanaConstants),r=this.platformDetectService.getClientVersion(),o=this.getPlatformName(n&&n.platformId);Object.assign(e,{getConfig:!0,qos:i.qualityOfService,appName:i.appName,appFlavor:o,appVersion:r,appCompany:i.companyName}),this.registeredSkills=this.cortanaSkillManager.getSkills();var a=this.settingsService.getRing(),s=i.assetBaseUrl?this.settingsService.getStaticsUri()+i.assetBaseUrl:null;return{authenticator:this.cortanaAuthService,qos:i.qualityOfService,disableGeolocation:!0,binPath:s,dataPath:s,logger:this.logger,app:{name:i.appName,flavor:o,version:r,company:i.companyName,ring:a?a.id:null},soundEffects:!0,skills:this.registeredSkills,endpoint:t}},t.prototype.getPlatformName=function(e){return{27:"windows-desktop",28:"mac-desktop",34:"rigel",35:"surface-hub",1415:"web"}[e]||""},t.prototype.getCorrelationIdAndServiceTag=function(){return{correlationId:this.cortanaInstance&&this.cortanaInstance.correlationId?this.cortanaInstance.correlationId:null,serviceTag:this.cortanaInstance&&this.cortanaInstance.serviceTag?this.cortanaInstance.serviceTag:null}},t.prototype.onConfigurationUpdated=function(e){return o(this,void 0,void 0,function(){var t,n,i,r,o,s;return a(this,function(a){switch(a.label){case 0:t=e.reason,n=e.needsRestart,this.logger.info("onConfigurationUpdated: reason: "+t+", needsRestart: "+n),i=!1,r=this.loggingService.newScenario(this.constants.scenarios.cortana.init),a.label=1;case 1:return a.trys.push([1,3,,4]),[4,this.cortanaConfigurationService.isCortanaEnabled()];case 2:return i=a.sent(),[3,4];case 3:return o=a.sent(),this.logger.error("onConfigurationUpdated failed: "+o),r.fail(o),[2];case 4:if(!i)return[3,9];this.logger.info("onConfigurationUpdated: Cortana is enabled, initialize Cortana"),r.mark(h.InitSDK,{configurationUpdatedReason:t,needsRestart:n}),a.label=5;case 5:return a.trys.push([5,7,,8]),[4,this.initializeCortana(n,r)];case 6:return a.sent(),r.stop(),[3,8];case 7:return s=a.sent(),r.fail(s),[3,8];case 8:return[3,10];case 9:this.logger.info("onConfigurationUpdated: Cortana is disabled, destroy Cortana"),this.destroyCortana(),r.mark(h.PolicyConfiguration,{destroyCortanaInstance:!0}),r.stop(),a.label=10;case 10:return[2]}})})},t.prototype.onDevicesChanged=function(){return o(this,void 0,void 0,function(){var e,t,n;return a(this,function(i){switch(i.label){case 0:return this.logger.info("onDevicesChanged: on devices changed event received"),this.initState!==s.Started?(this.logger.info("onDevicesChanged: Cortana SDK not started yet, ignoring devices changed, initState: "+this.initState),this.initState===s.NotInitialized||this.initState===s.GettingMediaDevices?[2]:(this.isDevicesChangedPendingStart=!0,[2])):(this.logger.info("onDevicesChanged: getting media devices..."),[4,this.cortanaDeviceService.getSuggestedDevices(["audioinput","audiooutput"])]);case 1:return e=i.sent(),t=e[0],n=e[1],t&&(this.logger.info("onDevicesChanged: updating audio input: "+JSON.stringify(t,["label","deviceId"])),this.cortanaInstance.audioInputId=t&&t.deviceId),n&&(this.logger.info("onDevicesChanged: updating audio output: "+JSON.stringify(n,["label","deviceId"])),this.cortanaInstance.audioOutputId=n&&n.deviceId),[2]}})})},t.prototype.updateTelemetry=function(e,t,n){if(this.cortanaInstance){var i=this.cortanaInstance.correlationId,o=this.cortanaInstance.serviceTag;this.serviceTag!==o&&(this.storageService.set(p.lastTraceId,o),this.serviceTag=o),this.logger.info("cortana correlationId="+i+" service-tag="+o),n=r({correlationId:i,serviceTag:o,event:t},n),this.correlationId!==this.cortanaInstance.correlationId&&(this.correlationId=this.cortanaInstance.correlationId,this.scenarioInstance&&(this.scenarioInstance.stop(),this.scenarioInstance=null)),this.scenarioInstance||(this.scenarioInstance=this.loggingService.newScenario(this.constants.scenarios.cortana.allEvents)),e===teamspace.services.CortanaScenarioLogType.Mark?this.scenarioInstance.mark(t,n):e===teamspace.services.CortanaScenarioLogType.Done?(this.scenarioInstance.stop(n),this.scenarioInstance=null):e===teamspace.services.CortanaScenarioLogType.Fail&&(this.scenarioInstance.fail(n),this.scenarioInstance=null)}},t.prototype.updateCortanaState=function(e){this.logger.info("changing cortana state to {0}",e),this.cortanaState=e;var t={eventName:teamspace.services.CortanaServiceEvents.stateChanged,state:e};this.cortanaInvocationLatencyScenario&&(e===l.CortanaState.Listening&&this.cortanaInvoked?(this.cortanaInvocationLatencyScenario.mark("firstlistening",this.getCorrelationIdAndServiceTag()),this.cortanaInvoked=!1):this.cortanaInvocationLatencyScenario.mark(e,this.getCorrelationIdAndServiceTag())),e===l.CortanaState.Listening&&(this.firstTextTranscribing=!0,this.stitchRawAudioAndDownload()),this.updateTelemetry(teamspace.services.CortanaScenarioLogType.Mark,teamspace.services.CortanaScenarioEventsType.SdkEvent,t),this.cortanaEventingService.triggerEvent(teamspace.services.CortanaServiceEvents.stateChanged,!0,e),this.settingsService.valueAsBoolean(this.constants.settings.names.enableCortanaAudioDucking)&&this.updateAudioDuckingState(e)},t.prototype.updateAudioDuckingState=function(e){if(e===l.CortanaState.Ready){this.callingAgentsService.unduckSpeakerVolume();t={actionType:teamspace.services.CortanaScenarioEventsActionType.StartAudioDucking};this.updateTelemetry(teamspace.services.CortanaScenarioLogType.Mark,teamspace.services.CortanaScenarioEventsType.Action,t)}else if(e===l.CortanaState.Listening||e===l.CortanaState.Speaking||e===l.CortanaState.Thinking){this.callingAgentsService.duckSpeakerVolume(10);var t={actionType:teamspace.services.CortanaScenarioEventsActionType.StopAudioDucking};this.updateTelemetry(teamspace.services.CortanaScenarioLogType.Mark,teamspace.services.CortanaScenarioEventsType.Action,t)}},t.prototype.updateSpeechPhrase=function(e){this.logger.info("changing received speech phrase");var t={eventName:teamspace.services.CortanaServiceEvents.phraseUpdated};this.updateTelemetry(teamspace.services.CortanaScenarioLogType.Mark,teamspace.services.CortanaScenarioEventsType.SdkEvent,t),this.cortanaEventingService.triggerEvent(teamspace.services.CortanaServiceEvents.phraseUpdated,!0,e.phrase),this.cortanaInvocationLatencyScenario&&(this.firstTextTranscribing?(this.cortanaInvocationLatencyScenario.mark("firstTextTranscribed",this.getCorrelationIdAndServiceTag()),this.firstTextTranscribing=!1):this.cortanaInvocationLatencyScenario.mark("textTranscribed",this.getCorrelationIdAndServiceTag()))},t.prototype.updateCortanaMessage=function(e){this.logger.info("changing received message");var t={eventName:teamspace.services.CortanaServiceEvents.messageUpdated};this.updateTelemetry(teamspace.services.CortanaScenarioLogType.Mark,teamspace.services.CortanaScenarioEventsType.SdkEvent,t),this.cortanaEventingService.triggerEvent(teamspace.services.CortanaServiceEvents.messageUpdated,!0,e)},t.prototype.updateAdaptiveCards=function(e){this.logger.info("changing received adaptive card");var t={eventName:teamspace.services.CortanaServiceEvents.adaptiveCardUpdated};this.updateTelemetry(teamspace.services.CortanaScenarioLogType.Mark,teamspace.services.CortanaScenarioEventsType.SdkEvent,t),this.cortanaEventingService.triggerEvent(teamspace.services.CortanaServiceEvents.adaptiveCardUpdated,!0,e)},t.prototype.updateSuggestions=function(e){this.logger.info("changing received suggestions card");var t={eventName:teamspace.services.CortanaServiceEvents.suggestionsUpdated};this.updateTelemetry(teamspace.services.CortanaScenarioLogType.Mark,teamspace.services.CortanaScenarioEventsType.SdkEvent,t),this.cortanaEventingService.triggerEvent(teamspace.services.CortanaServiceEvents.suggestionsUpdated,!0,e)},t.prototype.updateErrorMessage=function(e){var t,n=!1;if(this.cortanaInvocationLatencyScenario){var i={};i.errorMessage="cortanaError: "+e,this.cortanaInvocationLatencyScenario.fail(i),this.cortanaInvocationLatencyScenario=null}switch(e){case l.CortanaError.Success:break;case l.CortanaError.Timeout:t=this.$translate.instant(this.resources.strings.cortana_error_timeout),n=!0;break;case l.CortanaError.NotOnline:t=this.$translate.instant(this.resources.strings.cortana_error_not_online);break;case l.CortanaError.NoTokens:t=this.$translate.instant(this.resources.strings.cortana_error_no_tokens),n=!0;break;case l.CortanaError.NoResponse:t=this.$translate.instant(this.resources.strings.cortana_error_no_response),n=!0;break;case l.CortanaError.AuthError:t=this.$translate.instant(this.resources.strings.cortana_error_auth_error),n=!0;break;case l.CortanaError.Denied:t=this.$translate.instant(this.resources.strings.cortana_error_denied);break;case l.CortanaError.UnknownMediaError:t=this.$translate.instant(this.resources.strings.cortana_error_unknown_media_error);break;case l.CortanaError.MediaDeviceUnavailable:t=this.$translate.instant(this.resources.strings.cortana_error_media_device_unavailable);break;case l.CortanaError.AudioOutput:t=this.$translate.instant(this.resources.strings.cortana_error_audio_output);break;default:t=this.$translate.instant(this.resources.strings.cortana_error_generic),n=!0}var r={eventName:teamspace.services.CortanaServiceEvents.errorMessageUpdated,errorMessage:e};n?this.updateTelemetry(teamspace.services.CortanaScenarioLogType.Fail,teamspace.services.CortanaScenarioEventsType.SdkEvent,r):this.updateTelemetry(teamspace.services.CortanaScenarioLogType.Mark,teamspace.services.CortanaScenarioEventsType.SdkEvent,r),this.logger.error("cortana error received "+e),this.cortanaEventingService.triggerEvent(teamspace.services.CortanaServiceEvents.errorMessageUpdated,!0,t)},t.prototype.raiseKeywordSpotterEvent=function(e){this.cortanaEventingService.triggerEvent(teamspace.services.CortanaServiceEvents.keywordSpotterEvent,!0,e)},t.prototype.recordPCMAudioData=function(e){this.audioFragments[this.audioFragmentCount++]=new Float32Array(e)},t.prototype.stitchRawAudioAndDownload=function(){if(0!==this.audioFragmentCount){for(var e=0,t=0;t<this.audioFragmentCount;t++)e+=this.audioFragments[t].byteLength;var n=new Uint8Array(e);e=0;for(t=0;t<this.audioFragmentCount;t++)n.set(new Uint8Array(this.audioFragments[t].buffer),e),e+=this.audioFragments[t].byteLength;var i=(new Date).toLocaleString().replace(/\/| |:|,/g,"_");this.filesUtilityService.downloadFile("cortanaAudio_RawAudio_"+i,new Blob([n])),this.audioFragments={},this.audioFragmentCount=0}},t.prototype.startRecognizer=function(e){if(this.cortanaInstance){this.cortanaInvocationLatencyScenario=e,this.cortanaInvoked=!0;var t={actionType:teamspace.services.CortanaScenarioEventsActionType.StartListening};this.updateTelemetry(teamspace.services.CortanaScenarioLogType.Mark,teamspace.services.CortanaScenarioEventsType.Action,t),this.cortanaInstance.listen()}},t.prototype.stopRecognizer=function(){if(this.cortanaInstance){var e={actionType:teamspace.services.CortanaScenarioEventsActionType.StopListening};this.updateTelemetry(teamspace.services.CortanaScenarioLogType.Mark,teamspace.services.CortanaScenarioEventsType.Action,e),this.cortanaInstance.stopListening()}},t.prototype.adaptiveCardAction=function(e,t){this.sendCustomEvent(d.ClientSkillsId.card,e,t)},t.prototype.cancel=function(){var e={actionType:teamspace.services.CortanaScenarioEventsActionType.Cancel};this.updateTelemetry(teamspace.services.CortanaScenarioLogType.Mark,teamspace.services.CortanaScenarioEventsType.Action,e),this.cortanaInstance.cancel()},t.prototype.toggleWakeWord=function(e){this.cortanaInstance?this.cortanaInstance.keywordSpotting=e:this.logger.warn("can't set keywordSpotting, cortanaInstance is null")},t}(teamspace.services.MTMABase);t.CortanaService=f,angular.module("teamspace.cortanaService",["skypeX.myUserPreferencesStore","teamspace.tokenWarmingUtility","teamspace.appState","teamspace.callingAgentsService","teamspace.constants","teamspace.cortanaDeviceService","teamspace.cortanaConfigurationService","teamspace.loggingService","teamspace.orchestrationService","teamspace.settingsService","teamspace.storageService","teamspace.cortanaAuthService","teamspace.platformDetectService","teamspace.cortanaConfigurationService","teamspace.cortanaEventingService","teamspace.localizationService","teamspace.filesUtilityService"]).service("cortanaService",f)},2192:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),r=this&&this.__assign||function(){return(r=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++){t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var o=n(11),a=n(19),s=teamspace.services.MTMASubscriptionUtility,c=teamspace.services.CortanaState,l=function(e){function t(t,n,i,r,o,a,s,c,l,u,d,p,h,g,f,v,m,S){var y=e.call(this,S)||this;return y.$injector=t,y.$ocLazyLoad=n,y.callingActionHandler=i,y.constants=r,y.downloadFilesActionHandler=o,y.fileActionHandler=a,y.loggingService=s,y.meetingActionHandler=c,y.navigationActionHandler=l,y.presentActionHandler=u,y.teamsMiscActionHandler=d,y.sendMessageActionHandler=p,y.setStatusActionHandler=h,y.takeNoteActionHandler=g,y.teamChannelActionHandler=f,y.utilityService=v,y.cortanaEventingService=m,y.cortanaSkillExecutionScenarioMarker="cortana_skill_execution",y.cortanaInvocationLatencyScenarioName="cortana_invocation",y.logger=s.newLogger("TeamsActionService"),y.initializeOnAppLaunchAndReinit(),y.loadCortanaServiceModule(),y}return i(t,e),t.$inject=["$injector","$ocLazyLoad","callingActionHandler","constants","downloadFilesActionHandler","fileActionHandler","loggingService","meetingActionHandler","navigationActionHandler","presentActionHandler","teamsMiscActionHandler","sendMessageActionHandler","setStatusActionHandler","takeNoteActionHandler","teamChannelActionHandler","utilityService","cortanaEventingService","orchestrationService"],t.prototype.initializeOnAppLaunchAndReinit=function(e){var t=this;this.teamsActionHandlers=new Map,this.teamsActionAdapters=new Map,this.activeActions=new Map,this.ttsDefer=void 0,this.telemetryCb=function(e,t,n){},this.registerActionHandler(this.callingActionHandler),this.registerActionHandler(this.downloadFilesActionHandler),this.registerActionHandler(this.fileActionHandler),this.registerActionHandler(this.meetingActionHandler),this.registerActionHandler(this.navigationActionHandler),this.registerActionHandler(this.presentActionHandler),this.registerActionHandler(this.teamsMiscActionHandler),this.registerActionHandler(this.sendMessageActionHandler),this.registerActionHandler(this.setStatusActionHandler),this.registerActionHandler(this.takeNoteActionHandler),this.registerActionHandler(this.teamChannelActionHandler),this.teamsActionAdapters.set(this.getTeamsActionAdapterKey(o.ClientSkillsId.communication),this.communicationClientSkillAdapter.bind(this)),this.teamsActionAdapters.set(this.getTeamsActionAdapterKey(o.ClientSkillsId.meeting),this.meetingActionClientSkillAdapter.bind(this)),this.teamsActionAdapters.set(this.getTeamsActionAdapterKey(o.ClientSkillsId.communication,o.ClientSkillsActions.sendMessage),this.sendMessageClientSkillAdapter.bind(this)),this.teamsActionAdapters.set(this.getTeamsActionAdapterKey(o.ClientSkillsId.teams),this.teamsResponseClientSkillAdapter.bind(this)),this.teamsActionAdapters.set(this.getTeamsActionAdapterKey(o.ClientSkillsId.teams,o.ClientSkillsActions.setStatus),this.teamsActionClientSkillAdapter.bind(this)),this.teamsActionAdapters.set(this.getTeamsActionAdapterKey(o.ClientSkillsId.skype,o.ClientSkillsActions.meeting.joinMeeting),this.skypeActionClientSkillAdapter.bind(this)),this.cortanaStateSubscription=s.subscribe(this.cortanaEventingService,function(e,n){return t.onCortanaStateChanged(n)},services.CortanaServiceEvents.stateChanged)},t.prototype.cleanupOnAppTeardown=function(e){this.teamsActionHandlers=void 0,this.teamsActionAdapters=void 0,this.activeActions=void 0,this.telemetryCb=void 0,this.cortanaSkillExecutionScenario=void 0,this.ttsDefer=void 0,this.cortanaStateSubscription&&(s.unsubscribe(this.cortanaEventingService,this.cortanaStateSubscription),this.cortanaStateSubscription=null)},t.prototype.mtmaTelemetryIdentifier=function(){return"teamsActionService"},t.prototype.registerActionHandler=function(e){this.teamsActionHandlers.has(e.actionId)?this.logger.warn("duplicate registration of teams action handler {0}",e.actionId):this.teamsActionHandlers.set(e.actionId,{handler:e,isActive:!0})},t.prototype.enableAction=function(e,t){void 0===t&&(t=!0);var n=this.getActionHandler(e);n&&(n.isActive=t)},t.prototype.getRegisteredActions=function(){var e=[];return this.teamsActionHandlers.forEach(function(t,n){e=e.concat(n)}),e},t.prototype.cancelActionPromise=function(e){var t=this.activeActions.get(e);if(!t)return!1;var n=!0;return t.actionState===a.ActionThreadState.Waiting&&(n=!1,this.logger.info("canceling action: {0}",t.actionId)),t.isCanceled=!0,this.resolveAction(t,this.getActionResult(a.TeamsCortanaActionStatus.SysCancel,t.actionId)),n},t.prototype.invokeAction=function(e,t,n,i){var r=this;if(t||(t=this.loggingService.newScenario(this.constants.scenarios.cortana.action.actionScenarioName),n={}),!e)return this.logger.info("null action"),t.fail(n),null;this.logger.info("invokeAction called with actionId = {0}",e.actionId),n.actionId=e.actionId;var o=this.createActionThread(e.actionId,t,n),s=this.getActionHandler(e.actionId);if(!s||!s.isActive)return this.logger.info("action handler inactive or not found: {0}",e.actionId),this.resolveAction(o,this.getActionResult(a.TeamsCortanaActionStatus.Inactive,e.actionId)),o;var c={actionId:e.actionId,skillAction:n.skillAction,CortanaActionType:n.actionId};e.actionDelay=e.actionDelay||0,void 0!==e.dismissOnAction&&null!==e.dismissOnAction||(e.dismissOnAction=!0);var l=e.actionDelay?new Promise(function(t){return setTimeout(t,1e3*e.actionDelay)}):Promise.resolve();return o.actionState=a.ActionThreadState.Waiting,e.actionDelay&&this.skillExecutionNotify("willExecute",o.actionExecutionId,e.dismissOnAction,e.actionDelay),l.then(function(){if(o.isCanceled)r.logger.info("action canceled: {0} [{1}]",o.actionId,o.actionState);else{r.logger.info("invoking action: {0}",e.actionId),t.mark(r.constants.scenarios.cortana.action.marks.invokingAction,Object.assign({},n)),o.actionState=a.ActionThreadState.Running,i&&(i.mark("skillExecutionSubmission",c),i.stop(),i=null);try{s.handler.handleAction(e).then(function(t){if(r.resolveAction(o,t),t.actionResponseData){var i=t.actionResponseData;r.sendActionResponseData(i.id,i.event,i.slots)}else r.sendActionResponseData(n.skillId,n.skillAction,{success:!0,errorMessage:null});e.dismissOnAction&&r.closeCortana(),e.actionDelay&&r.skillExecutionNotify("executed"),c.success="true",c.errorMessage="null",r.telemetryCb(teamspace.services.CortanaScenarioLogType.Mark,teamspace.services.CortanaScenarioEventsType.Skill,c),r.cortanaSkillExecutionScenario.stop(c)}).catch(function(t){r.sendActionResponseData(n.skillId,n.skillAction,{success:!1,errorMessage:t}),r.resolveAction(o,r.getActionResult(a.TeamsCortanaActionStatus.Error,e.actionId),t),c.success="false",c.errorMessage=t,r.telemetryCb(teamspace.services.CortanaScenarioLogType.Mark,teamspace.services.CortanaScenarioEventsType.Skill,c),r.cortanaSkillExecutionScenario.fail(c)})}catch(t){r.logger.error("handleAction exception"),r.resolveAction(o,r.getActionResult(a.TeamsCortanaActionStatus.Error,e.actionId))}}}).catch(function(){r.logger.error("delay exception"),r.resolveAction(o,r.getActionResult(a.TeamsCortanaActionStatus.Error,e.actionId))}),o},t.prototype.sendActionResponseData=function(e,t,n){if(this.logger.info("sendActionResponseData called with args id = {0} eventName = {1}",e,t),e!==o.ClientSkillsId.teams)return o.ActionTypeToResult[t]?this.cortanaService.sendCustomEvent(e,o.ActionTypeToResult[t],n):this.cortanaService.sendCustomEvent(e,t,n)},t.prototype.setTelemetryCallback=function(e){this.telemetryCb=e},t.prototype.onCortanaStateChanged=function(e){switch(e.data){case c.Ready:this.ttsDefer&&this.ttsDefer.resolve(),this.ttsDefer=void 0}},t.prototype.loadCortanaServiceModule=function(){var e=this;return this.$ocLazyLoad.load("cortana-services").then(function(){var t=e.$injector.get("cortanaService");t?e.cortanaService=t:e.logger.error("failed to inject cortanaService")}).catch(function(t){return e.logger.error("failed to lazy load cortana-services module",t),!1})},t.prototype.handleTTSSkill=function(e){return e.id===o.ClientSkillsId.textToSpeech&&e.action===o.ClientSkillsActions.speak?(this.logger.info("Received TTS, starting the deferral for TTS to complete"),this.ttsDefer=this.utilityService.createDefer(),this.ttsDefer.promise()):this.ttsDefer?this.ttsDefer.promise():Promise.resolve()},t.prototype.handleClientSkill=function(e,t){var n=this;return this.ttsDefer?(this.logger.info("Waiting on TTS to complete before executing client skill"),this.ttsDefer.promise().then(function(){return n.logger.info("TTS complete executing client skill"),n.executeClientSkill(e,t)})):Promise.resolve(this.executeClientSkill(e,t))},t.prototype.executeClientSkill=function(e,t){var n=this.loggingService.findScenario(this.cortanaInvocationLatencyScenarioName);if(n&&n.mark("skillMetadataReceipt",{skillAction:e&&e.action?e.action:""}),this.cortanaSkillExecutionScenario=this.loggingService.newScenario(this.cortanaSkillExecutionScenarioMarker,null,null,null,!0),this.logger.info("handleClientSkill called with params",e,t),!e||!e.id)return null;var i=this.loggingService.newScenario(this.constants.scenarios.cortana.action.skillScenarioName),r={skillId:e.id,skillAction:e.action},o=this.getTeamsActionAdapterKey(e.id,e.action);this.teamsActionAdapters.has(o)||(o=this.getTeamsActionAdapterKey(e.id));var a=this.teamsActionAdapters.get(o),s=a&&a(e,t);return r.actionId=s&&s.actionId,this.invokeAction(s,i,r,n)},t.prototype.createActionThread=function(e,t,n){var i={actionId:e,actionState:a.ActionThreadState.None,actionExecutionId:this.utilityService.generateUUIDNormalized(),actionScenario:t,actionScenarioData:n||{},actionPromise:null,actionResolve:null,actionReject:null};return i.actionPromise=new Promise(function(e,t){i.actionResolve=e,i.actionReject=t}),this.activeActions.set(i.actionExecutionId,i),i},t.prototype.resolveAction=function(e,t,n){e&&(t&&(t.actionInfo=this.scrubActionInfo(t.actionInfo),e.actionScenarioData.actionInfo=t.actionInfo,e.actionScenarioData.actionStatus=t.status),n?(e.actionScenarioData.actionError=n,e.actionScenario.fail(e.actionScenarioData),e.actionReject(n)):(e.actionScenario.stop(e.actionScenarioData),e.actionResolve(t)),e.actionScenarioData=null,e.actionState=a.ActionThreadState.Completed,this.activeActions.delete(e.actionExecutionId))},t.prototype.scrubActionInfo=function(e){if(!e)return"";var t="";try{JSON.parse(e)}catch(n){t=e}return t},t.prototype.getActionHandler=function(e){return e&&this.teamsActionHandlers.has(e)?this.teamsActionHandlers.get(e):null},t.prototype.getActionResult=function(e,t){return{status:e,actionId:t||"<service>"}},t.prototype.getTeamsActionAdapterKey=function(e,t){return t?e+"::"+t:e},t.prototype.teamsResponseClientSkillAdapter=function(e,t){return e.action&&e.actionId?e:(this.logger.error("invalid action payload found in clientSkill object"),null)},t.prototype.teamsActionClientSkillAdapter=function(e,t){if(!e.action)return this.logger.error("unknown action"),null;var n=null;switch(e.action){case o.ClientSkillsActions.setStatus:var i=e;n={actionId:a.TeamsActionsId.setStatus,userStatus:i.userStatus};break;case o.ClientSkillsActions.dismissCortana:n={actionId:a.TeamsActionsId.teamsMiscAction,type:a.TeamsMiscActionType.Dismiss};break;default:this.logger.error("invalid Teams action")}return n},t.prototype.skypeActionClientSkillAdapter=function(e,t){var n=e;switch(n.action){case o.ClientSkillsActions.meeting.joinMeeting:return{actionId:a.TeamsActionsId.meetingAction,type:n.action,skypeTeamsMeetingUrl:n.skypeTeamsMeetingUrl,conversationId:n.skypeTeamsProperties?this.parseCid(n.skypeTeamsProperties):null}}},t.prototype.parseCid=function(e){return JSON.parse(e).cid},t.prototype.meetingActionClientSkillAdapter=function(e,t){var n=e;switch(n.action){case o.ClientSkillsActions.meeting.present:case o.ClientSkillsActions.meeting.stopSharingDeck:case o.ClientSkillsActions.meeting.navigateDeck:return"next"===n.navigationType?n.action=o.ClientSkillsActions.meeting.nextSlide:"previous"===n.navigationType?n.action=o.ClientSkillsActions.meeting.previousSlide:"slideNumber"===n.navigationType&&(n.action=o.ClientSkillsActions.meeting.goToSlide),{actionId:a.TeamsActionsId.present,type:n.action,conversationId:n.meetingId?n.meetingId.conversationId:null,deckName:n.deckName,deckUrl:n.deckUrl,fileType:n.fileType,slideIndex:n.slideNumber,callId:n.callId,attachmentInfo:n.attachmentInfo?{eventId:n.attachmentInfo.eventId,attachmentId:n.attachmentInfo.attachmentId,type:n.attachmentInfo["@odata.type"]}:null};case o.ClientSkillsActions.meeting.takeNote:return{actionId:a.TeamsActionsId.takeNote,noteBody:n.noteBody}}},t.prototype.communicationClientSkillAdapter=function(e,t){var n,i,r,s;switch(e.action){case o.ClientSkillsActions.addToCall:case o.ClientSkillsActions.makeCall:var c=e;if(!_.isEmpty(c.addresses)){var l=_.first(c.addresses);n=l.type.toUpperCase()===o.CommAddressTypes.upn?l.value:"",i=l.type.toUpperCase()===o.CommAddressTypes.number?l.value:"",s=l.type.toUpperCase()===o.CommAddressTypes.mri?l.value:""}break;case o.ClientSkillsActions.transferCall:var u=e;n=u.address&&u.address.type.toUpperCase()===o.CommAddressTypes.upn&&u.address.value,i=u.address&&u.address.type.toUpperCase()===o.CommAddressTypes.number&&u.address.value,s=u.address&&u.address.type.toUpperCase()===o.CommAddressTypes.mri&&u.address.value;break;case o.ClientSkillsActions.endCall:case o.ClientSkillsActions.resumeCall:case o.ClientSkillsActions.holdCall:r=e.callId}return{actionId:a.TeamsActionsId.callingAction,type:e.action,contacts:[{upn:n,number:i,mri:s}],callId:r}},t.prototype.closeCortana=function(){this.cortanaEventingService.triggerEvent(teamspace.services.CortanaServiceEvents.dismiss,!0)},t.prototype.skillExecutionNotify=function(e,t,n,i){var o=this,a={state:e};"willExecute"===e&&(a=r(r({},a),{dismissOnAction:n,actionDelay:i,cancelActionCb:function(){o.cancelActionPromise(t)}})),this.cortanaEventingService.triggerEvent(teamspace.services.CortanaServiceEvents.skillNotify,!0,a)},t.prototype.sendMessageClientSkillAdapter=function(e,t){var n=e,i=_.groupBy(n.addresses,function(e){return e.type.toUpperCase()}),r=_.map(i[o.CommAddressTypes.mri],function(e){return e.value}),s=_.map(i[o.CommAddressTypes.upn],function(e){return e.value}),c=_.map(i[o.CommAddressTypes.conversationId],function(e){return e.value}),l=c.length?c[0]:null;return{actionId:a.TeamsActionsId.sendMessageAction,conversationId:l,mris:r,userPrincipalNames:s,message:n.message,eventInfo:{id:o.ClientSkillsId.communication,event:"sendMessageActionResult"}}},t}(teamspace.services.MTMABase);t.TeamsActionService=l,angular.module("teamspace.teamsActionService",["teamspace.callingActionHandler","teamspace.constants","teamspace.downloadFilesActionHandler","teamspace.fileActionHandler","teamspace.loggingService","teamspace.meetingActionHandler","teamspace.navigationActionHandler","teamspace.presentActionHandler","teamspace.teamsMiscActionHandler","teamspace.sendMessageActionHandler","teamspace.setStatusActionHandler","teamspace.teamChannelActionHandler","teamspace.takeNoteActionHandler","teamspace.cortanaEventingService","teamspace.utilityService"]).service("teamsActionService",l)},2193:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(2194),o=n(2195),a=n(2196),s=n(2197),c=n(2198),l=n(2199),u=n(2200),d=function(e){function t(t,n,i,r,o){var a=e.call(this,t)||this;return a.orchestrationService=t,a.teamsActionService=i,a.cortanaClientContextService=r,a.communicationSkillConfigProvider=o,a.logger=n.newLogger("CortanaSkillManager"),a.initializeOnAppLaunchAndReinit("launch"),a}return i(t,e),t.$inject=["orchestrationService","loggingService","teamsActionService","cortanaClientContextService","communicationSkillConfigProvider"],t.prototype.mtmaTelemetryIdentifier=function(){return"CortanaSkillManager"},t.prototype.setTelemetryCallback=function(e){this.teamsActionService.setTelemetryCallback(e)},t.prototype.initializeOnAppLaunchAndReinit=function(e){this.logger.info("initializeOnAppLaunchAndReinit: reason = {0}",e),this.cortanaClientContextService.initialize()},t.prototype.cleanupOnAppTeardown=function(e){this.logger.info("cleanupOnAppTeardown: reason = {0}",e)},t.prototype.getSkills=function(){return[new r.InMeetingSkillHandler(this.teamsActionService),new o.SkypeSkillHandler(this.teamsActionService),new a.TeamsSkillHandler(this.teamsActionService),new s.CallingSkillHandler(this.teamsActionService),new c.CommunicationSkillHandler(this.teamsActionService,this.cortanaClientContextService,this.communicationSkillConfigProvider),new u.ContextSkill(this.cortanaClientContextService),new l.TextToSpeechSkillHandler(this.teamsActionService)]},t}(teamspace.services.MTMABase);t.CortanaSkillManager=d,angular.module("teamspace.cortanaSkillManager",["teamspace.teamsActionService","teamspace.loggingService","teamspace.orchestrationService","teamspace.communicationSkillConfigProvider","teamspace.cortanaClientContextService"]).service("cortanaSkillManager",d)},2194:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(11),r=function(){function e(e){this.teamsActionService=e,this.skillId=i.ClientSkillsId.meeting}return e.prototype.execute=function(e){this.teamsActionService.handleClientSkill(e)},Object.defineProperty(e.prototype,"id",{get:function(){return this.skillId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contextName",{get:function(){return null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"context",{get:function(){return null},enumerable:!0,configurable:!0}),e}();t.InMeetingSkillHandler=r},2195:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(11),r=function(){function e(e){this.teamsActionService=e,this.skillId=i.ClientSkillsId.skype,this.contextId=i.ClientContextId.skype}return Object.defineProperty(e.prototype,"id",{get:function(){return this.skillId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contextName",{get:function(){return this.contextId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"context",{get:function(){return new i.SkypeContext},enumerable:!0,configurable:!0}),e.prototype.execute=function(e){this.teamsActionService.handleClientSkill(e)},e}();t.SkypeSkillHandler=r},2196:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(11),r=function(){function e(e){this.teamsActionService=e,this.skillId=i.ClientSkillsId.teams}return e.prototype.execute=function(e){this.teamsActionService.handleClientSkill(e)},Object.defineProperty(e.prototype,"id",{get:function(){return this.skillId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contextName",{get:function(){return null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"context",{get:function(){return null},enumerable:!0,configurable:!0}),e}();t.TeamsSkillHandler=r},2197:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(11),r=n(11),o=function(){function e(e){this.teamsActionService=e,this.skillId=i.ClientSkillsId.call,this.contextId=i.ClientContextId.calls}return Object.defineProperty(e.prototype,"id",{get:function(){return this.skillId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contextName",{get:function(){return this.contextId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"context",{get:function(){return new r.CallsContext},enumerable:!0,configurable:!0}),e.prototype.execute=function(e){this.teamsActionService.handleClientSkill(e)},e}();t.CallingSkillHandler=o},2198:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(11),r=function(){function e(e,t,n){this.teamsActionService=e,this.cortanaClientContextService=t,this.communicationSkillConfigProvider=n,this.skillId=i.ClientSkillsId.communication,this.contextId=i.ClientContextId.communication,n.initialize()}return Object.defineProperty(e.prototype,"id",{get:function(){return this.skillId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contextName",{get:function(){return this.contextId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"context",{get:function(){return this.communicationContext=new i.CommunicationContext,this.communicationContext.settings=this.communicationSkillConfigProvider.getConfig(),this.communicationContext.state=this.cortanaClientContextService.getClientContext().communicationContextState,this.communicationContext},enumerable:!0,configurable:!0}),e.prototype.execute=function(e){this.teamsActionService.handleClientSkill(e)},e.prototype.cleanup=function(){this.communicationSkillConfigProvider.deinitialize()},e}();t.CommunicationSkillHandler=r},2199:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(11),r=function(){function e(e){this.teamsActionService=e,this.skillId=i.ClientSkillsId.textToSpeech,this.contextId=i.ClientContextId.textToSpeech}return Object.defineProperty(e.prototype,"id",{get:function(){return this.skillId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contextName",{get:function(){return this.contextId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"context",{get:function(){return new i.TextToSpeechContext},enumerable:!0,configurable:!0}),e.prototype.execute=function(e){this.teamsActionService.handleTTSSkill(e)},e}();t.TextToSpeechSkillHandler=r},2200:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(11),r=function(){function e(e){this.cortanaClientContextService=e,this.contextId=i.ClientContextId.private,this.skillId=i.ClientSkillsId.private}return e.prototype.execute=function(e){},Object.defineProperty(e.prototype,"id",{get:function(){return this.skillId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contextName",{get:function(){return this.contextId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"context",{get:function(){return{teamsUI:this.cortanaClientContextService.getClientContext().teamsContext,inmeeting:this.cortanaClientContextService.getClientContext().inMeetingPrivateContext}},enumerable:!0,configurable:!0}),e}();t.ContextSkill=r},300:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e){this.skillId=e,this.providerCallback=null}return e.prototype.registerCallback=function(e){this.providerCallback=e},e.prototype.clearCallback=function(){this.providerCallback=null},e.prototype.triggerConfigUpdated=function(){this.providerCallback&&this.providerCallback(this.skillId)},e}();t.CortanaConfigProviderBase=i},301:function(e,t,n){"use strict";e.exports=n(2161)},302:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(2167),r=n(131),o=n(303),a=function(){function e(){}return e.getPayloadBlob=function(e,t){var n=new i.IO.MemoryStream,r=new i.CompactBinaryProtocolWriter(n);return r.WriteFieldBegin(i.BondDataType.BT_MAP,3),r.WriteMapContainerBegin(t,i.BondDataType.BT_STRING,i.BondDataType.BT_LIST),Object.keys(e).forEach(function(t){r.WriteString(t);var n=e[t];r.WriteContainerBegin(1,i.BondDataType.BT_STRUCT),r.WriteFieldBegin(i.BondDataType.BT_STRING,2),r.WriteString("act_default_source"),r.WriteFieldBegin(i.BondDataType.BT_STRING,5),r.WriteString(o.newGuid()),r.WriteFieldBegin(i.BondDataType.BT_INT64,6),r.WriteInt64(o.numberToBondInt64(Date.now())),r.WriteFieldBegin(i.BondDataType.BT_LIST,8),r.WriteContainerBegin(n.length,i.BondDataType.BT_STRUCT);for(var a=0;a<n.length;++a)r.WriteBlob(n[a]);r.WriteStructEnd(!1)}),r.WriteStructEnd(!1),n.GetBuffer()},e.getEventBlob=function(e){var t=new i.IO.MemoryStream,n=new i.CompactBinaryProtocolWriter(t);n.WriteFieldBegin(i.BondDataType.BT_STRING,1),n.WriteString(e.id),n.WriteFieldBegin(i.BondDataType.BT_INT64,3),n.WriteInt64(o.numberToBondInt64(e.timestamp)),n.WriteFieldBegin(i.BondDataType.BT_STRING,5),n.WriteString(e.type),n.WriteFieldBegin(i.BondDataType.BT_STRING,6),n.WriteString(e.name);var a=[],s=[];return Object.keys(e.properties).forEach(function(t){e.properties[t].pii===r.AWTPiiKind.NotSet?a.push(t):s.push(t)}),a.length&&(n.WriteFieldBegin(i.BondDataType.BT_MAP,13),n.WriteMapContainerBegin(a.length,i.BondDataType.BT_STRING,i.BondDataType.BT_STRING),a.forEach(function(t){n.WriteString(t),n.WriteString(e.properties[t].value)})),s.length&&(n.WriteFieldBegin(i.BondDataType.BT_MAP,30),n.WriteMapContainerBegin(s.length,i.BondDataType.BT_STRING,i.BondDataType.BT_STRUCT),s.forEach(function(t){n.WriteString(t),n.WriteFieldBegin(i.BondDataType.BT_INT32,1),n.WriteInt32(1),n.WriteFieldBegin(i.BondDataType.BT_INT32,2),n.WriteInt32(e.properties[t].pii),n.WriteFieldBegin(i.BondDataType.BT_STRING,3),n.WriteString(e.properties[t].value),n.WriteStructEnd(!1)})),n.WriteStructEnd(!1),t.GetBuffer()},e.base64Encode=function(e){return i.Encoding.Base64.GetString(e)},e}();t.default=a},303:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(89),r=/[xy]/g;t.numberToBondInt64=function(e){var t=new i.Int64("0");return t.low=4294967295&e,t.high=Math.floor(e/4294967296),t},t.newGuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(r,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})},t.isPii=function(e){return!isNaN(e)&&null!==e&&e>=0&&e<=13}},304:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Version="1.2.0",t.FullVersionString="AWT-Web-CJS-"+t.Version},306:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});!function(e){e.BeforeSdkInit="beforeSDKInit",e.AfterSdkInit="afterSDKInit"}(t.TokenFetchState||(t.TokenFetchState={}))},307:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),r=this&&this.__awaiter||function(e,t,n,i){function r(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||(n=Promise))(function(n,o){function a(e){try{c(i.next(e))}catch(e){o(e)}}function s(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){e.done?n(e.value):r(e.value).then(a,s)}c((i=i.apply(e,t||[])).next())})},o=this&&this.__generator||function(e,t){function n(e){return function(t){return i([e,t])}}function i(n){if(r)throw new TypeError("Generator is already executing.");for(;c;)try{if(r=1,o&&(a=2&n[0]?o.return:n[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,n[1])).done)return a;switch(o=0,a&&(n=[2&n[0],a.value]),n[0]){case 0:case 1:a=n;break;case 4:return c.label++,{value:n[1],done:!1};case 5:c.label++,o=n[1],n=[0];continue;case 7:n=c.ops.pop(),c.trys.pop();continue;default:if(a=c.trys,!(a=a.length>0&&a[a.length-1])&&(6===n[0]||2===n[0])){c=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){c.label=n[1];break}if(6===n[0]&&c.label<a[1]){c.label=a[1],a=n;break}if(a&&c.label<a[2]){c.label=a[2],c.ops.push(n);break}a[2]&&c.ops.pop(),c.trys.pop();continue}n=t.call(e,c)}catch(e){n=[6,e],o=0}finally{r=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var r,o,a,s,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s};Object.defineProperty(t,"__esModule",{value:!0});var a;!function(e){e.devicesChanged="devicesChanged"}(a=t.CortanaDeviceServiceEvents||(t.CortanaDeviceServiceEvents={}));var s=function(e){function t(t,n,i,r,o){var a=e.call(this)||this;return a.constants=t,a.deviceManagerService=n,a.loggingService=i,a.orchestrationService=r,a.utilityService=o,a.hasEnumeratedDevices=!1,a.devices=null,r.registerForMtma(a),a.noSuggestionStrategy=function(){return Promise.resolve(null)},a.logger=i.newLogger("CortanaDeviceService"),a.deviceSuggestionStrategies=new Map,a.deviceSuggestionStrategies.set("audioinput",[function(){return a.getSpecializedCortanaAudioInput()},function(){return a.getTeamsSelectedAudioInput()}]).set("audiooutput",[function(){return a.getTeamsSelectedAudioOutput()}]),a.debouncedDevicesChanged=_.debounce(function(){return a.onDevicesChanged()},100),a.initializeOnAppLaunchAndReinit("launch"),a}return i(t,e),t.$inject=["constants","deviceManagerService","loggingService","orchestrationService","utilityService"],t.prototype.initializeOnAppLaunchAndReinit=function(e){var t=this;this.logger.info("initializeOnAppLaunchAndReinit: reason = "+e),this.hasEnumeratedDevices=!1,this.devices=[],(this.hasAnyStrategy("audioinput")||this.hasAnyStrategy("audiooutput"))&&teamspace.services.MTMASubscriptionUtility.subscribe(this.deviceManagerService,function(){return t.debouncedDevicesChanged()},this.constants.events.calling.devicesChanged)},t.prototype.mtmaTelemetryIdentifier=function(){return"CortanaDeviceService"},t.prototype.cleanupOnAppTeardown=function(e){this.logger.info("cleanupOnAppTeardown: reason = "+e),this.whenHasDevicesDeferred=null,this.hasEnumeratedDevices=!1,this.devices=null,this.debouncedDevicesChanged.cancel()},t.prototype.hasDevice=function(e){var t=this.deviceManagerService.getSelectedDevices();switch(e){case"audioinput":return this.logger.info("hasDevice: microphone: "+t.microphone),!!t.microphone;case"audiooutput":return this.logger.info("hasDevice: speaker: "+t.speaker),!!t.speaker;default:throw new Error("Unsupported media device kind: "+e)}},t.prototype.hasDevices=function(e){var t=this;return void 0===e&&(e=["audioinput","audiooutput"]),e.reduce(function(e,n){return e&&t.hasDevice(n)},!0)},t.prototype.whenHasDevices=function(e){return void 0===e&&(e=["audioinput","audiooutput"]),r(this,void 0,void 0,function(){return o(this,function(t){switch(t.label){case 0:return this.logger.info("whenHasDevices: Waiting for device manager initialization..."),[4,this.deviceManagerService.whenInitialized()];case 1:t.sent(),t.label=2;case 2:return this.hasDevices(e)?[3,4]:(this.logger.info("whenHasDevices: device manager doesn't have selected devices, waiting for devicesChanged event..."),this.whenHasDevicesDeferred=this.utilityService.createDefer(),[4,this.whenHasDevicesDeferred.promise()]);case 3:return t.sent(),[3,2];case 4:return[2]}})})},t.prototype.getSuggestedDevice=function(e){return r(this,void 0,void 0,function(){var t,n,i,r,a,s,c=this;return o(this,function(o){switch(o.label){case 0:if(!this.deviceSuggestionStrategies.has(e))throw new Error("Can't get suggested device, unsupported media device kind: "+e);return this.logger.info("Getting the suggested device for media device kind: "+e+" ..."),t=function(t){return t(e)},n=function(e){return e.then(function(e){return{v:e,isFulfilled:!0}},function(e){return{e:e,isFulfilled:!1}})},[4,Promise.all(this.deviceSuggestionStrategies.get(e).map(t).map(n))];case 1:for(i=o.sent(),r=0,a=i;r<a.length;r++)if((s=a[r]).isFulfilled&&s.v)return[2,s.v];return this.hasAnyStrategy(e)&&(this.logger.info("No suggested device. hasEnumeratedDevices: "+this.hasEnumeratedDevices+", devices: "+(this.devices&&this.devices.length)),this.devices&&this.devices.forEach(function(e,t){c.logger.info("device["+t+"]: "+JSON.stringify(e))})),[2,null]}})})},t.prototype.getSuggestedDevices=function(e){var t=this;return void 0===e&&(e=["audioinput","audiooutput"]),Promise.all(e.map(function(e){return t.getSuggestedDevice(e)}))},t.prototype.hasAnyStrategy=function(e){var t=this;return this.deviceSuggestionStrategies.get(e).some(function(e){return e!==t.noSuggestionStrategy})},t.prototype.getSpecializedCortanaAudioInput=function(){return r(this,void 0,void 0,function(){var e,t,n,i,r,a,s,c;return o(this,function(o){switch(o.label){case 0:e=[{vendorId:"7531",productId:"260"},{vendorId:"27027",productId:"45123"},{vendorId:"5013",productId:"157"}],o.label=1;case 1:if(o.trys.push([1,3,,4]),t=this.deviceManagerService.getMicrophones(),n=this.deviceManagerService.getSelectedDevices(),i=t.find(function(e){return e.id===n.microphone}),this.logger.info("getSpecializedCortanaAudioInput: Teams selected microphone: "+(i&&i.label)),this.logger.info("getSpecializedCortanaAudioInput: Teams selected microphone: "+JSON.stringify(i)),!i)throw new Error("Teams has no selected microphone");if(!(r=e.find(function(e){return e.productId===i.productId&&e.vendorId===i.vendorId})))throw new Error("The selected microphone device does not support an auxiliary Cortana microphone");return[4,this.enumerateDevices()];case 2:if(a=o.sent(),!(s=this.matchDeviceByLabel("audioinput","UAC2_CORTANA",a)))throw new Error("Did not find the Cortana audio input in the enumerated devices");return this.logger.info("getSpecializedCortanaAudioInput: Found audio input device: "+JSON.stringify(s)),[2,s];case 3:throw c=o.sent(),this.logger.info("getSpecializedCortanaAudioInput failed: "+c),c;case 4:return[2]}})})},t.prototype.getTeamsSelectedAudioInput=function(){return r(this,void 0,void 0,function(){var e,t,n,i,r,a;return o(this,function(o){switch(o.label){case 0:if(o.trys.push([0,2,,3]),e=this.deviceManagerService.getMicrophones(),t=this.deviceManagerService.getSelectedDevices(),n=e.find(function(e){return e.id===t.microphone}),this.logger.info("getTeamsSelectedAudioInput: Teams selected microphone: "+(null===n||void 0===n?void 0:n.label)),this.logger.info("getTeamsSelectedAudioInput: Teams selected microphone: "+JSON.stringify(n)),!(null===n||void 0===n?void 0:n.label))throw new Error("Teams has no selected microphone");return[4,this.enumerateDevices()];case 1:if(i=o.sent(),!(r=this.matchDeviceByLabel("audioinput",n.label,i)))throw new Error("The Teams selected microphone doesn't match any enumerated device");return[2,r];case 2:throw a=o.sent(),this.logger.info("getTeamsSelectedAudioInput failed: "+a),this.logDeviceLabels("audioinput"),a;case 3:return[2]}})})},t.prototype.getTeamsSelectedAudioOutput=function(){return r(this,void 0,void 0,function(){var e,t,n,i,r,a;return o(this,function(o){switch(o.label){case 0:if(o.trys.push([0,2,,3]),e=this.deviceManagerService.getSpeakers(),t=this.deviceManagerService.getSelectedDevices(),n=e.find(function(e){return e.id===t.speaker}),this.logger.info("getTeamsSelectedAudioOutput: Teams selected speaker: "+(null===n||void 0===n?void 0:n.label)),this.logger.info("getTeamsSelectedAudioOutput: Teams selected speaker: "+JSON.stringify(n)),!(null===n||void 0===n?void 0:n.label))throw new Error("Teams has no selected speaker");return[4,this.enumerateDevices()];case 1:if(i=o.sent(),!(r=this.matchDeviceByLabel("audiooutput",n.label,i)))throw new Error("The Teams selected speaker doesn't match any enumerated device");return[2,r];case 2:throw a=o.sent(),this.logger.info("getTeamsSelectedAudioOutput failed: "+a),this.logDeviceLabels("audiooutput"),a;case 3:return[2]}})})},t.prototype.enumerateDevices=function(){var e=this;return this.hasEnumeratedDevices?(this.logger.info("enumerateDevices: return cached devices"),Promise.resolve(this.devices)):(this.logger.info("enumerateDevices: enumerating devices..."),navigator.mediaDevices.enumerateDevices().then(function(t){return e.hasEnumeratedDevices=!0,e.devices=t||[],t}).catch(function(t){throw e.hasEnumeratedDevices=!1,e.devices=[],t}))},t.prototype.onDevicesChanged=function(){this.logger.info("onDevicesChanged: received devicesChanged event from the device manager"),this.whenHasDevicesDeferred&&this.whenHasDevicesDeferred.resolve(),this.hasEnumeratedDevices=!1,this.trigger(a.devicesChanged)},t.prototype.matchDeviceByLabel=function(e,t,n){return n.reduce(function(e,n){return n.label.includes(t)?e&&"default"!==e.deviceId&&"communications"!==e.deviceId?e:n:e},null)},t.prototype.logDeviceLabels=function(e){this.logger.info(e+" devices: "+this.devices.filter(function(t){return t.kind===e}).map(function(e){return e.label}))},t}(SkypeX.Services.ObservableBase);t.CortanaDeviceService=s,angular.module("teamspace.cortanaDeviceService",["teamspace.constants","teamspace.deviceManagerService","teamspace.loggingService","teamspace.orchestrationService","teamspace.utilityService"]).service("cortanaDeviceService",s)},89:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e){this.low=0,this.high=0,this.low=parseInt(e,10),this.low<0&&(this.high=-1)}return e.prototype.Equals=function(t){var n=new e(t);return this.low===n.low&&this.high===n.high},e}();t.Int64=i;var r=function(){function e(e){this.low=0,this.high=0,this.low=parseInt(e,10)}return e.prototype.Equals=function(t){var n=new e(t);return this.low===n.low&&this.high===n.high},e}();t.UInt64=r;var o=function(){function e(){}return e.ToByte=function(e){return this.ToUInt8(e)},e.ToInt16=function(e){return 32767&e|(32768&e)<<16>>16},e.ToInt32=function(e){return 2147483647&e|2147483648&e},e.ToUInt8=function(e){return 255&e},e.ToUInt32=function(e){return 4294967295&e},e}();t.Number=o}},[2147]);