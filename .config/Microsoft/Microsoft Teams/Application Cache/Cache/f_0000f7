"use strict";var __extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),__awaiter=this&&this.__awaiter||function(e,t,i,n){function o(e){return e instanceof i?e:new i(function(t){t(e)})}return new(i||(i=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){e.done?i(e.value):o(e.value).then(s,r)}c((n=n.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){function i(e){return function(t){return n([e,t])}}function n(i){if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,a&&(s=2&i[0]?a.return:i[0]?a.throw||((s=a.return)&&s.call(a),0):a.next)&&!(s=s.call(a,i[1])).done)return s;switch(a=0,s&&(i=[2&i[0],s.value]),i[0]){case 0:case 1:s=i;break;case 4:return c.label++,{value:i[1],done:!1};case 5:c.label++,a=i[1],i=[0];continue;case 7:i=c.ops.pop(),c.trys.pop();continue;default:if(s=c.trys,!(s=s.length>0&&s[s.length-1])&&(6===i[0]||2===i[0])){c=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){c.label=i[1];break}if(6===i[0]&&c.label<s[1]){c.label=s[1],s=i;break}if(s&&c.label<s[2]){c.label=s[2],c.ops.push(i);break}s[2]&&c.ops.pop(),c.trys.pop();continue}i=t.call(e,c)}catch(e){i=[6,e],a=0}finally{o=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var o,a,s,r,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return r={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r},__spreadArrays=this&&this.__spreadArrays||function(){for(var e=0,t=0,i=arguments.length;t<i;t++)e+=arguments[t].length;for(var n=Array(e),o=0,t=0;t<i;t++)for(var a=arguments[t],s=0,r=a.length;s<r;s++,o++)n[o]=a[s];return n},teamspace;!function(e){!function(t){var i,n=skype.calling.EventEmitter;!function(e){e[e.HoldCall=0]="HoldCall",e[e.TransferCall=1]="TransferCall",e[e.ConsultThenTransferCall=2]="ConsultThenTransferCall",e[e.DtmfKeypad=3]="DtmfKeypad"}(i||(i={}));var o=function(e){function i(i,n){var o=e.call(this)||this;return o.ipc=i,o.frameSink=n,o.emitHandler=function(e,t){for(var i=[],n=2;n<arguments.length;n++)i[n-2]=arguments[n];return o.emit.apply(o,__spreadArrays([t],i))},t.MTMAIpcUtility.onWithTenantScope(i,"callMonitor:videoRenderer:emit",o.emitHandler),o}return __extends(i,e),i.prototype.dispose=function(){this.ipc.removeListener("callMonitor:videoRenderer:emit",this.emitHandler)},i.prototype.getFrameSink=function(){return this.frameSink},i.prototype.getVideoSize=function(){},i.prototype.setScalingMode=function(e){return this.ipc.send("callMonitor:videoRenderer:invoke","setScalingMode",e),Promise.resolve()},i}(n),a=function(n){function a(e,t,i,o,a,s,r,c,l,h,p,d,g,u,v,f,S,m,y,C,b,T,k,w,_,N,I,A,M,R,P,D){var O=n.call(this)||this;return O.$window=e,O.$translate=t,O.$templateCache=i,O.callingAgentsService=o,O.callingService=a,O.callingSupportService=s,O.callingNavigationService=r,O.constants=c,O.conversationsService=l,O.loggingService=h,O.resources=p,O.callTitleService=d,O.peopleService=g,O.eventingService=u,O.$rootScope=v,O.deviceManagerService=f,O.callTogglingService=S,O.appConfig=m,O.settingsService=y,O.callingAlertsService=C,O.callLobbyService=b,O.callingDurationService=T,O.utilityService=k,O.desktopUtilityService=w,O.authenticationService=_,O.videoSupportService=N,O.callingQualityFeedbackService=A,O.callingIntentMultiWindowService=M,O.callingMultiWindowService=R,O.platformDetectService=P,O.coordinatedMeetingsService=D,O.isShownInExternalWindow=!1,O.isCallScreenVisible=void 0,O.isCurrentlyScreenSharing=!1,O.showNewCriticalUfdDesign=!1,O.showCallQualityIndicator=!1,O.callingFooterAlert=null,O.callingCriticalAlert=null,O.callsChanged=0,O.callStateChangedSubscriptions={},O.alwaysVisibleAlertNames=["SomeoneWaitingInLobby"],O.setHiContrast=function(e,t){O.isHighContrast="contrast"===t,O.monitoredCall&&O.sendUpdate(O.monitoredCall)},O.ipc=e.electronSafeIpc,I.registerForMtma(O),O.logger=h.newLogger("CallMonitor.Desktop"),O.initializeOnAppLaunchAndReinit(),O}return __extends(a,n),a.$inject=["$window","$translate","$templateCache","callingAgentsService","callingService","callingSupportService","callingNavigationService","constants","conversationsService","loggingService","resources","callTitleService","peopleService","eventingService","$rootScope","deviceManagerService","callTogglingService","appConfig","settingsService","callingAlertsService","callLobbyService","callingDurationService","utilityService","desktopUtilityService","authenticationService","videoSupportService","orchestrationService","callingQualityFeedbackService","callingIntentMultiWindowService","callingMultiWindowService","platformDetectService","coordinatedMeetingsService"],a.prototype.initializeOnAppLaunchAndReinit=function(e){var i=this;t.MTMAIpcUtility.onWithTenantScope(this.ipc,"callMonitor:callScreen:event",this.onCallMonitorEvent.bind(this)),this.useMeetingPolicyInScreenSharingFromChat=this.settingsService.valueAsBoolean(this.constants.settings.names.useMeetingPolicyInScreenSharingFromChat),this.adminSettings=this.callingService.getAdminSettings(),this.advancedSettings=this.callingService.getAdvancedCallSettings(),this.areTogglingIncomingVideoFlagsEnabled=this.advancedSettings.isTogglingIncomingVideoEnabled,this.isHighContrast=this.settingsService.getActiveTheme()===this.constants.themes.highContrast,this.eventingService.$onWithTenantScope(this.$rootScope,this.constants.events.layout.themeChanged,this.setHiContrast),this.eventingService.$onWithTenantScope(this.$rootScope,this.constants.events.calling.callRetriedOrCancelled,function(e,t){return i.removeCallStateChangedSubscription(t)}),t.MTMASubscriptionUtility.subscribe(this.callingService,function(e,t){return i.onNetworkReconnect(t.teamsCallId)},this.constants.events.calling.networkReconnect),this.deviceManagerService.whenInitialized().then(function(){i.deviceManagerSubscription=t.MTMASubscriptionUtility.subscribe(i.deviceManagerService,function(){return i.onDeviceChange()},i.constants.events.calling.devicesChanged),i.onDeviceChange()}),this.areTogglingIncomingVideoFlagsEnabled&&(this.incomingVideoSubscription=t.MTMASubscriptionUtility.subscribe(this.callTogglingService,function(){return i.onIncomingVideoValueChanged()},t.CallTogglingService.isIncomingVideoChanged)),this.defaultTitle=this.$translate.instant(this.resources.strings.calling_meetup_default_title),this.defaultWindowTitle=this.$translate.instant(this.resources.strings.calling_multitasking_dialog_title_call),this.qualityIndicatorTooltipText=this.$translate.instant(this.resources.strings.calling_qualityIndicatorTooltip),this.minimizeTooltipText=this.$translate.instant(this.resources.strings.desktopapp_minimize_button_text),this.alertCloseTooltipText=this.$translate.instant(this.resources.strings.modal_dialog_close_button),this.muteParticipantEnabled=this.settingsService.valueAsBoolean(this.constants.settings.names.enableRemoteMuteParticipant),this.showCallMonitorOnMinimize=this.settingsService.valueAsBoolean(this.constants.settings.names.enableCallMonitorOnMinimize),this.escalateScreensharingCallEnabled=this.settingsService.valueAsBoolean(this.constants.settings.names.enableSharingOnlyCallEscalation),this.canMinimizeExternalCallMonitor=this.settingsService.valueAsBoolean(this.constants.settings.names.enableMinimizeCallMonitor),this.disableVideoForVDI=this.desktopUtilityService.isDesktopPluginless(),this.callingConstantsUI=this.settingsService.valueFor(this.constants.settings.names.callingConstants).ui,this.callingButtonTooltips=this.getCallingButtonTooltips(),this.callMonitorTemplate=this.$templateCache.get("components/calling-monitor/calling-monitor.desktop.html"),this.enableUnifiedControlBarInCallMonitor=this.settingsService.valueAsBoolean(this.constants.settings.names.enableUnifiedControlBarInCallMonitor),this.enableConfirmAudioEscalation=this.settingsService.valueAsBoolean(this.constants.settings.names.enableConfirmAudioEscalation),this.useBufferSharing=this.settingsService.valueAsBoolean(this.constants.settings.names.callingEnableBufferSharing),this.shouldShowCQFFromSSFC=this.settingsService.valueAsBoolean(this.constants.settings.names.shouldShowCQFFromSSFC),t.MTMASubscriptionUtility.subscribe(this.callingService,function(){i.callsChanged||(i.callsChanged=_.defer(function(){return i.callingServiceChanged()}))}),this.showCallMonitorOnMinimize&&this.eventingService.$onWithTenantScope(this.$rootScope,this.constants.events.appState.minimizedChanged,function(e,t){i.logger.info("received appState.minimizedChanged event with screen visible: "+!t),i.onShowCallMonitorEvent(!t,!1)})},a.prototype.mtmaTelemetryIdentifier=function(){return"CallMonitor.Desktop"},a.prototype.cleanupOnAppTeardown=function(e){this.unsubscribeAtCleanup(),this.isShownInExternalWindow=!1,this.isCurrentlyScreenSharing=!1,this.isCallScreenVisible=void 0,this.callMonitorTemplate=void 0,this.monitoredCall=void 0,this.showNewCriticalUfdDesign=!1,this.monitoredCallSubscription=void 0,this.inLobbyCountSubscription=void 0,this.callRecordingSubscription=void 0,this.enableUnifiedControlBarInCallMonitor=void 0,this.defaultTitle=void 0,this.defaultWindowTitle=void 0,this.meetupTitleSubscription=void 0,this.deviceManagerSubscription=void 0,this.incomingVideoSubscription=void 0,this.callingAlertsServiceSubscription=void 0,this.cameraAvailable=void 0,this.isMicAvailable=void 0,this.isIncomingVideoOn=void 0,this.videoRenderer=void 0,this.isHighContrast=void 0,this.dominantSpeaker=void 0,this.callStartDate=void 0,this.avatarBackgroundColor=void 0,this.dominantSpeakerVideoIsAvailable=void 0,this.dominantSpeakerSubscription=void 0,this.dominantSpeakerAvatar=void 0,this.frameSink=void 0,this.showCallQualityIndicator=!1,this.qualityIndicatorTooltipText=void 0,this.minimizeTooltipText=void 0,this.alertCloseTooltipText=void 0,this.adminSettings=void 0,this.advancedSettings=void 0,this.areTogglingIncomingVideoFlagsEnabled=void 0,this.callingConversation=void 0,this.callingFooterAlert=null,this.callingCriticalAlert=null,this.callingButtonTooltips=void 0,this.muteParticipantEnabled=void 0,this.showCallMonitorOnMinimize=void 0,this.escalateScreensharingCallEnabled=void 0,this.canMinimizeExternalCallMonitor=void 0,this.broadcastLivePreviewProvider=void 0,this.lastReceivedAlertName=void 0,this.callsChanged=0,this.callStateChangedSubscriptions={},this.callingConstantsUI=void 0,this.disableVideoForVDI=void 0,this.enableConfirmAudioEscalation=void 0,this.useBufferSharing=void 0,this.shouldShowCQFFromSSFC=void 0,this.useMeetingPolicyInScreenSharingFromChat=void 0,this.alwaysVisibleAlertNames=["SomeoneWaitingInLobby"]},a.prototype.unsubscribeAtCleanup=function(){this.monitoredCallSubscription&&this.monitoredCallSubscription.dispose(),this.broadcastLivePreviewProvider&&this.broadcastLivePreviewProvider.dispose(),this.inLobbyCountSubscription&&e.services.MTMASubscriptionUtility.unsubscribe(this.callLobbyService,this.inLobbyCountSubscription),this.callRecordingSubscription&&this.callRecordingSubscription.dispose(),this.callingAlertsServiceSubscription&&e.services.MTMASubscriptionUtility.unsubscribe(this.callingAlertsService,this.callingAlertsServiceSubscription),this.meetupTitleSubscription&&this.meetupTitleSubscription.dispose(),this.deviceManagerSubscription&&e.services.MTMASubscriptionUtility.unsubscribe(this.deviceManagerService,this.deviceManagerSubscription),this.incomingVideoSubscription&&e.services.MTMASubscriptionUtility.unsubscribe(this.callTogglingService,this.incomingVideoSubscription)},a.prototype.callingServiceChanged=function(){var e=this;this.callsChanged=0;var i=this.callingService.getAllCalls(!1),n=Object.keys(this.callStateChangedSubscriptions).filter(function(i){return!e.callingService.getCallByTeamsCallId(t.TeamsCallService.parseTeamsCallId(i))}),o=i.filter(function(t){return!e.callStateChangedSubscriptions[t.teamsCallId]});n.forEach(function(t){e.removeCallStateChangedSubscription(t)}),o.forEach(function(t){e.callStateChangedSubscriptions[t.teamsCallId]=t.changed(function(){return e.updateCallMonitor(t)}),e.isCallScreenVisible=e.initIsCallScreenVisible(t),e.updateCallMonitor(t)})},a.prototype.initIsCallScreenVisible=function(e){if(!e.isScreenshareFromChat){if(!this.settingsService.valueAsBoolean(this.constants.settings.names.enableBetterTogetherExternalCallMonitor)||!e.isInTransportCompanionMode()||this.isCallFromChildWindow(e))return!0;this.log("We are in Better Together call started from the Kingston, so the call is not shown in the child window. teamsCallId = "+e.teamsCallId+", conversationId = "+e.conversationId+".")}},a.prototype.removeCallStateChangedSubscription=function(e){this.callStateChangedSubscriptions[e]&&(this.callStateChangedSubscriptions[e].dispose(),delete this.callStateChangedSubscriptions[e])},a.prototype.monitor=function(i){var n=this;this.log("start monitoring call"),this.monitoredCall=i,this.callingConversation=i.getCallingConversation(),this.callingAlertsServiceSubscription=t.MTMASubscriptionUtility.subscribe(this.callingAlertsService,this.onNewAlertReceived.bind(this)),this.inLobbyCountSubscription=t.MTMASubscriptionUtility.subscribe(this.callLobbyService,function(){return n.sendUpdate(i)},this.constants.events.lobby.inLobbyCountChanged,t.TeamsCallService.getTeamsCallIdAsString(i.teamsCallId)),this.callRecordingSubscription=this.monitoredCall.on("recordingStatusChanged",function(){return n.sendUpdate(i)}),this.callingConversation.isGroup()&&this.conversationsService.safeSubscribe(this.$rootScope,function(){return n.updateTitle(i)},e.services.ConversationsServiceEvents.EventType_TopicChanged),this.startBroadcastMonitoring(i),this.updateTitle(i),this.callingDurationService.whenCallStartDateRetrieved(i).then(function(e){n.callStartDate=e,n.updateTitle(i)}),this.callingConversation.isChannel()&&(this.meetupTitleSubscription=this.callTitleService.subscribeForMeetupTitle(i.teamsCallId,this.updateTitle.bind(this))),this.isIncomingVideoOn=this.callTogglingService.isIncomingVideoOn(i)},a.prototype.renderPreview=function(e){var t=this;this.broadcastLivePreviewProvider&&window.setTimeout(function(){try{t.sendRenderUpdateToExternalWindow(e)}catch(e){t.logger.error("Error while sending render update to call monitor {0}",e)}},0)},a.prototype.isVideoAvailable=function(){return this.cameraAvailable&&this.adminSettings.isVideoEnabled&&!this.disableVideoForVDI},a.prototype.onDeviceChange=function(){var e=this;try{this.deviceManagerService.getCameraAvailable().then(function(t){return e.cameraAvailable=t}),this.isMicAvailable=this.deviceManagerService.getMicrophones().length>0}catch(e){this.logger.error("onDeviceChange failed. error: {0}",e)}},a.prototype.onNewAlertReceived=function(){var e=this.callingAlertsService.getAlerts(t.AlertWindowType.ExternalCallMonitor);if(e.length>0){var i=e[e.length-1];this.showNewCriticalUfdDesign=this.callingAlertsService.showNewCriticalUFDDesign()&&_.includes([t.AlertType.Error,t.AlertType.Warning],i.type),!this.showNewCriticalUfdDesign||i.isAffirmational?(this.updateCallQualityIndicator(i),this.updateFooterAlert()):this.updateCriticalAlert(),this.lastReceivedAlertName!==i.name&&(this.callingAlertsService.sendBITelemetry(i.name),this.lastReceivedAlertName=i.name)}else this.updateQualityIndicatorVisibility(!1),this.showNewCriticalUfdDesign=!1,this.updateFooterAlert(),this.updateCriticalAlert()},a.prototype.updateFooterAlert=function(){var e=this.callingAlertsService.getAlerts(t.AlertWindowType.CallingFooter);e.length>0?this.callingFooterAlert=e[0]:this.callingFooterAlert=null,this.sendUpdate(this.monitoredCall)},a.prototype.updateCriticalAlert=function(){this.getLatestCriticalAlertsOnDisplay(),this.sendUpdate(this.monitoredCall)},a.prototype.updateCallQualityIndicator=function(e){var t;e&&(t=e.showQualityIndicator,this.qualityIndicatorTooltipText=e.text?e.text:this.$translate.instant(this.resources.strings.calling_holdOn_message_callingMonitor)),this.updateQualityIndicatorVisibility(t)},a.prototype.updateQualityIndicatorVisibility=function(e){e!==this.showCallQualityIndicator&&(this.log("showCallQualityIndicator = "+e),this.showCallQualityIndicator=e,this.sendUpdate(this.monitoredCall))},a.prototype.updateTitle=function(e){var t=this;this.callTitleService.getDefaultCallTitle(this.constants.scenarios.calling.context.externalCallMonitor,e,this.constants.dialogs.settings.numberOfNamesInTitle,this.callingConversation).then(function(e){t.defaultTitle=e.titleText,t.sendUpdate(t.monitoredCall)}).catch(function(i){t.logger.error("Could not get default title for call "+e.callId+" error="+i)})},a.prototype.canRenderBroadcastControl=function(){return this.monitoredCall.isBroadcast},a.prototype.startBroadcastMonitoring=function(e){var i=e.setupArgs.meetingInfo;this.canRenderBroadcastControl()&&i&&i.broadcastRole&&"producer"===i.broadcastRole.toLowerCase()&&(this.broadcastLivePreviewProvider&&(this.logger.error("'startBroadcastMonitoring': Broadcast live preview provider should have been null"),this.broadcastLivePreviewProvider.dispose(),this.broadcastLivePreviewProvider=null),this.broadcastLivePreviewProvider=new t.BroadcastLivePreviewProvider(e,this,this.$translate,this.appConfig,this.resources,this.logger),this.broadcastLivePreviewProvider.init())},a.prototype.stopMonitoring=function(){this.log("stopped monitoring"),this.monitoredCall=null,this.callingConversation=null,this.monitoredCallSubscription&&(this.monitoredCallSubscription.dispose(),this.monitoredCallSubscription=null),this.broadcastLivePreviewProvider&&(this.broadcastLivePreviewProvider.dispose(),this.broadcastLivePreviewProvider=null),this.inLobbyCountSubscription&&(e.services.MTMASubscriptionUtility.unsubscribe(this.callLobbyService,this.inLobbyCountSubscription),this.inLobbyCountSubscription=null),this.callRecordingSubscription&&(this.callRecordingSubscription.dispose(),this.callRecordingSubscription=null),this.callingAlertsServiceSubscription&&(e.services.MTMASubscriptionUtility.unsubscribe(this.callingAlertsService,this.callingAlertsServiceSubscription),this.callingAlertsServiceSubscription=null),this.meetupTitleSubscription&&(this.meetupTitleSubscription.dispose(),this.meetupTitleSubscription=null),this.deviceManagerSubscription&&(e.services.MTMASubscriptionUtility.unsubscribe(this.deviceManagerService,this.deviceManagerSubscription),this.deviceManagerSubscription=null),this.incomingVideoSubscription&&(e.services.MTMASubscriptionUtility.unsubscribe(this.callTogglingService,this.incomingVideoSubscription),this.incomingVideoSubscription=null),this.disposeFrameSink(),this.disposeDominantSpeakerSubscription(),this.dominantSpeaker=null},a.prototype.disposeFrameSink=function(){if(this.frameSink)try{this.frameSink.removeAllListeners(),this.frameSink.dispose(),this.ipc.removeAllListeners("callMonitor:frameSink:invoke")}catch(e){this.logger.error("Error disposing frameSink: "+e)}finally{this.frameSink=null}},a.prototype.onCallMonitorEvent=function(e,t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:switch(e=t.type){case"openCall":return[3,1];case"toggleMic":return[3,2];case"toggleVideo":return[3,3];case"togglePresenting":return[3,4];case"endCall":return[3,5];case"minimizeCallMonitor":return[3,7];case"dtmfKeypad":return[3,8];case"transfer":return[3,9];case"consultation":return[3,10];case"hold":return[3,11];case"closeAlert":return[3,12];case"clickOnAlertActionButton":return[3,13]}return[3,14];case 1:return this.onOpen(),[2];case 2:return this.onToggleMic(),[2];case 3:return this.onToggleVideo(),[2];case 4:return this.onTogglePresenting(),[2];case 5:return[4,this.onEndCall()];case 6:return i.sent(),[2];case 7:return this.onMinimizeCallMonitor(),[2];case 8:return this.onDtmfKeypadClick(),[2];case 9:return this.onTransferClick(),[2];case 10:return this.onConsultationClick(),[2];case 11:return this.onHoldClick(),[2];case 12:return this.onCloseAlert(),[2];case 13:return this.onAlertAction(),[2];case 14:return[3,15];case 15:return[2]}})})},a.prototype.getFrameSink=function(){var e=this;return this.frameSink?this.frameSink:(this.frameSink=this.callingAgentsService.createFrameSink(),t.MTMAIpcUtility.onWithTenantScope(this.ipc,"callMonitor:frameSink:invoke",function(t,i,n){switch(i){case"setVideoPreference":e.frameSink.setVideoPreference(n.width,n.height);break;case"setTextureSharingSupported":e.frameSink.setTextureSharingSupported&&e.frameSink.setTextureSharingSupported(n.supported);break;case"log":e.frameSink.log&&e.frameSink.log(n.level,n.message)}}),this.frameSink)},a.prototype.onShowCallMonitorEvent=function(e,t){var i=this.monitoredCall||this.callingService.getActiveCall();if(i){var n=this.isCallFromChildWindow(i),o=this.showCallMonitorOnMinimize&&(n?t:!t);this.logger.info("[onShowCMEvent]-\n        isCallScreenWindowVisible: "+e+",\n        isVisibilityChangedFromChildWindow: "+t+",\n        isCallFromChildWindow: "+n+",\n        shouldUpdateCallMonitor: "+o),o&&(this.isCallScreenVisible=e,this.updateCallMonitor(i))}},a.prototype.isCallInCallMonitor=function(e){return _.isEqual(e,this.monitoredCall)},a.prototype.isCallFromChildWindow=function(e){return this.callingSupportService.isCallPoppedOutInMultiWindow(e)},a.prototype.shouldShowExternalCallMonitor=function(e,t){var i=3===e.state,n=e.setupArgs.isProbeCall,o=this.showCallMonitorOnMinimize&&!1===this.isCallScreenVisible,a=void 0===this.isCallScreenVisible,s=3!==e.sharingSourceType&&e.isScreenSharingOn,r=!this.$window.isRigel&&i&&!n&&(o||(this.showCallMonitorOnMinimize?a:s));return t!==r&&this.logger.info("[shouldShowCM]-\n          showCallMonitorOnMinimize: "+this.showCallMonitorOnMinimize+",\n          isCallConnected: "+i+",\n          isMuted: "+e.isMuted+",\n          isServerMuted: "+e.isServerMuted+",\n          isProbeCall: "+n+",\n          isCallScreenVisible: "+this.isCallScreenVisible+",\n          ssfcSharingRole: "+(e.isScreenshareFromChat&&e.screenSharingControl?e.screenSharingControl.role:"Not applicable")+",\n          isSSFCCallScreenNotVisible: "+a+",\n          isScreenSharingOn: "+e.isScreenSharingOn+",\n          shouldShowExternalCallMonitor : "+r),r},a.prototype.updateCallMonitor=function(e){var t=!!this.monitoredCall,i=this.shouldShowExternalCallMonitor(e,t),n=!1;this.isCurrentlyScreenSharing!==e.isScreenSharingOn&&(this.isCurrentlyScreenSharing=e.isScreenSharingOn,t&&!e.isScreenSharingOn&&(i=!1,this.isCallScreenVisible=!0,n=!0,this.logger.info("[updateCM]- dismiss CM and navigate to calling screen when an active screen sharing session is stopped"))),t&&this.callTogglingService.isHoldStateChanging()&&(i=!1,this.isCallScreenVisible=!0,this.logger.info("[updateCM]- dismiss CM when hold state changing")),3===e.state&&this.sendRenderUpdateToExternalWindow(e),t!==i&&(i?this.showCallMonitor(e,"updateCallMonitor"):t&&e.callId===this.monitoredCall.callId&&(this.hideCallMonitor(e,"updateCallMonitor"),n&&this.navigateToCallScreen(e,{},"updateCallMonitor")))},a.prototype.showCallMonitor=function(e,t){this.logger.info("[showCM]- from "+t+", isScreenSharingOn: "+e.isScreenSharingOn+", isMuted: "+e.isMuted+", isServerMuted: "+e.isServerMuted),this.monitor(e),this.openWindow(e),this.sendRenderUpdateToExternalWindow(e)},a.prototype.hideCallMonitor=function(e,t){this.logger.info("[hideCM]: from "+t+", isScreenSharingOn: "+e.isScreenSharingOn+", isMuted: "+e.isMuted+", isServerMuted: "+e.isServerMuted),this.closeWindow(),this.stopMonitoring()},a.prototype.sendRenderUpdateToExternalWindow=function(t){var i=this;if(this.isShownInExternalWindow){var n=null;if(this.broadcastLivePreviewProvider&&this.broadcastLivePreviewProvider.isPreviewReady())n=this.broadcastLivePreviewProvider.getComposerIdIfExist();else{var o=[].concat(t.dominantSpeakerInfo.speakerList.filter(function(e){return t.participants.some(function(t){return t.id===e})})).concat(t.participants.filter(function(e){return 3===e.state}).map(function(e){return e.id})).filter(function(t){return!e.services.CallUtilities.isCallingSystemBot(t,i.callingConstantsUI.blacklistedBots)});n=o[0]}var a=_.find(t.participants,function(e){return e.id===n});if(a){var s=t.isEmergencyCall&&t.emergencyCalleeMri===a.id;this.updateDominantSpeaker(a,s,t)}else this.removeDominantSpeaker(t);this.sendUpdate(t)}},a.prototype.removeDominantSpeaker=function(e){this.log("removeDominantSpeaker "+(this.dominantSpeaker?this.dominantSpeaker.id:"")+" from callId "+e.callId),this.disposeDominantSpeakerSubscription(),this.dominantSpeaker&&e.participants.indexOf(this.dominantSpeaker)<0&&(this.dominantSpeaker=null,this.dominantSpeakerVideoIsAvailable=!1)},a.prototype.updateDominantSpeaker=function(e,t,i){var n=this;e!==this.dominantSpeaker&&(this.dominantSpeaker&&this.disposeDominantSpeakerSubscription(),this.log("updateDominantSpeaker "+e.id),this.dominantSpeaker=e,this.dominantSpeakerVideoIsAvailable=!1,this.disableVideoForVDI||(this.dominantSpeakerSubscription=e.changed(function(){return n.updateDominantSpeakerVideo(i)})),this.updateDominantSpeakerAvatar(e,t),this.updateDominantSpeakerVideo(i))},a.prototype.updateDominantSpeakerVideo=function(e){var t=this;if(!this.disableVideoForVDI){var i=skype.calling.ICallParticipantHelpers.bestVideoFor(this.dominantSpeaker),n=!!i&&i.isAvailable&&this.callingSupportService.isIPVideoModeEnabledForCall(e);this.areTogglingIncomingVideoFlagsEnabled&&(n=n&&this.isIncomingVideoOn),n!==this.dominantSpeakerVideoIsAvailable&&(n?i.start({renderer:this.createVirtualRenderer()}).then(function(e){var n=skype.calling.ICallParticipantHelpers.bestAvailableVideoFor(t.dominantSpeaker);n&&n.id==i.id?t.videoRenderer=e:t.disposeRenderer(e)}).catch(function(e){t.logger.error("Failed to start video: "+e)}):this.disposeDominantSpeakerVideo(),this.dominantSpeakerVideoIsAvailable=n,this.sendUpdate(this.monitoredCall))}},a.prototype.createVirtualRenderer=function(){return new o(this.ipc,this.getFrameSink())},a.prototype.disposeDominantSpeakerSubscription=function(){this.dominantSpeakerSubscription&&(this.dominantSpeakerSubscription.dispose(),this.dominantSpeakerSubscription=null),this.disposeDominantSpeakerVideo()},a.prototype.disposeDominantSpeakerVideo=function(){this.videoRenderer&&this.disposeRenderer(this.videoRenderer)},a.prototype.disposeRenderer=function(e){try{e.dispose()}catch(e){this.logger.warn("An error occurred while disposing the video renderer: "+(e&&e.message))}finally{e=null}},a.prototype.updateDominantSpeakerAvatar=function(e,t){var i=this;if(!this.dominantSpeakerVideoIsAvailable){if(t)return this.dominantSpeakerAvatar="emergency",void this.sendUpdate(this.monitoredCall);if(SkypeX.Services.ChatServiceUtils.isPstnMri(e.id)&&this.dominantSpeaker&&this.dominantSpeaker.id===e.id)return this.dominantSpeakerAvatar="pstn",this.avatarBackgroundColor=this.utilityService.pstnBackgroundColorClass(e.id.replace("+","")),void this.sendUpdate(this.monitoredCall);this.peopleService.getPeopleProfile(e.id,"calling-monitor-service").then(function(e){return i.authenticationService.isAnonymous()?i.peopleService.getUserInitialsPicture(e.displayName,i.constants.profilePictureSizes.small,"meetup").then(function(e){return e.replace(i.constants.pictureLoad.mimeJpeg,"")}):i.peopleService.getUserProfilePicture({userId:e.userPrincipalName,displayName:e.displayName,imageUri:e.imageUri},"meetup")}).then(function(t){t?i.dominantSpeaker&&i.dominantSpeaker.id===e.id&&(i.dominantSpeakerAvatar=i.constants.pictureLoad.mimeProgressivejpeg+t,i.sendUpdate(i.monitoredCall)):i.logger.warn("Received empty avatar picture")}).catch(function(e){return i.logger.error("Failed to get user avatar: "+e)})}},a.prototype.onNetworkReconnect=function(e){this.monitoredCall&&this.monitoredCall.teamsCallId===e&&this.isShownInExternalWindow&&this.monitoredCall.isNetworkReconnectOngoing()&&this.onOpen()},a.prototype.onOpen=function(i){if(void 0===i&&(i=t.CallMoreOption.None),this.monitoredCall){var n=this.monitoredCall,o=n.isScreenshareFromChat?{isMultiTasking:!0,rightPanelToOpen:e.components.Calling.RightPanel.CallingChat,callMoreOptionToExecute:i}:{isMultiTasking:!0,callMoreOptionToExecute:i};this.logger.info("[onOpen]- invoked"),this.navigateToCallScreen(n,o,"onOpen")}else this.logger.info("[onOpen]- no monitored call found")},a.prototype.navigateToCallScreen=function(e,t,i){var n=this.isCallFromChildWindow(e);t.isCallJoinedFromChildWindow=n,!n&&this.ipc.send("callScreen:restore"),this.callingNavigationService.navigateToCallScreen(e,t),this.logger.info("[navigateToCallScreen]-"+i+": Navigated to "+(n?"child":"main")+" window"),this.isCallScreenVisible=!0,this.updateCallMonitor(e)},a.prototype.onToggleMic=function(){var e,t=this;if(this.monitoredCall){var i=this.isCallFromChildWindow(this.monitoredCall);this.monitoredCall.isContentOnlyMode&&this.enableConfirmAudioEscalation&&!i&&(this.ipc.send("callScreen:restore"),this.logger.info("[onToggleMic]: Navigated to main window to confirm audio escalation")),this.callTogglingService.toggleMuteAudio(this.monitoredCall,i?3:1,null,(e={},e[this.constants.counters.eventNames.context]=this.constants.scenarios.calling.context.externalCallMonitor,e),!!i).then(function(){t.logger.info("[onToggleMic]: toggleMuteAudio completed, isMuted: "+t.monitoredCall.isMuted+", isServerMuted: "+t.monitoredCall.isServerMuted),t.sendUpdate(t.monitoredCall)})}},a.prototype.onDtmfKeypadClick=function(){this.onMoreOptionClicked(t.CallMoreOption.ShowDtmfKeypad)},a.prototype.onTransferClick=function(){this.onMoreOptionClicked(t.CallMoreOption.StartTransferring)},a.prototype.onConsultationClick=function(){this.onMoreOptionClicked(t.CallMoreOption.StartConsulting)},a.prototype.onHoldClick=function(){this.onMoreOptionClicked(t.CallMoreOption.ToggleHold)},a.prototype.onToggleVideo=function(){var e=this;this.callTogglingService.toggleVideo(this.monitoredCall,this.constants.scenarios.calling.context.externalCallMonitor).then(function(){e.logger.info("[onToggleVideo]: toggleVideo completed, isVideoOn: "+e.monitoredCall.isVideoOn),e.sendUpdate(e.monitoredCall)})},a.prototype.onIncomingVideoValueChanged=function(){this.isIncomingVideoOn=this.callTogglingService.isIncomingVideoOn(this.monitoredCall),this.sendUpdate(this.monitoredCall)},a.prototype.onTogglePresenting=function(){if(this.monitoredCall){var e={isSharingPanelRequested:!this.monitoredCall.isScreenSharingOn,forceCallingScreenReloading:!0};if(this.monitoredCall.isScreenSharingOn){var t=this.constants.scenarios.calling.context.externalCallMonitor;this.monitoredCall.stopScreenSharingOnCall(t),this.logger.info("[onTogglePresenting]- stop screen share, isScreenSharingOn: "+this.monitoredCall.isScreenSharingOn),this.trigger(a.Type_ExternalMonitorStopScreenshare)}this.navigateToCallScreen(this.monitoredCall,e,"onTogglePresenting")}else this.logger.info("[onTogglePresenting]- No call found")},a.prototype.popoutQuestionnaire=function(e){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(i){switch(i.label){case 0:return this.shouldShowCQFFromSSFC&&e&&this.callingMultiWindowService.isModernCallingEnabled()&&this.monitoredCall.isScreenSharingOn?null!=(t=this.monitoredCall.getIntent())&&void 0!==t?[3,2]:[4,this.callingIntentMultiWindowService.saveIntentFromCall(this.monitoredCall)]:[3,3];case 1:t=i.sent(),i.label=2;case 2:t.joinOptions.CQFCallId=this.monitoredCall.callId,this.callingMultiWindowService.deprecated_popoutIntent(t,"end-call-ssfc-cqf"),i.label=3;case 3:return[2]}})})},a.prototype.onEndCall=function(){return __awaiter(this,void 0,void 0,function(){var e,i,n,o=this;return __generator(this,function(a){switch(a.label){case 0:return this.monitoredCall?(e=this.monitoredCall,i=this.isCallFromChildWindow(this.monitoredCall),this.monitoredCall.isScreenshareFromChat&&i?this.callingQualityFeedbackService.isSlimCoreFeedbackAPIEnabled()?(this.callingQualityFeedbackService.retrieveSlimCoreFeedbackInfo(t.FeedbackCallType.ScreenshareFromChat,this.monitoredCall).then(function(e){return __awaiter(o,void 0,void 0,function(){return __generator(this,function(i){switch(i.label){case 0:return e&&this.callingQualityFeedbackService.shouldShowSlimCoreQuestionnaire(e)&&e.experience===t.FeedbackExperienceType.Modal?[4,this.popoutQuestionnaire(!0)]:[3,2];case 1:return i.sent(),[3,3];case 2:return this.callingService.leaveCall(this.monitoredCall,this.constants.scenarios.calling.context.externalCallMonitor),[2];case 3:return[2]}})})}).catch(function(e){o.logger.error("callMonitorService.desktop: Failed to retrieve CQF info: "+e)}),[3,3]):[3,1]:[3,4]):[3,6];case 1:return n=this.callingQualityFeedbackService.checkIfSampledForPostCallCQF(t.FeedbackCallType.ScreenshareFromChat,this.monitoredCall.callId)||this.callingQualityFeedbackService.checkIfSampledForEMF(t.FeedbackCallType.ScreenshareFromChat,this.monitoredCall.callId),[4,this.popoutQuestionnaire(n)];case 2:a.sent(),a.label=3;case 3:return[3,5];case 4:i||this.navigateToCallScreen(this.monitoredCall,{},"onEndCall"),a.label=5;case 5:this.callingService.leaveCall(e,this.constants.scenarios.calling.context.externalCallMonitor),a.label=6;case 6:return[2]}})})},a.prototype.onMinimizeCallMonitor=function(){this.isShownInExternalWindow&&this.canMinimizeExternalCallMonitor&&(this.ipc.send("callScreen:callMonitor:minimize"),this.logger.info("[onMinimizeCM]: sent ipc to minimize"))},a.prototype.onCloseAlert=function(){this.monitoredCall&&this.callingCriticalAlert&&this.callingAlertsService.dismiss(this.callingCriticalAlert)},a.prototype.onAlertAction=function(){this.monitoredCall&&this.callingCriticalAlert&&this.callingCriticalAlert.actions.length>0&&(this.callingCriticalAlert.actions[0].command(),this.callingAlertsService.dismiss(this.callingCriticalAlert))},a.prototype.getLatestCriticalAlertsOnDisplay=function(){var e=this,i=this.callingAlertsService.getAlerts(t.AlertWindowType.ExternalCallMonitor).filter(function(i){return i.type===t.AlertType.Warning||i.type===t.AlertType.Error||_.includes(e.alwaysVisibleAlertNames,i.name)});this.callingCriticalAlert=i.length>0?i[0]:null},a.prototype.getRecordingState=function(e){return e.getRecordingStatus()===t.CallRecordingStatus.recording||e.getVoiceCollectionStatus()===t.CallingVoiceCollectionStatus.started?t.CallRecordingStatus.recording:e.getRecordingStatus()===t.CallRecordingStatus.pending?t.CallRecordingStatus.pending:t.CallRecordingStatus.none},a.prototype.isVideoButtonAvailable=function(t){return!e.services.CallUtilities.isOneToOnePstnCall(t)&&!e.services.CallUtilities.isVoicemailGreetingCall(t)&&!t.isEmergencyCall&&this.callingSupportService.isIPVideoModeEnabledForCall(t)},a.prototype.isShareButtonAvailable=function(i){return!e.services.CallUtilities.isOneToOnePstnCall(i)&&(this.callingSupportService.isTFLRenderer()||!t.CallUtilities.isSkypeConsumerCall(i))&&!e.services.CallUtilities.isVoicemailGreetingCall(i)&&!i.isEmergencyCall&&(i.isScreenSharingOn||i.isActionExecutable(t.MeetingAction.Share))},a.prototype.isAudioButtonAvailable=function(t){return!(t.isEmergencyCall&&t.myRoleInEmergencyCall===e.services.UserRoleInEmergencyCall.Caller)&&this.callingSupportService.isIPAudioModeEnabledForCall(t)},a.prototype.computeCallMonitorDescription=function(e,t,i){return this.$translate.instant(!e.isScreenshareFromChat||t&&i?e.isScreenshareFromChat?this.resources.strings.calling_monitor_screeshareOnly_clickHereToGoBack:this.resources.strings.calling_monitor_clickHereToGoBack:this.resources.strings.calling_monitor_sharingOnly_clickHereToGoBack)},a.prototype.isVideoEnabled=function(e){var t=this.isVideoAvailable(),i=this.callingSupportService.isIPVideoModeEnabledForCall(e),n=this.callingSupportService.isIpVideoAllowedByCapability(e);return t&&i&&n},a.prototype.getState=function(i){this.getLatestCriticalAlertsOnDisplay();var n=this.callingSupportService.isPrivateCallingEnabled,o=this.callTitleService.getMeetupTitleForCall(i),a=this.callLobbyService.isSomeoneInLobby(i.teamsCallId),s=this.getRecordingState(i),r=i.isScreenshareFromChat,c=this.isAudioButtonAvailable(i),l=this.broadcastLivePreviewProvider&&this.broadcastLivePreviewProvider.isPreviewReady()&&!this.dominantSpeaker?this.broadcastLivePreviewProvider.getErrorMessage():this.computeCallMonitorDescription(i,n,c),h=r&&this.$translate.instant(this.resources.strings.calling_monitor_screeshareOnly_microphone_text),p=this.$translate.instant(this.resources.strings.calling_monitor_screenshareOnly_leavebutton_text),d=this.callingSupportService.isIPVideoModeEnabledForCall(i),g={title:this.defaultTitle,subtitle:o,windowTitle:this.defaultWindowTitle,state:i.state,startTime:this.callStartDate&&this.callStartDate.getTime(),isMuted:i.isMuted||this.muteParticipantEnabled&&i.isServerMuted||!this.callingSupportService.isIPAudioModeEnabledForCall(i),isContentOnlyMode:i.isContentOnlyMode,enableConfirmAudioEscalation:this.enableConfirmAudioEscalation,isVideoOn:i.isVideoOn&&d,isVideoButtonAvailable:this.isVideoButtonAvailable(i),isShareButtonAvailable:this.isShareButtonAvailable(i),isAudioButtonAvailable:this.isAudioButtonAvailable(i),isScreenSharingOn:i.isScreenSharingOn,isIncomingVideoOn:this.isIncomingVideoOn&&d,isSomeoneInLobby:a,isRecording:s,isScreenshareFromChat:r,escalateScreensharingCallEnabled:this.escalateScreensharingCallEnabled,isRemoteVideoOn:!(!this.dominantSpeaker||!skype.calling.ICallParticipantHelpers.bestAvailableVideoFor(this.dominantSpeaker)),avatarBackgroundColor:this.avatarBackgroundColor?this.avatarBackgroundColor:null,dominantSpeakerId:this.dominantSpeaker?this.dominantSpeaker.id:null,dominantSpeakerAvatar:this.dominantSpeaker?this.dominantSpeakerAvatar:null,description:l,showQualityIndicator:this.showCallQualityIndicator,showQualityIndicatorTooltip:this.qualityIndicatorTooltipText,isVideoEnabled:this.isVideoEnabled(i),isMicEnabled:this.isMicAvailable&&this.callingSupportService.isIPAudioModeEnabledForCall(i),isScreenSharingEnabled:this.adminSettings.isScreenSharingEnabled,isMinimizeMonitorEnabled:this.canMinimizeExternalCallMonitor,isPptSharingEnabled:this.advancedSettings.isPPTSharingEnabled,isHighContrast:this.isHighContrast,frameSinkName:this.getFrameSinkName(),showMoreBtn:this.showMoreBtn(),moreBtnDropDownVM:this.setMoreBtnDropdownViewModel(),callingFooterAlert:this.callingFooterAlert,callingCriticalAlert:this.callingCriticalAlert,callingButtonsTooltips:this.callingButtonTooltips,alertCloseTooltip:this.alertCloseTooltipText,minimizeTooltip:this.minimizeTooltipText,isBroadcast:this.canRenderBroadcastControl(),enableUnifiedControlBarInCallMonitor:this.enableUnifiedControlBarInCallMonitor,microphoneButtonTitleForScreenshareOnlyCalls:h,leaveButtonTitleForScreenshareOnlyCalls:p,pstnImgTitle:this.$translate.instant(this.resources.strings.icons_person),disableVideoForVDI:this.disableVideoForVDI,blockAVOverIPInMeetings:this.callingSupportService.blockAVOverIPInMeetings(),allowPrivateCalling:n,useMeetingPolicyInScreenSharingFromChat:!!this.useMeetingPolicyInScreenSharingFromChat,useBufferSharing:!!this.useBufferSharing,isMac:this.platformDetectService.getOS()===this.constants.os.mac,isSelfHardMuted:i.isSelfAttendeeRestrictedForModality(t.RestrictableModalities.Audio),isSelfVideoRestricted:i.isSelfAttendeeRestrictedForModality(t.RestrictableModalities.Video),isMicrophoneToggleDisabledForCoMe:this.coordinatedMeetingsService.isMicToggleDisabled(i),isCameraToggleDisabledForCoMe:this.coordinatedMeetingsService.isCameraToggleDisabled(i)};if(g.isBroadcast){var u=this.getBroadcastStatus(i),v=u&&u.toString(),f=e.services.BroadcastUtilities.getBroadcastStatusResourceString(u,this.resources,!0),S=this.$translate.instant(f);g.broadcastInfo={status:v,statusText:S}}return g},a.prototype.getBroadcastStatus=function(e){var t=e&&e.broadcastMeeting&&e.broadcastMeeting.broadcastState;return t&&t.status},a.prototype.getCallingButtonTooltips=function(){return{startVideo:this.$translate.instant(this.resources.strings.calling_startVideo),stopVideo:this.$translate.instant(this.resources.strings.calling_stopVideo),muteMicrophone:this.$translate.instant(this.resources.strings.calling_button_mute),unmuteMicrophone:this.$translate.instant(this.resources.strings.calling_unmute),turnOnAudio:this.$translate.instant(this.resources.strings.calling_confirm_audio_escalation_button_text),moreActions:this.$translate.instant(this.resources.strings.calling_more_actions),stopSharingDesktop:this.$translate.instant(this.resources.strings.calling_stopSharingDesktop),startSharingDesktop:this.$translate.instant(this.resources.strings.calling_startSharingDesktop),hangup:this.$translate.instant(this.resources.strings.calling_hangup),ecalateScreensharingCall:this.$translate.instant(this.resources.strings.calling_screenshare_only_call_escalation_microphone_disabled_external_call_monitor),videoDisabled:this.getVideoDisabledReason(),micDisabled:this.$translate.instant(this.resources.strings.calling_microphone_disabled),sharingDisabled:this.getSharingDisabledReason(),micHardMuted:this.$translate.instant(this.resources.strings.calling_microphone_disabled_by_hard_mute_new),videoRestricted:this.$translate.instant(this.resources.strings.calling_video_restricted_tooltip)}},a.prototype.getVideoDisabledReason=function(){if(this.disableVideoForVDI)return this.$translate.instant(this.resources.strings.calling_video_disabled_while_sharing_screen);var e=this.monitoredCall||this.callingService.getActiveCall(),t=e?this.videoSupportService.getVideoUnavailableReasonString(e.teamsCallType):this.resources.strings.calling_video_disabled_by_admin;return this.$translate.instant(t)},a.prototype.getSharingDisabledReason=function(){return this.monitoredCall&&!this.monitoredCall.isActionExecutable(t.MeetingAction.Share)?this.$translate.instant(this.resources.strings.calling_sharing_not_allowed_tooltip):this.$translate.instant(this.videoSupportService.getScreenSharingUnavailableReasonString())},a.prototype.getFrameSinkName=function(){return this.frameSink&&this.frameSink.getBufferName?this.frameSink.getBufferName():void 0},a.prototype.openWindow=function(e){if(this.log("openWindow"),!this.isShownInExternalWindow){this.dominantSpeaker=null,this.callingButtonTooltips.videoDisabled=this.getVideoDisabledReason(),this.callingButtonTooltips.sharingDisabled=this.getSharingDisabledReason(),e.isScreenshareFromChat&&(this.callingButtonTooltips.hangup=this.escalateScreensharingCallEnabled?this.$translate.instant(this.resources.strings.calling_screensharing_call_escalated_hangup):this.$translate.instant(this.resources.strings.calling_screensharing_call_hangup));var i=this.callMonitorTemplate,n=this.getState(e);this.isShownInExternalWindow=!0,this.trigger(a.Type_ExternalMonitorChanged,null,!1),this.ipc.send("callScreen:callMonitor:open",i,n);var o=this.isCallFromChildWindow(this.monitoredCall);this.shouldMinimizeApp(e)&&!o&&this.ipc.send("callScreen:minimize");var s=this.loggingService.findScenarioByNameAndId(this.constants.scenarios.calling.screenSharingSender,t.TeamsCallService.getTeamsCallIdAsString(e.teamsCallId));s?s.mark(this.constants.scenarios.steps.calling.screenSharing.senderCallMonitorShown):this.loggingService.warn("attempted to set performance mark "+this.constants.scenarios.steps.calling.screenSharing.senderCallMonitorShown+" but could not find scenario")}},a.prototype.shouldMinimizeApp=function(t){return!this.callingSupportService.isCallPoppedOutInMultiWindow(t)&&((!this.settingsService.valueAsBoolean(this.constants.settings.names.enableBetterTogetherExternalCallMonitor)||!t.isInTransportCompanionMode())&&(t.isBroadcast?!t.broadcastMeeting||t.broadcastMeeting.role!==e.services.BroadcastMeeting.constants.role.producer:!t.isScreenshareFromChat))},a.prototype.sendUpdate=function(e){this.isShownInExternalWindow&&this.ipc.send("callScreen:callMonitor:update",this.getState(e))},a.prototype.closeWindow=function(){this.logger.info("[closeWindow]: isShownInExternalWindow: "+this.isShownInExternalWindow),this.isShownInExternalWindow&&(this.isShownInExternalWindow=!1,this.trigger(a.Type_ExternalMonitorChanged,null,!0),this.ipc.send("callScreen:callMonitor:close"))},a.prototype.log=function(e){this.logger.info("CallMonitorService.Desktop."+e+": callId = "+(this.monitoredCall?this.monitoredCall.callId:"no-call")+", isShownInExternalWindow = "+this.isShownInExternalWindow)},a.prototype.onMoreOptionClicked=function(e){this.trigger(a.Type_ExternalMonitorMoreOptionClicked,null,e),e===t.CallMoreOption.ShowDtmfKeypad||this.closeWindow(),this.onOpen(e)},a.prototype.setMoreBtnDropdownViewModel=function(){var e;return e={},e[i.DtmfKeypad]={name:"dtmfKeypad",value:this.$translate.instant(this.resources.strings.calling_open_dtmf_keypad),enabled:this.showDtmfKeypadOption()},e[i.HoldCall]={name:"hold",value:this.$translate.instant(this.resources.strings.calling_hold_call),enabled:this.showHoldOption()},e[i.TransferCall]={name:"transfer",value:this.$translate.instant(this.resources.strings.calling_transfer_call),enabled:this.showTransferOption()},e[i.ConsultThenTransferCall]={name:"consultation",value:this.$translate.instant(this.resources.strings.calling_consultThenTransfer),enabled:this.showConsultationOption()},e},a.prototype.showTransferOption=function(){return!!this.monitoredCall&&(1===this.monitoredCall.teamsCallType&&this.advancedSettings.isCallTransferEnabled)},a.prototype.showConsultationOption=function(){return!1},a.prototype.showDtmfKeypadOption=function(){return!!this.monitoredCall&&(1===this.monitoredCall.teamsCallType&&this.advancedSettings.isDtmfEnabled)},a.prototype.showHoldOption=function(){return!!this.monitoredCall&&(this.callingConversation.isOneToOne()&&this.advancedSettings.isHoldResumeEnabled)},a.prototype.showMoreBtn=function(){return!this.isCallFromChildWindow(this.monitoredCall)&&!this.monitoredCall.isScreenshareFromChat&&(this.showTransferOption()||this.showConsultationOption()||this.showDtmfKeypadOption()||this.showHoldOption())},a.Type_ExternalMonitorChanged="call-external-monitor-changed",a.Type_ExternalMonitorMoreOptionClicked="call-external-monitor-more-option-clicked",a.Type_ExternalMonitorStopScreenshare="call-external-monitor-stop-screenshare",a}(SkypeX.Services.ObservableBase);t.CallMonitorServiceElectronImplementation=a,angular.module("teamspace.callMonitorService",["teamspace.constants","teamspace.callingAgentsService","teamspace.callingService","teamspace.callingNavigationService","teamspace.callTitleService","teamspace.conversationsService","teamspace.peopleService","skypeX.sxConfig","teamspace.deviceManagerService","teamspace.callTogglingService","teamspace.settingsService","teamspace.callingAlertsService","teamspace.callLobbyService","teamspace.callingDurationService","teamspace.utilityService","teamspace.desktopUtilityService","teamspace.authenticationService","skypeX.conversationsStore","teamspace.videoSupportService","teamspace.orchestrationService","teamspace.callingMultiWindowService","teamspace.callingIntentMultiWindowService","teamspace.callingQualityFeedbackService","teamspace.platformDetectService"]).service("callMonitorService",a)}(e.services||(e.services={}))}(teamspace||(teamspace={}));var teamspace;!function(e){!function(e){e.ringAudioPath="[[staticsPath]]/hashed/audio/ring-b1268ee.mp3";var t=function(){function t(t,i,n,o,a,s){this.$rootScope=t,this.constants=i,this.$q=n,this.loggingService=o,this.meetingRoomUbarService=a,this.audioService=s,this.logger=o.newLogger("MeetingRoomRingingService"),this.incomingCallAudio=s.getAudioElement(e.ringAudioPath),this.incomingCallAudio.loop=!0}return t.$inject=["$rootScope","constants","$q","loggingService","meetingRoomUbarService","audioService"],t.prototype.init=function(){return this.$q.when(this.initHandler())},t.prototype.initHandler=function(){this.meetingRoomUbarService.isInCallHybridMode&&(this.$rootScope.$on(this.constants.events.rigel.call.eventTypes.callCreated,this.onCreatedCall.bind(this)),this.$rootScope.$on(this.constants.events.rigel.service.eventTypes.teamsCallState,this.onTeamsCallStateChanged.bind(this)))},t.prototype.onCreatedCall=function(e,t){var i=this;this.callSubscription&&this.callSubscription.dispose(),t&&(this.callSubscription=t.on("callStateChanged",function(){return i.onCallStateChanged(t)}),this.onCallStateChanged(t))},t.prototype.onCallStateChanged=function(e){var t=this.currentCallState;this.currentCallState=null===e||void 0===e?void 0:e.state,1===t&&1!==this.currentCallState&&(this.stopIncomingRing(),this.callSubscription.dispose(),this.callSubscription=void 0)},t.prototype.onTeamsCallStateChanged=function(t,i){i==e.TeamsCallState.InACall&&1===this.currentCallState&&this.playIncomingRing()},t.prototype.playIncomingRing=function(){var e=this;this.incomingAudioPlayDeferred=this.$q.defer(),this.incomingCallAudio.currentTime=0,this.incomingCallAudio.play().then(function(){e.logger.info("Ring.play() fully initialized"),e.incomingAudioPlayDeferred.resolve()}).catch(function(t){e.logger.error("Failed to play audio: "+t)})},t.prototype.stopIncomingRing=function(){var e=this;this.incomingAudioPlayDeferred&&!this.incomingCallAudio.paused?this.incomingAudioPlayDeferred.promise.then(function(){e.logger.info("Calling ring.pause()"),e.incomingCallAudio.pause()}).catch(function(t){e.logger.error("Failed to pause playing audio: "+t)}):this.logger.info("incomingAudioPlayDeferred never got initialized.")},t}();e.MeetingRoomRingingServiceImplementation=t,angular.module("teamspace.meetingRoomRingingService",["teamspace.constants","teamspace.loggingService","teamspace.meetingRoomUbarService"]).service("meetingRoomRingingService",t)}(e.services||(e.services={}))}(teamspace||(teamspace={}));var __extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),teamspace;!function(e){!function(e){var t=function(e){function t(t,i,n,o,a,s,r,c,l){return e.call(this,{isInHybridConsoleMode:function(){return n.valueFor(t.settings.names.rigel).enableHybridRigelConsoleApp&&n.valueFor(t.settings.names.rigel).supportedHybridStates.callingScreen}},o,teams.calling.helpers.services.eventing(l),a,s,r,c,teams.calling.helpers.toNgPromiseFactory(i))||this}return __extends(t,e),t.$inject=["constants","$q","settingsService","loggingService","cortanaLoaderService","cortanaEventingService","deviceManagerService","cortanaRigelConfigurationService","eventingService"],t}(teams.calling.MeetingRoomUbarServiceBase);e.MeetingRoomUbarServiceImplementation=t,angular.module("teamspace.meetingRoomUbarService",["teamspace.constants","teamspace.loggingService","teamspace.settingsService","teamspace.cortanaLoaderService","teamspace.cortanaEventingService","teamspace.cortanaRigelConfigurationService","teamspace.eventingService"]).service("meetingRoomUbarService",t)}(e.services||(e.services={}))}(teamspace||(teamspace={}));var __extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),__awaiter=this&&this.__awaiter||function(e,t,i,n){function o(e){return e instanceof i?e:new i(function(t){t(e)})}return new(i||(i=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){e.done?i(e.value):o(e.value).then(s,r)}c((n=n.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){function i(e){return function(t){return n([e,t])}}function n(i){if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,a&&(s=2&i[0]?a.return:i[0]?a.throw||((s=a.return)&&s.call(a),0):a.next)&&!(s=s.call(a,i[1])).done)return s;switch(a=0,s&&(i=[2&i[0],s.value]),i[0]){case 0:case 1:s=i;break;case 4:return c.label++,{value:i[1],done:!1};case 5:c.label++,a=i[1],i=[0];continue;case 7:i=c.ops.pop(),c.trys.pop();continue;default:if(s=c.trys,!(s=s.length>0&&s[s.length-1])&&(6===i[0]||2===i[0])){c=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){c.label=i[1];break}if(6===i[0]&&c.label<s[1]){c.label=s[1],s=i;break}if(s&&c.label<s[2]){c.label=s[2],c.ops.push(i);break}s[2]&&c.ops.pop(),c.trys.pop();continue}i=t.call(e,c)}catch(e){i=[6,e],a=0}finally{o=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var o,a,s,r,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return r={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r},teamspace;!function(e){!function(t){var i=function(i){function n(e,n,o,a,s,r,c,l,h,p,d,g,u){var v=i.call(this)||this;return v.loggingService=e,v.$q=n,v.$rootScope=o,v.eventingService=a,v.constants=s,v.settingsService=r,v.rigelServiceHandler=c,v.rigelNavigationService=l,v.callingQualityFeedbackService=h,v.callRingingService=p,v.callTogglingService=d,v.meetingPolicySettingsStore=g,v.$window=u,v.teamsState=t.TeamsCallState.Idle,v.autoExitingMeeting=!1,v.defaultCallDisposedTimeOut=3e3,v.logger=e.newLogger("RigelCallHandler"),v.rigelSettings=r.valueFor(s.settings.names.rigel),v.callDisposedTimer=null,v.callDisposedTimeOut=v.rigelSettings.callDisposedTimeout?v.rigelSettings.callDisposedTimeout:v.defaultCallDisposedTimeOut,v}return __extends(n,i),n.$inject=["loggingService","$q","$rootScope","eventingService","constants","settingsService","rigelServiceHandler","rigelNavigationService","callingQualityFeedbackService","callRingingService","callTogglingService","meetingPolicySettingsStore","$window"],n.prototype.init=function(){return this.$q.when(this.initHandler())},n.prototype.initHandler=function(){var e=this;this.ipc=this.$window.electronSafeIpc,this.rigelServiceHandler.appReadyPromise.then(function(){e.eventingService.$on(e.$rootScope,e.constants.events.calling.callCreated,e.monitor.bind(e)),e.eventingService.$on(e.$rootScope,e.constants.events.calling.callDisposed,e.callDisposed.bind(e)),e.eventingService.$on(e.$rootScope,e.constants.events.rigel.service.eventTypes.autoExitMeetingUserActionEvent,function(t,i){return e.shouldAutoExitMeeting(i)}),e.eventingService.$on(e.$rootScope,e.constants.events.calling.callEscalated,e.onCallEscalated.bind(e)),e.$rootScope.$on(e.constants.events.rigel.service.eventTypes.toggleWhiteboardCamera,e.toggleWhiteboardCamera.bind(e))})},n.prototype.callDisposed=function(e,t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this.onCallDisposed(t)];case 1:return e.sent(),[2]}})})},n.prototype.getCurrentTeamsState=function(){return this.teamsState},n.prototype.monitor=function(e,i){var n=this;i&&([6,7].includes(i.state)?this.logger.error("Received call created callId="+i.callId+" with state="+t.CallUtilities.stringifyCallState(i.state)+". Will not monitor."):(this.logger.info("New call created callId="+i.callId),this.monitoredCall&&i.callId===this.monitoredCall.callId||(this.monitoredCall&&![7,0].includes(this.monitoredCall.state)?(this.logger.info("Rejecting newly created call since there is already a monitored call\n            in state="+t.CallUtilities.stringifyCallState(this.monitoredCall.state)),this.rejectCall(i,this.constants.scenarios.calling.reasons.autoRejectInATeamsMeeting)):this.monitoredCall&&7===this.monitoredCall.state&&this.callDisposedTimer?(this.logger.info("Rejecting newly created call while call is disposing and in state="+t.CallUtilities.stringifyCallState(this.monitoredCall.state)),this.rejectCall(i,this.constants.scenarios.calling.reasons.autoRejectInACallDisposing)):this.teamsState===t.TeamsCallState.PostCall?(this.logger.info("Rejecting newly created call due to post call now"),this.rejectCall(i,this.constants.scenarios.calling.reasons.autoRejectInAPostCall)):(this.monitoredCallSubscription&&this.monitoredCallSubscription.dispose(),this.logger.info("reset call disposed timer"),this.callDisposedTimer=null,this.callDisposedScenario=null,this.webLogDownloadDefer=this.$q.defer(),this.monitoredCallSubscription=i.on("callStateChanged",function(){return n.onCallStateChanged(i)}),this.monitoredCall=i,this.onCallStateChanged(i)))))},n.prototype.getWebLogDownloadDeferred=function(){return this.webLogDownloadDefer},n.prototype.onCallStateChanged=function(e){var i=this;switch(this.logger.info("onCallStateChanged to call.state:"+t.CallUtilities.stringifyCallState(e.state)),_.includes([6,7],e.state)||this.checkIfVideoAllowed(),e.state){case 2:this.updateTeamsState(t.TeamsCallState.InACall,"onCallStateChanged",e);break;case 7:null===this.callDisposedTimer&&null!==this.monitoredCall&&(this.logger.info("registering call disposed timer and timeout = "+this.callDisposedTimeOut),this.createCallDisposedScenario(),this.callDisposedScenario.mark("timer_start"),this.callDisposedTimer=setTimeout(function(){return __awaiter(i,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.onCallDisposed(e)];case 1:return[2,t.sent()]}})})},this.callDisposedTimeOut));break;case 1:this.onCallStateNotified(e)}},n.prototype.createCallDisposedScenario=function(){null===this.callDisposedScenario&&(this.callDisposedScenario=this.loggingService.newScenario(this.constants.events.rigel.service.scenarios.callDisposed,null,null,this.callDisposedTimeOut+2e3))},n.prototype.updateTeamsState=function(e,i,n){if(void 0===n&&(n=null),this.teamsState!==e){(e===t.TeamsCallState.InACall&&this.teamsState!=t.TeamsCallState.Incoming||e===t.TeamsCallState.Incoming)&&this.$rootScope.$broadcast(this.constants.events.rigel.call.eventTypes.callCreated,n);var o=this.teamsState;this.teamsState=e,this.rigelServiceHandler.updateTeamsCallState(this.teamsState,i),this.logger.info("TeamsCallState updated: "+t.TeamsCallState[o]+" ("+o+") ---\x3e "+t.TeamsCallState[e]+" ("+e+"), reason: "+i)}},n.prototype.sendMeetingLockedError=function(){this.monitoredCall.isMeetingLocked()&&(this.logger.warn("Join meeting failed. The meeting is locked, No one else can join."),this.ipc.send(this.constants.events.rigel.service.callback,{type:this.constants.events.rigel.service.eventTypes.joinMeetupFailure,data:t.RigelNavigationServiceErrorCode.MeetingIsLocked}))},n.prototype.onCallDisposed=function(e){return __awaiter(this,void 0,void 0,function(){var i,n,o;return __generator(this,function(a){switch(a.label){case 0:return this.monitoredCall?(this.sendMeetingLockedError(),this.logger.info("onCallDisposed called, this.monitoredCall.callId = "+this.monitoredCall.callId+", call.callId = "+e.callId),this.monitoredCall.callId!==e.callId?(this.logger.error("call disposed event with different call id"),[2]):(7!==e.state||e.setupArgs.isProbeCall||this.callRingingService.playCallDisconnectedAudio(),this.callDisposedTimer&&(this.logger.info("clearing callDisposedTimer"),clearTimeout(this.callDisposedTimer),this.callDisposedTimer=null),this.monitoredCallSubscription&&(this.monitoredCallSubscription.dispose(),this.monitoredCallSubscription=null),this.monitoredCall=null,e.terminatedReason&&59===e.terminatedReason&&this.rigelServiceHandler.sendMeetingIsFull(),this.createCallDisposedScenario(),this.callDisposedScenario.stop(),!this.rigelSettings.enableCQF||this.teamsState!==t.TeamsCallState.InACall||this.autoExitingMeeting?[3,2]:(this.logger.info("try to get questionnaire by call id = "+e.callId),i=this.loggingService.newScenario(this.constants.events.rigel.service.scenarios.getQuestionnaireForCqf),[4,this.callingQualityFeedbackService.getQuestionnaire(e.callId)]))):(this.logger.info("monitoredCall is null"),[2]);case 1:if(n=a.sent())switch(i.stop(),n.type){case t.FeedbackType.Quality:return this.logger.info("navigate to post call page"),this.updateTeamsState(t.TeamsCallState.PostCall,"onCallStateDisconnected"),this.webLogDownloadDefer.resolve(),this.rigelNavigationService.navigateToPostCallPage(e.callId),[2];case t.FeedbackType.ShortDurationHangup:this.logger.info("CQF enabled, but its too short to show CQF"),(o=this.loggingService.newScenario(this.constants.events.rigel.service.scenarios.callingQualityFeedbackShortDuration)).stop();break;default:this.logger.warn("unhandled feedback type and navigate to default = "+n.type)}else i.fail(),this.logger.error("cant get questionnaire");a.label=2;case 2:return this.logger.info("update teams call state idle"),this.updateTeamsState(t.TeamsCallState.Idle,"onCallStateDisconnected"),this.autoExitingMeeting=!1,this.webLogDownloadDefer.reject(),[2]}})})},n.prototype.onCallStateNotified=function(e){if(this.rigelServiceHandler.sfbState===t.SfBState.Idle){var i=this.settingsService.valueFor(this.constants.settings.names.rigel);i.enableIncomingCall&&2===e.teamsCallType||i.enableIncomingP2P&&1===e.teamsCallType?(this.$rootScope.$broadcast(this.constants.events.rigel.call.eventTypes.attemptAutoJoin,e),this.updateTeamsState(t.TeamsCallState.Incoming,"onCallStateNotified",e)):this.logger.info("Incoming call of type "+e.teamsCallType+" is not enabled on this build.")}else this.logger.info("Will reject incoming because SfB is already in a call."),this.rejectCall(e,this.constants.scenarios.calling.reasons.autoRejectInAnSfbMeeting)},n.prototype.rejectCall=function(e,i){e.reject();var n=t.TeamsCallService.getTeamsCallIdAsString(e.teamsCallId),o=this.loggingService.findScenarioByNameAndId(this.constants.scenarios.calling.incomingCall,n)||this.loggingService.findScenarioByNameAndId(this.constants.scenarios.calling.incomingPstnCall,n)||this.loggingService.findScenarioByNameAndId(this.constants.scenarios.calling.incomingInteropCall,n);o&&o.cancel({reason:i})},n.prototype.shouldAutoExitMeeting=function(t){this.autoExitingMeeting=t===e.services.RigelAutoExitMeetingUserAction.Leave},n.prototype.onCallEscalated=function(e,t){var i=this;this.logger.info("Escalating Event Recieved. Call is escalated and navigating to Console State."),this.logger.info("Escalated Call ID="+t.teamsCallId+" Conversation ID="+t.conversationId),t.getMeetingDetails().then(function(e){i.logger.info("Meeting details available after call escalated"),_.includes([6,7],t.state)||i.checkIfVideoAllowed()}).catch(function(){i.logger.error("Failed in getting meeting details for call: "+t.callId)});var n=this.loggingService.newScenario(this.constants.events.rigel.service.scenarios.callEscalated);this.rigelNavigationService.navigateToRigelConsoleStateWithEscalatedCall(t).then(function(){return n.stop()}).catch(function(){n.fail()})},n.prototype.toggleWhiteboardCamera=function(){this.rigelSettings.enableWhiteboardCameraButton&&this.monitoredCall&&3==this.monitoredCall.state?this.callTogglingService.toggleVideoSharing(this.monitoredCall,"rigelCallHandler_LogitechScribe"):this.monitoredCall?this.logger.info("Failed to toggle video sharing, enableWhiteboardCameraButton = "+this.rigelSettings.enableWhiteboardCameraButton+", call state = "+this.monitoredCall.state+", isScreenSharingOn = "+this.monitoredCall.isScreenSharingOn+"}"):this.logger.info("Failed to toggle video sharing, enableWhiteboardCameraButton = "+this.rigelSettings.enableWhiteboardCameraButton)},n.prototype.checkIfVideoAllowed=function(){!this.isVideoAllowed()&&this.monitoredCall.isVideoOn&&(this.logger.info("Toggling video to off because video is disabled by policy"),this.callTogglingService.toggleVideo(this.monitoredCall,this.constants.scenarios.calling.context.rigelConsoleScreen))},n.prototype.isVideoAllowed=function(){var e=!0;return e=!!this.meetingPolicySettingsStore.getSettingValue(SkypeX.Services.MeetingPolicySettingsStorageKey.allowIPVideo),this.logger.info("Local allowIPVideo meeting policy: "+e),this.monitoredCall&&(this.logger.info("Current call state is: "+this.monitoredCall.state),10!==this.monitoredCall.state&&this.monitoredCall.meetingDetails&&this.monitoredCall.meetingDetails.meetingCapability&&!this.monitoredCall.meetingDetails.meetingCapability.allowIPVideo&&(this.logger.info("AllowIPVideo is false for meeting organizer"),e=!1),this.monitoredCall.isEmergencyCall&&(this.logger.info("Video not allowed for emergency call"),e=!1)),e},n}(SkypeX.Services.ObservableBase);t.RigelCallHandlerImplementation=i,angular.module("teamspace.rigelCallHandler",["teamspace.constants","teamspace.loggingService","teamspace.settingsService","teamspace.eventingService","teamspace.rigelServiceHandler","teamspace.rigelNavigationService","teamspace.callingQualityFeedbackService"]).service("rigelCallHandler",i)}(e.services||(e.services={}))}(teamspace||(teamspace={}));var __extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),teamspace;!function(e){!function(e){var t=function(t){function i(i,n,o,a,s,r,c,l,h,p,d,g,u,v,f,S,m,y,C,b,T,k,w,_,N,I,A,M){return t.call(this,{rigel:function(){return p.valueFor(a.settings.names.rigel)},enableCameraSharing:function(){return p.valueAsBoolean(a.settings.names.enableCameraSharing)},getActiveTheme:function(){return p.getActiveTheme()}},{alerts:{rigelAlertRoomCapacity:{text:function(){return h.instant(v.strings.rigel_calling_body_alertRoomCapacity)},title:function(){return h.instant(v.strings.rigel_calling_title_alertRoomCapacity)}},rigelLocalSharingOnly:{text:function(){return h.instant(v.strings.calling_error_rigel_local_sharing_only_title)},title:function(){return h.instant(v.strings.calling_error_rigel_local_sharing_only_description)}}}},{loadRigelAutoExitMeetingManager:function(t,o){return new e.RigelAutoExitMeetingManager(t,i,l,n,I,N,w,a,_,c,o,s,p)}},o,s,r,teams.calling.helpers.services.eventing(c),teams.calling.helpers.services.eventing(c,function(e,t){return c.$on(l,e,function(e,i){return t(i)})}),teams.calling.helpers.services.eventing(c,function(e,t){return l.$on(e,function(e,i){return t(i)})}),d,g,u,f,S,m,{brbV2FeedbackService:null,broadcastService:null,callingAlertsService:null,callingMultiWindowService:null,callingParticipantService:null,callingUserActionService:null,callParkService:null,callTogglingService:null,callTransferService:null,coordinatedMeetingsService:null,emergencyService:null,transportAgentService:null,callingEchoBotCallService:null,breakoutRoomService:null,teamsAdminSettingsService:null,callMergeService:null,lockMeetingsService:null,broadcastJoinService:null,interprocessStore:null,rigelCallHandler:null,proximityValidationService:null,rigelServiceHandler:function(){return b}},function(){return y},T,k,A,M,teams.calling.helpers.services.mtmaSubscriptionUtility(),teams.calling.helpers.services.observableFactory(),{rigelContentCameraSharingChanged:function(e){return l.$broadcast(a.events.rigel.service.eventTypes.contentCameraSharingChanged,e)},openDialog:function(e,t){return _.open(e,t)},downloadDiagnostics:function(){return C.download()}},teams.calling.helpers.toNgPromiseFactory(i))||this}return __extends(i,t),i.$inject=["$q","$timeout","callingAgentsService","constants","loggingService","peopleService","eventingService","$rootScope","$translate","settingsService","pushDataEventDispatcher","windowSyncDataService","sxConfig","resources","callingAlertsService","utilityService","callingTelemetryService","$window","diagnosticsActionService","rigelServiceHandler","callingMultiWindowService","deviceManagerService","callingParticipantService","dialogService","callingService","calendarService","callingIntentMultiWindowService","msGraphRestClient"],i.prototype.propagate=function(e,t,i){return this.asObservable.propagate(e,t,i)},i.prototype.safeSubscribe=function(e,t,i,n){return this.asObservable.safeSubscribe(e,t,i,n)},i.prototype.subscribe=function(e,t,i){return this.asObservable.subscribe(e,t,i)},i.prototype.unsubscribe=function(e){return this.asObservable.unsubscribe(e)},i}(teams.calling.RigelCallScreenServiceBase);e.RigelCallScreenServiceImplementation=t,angular.module("teamspace.rigelCallScreenService",["teamspace.constants","teamspace.callingAgentsService","teamspace.peopleService","teamspace.callingAlertsService","teamspace.utilityService","teamspace.callingTelemetryService","teamspace.diagnosticsActionService","skypeX.sxConfig","teamspace.callingMultiWindowService","teamspace.deviceManagerService","teamspace.dialogService","teamspace.callingIntentMultiWindowService","teamspace.msGraphRestClient"]).service("rigelCallScreenService",t)}(e.services||(e.services={}))}(teamspace||(teamspace={}));var __extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),teamspace;!function(e){!function(e){var t=function(e){function t(t,i,n,o,a,s){return e.call(this,{enableDefaultCamera:function(){return n.valueFor(t.settings.names.rigel).enableDefaultCamera}},teams.calling.helpers.services.eventing(o),a,s,teams.calling.helpers.toNgPromiseFactory(i))||this}return __extends(t,e),t.$inject=["constants","$q","settingsService","eventingService","loggingService","deviceManagerService"],t}(teams.calling.RigelDeviceManagerService);e.RigelDeviceManagerServiceImplementation=t,angular.module("teamspace.rigelDeviceManagerService",["teamspace.constants","teamspace.loggingService","teamspace.settingsService","teamspace.eventingService","teamspace.deviceManagerService"]).service("rigelDeviceManagerService",t)}(e.services||(e.services={}))}(teamspace||(teamspace={}));var __extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),__awaiter=this&&this.__awaiter||function(e,t,i,n){function o(e){return e instanceof i?e:new i(function(t){t(e)})}return new(i||(i=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){e.done?i(e.value):o(e.value).then(s,r)}c((n=n.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){function i(e){return function(t){return n([e,t])}}function n(i){if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,a&&(s=2&i[0]?a.return:i[0]?a.throw||((s=a.return)&&s.call(a),0):a.next)&&!(s=s.call(a,i[1])).done)return s;switch(a=0,s&&(i=[2&i[0],s.value]),i[0]){case 0:case 1:s=i;break;case 4:return c.label++,{value:i[1],done:!1};case 5:c.label++,a=i[1],i=[0];continue;case 7:i=c.ops.pop(),c.trys.pop();continue;default:if(s=c.trys,!(s=s.length>0&&s[s.length-1])&&(6===i[0]||2===i[0])){c=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){c.label=i[1];break}if(6===i[0]&&c.label<s[1]){c.label=s[1],s=i;break}if(s&&c.label<s[2]){c.label=s[2],c.ops.push(i);break}s[2]&&c.ops.pop(),c.trys.pop();continue}i=t.call(e,c)}catch(e){i=[6,e],a=0}finally{o=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var o,a,s,r,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return r={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r},teamspace;!function(e){!function(t){var i=function(i){function n(e,t,n,o,a,s,r,c,l,h,p,d,g){var u=i.call(this)||this;return u.$state=e,u.$q=t,u.callingIntentMultiWindowService=n,u.callingService=o,u.constants=a,u.loggingService=s,u.callingUserActionService=r,u.$rootScope=c,u.utilityService=l,u.orchestrationRegistrationService=h,u.broadcastMeetingService=p,u.settingsService=d,u.meetingPolicySettingsStore=g,u.logger=s.newLogger("RigelNavigationService"),u}return __extends(n,i),n.$inject=["$state","$q","callingIntentMultiWindowService","callingService","constants","loggingService","callingUserActionService","$rootScope","utilityService","orchestrationRegistrationService","broadcastMeetingService","settingsService","meetingPolicySettingsStore"],n.getErrorDetails=function(e,t){var i="An error occurred in RigelNavigationService",n=t;return e&&(i=e.hasOwnProperty("message")?e.message:e,e.hasOwnProperty("code")&&(n=e.code)),{errMessage:i,errCode:n}},n.prototype.init=function(){this.initHandler()},n.prototype.navigateToRigelConsoleStateWithDeeplink=function(i,o){var a,s=this;this.logger.info("Navigate to rigel console with deeplink");try{o.mark("start_navigate_to_rigel");var r=this.utilityService.parseUrl(i),c=this.orchestrationRegistrationService.getEntityReferenceFromUrl(r);if(!c)return o.mark("not_retrieve_entity_url"),this.logger.warn("Could not retrieve entity reference for a given URL"),this.$q.reject({message:"Could not retrieve entity reference for a given URL",code:t.RigelNavigationServiceErrorCode.UnableToRetrieveEntityUrl});var l=c.context||{};l.DeeplinkId=c.deeplinkId,l.WithVideo=this.isVideoAllowed()?"true":"false";var h=this.settingsService.valueFor(this.constants.settings.names.rigel);if(o.mark("before_call_navigateToRigelConsoleState"),l.IsBroadcastMeeting){var p=this.utilityService.generateUUID();o.mark("before_broadcast_get_attendee_meeting",(a={},a[this.constants.scenarioDataPropNames.broadcastData]=JSON.stringify({joinId:p}),a));var d=this.broadcastMeetingService.getAttendeeMeetingUsingIds(l.Tid,l.Oid,c.containerId,"0",p);return e.services.SfBInteropUtilsService.toIPromise(this.$q,d).then(function(i){var n,a;if(h.blockBroadcastByoeMeeting){var r=i.streamResource;if(r){g={joinId:p,isByoe:r};return o.mark("broadcast_scenario_not_supported",(n={},n[s.constants.scenarioDataPropNames.broadcastData]=JSON.stringify(g),n)),s.logger.error("[resolveUrl] broadcast scenario not supported, broadcastData: "+JSON.stringify(g)),s.$q.reject({message:"This broadcast scenario is not supported",code:t.RigelNavigationServiceErrorCode.CannotJoinByoeBroadcastMeeting})}}var d=i.userRole.toLowerCase();if(d!==e.services.BroadcastMeeting.constants.role.contributor&&d!==e.services.BroadcastMeeting.constants.role.producer){var g={joinId:p,userRole:d};return o.mark("broadcast_attendee_join_not_supported",(a={},a[s.constants.scenarioDataPropNames.broadcastData]=JSON.stringify(g),a)),s.logger.error("[resolveUrl] cannot join broadcast as attendee, broadcastData: "+JSON.stringify(g)),s.$q.reject({message:"Attendee joining broadcast not supported",code:t.RigelNavigationServiceErrorCode.CannotJoinBroadcastAsAttendee})}return l.isBroadcast=!0,l.userRole=d,s.startOrJoinCallWithDeeplinkContext(o,c.containerId,l,c.itemId)}).catch(function(e){o.mark("broadcast_get_attendee_meeting_failed");var i=n.getErrorDetails(e,t.RigelNavigationServiceErrorCode.ErrorFetchingAttendeeMeeting),a=i.errMessage,r=i.errCode;return s.logger.error("[resolveUrl] getAttendeeMeetingUsingIds failed to an error: "+a),s.$q.reject({message:"An error occured while fetching attendee meeting: "+a,code:r})})}return this.startOrJoinCallWithDeeplinkContext(o,c.containerId,l,c.itemId)}catch(e){o.mark("url_not_resolved");var g=n.getErrorDetails(e,t.RigelNavigationServiceErrorCode.ErrorResolvingMeetingUrl),u=g.errMessage,v=g.errCode;return this.logger.error("[resolveUrl] Provided URL could not be resolved due to an error: "+u),this.$q.reject({message:"An error occured when parsing requested meeting URL: "+u,code:v})}},n.prototype.startOrJoinCallWithDeeplinkContext=function(e,i,o,a){var s=this,r=this.getCallParams(a,i,void 0,o);return this.getCallingIntentWitParams(r).then(function(i){return e.mark("starting_call_with_intent"),s.logger.info("Starting call with callingIntentId: "+i.id),s.callingUserActionService.startOrJoinCallFromIntent(i).then(function(t){return e.mark("call-started"),s.logger.info("Call started with callingIntentId: "+i.id+", callId: "+t.callId),s.navigateToConsoleScreenWithCall(t,e)}).catch(function(i){e.fail({reason:"callStartPromise",errorMessage:i});var o=n.getErrorDetails(i,t.RigelNavigationServiceErrorCode.GenericError),a=o.errMessage,r=o.errCode;return s.logger.error("[startOrJoinCallWithDeeplinkContext] Could not start call: "+a),s.$q.reject({message:"An error occured when starting or joining the call: "+a,code:r})})})},n.prototype.navigateToConsoleScreenWithCall=function(e,t){return this.logger.info("Navigating to rigel console with call"),t.mark("Navigating to rigel console with call"),this.navigateToRigelConsoleInternal(e.conversationId,e.teamsCallId,e.messageId,{scenarioName:t.name,scenarioId:t.clientId})},n.prototype.navigateToCortanaPage=function(){var e={location:"replace",inherit:!1,reload:!1};this.logger.info("Navigating to rigel Cortana"),this.$state.go(this.constants.states.rigelConsoleCortana,{},e)},n.prototype.navigateToPreCallPage=function(e,t){var i={location:"replace",inherit:!1,reload:!1};this.logger.info("Navigating to rigel pre-call screen with isPstnCall:"+e+", showVMRButton:"+t),this.$state.go(this.constants.states.rigelConsolePreCall,{isPstnCall:e,showVMRButton:t},i)},n.prototype.navigateToPostCallPage=function(e){var t={location:"replace",inherit:!1,reload:!1};this.logger.info("Navigating to rigel post-call screen with callId: "+e),this.$state.go(this.constants.states.rigelConsolePostCall,{callId:e},t)},n.prototype.navigateToJoinByCode=function(){var e={location:"replace",inherit:!1,reload:!1};this.logger.info("Navigating to rigel join by meeting code screen"),this.$state.go(this.constants.states.rigelConsoleJoinbyCode,{},e)},n.prototype.initHandler=function(){this.$rootScope.$on(this.constants.events.rigel.call.eventTypes.incomingCall,this.navigateToRigelConsoleStateWithIncomingCall.bind(this)),this.$rootScope.$on(this.constants.events.rigel.call.eventTypes.callReadyToNavigate,this.navigateToRigelConsole.bind(this))},n.prototype.navigateToRigelConsole=function(e,t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return this.logger.info("Navigate to rigel console from callReadyToNavigate event"),[4,this.getCallingIntentWithTeamsCallId(t.teamsCallId)];case 1:return"DeepLink"!==(e=i.sent()).joinOptions.context?[2,this.navigateToRigelConsoleInternal(t.conversationId,t.teamsCallId,t.messageId)]:(this.logger.info("Navigation from callReadyToNavigateEvent blocked because context is "+e.joinOptions.context),[2])}})})},n.prototype.navigateToRigelConsoleStateWithIncomingCall=function(e,t){this.logger.info("Navigate to rigel console with incoming call");var i=this.loggingService.newScenario(this.constants.events.rigel.service.scenarios.joinMeetingIncoming);return this.navigateToConsoleScreenWithCall(t,i)},n.prototype.navigateToRigelConsoleStateWithEscalatedCall=function(e){this.logger.info("Navigate to rigel console with escalated call");var t=this.loggingService.newScenario(this.constants.events.rigel.service.scenarios.callEscalated);return this.navigateToConsoleScreenWithCall(e,t)},n.prototype.isVideoAllowed=function(){var e=!!this.meetingPolicySettingsStore.getSettingValue(SkypeX.Services.MeetingPolicySettingsStorageKey.allowIPVideo);return this.logger.info("allowIPVideo="+e),e},n.prototype.navigateToRigelConsoleInternal=function(i,o,a,s){var r=this,c={location:"replace",inherit:!1,reload:!1};this.logger.info("Calling state transition from "+this.$state.current.name+" to "+this.constants.states.rigelConsole);var l=this.getCallParams(a,i,o,s),h=this.getCallingIntentWithTeamsCallId(o);return e.services.SfBInteropUtilsService.toIPromise(this.$q,h).then(function(e){l.callingIntentId=e.id;var i=r.constants.states.rigelConsole;return r.logger.info("Starting Angular navigation callingIntentId: "+e.id),r.$state.go(i,l,c).catch(function(e){var o=n.getErrorDetails(e,t.RigelNavigationServiceErrorCode.GenericError).errMessage;if(!o||-1===o.indexOf("transition prevented")||!t.getSupportedRigelHybridEntity(i,l,r.constants,r.settingsService))throw r.logger.error("Error Navigating to console "+o),e})})},n.prototype.getCallParams=function(e,t,i,n){return{isMultiTasking:!1,isSharingPanelRequested:!1,messageId:e,notify:!1,reload:!1,conversationId:t,isMeetupCreation:!1,navCtx:"rigel-service",deepLinkContext:n,teamsCallId:i,callingIntentId:null}},n.prototype.getCallingIntentWithTeamsCallId=function(e){var t=this.callingService.getCallByTeamsCallId(e,!0);return this.callingIntentMultiWindowService.saveIntentFromCall(t)},n.prototype.getCallingIntentWitParams=function(e){var i=this.toDeepLinkOptions(e),n=t.CallingIntentUtilities.intentFromDeepLinkOptions(i,this.utilityService);return this.callingIntentMultiWindowService.saveIntent(n)},n.prototype.parseBroadcastParticipantRole=function(t){switch(t){case"contributor":return e.services.BroadcastParticipantRole.Contributor;case"producer":return e.services.BroadcastParticipantRole.Producer;default:return}},n.prototype.toDeepLinkOptions=function(e){return{conversationId:e.conversationId,messageId:e.messageId,deeplinkId:e.deepLinkContext.DeeplinkId,context:e.deepLinkContext,navCtx:this.constants.navContext.deepLink,goOptions:void 0,bypassPrejoin:e.bypassPrejoin,userRole:this.parseBroadcastParticipantRole(e.deepLinkContext.userRole)}},n.prototype.navigateToHomePage=function(){var e={location:"replace",inherit:!1,reload:!1};this.logger.info("Navigating to rigel home page"),this.$state.go(this.constants.states.rigelConsoleHomePage,{},e)},n}(SkypeX.Services.ObservableBase);t.RigelNavigationServiceImplementation=i,angular.module("teamspace.rigelNavigationService",["ui.router","teamspace.constants","teamspace.loggingService","teamspace.utilityService","teamspace.callingService","teamspace.orchestrationService","teamspace.callingUserActionService","teamspace.settingsService","teamspace.callingIntentMultiWindowService","skypeX.meetingPolicySettingsStore"]).service("rigelNavigationService",i)}(e.services||(e.services={}))}(teamspace||(teamspace={}));var __extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),teamspace;!function(e){!function(t){var i=function(i){function n(e,t,n,o,a,s,r,c,l,h,p,d,g){var u=i.call(this)||this;return u.loggingService=e,u.$q=t,u.$rootScope=n,u.eventingService=o,u.authenticationService=a,u.constants=s,u.rigelServiceHandler=c,u.deviceManagerService=l,u.meetingPolicySettingsStore=h,u.callingAlertsService=p,u.$translate=d,u.resources=g,u.isRemoteControlRunning=!1,u.ptzRemoteToggleEnabled=!0,u.cameraStateOn=!0,u.remoteControllerName="Unknown",u.logger=e.newLogger("RigelRemoteControlHandler.Desktop"),u.rigelSettings=r.valueFor(s.settings.names.rigel),u.callRemotePtzCameraState={isRemoteControlRunning:!1,remotePtzCameraControllerName:null},n.$on(s.events.rigel.service.eventTypes.toggleRemotePtzCamera,function(e,t){u.logger.info(s.events.rigel.service.eventTypes.toggleRemotePtzCamera+" called by TMP"),t.isEnabled&&u.isPtzCameraPolicyReady()?u.updateEndpointPtzMetadata(!0):(u.updateEndpointPtzMetadata(!1),u.terminatePtzRemoteControl())}),u}return __extends(n,i),n.$inject=["loggingService","$q","$rootScope","eventingService","authenticationService","constants","settingsService","rigelServiceHandler","deviceManagerService","meetingPolicySettingsStore","callingAlertsService","$translate","resources"],n.prototype.init=function(){return this.$q.when(this.initHandler())},n.prototype.updatePtzToggleButtonState=function(e){this.ptzRemoteToggleEnabled=e,this.logger.info("PTZ remote toggle button = ["+this.ptzRemoteToggleEnabled+"]"),this.updateEndpointPtzMetadata(this.buttonsAreReady())},n.prototype.updateCameraButtonState=function(e){this.cameraStateOn=e,this.logger.info("camera button = ["+this.cameraStateOn+"]"),this.updateEndpointPtzMetadata(this.buttonsAreReady())},n.prototype.initHandler=function(){var e=this;this.rigelSettings.enablePtzRemoteControl?this.rigelServiceHandler.appReadyPromise.then(function(){e.logger.info("initialize PTZ remote control for MTR"),e.eventingService.$on(e.$rootScope,e.constants.events.rigel.call.eventTypes.callCreated,e.onCallCreated.bind(e)),e.eventingService.$on(e.$rootScope,e.constants.events.calling.callDisposed,e.onCallDisposed.bind(e)),e.eventingService.$on(e.$rootScope,e.constants.events.calling.callEscalated,e.onCallEscalated.bind(e)),e.deviceManagerService.whenInitialized().then(function(){e.deviceManagerSubscription=e.deviceManagerService.subscribe(e.onDeviceChanged.bind(e),e.constants.events.calling.devicesChanged),e.onDeviceChanged()}),e.getCurrentTenantId()}):this.logger.info("PTZ remote control for MTR disabled")},n.prototype.onCallCreated=function(e,t){var i=this;this.callStateSubscription=t.on("callStateChanged",function(){return i.onCallStateChanged(t)})},n.prototype.onCallStateChanged=function(e){switch(this.logger.info("onCallStateChanged and call.state to = ["+t.CallUtilities.stringifyCallState(e.state)+"]"),e.state){case 3:case 1:this.initRemoteControl(e)}},n.prototype.initRemoteControl=function(e){this.isRemoteControlRunning||2!==e.teamsCallType?this.logger.info("Camera remote control not initialized due to isRemoteControlRunning = ["+this.isRemoteControlRunning+"],call type = "+e.teamsCallType.toString()):(this.currentTeamsCall=e,this.initPtzHandler(e))},n.prototype.sendPtzControlCommand=function(e){var t;null===(t=this.currentTeamsCall.ptzHandler)||void 0===t||t.sendPTZControlCommand(e)},n.prototype.onCallEscalated=function(e,t){this.logger.info("onCallEscalated fired"),this.initRemoteControl(t)},n.prototype.onCallDisposed=function(e,t){this.logger.info("onCallDisposed called"),this.currentTeamsCall&&t&&(this.logger.info("this.currentTeamsCall.callId = "+this.currentTeamsCall.callId+", call.callId = "+t.callId),this.currentTeamsCall.callId!==t.callId)?this.logger.error("call disposed event with different call id"):(this.currentTeamsCall=null,this.remoteControllerName="Unknown",this.callStateSubscription&&(this.callStateSubscription.dispose(),this.callStateSubscription=null),this.ptzDataChannelStateChangedSubscription&&(this.ptzDataChannelStateChangedSubscription.dispose(),this.ptzDataChannelStateChangedSubscription=null),this.ptzIncomingRequestSubscription&&(this.ptzIncomingRequestSubscription.dispose(),this.ptzIncomingRequestSubscription=null),this.ptzSessionChangedSubscription&&(this.ptzSessionChangedSubscription.dispose(),this.ptzSessionChangedSubscription=null),this.ptzControlDeviceStateSubscription&&(this.ptzControlDeviceStateSubscription.dispose(),this.ptzControlDeviceStateSubscription=null),this.monitoredCallSubscription&&(this.monitoredCallSubscription.dispose(),this.monitoredCallSubscription=null))},n.prototype.getCurrentTenantId=function(){var e=this;this.authenticationService.getUserInformation().then(function(t){e.currentTenantId=t&&t.profile.tid||"",e.logger.info("current tenant id = ["+e.currentTenantId+"]")})},n.prototype.isRemoteRequestAllowed=function(e,t){switch(this.updateCurrentTeamsMeetingPolicy(),this.ptzPolicyMode){case"AutoAcceptInTenant":return this.isSameTenant(e,t);case"AutoAcceptAll":return!0;default:return!1}},n.prototype.updateCurrentTeamsMeetingPolicy=function(){this.ptzPolicyMode=this.meetingPolicySettingsStore.getSettingValue(SkypeX.Services.MeetingPolicySettingsStorageKey.teamsCameraFarEndPTZMode),this.logger.info("update PTZ remote control policy to = ["+this.ptzPolicyMode+"]")},n.prototype.remoteControlBroadcastEnabled=function(){switch(this.updateCurrentTeamsMeetingPolicy(),this.ptzPolicyMode){case"AutoAcceptInTenant":case"AutoAcceptAll":return!0;default:return!1}},n.prototype.isSameTenant=function(e,t){this.logger.info("current tenant id = ["+this.currentTenantId+"], target paticipant to find = ["+e+"], number of participant = ["+t.participants.length+"]");var i=t.participants.find(function(t){return e===t.id});return i&&i.tenantId===this.currentTenantId},n.prototype.onDeviceChanged=function(){var e=this.deviceManagerService.getSelectedDevices();e&&e.camera&&this.selectedPtzCapableCamera!==e.camera&&this.selectedPtzCapableCamera},n.prototype.isPtzCameraPolicyReady=function(){return this.logger.info("saved selectedPtzCapableCamera = "+this.selectedPtzCapableCamera),this.selectedPtzCapableCamera&&this.remoteControlBroadcastEnabled()},n.prototype.initPtzHandler=function(e){var t=this,i=this.loggingService.newScenario(this.constants.events.rigel.service.scenarios.ptzRemoteControlInit),n=this.deviceManagerService.getSelectedDevices();this.isPtzCameraPolicyReady()?(this.logger.info("use camera cached"),e.ptzHandler.setPTZHandlerFeatureFlag(!0),this.createPtzRemoteControlEvent(e),i.stop({reason:"cameraCache"})):n&&n.camera&&this.remoteControlBroadcastEnabled()?this.deviceManagerService.getCameraAvailable().then(function(o){t.logger.info("isCameraReady = "+o),e.ptzHandler.getDevicePTZCapability(n.camera).then(function(o){o&&0!==o.type?(t.selectedPtzCapableCamera=n.camera,t.logger.info("set selectedPtzCapableCamera = "+t.selectedPtzCapableCamera),e.ptzHandler.setPTZHandlerFeatureFlag(!0),t.createPtzRemoteControlEvent(e),i.stop({reason:"cameraNoCache"})):o?(t.logger.info("This is not PTZ camera supported type = "+o.type+", version = "+o.version),i.stop({reason:"DevicePTZCapabilityTypeNone"})):(i.incomplete({reason:"DevicePTZCapabilityNull"}),t.logger.info("getDevicePTZCapability returned null"))}).catch(function(e){t.logger.error("getDevicePTZCapability returned exception, error = ["+e+"]"),i.fail({reason:"getDevicePTZCapabilityFailed",errorMessage:e})})}):(i.incomplete({reason:"noCameraOrPolicyDisabled"}),this.logger.error("cant find selected device or camera or policy disabled"))},n.prototype.onPtzDataChannelStateChanged=function(e){this.logger.info("onPtzDataChannelStateChanged = ["+e+"]"),this.updateEndpointPtzMetadata(e)},n.prototype.updateEndpointPtzMetadata=function(e){this.logger.info("publish PTZ remote control endpoint metadata = ["+e+"]");var i=t.CallUtilities.getOwnEndpoint(this.currentTeamsCall),n=i?i.endpointMetadata:{};n||(n={}),n.ptzRemoteCameraControl=e,this.currentTeamsCall.updateEndpointMetadata(JSON.stringify(n))},n.prototype.buttonsAreReady=function(){return this.logger.info("ptzRemoteToggleEnabled = ["+this.ptzRemoteToggleEnabled+"], cameraStateOn = ["+this.cameraStateOn+"]"),this.ptzRemoteToggleEnabled&&this.cameraStateOn},n.prototype.onPtzIncomingRequest=function(e,t){var i=this,n=this.loggingService.newScenario(this.constants.events.rigel.service.scenarios.ptzRemoteControlRequest);this.buttonsAreReady()&&this.isRemoteRequestAllowed(e,t)?t.ptzHandler.acceptPTZControllerRequest().then(function(){i.logger.info("accepting remote control request from participant id = ["+e+"]"),i.isRemoteControlRunning=!0;var o=t.participants.find(function(t){return e===t.id});i.remoteControllerName=o?o.displayName:"Unknown",i.callRemotePtzCameraState.isRemoteControlRunning=!0,i.callRemotePtzCameraState.remotePtzCameraControllerName=i.getRemoteControllerName(),i.$rootScope.$emit(i.constants.events.calling.remotePtzCameraStateChanged,i.callRemotePtzCameraState);var a=i.callingAlertsService.getAlertsOfTypes([i.remotePtzIsControllingYourCameraBanner.name]);_.forEach(a,function(e){return i.callingAlertsService.dismiss(e)}),i.callingAlertsService.handleOnDemandAlert(i.remotePtzIsControllingYourCameraBanner),n.stop()}).catch(function(e){i.logger.error("acceptPTZControllerRequestFailed = ["+e+"]"),n.fail({reason:"acceptPTZControllerRequestFailed",errorMessage:e})}):(this.isRemoteControlRunning=!1,t.ptzHandler.denyPTZControllerRequest().then(function(){var o=i.isRemoteRequestAllowed(e,t);i.logger.info("buttonReady="+i.buttonsAreReady()+",requestAllowed="+o+"}"),n.incomplete({reason:"buttonReady="+i.buttonsAreReady()+",requestAllowed="+o+"}"})}).catch(function(e){i.logger.error("denyPTZControllerRequestFailed = ["+e+"]"),n.fail({reason:"denyPTZControllerRequestFailed",errorMessage:e})}))},n.prototype.onPtzSessionChanged=function(e){this.logger.info("onPtzSessionChanged isControl = ["+e.inControl+"], id = ["+e.id+"]"),e.inControl||(this.isRemoteControlRunning=!1,this.logger.info("onPtzSessionChanged and terminatedReason = ["+e.terminatedReason+"]"),this.callRemotePtzCameraState.isRemoteControlRunning=!1,this.callRemotePtzCameraState.remotePtzCameraControllerName=this.getRemoteControllerName(),this.$rootScope.$emit(this.constants.events.calling.remotePtzCameraStateChanged,this.callRemotePtzCameraState),this.callingAlertsService.dismiss(this.remotePtzIsControllingYourCameraBanner))},n.prototype.onPtzControlDeviceState=function(e){this.logger.info("PTZ state = ["+e+"]")},n.prototype.createPtzRemoteControlEvent=function(e){var t=this,i=e.ptzHandler;null!=i?(this.ptzDataChannelStateChangedSubscription=i.on("ptzDataChannelStateChanged",function(e){return t.onPtzDataChannelStateChanged(e)}),this.ptzIncomingRequestSubscription=i.on("ptzIncomingRequest",function(i){return t.onPtzIncomingRequest(i,e)}),this.ptzSessionChangedSubscription=i.on("ptzSessionChanged",function(e){return t.onPtzSessionChanged(e)}),this.ptzControlDeviceStateSubscription=i.on("ptzControlDeviceState",function(e){return t.onPtzControlDeviceState(e)})):this.logger.error("ptzEvent is null")},n.prototype.terminatePtzRemoteControl=function(){var e,t,i=this;if(this.logger.info("terminate PTZ Remote Control = ["+this.isRemoteControlRunning+"], currentTeamsCall.callId = ["+this.currentTeamsCall.callId+"]"),this.isRemoteControlRunning&&this.currentTeamsCall){var n=this.loggingService.newScenario(this.constants.events.rigel.service.scenarios.ptzRemoteControlTerminated);null===(e=this.currentTeamsCall.ptzHandler)||void 0===e||e.terminatePTZSession().then(function(){n.stop(),i.logger.info("terminate PTZ session by camera off")}).catch(function(e){i.logger.error("throwing exception at terminating PTZ session by camera off adn error = ["+e+"]"),n.fail({errorMessage:e})}),this.isRemoteControlRunning=!1}else this.logger.info("not terminating PTZ due to isRemoteControlRunning=["+this.isRemoteControlRunning+"], this.currentTeamsCall?.callId = ["+(null===(t=this.currentTeamsCall)||void 0===t?void 0:t.callId)+"]")},n.prototype.getRemoteControllerName=function(){return this.remoteControllerName},Object.defineProperty(n.prototype,"remotePtzIsControllingYourCameraBanner",{get:function(){return{name:"RemotePtzIsControllingYourCamera",type:e.services.AlertType.Info,text:this.$translate.instant(this.resources.strings.call_remote_ptz_controlling_your_camera,{name:this.getRemoteControllerName()}),ariaText:this.$translate.instant(this.resources.strings.call_remote_ptz_controlling_your_camera,{name:this.getRemoteControllerName()}),dismissable:!0,teamsCallId:this.currentTeamsCall.teamsCallId,timeout:t.ALERT_NO_TIMEOUT}},enumerable:!0,configurable:!0}),n}(SkypeX.Services.ObservableBase);t.RigelRemoteControlHandlerImplementation=i,angular.module("teamspace.rigelRemoteControlHandler",["teamspace.constants","teamspace.loggingService","teamspace.settingsService","teamspace.eventingService","teamspace.rigelServiceHandler","teamspace.rigelNavigationService","teamspace.authenticationService","teamspace.deviceManagerService","skypeX.meetingPolicySettingsStore","teamspace.callingAlertsService"]).service("rigelRemoteControlHandler",i)}(e.services||(e.services={}))}(teamspace||(teamspace={}));var __extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),teamspace;!function(e){!function(e){var t=function(t){function i(i,n,o,a,s,r,c,l,h,p,d,g,u,v,f,S,m,y,C,b,T,k,w){var N=t.call(this)||this;return N.$window=i,N.$q=n,N.constants=o,N.loggingService=a,N.$rootScope=s,N.rigelNavigationService=r,N.settingsService=c,N.callingSupportService=l,N.emergencyService=h,N.eventingService=p,N.hybridContentVisibilityManager=d,N.multiWindowService=g,N.platformDetectService=u,N.msGraphRestClient=v,N.utilityService=f,N.sxConfig=S,N.peopleService=m,N.pstnNumberService=y,N.ariaLiveService=C,N.resources=b,N.$translate=T,N.authenticationService=k,N.myPhoneNumberService=w,N.sfbState=e.SfBState.Idle,N.disableFeedbackButton=!1,N.ingestCameraIdEnabled=!1,N.isAppReady=!1,N.isOemPluginConnected=!1,N.isOemPluginShown=!1,N.externalWindowCount=1,N.currentIngestCamera=null,N.currentWhiteboardCamera=null,N.rigelSettings=null,N.foundCaptureConfigOverride=!1,N._allowRoomRemoteController=!1,N._autoExitMeetingEnabled=!1,N._bluetoothBeaconEnabled=!1,N._byomAutoAcceptEnabled=!1,N._cortanaWakeWordSettingEnabled=!1,N.showVMRButton=!0,N.enableRoomCapacityNotification=!0,N.appReadyDependantEventTypes=[N.constants.events.rigel.service.eventTypes.joinMeetup,N.constants.events.rigel.service.eventTypes.openPreCall,N.constants.events.rigel.service.eventTypes.toggleCortana,N.constants.events.rigel.service.eventTypes.openRigelCortana],N.VidPidRegExp=RegExp("vid_([0-9a-f]{4})&pid_([0-9a-f]{4})","g"),N.isDesktopVersionValidForMW=!1,N.rigelSettings=c.valueFor(o.settings.names.rigel),N.cameraCaptureConfigOverrides=N.rigelSettings.cameraCaptureConfigOverrides,N.logger=a.newLogger("RigelServiceHandler"),N.isDesktopVersionValidForMW=!N.isDesktopBelowCompareVersion(N.rigelSettings.minDesktopVersionForMultiWindow),N.appReadyDefer=n.defer(),N.appReadyDefer.promise.then(function(){return N.onAppReady()}),N.debouncedCortanaSettingsUpdated=_.debounce(function(){N.logger.info("trigger cortanaSettingsUpdated"),N.trigger(e.RigelServiceHandlerEvents.cortanaSettingsUpdated,SkypeX.Services.ObservableBase.Key_All)},10),N}return __extends(i,t),i.$inject=["$window","$q","constants","loggingService","$rootScope","rigelNavigationService","settingsService","callingSupportService","emergencyService","eventingService","hybridContentVisibilityManager","multiWindowService","platformDetectService","msGraphRestClient","utilityService","sxConfig","peopleService","pstnNumberService","ariaLiveService","resources","$translate","authenticationService","myPhoneNumberService"],i.prototype.init=function(){var e=this;return this.rigelSettings.enableGetSKUType&&(this.skuScenario=this.loggingService.newScenario(this.constants.events.rigel.service.scenarios.premiumSKU),this.msGraphRestClient.lookupLicenseDetails().then(function(t){var i="";t.forEach(function(e){i+=e+";"}),e.skuScenario.stop({message:i})}).catch(function(t){e.skuScenario.fail({error:t})})),this.$q.when(this.initHandler())},i.prototype.postFeedbackSubmit=function(e,t,i,n){this.logger.info("The teams feedback was filed under the category : '{0}'",t),this.logger.info("The user has requested to include the screenshot in work item : '{0}'",i),this.ipc.send(this.constants.events.rigel.service.callback,{type:this.constants.events.rigel.service.eventTypes.postFeedbackSubmit,data:{feedbackText:e,feedbackSelectedCategory:t,includeScreenshot:i,childWindow:n}})},i.prototype.showTeams=function(e){this.ipc.send(this.constants.events.rigel.service.callback,{type:this.constants.events.rigel.service.eventTypes.showTeams,data:{value:e}})},i.prototype.updateTeamsCallState=function(t,i){this.settingsService.valueFor(this.constants.settings.names.rigel).switchToTeamsStateUpdate?(this.logger.info("Sending new TeamsCallState: "+e.TeamsCallState[t]+" ("+t+")"),this.ipc.send(this.constants.events.rigel.service.callback,{type:this.constants.events.rigel.service.eventTypes.teamsCallState,data:{value:e.TeamsCallState[t]}})):this.showTeams(t!==e.TeamsCallState.Idle),t===e.TeamsCallState.Idle&&this.rigelNavigationService.navigateToHomePage();var n=this.loggingService.newScenario(this.constants.events.rigel.service.scenarios.updateTeamsCallState,null,null,10*this.constants.timeInMiliseconds.second);i&&n.mark(i),n.stop(),this.$rootScope.$broadcast(this.constants.events.rigel.service.eventTypes.teamsCallState,t)},i.prototype.displayOemPlugin=function(e){void 0===e&&(e=!0);var t=this.getIsOemPluginConnected(),i=this.getIsOemPluginShown();this.logger.info("Displaying OEM Plugin, show: "+e+", isOemPluginConnected: "+t+", isOemPluginShown: "+i),t&&e!==i&&this.ipc.send(this.constants.events.rigel.service.callback,{type:this.constants.events.rigel.service.eventTypes.displayOemPlugin,data:e})},i.prototype.initHandler=function(){var t=this;this.sendRoomInformation(),this.checkIfAppIsReady(),this.ingestCameraIdEnabled=this.$window.desktopSettings&&this.$window.desktopSettings[this.constants.events.rigel.desktopSettings.enableRigelIngestCameraId],this.ipc=this.$window.electronSafeIpc,this.ipc.on(this.constants.events.rigel.service.event,this.onRigelServiceEvent.bind(this)),this.$rootScope.$on(this.constants.events.rigel.service.event,this.onRigelServiceEvent.bind(this)),this.requestRigelServiceState(),this.callingSupportService.subscribe(function(){return t.sendIsPstnCallingAllowed()},e.CallingSupportServiceEvents.Type_isPstnCallingAllowedChanged),this.sendIsPstnCallingAllowed(),this.initDeviceLocationSubscription(),this.updateTeamsCallState(e.TeamsCallState.Idle,"RigelServiceHandler_initHandler"),this.$rootScope.$on(this.constants.events.rigel.service.eventTypes.enableUwpAudioIngestPlayback,function(e,i){t.sendEnableUwpAudioIngestPlayback(i)}),this.sendTeamsTenantInformation()},i.prototype.checkIfAppIsReady=function(){var e=this;if(this.logger.info("[checkIfAppIsReady] multiWindowEnabled="+this.multiWindowEnabled),this.multiWindowEnabled&&!this.hybridContentVisibilityManager.isReady){this.logger.info("MultiWindow not loaded. subscribing to loaded event");var t=this.eventingService.$onWithTenantScope(this.$rootScope,this.constants.events.multiWindow.loaded,function(){e.logger.info("MultiWindow loaded event received. resolving app ready promise"),e.appReadyDefer.resolve(),t()})}else this.logger.info("app is ready. resolving promise"),this.appReadyDefer.resolve()},i.prototype.onAppReady=function(){this.isAppReady=!0,this.logger.info("[onAppReady] sending ready state to desktop client"),this.ipc.send(this.constants.events.rigel.service.callback,{type:this.constants.events.rigel.service.eventTypes.appReady,data:this.isAppReady})},i.prototype.initDeviceLocationSubscription=function(){this.eventingService.$on(this.$rootScope,this.constants.events.calling.locationUpdated,this.sendDeviceLocation.bind(this)),this.sendDeviceLocation()},i.prototype.requestRigelServiceState=function(){this.ipc.send(this.constants.events.rigel.service.callback,{type:this.constants.events.rigel.service.eventTypes.requestRigelServiceState,data:null})},i.prototype.sendIsPstnCallingAllowed=function(){if(this.settingsService.valueFor(this.constants.settings.names.rigel).enableSendIsEvEnabled){var e=!!this.callingSupportService.isPSTNCallingAllowed();this.logger.info("PSTN is' "+(e?"enabled":"disabled")+"' based on callingSupportService."),this.ipc.send(this.constants.events.rigel.service.callback,{type:this.constants.events.rigel.service.eventTypes.isEvEnabled,data:e})}else this.logger.info("enableSendIsEvEnabled is not enabled and isEvEnabled property will not be reflected on the SfB side accurately")},i.prototype.sendDeviceLocation=function(){var e=this.emergencyService.getMyFormattedLocation(this.constants.scenarios.calling.context.rigelConsoleScreen);this.ipc.send(this.constants.events.rigel.service.callback,{type:this.constants.events.rigel.service.eventTypes.updateDeviceLocation,data:e||""})},i.prototype.sendEnableUwpAudioIngestPlayback=function(e){this.ipc.send(this.constants.events.rigel.service.callback,{type:this.constants.events.rigel.service.eventTypes.enableUwpAudioIngestPlayback,data:e})},i.prototype.sendRoomInformation=function(){var e=this;if(this.settingsService.valueFor(this.constants.settings.names.rigel).enableRoomInformation){this.logger.info("Requesting Room Information.");var t=this.sxConfig.getCurrentSkypeMri();t?this.peopleService.getPeopleProfile(t,"rigelServiceHandler").then(function(t){var i,n,o,a,s;e.logger.info("Room Information found"),t.displayName||e.logger.warn("Room Information has an empty displayName"),t.telephoneNumber||e.logger.warn("Room Information has an empty phone number"),t.email||e.logger.warn("Room Information has an empty email");var r=null===(n=e.pstnNumberService.formatPhoneNumber(null!==(i=t.telephoneNumber)&&void 0!==i?i:""))||void 0===n?void 0:n.display;r||(e.logger.info("Room Information is falling back to using dial pad for phone number"),(r=e.myPhoneNumberService.getMyPhoneNumber())||e.logger.warn("Room Information dial pad information has an empty phone number"));var c={name:null!==(o=t.displayName)&&void 0!==o?o:"",phoneNumber:null!==r&&void 0!==r?r:"",email:null!==(a=t.email)&&void 0!==a?a:"",sip:null!==(s=t.sipProxyAddress)&&void 0!==s?s:""};e.ipc.send(e.constants.events.rigel.service.callback,{type:e.constants.events.rigel.service.eventTypes.currentUserInformation,data:JSON.stringify(c),sensitive:!0})}).catch(function(i){return e.logger.error("Room Information failed. Failed to fetch for user="+t+", exception="+JSON.stringify(i))}):this.logger.error("Room Information failed. User Mri was not found.")}},i.prototype.sendTeamsTenantInformation=function(){var e;if(this.settingsService.valueFor(this.constants.settings.names.rigel).enableTenantInformation){this.logger.info("Sending Tenant Information.");var t=null!==(e=this.authenticationService.getLoggedInUserTenantId())&&void 0!==e?e:"";t?this.ipc.send(this.constants.events.rigel.service.callback,{type:this.constants.events.rigel.service.eventTypes.teamsTenantId,data:t}):this.logger.warn("Tenant Information is invalid. Tenant Id is unavailable.")}else this.logger.info("Sending Tenant Information is disabled.")},i.prototype.onRigelServiceEvent=function(t,i){if(this.logger.info("Received "+i.type+" with value "+i.data),this.appReadyDependantEventTypes.includes(i.type)&&!this.isAppReady)return this.logger.info("cannot process event="+i.type+", app not ready."),this.$q.reject();switch(i.type){case this.constants.events.rigel.service.eventTypes.autoExitMeetingEnabled:return this._autoExitMeetingEnabled=i.data,this.trigger(e.RigelServiceHandlerEvents.onRigelServiceEvent,SkypeX.Services.ObservableBase.Key_All,i),this.$q.resolve();case this.constants.events.rigel.service.eventTypes.bluetoothBeaconEnabled:return this._bluetoothBeaconEnabled=i.data,this.trigger(e.RigelServiceHandlerEvents.onRigelServiceEvent,SkypeX.Services.ObservableBase.Key_All,i),this.$q.resolve();case this.constants.events.rigel.service.eventTypes.byomAutoAcceptEnabled:return this._byomAutoAcceptEnabled=i.data,this.trigger(e.RigelServiceHandlerEvents.onRigelServiceEvent,SkypeX.Services.ObservableBase.Key_All,i),this.$q.resolve();case this.constants.events.rigel.service.eventTypes.cortanaWakewordSettingEnabled:return i.data!==this._cortanaWakeWordSettingEnabled&&void 0!==i.data&&(this._cortanaWakeWordSettingEnabled=i.data,this.debouncedCortanaSettingsUpdated()),this.$q.resolve();case this.constants.events.rigel.service.eventTypes.openRigelCortana:return this.trigger(e.RigelServiceHandlerEvents.cortanaOpened,SkypeX.Services.ObservableBase.Key_All),this.$q.resolve();case this.constants.events.rigel.service.eventTypes.toggleCortana:return this.trigger(e.RigelServiceHandlerEvents.cortanaToggled,SkypeX.Services.ObservableBase.Key_All,i.data),this.$q.resolve();case this.constants.events.rigel.service.eventTypes.joinMeetup:return this.joinMeetup(i.data);case this.constants.events.rigel.service.eventTypes.getAudioVolume:return this.$rootScope.$broadcast(this.constants.events.rigel.service.eventTypes.getAudioVolume,i.data),this.$q.resolve();case this.constants.events.rigel.service.eventTypes.hdmiActive:return this.$q.resolve();case this.constants.events.rigel.service.eventTypes.autoScreenSharing:return this.$rootScope.$broadcast(this.constants.events.rigel.service.eventTypes.autoScreenSharing,i.data),this.$q.resolve();case this.constants.events.rigel.service.eventTypes.coordinatedMeetingsSettings:return this.logger.info("Received coordinatedMeetingsSettings : "+i.data),this.broadcastOnRootScope(i.type,i.data);case this.constants.events.rigel.service.eventTypes.externalWindowCount:return this.$window.desktopSettings&&this.$window.desktopSettings[this.constants.events.rigel.desktopSettings.enableRigelDualFrontOfRoomSupport]&&(this.externalWindowCount=i.data,this.logger.info("Received externalWindow count "+this.externalWindowCount),this.$rootScope.$broadcast(this.constants.events.rigel.service.eventTypes.externalWindowCount,this.externalWindowCount)),this.$q.resolve();case this.constants.events.rigel.service.eventTypes.connectedDisplayCount:return this.broadcastOnRootScope(i.type,i.data);case this.constants.events.rigel.service.eventTypes.frontOfRoomWindowsSwapDone:return this.ariaLiveService.update(this.$translate.instant(this.resources.strings.aria_announce_swapped_screens),!0),this.$q.resolve();case this.constants.events.rigel.service.eventTypes.hdmiPluggedIn:return this.$rootScope.$broadcast(this.constants.events.rigel.service.eventTypes.hdmiPluggedIn,i.data),this.$q.resolve();case this.constants.events.rigel.service.eventTypes.disableFeedbackButton:return this.disableFeedbackButton=i.data,this.$rootScope.$broadcast(this.constants.events.rigel.service.eventTypes.disableFeedbackButton,i.data),this.$q.resolve();case this.constants.events.rigel.service.eventTypes.sfbState:var n=this.sfbState;return this.sfbState=i.data,this.logger.info("SfbState updated: "+e.SfBState[n]+" ("+n+") ---\x3e "+e.SfBState[this.sfbState]+" ("+this.sfbState+")"),this.trigger(e.RigelServiceHandlerEvents.sfbStateUpdated,SkypeX.Services.ObservableBase.Key_All,this.sfbState),this.$q.resolve();case this.constants.events.rigel.service.eventTypes.showVMRButton:return this.showVMRButton=i.data,this.logger.info("Received "+this.constants.events.rigel.service.eventTypes.showVMRButton+"="+this.showVMRButton),this.$q.resolve();case this.constants.events.rigel.service.eventTypes.openPreCall:var o=i.data;return this.logger.info("Received "+this.constants.events.rigel.service.eventTypes.openPreCall+" with isPstn="+o+", showVMRButton="+this.showVMRButton),this.rigelNavigationService.navigateToPreCallPage(o,this.showVMRButton),this.$q.resolve();case this.constants.events.rigel.service.eventTypes.hdmiCaptureDevice:if(this.ingestCameraIdEnabled)return this.$q.resolve();var a=i.data;return this.currentIngestCamera=this.createRigelCameraFromVidPid(a.vid,a.pid),this.checkForCameraConfigOverrides(),this.broadcastOnRootScope(this.constants.events.rigel.service.eventTypes.hdmiIngestCamera,this.currentIngestCamera);case this.constants.events.rigel.service.eventTypes.defaultSelectedCamera:var s=this.createRigelCameraFromInstancePath(i.data);return this.broadcastOnRootScope(i.type,s);case this.constants.events.rigel.service.eventTypes.ingestCameraId:if(!this.ingestCameraIdEnabled)return this.$q.resolve();var r=i.data;return this.currentIngestCamera=this.createRigelCameraFromInstancePath(r),this.checkForCameraConfigOverrides(),this.broadcastOnRootScope(this.constants.events.rigel.service.eventTypes.hdmiIngestCamera,this.currentIngestCamera);case this.constants.events.rigel.service.eventTypes.contentCameraId:if(this.foundCaptureConfigOverride&&!this.rigelSettings.enableCameraCaptureConfigOverride)return;var c=i.data;return this.currentWhiteboardCamera=this.createRigelCameraFromInstancePath(c),this.broadcastOnRootScope(this.constants.events.rigel.service.eventTypes.whiteboardCamera,this.currentWhiteboardCamera);case this.constants.events.rigel.service.eventTypes.contentCameraEnhancementEnabled:case this.constants.events.rigel.service.eventTypes.contentCameraInverted:return this.broadcastOnRootScope(i.type,i.data);case this.constants.events.rigel.service.eventTypes.oemPluginConnected:var l=i.data;return this.isOemPluginConnected=l,this.$rootScope.$broadcast(this.constants.events.rigel.service.eventTypes.oemPluginConnected,l),this.$q.resolve();case this.constants.events.rigel.service.eventTypes.oemPluginShown:var h=i.data;return this.isOemPluginShown=h,this.$q.resolve();case this.constants.events.rigel.service.eventTypes.frontOfRoomLoadFailed:return this.broadcastOnRootScope(i.type,i.data);case this.constants.events.rigel.service.eventTypes.disableTeamsAudioSharing:return this.$rootScope.$broadcast(this.constants.events.rigel.service.eventTypes.disableTeamsAudioSharing,i.data),this.$q.resolve();case this.constants.events.rigel.service.eventTypes.allowRoomRemoteEnabled:return this.logger.info("Broadcasting allowroomremoteenabled: "+i.data),this._allowRoomRemoteController=!!i.data&&i.data,this.broadcastOnRootScope(this.constants.events.rigel.service.eventTypes.allowRoomRemoteEnabled,this._allowRoomRemoteController);case this.constants.events.rigel.service.eventTypes.joinByCode:return this.rigelNavigationService.navigateToJoinByCode(),this.$q.resolve();case this.constants.events.rigel.service.eventTypes.enableRoomCapacityNotification:return this.enableRoomCapacityNotification=i.data,this.logger.info("Received "+this.constants.events.rigel.service.eventTypes.enableRoomCapacityNotification+"="+this.enableRoomCapacityNotification),this.$q.resolve();case this.constants.events.rigel.service.eventTypes.toggleWhiteboardCamera:return this.broadcastOnRootScope(i.type,i.data);default:return this.logger.error("Unrecognized event type: '{0}'",i.type),this.$q.reject("Unrecognized event type: "+i.type)}},i.prototype.createRigelCameraFromInstancePath=function(e){if(!e)return this.logger.warn("Received an empty instance path, camera is not configured currently"),null;var t=e.toLowerCase().replace(/\\/g,"#");this.VidPidRegExp.lastIndex=0;var i=this.VidPidRegExp.exec(t),n=0,o=0;return 3===i.length?(n=parseInt(i[1],16),o=parseInt(i[2],16)):this.logger.error("Unable to parse VID/PID out of instance path"),{deviceId:t,vid:n,pid:o}},i.prototype.createRigelCameraFromVidPid=function(e,t){return{deviceId:"vid_"+this.decimalToPaddedFourDigitHex(e)+"&pid_"+this.decimalToPaddedFourDigitHex(t),vid:e,pid:t}},i.prototype.decimalToPaddedFourDigitHex=function(e){var t="000"+e.toString(16);return t.substr(t.length-4)},i.prototype.broadcastOnRootScope=function(e,t){return this.$rootScope.$broadcast(e,t),this.$q.resolve()},i.prototype.checkForCameraConfigOverrides=function(){if(this.currentIngestCamera){this.foundCaptureConfigOverride=!1;for(var e=0,t=this.cameraCaptureConfigOverrides;e<t.length;e++){var i=t[e];this.currentIngestCamera.vid===i.vendorId&&this.currentIngestCamera.pid===i.productId&&(this.logger.info("Found camera capture config override in ECS config"),this.foundCaptureConfigOverride=!0,this.broadcastOnRootScope(this.constants.events.rigel.service.eventTypes.roomCameraCaptureConfig,i.roomCameraConfig),this.broadcastOnRootScope(this.constants.events.rigel.service.eventTypes.contentCameraCaptureConfig,i.contentCameraConfig),this.rigelSettings.enableCameraCaptureConfigOverride||this.broadcastOnRootScope(this.constants.events.rigel.service.eventTypes.whiteboardCamera,null))}}else this.logger.warn("No valid ingest camera found")},i.prototype.decodeSafeLinkUrl=function(e){this.logger.info("Decoding safelink meeting URL "+e);var t=/[?].*/.exec(e)[0],i=new URLSearchParams(t).get("url");if(null==i)throw new TypeError("Invalid safelink Url");return i},i.prototype.hanldeJoinMeetupFailure=function(e,t,i){return this.ipc.send(this.constants.events.rigel.service.callback,{type:this.constants.events.rigel.service.eventTypes.joinMeetupFailure,data:e.code}),t.fail({reason:i,errorMessage:e}),this.$q.reject(e)},i.prototype.joinMeetup=function(e){var t=this,i=this.loggingService.newScenario(this.constants.events.rigel.service.scenarios.joinMeetingStart,null,null,10*this.constants.timeInMiliseconds.second);if(this.rigelSettings.enableSafelinksJoinMeetupSupport&&/\.safelinks\./.test(e.url))try{e.url=this.decodeSafeLinkUrl(e.url)}catch(e){return this.logger.error("Error while decoding safelinkUrl, error: "+e.message),this.hanldeJoinMeetupFailure(e,i,"decodeSafeLinkUrl")}return this.rigelNavigationService.navigateToRigelConsoleStateWithDeeplink(e.url,i).catch(function(e){return t.logger.error("Error while handling rigel service join-meetup event: "+e.message),t.hanldeJoinMeetupFailure(e,i,"navigateToRigelConsoleStateWithDeeplink")})},i.prototype.getIsOemPluginConnected=function(){return this.isOemPluginConnected},i.prototype.getIsOemPluginShown=function(){return this.isOemPluginShown},i.prototype.getExternalWindowCount=function(){return this.externalWindowCount},i.prototype.getHdmiIngestCamera=function(){return this.currentIngestCamera},i.prototype.getWhiteboardCamera=function(){return this.currentWhiteboardCamera},Object.defineProperty(i.prototype,"autoExitMeetingEnabled",{get:function(){return this._autoExitMeetingEnabled},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"bluetoothBeaconEnabled",{get:function(){return this._bluetoothBeaconEnabled},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"byomAutoAcceptEnabled",{get:function(){return this._byomAutoAcceptEnabled},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"cortanaWakeWordSettingEnabled",{get:function(){return this._cortanaWakeWordSettingEnabled},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"multiWindowEnabled",{get:function(){return this.isDesktopVersionValidForMW&&this.multiWindowService.enabled&&this.rigelSettings.enableMultiWindow},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"appReadyPromise",{get:function(){return this.appReadyDefer.promise},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"allowRoomRemoteController",{get:function(){return this._allowRoomRemoteController},enumerable:!0,configurable:!0}),i.prototype.isDesktopBelowCompareVersion=function(e){var t=this.platformDetectService.getDesktopAppVersion();return this.logger.info("[isDesktopBelowCompareVersion] desktopVersion={0}, compareVersion={0}",t,e),this.isValidVersion(t)&&this.isValidVersion(e)?-1===this.utilityService.compareVersions(t,e):(this.logger.info("[isDesktopBelowCompareVersion] version not valid",t,e),!1)},i.prototype.isValidVersion=function(e){return e&&e.length>0&&4===e.split(".").length&&!e.split(".").some(function(e){return isNaN(parseInt(e))})},i.prototype.sendMeetingIsFull=function(){this.logger.warn("Join meeting failed, the meeting is full. The participant limit was reached."),this.ipc.send(this.constants.events.rigel.service.callback,{type:this.constants.events.rigel.service.eventTypes.joinMeetupFailure,data:e.RigelNavigationServiceErrorCode.MeetingParticipantCountLimitReached})},i}(SkypeX.Services.ObservableBase);e.RigelServiceHandlerImplementation=t,angular.module("teamspace.rigelServiceHandler",["teamspace.constants","teamspace.loggingService","teamspace.rigelNavigationService","teamspace.settingsService","teamspace.emergencyService","teamspace.eventingService","teamspace.pstnNumberService","teamspace.msGraphRestClient","teamspace.ariaLiveService","teamspace.authenticationService","teamspace.myPhoneNumberService"]).service("rigelServiceHandler",t)}(e.services||(e.services={}))}(teamspace||(teamspace={}));var __extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),teamspace;!function(e){!function(e){var t=function(e){function t(t,i,n,o,a){var s=e.call(this)||this;return s.$rootScope=t,s.constants=i,s.$window=n,s.$q=o,s._volume=50,s._isMuted=!1,s.logger=a.newLogger("RigelSpeakerService"),s}return __extends(t,e),t.$inject=["$rootScope","constants","$window","$q","loggingService"],t.prototype.init=function(){return this.$q.when(this.initHandler())},Object.defineProperty(t.prototype,"volume",{get:function(){return this._volume},set:function(e){var t=Math.min(e,100);t=Math.max(t,0),t=10*Math.round(t/10),this.logger.info("Sending volume="+t),this.$window.electronSafeIpc.send(this.constants.events.rigel.service.callback,{type:this.constants.events.rigel.service.eventTypes.setAudioVolume,data:t/100})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isMuted",{get:function(){return this._isMuted},enumerable:!0,configurable:!0}),t.prototype.toggleMuted=function(){this.setMute(!this._isMuted)},t.prototype.initHandler=function(){this.$rootScope.$on(this.constants.events.rigel.service.eventTypes.getAudioVolume,this.onGetAudioVolumeCallback.bind(this)),this.queryVolume()},t.prototype.onGetAudioVolumeCallback=function(e,t){this.logger.info("Received data: mute="+t.mute+", volume="+t.volume),this._isMuted=t.mute,this._volume=100*t.volume,this.$rootScope.$broadcast(this.constants.events.rigel.callScreen.speakerVolumeChanged)},t.prototype.queryVolume=function(){this.logger.info("queryVolume"),this.$window.electronSafeIpc.send(this.constants.events.rigel.service.callback,{type:this.constants.events.rigel.service.eventTypes.queryAudioVolume,data:null})},t.prototype.setMute=function(e){this.logger.info("Sending muted="+e),this.$window.electronSafeIpc.send(this.constants.events.rigel.service.callback,{type:this.constants.events.rigel.service.eventTypes.setMute,data:e})},t}(SkypeX.Services.ObservableBase);e.RigelSpeakerServiceImplementation=t,angular.module("teamspace.rigelSpeakerService",["teamspace.constants","teamspace.loggingService","teamspace.settingsService"]).service("rigelSpeakerService",t)}(e.services||(e.services={}))}(teamspace||(teamspace={}));var __extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),teamspace;!function(e){!function(e){var t=function(e){function t(t,i,n){return e.call(this,t,i,n)||this}return __extends(t,e),t}(teams.calling.RigelVirtualRenderer);e.RigelVirtualRenderer=t}(e.services||(e.services={}))}(teamspace||(teamspace={}));var __extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++){t=arguments[i];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(e,t,i,n){function o(e){return e instanceof i?e:new i(function(t){t(e)})}return new(i||(i=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){e.done?i(e.value):o(e.value).then(s,r)}c((n=n.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){function i(e){return function(t){return n([e,t])}}function n(i){if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,a&&(s=2&i[0]?a.return:i[0]?a.throw||((s=a.return)&&s.call(a),0):a.next)&&!(s=s.call(a,i[1])).done)return s;switch(a=0,s&&(i=[2&i[0],s.value]),i[0]){case 0:case 1:s=i;break;case 4:return c.label++,{value:i[1],done:!1};case 5:c.label++,a=i[1],i=[0];continue;case 7:i=c.ops.pop(),c.trys.pop();continue;default:if(s=c.trys,!(s=s.length>0&&s[s.length-1])&&(6===i[0]||2===i[0])){c=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){c.label=i[1];break}if(6===i[0]&&c.label<s[1]){c.label=s[1],s=i;break}if(s&&c.label<s[2]){c.label=s[2],c.ops.push(i);break}s[2]&&c.ops.pop(),c.trys.pop();continue}i=t.call(e,c)}catch(e){i=[6,e],a=0}finally{o=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var o,a,s,r,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return r={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r},teamspace;!function(e){!function(t){var i;!function(e){e[e.Purple=0]="Purple",e[e.Native=1]="Native"}(i=t.NotificationStyle||(t.NotificationStyle={}));var n=function(n){function o(e,i,o,a,s,r,c,l,h,p,d,g,u,v,f,S,m,y,C,b,T,k,w,N,I,A,M,R,P,D,O,E,$,U,F,x,B,V,W){var H=n.call(this,i,l,o,u,f,p,g,C,S,k,w,m,y,b,T,d,s,P,B)||this;return H.$injector=e,H.$q=a,H.$rootScope=r,H.$state=c,H.notificationsStore=h,H.peopleService=v,H.chatListService=N,H.analyticsStateService=I,H.userAppsStore=A,H.navigationNotificationService=M,H.platformDetectService=R,H.messagingTelemetryService=D,H.authenticationService=O,H.$http=E,H.deviceManagerService=U,H.notificationsAuxiliaryService=F,H.profilePictureLoaderService=x,H.channelService=V,H.appsService=W,H.enableK2CollabNotifications=!1,H.enableK2M2Notifications=!1,H.enableK2MriTidNotifications=!1,H.enableNotificationSettingsInDesktop=!1,H.isDoNotDisturbEnabled=!1,H.defaultMacNativeMinSupportedOSVersion="10.15",H.updateTaskbarNotificationFlash=_.throttle(function(e){return __awaiter(H,void 0,void 0,function(){var t,i,n,o,a,s,r,c,l,h,p,d,g,u,v,f,S=this;return __generator(this,function(m){if(t=this.settingsService.valueFor(this.constants.settings.names.flashMWonNotifications),i=this.settingsService.valueFor(this.constants.settings.names.flashConversationUpdateLimit),this.badgeCounts.chat=this.chatListService.getUnreadCountFromChatList(),"v1"==t&&(!i||i<0||e&&e.length<i)){n=this.loggingService.newScenario(this.constants.scenarios.notifications.updateTaskbarNotification);try{if(o=this.chatListService.getUnreadVisibleChats(),e&&e.length>0){for(a=[],s=[],r=function(e){o.find(function(t){return t.id===e})?s.push(e):a.push(e)},c=0,l=e;c<l.length;c++)h=l[c],r(h);for(this.badgeCounts.chat=this.chatListService.countUnreadVisibleChats(),this.logger.info("unreadchat count "+s.length+" and readchat count "+a.length),p=0,d=a;p<d.length;p++)g=d[p],this.getConversationWindowId(g).then(function(e){return S.clearTaskbarWindowFlash(e)});for(0==s.length&&this.updateTaskbarBadge(this.getTotalBadgeCount()),u=0,v=s;u<v.length;u++)f=v[u],this.getConversationWindowId(f).then(function(e){return S.updateTaskbarBadge(S.getTotalBadgeCount(),e)})}else this.logger.info("no unread chats, not flashing"),this.updateTaskbarBadge(this.getTotalBadgeCount());n.stop({conversationCount:e&&e.length})}catch(t){this.logger.log("failure updating mw badge count: "+JSON.stringify(t)),this.updateTaskbarBadge(this.getTotalBadgeCount()),n.fail({errorMessage:this.utilityService.scrubEuii(JSON.stringify(t)),conversationCount:e&&e.length})}}else this.updateTaskbarBadge(this.getTotalBadgeCount());return[2]})})},1e3,{leading:!0,trailing:!0}),H.logger=u.newLogger("Notifications Service Desktop"),H.safeIpc=s.electronSafeIpc,$.registerAction(o.actions.notificationsService.startup,function(){try{return R.isElectronAppSurfaceHub()||("v1"==p.valueFor(o.settings.names.flashMWonNotifications)?t.MTMASubscriptionUtility.safeSubscribe(N,r,function(e,t){return H.updateTaskbarNotificationFlash(t)},t.ChatListServiceEvents.EventType_Batched):t.MTMASubscriptionUtility.safeSubscribe(N,r,function(){return H.updateTaskbarNotificationFlash()},t.ChatListServiceEvents.EventType_UnreadCount)),a.resolve()}catch(e){return a.reject(e)}}),$.registerForMtma(H),H.initializeOnAppLaunchAndReinit("First Initialize"),H.attachEvent(),p.valueAsBoolean(o.settings.names.taskbarIconFlashOffOnDND)&&H.subscribeForEvents(),H}return __extends(o,n),o.$inject=["$injector","ringtoneSettingService","constants","$q","$window","$rootScope","$state","eventingService","notificationsStore","settingsService","utilityService","routeUtilityService","loggingService","peopleService","notificationSettingsStore","audioService","resources","$translate","ariaLiveService","shortcutService","peopleTargetingService","conversationsService","hybridContentVisibilityManager","chatListService","analyticsStateService","userAppsStore","navigationNotificationService","platformDetectService","desktopUtilityService","messagingTelemetryService","authenticationService","$http","orchestrationService","deviceManagerService","notificationsAuxiliaryService","profilePictureLoaderService","localizationService","channelService","appsService"],o.prototype.initializeOnAppLaunchAndReinit=function(e){var i=this;this.logger.log("onAppReInit - {0}",e),this.isMacNativeNotificationSupported=!1,this.enableNativeNotificationReactionIcon=this.settingsService.valueAsBoolean(this.constants.settings.names.enableNativeNotificationReactionIcon),this.enableNotificationSettingsInDesktop=this.$window.desktopSettings.enableNotificationSettingsInDesktop,t.MTMAIpcUtility.onWithTenantScope(this.safeIpc,this.constants.events.desktopApp.notificationShown,function(e,t){i.onNotificationShown(t)}),t.MTMAIpcUtility.onWithTenantScope(this.safeIpc,this.constants.events.desktopApp.notificationUpdated,function(e,t){i.onNotificationUpdated(t)}),t.MTMAIpcUtility.onWithTenantScope(this.safeIpc,this.constants.events.desktopApp.notificationAudioRequest,function(e,t){i.playNotificationAudio(t)}),t.MTMAIpcUtility.onWithTenantScope(this.safeIpc,this.constants.events.desktopApp.notificationClicked,function(e,t,n,o,a){i.onNotificationClicked(t,n,o,a)}),t.MTMAIpcUtility.onWithTenantScope(this.safeIpc,this.constants.events.desktopApp.notificationTimeout,function(e,t){i.onNotificationTimeout(t)}),t.MTMAIpcUtility.onWithTenantScope(this.safeIpc,this.constants.events.desktopApp.notificationActionDismissed,function(e,t){i.onNotificationDismissed(t)}),t.MTMAIpcUtility.onWithTenantScope(this.safeIpc,this.constants.events.desktopApp.notificationActionTaken,function(e,t,n,o,a,s){i.onNotificationActionTaken(t,n,a,o,s)}),t.MTMAIpcUtility.onWithTenantScope(this.safeIpc,this.constants.events.desktopApp.inlineReplyMessage,function(e,t,n,o){i.onNotificationReplied(o)}),t.MTMAIpcUtility.onWithTenantScope(this.safeIpc,this.constants.events.desktopApp.notificationActionCancelled,function(e,t,n){i.onNotificationActionCancelled(t,n)}),t.MTMAIpcUtility.onWithTenantScope(this.safeIpc,this.constants.events.desktopApp.notificationActionNotShown,function(e,t){i.onNotificationActionNotShown(t)}),t.MTMAIpcUtility.onWithTenantScope(this.safeIpc,this.constants.events.desktopApp.sfbNotificationActionNotShown,function(e,t){i.onSfBNotificationActionNotShown(t)}),t.MTMAIpcUtility.onWithTenantScope(this.safeIpc,this.constants.events.desktopApp.notificationProcessFail,function(e,t,n,o){i.onNotificationProcessFail(t,n,o)}),this.desktopUtilityService.avIsRemoted()&&this.settingsService.valueAsBoolean(this.constants.settings.names.remoteVDINotifications)&&(t.MTMAIpcUtility.onWithTenantScope(this.safeIpc,this.constants.events.desktopApp.notificationAudioPlayed,function(e,t,n,o){i.logger.log("VDI: notificationAudioPlayed for audioId: "+t+", src: "+n+", isLoop: "+o);var a=i.deviceManagerService.getSelectedSpeakerApplicationDeviceId();window.vdi.setSinkId(t,a),window.vdi.setLoop(t,o),window.vdi.playNotifyAudio(t,n);var s=i.deviceManagerService.getSelectedSecondaryRingerDeviceId();if(s){var r=t+"_secondary";window.vdi.setSinkId(r,s),window.vdi.setLoop(r,o),window.vdi.playNotifyAudio(r,n)}}),t.MTMAIpcUtility.onWithTenantScope(this.safeIpc,this.constants.events.desktopApp.notificationAudioPaused,function(e,t){i.logger.log("VDI: notificationAudioPaused for audioId: "+t),window.vdi.pauseNotifyAudio(t),i.deviceManagerService.getSelectedSecondaryRingerDeviceId()&&window.vdi.pauseNotifyAudio(t+"_secondary")})),this.initializeNotficationsServiceBase(e),this.notificationHandlers={native:new Map,purple:new Map},this.cancellationHandlers=new Map,this.badgeCounts={activity:0,chat:0},this.chatsEnabled=!0,this.userAppsStore.register(this),t.MTMASubscriptionUtility.subscribe(this.notificationsStore,function(e,t){var n,o=SkypeX.Services.NotificationUtility.getClientOnlineTimestamp();void 0!=o&&t&&new Date(t.activityTimestamp).getTime()>o.getTime()+i.settingsService.valueFor(i.constants.telemetry.notification.clientStableBufferTimeForToastScenario)&&((n=i.loggingService.newScenario(i.constants.scenarios.notifications.e2eLatency.toastEndToEndTrackingOnWebClient)).eventData.context=JSON.stringify({isFromWebhook:!0,isSharedChannel:t.isSharedChannel})),i.createNotification(t,void 0,void 0,n)},this.constants.events.notifications.store.Type_NewActivitiesHydrated_Recent),this.eventingService.$onWithTenantScope(this.$rootScope,this.constants.events.notifications.bellCountUpdated,function(e,t){i.badgeCounts.activity=t,i.updateTaskbarBadge(i.getTotalBadgeCount())}),this.enableK2CollabNotifications=this.settingsService.valueAsBoolean(this.constants.settings.names.enableK2CollabNotifications),this.enableK2M2Notifications=this.enableK2CollabNotifications&&this.settingsService.valueAsBoolean(this.constants.settings.names.enableK2M2Notifications),this.enableK2MriTidNotifications=this.enableK2CollabNotifications&&this.settingsService.valueAsBoolean(this.constants.settings.names.enableK2MriTidNotifications)},o.prototype.attachEvent=function(){var e=this;this.platformDetectService.getOS()===this.constants.os.mac&&this.$window&&this.$window.desktopSettings&&this.$window.desktopSettings.enableMacNativeNotification&&(t.MTMAIpcUtility.onWithTenantScope(this.safeIpc,this.constants.events.desktopApp.toastStyleChoiceEnabledResponse,function(t,i){e.isMacNativeNotificationSupported=i}),this.safeIpc.send(this.constants.events.desktopApp.toastStyleChoiceEnabledRequest))},o.prototype.getConversationWindowId=function(e){var t=this,i=this.loggingService.newScenario(this.constants.scenarios.notifications.performTaskbarChatAction);return this.logger.info("Calling shouldshowchatnotification with "+e),this.hybridContentVisibilityManager.shouldShowChatNotification(e).then(function(e){var n=e&&e.windowId?e.windowId:void 0;return t.logger.info("got window id "+n+" from shouldshowchatnotification"),i.stop({status:"success",isPopoutWindow:!!n}),n}).catch(function(e){i.fail({status:"failure",errorMessage:t.utilityService.scrubEuii(JSON.stringify(e))}),t.updateTaskbarBadge(t.getTotalBadgeCount())})},o.prototype.getNotificationHandlers=function(e){return this.notificationHandlers.native.has(e)?this.notificationHandlers.native.get(e):this.notificationHandlers.purple.get(e)},o.prototype.deleteNotificationHandlers=function(e){this.notificationHandlers.native.has(e)?this.notificationHandlers.native.delete(e):this.notificationHandlers.purple.delete(e)},o.prototype.hasNotificationHandlers=function(e){return this.notificationHandlers.native.has(e)||this.notificationHandlers.purple.has(e)},o.prototype.cleanupOnAppTeardown=function(e){this.logger.log("onAppTeardown -- reason - {0}",e),this.cleanupNotficationsServiceBase(e),this.notificationHandlers=void 0,this.cancellationHandlers=void 0,this.lastBadgeCountSent=void 0,this.actionNotificationData=void 0,this.badgeCounts=void 0,this.chatsEnabled=void 0,this.isMacNativeNotificationSupported=!1,this.enableK2CollabNotifications=!1,this.enableK2M2Notifications=!1,this.enableK2MriTidNotifications=!1,this.enableNativeNotificationReactionIcon=!1,this.enableNotificationSettingsInDesktop=!1,this.isDoNotDisturbEnabled=!1},o.prototype.mtmaTelemetryIdentifier=function(){return"NotificationsServiceDesktopImplementation"},o.prototype.createToast=function(e,t,n,o){return this.platformDetectService.isRigel()?(this.logger.info("Skip all toasts for Teams on Rigel."),void SkypeX.Services.NotificationUtility.stopScenarioIfExists(o,{skipToastReason:"Skip all toasts for Teams on Rigel"})):this.platformDetectService.isElectronAppSurfaceHub()?(this.logger.info("Skip all in-app toasts for SurfaceHub."),void SkypeX.Services.NotificationUtility.stopScenarioIfExists(o,{skipToastReason:"Skip all in-app toasts for Teams on SurfaceHub"})):(this.createDesktopNotification(e,t,n,o),void(this.$window&&this.$window.desktopSettings&&this.$window.desktopSettings.enableNotificationAudioPlayInSync||this.isMacNativeNotificationSupported&&this.notificationsAuxiliaryService.getNotificationStyle()===i[i.Native].toString()?this.logger.info("control to play audio alert in desktop side"):this.playNotificationAudio(e)))},o.prototype.playNotificationAudio=function(e){var i=null,n=this.notificationSettingsStore.getAppUserSettings();e.notificationType===SkypeX.Services.NotificationType.Priority||e.notificationType===SkypeX.Services.NotificationType.NativeNotificationFre?i=this.primaryNotificationAudio:n&&e.notificationType&&n.soundsSettings.alertSound!==t.AlertSoundValue[t.AlertSoundValue.Off]&&(e.notificationType===SkypeX.Services.NotificationType.Mention||e.notificationType===SkypeX.Services.NotificationType.MentionInChat?e.notificationSubType===SkypeX.Services.NotificationSubType.Person?i=this.primaryNotificationAudio:e.notificationSubType!==SkypeX.Services.NotificationSubType.Channel&&e.notificationSubType!==SkypeX.Services.NotificationSubType.Team&&e.notificationSubType!==SkypeX.Services.NotificationSubType.Tag||(i=this.secondaryNotificationAudio):e.notificationType===SkypeX.Services.NotificationType.Chat?i=this.primaryNotificationAudio:e.notificationType!==SkypeX.Services.NotificationType.Reply&&e.notificationType!==SkypeX.Services.NotificationType.ReplyToReply&&e.notificationType!==SkypeX.Services.NotificationType.Like&&e.notificationType!==SkypeX.Services.NotificationType.LikeInChat&&e.notificationType!==SkypeX.Services.NotificationType.Reaction&&e.notificationType!==SkypeX.Services.NotificationType.ReactionInChat&&e.notificationType!=SkypeX.Services.NotificationType.Follow&&e.notificationType!=SkypeX.Services.NotificationType.MsGraph&&e.notificationType!=SkypeX.Services.NotificationType.ThirdParty||n.soundsSettings.alertSound===t.AlertSoundValue[t.AlertSoundValue.CallMentionChats]||(i=this.secondaryNotificationAudio)),i&&i.play()},o.prototype.onStateChanged=function(e){this.chatsEnabled=e.hasApp(this.constants.appId.chat),this.platformDetectService.isElectronAppSurfaceHub()||this.updateTaskbarNotificationFlash()},o.prototype.getFilteredDataForIpc=function(e){var t=__assign(__assign({},e),{primaryAction:__assign(__assign({},e.primaryAction),{action:null}),dismissAction:__assign(__assign({},e.dismissAction),{action:null}),timeoutAction:__assign(__assign({},e.timeoutAction),{action:null}),errorAction:__assign(__assign({},e.errorAction),{action:null}),actions:[],onNotificationShown:void 0,onNotificationUpdated:void 0});if(e.actions)for(var i=0;i<e.actions.length;i++)t.actions[i]=__assign(__assign({},e.actions[i]),{action:null});return this.enableNotificationSettingsInDesktop&&(delete t.notificationStyle,delete t.showPreviewInToasts),t},o.prototype.createNotificationWithActions=function(i,n){var o=this;SkypeX.Services.NotificationUtility.markScenarioIfExists(this.constants.scenarios.notifications.e2eLatency.markers.createNotificationWithActions,n);var a={notificationType:i&&i.trackingType,notificationStyle:i&&i.notificationStyle,webhookCorrelationId:i&&i.webhookCorrelationId};i&&i.sourceUserTenantId&&(a["UserInfo.ChannelResourceTenant.Id"]=i.sourceUserTenantId),void 0===n&&(n=this.loggingService.newScenario(this.constants.scenarios.notifications.e2eLatency.toastEndToEndTrackingOnWebClient),SkypeX.Services.NotificationUtility.setContextForScenarioIfExists(n,{isFromWebhook:!1})),this.actionNotificationData=i;var s=null;if(this.platformDetectService.isRigel())return this.logger.info("Disabling calling notification for Teams on Rigel."),SkypeX.Services.NotificationUtility.stopScenarioIfExists(n,{skipToastReason:"Disabling calling notification for Teams on Rigel"}),s;if(i){var r=this.utilityService.generateUUID();a.notificationId=r,this.populateRingtoneName(i),this.populateNotificationData(i);var c=(new Date).getTime();this.notificationsForConversation[i.sourceId]?this.notificationsForConversation[i.sourceId].push(r):this.notificationsForConversation[i.sourceId]=[r];var l={data:i,time:c};"Native"===i.notificationStyle?this.notificationHandlers.native.set(r,l):this.notificationHandlers.purple.set(r,l),s=new t.NotificationWithActions(this.$q,function(){return o.cancelNotification(r)},function(e){return o.updateNotification(r,e)}),this.cancellationHandlers.set(r,{cancelable:s,trackingType:i.trackingType,time:c}),this.desktopUtilityService&&this.desktopUtilityService.isIPCRendererListenerRemovalEnabled()?t.MTMAIpcUtility.onceWithTenantScope(this.safeIpc,this.constants.events.desktopApp.playNotificationAudio,function(e,t){var i={notificationType:t.skypexType,notificationSubType:t.skypexSubType};o.playNotificationAudio(i)}):t.MTMAIpcUtility.onWithTenantScope(this.safeIpc,this.constants.events.desktopApp.playNotificationAudio,function(e,t){var i={notificationType:t.skypexType,notificationSubType:t.skypexSubType};o.playNotificationAudio(i)});var h=this.notificationSettingsStore.getAppUserSettings();i.type==e.services.NotificationType.meetingWentLive&&(i.icon="icons-meeting-join"),SkypeX.Services.NotificationUtility.stopScenarioIfExists(n,a);var p=SkypeX.Services.NotificationUtility.getClientOnlineTimestamp().getTime()+this.settingsService.valueFor(this.constants.telemetry.notification.clientStableBufferTimeForToastScenario);this.enableNotificationSettingsInDesktop?this.safeIpc.send(this.constants.events.desktopApp.notificationAction,r,this.getFilteredDataForIpc(i),null,p):this.safeIpc.send(this.constants.events.desktopApp.notificationAction,r,this.getFilteredDataForIpc(i),h,p);var d={};d[this.constants.telemetry.notification.property.id]=r,d[this.constants.telemetry.notification.property.type]=i.trackingType,d[this.constants.telemetry.notification.property.hasHeader]=!!i.headerData,this.loggingService.event(this.constants.telemetry.notification.show,d),i.teamsCallId?this.logger.info("Created notification toast with ID: "+r+" for teamsCallId: "+i.teamsCallId+", [call][incomingCall][createCallToast][teamsCallId="+i.teamsCallId+"][notificationId="+r+"]"):this.logger.info("Created notification toast with ID: "+r),this.removeOldestNativeToastHandlerCheck()&&this.removeOldestNativeToastHandler()}return SkypeX.Services.NotificationUtility.failScenarioIfExists(n,{failToastReason:this.constants.scenarios.notifications.e2eLatency.toastFailReason.nullNotificationData}),s},o.prototype.removeOldestNativeToastHandlerCheck=function(){var e=this.settingsService.valueFor(this.constants.settings.names.maxNotificationHandlersForWindows);return this.platformDetectService.getOS()===this.constants.os.mac&&(e=this.settingsService.valueFor(this.constants.settings.names.maxNotificationHandlersForMac)),this.notificationHandlers.native.size>e},o.prototype.updateNotification=function(e,t){if(this.settingsService.valueAsBoolean(this.constants.settings.names.enableUpdatingCallToasts))if(e&&t){this.safeIpc.send(this.constants.events.desktopApp.notificationUpdate,e,this.getFilteredDataForIpc(t));var i={};i[this.constants.telemetry.notification.property.id]=e,i[this.constants.telemetry.notification.property.isTitleUpdated]=!!t.title,i[this.constants.telemetry.notification.property.isImageUpdated]=!!t.image,this.loggingService.event(this.constants.telemetry.notification.update,i);var n=t.teamsCallId||t.callId?"[call][incomingCall][updateCallToast][teamsCallId="+t.teamsCallId+"][callId="+t.callId+"]":"";this.logger.info("[updateNotification] Updated notification toast. [notificationId={0}]{1}",e,n)}else this.logger.warn("[updateNotification] Unable to update notification. Missing data.")},o.prototype.dismissNotification=function(e,i){var n=this,o=t.NotificationType.chat+"|"+e+"|"+i;this.notificationsForConversation[o]&&(_.each(this.notificationsForConversation[o],function(e){n.cancelNotification(e)}),delete this.notificationsForConversation[o]),this.actionNotificationData=null},o.prototype.createDesktopNotification=function(n,o,a,s){var r=this;SkypeX.Services.NotificationUtility.markScenarioIfExists(this.constants.scenarios.notifications.e2eLatency.markers.createDesktopNotification,s);var c=n.title,l=t.NotificationType.default,h=n.message,p=null,d=null,g=7,u=this.constants.telemetry.notification.type.default,v=null,f=!1,S=n.subtitle,m=n.usrObj,y=n.notificationType,C=n.sourceThreadId,b=n.linkParams,T=n.notificationSubType,k=n.message,w=n.activityId,_=n.skipIfSfBRunning,N=n.loggedInUserSip,I=n.linkState,A=n.notificationDataMTMA,M=n.showPreviewInToasts,R=n.webhookCorrelationId,P=n.activityTimestamp,D=this.parseTeamChannelFromLinkParams(b),O=!1,E="";switch(m&&(m.displayName&&y!==SkypeX.Services.NotificationType.Chat&&(c=m.displayName,this.settingsService.valueAsBoolean(this.constants.settings.names.enableAADFirstAndLastName)&&n.originalNotification&&n.originalNotification.activity&&n.originalNotification.activity.sourceUserImDisplayName&&(c=n.originalNotification.activity.sourceUserImDisplayName),O=!0),m.objectId?E=m.objectId:m.userPrincipalName&&(E=m.userPrincipalName)),y){case SkypeX.Services.NotificationType.Chat:l=t.NotificationType.chat,d=this.constants.icons.notification.chat,g=16,T===SkypeX.Services.NotificationSubType.SmsChat&&(d=this.constants.icons.notification.sms,c=this.$translate.instant(this.resources.strings.notifications_sms_toast_title_text,{displayName:c})),e.services.SfBInteropUtilsService.isSfBConversation(n.sourceThreadId)&&(d=this.constants.icons.notification.sfb),u=this.constants.telemetry.notification.type.chat,v=l+"|"+C+"|"+E;break;case SkypeX.Services.NotificationType.Reply:l=t.NotificationType.reply,O&&(c=this.$translate.instant(this.resources.strings.notifications_desktop_reply_title,{displayName:c})),D&&(h=D),d=this.constants.icons.notification.reply,u=this.constants.telemetry.notification.type.reply;break;case SkypeX.Services.NotificationType.ReplyToReply:l=t.NotificationType.replyToReply,O&&(c=this.$translate.instant(this.resources.strings.notifications_desktop_replytoreply_title,{displayName:c})),D&&(h=D),d=this.constants.icons.notification.reply,u=this.constants.telemetry.notification.type.replyToReply;break;case SkypeX.Services.NotificationType.Mention:case SkypeX.Services.NotificationType.MentionInChat:l=t.NotificationType.mention,T&&T===SkypeX.Services.NotificationSubType.Person?O&&(c=this.$translate.instant(this.resources.strings.notifications_desktop_mention_title,{displayName:c})):k&&k.length>0&&(c=k),D&&(h=D),y===SkypeX.Services.NotificationType.MentionInChat&&(h=this.parseGroupNameFromNotification(n)),d=T===SkypeX.Services.NotificationSubType.Channel?this.constants.icons.notification.channel:T===SkypeX.Services.NotificationSubType.Team?this.constants.icons.notification.teams:this.constants.icons.notification.mention,u=this.constants.telemetry.notification.type.mention;break;case SkypeX.Services.NotificationType.Like:case SkypeX.Services.NotificationType.LikeInChat:l=t.NotificationType.like,O&&(c=this.$translate.instant(this.resources.strings.notifications_desktop_like_title,{displayName:c})),D&&(h=D),y===SkypeX.Services.NotificationType.LikeInChat&&(h=this.parseGroupNameFromNotification(n)),d=this.constants.icons.notification.like,u=this.constants.telemetry.notification.type.like;break;case SkypeX.Services.NotificationType.Reaction:case SkypeX.Services.NotificationType.ReactionInChat:l=t.NotificationType.reaction;var $=this.notificationsAuxiliaryService.getNotificationStyle();!O||this.enableNativeNotificationReactionIcon&&$!==i[i.Purple].toString()||(c=this.$translate.instant(this.resources.strings.notifications_desktop_reaction_title,{displayName:c}));var U=this.enableNativeNotificationReactionIcon&&O&&$===i[i.Native].toString();switch(D&&(h=D),y===SkypeX.Services.NotificationType.ReactionInChat&&(h=this.parseGroupNameFromNotification(n)),n.notificationSubType){case SkypeX.Services.NotificationSubType.Angry:c=U?this.$translate.instant(this.resources.strings.notifications_desktop_reaction_title_with_icon,{displayName:c,reaction:this.$translate.instant(this.resources.strings.notifications_desktop_reaction_angry_icon)}):c,d=this.constants.icons.notification.reactionAngry,u=this.constants.telemetry.notification.type.reactionAngry;break;case SkypeX.Services.NotificationSubType.Heart:c=U?this.$translate.instant(this.resources.strings.notifications_desktop_reaction_title_with_icon,{displayName:c,reaction:this.$translate.instant(this.resources.strings.notifications_desktop_reaction_heart_icon)}):c,d=this.constants.icons.notification.reactionHeart,u=this.constants.telemetry.notification.type.reactionHeart;break;case SkypeX.Services.NotificationSubType.Laugh:c=U?this.$translate.instant(this.resources.strings.notifications_desktop_reaction_title_with_icon,{displayName:c,reaction:this.$translate.instant(this.resources.strings.notifications_desktop_reaction_laugh_icon)}):c,d=this.constants.icons.notification.reactionLaugh,u=this.constants.telemetry.notification.type.reactionLaugh;break;case SkypeX.Services.NotificationSubType.Like:c=U?this.$translate.instant(this.resources.strings.notifications_desktop_reaction_title_with_icon,{displayName:c,reaction:this.$translate.instant(this.resources.strings.notifications_desktop_reaction_like_icon)}):c,d=this.constants.icons.notification.reactionLike,u=this.constants.telemetry.notification.type.reactionLike;break;case SkypeX.Services.NotificationSubType.Sad:c=U?this.$translate.instant(this.resources.strings.notifications_desktop_reaction_title_with_icon,{displayName:c,reaction:this.$translate.instant(this.resources.strings.notifications_desktop_reaction_sad_icon)}):c,d=this.constants.icons.notification.reactionSad,u=this.constants.telemetry.notification.type.reactionSad;break;case SkypeX.Services.NotificationSubType.Surprised:c=U?this.$translate.instant(this.resources.strings.notifications_desktop_reaction_title_with_icon,{displayName:c,reaction:this.$translate.instant(this.resources.strings.notifications_desktop_reaction_surprised_icon)}):c,d=this.constants.icons.notification.reactionSurprised,u=this.constants.telemetry.notification.type.reactionSurprised;break;case SkypeX.Services.NotificationSubType.GenericReaction:c=U?this.$translate.instant(this.resources.strings.notifications_desktop_reaction_title_with_icon,{displayName:c,reaction:this.$translate.instant(this.resources.strings.notifications_desktop_reaction_generic_icon)}):c,d=this.constants.icons.notification.reactionGeneric,u=this.constants.telemetry.notification.type.reactionGeneric}break;case SkypeX.Services.NotificationType.TeamMembershipChange:if(u=this.constants.telemetry.notification.type.teamMemberChange,l=t.NotificationType.teamMembershipChange,T===SkypeX.Services.NotificationSubType.AddedToTeam)u=this.constants.telemetry.notification.type.addedToTeam,c=this.conversationsService.isPrivateChannel(C)?this.$translate.instant(this.resources.strings.notifications_privatechannel_toast_title,{actor:n.originalNotification.userProfile.displayName}):this.$translate.instant(this.resources.strings.notifications_team_toast_title),this.conversationsService.isPrivateChannel(C)&&(h=D.replace(this.$translate.instant(this.resources.strings.recent_conversations_teamChannelSeparator)," > ")),d=this.constants.icons.notification.addParticipant;else if(T===SkypeX.Services.NotificationSubType.PromotedToTeamAdmin)u=this.constants.telemetry.notification.type.promotedToTeamAdmin,this.conversationsService.isPrivateChannel(C)?(c=this.$translate.instant(this.resources.strings.notifications_privatechannel_or_sharedchannel_admin_toast_title,{actor:n.originalNotification.userProfile.displayName}),h=this.$translate.instant(this.resources.strings.notifications_privatechannel_sharedchannel_location_text,{teamName:b.groupName,channelName:b.slug})):c=this.$translate.instant(this.resources.strings.notifications_team_admin_toast_title),d=this.constants.icons.notification.promotedToTeamAdmin;else if(this.enableK2CollabNotifications&&T===SkypeX.Services.NotificationSubType.PromotedToSharedChannelOwner)u=this.constants.telemetry.notification.type.promotedToSharedChannelOwner,c=this.$translate.instant(this.resources.strings.notifications_privatechannel_or_sharedchannel_admin_toast_title,{actor:n.originalNotification.userProfile.displayName}),h=this.$translate.instant(this.resources.strings.notifications_privatechannel_sharedchannel_location_text,{teamName:b.groupName,channelName:b.slug}),d=this.constants.icons.notification.promotedToTeamAdmin;else if(this.enableK2CollabNotifications&&T===SkypeX.Services.NotificationSubType.AddedToSharedChannel)u=this.constants.telemetry.notification.type.addedToSharedChannel,c=this.$translate.instant(this.resources.strings.notifications_sharedchannel_toast_title,{actor:n.originalNotification.userProfile.displayName}),h=this.$translate.instant(this.resources.strings.notifications_privatechannel_sharedchannel_location_text,{teamName:b.groupName,channelName:b.slug}),d=this.constants.icons.notification.addedToSharedChannel;else if(T===SkypeX.Services.NotificationSubType.TeamShareTeamOwnerNotify)u=this.constants.telemetry.notification.type.teamShareTeamOwnerNotify,c=this.$translate.instant(this.resources.strings.notifications_teamShareTeamOwnerNotify_title,{actor:c}),h=this.$translate.instant(this.resources.strings.notifications_privatechannel_sharedchannel_location_text,{teamName:b.groupName,channelName:b.slug}),d=this.constants.icons.notification.teamShareTeamOwnerNotify;else if(T===SkypeX.Services.NotificationSubType.ChannelOwnerUnshareTeamOwnerNotify)u=this.constants.telemetry.notification.type.channelOwnerUnshareTeamOwnerNotify,c=this.$translate.instant(this.resources.strings.notifications_channelOwnerUnshareTeamOwnerNotify_title,{actor:c}),h=b.teamName,d=this.constants.icons.notification.channelOwnerUnshareTeamOwnerNotify;else if(T===SkypeX.Services.NotificationSubType.TeamOwnerUnshareChannelOwnerNotify)u=this.constants.telemetry.notification.type.teamOwnerUnshareChannelOwnerNotify,c=this.$translate.instant(this.resources.strings.notifications_teamOwnerUnshareChannelOwnerNotify_title,{actor:c}),h=this.channelService.getChannelByObjectId(C).displayName,d=this.constants.icons.notification.teamOwnerUnshareChannelOwnerNotify;else if(T===SkypeX.Services.NotificationSubType.HostOwnerUnshareChannelOwnerNotify){u=this.constants.telemetry.notification.type.hostOwnerUnshareChannelOwnerNotify;F=this.channelService.getChannelByObjectId(C).displayName;h=F,c=this.$translate.instant(this.resources.strings.notifications_hostOwnerUnshare_title,{actor:c,threadName:F}),d=this.constants.icons.notification.hostOwnerUnshareChannelOwnerNotify}else if(T===SkypeX.Services.NotificationSubType.HostOwnerUnshareTeamOwnerNotify){u=this.constants.telemetry.notification.type.hostOwnerUnshareTeamOwnerNotify;var F=n.sharedChannelName;h=F,c=this.$translate.instant(this.resources.strings.notifications_hostOwnerUnshare_title,{actor:c,threadName:F}),d=this.constants.icons.notification.hostOwnerUnshareTeamOwnerNotify}else SkypeX.Services.NotificationUtility.isJoinRequestSubType(T)&&(u=SkypeX.Services.NotificationUtility.isSponsoredJoinRequestSubType(T)?this.constants.telemetry.notification.type.pendingInvitedJoinRequest:this.constants.telemetry.notification.type.pendingSelfJoinRequest,c=h,h=n.originalNotification.displayChannelName,d=this.constants.icons.notification.addParticipant);break;case SkypeX.Services.NotificationType.Download:switch(u=this.constants.telemetry.notification.type.download,l=t.NotificationType.download,f=!0,T){case SkypeX.Services.NotificationSubType.DownloadStarted:d=this.constants.icons.notification.downloadStarted;break;case SkypeX.Services.NotificationSubType.Downloaded:d=this.constants.icons.notification.downloaded;break;case SkypeX.Services.NotificationSubType.DownloadFailed:d=this.constants.icons.notification.downloadFailed}break;case SkypeX.Services.NotificationType.Inferred:u=this.constants.telemetry.notification.type.inferred,l=t.NotificationType.inferred,d=this.constants.icons.notification.inferred,h=D,c=n.notificationSubType===SkypeX.Services.NotificationSubType.ChannelNewMessage?this.$translate.instant(this.resources.strings.notifications_inferred_newMessage_toastTitle,{actor:c}):this.$translate.instant(this.resources.strings.notifications_inferred_replyMessage_toastTitle,{actor:c});break;case SkypeX.Services.NotificationType.Follow:u=this.constants.telemetry.notification.type.follow,l=t.NotificationType.follow,d=this.constants.icons.notification.follow,h=D,c=n.notificationSubType===SkypeX.Services.NotificationSubType.ChannelNewMessage?this.$translate.instant(this.resources.strings.notifications_follow_newMessage_toastTitle,{actor:c}):this.$translate.instant(this.resources.strings.notifications_follow_replyMessage_toastTitle,{actor:c});break;case SkypeX.Services.NotificationType.Trending:u=this.constants.telemetry.notification.type.trending,l=t.NotificationType.trending,d=this.constants.icons.notification.trending,h=D,c=this.$translate.instant(this.resources.strings.notifications_trending_toastTitle,{actor:c});break;case SkypeX.Services.NotificationType.ThirdParty:u=this.constants.telemetry.notification.type.thirdparty,l=t.NotificationType.thirdparty,d=this.constants.icons.notification.thirdparty,c=this.$translate.instant(this.resources.strings.notifications_thirdparty_toastTitle,{actor:c});break;case SkypeX.Services.NotificationType.DLP:u=this.constants.telemetry.notification.type.dlp,l=t.NotificationType.dlp,d=this.constants.icons.notification.dlp,h=n.originalNotification.isChat?this.parseGroupNameFromNotification(n):D,c=this.$translate.instant(this.resources.strings.actor_reason_string_for_dlp);break;case SkypeX.Services.NotificationType.Priority:u=this.constants.telemetry.notification.type.priority,l=t.NotificationType.priority,d=this.constants.icons.notification.priority,g=16,n.usrObj&&n.usrObj.givenName&&(c=n.usrObj.givenName),c=this.$translate.instant(this.resources.strings.actor_reason_string_for_priority_feed_notification,{actor:c});break;case SkypeX.Services.NotificationType.MessageSendFailed:l=t.NotificationType.messageSendFailed,d=this.constants.icons.notification.messageSendFailed;break;case SkypeX.Services.NotificationType.Error:d=this.constants.icons.notification.error;break;case SkypeX.Services.NotificationType.PresenceStatus:l=t.NotificationType.presenceStatus;break;case SkypeX.Services.NotificationType.TeamsEngagementActivity:n.notificationSubType===SkypeX.Services.NotificationSubType.WelcomeNewUser&&(u=this.constants.telemetry.notification.type.welcomeNewUser,l=t.NotificationType.teamsEngagementActivity,d=this.constants.icons.notification.inferred,n.usrObj&&n.usrObj.givenName&&(c=n.usrObj.givenName),c=this.$translate.instant(this.resources.strings.actor_reason_string_for_welcome_user,{actor:c}));break;case SkypeX.Services.NotificationType.StaffHub:switch(l=t.NotificationType.StaffHub,h=n.originalNotification.isChat?this.parseGroupNameFromNotification(n):D,d=this.constants.icons.notification.teamsShifts,n.usrObj&&n.usrObj.givenName&&(c=n.usrObj.givenName),n.notificationSubType){case SkypeX.Services.NotificationSubType.NewShift:c=this.$translate.instant(this.resources.strings.teams_shifts_shift_assigned,{actor:c});break;case SkypeX.Services.NotificationSubType.SchedulePublished:c=this.$translate.instant(this.resources.strings.teams_shifts_schedule_published,{actor:c});break;case SkypeX.Services.NotificationSubType.NewShiftRequest:c=this.$translate.instant(this.resources.strings.teams_shifts_timeoff_requested,{actor:c});break;case SkypeX.Services.NotificationSubType.ShiftRequestUpdated:c=this.$translate.instant(this.resources.strings.teams_shifts_timeoff_updated,{actor:c});break;case SkypeX.Services.NotificationSubType.ShiftUpdated:c=this.$translate.instant(this.resources.strings.teams_shifts_shift_updated,{actor:c})}break;case SkypeX.Services.NotificationType.TeamsTasks:switch(l=t.NotificationType.TeamsTasks,h=n.originalNotification.isChat?this.parseGroupNameFromNotification(n):D,d=this.constants.icons.notification.teamsTasks,n.usrObj&&n.usrObj.givenName&&(c=n.usrObj.givenName),n.notificationSubType){case SkypeX.Services.NotificationSubType.TaskAssignedToYou:c=this.$translate.instant(this.resources.strings.teams_tasks_task_assigned,{actor:c});break;case SkypeX.Services.NotificationSubType.UrgentTaskAssignedToYou:c=this.$translate.instant(this.resources.strings.teams_tasks_urgent_task_assigned,{actor:c});break;case SkypeX.Services.NotificationSubType.YourTaskWasUpdated:c=this.$translate.instant(this.resources.strings.teams_tasks_task_updated,{actor:c});break;case SkypeX.Services.NotificationSubType.YourTaskChangedToNotStarted:c=this.$translate.instant(this.resources.strings.teams_tasks_task_not_started,{actor:c});break;case SkypeX.Services.NotificationSubType.YourTaskChangedToInProgress:c=this.$translate.instant(this.resources.strings.teams_tasks_task_in_progress,{actor:c});break;case SkypeX.Services.NotificationSubType.YourTaskChangedToCompleted:c=this.$translate.instant(this.resources.strings.teams_tasks_task_completed,{actor:c});break;case SkypeX.Services.NotificationSubType.YourTaskChangedToBlocked:c=this.$translate.instant(this.resources.strings.teams_tasks_task_blocked,{actor:c});break;case SkypeX.Services.NotificationSubType.YourTaskChangedToRemoved:c=this.$translate.instant(this.resources.strings.teams_tasks_task_removed,{actor:c});break;case SkypeX.Services.NotificationSubType.YourTaskChangedToNotApplicable:c=this.$translate.instant(this.resources.strings.teams_tasks_task_not_applicable,{actor:c});break;case SkypeX.Services.NotificationSubType.YourTaskWasReassigned:c=this.$translate.instant(this.resources.strings.teams_tasks_task_reassigned,{actor:c});break;case SkypeX.Services.NotificationSubType.YourTaskWasDeleted:c=this.$translate.instant(this.resources.strings.teams_tasks_task_deleted,{actor:c});break;case SkypeX.Services.NotificationSubType.TaskListPublishedToYourTeam:c=this.$translate.instant(this.resources.strings.teams_tasks_tasklist_published,{actor:c});break;case SkypeX.Services.NotificationSubType.TaskListRecalledFromYourTeam:c=this.$translate.instant(this.resources.strings.teams_tasks_tasklist_recalled,{actor:c});break;case SkypeX.Services.NotificationSubType.YourTaskWasMarkedUrgent:c=this.$translate.instant(this.resources.strings.teams_tasks_task_made_urgent,{actor:c});break;case SkypeX.Services.NotificationSubType.YourTaskWasMarkedNotUrgent:c=this.$translate.instant(this.resources.strings.teams_tasks_task_made_not_urgent,{actor:c});break;case SkypeX.Services.NotificationSubType.UrgentTaskPublishedToYourTeam:c=this.$translate.instant(this.resources.strings.teams_tasks_tasklist_published,{actor:c});break;case SkypeX.Services.NotificationSubType.TFLPlanCreated:c=this.$translate.instant(this.resources.strings.teams_tasks_tfl_plan_created,{actor:c});break;case SkypeX.Services.NotificationSubType.TFLTaskAssigned:c=this.$translate.instant(this.resources.strings.teams_tasks_tfl_task_assigned,{actor:c});break;case SkypeX.Services.NotificationSubType.TFLTaskUnassigned:c=this.$translate.instant(this.resources.strings.teams_tasks_tfl_task_unassigned,{actor:c});break;case SkypeX.Services.NotificationSubType.TFLTaskAssignedDeleted:c=this.$translate.instant(this.resources.strings.teams_tasks_tfl_task_assigned_deleted,{actor:c});break;case SkypeX.Services.NotificationSubType.TFLTaskAssignedMarkedCompleted:c=this.$translate.instant(this.resources.strings.teams_tasks_tfl_task_assigned_completed,{actor:c})}break;case SkypeX.Services.NotificationType.MsGraph:l=t.NotificationType.msGraph,c=n.title,h=n.message,d=this.settingsService.valueAsBoolean(this.constants.settings.names.enableGraphApiPhase2Enhancements)?null:this.constants.icons.notification.thirdparty,u=this.constants.telemetry.notification.type.msGraph;break;default:d=this.constants.icons.notification.default,this.logger.warn("unknown notification action type of "+y)}if(h&&0!==h.trim().length||(c=n.title),n.isMsGraphAppContextNotificationAssociatedWithTeamsApp&&n.teamsAppIconUrl){this.logger.info("isMsGraphAppContextNotificationAssociatedWithTeamsApp "+n.isMsGraphAppContextNotificationAssociatedWithTeamsApp),this.logger.info("teamsAppIconUrl "+n.teamsAppIconUrl);var x,B=window.stopBackgroundThrottling(function(e){e&&r.logger.info("[Notification data] disable background throttling"),x=r.loggingService.newScenario(r.constants.scenarios.toast.getBase64TeamsIcon),SkypeX.Services.NotificationUtility.markScenarioIfExists(r.constants.scenarios.toast.getBase64TeamsIcon,s)});this.getBase64Image(n.teamsAppIconUrl,"png").then(function(e){(p=e)?(r.actionNotificationData=r.createActionsNotificationData(l,c,S,h,p,d,f,g,v,C,w,u,I,b,n,o,a,_,N,y,T,void 0,R,P),r.handleImageSuccess(s,B,x,!0)):r.getBase64Image(n.teamsAppIconUrl,"png",!1).then(function(e){p=e,r.actionNotificationData=r.createActionsNotificationData(l,c,S,h,p,d,f,g,v,C,w,u,I,b,n,o,a,_,N,y,T,void 0,R,P),r.handleImageSuccess(s,B,x,!1)}).catch(function(e){r.handleImageFailure(s,B,x,e,!1)})}).catch(function(e){r.handleImageFailure(s,B,x,e,!0)})}else if(m&&m.userPrincipalName&&m.displayName&&y!==SkypeX.Services.NotificationType.Priority&&y!==SkypeX.Services.NotificationType.DLP){var V,W,H=[],L=void 0,z=n.isSharedChannel,X=void 0,j=window.stopBackgroundThrottling(function(e){e&&r.logger.info("[User/initial picture] disable background throttling"),z&&r.enableK2M2Notifications?(V=r.loggingService.newScenario(r.constants.scenarios.toast.getUserInitialPictureSharedChannel)).appendEventData({"UserInfo.ChannelResourceTenant.Id":W}):V=r.loggingService.newScenario(r.constants.scenarios.toast.getUserInitialPicture),SkypeX.Services.NotificationUtility.markScenarioIfExists(r.constants.scenarios.toast.getUserInitialPicture,s)}),q=void 0;if(m.isAnonymousUser||this.peopleService.isUnknownUser(m))q=this.peopleService.getUserInitialsPicture(m.displayName,this.constants.profilePictureSizes.small,"notificationsServiceDesktop");else{var G=void 0;if(A&&(G={tenantId:A.id,oid:A.currentUserIdInSecondaryTenant}),z){L=n.hostTenantId,X={isSharedChannel:z,conversationId:C,hostTenantId:L},W=SkypeX.Services.NotificationUtility.getSourceUserTenantId(n.originalNotification,L);var Q=m.mri;this.enableK2MriTidNotifications&&(Q=Q+"|"+W)}q=this.settingsService.valueAsBoolean(this.constants.settings.names.enableProfilePictureV2ForNotifications)?z&&this.enableK2M2Notifications?this.profilePictureLoaderService.getProfilePictureV2AsDataUri({mri:Q,displayName:m.displayName,principalName:m.userPrincipalName,size:this.constants.profilePictureSizes.small,source:"notificationsServiceDesktop",isSharedChannel:!0,hostTenantId:L,conversationId:C},!1,!0):this.profilePictureLoaderService.getProfilePictureV2AsDataUri({mri:m.mri,displayName:m.displayName,principalName:m.userPrincipalName,size:this.constants.profilePictureSizes.small,source:"notificationsServiceDesktop"},!1,!0):this.peopleService.isMSAProfilePictureEnabled()?z&&this.enableK2M2Notifications?this.peopleService.getUserProfilePicture({userId:m.userPrincipalName,displayName:m.displayName,imageUri:m.imageUri,mri:Q},"notificationsServiceDesktop",null,!0,!0,!0,G,X):this.peopleService.getUserProfilePicture({userId:m.userPrincipalName,displayName:m.displayName,imageUri:m.imageUri},"notificationsServiceDesktop",null,!0,!0,!0,G):z&&this.enableK2M2Notifications?this.peopleService.getUserProfilePicture({userId:m.userPrincipalName,displayName:m.displayName,mri:Q},"notificationsServiceDesktop",null,!0,!0,!0,G,X):this.peopleService.getUserProfilePicture({userId:m.userPrincipalName,displayName:m.displayName},"notificationsServiceDesktop",null,!0,!0,!0,G)}H.push(q),n&&n.usrObj&&n.usrObj.mri&&H.push(this.appsService.getUserInstalledAppFromBotId(n.usrObj.mri)),q.then(function(){r.updateGetProfilePicScenarioResult(V,j)}),q.catch(function(e){r.updateGetProfilePicScenarioResult(V,j,e,s)}),Promise.all(H).then(function(e){var t=e[0],i=e.length>1?e[1]:void 0,m=i&&i.appDefinition&&i.appDefinition.bots&&i.appDefinition.bots.length>0&&!!i.appDefinition.bots[0].isNotificationOnly;t&&(p=t),r.actionNotificationData=r.createActionsNotificationData(l,c,S,h,p,d,f,g,v,C,w,u,I,b,n,o,a,_,N,y,T,M,R,P),r.actionNotificationData.isNotificationOnlyBot=m,SkypeX.Services.NotificationUtility.markScenarioIfExists(r.constants.scenarios.notifications.e2eLatency.markers.createNotificationWithActions_withUserProfileImage,s),r.createNotificationWithActions(r.actionNotificationData,s)}).catch(function(e){r.logger.error("notificationService.desktop: createDesktopNotification - while creating notification: "+JSON.stringify(e)+".")})}else this.actionNotificationData=this.createActionsNotificationData(l,c,S,h,p,d,f,g,v,C,w,u,I,b,n,o,a,_,N,y,T,M,R,P),SkypeX.Services.NotificationUtility.markScenarioIfExists(this.constants.scenarios.notifications.e2eLatency.markers.createNotificationWithActions_withNullImage,s),this.createNotificationWithActions(this.actionNotificationData,s)},o.prototype.updateGetProfilePicScenarioResult=function(t,i,n,o){var a=this,s="";n?(s=JSON.stringify(n),this.logger.error("notificationService.desktop: createDesktopNotification - Get Profile Pic failed: "+s+".")):this.logger.info("notificationService.desktop: createDesktopNotification - Get Profile Pic Success"),i(function(i,r){i&&a.logger.info("[User/initial picture] try enable background throttling"),n?(t.fail({isLockReleased:r,reason:new e.services.PIIString(s).scrubbedValue}),o&&SkypeX.Services.NotificationUtility.failScenarioIfExists(o,{failToastReason:a.constants.scenarios.notifications.e2eLatency.toastFailReason.getUserInitialPictureException+new e.services.PIIString(n.message).scrubbedValue,isLockReleased:r})):t.stop({isLockReleased:r})})},o.prototype.getBase64Image=function(e,t,i){return void 0===i&&(i=!0),__awaiter(this,void 0,void 0,function(){var n;return __generator(this,function(o){switch(o.label){case 0:return n=void 0,[4,this.getAMSHeaders().then(function(t){var n={method:"GET",url:e,headers:t,responseType:"arraybuffer",withCredentials:i};return this.$http(n)}.bind(this)).then(function(e){var i=this.base64FromArrayBuffer(e.data);n="data:"+("image/"+t)+";base64,"+i}.bind(this)).catch(function(e){this.logger.warn("NotificationsService.Desktop: Error retrieving image for priority notifications. Error Code: "+e.status)}.bind(this))];case 1:return o.sent(),[2,n]}})})},o.prototype.handleImageSuccess=function(e,t,i,n){var o=this;SkypeX.Services.NotificationUtility.markScenarioIfExists(this.constants.scenarios.notifications.e2eLatency.markers.createNotificationWithActions_withTeamsAppImageForGraphAPI,e),this.createNotificationWithActions(this.actionNotificationData,e),t(function(e,t){e&&o.logger.info("[Notification data] try enable background throttling"),i.stop({isLockReleased:t,withCredentials:n})})},o.prototype.handleImageFailure=function(t,i,n,o,a){var s=this;i(function(i,r){i&&s.logger.info("[Notification data][catch] try enable background throttling"),n.fail({error:o,isLockReleased:r,withCredentials:a}),SkypeX.Services.NotificationUtility.failScenarioIfExists(t,{failToastReason:s.constants.scenarios.notifications.e2eLatency.toastFailReason.getBase64TeamsIconException+new e.services.PIIString(o.message).scrubbedValue,isLockReleased:r})})},o.prototype.base64FromArrayBuffer=function(e){var t="";return new Uint8Array(e).forEach(function(e){t+=String.fromCharCode(e)}),btoa(t)},o.prototype.getAMSHeaders=function(){var e=this,t=this.$q.defer();return this.authenticationService.getSkypeTokens().then(function(i){var n={};n[e.constants.headers.tokens.authorization]=e.constants.files.strings.skypeToken+i.skypeToken,n[e.constants.headers.accept]="*/*",n[e.constants.headers.contentType]=e.constants.headers.multipart,n[e.constants.headers.cacheControl]="no-cache, no-store",t.resolve(n)},function(e){t.reject()}),t.promise},o.prototype.createActionsNotificationData=function(i,n,o,a,s,r,c,l,h,p,d,g,u,v,f,S,m,y,C,b,T,k,w,_){var N=this,I={title:n,subtitle:o,type:i,message:a,image:s,icon:r,windowActionIconProperty:c,timeout:l,linkState:u,appId:f&&f.teamsAppId,skipIfSfBRunning:y,loggedInUserSip:C,notificationDataMTMA:f&&f.notificationDataMTMA,notificationStyle:void 0,showPreviewInToasts:k,activityId:d,showSquareImageInAvatar:i===t.NotificationType.msGraph&&f.isMsGraphAppContextNotificationAssociatedWithTeamsApp||!1,primaryAction:{action:function(){if(d&&(N.eventingService.$emit(N.constants.events.pushEvents.activityHub.toastClicked,d),N.startActivitySwitch(b,N.messagingTelemetryService)),S){var t={launchMethod:e.components.LaunchMethod.toast};N.analyticsStateService.setLaunchMethodState(t),S(u,v)}else N.settingsService.valueAsBoolean(N.constants.settings.names.enableThirdPartyNotificationReplyMention)?N.navigationNotificationService.navigateWithNotificationData(f,N.$rootScope):N.gotoState(u,v)}},dismissAction:{action:function(){m&&m(),N.actionNotificationData=null}},timeoutAction:null,errorAction:null,actions:[{action:function(){if(S){var t={launchMethod:e.components.LaunchMethod.toast};N.analyticsStateService.setLaunchMethodState(t),S(u,v)}N.actionNotificationData=null}}],trackingType:g,sourceId:h,sourceThreadId:p,skypexType:b,skypexSubType:T,webhookCorrelationId:w,activityTimestamp:_};return i===t.NotificationType.priority&&v&&v.messageId&&(I.messageIdForPriorityMessage=v.messageId),v&&v.messageId?I.messageId=v.messageId:f&&f.sourceMessageId&&(I.messageId=f.sourceMessageId),(this.desktopUtilityService.isDesktop()&&this.platformDetectService.getOS()===this.constants.os.windows&&"10"===this.platformDetectService.getOSVersion()||this.platformDetectService.getOS()===this.constants.os.mac&&this.macOSMinVersionCheck())&&(I.notificationStyle=this.notificationsAuxiliaryService.getNotificationStyle()),f&&f.isSharedChannel&&(I.sourceUserTenantId=SkypeX.Services.NotificationUtility.getSourceUserTenantId(f.originalNotification,f.hostTenantId)),I},o.prototype.macOSMinVersionCheck=function(){var e=parseInt(this.platformDetectService.getOSVersion()),t=this.platformDetectService.getOSMinorVersion(),i=this.platformDetectService.getOSPatchVersion();if(this.settingsService.valueAsBoolean(this.constants.settings.names.macNativeMinSupportedOSVersionECSCheck)){var n=(this.settingsService.valueFor(this.constants.settings.names.macNativeMinSupportedOSVersion)||this.defaultMacNativeMinSupportedOSVersion).split(".").map(function(e){return parseInt(e,10)}),o=this.settingsService.valueFor(this.constants.settings.names.macNativeUnsupportedOSVersions)||[];return!o.includes([e,t].join("."))&&!o.includes([e,t,i].join("."))&&(e==n[0]?t>=n[1]:e>n[0])}return 10===e&&t>=14},o.prototype.onNotificationClicked=function(e,t,i,n){if(this.logger.info("onNotificationClicked: Notification was Clicked for notificationId: "+e+"."),t&&this.eventingService.$emit(this.constants.events.pushEvents.activityHub.toastClicked,t),this.hasNotificationHandlers(e)){var o=this.getNotificationHandlers(e);this.deleteNotificationHandlers(e),o.click&&o.click(i,n)}else this.gotoState(i,n);this.actionNotificationData=null},o.prototype.gotoState=function(e,t){var i=angular.extend(t,{lm:this.constants.telemetry.analytics.launchMethod.toast});this.$state.go(e,i)},o.prototype.onNotificationShown=function(e){this.logger.info("onNotificationShown: Notification was shown for notificationId: "+e+".");var t=this.getNotificationHandlers(e);t&&t.data&&t.data.onNotificationShown&&t.data.onNotificationShown()},o.prototype.onNotificationUpdated=function(e){this.logger.info("onNotificationUpdated: Notification was update for notificationId: "+e+".");var t=this.getNotificationHandlers(e);t&&t.data&&t.data.onNotificationUpdated&&t.data.onNotificationUpdated()},o.prototype.onNotificationProcessFail=function(e,t,i){var n=this.getNotificationHandlers(e);n?(this.logger.info("onNotificationProcessFail: Notification with ID: "+e+". Has process throw exception: "+t+". IsPurpleNotification: "+i),n.data&&n.data.errorAction&&n.data.errorAction.action()):this.logger.info("onNotificationProcessFail: There are no handlers. Notification with ID: "+e+" should have been already removed")},o.prototype.onNotificationTimeout=function(e){this.logger.info("onNotificationTimeout: notification timeout for notificationId: "+e),this.deleteNotificationHandlers(e),this.actionNotificationData=null},o.prototype.onNotificationReplied=function(e){this.logger.info("onNotificationReplied: Reply action taken for notificationId: "+e),this.deleteNotificationHandlers(e),this.actionNotificationData=null},o.prototype.onNotificationDismissed=function(e){if(this.logger.info("onNotificationDismissed: OS notification dismiss attempted for notificationId: "+e),this.hasNotificationHandlers(e)){var t=this.getNotificationHandlers(e);if(this.deleteNotificationHandlers(e),t.data){var i=(new Date).getTime()-t.time,n={target:this.constants.telemetry.notification.target.dismiss,notificationAction:t.data.dismissAction};if(n.notificationAction){n.notificationAction.action();var o={};o[this.constants.telemetry.notification.property.id]=e,o[this.constants.telemetry.notification.property.type]=t.data.trackingType,o[this.constants.telemetry.notification.property.timeElapsed]=i,o[this.constants.telemetry.notification.property.target]=n.target,this.loggingService.event(this.constants.telemetry.notification.actionTaken,o)}else this.logger.warn("cannot take notification action. Target action doesn't exist for "+e)}else this.logger.warn("cannot take notification action. Action doesn't exist for "+e)}else this.logger.warn("cannot take notification action. Notification handler doesn't exist for "+e)},o.prototype.cancelNotification=function(e){return this.notificationHandlers||this.cancellationHandlers||this.actionNotificationData?(this.hasNotificationHandlers(e)&&this.deleteNotificationHandlers(e),this.cancellationHandlers.has(e)?(this.logger.info("Cancelled notification toast with ID: "+e+" and sent event to desktop"),this.safeIpc.send(this.constants.events.desktopApp.notificationActionCancel,e),!0):(this.logger.warn("cancelNotification: Cannot cancel notification. Handler doesn't exist for notification with ID: "+e),this.actionNotificationData=null,!1)):(this.logger.info("cancelNotification: There are no handlers. Notification with ID: "+e+" should have been already removed"),!1)},o.prototype.onNotificationActionTaken=function(e,t,i,n,o){if(void 0===i&&(i=""),void 0===n&&(n=""),void 0===o&&(o=!1),this.logger.info("onNotificationActionTaken: action taken for notificationId "+e+" actionId "+t),this.hasNotificationHandlers(e)){var a=this.getNotificationHandlers(e);if(this.deleteNotificationHandlers(e),t&&a.data){var s=(new Date).getTime()-a.time,r=this.getNotificationActionData(a.data,t);if(r&&r.notificationAction){r.notificationAction.action();var c={};c[this.constants.telemetry.notification.property.id]=e,c[this.constants.telemetry.notification.property.type]=a.data.trackingType,c[this.constants.telemetry.notification.property.timeElapsed]=s,c[this.constants.telemetry.notification.property.target]=r.target,this.loggingService.event(this.constants.telemetry.notification.actionTaken,c)}else this.logger.warn("cannot take notification action. Target action doesn't exist for "+e)}else this.logger.warn("cannot take notification action. Action doesn't exist for "+e)}else if(this.logger.warn("onNotificationActionTaken: cannot take notification action. Handler doesn't exist for "+e),o&&(n||i)){var l=this.$injector.get("messageNotificationService");l?l.navigateToConvByConvId(n,i):this.logger.warn("messageNotificationService is null")}this.cancellationHandlers.has(e)&&this.cancellationHandlers.delete(e),this.actionNotificationData=null},o.prototype.onNotificationActionCancelled=function(e,t){if(this.logger.info("Cancelling notification with ID: "+e),this.cancellationHandlers.has(e)){var i=this.cancellationHandlers.get(e);if(this.cancellationHandlers.delete(e),i.cancelable){var n=(new Date).getTime()-i.time;i.cancelable.complete(t);var o={};o[this.constants.telemetry.notification.property.id]=e,o[this.constants.telemetry.notification.property.type]=i.trackingType,o[this.constants.telemetry.notification.property.timeElapsed]=n,o[this.constants.telemetry.notification.property.status]=t?this.constants.telemetry.notification.property.status_completed:this.constants.telemetry.notification.property.status_failed,this.loggingService.event(this.constants.telemetry.notification.cancel,o)}}else this.logger.warn("onNotificationActionCancelled: Cannot cancel notification. Handler doesn't exist for notification with ID: "+e);this.actionNotificationData=null},o.prototype.onNotificationActionNotShown=function(e){if(this.logger.info("onNotificationActionNotShown: not shown notification for notificationId: "+e),this.hasNotificationHandlers(e)){var t=this.getNotificationHandlers(e);if(this.deleteNotificationHandlers(e),t.data){var i=(new Date).getTime()-t.time,n={};n[this.constants.telemetry.notification.property.id]=e,n[this.constants.telemetry.notification.property.type]=t.data.trackingType,n[this.constants.telemetry.notification.property.timeElapsed]=i,this.loggingService.event(this.constants.telemetry.notification.notShown,n)}}this.cancellationHandlers.has(e)&&this.cancellationHandlers.delete(e),this.actionNotificationData=null},o.prototype.onSfBNotificationActionNotShown=function(e){var t=this.getNotificationHandlers(e);if(this.logger.info("sfb notification not shown "+e),t.data){var i=(new Date).getTime()-t.time,n={};n[this.constants.telemetry.notification.property.id]=e,n[this.constants.telemetry.notification.property.type]=t.data.trackingType,n[this.constants.telemetry.notification.property.timeElapsed]=i,this.loggingService.event(this.constants.telemetry.notification.notShown,n)}},o.prototype.populateRingtoneName=function(e){_.isUndefined(e.ringtoneCallType)&&_.isNull(e.ringtoneCallType)||(e.ringtoneCallType===t.RingtoneCallType.CallGroup&&(this.logger.info("populating ringtone file name for call groups {0}",this.ringtoneNameCallGroup),e.ringtoneFile=this.ringtoneNameCallGroup),e.ringtoneCallType===t.RingtoneCallType.CallQueue&&(this.logger.info("populating ringtone file name for call queue, {0}",this.ringtoneNameCallQueue),e.ringtoneFile=this.ringtoneNameCallQueue),e.ringtoneCallType===t.RingtoneCallType.Delegate&&(this.logger.info("populating ringtone file name for Delegate ,{0}",this.ringtoneNameCallDelegate),e.ringtoneFile=this.ringtoneNameCallDelegate),e.ringtoneCallType===t.RingtoneCallType.Regular&&(this.logger.info("populating ringtone file name for Regular, {0}",this.ringtoneNameCallRegular),e.ringtoneFile=this.ringtoneNameCallRegular),e.ringtoneCallType===t.RingtoneCallType.MeetingStartedReminder&&(this.logger.info("populating ringtone file name for meetingstartedReminder, {0}",this.ringtoneNameCallMeetingReminder),e.ringtoneFile=this.ringtoneNameCallMeetingReminder))},o.prototype.populateNotificationData=function(e){if(e.primaryAction&&(e.primaryAction.id=this.utilityService.generateUUID()),e.dismissAction&&(e.dismissAction.id=this.utilityService.generateUUID()),e.timeout&&e.timeout>0&&!e.timeoutAction&&(e.timeoutAction={action:function(){}}),e.timeoutAction&&(e.timeoutAction.id=this.utilityService.generateUUID()),e.actions)for(var t=0;t<e.actions.length;t++)e.actions[t].id=this.utilityService.generateUUID()},o.prototype.getNotificationActionData=function(e,t){var i={target:"",notificationAction:null};if(e.primaryAction.id===t)i.target=this.constants.telemetry.notification.target.primary,i.notificationAction=e.primaryAction;else if(e.dismissAction&&e.dismissAction.id===t)i.target=this.constants.telemetry.notification.target.dismiss,i.notificationAction=e.dismissAction;else if(e.timeoutAction&&e.timeoutAction.id===t)i.target=this.constants.telemetry.notification.target.timeout,i.notificationAction=e.timeoutAction;else if(e.actions)for(var n=0;n<e.actions.length;n++)if(e.actions[n].id===t){i.target=n+1+"",i.notificationAction=e.actions[n];break}return i},o.prototype.removeOldestNativeToastHandler=function(){var e=this.notificationHandlers.native.keys().next().value;this.notificationHandlers.native.has(e)&&(this.notificationHandlers.native.delete(e),this.logger.info("removed orphaned handler for "+e)),this.cancellationHandlers.has(e)&&(this.cancellationHandlers.delete(e),this.safeIpc.send(this.constants.events.desktopApp.notificationActionCancel,e),this.logger.info("Removed orphaned cancellation handler and Cancelled notification toast with ID: "+e)),this.actionNotificationData=null},o.prototype.clearTaskbarWindowFlash=function(e){e&&this.safeIpc.send(this.constants.events.desktopApp.clearTaskbarWindowFlash,e)},o.prototype.updateTaskbarBadge=function(e,t){void 0===t&&(t=void 0);var i=this.settingsService.valueAsBoolean(this.constants.settings.names.enableOptimizedBadgeCount);this.settingsService.valueAsBoolean(this.constants.settings.names.taskbarIconFlashOffOnDND)||(this.isDoNotDisturbEnabled=!1),this.logger.info("previous badge count is "+this.lastBadgeCountSent+" and new badge count is "+e),i?(e!==this.lastBadgeCountSent||t)&&(this.safeIpc.send(this.constants.events.desktopApp.updateTaskbarBadgeCount,e,t,this.isDoNotDisturbEnabled),this.lastBadgeCountSent=e):this.safeIpc.send(this.constants.events.desktopApp.updateTaskbarBadgeCount,e,t,this.isDoNotDisturbEnabled)},o.prototype.getTotalBadgeCount=function(){var e=0;for(var t in this.badgeCounts){var i=this.badgeCounts[t];i&&angular.isNumber(i)&&(e+=this.badgeCounts[t])}return!this.chatsEnabled&&this.badgeCounts.chat&&(e-=this.badgeCounts.chat),e},o.prototype.subscribeForEvents=function(){var e=this;this.eventingService.unsafeOnWithTenantScope(this.constants.events.presence.myStatusChanged,function(t,i){var n=e.settingsService.valueAsBoolean(e.constants.settings.names.enableFlwPresence);e.isDoNotDisturbEnabled=i&&(SkypeX.Services.UserStatus.OutToLunch===i.status||SkypeX.Services.UserStatus.Presenting===i.status||SkypeX.Services.UserStatus.Focusing===i.status)||n&&SkypeX.Services.UserFlwPresence.OffShift===i.flwPresence})},o}(t.NotificationsService);t.NotificationsServiceDesktopImplementation=n,angular.module("teamspace.notificationsService",["teamspace.ariaLiveService","teamspace.notificationsAuxiliaryService","teamspace.notificationSettingsStore","teamspace.navigationNotificationService","teamspace.routeUtilityService","teamspace.audioService","teamspace.messagingTelemetryService","teamspace.hybridContentVisibilityManager","teamspace.profilePictureLoaderService","teamspace.localizationService","teamspace.appsService"]).service("notificationsService",n),angular.module("teamspace.notificationsServiceDesktop",["teamspace.ariaLiveService","teamspace.notificationsAuxiliaryService","teamspace.notificationSettingsStore","teamspace.routeUtilityService","teamspace.ringtoneSettingService","teamspace.audioService","teamspace.messagingTelemetryService","teamspace.deviceManagerService","teamspace.hybridContentVisibilityManager","teamspace.profilePictureLoaderService","teamspace.localizationService","teamspace.appsService"]).service("notificationsService",n)}(e.services||(e.services={}))}(teamspace||(teamspace={}));