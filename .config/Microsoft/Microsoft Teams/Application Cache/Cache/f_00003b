!function(e){"object"==typeof module&&module.exports?module.exports=e():window.vdiPeerConnection=e()}(function(e,t){"use strict";function n(e,t,n){var i=e.indexOf(t);if(-1==i)return e+t+"1_id#"+n;var r=e.substring(0,i),o=e.indexOf("_id#",i+t.length),a=Number(e.substring(i+t.length,o));return a=isNaN(a)?0:a,r+t+(a+1)+"_id#"+n}var i={NATIVE:0,CEF:1},r={createInstance:30,createInstanceResult:31,newVideoElement:32,removeVideoElement:33,updateVideoElement:34,newFrame:36,removeFrame:37,version:40,enumDevices:41,enumVideoDevice:42,createPeerConnection:43,createOffer:44,createAnswer:45,setLocalDescription:46,setRemoteDescription:47,addIceCandidate:48,addStream:49,getLocalStreams:50,getStats:51,removeStream:52,close:53,getUserMediaShim:54,mediaTrkStop:55,trackEnabled:56,newAudioElement:57,setSinkId:58,updateSrcObject:59,notifyAudio:60,mediaStreamClone:61,mediaTrackClone:62,getDisplayMediaShim:63,setDefaultSinkId:64,shimLogToWebSocket:65,insertDTMF:66,getReceivers:67,customClipRect:69,applyConstraints:70,getScreens:71,setScreenId:72,hidCmd:73,addTrack:74,removeTrack:75,senderCmd:76,createMediaStream:77,connectedStateChanged:78,updateObjectFit:79,transceiverCmd:300,dataChannelCmd:301},o={ERROR:0,WARN:1,INFO:2,DEBUG:3},a={DISCONNECTED:0,PENDING:1,CONNECTED:2},s={DURATION:100,INTERTONEGAP:70},d={SSRC:0,CSRC:1},c={ADD:0,REMOVE:1,UPDATE:2},u={SENDERCMD_SET_PARAMETERS:1,SENDERCMD_REPLACE_TRACK:2},l={PLAN_B:"plan-b",UNIFIED_PLAN:"unified-plan"},h={TRANSCEIVER_ADD_TRANSCEIVER:1,TRANSCEIVER_SET_CODECPREFERENCE:2,TRANSCEIVER_STOP:3,TRANSCEIVER_SET_DIRECTION:4},f={PENDING:0,COMPLETED:1,DESTROYED:2},v={RSPF_DEGRADATION_PREFERENCE:1,RSPF_ENCODEINGS:2,RSPF_PRIORITY:4,RSPF_TRANSACTION_ID:16},g={RPF_ACTIVE:1,RPF_CODEPAYLOADTYPE:2,RPF_DTX:4,RPF_MAXBITRATE:8,RPF_MAXFRAMERATE:16,RPF_PTIME:32,RPF_RID:64,RPF_SCALE_RESOLUTION_DOWNBY:128},p={POWEREVENT_SUSPEND:0,POWEREVENT_RESUME:1},m={v0:0,v1:1},b={DIFFERENCE:1,COMPRESSION:2,PROMISE:4},S={AGENT_TEXT:1,AGENT_BINARY:2,CLIENT_TEXT:4,CLIENT_BINARY:8,CLIENT_BOUNDS:16,BOUNDS:32},C="1.0.";C+="@"==="18669004"[0]?"00000":"18669004";var E=-1,y=0,R=0,T=0,_=0,k=0,I=0,w={},O={},P={},D={},M={},N=window.navigator.mediaDevices.enumerateDevices,A=i.CEF,V=null,F=null,j={},L={},x={},W={},U={},B=null,H=null,G=[],J=[],z={},X={},q={},Y={logLevel:o.DEBUG,websocketlogLevel:o.INFO,logToConsole:!1,updateLogLevel:function(e,t){Y.logLevel=e,Y.websocketlogLevel=t},error:function(e){Y.log("ERROR",e),H&&"function"==typeof H.error&&H.error(e)},warn:function(e){Y.log("WARN",e),H&&"function"==typeof H.warn&&H.warn(e)},info:function(e){Y.log("INFO",e),H&&"function"==typeof H.info&&H.info(e)},debug:function(e){Y.log("DEBUG",e)},log:function(e,t){try{o[e]<=Y.logLevel&&(Y.logToConsole&&console&&("object"==typeof t?console.log(t):console.log(e+": "+t)),"string"==typeof t&&o[e]<=Y.websocketlogLevel&&B.sendLogToWebSocket(t,e))}catch(e){}}},K=function(e){setTimeout(e,0)},Q=function(e){return e},Z=function(e){if(z.multiwindow&&B){var t=Q(e);t?X[t]?Y.debug("ensureFrame skipped due to frame already registered."):(B.send({cmd:"newFrame",frame:t,browser:"electron",customClipRect:1},-1),X[t]=e):Y.debug("ensureFrame skipped due to no frameWnd")}else Y.debug("ensureFrame skipped due to feature not enabled or no connection.")},$=function(e){if(z.multiwindow&&B){var t=Q(e);t?X[t]?(B.send({cmd:"removeFrame",frame:t},-1),delete X[t]):Y.info("removeFrame skipped due to frame is not registered."):Y.error("removeFrame skipped due to no frameWnd")}else Y.error("removeFrame skipped due to feature not enabled or no connection.")},ee=function(e,t){var n=this,i={},r={},o={},a=!1;this.id=++E,this._localStreams=[],this._remoteStreams=[],this._dataChannelMap={},this._dataChannelIdToShimIdMap={},this._iceConnectionState="new";!function(e,t){e&&e.sdpSemantics===l.UNIFIED_PLAN&&(a=!0)}(e);var s=function(){return a};this.isUnifiedPlan=function(){return s()},Object.defineProperty(this,"iceConnectionState",{get:function(){return Y.debug("get iceConnectionState:"+this._iceConnectionState),this._iceConnectionState},configurable:!0}),this._iceGatheringState="new",Object.defineProperty(this,"iceGatheringState",{get:function(){return Y.debug("get iceGatheringState:"+this._iceGatheringState),this._iceGatheringState},configurable:!0}),this._signalingState="stable",Object.defineProperty(this,"signalingState",{get:function(){return Y.debug("get signalingState:"+this._signalingState),this._signalingState},configurable:!0}),this._connectionState="new",z.connectionState&&Object.defineProperty(this,"connectionState",{get:function(){return Y.debug("get connectionState:"+this._connectionState),this._connectionState},configurable:!0}),this._localDescription=null,Object.defineProperty(this,"localDescription",{get:function(){return Y.debug("get localDescription:"+this._localDescription),this._localDescription},configurable:!0}),this._remoteDescription=null,Object.defineProperty(this,"remoteDescription",{get:function(){return Y.debug("get remoteDescription:"+this._remoteDescription),this._remoteDescription},configurable:!0}),this.cleanUp=function(){if("complete"!==this._iceGatheringState){t={type:"icecandidate",candidate:null,target:this};this.onicecandidate&&this.onicecandidate(t),this._iceGatheringState="complete";var e={type:"icegatheringstatechange",target:this};this.onicegatheringstatechange&&this.onicegatheringstatechange(e)}if("disconnected"!=this._iceConnectionState){this._iceConnectionState="disconnected";var t={type:"iceconnectionstatechange",target:this};this.oniceconnectionstatechange&&this.oniceconnectionstatechange(t)}this._localStreams=[],this._remoteStreams=[]};var d=function(){return arguments.length>=1&&"function"==typeof arguments[0]},c=function(){return arguments.length>=2&&"function"==typeof arguments[1]},u=function(e,t,i,r){return new Promise(function(o,a){var s=new DOMException("createOffer cancelled","OperationError"),d=new DOMException("The RTCPeerConnection is closed","InvalidStateError"),c=e?o:i,u=e?a:r;B.send({cmd:"createOffer",options:t},n.id,function(e){O[n.id]?void 0===e.error?(Y.debug("createOffer done"),Y.debug(e.desc),e.transceivers&&y(e.transceivers),c(e.desc)):u(s):u(d)})})};this.createOfferV0=function(e,t,n){u(m.v0,n,e,t)},this.createOfferV1=function(){if(d.apply(null,arguments))return this.createOfferV0.apply(this,arguments);var e=arguments[0];return u(m.v1,e)};var f=function(e,t,i,r){return new Promise(function(o,a){var s=new DOMException("createAnswer cancelled","OperationError"),d=new DOMException("The RTCPeerConnection is closed","InvalidStateError"),c=e?o:i,u=e?a:r;B.send({cmd:"createAnswer",options:t},n.id,function(e){O[n.id]?void 0===e.error?(Y.debug("createAnswer done"),Y.debug(e.desc),e.transceivers&&y(e.transceivers),c(e.desc)):u(s):u(d)})})};this.createAnswerV0=function(e,t,n){f(m.v0,n,e,t)},this.createAnswerV1=function(){if(d.apply(null,arguments))return this.createAnswerV0.apply(this,arguments);var e=arguments[0];return f(m.v1,e)};var v=function(e,t,i,r){return n._remoteDescription=t,new Promise(function(o,a){var s=new DOMException("setRemoteDescription cancelled","OperationError"),d=new DOMException("The RTCPeerConnection is closed","InvalidStateError"),c=e?o:i,u=e?a:r;B.send({cmd:"setRemoteDescription",desc:t},n.id,function(e){O[n.id]?void 0===e.error?(e.transceivers&&y(e.transceivers,e.transceiversRemoved),c()):u(s):u(d)})})};this.setRemoteDescriptionV0=function(e,t,n){v(m.v0,e,t,n)},this.setRemoteDescriptionV1=function(){if(c.apply(null,arguments))return this.setRemoteDescriptionV0.apply(this,arguments);var e=arguments[0];return v(m.v1,e)};var g=function(e,t,i,r){return n._localDescription=t,new Promise(function(o,a){var s=new DOMException("setLocalDescription cancelled","OperationError"),d=new DOMException("The RTCPeerConnection is closed","InvalidStateError"),c=e?o:i,u=e?a:r;B.send({cmd:"setLocalDescription",desc:t},n.id,function(e){O[n.id]?void 0===e.error?(e.transceivers&&y(e.transceivers,e.transceiversRemoved),c()):u(s):u(d)})})};this.setLocalDescriptionV0=function(e,t,n){g(m.v0,e,t,n)},this.setLocalDescriptionV1=function(){if(c.apply(null,arguments))return this.setLocalDescriptionV0.apply(this,arguments);var e=arguments[0];return g(m.v1,e)};var p=function(e,t,i,r){return new Promise(function(o,a){var s=new DOMException("addIceCandidate cancelled","OperationError"),d=new DOMException("The RTCPeerConnection is closed","InvalidStateError"),c=e?o:i,u=e?a:r;B.send({cmd:"addIceCandidate",candidate:t},n.id,function(e){O[n.id]?void 0===e.error?c():u(s):u(d)})})};this.addIceCandidateV0=function(e,t,n){p(m.v0,e,t,n)},this.addIceCandidateV1=function(){if(c.apply(null,arguments))return this.addIceCandidateV0.apply(this,arugments);var e=arguments[0];return p(m.v1,e)},this.createDTMFSender=function(e){if("audio"!==e.kind)return Y.error("DTMF only could be associated with audio track."),null;var t=new oe;return t.initPlanB(n.id,e),M[e.id]=t,t};var S=function(e,t){return new Promise(function(i,r){new DOMException("getStats cancelled","InvalidAccessError");var o=e?i:t,a={cmd:"getStats"};e==m.v1&&(a.capability=b.PROMISE),B.send(a,n.id,function(t){if("function"==typeof o)if(void 0===t.error&&void 0!==t.stats&&void 0!==O[n.id])if(e==m.v1)o(t.stats);else{var i=new ie;i._create(t.stats),o(i)}else o({})})})};this.getStatsV0=function(e){return S(m.v0,e)},this.getStatsV1=function(){return d.apply(null,arguments)?this.getStatsV0.apply(this,arguments):S(m.v1)},this.getLocalStreams=function(){return s()?(Y.warn("getLocalStreams is not supported in the unified plan, use getSenders()"),[]):(Y.debug("getLocalStreams():"+this._localStreams.length),this._localStreams)},this.getRemoteStreams=function(){return s()?(Y.warn("getRemoteStreams is not supported in the unified plan, use getReceivers()"),[]):(Y.debug("getRemoteStreams():"+this._remoteStreams.length),this._remoteStreams)},this.addStream=function(e){this._localStreams.push(e),B.send({cmd:"addStream",sid:e.id},n.id)},this.removeStream=function(e){Y.debug("RTCPeerConnection.removeStream(): "+e.id);var t=this._localStreams.indexOf(e);-1!=t?this._localStreams.splice(t,1):Y.error("RTCPeerConnection.removeStream(): Failed to find stream: "+e.id),B.send({cmd:"removeStream",sid:e.id},n.id)};var C=function(e){e&&e.forEach(function(e){var t=r[e.id];t&&t.update(e)})};this.addTrackImplV1=function(e,t){if(!e||!t)throw new Error("both media track and stream need to be provided");if(s()){var i=new ue(n);return i.initTrackOrKind(e),o[i.id]=i,(a=i.sender).setTrack(e,t),B.send({cmd:"addTrack",transceiverId:i.id,tid:e.id,sid:t.id},n.id,function(e){void 0===e.error?y(e.transceivers):delete o[i.id]}),a}var a=r[e.id];return a?(Y.warn("RTCPeerConnection.addTrack: sender already exists."),a):((a=new se(n)).initPlanB(e,t),r[a.id]=a,B.send({cmd:"addTrack",transceiverId:"",tid:e.id,sid:t.id},n.id,function(e){void 0===e.error||delete r[a.id]}),a)},this.removeTrackImplV1=function(e){e?void 0!==e._cap?e.id?(e.removeTrack(),s()||delete r[e.id]):Y.error("RTCPeerConnection.removeTrack: not a valid sender object"):Y.error("sender object doesn't have the capability bits"):Y.error("RTCPeerConnection.removeTrack: invalid sender.")},this.getSendersImplV1=function(){Y.debug("RTCPeerConnection.getSendersImplV1");var e=[];if(s())for(var t in o){var n=o[t].sender;n&&e.push(n)}else for(var t in r)r[t]&&e.push(r[t]);return e},this.getTranceiversImplV1=function(){Y.debug("RTCPeerConnection.getTranceiversImplV1");var e=[];for(var t in o)Y.debug("RTCPeerConnection.getTranceiversImplV1 id="+t),e.push(o[t]);return e},this.addTransceiverImplV1=function(e,t){var i=new ue(n);i.initTrackOrKind(e,t),o[i.id]=i;var r={cmd:"transceiverCmd",transceiverCmd:h.TRANSCEIVER_ADD_TRANSCEIVER,hint:"RTCRtpTransceiver.addTransceiver",transceiverId:i.id};if("audio"===e||"video"===e)r.trackOrKind=e;else{if(!(e instanceof ne))return Y.error("addTranceiver: Unknown type"),null;Y.debug("addTranceiver with track is not Implemented"),r.trackOrKind=e.id}var a={};if(t.direction&&(a.direction=t.direction),t.sendEncodings&&(a.sendEncodings=t.sendEncodings),t.streams){streamIds=[];for(var s in t.streams)streamIds.push(s.id);a.streams=streamIds}return r.init=a,B.send(r,n.id,function(e){void 0===e.error&&y(e.transceivers)}),i},this.createDataChannelImplV1=function(e,t){if(Y.debug("RTCPeerConnection.createDataChannel: "+e+" option: "+JSON.stringify(this.options)),!e)return Y.error("RTCPeerConnection.createDataChannel: missing label"),null;var i=++I,r=new be(n.id,i);return r._createChannel(e,t),n._dataChannelMap[i]=r,r},this._untrackDataChannel=function(e,t){void 0!==t&&n._dataChannelMap[t]&&(Y.debug("Untrack datachannel: "+e+" shimId: "+t),delete n._dataChannelMap[t]),-1!=e&&n._dataChannelIdToShimIdMap[e]&&(Y.debug("Remove mapped datachannel: "+e+" shimId:"+t),delete n._dataChannelIdToShimIdMap[e])};var y=function(e,t){for(var i in e){var r=e[i],a=o[r.id];if(a)a.update(r);else{var s=r.id;Y.debug("_updateTransceivers: addTransceiver id="+s);var d=new ue(n);d.initId(s),o[s]=d,d.update(r)}}if(t)for(var i in t){var c=t[i];Y.debug("_updateTransceivers: removeTransceiver id="+c),delete o[c]}};this.close=function(){R=null,B.send({cmd:"close"},n.id,function(e){delete O[n.id]},!0)};var R=null,T=function(e){e&&e.forEach(function(e){if(e.id){var t=e.id;if("-"===e.op)delete R[t];else{"+"===e.op&&delete R[t];var n=R[t];n||(n=new ae,R[t]=n),n.update(e)}}})};this.getReceivers=function(){if(s()){i=[];if(!o)return i;for(var e in o){var t=o[e].receiver;t&&i.push(t)}return i}R||(R={},B.send({cmd:"getReceivers"},n.id,function(e){},!0));var i=[];for(var e in R)R[e]&&i.push(R[e]);return i},this.addEventListener=function(e,t){Y.debug("RTCPeerConnection.addEventListener(): "+e),"function"==typeof t?"string"==typeof e?(void 0===i[e]&&(i[event]={listeners:[]}),i[e].listeners.push(t)):Y.error("RTCPeerConnection.addEventListener(): The event name is invalid."):Y.error("RTCPeerConnection.addEventListener(): The listener handler is invalid.")},this.removeEventListener=function(e,t){Y.debug("RTCPeerConnection.removeEventListener(): "+e),void 0!==i[e]?i[e].listeners=i[e].listeners.filter(function(e){return e.toString()!==t.toString()}):Y.error("RTCPeerConnection.removeEventListener(): Event does not exist = "+e)},this._onReceiveDataChannelEvent=function(e){if(void 0!==e.shimId){var t=e.shimId;-1==t&&e.channel&&void 0!==e.channel.id&&(Y.debug("Try to find mapped "+e.channel.id+" in:"+JSON.stringify(n._dataChannelIdToShimIdMap)),void 0!==n._dataChannelIdToShimIdMap[e.channel.id]&&(t=n._dataChannelIdToShimIdMap[e.channel.id],Y.debug("RTCPeerConnection._onReceiveDataChannelEvent: use mapped shimId: "+t))),-1!=t&&n._dataChannelMap[t]?n._dataChannelMap[t]._onReceiveEvent(e):Y.error("RTCPeerConnection._onReceiveDataChannelEvent: dataChannle "+t+" not existed")}else Y.error("RTCPeerConnection._onReceiveDataChannelEvent: missing shimId")},this._onReceiveEvent=function(e){if(void 0!==e&&void 0!==e.evt){var t={type:e.evt,target:this};switch(e.details&&this._updateVars(e.details),e.evt){case"connectionstatechange":this.onconnectionstatechange&&this.onconnectionstatechange(t);break;case"negotiationneeded":this.onnegotiationneeded&&this.onnegotiationneeded(t);break;case"icecandidate":t.candidate=e.candidate,this.onicecandidate&&this.onicecandidate(t);break;case"icegatheringstatechange":this.onicegatheringstatechange&&this.onicegatheringstatechange(t);break;case"iceconnectionstatechange":this.oniceconnectionstatechange&&this.oniceconnectionstatechange(t);break;case"signalingstatechange":this.onsignalingstatechange&&this.onsignalingstatechange(t);break;case"ondatachannel":if(!e.channel){Y.warn("ondatachannel from legacy client");break}if(this.ondatachannel){var i=++I,r=new be(n.id,i);void 0!==e.channel.id&&(Y.debug("ondatachannel shimId: "+e.channel.id+" mapped to "+i),n._dataChannelIdToShimIdMap[e.channel.id]=i),n._dataChannelMap[i]=r,r._updateChannel(e.channel),t.channel=r,Y.debug("ondatachannel shimId: "+i+" channel:"+JSON.stringify(e.channel)),this.ondatachannel(t)}break;case"addStream":if(void 0===e.stream){Y.debug("_onReceiveEvent(): stream property is invalid.");break}t.stream=new te,t.stream._create(e.stream),this._remoteStreams.push(t.stream),this.onaddstream&&this.onaddstream(t);break;case"removeStream":if(void 0===e.stream){Y.debug("_onReceiveEvent(): stream property is invalid.");break}if(t.stream=D[e.stream],void 0===t.stream){Y.debug("_onReceiveEvent(): no stream found.");break}var a=this._remoteStreams.indexOf(t.stream);-1!=a&&(e.trackId&&t.stream.removeTrackById(e.trackId),this._remoteStreams.splice(a,1)),this.onremovestream&&this.onremovestream(t);break;case"ontrack":if(void 0===e.transceiver||void 0===e.stream){Y.error("_onReceiveEvent ontrack property is invalid");break}u=e.transceiver.id;(l=o[u])||(Y.debug("ontrack: add transceiver id="+u),(l=new ue(n)).initId(u),o[u]=l),l.update(e.transceiver);var d=new te;d._create(e.stream),this._remoteStreams.push(d),t.transceiver=l,t.receiver=l.receiver,t.streams=[d],t.track=d.track[0],this.ontrack&&this.ontrack(t);break;case"tonechange":var c=null;if(s()){var u=e.transceiverId,l=o?o[u]:null,h=l?l.sender:null;c=h?h.dtmf:null}else c=M[e.tid];if(!c){Y.debug("_onReceiveEvent(): tonechange, dtmfId is invalid  or not found.");break}c.ontonechange&&c.ontonechange(e);break;case"onreceivers":T(e.receivers);break;case"onsenders":C(e.senders);break;case"ontransceivers":y(e.transceivers)}}else Y.error("_onReceiveEvent(): evt property is invalid.")},this._updateVars=function(e){e.iceConnectionState&&(this._iceConnectionState=e.iceConnectionState),e.iceGatheringState&&(this._iceGatheringState=e.iceGatheringState),e.signalingState&&(this._signalingState=e.signalingState),e.connectionState&&(this._connectionState=e.connectionState),e.localDescription&&(this._localDescription=e.localDescription),e.remoteDescription&&(this._remoteDescription=e.remoteDescription)}},te=function(e){var t=this,i={};this._objectId=++T,this.id="",this.active=!1,this.ended=!1,this.cloned=null,this.track=[],this.createMediaStream=function(e){if(void 0===e||Array.isArray(e)){this.id="Stream#"+t._objectId;var n=e;Y.debug("MediaStream.createMediaStream() with "+t.id+"MediaStreamTracks num ="+!n?0:n.length),this.active=!1,this.track=[],void 0!==n&&n.forEach(function(e){e&&e instanceof ne&&t.track.push(e)}),B.send({cmd:"createMediaStream",sid:t.id,tracks:t.track},-1)}else Y.debug("MediaStream.createMediaStream failed with invalid parameter")},this._create=function(e){this.id=e.id,this.active=e.active,this.track=[],e.track.forEach(function(e){var n=new ne;n._create(e),t.track.push(n)}),D[this.id]=this},this.dispatchEvent=function(e){Y.debug("MediaStream.dispatchEvent(): "+e.type),void 0!==i[event.type]&&i[event.type].listeners.forEach(function(t){t(e)}),"active"===e.type?this.onactive&&this.onactive(e):"addtrack"===e.type?this.onaddtrack&&this.onaddtrack(e):"inactive"===e.type?this.oninactive&&this.oninactive(e):"removetrack"===e.type?this.onremovetrack&&this.onremovetrack(e):Y.debug("MediaStream.dispatchEvent(): Undefined event: ",e.type)},this.addEventListener=function(e,t){Y.debug("MediaStream.addEventListener(): "+e),"function"==typeof t?"string"==typeof e?(void 0===i[e]&&(i[event]={listeners:[]}),i[e].listeners.push(t)):Y.error("MediaStream.addEventListener(): The event name is invalid."):Y.error("MediaStream.addEventListener(): The listener handler is invalid.")},this.removeEventListener=function(e,t){Y.debug("MediaStream.removeEventListener(): "+e),void 0!==i[e]?i[e].listeners=i[e].listeners.filter(function(e){return e.toString()!==t.toString()}):Y.error("MediaStream.removeEventListener(): Event does not exist = "+e)},this.addTrack=function(e){Y.debug("MediaStream.addTrack(): "+e.id);var t=!1;this.track.forEach(function(n){n.id==e.id&&(t=!0)}),t||this.track.push(e)},this.removeTrack=function(e){Y.debug("MediaStream.removeTrack(): "+e.id);for(var t=0;t<this.track.length;t++)if(this.track[t].id==e.id)return void this.track.splice(t,1)},this.removeTrackById=function(e){Y.debug("MediaStream.removeTrackById(): "+e);for(var t=0;t<this.track.length;t++)if(this.track[t].id==e){var n={type:"removetrack",track:this.track[t]};return this.dispatchEvent(n),void this.track.splice(t,1)}},this.getTracks=function(){return Y.debug("["+this.id+"]MediaStream.getTracks(): "+this.track.length),Y.debug(this.track),this.track},this.getAudioTracks=function(){var e=[];return this.track.forEach(function(t){"audio"==t.kind&&e.push(t)}),Y.debug("MediaStream.getAudioTracks(): Audio tracks = "+e.length),e},this.getVideoTracks=function(){var e=[];return this.track.forEach(function(t){"video"==t.kind&&e.push(t)}),Y.debug("MediaStream.getVideoTracks(): Video tracks = "+e.length),e},this.getTrackById=function(e){var t=null;return Y.debug("MediaStream.getTrackById(): "+e),this.track.forEach(function(n){n.id==e&&(t=n)}),t},this.clone=function(){if(Y.debug("MediaStream.clone(): Clone mediaStream = "+this.id),this.cloned)return Y.debug("MediaStream.clone(): Use cached clone: "+this.cloned.id),this.cloned;var e=new te,t=n(this.id,"StreamCln#",e._objectId),i=[];e._create({id:t,active:this.active,track:[]});for(var r=0;r<this.track.length;r++){var o=this.track[r]._internalClone();e.track.push(o),i.push({tid:this.track[r].id,cid:o.id})}return B.send({cmd:"mediaStreamClone",sid:this.id,cid:e.id,trackClones:i},-1),Y.debug("MediaStream.clone(): MediaStream cloned = "+e.id+" from = "+this.id),e}},ne=function(){var e={};this._objectId=++_,this.remote=!1,this.readonly=!1,this.contentHint="",this.id="",this.kind="",this.label="",this.muted=!1,this.readyState="",this._enabled=!1,Object.defineProperty(this,"enabled",{get:function(){return this._enabled},set:function(e){this._enabled=e,void 0===e&&Y.warn("Set MediaStreamTrack.enabled to undefined."),B.send({cmd:"trackEnabled",trackId:this.id,enabled:e},-1)},configurable:!0}),this._create=function(e){this._update(e),P[this.id]=this},this._update=function(e){e&&(this.contentHint=e.contentHint,this.id=e.id,this.kind=e.kind,this.label=e.label,this._enabled=e.enabled,this.muted=e.muted,this.readyState=e.readyState,this.remote=e.remote,this.readonly=e.readonly,this.settings=e.settings)},this.dispatchEvent=function(e){"started"==e.type?this.onstarted&&this.onstarted(e):"ended"==e.type?this.onended&&this.onended(e):"isolationchange"==e.type?this.onisolationchange&&this.onisolationchange(e):"mute"==e.type?this.onmute&&this.onmute(e):"unmute"==e.type?this.onunmute&&this.onunmute(e):"overconstrained"==e.type?this.onoverconstrained&&this.onoverconstrained(e):Y.debug("Undefined media track evt: ",e.type)},this.addEventListener=function(t,n){Y.debug("MediaStreamTrack.addEventListener(): "+t),"function"==typeof n?"string"==typeof t?(void 0===e[t]&&(e[event]={listeners:[]}),e[t].listeners.push(n)):Y.error("MediaStreamTrack.addEventListener(): The event name is invalid."):Y.error("MediaStreamTrack.addEventListener(): The listener handler is invalid.")},this.removeEventListener=function(t,n){Y.debug("MediaStreamTrack.removeEventListener(): "+t),void 0!==e[t]?e[t].listeners=e[t].listeners.filter(function(e){return e.toString()!==n.toString()}):Y.error("MediaStreamTrack.removeEventListener(): Event does not exist = "+t)},this.applyConstraints=function(e){var t=this.id,n=this.settings;return Y.debug("MediaStreamTrack.applyConstraints()"),new Promise(function(i,r){var o=new DOMException("applyConstraints failed","OperationError");B.send({cmd:"applyConstraints",constraints:e,trkid:t},-1,function(e){void 0===e.error?(void 0!==e.settings.width&&void 0!==e.settings.height&&(n.width=e.settings.width,n.height=e.settings.height),i()):r(o)})})},this.getConstraints=function(){Y.debug("MediaStreamTrack.getConstraints(): Not implemented")},this.getCapabilities=function(){Y.debug("MediaStreamTrack.getCapabilities(): Not implemented")},this.getSettings=function(){return Y.debug("MediaStreamTrack.getSettings(): "+JSON.stringify(this.settings)),this.settings},this.stop=function(){B.send({cmd:"mediaTrkStop",trkid:this.id})},this._internalClone=function(){var e=new ne,t=n(this.id,"TrackCln#",e._objectId);return e._create({id:t,kind:this.kind,label:this.label,enabled:this.enabled,muted:this.muted,readyState:this.readyState,remoate:this.remote,readonly:this.readonly,settings:this.settings}),e},this.clone=function(){var e=this._internalClone();return B.send({cmd:"mediaTrackClone",tid:this.id,cid:e.id},-1),e}},ie=function(){this.reports=[],this.result=function(){return this.reports},this._create=function(e){var t=this;e.forEach(function(e){var n=new re;n._create(e),t.reports.push(n)})}},re=function(){this.stats={},this._create=function(e){this.stats=e,this.type=e.type,this.id=e.id,this.timestamp=e.timestamp,delete this.stats.type,delete this.stats.id,delete this.stats.timestamp},this.names=function(){return Object.keys(this.stats)},this.stat=function(e){return this.stats[e]}},oe=function(){this.canInsertDTMF=!0;var e=void 0,t=null,n="",i=null,r=null;this.initPlanB=function(n,i){e=n,t=i},this.initUnifiedPlan=function(n,o,a,s){o&&a?(e=n,t=s,i=o,r=a):Y.error("RTCDTMFSender.initUnifiedPlan: invalid transceiver or sender")},Object.defineProperty(this,"toneBuffer",{get:function(){return Y.debug("get DTMF tone buffer"+n),n},set:function(e){void 0===e&&Y.warn("Set RTCDTMFSender.toneBuffer to undefined."),Y.debug("set DTMF tone buffer"+e),n=e},configurable:!0}),this.insertDTMF=function(n,o,a){Y.debug("insertDTMF audio tones: "+n),void 0===o&&(Y.debug("Duration is not set, use default"),o=s.DURATION),void 0===a&&(Y.debug("Gap is not set, use default"),a=s.INTERTONEGAP),B.send({cmd:"insertDTMF",transceiverId:i?i.id:"",senderId:r?r.id:"",tid:t.id,tones:n,duration:o,gap:a},e)}},ae=function(){var e={},t={},n=function(n){n&&("+"===n.op&&(e=null,t={}),n.track&&(e?Object.keys(n.track).forEach(function(t){"enabled"!=t?e[t]=n.track[t]:e._enabled=n.track[t]}):(e=new ne)._update(n.track)),n.sources&&n.sources.forEach(function(e){var n=e.source;if("-"===e.op)delete t[n];else{"+"===e.op&&(delete t[n],t[n]={});var i=t[n];Object.keys(e).forEach(function(t){i[t]=e[t]})}}))},i=function(e){var n=[];for(var i in t){var r=t[i];r.type&&r.type===e&&n.push(r)}return n};this.update=function(e){n(e)},Object.defineProperty(this,"track",{get:function(){return e},configurable:!0}),this.getContributingSources=function(){return i(d.CSRC)},this.getSynchronizationSources=function(){return i(d.SSRC)}};ae.getCapabilities=function(e){if(Y.info("RTCRtpReceiver.getCapabilities for kind = "+e),q.receiver&&q.receiver[e])return q.receiver[e]};var se=function(e){var t=this,n=!1;this._cap=z.sender?z.sender:0;var i=e,r=null,o=null,a=f.PENDING,s="",d=null,c=null,l=null;this.initPlanB=function(e,i){Y.debug("RtcRtpSender.initPlanB"),n=!1,r=i,s=e?e.id:"",o=e,d=new de(t)},this.initUnifiedPlan=function(e,i){e?(n=!0,c=e,d=new de(t),i&&i.sendEncodings):Y.error("RTCRtpSender.initUnifiedPlan: Invalid transceiver")},Object.defineProperty(this,"dtmf",{get:function(){return n?(l||(l=new oe).initUnifiedPlan(i.id,c,this,o),l):i?i.createDTMFSender(o):null},configurable:!0}),Object.defineProperty(this,"rtcpTransport",{get:function(){Y.debug("RTCRtpSender.rtcpTransport getter: Not implemented")},configurable:!0}),Object.defineProperty(this,"track",{get:function(){return Y.debug("RTCRtpSender.track Transceiver="+(c?c.id:"")+")"),o},configurable:!0}),Object.defineProperty(this,"transport",{get:function(){Y.debug("RTCRtpSender.transport getter: Not implemented")},configurable:!0}),Object.defineProperty(this,"id",{get:function(){return Y.debug("RTCRtpSender.id:"+s),s},configurable:!0}),Object.defineProperty(this,"proxyState",{get:function(){return a},configurable:!0}),this.setTrack=function(e,t){o=e,r=t},this.removeTrack=function(){o?i?(B.send({cmd:"removeTrack",transceiverId:c?c.id:"",senderId:s},i.id),d=null,o=null):Y.error("RTCRtpSender.removeTrack: invalid peer object."):Y.error("RTCRtpSender.removeTrack: track is already removed.")},this.update=function(e){if(i)if(e){if(c)e.id?s=e.id:Y.error("RTCRtpSender.update invalid id");else if(s!=e.id||!d)return void Y.error("RTCRtpSender.update Invalid state detected, self = "+JSON.stringify(t));e.track&&o&&o._update(e.track),e.parameters&&d&&d.update(e.parameters),a=f.COMPLETED}else Y.error("RTCRtpSender.update: invalid sender object.");else Y.error("RTCRtpSender.update: invalid peer object.")},this.getParameters=function(){return Y.debug("RTCRtpSender.getParameters"),i?(a===f.PENDING&&Y.warn("RTCRtpSender.getParameters without peer, use cached value and the behavior will be undefined."),d):(Y.error("RTCRtpSender.getParameters: invalid peer object."),null)},this.setParameters=function(e){return Y.debug("RTCRtpSender.setParameters"),new Promise(function(t,n){i?B.send({cmd:"senderCmd",senderCmd:u.SENDERCMD_SET_PARAMETERS,hint:"setParameter",transceiverId:c?c.id:"",senderId:s,parameters:e.modifiedValues()},i.id,function(e){if(void 0===e.error){var i=Array.isArray(e.senders)&&e.senders.length>0?i=e.senders[0]:null;if(!i||i.id!=s){Y.debug("RTCRtpSender.setParameters invaild response.");var r=new DOMException("setParameters failed","OperationError");return void n(r)}d.update(i.parameters),t()}else n(e.error)}):n(new DOMException("RTCRtpSender.setParameters: invalid peer object","OperationError"))})},this.getStats=function(){Y.debug("RTCRtpSender.getStats: Not implemented")},this.replaceTrack=function(e){return Y.debug("RTCRtpSender.replaceTrack"),new Promise(function(n,a){i?(B.send({cmd:"senderCmd",senderCmd:u.SENDERCMD_REPLACE_TRACK,hint:"replaceTrack",transceiverId:c?c.id:"",senderId:s,sid:r?r.id:"",trackId:o?o.id:"",newTrackId:e?e.id:""},i.id,function(e){void 0===e.error?n():a(e.error)}),o=e,d=new de(t)):a(new DOMException("RTCRtpSender.replaceTrack no peer","OperationError"))})}};se.getCapabilities=function(e){if(Y.info("RTCRtpSender.getCapabilities for kind = "+e),q.sender&&q.sender[e])return q.sender[e]};var de=function(e){var t="balanced",n=[],i=null,r="",o=0;n[0]=new ce;var a=function(t){e&&e.proxyState!=f.PENDING?Y.debug("RTCRtpSendParameters."+t):Y.warn("RTCRtpSendParameters."+t+": sender is pending.")};Object.defineProperty(this,"degradationPreference",{get:function(){return a("degradationPreference getter"),t},set:function(e){t=e,o|=v.RSPF_DEGRADATION_PREFERENCE},configurable:!0}),Object.defineProperty(this,"encodings",{get:function(){return a("encodings getter"),n},set:function(e){n=e,o|=v.RSPF_ENCODEINGS},configurable:!0}),Object.defineProperty(this,"priority",{get:function(){return a("priority getter"),i},set:function(e){i=e,o|=v.RSPF_PRIORITY},configurable:!0}),Object.defineProperty(this,"transactionId",{get:function(){return a("transactionId getter"),r},set:function(e){r=e,o|=v.RSPF_TRANSACTION_ID},configurable:!0}),this.update=function(e){0==(o&v.RSPF_DEGRADATION_PREFERENCE)&&(t=e.degradationPreference),0==(o&v.RSPF_ENCODEINGS)&&e.encodings&&(n=[],e.encodings.forEach(function(e){var t=new ce;t.update(e),n.push(t)})),0==(o&v.RSPF_PRIORITY)&&(i=e.priority),0==(o&v.RSPF_TRANSACTION_ID)&&(r=e.transactionId)},this.modifiedValues=function(){var e={};o&v.RSPF_DEGRADATION_PREFERENCE&&(e.degradationPreference=t);var r=[];return n.forEach(function(e){var t=e.modifiedValues();Object.keys(t).length&&r.push(t)}),r.length&&(e.encodings=r),o&v.RSPF_PRIORITY&&(e.priority=i),o=0,e}},ce=function(){var e,t,n,i,r,o,a,s=!0,d=0;Object.defineProperty(this,"active",{get:function(){return s},set:function(e){s=e,d|=g.RPF_ACTIVE},configurable:!0}),Object.defineProperty(this,"codecPayloadType",{get:function(){return e},configurable:!0}),Object.defineProperty(this,"dtx",{get:function(){return t},set:function(e){dtx=e,d|=g.RPF_DTX},configurable:!0}),Object.defineProperty(this,"maxBitrate",{get:function(){return n},set:function(e){n=e,d|=g.RPF_MAXBITRATE},configurable:!0}),Object.defineProperty(this,"maxFramerate",{get:function(){return i},set:function(e){i=e,d|=g.RPF_MAXFRAMERATE},configurable:!0}),Object.defineProperty(this,"ptime",{get:function(){return r},set:function(e){r=e,d|=g.RPF_PTIME},configurable:!0}),Object.defineProperty(this,"rid",{get:function(){return o},set:function(e){o=e,d|=g.RPF_RID},configurable:!0}),Object.defineProperty(this,"scaleResolutionDownBy",{get:function(){return scaleResolutionDownBy},set:function(e){a=e,d|=g.RPF_SCALE_RESOLUTION_DOWNBY},configurable:!0}),this.update=function(c){0==(d&g.RPF_ACTIVE)&&(s=c.active),0==(d&g.RPF_CODEPAYLOADTYPE)&&(e=c.codecPayloadType),0==(d&g.RPF_DTX)&&(t=c.dtx),0==(d&g.RPF_MAXBITRATE)&&(n=c.maxBitrate),0==(d&g.RPF_MAXFRAMERATE)&&(i=c.maxFramerate),0==(d&g.RPF_PTIME_)&&(r=c.ptime),0==(d&g.RPF_RID)&&(o=c.rid),0==(d&g.RPF_SCALE_RESOLUTION_DOWNBY)&&(a=c.scaleResolutionDownBy)},this.modifiedValues=function(){var c={};return d&g.RPF_ACTIVE&&(c.active=s),d&g.RPF_CODEPAYLOADTYPE&&(c.codecPayloadType=e),d&g.RPF_DTX&&(c.dtx=t),d&g.RPF_MAXBITRATE&&(c.maxBitrate=n),d&g.RPF_MAXFRAMERATE&&(c.maxFramerate=i),d&g.RPF_PTIME&&(c.ptime=r),d&g.RPF_RID&&(c.rid=o),d&g.RPF_SCALE_RESOLUTION_DOWNBY&&(c.scaleResolutionDownBy=a),d=0,c}},ue=function(e){var t,n=this,i=e,r="inactive",o="inactive",a=null,s=!1,d=null,c=null;this.initId=function(e){t=e,(d=new se(i)).initUnifiedPlan(n,null),c=new ae},this.initTrackOrKind=function(e,r){var a=e instanceof ne?e.kind:e,s="";"audio"===a?s="A":"video"===a&&(s="V"),t="Transceiver#"+s+k.toString(),k++,(d=new se(i)).initUnifiedPlan(n,r),c=new ae,r&&r.direction&&(o=r.direction),r&&r.stream&&Y.debug("RTCRtpTransceiver.init with stream is not implemented.")},this.update=function(e){e.currentDirection&&(r=e.currentDirection),e.direction&&(o=e.direction),e.mid&&(a=e.mid),void 0!==e.stopped&&(s=e.stopped),e.sender&&d&&d.update(e.sender),e.receiver&&c&&c.update(e.receiver)};var u=function(e){Y.info(e+"("+t+")")};Object.defineProperty(this,"id",{get:function(){return t},configurable:!0}),Object.defineProperty(this,"mid",{get:function(){return u("RTCRtpTransceiver.mid="+a),a}}),Object.defineProperty(this,"currentDirection",{get:function(){return u("RTCRtpTransceiver.currentDirection"),r},configurable:!0}),Object.defineProperty(this,"direction",{get:function(){return u("RTCRtpTransceiver.direction="+o),o},set:function(e){u("RTCRtpTransceiver.direction setter"),o=e;var n={cmd:"transceiverCmd",transceiverCmd:h.TRANSCEIVER_SET_DIRECTION,hint:"RTCRtpTransceiver.direction",transceiverId:t,value:e};B.send(n,i.id)},configurable:!0}),Object.defineProperty(this,"receiver",{get:function(){return u("RTCRtpTransceiver.receiver"),c},configurable:!0}),Object.defineProperty(this,"sender",{get:function(){return u("RTCRtpTransceiver.sender"),d},configurable:!0}),Object.defineProperty(this,"stopped",{get:function(){return u("RTCRtpTransceiver stopped"),s},set:function(e){u("RTCRtpTransceiver stopped setter"),s=e},configurable:!0}),this.setCodecPreferences=function(e){u("RTCRtpTransceiver setCodecPreferences"),B.send({cmd:"transceiverCmd",transceiverCmd:h.TRANSCEIVER_SET_CODECPREFERENCE,hint:"RTCRtpTransceiver.setCodecPreference",transceiverId:t,codecs:e},i.id,function(e){void 0===e.error||u("RTCRtpTransceiver.setCodecPreferences failed.")})},this.stop=function(){u("RTCRtpTransceiver stop"),B.send({cmd:"transceiverCmd",transceiverCmd:h.TRANSCEIVER_STOP,hint:"RTCRtpTransceiver.stop",transceiverId:t},i.id,function(e){void 0===e.error||u("RTCRtpTransceiver.stop failed.")})}},le=function(e,t){var n=this,i=t;this._srcObject=e.srcObject,this._id=R++,this._rawAudio=e,this.sendAudioElement=function(){var t={cmd:"newAudioElement",audioId:this._id};e.setAttribute("data-vdi_audioid",this._id),B.send(t,-1)},Object.defineProperty(e,"srcObject",{get:function(){return n._srcObject},set:function(e){void 0===e&&Y.warn("Set audio.srcObject to undefined."),Y.debug("Setting srcObject for audio element: "+n._id),Y.debug(e),n._srcObject=void 0===e?null:e,n.sendSrcObject()},configurable:!0}),this.sendSrcObject=function(){var e=this._srcObject?this._srcObject.id:"null";B.send({cmd:"updateSrcObject",mediaStreamId:e,audioId:this._id,type:"audio"},-1)},Object.defineProperty(e,"sinkId",{get:function(){return n._sinkId},set:function(e){},configurable:!0}),e.setSinkId=function(e){return n._sinkId=e,Y.debug("Audio.setSinkId for ID = "+n._id+" Value = "+e),0===(void 0!==z.setSinkId?z.setSinkId:0)?new Promise(function(t,i){B.send({cmd:"setSinkId",deviceId:e,audioId:n._id,context:"audioElement"},-1),t()}):new Promise(function(t,i){B.send({cmd:"setSinkId",deviceId:e,audioId:n._id,context:"audioElement"},-1,function(e){void 0===e.error?t():i(e.error)})})},e.play=function(){return Promise.resolve()},this.init=function(){Z(i),this.sendAudioElement(),this._srcObject&&(Y.debug("srcObject already set for audio: "+this._id),this.sendSrcObject()),Y.debug(e)},this.init()},he=function(e,t){var n=this,i=t,r=Q(t),o=!1;this._srcObject=e.srcObject,this._videoWidth=e.videoWidth,this._videoHeight=e.videoHeight,this._cloaked=!1,this._id=y++,this._clientRect=null,this._bodyClientRect=null,this._colorKey=null,this._rawVideo=e,this._removeTimer=null,this._removed=!1,this._objectFit=e.style.objectFit,this._styleObserver=new MutationObserver(function(t){t.forEach(function(t){n.handleStyleChanges(t,e)})});var a=function(e){var t=Number(e).toString(16);return t.length<2&&(t="0"+t),t},s=function(){for(var e="";""==e;){var t=Math.floor(16*Math.random())+1,n=Math.floor(16*Math.random())+1,i=Math.floor(16*Math.random())+1;e="#"+a(t)+a(n)+a(i);var r=Object.keys(j);for(var o in r){var s=j[r[o]];if(s&&s._colorKey==e){e="";break}}}return e};this.sendVideoElement=function(){this._colorKey=s();var t={cmd:"newVideoElement",videoId:this._id,colorKey:this._colorKey,body:{}};r&&(t.frame=r);for(var n in this._clientRect)t[n]=this._clientRect[n];for(var n in this._bodyClientRect)t.body[n]=this._bodyClientRect[n];""!==this._objectFit&&(t.objectFit=this._objectFit),e.setAttribute("data-vdi_videoid",this._id),B.send(t,-1)},this.updateVideoElement=function(){var t=this.getBoundingClientRect(e);this._cloaked||(t.right=t.left,t.bottom=t.top);var n=this.getBoundingClientRect(document.body);if(t.left==this._clientRect.left&&t.right==this._clientRect.right&&t.top==this._clientRect.top&&t.bottom==this._clientRect.bottom&&n.left==this._bodyClientRect.left&&n.right==this._bodyClientRect.right&&n.top==this._bodyClientRect.top&&n.bottom==this._bodyClientRect.bottom)return!1;this._clientRect=t,this._bodyClientRect=n;var i={cmd:"updateVideoElement",videoId:this._id,body:{}};r&&(i.frame=r);for(var o in t)i[o]=t[o];for(var o in n)i.body[o]=n[o];""!==this._objectFit&&(i.objectFit=this._objectFit),Y.debug(i),B.send(i,-1)},this.removeVideoElement=function(){var e={cmd:"removeVideoElement",videoId:n._id};r&&(e.frame=r),Y.debug("RemoveVideoElement: "+n._id),B.send(e,-1),delete j[n._id],n._removeTimer=null,n._removed=!0},this.disposeVideo=function(){o=!0},this.cloak=function(){!0!==this._cloaked&&(this._colorKey?(e.style.backgroundColor=this._colorKey,this._styleObserver.observe(e,{attributes:!0,attributeFilter:["style"]}),this._cloaked=!0,this._poll=setInterval(function(){n.updateVideoElement()},500)):Y.error("cloak(): Invalid color key."))},this.uncloak=function(){if(!1===this._cloaked)return!1;e.style.backgroundColor="",this._styleObserver.disconnect(),clearInterval(this._poll),this._cloaked=!1,this.updateVideoElement()},this.getBoundingClientRect=function(e,t){var n=e.getBoundingClientRect(),i=1;return"number"==typeof window.devicePixelRatio&&(i=window.devicePixelRatio),t&&t.left&&t.top?{left:n.left*i+t.left,top:n.top*i+t.top,bottom:n.bottom*i+t.top,right:n.right*i+t.left,width:n.width*i,height:n.height*i}:{left:n.left*i,top:n.top*i,bottom:n.bottom*i,right:n.right*i,width:n.width*i,height:n.height*i}},this.onReceiveEvent=function(e){if(void 0!==e&&void 0!==e.evt)if(this._rawVideo){if("loadedmetadata"===e.evt){if(""==this._objectFit){var t=window.getComputedStyle(this._rawVideo).objectFit;""!==t&&(Y.debug("onReceiveEvent(): updating objectfit to "+t),this._objectFit=t,this.sendObjectFit())}void 0!==e.videoWidth&&(this._videoWidth=e.videoWidth),void 0!==e.videoHeight&&(this._videoHeight=e.videoWidth);var n=new Event(e.evt);this._rawVideo.dispatchEvent(n)}}else Y.error("onReceiveEvent(): Invalid rawVideo object.");else Y.error("onReceiveEvent(): evt property is invalid.")},this.sendSrcObject=function(){var e=this._srcObject?this._srcObject.id:"null";B.send({cmd:"updateSrcObject",mediaStreamId:e,videoId:this._id,type:"video"},-1),this._srcObject?this.cloak():this.uncloak()},this.sendObjectFit=function(){B.send({cmd:"updateObjectFit",videoId:this._id,objectFit:this._objectFit},-1)},Object.defineProperty(e,"srcObject",{get:function(){return n._srcObject},set:function(e){n._removed?Y.warn("Setting srcObject of zombie video element: "+n._id):(n._removeTimer&&(clearTimeout(n._removeTimer),n._removeTimer=null),void 0===e&&Y.warn("Set video.srcObject to undefined."),Y.debug("Setting srcObject for video element: "+n._id),Y.debug(e),n._srcObject=e,n.sendSrcObject(),n._srcObject||(o?n.removeVideoElement():(Y.debug("srcObject is null, setup removeTimer for "+n._id),n._removeTimer=setTimeout(n.removeVideoElement,5e3))))},configurable:!0}),Object.defineProperty(e,"videoWidth",{get:function(){return n._videoWidth},configurable:!0}),Object.defineProperty(e,"videoHeight",{get:function(){return n._videoHeight},configurable:!0}),Object.defineProperty(e.style,"objectFit",{get:function(){return console.log("keyword defineProperty get objectFit "+n._objectFit),n._objectFit},set:function(e){console.log("keyword defineProperty set objectFit "+e),n._objectFit=e,n.sendObjectFit()},configurable:!0}),he.prototype.handleStyleChanges=function(e,t){"attributes"===e.type&&"style"===e.attributeName&&(Y.debug("video style change in id = "+this._id+", object-fit = "+t.style.objectFit),Y.debug(t),this._objectFit!==t.style.objectFit&&(Y.debug("change in object-fit. Old = "+this._objectFit+", new = "+t.style.objectFit),this._objectFit=t.style.objectFit,this.sendObjectFit()))},this.init=function(){this._clientRect=this.getBoundingClientRect(e),this._bodyClientRect=this.getBoundingClientRect(document.body),Z(i),this.sendVideoElement(),this._srcObject&&(Y.debug("srcObject already set for video: "+this._id),this.sendSrcObject()),Y.debug(e)},this.init()},fe=function(e){"function"==typeof V?(Y.info("onVMEvent(): Fire event = "+JSON.stringify(e)),V(e)):Y.warn("onVMEvent(): setVMEventCallback is not called yet.")},ve=function(){var e=this,t=null,n=a.DISCONNECTED,i={},s=0,d=null,c=!1,u=!0;Object.defineProperty(this,"state",{get:function(){return n},configurable:!0}),Object.defineProperty(this,"shortPollingIntervalMs",{get:function(){return 1e3}}),Object.defineProperty(this,"shortPollingTimeout",{get:function(){return 1e4}}),Object.defineProperty(this,"longPollingIntervalMs",{get:function(){return 5e3}}),Object.defineProperty(this,"isHorizonRegistryPresent",{get:function(){return c},set:function(e){c=e},configurable:!0}),Object.defineProperty(this,"sendVdiClientEventsOnError",{get:function(){return u},set:function(e){u=e},configurable:!0}),this.sendLogToWebSocket=function(e,t){return"string"==typeof e&&0!==e.length&&(n===a.CONNECTED&&(g({cmd:"shimLogToWebSocket",message:e,level:t},-1),!0))},this.isSocketConnected=function(){return n===a.CONNECTED},this.isSocketOpen=function(){return!!t&&t.readyState===WebSocket.OPEN},this.init=function(){Y.info("RequestManager.init(): Initializing Request Manager."),this.startPolling(1e3,1e4,this.sendEvents)},this.startPolling=function(t,i,r){if(d)Y.info("RequestManager.startPolling(): Polling timer already initialized");else if(n===a.DISCONNECTED){var o=i;Y.info("intervalMs "+t+" timeout "+i),d=setInterval(function(){e.connectToHorizon(),void 0!==o&&(o-=t,c||e.queryHorizonRegistry()),void 0!==o&&o<=0&&(e.stopPolling(),r&&!0===c&&r())},t)}else Y.info("RequestManager.startPolling(): Socket state not disconnected, exiting")},this.stopPolling=function(){null!==d&&(clearInterval(d),d=null,Y.info("Stopped polling websocket"))},this.sendEvents=function(){var e={};e.shimVersion=C;var t={event:"vdiClientConnected",version:e};try{fe(t)}catch(e){Y.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}try{fe({event:"vdiClientDisconnected",reason:"endpointUnsupported"})}catch(e){Y.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}B.startPolling(5e3)},this.queryHorizonRegistry=function(){window.getVMWareViewClientID().then(function(e){Y.info("queryHorizonRegistry(): Horizon Client ID "+e),e&&B&&(B.isHorizonRegistryPresent=!0,Y.info("queryHorizonRegistry(): isHorizonRegistryPresent true"))},function(){return Y.error("queryHorizonRegistry(): Failed to query Horizon Client ID"),!1})},this.connectToHorizon=function(){n===a.DISCONNECTED&&window.getVMWareSecureWebPort().then(function(e){if("string"!=typeof e||0===e.length)return Y.error("connectToHorizon(): Port is not valid"),void E("VMware HTML5 Server port not valid");Y.info("connectToHorizon(): port is "+e),n=a.PENDING,(t=new WebSocket("wss://view-localhost:"+e+"/")).binaryType="arraybuffer",t.onopen=l,t.onclose=h,t.onerror=f,t.onmessage=v},function(){Y.error("connectToHorizon(): Failed to receive port number"),E("Failed to receive port number")})};var l=function(){Y.info("onWebSocketOpen(): Websocket opened"),B.stopPolling(),g({cmd:"createInstance",hwnd:W.hwnd,shimVersion:C,shimMinAgentVersion:1,customClipRect:1,allowFeatureChange:1,supportObjectFit:1,supportE911:1},-1,function(t){if(n!=a.DISCONNECTED){t.uid&&Y.info("onWebSocketOpen(): ["+t.uid+"] createInstanceDone"),"true"===t.traceEnabled&&Y.updateLogLevel(o.DEBUG,o.DEBUG);var i=["agentOsVersion","clientOsVersion","haVersion","hcVersion","shimVersion","webrtcClientVer","webRTCRedirAgentVersion","webRTCRedirClientVersion"],r={};Y.logToConsole=1===t.logToConsole,Y.debug("VDI Shim: Log to console = "+Y.logToConsole);for(c=0;c<i.length;c++)t[i[c]]?(r[i[c]]=t[i[c]],Y.debug("onWebSocketOpen(): "+i[c]+" = "+t[i[c]])):Y.warn("onWebSocketOpen(): Could not find property "+i[c]);t.clientOsVersion?t.clientOsVersion.startsWith("Win")?r.clientPlatform="Windows":t.clientOsVersion.startsWith("Mac")?r.clientPlatform="Mac":t.clientOsVersion.startsWith("Lin")?r.clientPlatform="Linux":(Y.error("Unknown client os: "+t.clientOsVersion),r.clientPlatform="Unknown"):(Y.error("Missing client os information."),r.clientPlatform="Unknown"),Y.debug("onWebSocketOpen(): clientPlatform = "+r.clientPlatform);var s={event:"vdiClientConnected",version:r};if(t.hcId&&(s.endpointId=t.hcId,Y.debug("onWebSocketOpen(): ClientId = "+t.hcId)),"true"===t.allow){n=a.CONNECTED,z=t["api-capabilities"]?t["api-capabilities"]:{},q=t.rtpCapabilities?t.rtpCapabilities:{},Array.isArray(t.featuresSupported)?(G=t.featuresSupported,Y.info("onWebSocketOpen(): Supported features = "+JSON.stringify(G))):Y.warn("onWebSocketOpen(): featureSupported property not valid");try{fe(s)}catch(e){Y.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}e.invokeDeviceChange()}else{try{fe(s)}catch(e){Y.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}for(var d="",i=["errorCode","errorMsg"],c=0;c<i.length;c++)void 0!==t[i[c]]?(Y.debug("onWebSocketOpen(): "+i[c]+": "+t[i[c]]),d+=i[c]+" = "+t[i[c]],c!=i.length-1&&(d+="; ")):Y.warn("onWebSocketOpen(): Could not find property "+i[c]);try{fe({event:"vdiClientDisconnected",reason:"endpointUnsupported",msg:d})}catch(e){Y.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}E("VMware HTML5 Server connection not allowed")}}})},h=function(){Y.info("onWebSocketClose(): Websocket closed"),E("VMware HTML5 Server connection closed")},f=function(e){Y.debug("onWebSocketError(): Websocket error");var t=a.DISCONNECTED;B&&(t=B.state),E("VMware HTML5 Server connection error: "+e.message),t==a.PENDING&&(Y.debug("Error in connecting socket"),B&&B.sendVdiClientEventsOnError&&(Y.error("Error in connecting to websocket"),B.stopPolling(),B.sendEvents(),B.sendVdiClientEventsOnError=!1))},v=function(e){if("object"==typeof e.data){var t=new Uint8Array(e.data),n=new DataView(e.data),r=n.getInt32(0),o=n.getInt32(36);if(1396920910!=r)return void Y.warn("Unsupport binary data: "+r.toString(16));z.getScreens&&z.getScreens&S.BOUNDS&&Y.warn("New client should return string for getScreen.");for(var a=40,s=[];a+12<t.length;){var d=n.getInt32(a),c=(m=n.getInt32(a+4))*(C=n.getInt32(a+8))*4;if(m<0||C<0||a+12+c>t.length){Y.warn("Invalid screen "+m+"X"+C+" offs:"+a+" size:"+c+" len:"+t.length);break}a+=12;var u=new Uint8ClampedArray(t.buffer,a,c),l=new ImageData(u,m,C),h=new pe(d,"Screen "+d,l);a+=c,s.push(h),Y.debug("Screen:"+d+": "+m+"X"+C+" offs:"+a+" size:"+c+" len:"+t.length)}g=i[o];return delete i[o],void(void 0!==g&&"function"==typeof g.responseCb&&g.responseCb(s))}if("string"==typeof e.data){var f=e.data,v=JSON.parse(f);if(Y.logToConsole&&console.log("onWebSocketMessage(): "+f),F&&F(v),"number"==typeof v.id&&v.id>0){var g=i[v.id];if(delete i[v.id],g&&"function"==typeof g.responseCb)if("getScreens"!==v.evt||v.screens)g.responseCb(v);else if(v.error)g.responseCb(v);else{var s=[],p="number"==typeof v.screens?v.screens:1;for(d=1;d<=p;d++){for(var m=100,C=100,E=4*m*C,u=new Uint8ClampedArray(E),y=0;y<E;y+=4)u[y]=81,u[y+1]=144,u[y+2]=201,u[y+3]=255;var l=new ImageData(u,m,C),h=new pe(d,"Screen "+d,l);s.push(h)}g.responseCb(s)}}else if(void 0!==v.evt)switch(v.evt){case"version":if(void 0===v.ver){Y.error("onWebSocketMessage(): ver property is invalid.");break}Y.info("onWebSocketMessage(): version = "+v.ver);break;case"negotiationneeded":case"icecandidate":case"icegatheringstatechange":case"iceconnectionstatechange":case"signalingstatechange":case"connectionstatechange":case"addStream":case"ontrack":case"tonechange":case"onreceivers":case"onsenders":case"ontransceivers":case"ondatachannel":case"removeStream":void 0!==v.peer&&void 0!==O[v.peer]?O[v.peer]._onReceiveEvent(v):Y.error("onWebSocketMessage(): peerConnection is invalid.");break;case"loadedmetadata":void 0!==v.videoId&&void 0!==j[v.videoId]?j[v.videoId].onReceiveEvent(v):Y.error("onReceiveCommand(): Invalid context.");break;case"devicechange":var R=new Event("devicechange");navigator.mediaDevices.dispatchEvent(R);break;case"vdiScreenTopologyChanged":try{fe({event:"vdiScreenTopologyChanged"})}catch(e){Y.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}break;case"featuresSupportedChanged":for(var y in v.features){var T=v.features[y],_=G.indexOf(T.feature);"+"==T.op&&_<0?G.push(T.feature):"-"==T.op&&_>=0&&G.splice(_,1)}fe({event:"vdiFeatureSupportedChanged",reason:v.reason?v.reason:"endpoint changes supported features"});break;case"vdiE911InfoChanged":v.event="vdiE911InfoChanged",fe(v);break;case"onHidDeviceChange":Y.error("onHidDeviceChange : gHidManager is null or hidDevices not found");break;case"onHidDeviceInputReport":Y.error("onHidDeviceInputReport : gHidManager is null or deviceId not found or no elements");break;case"powerevent":var k=v.eventData;b(k);break;case"dconopen":case"dconbufferedamountlow":case"dconclosing":case"dconerror":case"dconmessage":case"dconclose":void 0!==v.peer&&void 0!==O[v.peer]?O[v.peer]._onReceiveDataChannelEvent(v):Y.error("Datachannel event: peerConnection is invalid.")}else Y.error("onWebSocketMessage(): evt property is invalid")}else Y.error("onWebSocketMessage(): invalid data type: "+typeof e.data)},g=function(e,o,d,c){if(o=void 0==o?-1:o,void 0!==e)if(-1===o||O[o])e.feature=3,e.commandId=r[e.cmd],e.id=++s,e.peer=o,e.browser="electron",e.player=A,"createInstance"===e.cmd&&(e.uid=2147483647&Date.now(),Y.info("sendHelper(): ["+e.uid+"] createInstance")),"createInstance"!==e.cmd&&n!==a.CONNECTED||(d&&(c?d():i[e.id]={id:e.id,webCommandId:e.commandId,responseCb:d}),t.send(JSON.stringify(e)));else{u=new DOMException("peer Id is not found, operation cancelled","OperationError");d?d({error:u}):Y.error(u)}else{var u=new DOMException("Invalid command, operation cancelled","OperationError");d?d({error:u}):Y.error(u)}};this.send=function(e,t,n,i){"getStats"!=e.cmd&&Y.debug(JSON.stringify(e)),g(e,t,n,i)},this.invokeDeviceChange=function(){K(function(){Y.info("invokeDeviceChange(): Fire devicechange event");var e=new Event("devicechange");navigator.mediaDevices.dispatchEvent(e)})},this.sendBinary=function(e){n===a.CONNECTED?t.send(e):Y.warn("sendBinary(): WSS is not connected.")};var m=function(){var e="v=0\n",t=Math.random()*Number.MAX_SAFE_INTEGER;return t=Math.floor(t),e=e+"o=- "+String(t)+" 2 IP4 127.0.0.1\n",e+="s=-\n",e+="t= 0 0\n",e+="a=msid-semantic: WMS"},b=function(e){if(e==p.POWEREVENT_SUSPEND)try{Y.info("onPowerEvent(): received suspend"),fe({event:"vdiRequestEndCalls",reason:"vdiClientPowerEventSuspend"})}catch(e){Y.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}else if(e==p.POWEREVENT_RESUME){Y.info("onPowerEvent(): received resume");try{fe({event:"vdiRequestEndCalls",reason:"vdiClientPowerEventResume"})}catch(e){Y.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}}else Y.error("powerevent: Invalid param.")},E=function(o,s){var d=n;if(n=s?a.PENDING:a.DISCONNECTED,Object.keys(i).forEach(function(e){var t=new DOMException(o,"OperationError");if(i[e].responseCb)if(i[e].webCommandId===r.createOffer||i[e].webCommandId===r.createAnswer){var n={desc:{sdp:m()}};Y.debug("Resolving createoffer/createAnswer with desc "+n.desc),i[e].responseCb(n)}else i[e].responseCb({error:t});else Y.error(t)}),i={},t&&t.readyState===WebSocket.OPEN&&n==a.DISCONNECTED&&t.close(),t=null,Object.keys(O).forEach(function(e){O[e].cleanUp()}),O={},P={},D={},G=[],J=[],X={},q={},d===a.CONNECTED){try{fe({event:"vdiClientDisconnected",reason:"endpointDisconnected"})}catch(e){Y.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}e.invokeDeviceChange()}z={}}},ge={Monitor:1,Window:2,Camera:3},pe=function(e,t,n,i){var r=this;this.id=e,this.name=t,this.image=n,this.icon=void 0,this.bounds=i||{x:0,y:0,width:0,height:0},this.getId=function(){return Y.debug("getId "+r.id),r.id},this.getDeviceId=function(){return Y.debug("getDeviceId "+r.id),"VDI_Mon-"+r.id},this.getType=function(){return ge.Monitor},this.getPreview=function(e,t,n){return Y.debug("ScreensAsync getPreview "),new Promise(function(e,t){t()})},this.getPreviewAsync=function(e,t,n){return Y.debug("ScreensAsync getPreviewAsync"),n?new Promise(function(e,t){var n=document.createElement("canvas");n.getContext("2d").putImageData(r.image,0,0);var i=n.toDataURL();e({data:i=i.replace("data:image/png;base64,","")})}):new Promise(function(e,t){e(r.image)})},this.getDescription=function(){return Y.debug("ScreensAsync getDescription "),r.name},this.getIcon=function(e,t){return Y.debug("ScreensAsync getIcon"),new Promise(function(e,t){e(r.image)})},this.getAppName=function(){return Y.warn("getAppName: not support."),null},this.getBounds=function(){return(r.bounds.width<=0||r.bounds.height<=0)&&Y.warn("getBounds: invalid bounds."),r.bounds}},me={CREATE:1,SEND:2,SET_BUFFER_AMOUNT_LOW_THRESHOLD:3,CLOSE:4},be=function(e,t){var n=this;this.id=-1,this.binaryType="arraybuffer",this.bufferedAmount=0,this.maxPacketLifeTime=0,this.maxRetransmits=0,this.negotiated=!1,this.ordered=!0,this.protocol="",this.readyState=!1,this.reliable=!0,this.label="";var i=t,r=e,o=0;Object.defineProperty(this,"bufferedAmountLowThreshold",{get:function(){return o},set:function(e){void 0===e&&Y.warn("RTCDataChannel bufferedAmountLowThreshold value undefined."),-1!=n.id&&B.send({cmd:"dataChannelCmd",hint:"setBufferAmountLowThreshold",dataChannelCmd:me.SET_BUFFER_AMOUNT_LOW_THRESHOLD,dataChannelId:n.id,shimId:i,label:n.label,threshold:e},r),o=e},configurable:!0}),this._createChannel=function(e,t){-1==n.id?(n.label=e,B.send({cmd:"dataChannelCmd",hint:"create",label:e,shimId:i,options:t,dataChannelCmd:me.CREATE},r)):Y.warn("RTCDataChannel.create channel "+n.id+" already existed")},this._updateChannel=function(e){n.id=e.id,n.binaryType=e.binaryType,n.bufferedAmount=e.bufferedAmount,n.maxPacketLifeTime=e.maxPacketLifeTime,n.maxRetransmits=e.maxRetransmits,n.negotiated=e.negotiated,n.ordered=e.ordered,n.protocol=e.protocol,n.readyState=e.readyState,n.reliable=e.reliable,n.label=e.label},this.send=function(e){if(-1!=n.id)if(e instanceof Blob){e.arrayBuffer();e.arrayBuffer().then(function(e){for(var t=new Uint8Array(e),o=t.byteLength,a="",s=0;s<o;s++)a+=String.fromCharCode(t[s]);B.send({cmd:"dataChannelCmd",label:n.label,dataChannelId:n.id,shimId:i,dataChannelCmd:me.SEND,hint:"send",data:window.btoa(a),dataType:"binary",dataLen:o},r)})}else{var t=null,o=0,a="binary";if("string"==typeof e||e instanceof String)t=window.btoa(e),a="string",o=e.length;else{var s=new Uint8Array(e);o=s.byteLength;for(var d="",c=0;c<o;c++)d+=String.fromCharCode(s[c]);d&&(t=window.btoa(d))}t?B.send({cmd:"dataChannelCmd",label:n.label,dataChannelId:n.id,shimId:i,hint:"send",dataChannelCmd:me.SEND,data:t,dataType:a,dataLen:o},r):Y.warn("RTCDataChannel.send: Unsupported data format")}else Y.error("RTCDataChannel.send: invalid datachannel id.")},this.close=function(){O[r]?(B.send({cmd:"dataChannelCmd",hint:"close",label:n.label,dataChannelId:n.id,shimId:i,dataChannelCmd:me.CLOSE},r),O[r]._untrackDataChannel(n.id,i)):Y.warn("RTCDataChannel.close: peerconnection is untracked.")},this._onReceiveEvent=function(e){if(void 0!==e&&void 0!==e.evt){var t={target:this};switch(e.evt){case"dconopen":this.onopen&&(this._updateChannel(e.channel),this.onopen(t));break;case"dconbufferedamountlow":this.onbufferedamountlow&&this.onbufferedamountlow(t);break;case"dconerror":this.onerror&&this.onerror(t);break;case"dconmessage":if(this.onmessage){if("string"===e.dataType)t.data=window.atob(e.data);else{var n=window.atob(e.data),i=n.length;t.data=new Uint8Array(i);for(var r=0;r<i;r++)t.data[r]=n.charCodeAt(r)}this.onmessage(t)}break;case"dconclose":this.onclose&&this.onclose(t)}}else Y.error("_onReceiveEvent(): evt property is invalid.")}},Se={createPeerConnection:function(e,t){if(B){if(B.isSocketConnected()){var n=new ee(e,t);if(z.sender)n.createOffer=n.createOfferV1,n.createAnswer=n.createAnswerV1,n.setRemoteDescription=n.setRemoteDescriptionV1,n.setLocalDescription=n.setLocalDescriptionV1,n.addIceCandidate=n.addIceCandidateV1,n.getStats=n.getStatsV1,n.addTrack=n.addTrackImplV1,n.removeTrack=n.removeTrackImplV1,n.getSenders=n.getSendersImplV1,n.getTransceivers=n.getTranceiversImplV1,n.addTransceiver=n.addTransceiverImplV1;else{if(n.isUnifiedPlan())throw Y.error("createPeerConnection failed due to endpoint does not support unified plan"),"endpoint does not support unified plan";n.createOffer=n.createOfferV0,n.createAnswer=n.createAnswerV0,n.setRemoteDescription=n.setRemoteDescriptionV0,n.setLocalDescription=n.setLocalDescriptionV0,n.addIceCandidate=n.addIceCandidateV0,n.getStats=n.getStatsV0}return n.createDataChannel=n.createDataChannelImplV1,O[n.id]=n,B.send({cmd:"createPeerConnection",arg1:e,arg2:t},n.id),Y.debug("createPeerConnection(): Create peer: "+n.id),n}Y.error("createPeerConnection: WebSocket is not in connected state")}else Y.error("createPeerConnection: gRequestManager is not created yet.")},createMediaStream:function(e){var t=new te;return t.createMediaStream(e),t},getDisplayMediaShim:function(e){if(B.isSocketConnected())return new Promise(function(t,n){Y.debug("getDisplayMediaShim(): Constraints = "+JSON.stringify(e)),B.send({cmd:"getDisplayMediaShim",constraints:e},-1,function(e){if(void 0===e.error){var i=new te;i._create(e.stream),Y.debug("getDisplayMediaShim(): Media ="+i.id),t(i)}else n(e.error)})});Y.error("getDisplayMediaShim: WebSocket is not in connected state")},mediaDevicesGetUserMediaShim:function(e){if(B.isSocketConnected())return new Promise(function(t,n){Se.getUserMediaShim(e,t,n)});Y.error("mediaDevicesGetUserMediaShim: WebSocket is not in connected state")},getUserMediaShim:function(e,t,n){if(Y.debug("Constraints: "+JSON.stringify(e)),B.isSocketConnected()){if(void 0!==e.video&&void 0!==e.video.mandatory&&void 0!==e.video.mandatory.sourceId&&void 0!==U[e.video.mandatory.sourceId]){var i=0,r=0,o=0,a=!1,s=e.video.mandatory.sourceId,d=e.video.mandatory.minWidth,c=e.video.mandatory.maxWidth,u=e.video.mandatory.minHeight,l=e.video.mandatory.maxHeight,h=e.video.mandatory.maxFrameRate,f=d,v=u,g={width:0,height:0},p={width:0,height:0};U[s].forEach(function(e){(void 0===d||e.width>=d)&&(void 0===c||e.width<=c)&&(void 0===u||e.height>=u)&&(void 0===l||e.height<=l)&&(void 0===h||e.fps>=h)?(e.width*e.height>g.width*g.height&&(g=e),f&&v&&f*e.height==v*e.width&&e.width*e.height>p.width*p.height&&(p=e)):(void 0!==d&&e.width>=d||void 0!==c&&e.width>=c)&&(a=!0)});var m=p.width>0?p:g;if(m&&(i=m.width,r=m.height,o=m.fps),i>0&&r>0&&o>0)Y.debug("Constraints: "+JSON.stringify(e)+" ==> "+i+"x"+r+" @"+o),e.video.mandatory.maxFrameRate=o,e.video.mandatory.maxWidth=e.video.mandatory.minWidth=i,e.video.mandatory.maxHeight=e.video.mandatory.minHeight=r;else{if(!a)return Y.debug("getUserMediaShim(): constraints does not match."),void n({name:"OverconstrainedError",message:null});Y.debug("getUserMediaShim(): low resolution video forward to client.")}}B.send({cmd:"getUserMediaShim",constraints:e},-1,function(e){if(void 0===e.error){var i=null;void 0!==e.clone&&((i=new te)._create(e.clone),Y.debug("Media cloned:"+i.id));var r=new te;r._create(e.stream),r.cloned=i,Y.debug("Media:"+r.id),t(r)}else{new DOMException("Abort","AbortError");n(e.error)}})}else Y.error("getUserMediaShim: Websocket is not in connected state")},init:function(e){H=e,Y.info("init(): VMware VDI shim version = "+C),window.getWindowHandleAsHex().then(function(e){Y.info("init(): HWND: "+e),W.hwnd=e,(B=new ve).init()},function(e){Y.error("init(): Failed to retrieve window handle: "+e.message)})},connectedStateChanged:function(e){Y.info("connectedStateChanged called "+e),B&&(B.state===a.CONNECTED&&B.send({cmd:"connectedStateChanged",connectionState:!0===e?1:0},-1),!0===e?(B.sendVdiClientEventsOnError=!0,B.startPolling(B.shortPollingIntervalMs,B.shortPollingTimeout,B.sendEvents)):(B.sendVdiClientEventsOnError=!1,B.isHorizonRegistryPresent=!1,Y.info("connectedStateChanged(): isHorizonRegistryPresent false"),B.stopPolling()))},enumerateDevicesShim:function(){return B.isSocketConnected()?new Promise(function(e,t){B.send({cmd:"enumDevices"},-1,function(n){void 0===n.error?(e(n.devices),void 0!==n.caps&&Object.keys(n.caps).forEach(function(e){U[e]=n.caps[e]})):t("enumDevices cancelled.")})}):(Y.info("enumerateDevicesShim(): Use fallback mode."),new Promise(function(e,t){N.call(navigator.mediaDevices).then(function(t){e(t),B.isSocketConnected()&&(Y.info("enumerateDevicesShim(): [Resolve] Fallback cancelled. Invoke device change."),B.invokeDeviceChange())},function(n){B.isSocketConnected()?(Y.info("enumerateDevicesShim(): [Reject] Fallback cancelled. Invoke device change."),e([]),B.invokeDeviceChange()):t(n)})}))},newVideoElement:function(e,t){if(B.isSocketConnected()){Y.debug("newVideoElement: New video element from teams.");for(var n=Object.keys(j),i=0;i<n.length;i++){var r=n[i];if(j[r]._rawVideo===e)return void Y.debug("newVideoElement(): Video already found")}var o=new he(e,t);j[o._id]=o,e._context=o}else Y.error("newVideoElement: WebSocket is not in connected state")},newAudioElement:function(e,t){if(B.isSocketConnected()){Y.debug("newAudioElement(): A new audio element created.");for(var n=Object.keys(L),i=0;i<n.length;i++){var r=n[i];if(L[r]._rawAudio===e)return void Y.debug("newAudioElement(): Audio already found")}var o=new le(e,t);L[o._id]=o,e._context=o}else Y.error("newAudioElement: WebSocket is not in connected state")},setVMEventCallback:function(e){return"function"!=typeof e?(Y.error("setVMEventCallback(): The event callback function is not valid."),!1):(Y.info("setVMEventCallback(): Set event callback"),V=e,!0)},setVMResultHandler:function(e){return"function"!=typeof e?(Y.error("setVMResultHandler(): The event callback function is not valid."),!1):(Y.info("setVMResultHandler(): Set result event callback"),F=e,!0)},playNotifyAudio:function(e,t){if(B.isSocketConnected())if(t){var n=!0===x[e];Y.debug("playNotifyAudio(): id = "+e+" src = "+t+" loop = "+n),t.startsWith("file:")&&(t="https://teams.microsoft.com/assets/audio"+t.substring(t.lastIndexOf("/")),Y.debug("playNotifyAudio(): src map to :"+t));var i=w[e];void 0===i&&(i=R++,w[e]=i),B.send({cmd:"notifyAudio",action:"play",src:t,audid:i,loop:n},-1);var r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="arraybuffer",r.onreadystatechange=function(){if(r.readyState==XMLHttpRequest.DONE&&200==r.status){var e=16+r.response.byteLength,n=new Uint8Array(16);n[0]=65,n[1]=78,n[2]=84,n[3]=70,n[4]=e>>24&255,n[5]=e>>16&255,n[6]=e>>8&255,n[7]=255&e,n[8]=i>>24&255,n[9]=i>>16&255,n[10]=i>>8&255,n[11]=255&i;var o=new Uint8Array(e),a=new Uint8Array(r.response);o.set(n,0),o.set(a,16),B.sendBinary(o),Y.debug("onreadystatechange(): Send "+e+"bytes")}else Y.debug("onreadystatechange(): Download "+t+" status = "+r.status)},r.send()}else Y.error("playNotifyAudio(): src cannot be null or undefined");else Y.error("playNotifyAudio(): WebSocket is not in connected state")},setLoop:function(e,t){Y.debug(e+".loop = "+t),x[e]=t},pauseNotifyAudio:function(e){if(B.isSocketConnected()){Y.debug("pauseNotifyAudio(): id = "+e);var t=w[e];void 0===t?Y.warn("pauseNotifyAudio(): id = "+e+" did not play yet."):B.send({cmd:"notifyAudio",action:"pause",audid:t},-1)}else Y.error("playNotifyAudio: WebSocket is not in connected state")},addClipRect:function(e,t){if(Y.debug("addClipRect: "+JSON.stringify(e)),B.isSocketConnected()){var n={cmd:"customClipRect",op:c.ADD,clip:e},i=Q(t);i&&(Z(t),n.frame=i),B.send(n,-1)}else Y.error("addClipRect: WebSocket is not in connected state")},removeClipRect:function(e,t){if(Y.debug("removeClipRect: "+JSON.stringify(e)),B.isSocketConnected()){var n={cmd:"customClipRect",op:c.REMOVE,clip:e},i=Q(t);i&&(n.frame=i),B.send(n,-1)}else Y.error("removeClipRect: WebSocket is not in connected state")},addClipCircle:function(e,t){var n=JSON.parse(JSON.stringify(e));n.colored=!0,Y.debug("addClipCircle: "+JSON.stringify(n));var i={cmd:"customClipRect",op:c.ADD,clip:n},r=Q(t);r&&(Z(t),i.frame=r),B.send(i,-1)},removeClipCircle:function(e,t){var n=JSON.parse(JSON.stringify(e));n.colored=!0,Y.debug("removeClipCircle: "+JSON.stringify(n));var i={cmd:"customClipRect",op:c.REMOVE,clip:n},r=Q(t);r&&(i.frame=r),B.send(i,-1)},disposeVideoElement:function(e,t){e&&e._context&&e._context.disposeVideo();var n=e&&e._context?e._context._id:void 0;Y.info("disposeElement video id="+n)},disposeAudioElement:function(e,t){e&&e._context&&e._context._id;Y.info("disposeElement audio id="+_id)},onWindowClose:function(e){$(e)},getCapabilitiesShim:function(e){return Y.debug("getCapabilitiesShim"),ae.getCapabilities(e)},setSinkId:function(e,t){if(B.isSocketConnected()){var n=w[e];void 0===n&&(n=R++,w[e]=n),Y.debug("setSinkId id = "+n+" srcId = "+e+" Value = "+t),B.send({cmd:"setSinkId",deviceId:t,audioId:n,srcId:e,context:"global"},-1,function(e){})}else Y.error("setSinkId: WebSocket is not in connected state")},setDefaultSinkId:function(e){Y.debug("setDefaultSinkId = "+e),B.isSocketConnected()?B.send({cmd:"setDefaultSinkId",deviceId:e},-1):Y.error("setDefaultSinkId: WebSocket is not in connected state")},isFeatureSupported:function(e){if("string"!=typeof e)return Y.debug("isFeatureSupported(): Invalid feature parameter"),!1;if(!B||B.state!==a.CONNECTED)return!1;if("hid"===e)return Y.debug("isFeatureSupported(): hid is now disabled"),!1;if("givecontrol"===e){if(!z.getScreens||0==(z.getScreens&S.BOUNDS))return Y.debug("isFeatureSupported(): disable givecontrol for old endpoint(no bounds)."),!1;if(!z.datachannel||1!=z.datachannel)return Y.debug("isFeatureSupported(): disable givecontrol for no datachannel."),!1}else if("datachannel"===e)return z.datachannel?1==z.datachannel||(Y.debug("isFeatureSupported(): disable datachannel by settings."),!1):(Y.debug("isFeatureSupported(): disable datachannel for old client."),!1);var t=!1;return Array.isArray(G)&&-1!=G.indexOf(e)&&(t=!0),t||Y.debug("isFeatureSupported(): Input feature string not supported = "+e),t},getScreensAsync:function(){Y.debug("getScreensAsync get called.");{if(B.isSocketConnected())return new Promise(function(e,t){var n=0;z.getScreens&&z.getScreens&S.BOUNDS&&(n=1),B.send({cmd:"getScreens",bounds:n},-1,function(n){if(Array.isArray(n))J=i=n,e(i);else if(n.screens&&Array.isArray(n.screens)){for(var i=[],r=0;r<n.screens.length;r++){var o=n.screens[r].w,a=n.screens[r].h,s=n.screens[r].id,d=n.screens[r].bounds,c=n.screens[r].imageData;if(o>0&&a>0&&s&&d&&c){for(var u=window.atob(c),l=u.length,h=new Uint8ClampedArray(l),f=0;f<l;f++)h[f]=u.charCodeAt(f);var v=new ImageData(h,o,a),g=new pe(s,"Screen "+s,v,d);i.push(g),Y.debug("Screen:"+s+":  image size:"+l)}else Y.error("Invalid screen data:"+JSON.stringify(n.screens[r]))}J=i,e(i)}else{var p=n.error&&n.error.message?n.error.message:"Invalid getScreen response";t(new DOMException(p,"OperationError"))}})});Y.error("getScreensAsync: WebSocket is not in connected state")}},setScreenSharePanelId:function(e){Y.debug("setScreenSharePanelId = "+e+" for getDisplayMedia"),B.isSocketConnected()?B.send({cmd:"setScreenId",scrnId:e,numScreens:J.length},-1):Y.error("setScreenSharePanelId: WebSocket is not in connected state")},startClientLogsCollection:function(){return null},queryState:function(e){return"requestmanager"===e?B.isSocketConnected():"websocket"===e?B.isSocketOpen():(Y.error("queryState() Invalid item: "+e),!1)}};return Se});